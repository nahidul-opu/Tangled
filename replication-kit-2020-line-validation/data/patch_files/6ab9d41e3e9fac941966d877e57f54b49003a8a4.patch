From 6ab9d41e3e9fac941966d877e57f54b49003a8a4 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 18 Oct 2010 21:48:41 +0000
Subject: [PATCH] FIX: Can not use a v[revision] in an artifact pattern of a
 filesystem resolver (IVY-1238)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1024027 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../plugins/resolver/util/ResolverHelper.java |  8 ++--
 .../resolver/util/ResolverHelperTest.java     | 41 +++++++++++++++++++
 .../IVY-1238/ivy-org/modA/v1.0/ivy.xml        | 23 +++++++++++
 .../IVY-1238/ivy-org/modA/v2.0/ivy.xml        | 23 +++++++++++
 5 files changed, 91 insertions(+), 5 deletions(-)
 create mode 100644 test/java/org/apache/ivy/plugins/resolver/util/ResolverHelperTest.java
 create mode 100644 test/repositories/IVY-1238/ivy-org/modA/v1.0/ivy.xml
 create mode 100644 test/repositories/IVY-1238/ivy-org/modA/v2.0/ivy.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index d6deb71ae..e72153efa 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -113,6 +113,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	
    trunk
 =====================================
+- FIX: Can not use a v[revision] in an artifact pattern of a filesystem resolver (IVY-1238)
 - FIX: Cached ivy.xml is invalid if the description contains the ampersand entity (&amp;) (IVY-1237)
 - FIX: Couldn't authenticate against sites having the same address as the proxy server (IVY-1234)
 - FIX: OutOfMemoryError when uploading large files using commons-httpclient (IVY-1197) (thanks to Torkild U. Resheim)
diff --git a/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java b/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java
index 272d760d9..adac92063 100644
--- a/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java
+++ b/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java
@@ -73,13 +73,11 @@ public static String[] listTokenValues(Repository rep, String pattern, String to
                         namePattern = pattern.substring(slashIndex + 1);
                     }
                     namePattern = namePattern.replaceAll("\\.", "\\\\.");
-                    String acceptNamePattern = ".*?"
-                            + IvyPatternHelper.substituteToken(namePattern, token, "([^" + fileSep
-                                    + "]+)") + "($|" + fileSep + ".*)";
-                    Pattern p = Pattern.compile(acceptNamePattern);
+                    namePattern = IvyPatternHelper.substituteToken(namePattern, token, "(.+)");
+                    Pattern p = Pattern.compile(namePattern);
                     for (Iterator iter = all.iterator(); iter.hasNext();) {
                         String path = (String) iter.next();
-                        Matcher m = p.matcher(path);
+                        Matcher m = p.matcher(path.substring(root.length() + 1));
                         if (m.matches()) {
                             String value = m.group(1);
                             ret.add(value);
diff --git a/test/java/org/apache/ivy/plugins/resolver/util/ResolverHelperTest.java b/test/java/org/apache/ivy/plugins/resolver/util/ResolverHelperTest.java
new file mode 100644
index 000000000..ba6ef1bfc
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/resolver/util/ResolverHelperTest.java
@@ -0,0 +1,41 @@
+/*
+ *  Licensed to the Apache Software Foundation (ASF) under one or more
+ *  contributor license agreements.  See the NOTICE file distributed with
+ *  this work for additional information regarding copyright ownership.
+ *  The ASF licenses this file to You under the Apache License, Version 2.0
+ *  (the "License"); you may not use this file except in compliance with
+ *  the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ *  Unless required by applicable law or agreed to in writing, software
+ *  distributed under the License is distributed on an "AS IS" BASIS,
+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ *  See the License for the specific language governing permissions and
+ *  limitations under the License.
+ *
+ */
+package org.apache.ivy.plugins.resolver.util;
+
+import java.io.File;
+import java.util.Arrays;
+
+import org.apache.ivy.plugins.repository.file.FileRepository;
+
+import junit.framework.TestCase;
+
+public class ResolverHelperTest extends TestCase {
+
+    public void testListTokenValuesForIvy1238() {
+        FileRepository rep = new FileRepository(new File(".").getAbsoluteFile());
+        String[] revisions = ResolverHelper.listTokenValues(rep, "test/repositories/IVY-1238/ivy-org/modA/v[revision]/ivy.xml", "revision");
+
+        assertNotNull(revisions);
+        assertEquals(2, revisions.length);
+        
+        Arrays.sort(revisions);
+        assertEquals("1.0", revisions[0]);
+        assertEquals("2.0", revisions[1]);
+    }
+    
+}
diff --git a/test/repositories/IVY-1238/ivy-org/modA/v1.0/ivy.xml b/test/repositories/IVY-1238/ivy-org/modA/v1.0/ivy.xml
new file mode 100644
index 000000000..0e137d8e2
--- /dev/null
+++ b/test/repositories/IVY-1238/ivy-org/modA/v1.0/ivy.xml
@@ -0,0 +1,23 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+    <info organisation="myorg" module="modA" revision="1.0" />
+    <publications />
+    <dependencies />
+</ivy-module>
diff --git a/test/repositories/IVY-1238/ivy-org/modA/v2.0/ivy.xml b/test/repositories/IVY-1238/ivy-org/modA/v2.0/ivy.xml
new file mode 100644
index 000000000..2f50bc3c0
--- /dev/null
+++ b/test/repositories/IVY-1238/ivy-org/modA/v2.0/ivy.xml
@@ -0,0 +1,23 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+    <info organisation="myorg" module="modA" revision="2.0" />
+    <publications />
+    <dependencies />
+</ivy-module>
