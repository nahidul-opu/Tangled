From ac3c4d8080ff6bc5a760d1d3deb375b3d2cd608d Mon Sep 17 00:00:00 2001
From: Nicolas Lalevee <hibou@apache.org>
Date: Sat, 20 Nov 2010 09:50:58 +0000
Subject: [PATCH] IVY-1250 : clone the system properties before using it so we
 can avoid some ConcurrentModificationException

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1037148 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                            | 1 +
 src/java/org/apache/ivy/core/settings/IvySettings.java | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 4a8726e20..aa18dbdb5 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -123,6 +123,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: Only the last dependency descriptor is taken into account on the same module (IVY-1240)
 - FIX: UseCacheOnly doesn't respect the cache configuration in the ivysettings (IVY-1227)
 - FIX: UseCacheOnly is influenced by the TTL on cached metadata (IVY-1243)
+- FIX: ConcurrentModificationException on ivy settings loading (IVY-1250)
 
    2.2.0
 =====================================
diff --git a/src/java/org/apache/ivy/core/settings/IvySettings.java b/src/java/org/apache/ivy/core/settings/IvySettings.java
index ff9a9aa86..987d0bfc3 100644
--- a/src/java/org/apache/ivy/core/settings/IvySettings.java
+++ b/src/java/org/apache/ivy/core/settings/IvySettings.java
@@ -297,7 +297,7 @@ public IvySettings(IvyVariableContainer variableContainer) {
 
     private void addSystemProperties() {
         try {
-            addAllVariables(System.getProperties());
+            addAllVariables((Map) System.getProperties().clone());
         } catch (AccessControlException ex) {
             Message.verbose(
                 "access denied to getting all system properties: they won't be available as Ivy variables."
