From 424c02b3ea3c10724df2419ae82cd7f98a7c351f Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Mon, 24 Mar 2008 16:30:44 +0000
Subject: [PATCH] CONFIGURATION-318: Take the name of the root element into
 account when creating an XMLConfiguration using the copy constructor

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@640458 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/XMLConfiguration.java       |  2 +
 ...estHierarchicalConfigurationXMLReader.java |  2 +-
 .../configuration/TestXMLConfiguration.java   | 39 +++++++++++++++++++
 xdocs/changes.xml                             |  4 ++
 4 files changed, 46 insertions(+), 1 deletion(-)

diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index bfa6b702f7..7d74d13bed 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -279,6 +279,7 @@ public void setRootElementName(String name)
                     + "cannot be changed when loaded from an XML document!");
         }
         rootElementName = name;
+        getRootNode().setName(name);
     }
 
     /**
@@ -422,6 +423,7 @@ public void initProperties(Document document, boolean elemRefs)
         }
 
         constructHierarchy(getRoot(), document.getDocumentElement(), elemRefs);
+        getRootNode().setName(document.getDocumentElement().getNodeName());
         if (elemRefs)
         {
             getRoot().setReference(document.getDocumentElement());
diff --git a/src/test/org/apache/commons/configuration/TestHierarchicalConfigurationXMLReader.java b/src/test/org/apache/commons/configuration/TestHierarchicalConfigurationXMLReader.java
index 0f15d81921..de781ba982 100644
--- a/src/test/org/apache/commons/configuration/TestHierarchicalConfigurationXMLReader.java
+++ b/src/test/org/apache/commons/configuration/TestHierarchicalConfigurationXMLReader.java
@@ -67,7 +67,7 @@ public void testParse() throws Exception
         Node root = ((Document) result.getNode()).getDocumentElement();
         JXPathContext ctx = JXPathContext.newContext(root);
 
-        assertEquals("Wrong name of root element", "config", root.getNodeName());
+        assertEquals("Wrong name of root element", "database", root.getNodeName());
         assertEquals("Wrong number of children of root", 1, ctx.selectNodes(
                 "/*").size());
         assertEquals("Wrong number of tables", 2, ctx.selectNodes(
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 1e1688a14e..2e41552039 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -1325,6 +1325,45 @@ public void testSaveAfterCreateWithCopyConstructor()
                 .getRootElementName());
     }
 
+    /**
+     * Tests whether the name of the root element is copied when a configuration
+     * is created using the copy constructor.
+     */
+    public void testCopyRootName() throws ConfigurationException
+    {
+        final String rootName = "rootElement";
+        final String xml = "<" + rootName + "><test>true</test></" + rootName
+                + ">";
+        conf.clear();
+        conf.load(new StringReader(xml));
+        XMLConfiguration copy = new XMLConfiguration(conf);
+        assertEquals("Wrong name of root element", rootName, copy
+                .getRootElementName());
+        copy.save(testSaveConf);
+        copy = new XMLConfiguration(testSaveConf);
+        assertEquals("Wrong name of root element after save", rootName, copy
+                .getRootElementName());
+    }
+
+    /**
+     * Tests whether the name of the root element is copied for a configuration
+     * for which not yet a document exists.
+     */
+    public void testCopyRootNameNoDocument() throws ConfigurationException
+    {
+        final String rootName = "rootElement";
+        conf = new XMLConfiguration();
+        conf.setRootElementName(rootName);
+        conf.setProperty("test", Boolean.TRUE);
+        XMLConfiguration copy = new XMLConfiguration(conf);
+        assertEquals("Wrong name of root element", rootName, copy
+                .getRootElementName());
+        copy.save(testSaveConf);
+        copy = new XMLConfiguration(testSaveConf);
+        assertEquals("Wrong name of root element after save", rootName, copy
+                .getRootElementName());
+    }
+
     /**
      * Prepares a configuration object for testing a reload operation.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 19d2211f43..e9bfd22b73 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-318">
+        When an XMLConfiguration is created using the copy constructor, the name
+        of the root element is now preserved.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-316">
         Changing the text of the root element of an XMLConfiguration had no
         effect when the configuration was saved. This has been fixed.
