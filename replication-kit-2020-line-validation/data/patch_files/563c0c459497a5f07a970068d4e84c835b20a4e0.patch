From 563c0c459497a5f07a970068d4e84c835b20a4e0 Mon Sep 17 00:00:00 2001
From: Bernd Eckenfels <ecki@apache.org>
Date: Wed, 23 Sep 2015 15:41:29 +0000
Subject: [PATCH] [VFS-279] better support for ON_CALL cache

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@1704885 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/vfs2/provider/local/LocalFileSystem.java       | 3 ++-
 .../apache/commons/vfs2/test/VerifyingFileSelector.java    | 7 +++++--
 src/changes/changes.xml                                    | 5 ++++-
 3 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs2/provider/local/LocalFileSystem.java b/core/src/main/java/org/apache/commons/vfs2/provider/local/LocalFileSystem.java
index fc8bfc416b..97b700bdd2 100644
--- a/core/src/main/java/org/apache/commons/vfs2/provider/local/LocalFileSystem.java
+++ b/core/src/main/java/org/apache/commons/vfs2/provider/local/LocalFileSystem.java
@@ -28,6 +28,7 @@
 import org.apache.commons.vfs2.FileSystemOptions;
 import org.apache.commons.vfs2.provider.AbstractFileName;
 import org.apache.commons.vfs2.provider.AbstractFileSystem;
+import org.apache.commons.vfs2.util.FileObjectUtils;
 
 /**
  * A local file system.
@@ -72,7 +73,7 @@ protected File doReplicateFile(final FileObject fileObject,
                                    final FileSelector selector)
         throws Exception
     {
-        final LocalFile localFile = (LocalFile) fileObject;
+        final LocalFile localFile = (LocalFile) FileObjectUtils.getAbstractFileObject(fileObject);
         final File file = localFile.getLocalFile();
         final SecurityManager sm = System.getSecurityManager();
         if (sm != null)
diff --git a/core/src/test/java/org/apache/commons/vfs2/test/VerifyingFileSelector.java b/core/src/test/java/org/apache/commons/vfs2/test/VerifyingFileSelector.java
index 6bfdb6d8c2..c34f9f2c81 100644
--- a/core/src/test/java/org/apache/commons/vfs2/test/VerifyingFileSelector.java
+++ b/core/src/test/java/org/apache/commons/vfs2/test/VerifyingFileSelector.java
@@ -26,6 +26,8 @@
 import org.apache.commons.vfs2.FileSelector;
 import org.apache.commons.vfs2.FileSystemException;
 import org.apache.commons.vfs2.FileType;
+import org.apache.commons.vfs2.provider.AbstractFileObject;
+import org.apache.commons.vfs2.util.FileObjectUtils;
 import org.junit.Assert;
 
 /**
@@ -88,7 +90,7 @@ public boolean traverseDescendents(final FileSelectInfo fileInfo)
         throws FileSystemException
     {
         // Check that the given file is a folder
-        final FileObject folder = fileInfo.getFile();
+        final FileObject folder = FileObjectUtils.getAbstractFileObject(fileInfo.getFile());
         assertSame(FileType.FOLDER, folder.getType());
         assertTrue(folder.isFolder());
 
@@ -101,7 +103,8 @@ public boolean traverseDescendents(final FileSelectInfo fileInfo)
         }
         else
         {
-            assertSame(currentFolder, folder.getParent());
+            AbstractFileObject parent = FileObjectUtils.getAbstractFileObject(folder.getParent());
+            assertSame(currentFolder, parent);
 
             // Locate the info for the child, and make sure it is folder
             currentFolderInfo = getChild(baseName);
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 67efcea48f..2620721ff7 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -26,8 +26,11 @@
 <!--       <action issue="VFS-443" dev="ggregory" type="update" due-to="nickallen"> -->
 <!--        [Local] Need an easy way to convert from a FileObject to a File. -->
 <!--       </action> -->
+      <action issue="VFS-279" dev="ecki" type="fix" due-to="Didier Earith, Simon Legner">
+        [local] Avoid ClassCastException when replicating local files while OnCall caching is active.
+      </action>
       <action issue="VFS-297" dev="joehni" type="fix" due-to="Kirill Safonov, Jimmy Praet">
-        [core/sftp] VSF fails to reuse FileSystem instances if FileSystemOptions contain
+        [sftp] VSF fails to reuse FileSystem instances if FileSystemOptions contain
         an array as value. Reported for SFTP using identities.
       </action>
       <action issue="VFS-198" dev="ecki" type="add" due-to="Andrew Franklin, Simon Legner">
