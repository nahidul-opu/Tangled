From bb2aeef4bc11b17be9233572b7afcfc3da04b887 Mon Sep 17 00:00:00 2001
From: "Bruno P. Kinoshita" <kinow@apache.org>
Date: Thu, 12 Oct 2017 07:16:07 +0000
Subject: [PATCH] JCS-184: move return statement outside of logging block

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/jcs/trunk@1811915 13f79535-47bb-0310-9956-ffa450edef68
---
 .../engine/control/CompositeCacheManager.java |  2 +-
 .../control/CompositeCacheManagerTest.java    | 54 +++++++++++++++++++
 src/changes/changes.xml                       |  3 ++
 3 files changed, 58 insertions(+), 1 deletion(-)
 create mode 100644 commons-jcs-core/src/test/java/org/apache/commons/jcs/engine/control/CompositeCacheManagerTest.java

diff --git a/commons-jcs-core/src/main/java/org/apache/commons/jcs/engine/control/CompositeCacheManager.java b/commons-jcs-core/src/main/java/org/apache/commons/jcs/engine/control/CompositeCacheManager.java
index ff0979df6..e62cb9ac5 100644
--- a/commons-jcs-core/src/main/java/org/apache/commons/jcs/engine/control/CompositeCacheManager.java
+++ b/commons-jcs-core/src/main/java/org/apache/commons/jcs/engine/control/CompositeCacheManager.java
@@ -736,8 +736,8 @@ private void release( boolean fromRemote )
                 if ( log.isDebugEnabled() )
                 {
                     log.debug( "Release called, but " + clients + " remain" );
-                    return;
                 }
+                return;
             }
 
             if ( log.isDebugEnabled() )
diff --git a/commons-jcs-core/src/test/java/org/apache/commons/jcs/engine/control/CompositeCacheManagerTest.java b/commons-jcs-core/src/test/java/org/apache/commons/jcs/engine/control/CompositeCacheManagerTest.java
new file mode 100644
index 000000000..207062ce2
--- /dev/null
+++ b/commons-jcs-core/src/test/java/org/apache/commons/jcs/engine/control/CompositeCacheManagerTest.java
@@ -0,0 +1,54 @@
+package org.apache.commons.jcs.engine.control;
+
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * "License"); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *   http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing,
+ * software distributed under the License is distributed on an
+ * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+ * KIND, either express or implied.  See the License for the
+ * specific language governing permissions and limitations
+ * under the License.
+ */
+
+import junit.framework.TestCase;
+
+import org.apache.commons.jcs.engine.CacheStatus;
+import org.apache.commons.jcs.engine.CompositeCacheAttributes;
+
+/** Unit tests for the composite cache manager */
+public class CompositeCacheManagerTest
+    extends TestCase
+{
+
+    /**
+     * Verify that calling release, when there are active clients, the caches are correctly disposed or not.
+     */
+    public void testRelease()
+    {
+        // See JCS-184
+        // create the manager
+        CompositeCacheManager manager = CompositeCacheManager.getInstance();
+        // add a simple cache
+        CompositeCacheAttributes cacheAttributes = new CompositeCacheAttributes();
+        CompositeCache<String, String> cache = new CompositeCache<>(cacheAttributes, /* attr */ null);
+        manager.addCache("simple_cache", cache);
+        // add a client to the cache
+        CompositeCacheManager.getUnconfiguredInstance();
+        // won't release as there are still clients. Only disposed when release() is called by
+        // the last client
+        manager.release();
+        assertEquals("The cache was disposed during release!", CacheStatus.ALIVE, cache.getStatus());
+        manager.release();
+        assertEquals("The cache was NOT disposed during release!", CacheStatus.DISPOSED, cache.getStatus());
+    }
+
+}
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 4376e99c7..fc6ca2dc4 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -20,6 +20,9 @@
 	</properties>
 	<body>
         <release version="3.0" date="unreleased">
+            <action dev="kinow" type="fix" due-to="athun">
+                Unexpected dispose() in CompositeCacheManager.release()
+            </action>
             <action dev="tv" type="remove">
                 Remove dependency on velocity-tools
             </action>
