From cb5c4dd73597780fce451e1b643c9b25d4ce7b4c Mon Sep 17 00:00:00 2001
From: Thomas Vandahl <tv@apache.org>
Date: Fri, 20 Nov 2015 13:29:15 +0000
Subject: [PATCH] JCS-149: When reading keys from disk, a
 StreamCorruptedException happens when a custom serializer is applied

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/jcs/trunk@1715355 13f79535-47bb-0310-9956-ffa450edef68
---
 .../jcs/auxiliary/disk/block/BlockDiskCacheFactory.java        | 3 +--
 .../jcs/auxiliary/disk/indexed/IndexedDiskCacheFactory.java    | 3 +--
 src/changes/changes.xml                                        | 3 +++
 3 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCacheFactory.java b/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCacheFactory.java
index 62252b1d4..0b35d2b72 100644
--- a/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCacheFactory.java
+++ b/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCacheFactory.java
@@ -57,9 +57,8 @@ public <K, V> BlockDiskCache<K, V> createCache( AuxiliaryCacheAttributes iaca, I
             log.debug( "Creating DiskCache for attributes = " + idca );
         }
 
-        BlockDiskCache<K, V> cache = new BlockDiskCache<K, V>( idca );
+        BlockDiskCache<K, V> cache = new BlockDiskCache<K, V>( idca, elementSerializer );
         cache.setCacheEventLogger( cacheEventLogger );
-        cache.setElementSerializer( elementSerializer );
 
         return cache;
     }
diff --git a/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/indexed/IndexedDiskCacheFactory.java b/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/indexed/IndexedDiskCacheFactory.java
index 6c5888e1a..03f2f1036 100644
--- a/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/indexed/IndexedDiskCacheFactory.java
+++ b/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/indexed/IndexedDiskCacheFactory.java
@@ -57,9 +57,8 @@ public <K, V> IndexedDiskCache<K, V> createCache( AuxiliaryCacheAttributes iaca,
             log.debug( "Creating DiskCache for attributes = " + idca );
         }
 
-        IndexedDiskCache<K, V> cache = new IndexedDiskCache<K, V>( idca );
+        IndexedDiskCache<K, V> cache = new IndexedDiskCache<K, V>( idca, elementSerializer );
         cache.setCacheEventLogger( cacheEventLogger );
-        cache.setElementSerializer(elementSerializer);
 
         return cache;
     }
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index deb4f6114..f3b3d741f 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -20,6 +20,9 @@
 	</properties>
 	<body>
         <release version="2.0" date="unreleased" description="JDK 1.6 based major release">
+            <action issue="JCS-149" dev="tv" type="fix" due-to="Youngho Cho">
+                When reading keys from disk, a StreamCorruptedException happens when a custom serializer is applied
+            </action>
             <action issue="JCS-48" dev="tv" type="update" due-to="Hanasaki Jiji">
                 Replace PoolAccess with a DataSourceFactory model borrowed from DB-Torque
             </action>
