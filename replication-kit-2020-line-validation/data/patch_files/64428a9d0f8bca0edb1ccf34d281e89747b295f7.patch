From 64428a9d0f8bca0edb1ccf34d281e89747b295f7 Mon Sep 17 00:00:00 2001
From: Pavan Kumar <pavanka@fb.com>
Date: Wed, 18 Jun 2014 16:14:40 -0700
Subject: [PATCH] GIRAPH-922: SimpleEdgeStore has a bug causing NPE (pavanka)

---
 CHANGELOG                                            |  2 ++
 .../org/apache/giraph/edge/AbstractEdgeStore.java    | 12 +++++-------
 .../java/org/apache/giraph/edge/SimpleEdgeStore.java |  7 +++----
 .../apache/giraph/edge/primitives/IntEdgeStore.java  |  7 +++----
 .../apache/giraph/edge/primitives/LongEdgeStore.java |  7 +++----
 5 files changed, 16 insertions(+), 19 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 659edfdb9..d315a9fa6 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,8 @@
 Giraph Change Log
 
 Release 1.1.0 - unreleased
+  GIRAPH-922: SimpleEdgeStore has a bug causing NPE (pavanka)
+
   GIRAPH-915: With BigDataIO some messages can get ignored (majakabiljo via pavanka)
 
   GIRAPH-918: GIRAPH-908 has a small bug reg counting entries (pavanka)
diff --git a/giraph-core/src/main/java/org/apache/giraph/edge/AbstractEdgeStore.java b/giraph-core/src/main/java/org/apache/giraph/edge/AbstractEdgeStore.java
index ee53718f3..b40ac005e 100644
--- a/giraph-core/src/main/java/org/apache/giraph/edge/AbstractEdgeStore.java
+++ b/giraph-core/src/main/java/org/apache/giraph/edge/AbstractEdgeStore.java
@@ -121,14 +121,12 @@ public AbstractEdgeStore(
   protected abstract Map<K, OutEdges<I, E>> getPartitionEdges(int partitionId);
 
   /**
-   * Remove and return the OutEdges for a given partition
+   * Return the OutEdges for a given partition
    *
    * @param entry for vertexId key
-   * @param partitionEdges map of out-edges for vertices in a partition
    * @return out edges
    */
-  protected abstract OutEdges<I, E> removePartitionEdges(Et entry,
-    Map<K, OutEdges<I, E>> partitionEdges);
+  protected abstract OutEdges<I, E> getPartitionEdges(Et entry);
 
   /**
    * Get iterator for partition edges
@@ -223,10 +221,10 @@ public Void call() throws Exception {
               // process all vertices in given partition
               while (iterator.hasNext()) {
                 Et entry = iterator.next();
-                I vertexId = getVertexId(entry,
-                    representativeVertexId);
+                I vertexId = getVertexId(entry, representativeVertexId);
                 OutEdges<I, E> outEdges = convertInputToComputeEdges(
-                    removePartitionEdges(entry, partitionEdges));
+                  getPartitionEdges(entry));
+                iterator.remove();
                 Vertex<I, V, E> vertex = partition.getVertex(vertexId);
                 // If the source vertex doesn't exist, create it. Otherwise,
                 // just set the edges.
diff --git a/giraph-core/src/main/java/org/apache/giraph/edge/SimpleEdgeStore.java b/giraph-core/src/main/java/org/apache/giraph/edge/SimpleEdgeStore.java
index a6a33565c..3eb97d6b8 100644
--- a/giraph-core/src/main/java/org/apache/giraph/edge/SimpleEdgeStore.java
+++ b/giraph-core/src/main/java/org/apache/giraph/edge/SimpleEdgeStore.java
@@ -87,10 +87,9 @@ protected ConcurrentMap<I, OutEdges<I, E>> getPartitionEdges(
   }
 
   @Override
-  protected OutEdges<I, E> removePartitionEdges(
-      Map.Entry<I, OutEdges<I, E>> entry,
-      Map<I, OutEdges<I, E>> partitionEdges) {
-    return partitionEdges.put(entry.getKey(), null);
+  protected OutEdges<I, E> getPartitionEdges(
+    Map.Entry<I, OutEdges<I, E>> entry) {
+    return entry.getValue();
   }
 
   @Override
diff --git a/giraph-core/src/main/java/org/apache/giraph/edge/primitives/IntEdgeStore.java b/giraph-core/src/main/java/org/apache/giraph/edge/primitives/IntEdgeStore.java
index 826c68526..b138f4964 100644
--- a/giraph-core/src/main/java/org/apache/giraph/edge/primitives/IntEdgeStore.java
+++ b/giraph-core/src/main/java/org/apache/giraph/edge/primitives/IntEdgeStore.java
@@ -75,10 +75,9 @@ protected IntWritable createVertexId(
   }
 
   @Override
-  protected OutEdges<IntWritable, E> removePartitionEdges(
-    Int2ObjectMap.Entry<OutEdges<IntWritable, E>> entry,
-    Map<Integer, OutEdges<IntWritable, E>> partitionEdges) {
-    return partitionEdges.put(entry.getIntKey(), null);
+  protected OutEdges<IntWritable, E> getPartitionEdges(
+    Int2ObjectMap.Entry<OutEdges<IntWritable, E>> entry) {
+    return entry.getValue();
   }
 
   @Override
diff --git a/giraph-core/src/main/java/org/apache/giraph/edge/primitives/LongEdgeStore.java b/giraph-core/src/main/java/org/apache/giraph/edge/primitives/LongEdgeStore.java
index 486410ff7..61f908a06 100644
--- a/giraph-core/src/main/java/org/apache/giraph/edge/primitives/LongEdgeStore.java
+++ b/giraph-core/src/main/java/org/apache/giraph/edge/primitives/LongEdgeStore.java
@@ -76,10 +76,9 @@ protected LongWritable createVertexId(
 
 
   @Override
-  protected OutEdges<LongWritable, E> removePartitionEdges(
-      Long2ObjectMap.Entry<OutEdges<LongWritable, E>> entry,
-      Map<Long, OutEdges<LongWritable, E>> partitionEdges) {
-    return partitionEdges.put(entry.getLongKey(), null);
+  protected OutEdges<LongWritable, E> getPartitionEdges(
+    Long2ObjectMap.Entry<OutEdges<LongWritable, E>> entry) {
+    return entry.getValue();
   }
 
   @Override
