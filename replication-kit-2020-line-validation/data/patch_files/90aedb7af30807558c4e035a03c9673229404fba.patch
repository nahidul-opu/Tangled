From 90aedb7af30807558c4e035a03c9673229404fba Mon Sep 17 00:00:00 2001
From: Henry Saputra <hsaputra@apache.org>
Date: Tue, 21 Jan 2014 07:29:24 +0000
Subject: [PATCH] GORA-290 StatefulHashMap removes the entry when put with same
 value. Thanks Alparslan.

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1559929 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                   | 2 ++
 .../java/org/apache/gora/persistency/StatefulHashMap.java     | 2 +-
 .../test/java/org/apache/gora/store/DataStoreTestUtil.java    | 4 ++++
 3 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 76ef5b11f..7256d77c7 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -4,6 +4,8 @@
 
 Gora Change Log
 
+* GORA-290 StatefulHashMap removes the entry when put with same value (Alparslan Avci via hsaputra)
+
 * GORA-231 Provide better error handling in AccumuloStore.readMapping when file does not exist (Apostolos Giannakidis)
 
 * GORA-283 Specify field name for types not being considered in gora-cassandra (lewismc)
diff --git a/gora-core/src/main/java/org/apache/gora/persistency/StatefulHashMap.java b/gora-core/src/main/java/org/apache/gora/persistency/StatefulHashMap.java
index 7615035cb..6307c004b 100644
--- a/gora-core/src/main/java/org/apache/gora/persistency/StatefulHashMap.java
+++ b/gora-core/src/main/java/org/apache/gora/persistency/StatefulHashMap.java
@@ -55,10 +55,10 @@ public StatefulHashMap(Map<K, V> m) {
   
   @Override
   public V put(K key, V value) {
-    keyStates.remove(key);
     V old = super.put(key, value);
     //if old value is different or null, set state to dirty
     if (!value.equals(old)) {
+      keyStates.remove(key);
       keyStates.put(key, State.DIRTY);
     }
     return old;
diff --git a/gora-core/src/test/java/org/apache/gora/store/DataStoreTestUtil.java b/gora-core/src/test/java/org/apache/gora/store/DataStoreTestUtil.java
index e70b63e04..d093b240e 100644
--- a/gora-core/src/test/java/org/apache/gora/store/DataStoreTestUtil.java
+++ b/gora-core/src/test/java/org/apache/gora/store/DataStoreTestUtil.java
@@ -380,6 +380,10 @@ public static void testUpdateWebPage(DataStore<String, WebPage> dataStore)
       for (int j = 1; j < urls.length; j += 2) {
         webPage.putToOutlinks(new Utf8(anchor + j), new Utf8(urls[j]));
       }
+      //test for double put of same entries
+      for (int j = 1; j < urls.length; j += 2) {
+        webPage.putToOutlinks(new Utf8(anchor + j), new Utf8(urls[j]));
+      }
       dataStore.put(webPage.getUrl().toString(), webPage);
     }
 
