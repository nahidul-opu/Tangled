From 799f674dffd9ac1406c52cb6d9d2077126b5be0d Mon Sep 17 00:00:00 2001
From: Niall Pemberton <niallp@apache.org>
Date: Mon, 11 Jun 2007 15:42:53 +0000
Subject: [PATCH] Fix for BEANUTILS-283 - ConvertUtilsBean doesn't handle
 conversion to String correctly - thanks to Josef Cacek

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/beanutils/trunk@546174 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/beanutils/ConvertUtilsBean.java   |  4 +--
 .../beanutils/ConvertUtilsTestCase.java       | 25 +++++++++++++++++++
 2 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/beanutils/ConvertUtilsBean.java b/src/java/org/apache/commons/beanutils/ConvertUtilsBean.java
index 41bd900da..c95fa0629 100644
--- a/src/java/org/apache/commons/beanutils/ConvertUtilsBean.java
+++ b/src/java/org/apache/commons/beanutils/ConvertUtilsBean.java
@@ -542,8 +542,8 @@ public Object convert(Object value, Class targetType) {
             }
             converted = converter.convert(targetType, value);
         }
-        if (targetType == String.class && value != null) {
-            converted = value.toString();
+        if (targetType == String.class && converted != null) {
+            converted = converted.toString();
         }
         return converted;
 
diff --git a/src/test/org/apache/commons/beanutils/ConvertUtilsTestCase.java b/src/test/org/apache/commons/beanutils/ConvertUtilsTestCase.java
index 957817a7a..7b116dfaa 100644
--- a/src/test/org/apache/commons/beanutils/ConvertUtilsTestCase.java
+++ b/src/test/org/apache/commons/beanutils/ConvertUtilsTestCase.java
@@ -21,6 +21,10 @@
 import java.sql.Date;
 import java.sql.Time;
 import java.sql.Timestamp;
+import java.text.DateFormat;
+import java.text.SimpleDateFormat;
+import java.util.Locale;
+import org.apache.commons.beanutils.converters.DateConverter;
 import junit.framework.TestCase;
 import junit.framework.Test;
 import junit.framework.TestSuite;
@@ -609,6 +613,27 @@ public void testDeregisteringSingleConverter() throws Exception {
 
     }
 
+    public void testConvertToString() throws Exception {
+
+        ConvertUtilsBean utils = new ConvertUtilsBean();
+
+        // Register a DateConverter using Locale.US
+        DateConverter dateConverter = new DateConverter();
+        dateConverter.setLocale(Locale.US);
+        utils.register(dateConverter, java.util.Date.class);
+
+        java.util.Date today = new java.util.Date();
+        DateFormat fmt = new SimpleDateFormat("M/d/yy"); /* US Short Format */
+        String expected = fmt.format(today);
+
+        assertEquals("date M/d/yy", expected, utils.convert(today, String.class));
+        
+        // Remove the registered DateConverter
+        utils.deregister(java.util.Date.class);
+        assertEquals("Date.toString()", today.toString(), utils.convert(today, String.class));
+        
+    }
+
     // -------------------------------------------------------- Private Methods
 
 
