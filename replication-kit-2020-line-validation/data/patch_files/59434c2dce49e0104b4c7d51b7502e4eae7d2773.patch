From 59434c2dce49e0104b4c7d51b7502e4eae7d2773 Mon Sep 17 00:00:00 2001
From: Luc Maisonobe <luc@apache.org>
Date: Wed, 3 Jun 2009 09:06:08 +0000
Subject: [PATCH] Fixed a wrong check for basic variables JIRA: MATH-273

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/math/trunk@781304 13f79535-47bb-0310-9956-ffa450edef68
---
 .../math/optimization/linear/SimplexTableau.java     | 10 ++++------
 src/site/xdoc/changes.xml                            |  3 +++
 .../math/optimization/linear/SimplexSolverTest.java  | 12 ++++++++++++
 3 files changed, 19 insertions(+), 6 deletions(-)

diff --git a/src/java/org/apache/commons/math/optimization/linear/SimplexTableau.java b/src/java/org/apache/commons/math/optimization/linear/SimplexTableau.java
index a6d7419cf6..b0d114eea9 100644
--- a/src/java/org/apache/commons/math/optimization/linear/SimplexTableau.java
+++ b/src/java/org/apache/commons/math/optimization/linear/SimplexTableau.java
@@ -272,12 +272,10 @@ protected static double getInvertedCoeffiecientSum(final RealVector coefficients
     private Integer getBasicRow(final int col) {
         Integer row = null;
         for (int i = getNumObjectiveFunctions(); i < getHeight(); i++) {
-            if (!MathUtils.equals(getEntry(i, col), 0.0, epsilon)) {
-                if (row == null) {
-                    row = i;
-                } else {
-                    return null;
-                }
+            if (MathUtils.equals(getEntry(i, col), 1.0, epsilon) && (row == null)) {
+                row = i;
+            } else if (!MathUtils.equals(getEntry(i, col), 0.0, epsilon)) {
+                return null;
             }
         }
         return row;
diff --git a/src/site/xdoc/changes.xml b/src/site/xdoc/changes.xml
index 4f53d0cb48..a1fe400a6a 100644
--- a/src/site/xdoc/changes.xml
+++ b/src/site/xdoc/changes.xml
@@ -39,6 +39,9 @@ The <action> type attribute can be add,update,fix,remove.
   </properties>
   <body>
     <release version="2.0" date="TBD" description="TBD">
+      <action dev="luc" type="fix" issue="MATH-273" due-to="Benjamin McCann">
+        Fixed a wrong check for basic variables
+      </action>
       <action dev="luc" type="fix" issue="MATH-272" due-to="Benjamin McCann">
         Fixed a problem when setting some variables (several variables were set
         instead of only one)
diff --git a/src/test/org/apache/commons/math/optimization/linear/SimplexSolverTest.java b/src/test/org/apache/commons/math/optimization/linear/SimplexSolverTest.java
index 8066185770..954ad7ca09 100644
--- a/src/test/org/apache/commons/math/optimization/linear/SimplexSolverTest.java
+++ b/src/test/org/apache/commons/math/optimization/linear/SimplexSolverTest.java
@@ -64,6 +64,18 @@ public void testSimplexSolver() throws OptimizationException {
         assertEquals(57.0, solution.getValue(), 0.0);
     }
 
+    @Test
+    public void testSingleVariableAndConstraint() throws OptimizationException {
+        LinearObjectiveFunction f = new LinearObjectiveFunction(new double[] { 3 }, 0);
+        Collection<LinearConstraint> constraints = new ArrayList<LinearConstraint>();
+        constraints.add(new LinearConstraint(new double[] { 1 }, Relationship.LEQ, 10));
+
+        SimplexSolver solver = new SimplexSolver();
+        RealPointValuePair solution = solver.optimize(f, constraints, GoalType.MAXIMIZE, false);
+        assertEquals(10.0, solution.getPoint()[0], 0.0);
+        assertEquals(30.0, solution.getValue(), 0.0);
+    }
+    
     /**
      * With no artificial variables needed (no equals and no greater than
      * constraints) we can go straight to Phase 2.
