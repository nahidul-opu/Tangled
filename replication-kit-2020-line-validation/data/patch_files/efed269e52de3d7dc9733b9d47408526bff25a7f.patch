From efed269e52de3d7dc9733b9d47408526bff25a7f Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Wed, 12 Dec 2012 11:15:54 +0000
Subject: [PATCH] NET-492 FTPClient.printWorkingDirectory() incorrectly parses
 certain valid PWD command results

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1420619 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  8 ++++++-
 .../org/apache/commons/net/ftp/FTPClient.java | 21 ++++++++-----------
 2 files changed, 16 insertions(+), 13 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 962fca7ec..2618f7685 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -62,7 +62,13 @@ The <action> type attribute can be add,update,fix,remove.
      -->
 
     <body>
-        <release version="3.2" date="TBA" description="
+        <release version="3.3" date="TBA" description="
+        ">
+            <action issue="NET-492" dev="sebb" type="fix">
+            FTPClient.printWorkingDirectory() incorrectly parses certain valid PWD command results
+            </action>
+        </release>
+        <release version="3.2" date="2012-12-03" description="
 This release fixes bugs and adds some new functionality (see below).
  It is binary compatible with previous releases.
  Note that Clirr shows that two public methods have been removed (NET-485). These are not used within NET.
diff --git a/src/main/java/org/apache/commons/net/ftp/FTPClient.java b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
index e4d2c3ead..11a5793e1 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
@@ -484,11 +484,12 @@ private void __initDefaults()
 
     /**
      * Parse the pathname from a CWD reply.
+     * <p>
      * According to RFC959 (http://www.ietf.org/rfc/rfc959.txt), 
-     * it should be the same as for MKD, i.e.
-     * 257<space>"<directory-name>"<space><commentary>
-     * where any embedded double-quotes are doubled.
-     * 
+     * it should be the same as for MKD - but without commentary - i.e.
+     * {@code 257<space>"<directory-name>"}
+     * where any double-quotes in <directory-name> are doubled.
+     * <p>
      * However, see NET-442 for an exception.
      * 
      * @param reply
@@ -496,16 +497,12 @@ private void __initDefaults()
      */
     private static String __parsePathname(String reply)
     {
-        int begin = reply.indexOf('"'); // find first double quote
-        if (begin == -1) { // not found, return all after reply code and space
-            return reply.substring(REPLY_CODE_LEN + 1);
-        }
-        int end = reply.lastIndexOf("\" "); // N.B. assume commentary does not contain double-quote
-        if (end != -1 ){ // found end of quoted string, de-duplicate any embedded quotes
-            return reply.substring(begin+1, end).replace("\"\"", "\"");            
+        String param = reply.substring(REPLY_CODE_LEN + 1);
+        if (param.startsWith("\"") && param.endsWith("\"")) {
+            return param.substring(1, param.length()-1).replace("\"\"", "\"");            
         }
         // malformed reply, return all after reply code and space
-        return reply.substring(REPLY_CODE_LEN + 1);
+        return param;
     }
 
     /**
