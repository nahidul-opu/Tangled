From 30d4b7bd496feaca6b37d23569fceff1738a643a Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 8 Feb 2008 17:00:10 +0000
Subject: [PATCH] FIX: Bad conflict resolution leads to bad "configuration(s)
 not found" error (IVY-729)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@619939 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/core/resolve/ResolveEngine.java       |  3 +-
 .../apache/ivy/core/resolve/ResolveTest.java  | 10 +++++
 test/repositories/IVY-729/a/1/jars/a-1.jar    |  0
 test/repositories/IVY-729/b/1/ivy.xml         | 10 +++++
 test/repositories/IVY-729/b/1/jars/b-1.jar    |  0
 test/repositories/IVY-729/c/1/ivy.xml         | 14 +++++++
 test/repositories/IVY-729/c/1/jars/c-1.jar    |  0
 test/repositories/IVY-729/ivy.xml             | 42 +++++++++++++++++++
 test/repositories/IVY-729/ivysettings.xml     |  9 ++++
 10 files changed, 88 insertions(+), 1 deletion(-)
 create mode 100644 test/repositories/IVY-729/a/1/jars/a-1.jar
 create mode 100644 test/repositories/IVY-729/b/1/ivy.xml
 create mode 100644 test/repositories/IVY-729/b/1/jars/b-1.jar
 create mode 100644 test/repositories/IVY-729/c/1/ivy.xml
 create mode 100644 test/repositories/IVY-729/c/1/jars/c-1.jar
 create mode 100644 test/repositories/IVY-729/ivy.xml
 create mode 100644 test/repositories/IVY-729/ivysettings.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 897b9c856..0a5a68767 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -78,6 +78,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Downgrade Ant version requirement to 1.6 to build Ivy (IVY-687)
 - IMPROVEMENT: In the ResolveReport class, add the possibility to filter the evicted module while getting the list of DownloadArtifact (IVY-704) (thanks to Nicolas Lalevée)
 
+- FIX: Bad conflict resolution leads to bad "configuration(s) not found" error (IVY-729)
 - FIX: Resolving for muyltiple configurations when one is not in the list of available configurations does not abort the build (IVY-720)
 - FIX: Branch attribute considered as both a standard and extra attribute on module info (IVY-726)
 - FIX: Branch attribute not set on deliver when using a non default branch (IVY-724)
diff --git a/src/java/org/apache/ivy/core/resolve/ResolveEngine.java b/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
index d7dce7f10..89c88d48f 100644
--- a/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
+++ b/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
@@ -908,7 +908,8 @@ private Collection computeConflicts(VisitNode node, VisitNode ancestor, String c
         } else if (resolvedNodes.isEmpty() && node.getParent() != ancestor) {
             //Conflict must only be computed per root configuration at this step.
             Collection ancestorDepIvyNodes = node.getParent().getNode()
-                        .getDependencies(node.getRootModuleConf(), new String[] {conf});
+                        .getDependencies(node.getRootModuleConf(), 
+                            new String[] {node.getParentConf()});
             for (Iterator it = ancestorDepIvyNodes.iterator(); it.hasNext();) {
                 IvyNode ancestorDep = (IvyNode) it.next();
                 if (ancestorDep.getModuleId().equals(node.getModuleId())) {
diff --git a/test/java/org/apache/ivy/core/resolve/ResolveTest.java b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
index 944eb2cea..85629fee1 100644
--- a/test/java/org/apache/ivy/core/resolve/ResolveTest.java
+++ b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
@@ -2604,6 +2604,16 @@ public void testIVY218() throws Exception {
                 .getArtifactsNumber());
     }
 
+    public void testIVY729() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-729/ivysettings.xml"));
+
+        ResolveReport report = ivy.resolve(new File(
+                "test/repositories/IVY-729/ivy.xml").toURL(), 
+                getResolveOptions(new String[] {"*"}));
+        assertFalse(report.hasError());
+    }
+
     public void testCircular() throws Exception {
         // mod6.3 depends on mod6.2, which itself depends on mod6.3
 
diff --git a/test/repositories/IVY-729/a/1/jars/a-1.jar b/test/repositories/IVY-729/a/1/jars/a-1.jar
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-729/b/1/ivy.xml b/test/repositories/IVY-729/b/1/ivy.xml
new file mode 100644
index 000000000..07aa301f5
--- /dev/null
+++ b/test/repositories/IVY-729/b/1/ivy.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ivy-module version="2.0">
+	<info organisation="test" module="b" revision="1" status="release"/>
+	<configurations>
+		<conf name="compile"/>
+	</configurations>
+	<publications>
+		<artifact name="b" type="jar" conf="compile"/>
+	</publications>
+</ivy-module>
diff --git a/test/repositories/IVY-729/b/1/jars/b-1.jar b/test/repositories/IVY-729/b/1/jars/b-1.jar
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-729/c/1/ivy.xml b/test/repositories/IVY-729/c/1/ivy.xml
new file mode 100644
index 000000000..56fb9f3d0
--- /dev/null
+++ b/test/repositories/IVY-729/c/1/ivy.xml
@@ -0,0 +1,14 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ivy-module version="2.0">
+	<info organisation="test" module="c" revision="1" status="release"/>
+	<configurations>
+		<conf name="compile"/>
+	</configurations>
+	<publications>
+		<artifact name="c" type="jar" conf="compile"/>
+	</publications>
+	<dependencies>
+		<dependency org="test" name="a" rev="1" conf="compile->*"/>
+		<dependency org="test" name="b" rev="1" conf="%->@"/>
+	</dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-729/c/1/jars/c-1.jar b/test/repositories/IVY-729/c/1/jars/c-1.jar
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-729/ivy.xml b/test/repositories/IVY-729/ivy.xml
new file mode 100644
index 000000000..31cdead3b
--- /dev/null
+++ b/test/repositories/IVY-729/ivy.xml
@@ -0,0 +1,42 @@
+<ivy-module
+version="2.0"
+xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+
+
+xsi:noNamespaceSchemaLocation="http://ant.apache.org/ivy/schemas/ivy.xsd">
+
+<info
+organisation="test"
+module="test"/>
+
+<configurations>
+
+
+<conf
+name="conf1"/>
+
+
+<conf
+name="conf2"/>
+
+</configurations>
+
+<dependencies>
+
+
+<dependency
+org="test"
+name="a"
+rev="1"
+conf="conf1->*"/>
+
+
+<dependency
+org="test"
+name="c"
+rev="1"
+conf="conf2->compile"/>
+
+</dependencies>
+</ivy-module>
+
diff --git a/test/repositories/IVY-729/ivysettings.xml b/test/repositories/IVY-729/ivysettings.xml
new file mode 100644
index 000000000..e1bf5acd8
--- /dev/null
+++ b/test/repositories/IVY-729/ivysettings.xml
@@ -0,0 +1,9 @@
+<ivysettings>
+    <settings defaultResolver="test"/>
+    <resolvers>
+        <filesystem name="test">
+            <ivy pattern="${ivy.settings.dir}/[module]/[revision]/ivy.xml" />
+            <artifact pattern="${ivy.settings.dir}/[module]/[revision]/[type]s/[artifact]-[revision].[ext]" />
+        </filesystem>
+    </resolvers>
+</ivysettings>
\ No newline at end of file
