From 45ba15c8d90f457766ca52e21ea432b0ca88d07c Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Tue, 2 Aug 2011 20:15:46 +0000
Subject: [PATCH] [CONFIGURATION-458] Provide a specific implementation of
 clear() in AbstractHierarchicalConfiguration. Ported fix to branch.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/configuration2_experimental@1153263 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  5 ++++
 .../AbstractHierarchicalConfiguration.java    | 27 +++++++++++++++++++
 .../TestInMemoryConfiguration.java            |  8 ++++++
 3 files changed, 40 insertions(+)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 67d544c600..9de9ed3ccb 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -79,6 +79,11 @@
     </release>
 
     <release version="1.7" date="in SVN" description="">
+      <action dev="oheger" type="add" issue="CONFIGURATION-458">
+        HierarchicalConfiguration now provides a specific implementation of the
+        clear() method. This is more efficient and also solves some other
+        problems related to clearing a SubnodeConfiguration.
+      </action>
       <action dev="oheger" type="add" issue="CONFIGURATION-452">
         XPathExpressionEngine now provides better support for the setProperty()
         method.
diff --git a/src/main/java/org/apache/commons/configuration2/AbstractHierarchicalConfiguration.java b/src/main/java/org/apache/commons/configuration2/AbstractHierarchicalConfiguration.java
index 92baaea345..fc64c80391 100644
--- a/src/main/java/org/apache/commons/configuration2/AbstractHierarchicalConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration2/AbstractHierarchicalConfiguration.java
@@ -527,6 +527,33 @@ public void setProperty(String key, Object value)
         fireEvent(EVENT_SET_PROPERTY, key, value, false);
     }
 
+    /**
+     * Clears this configuration. This is a more efficient implementation than
+     * the one inherited from the base class. It directly removes all data from
+     * the root node.
+     */
+    @Override
+    public void clear()
+    {
+        fireEvent(EVENT_CLEAR, null, null, true);
+        List<T> children =
+                new ArrayList<T>(getNodeHandler().getChildren(getRootNode()));
+        for (T child : children)
+        {
+            getNodeHandler().removeChild(getRootNode(), child);
+        }
+
+        List<String> attrs =
+                new ArrayList<String>(getNodeHandler().getAttributes(
+                        getRootNode()));
+        for (String attr : attrs)
+        {
+            getNodeHandler().removeAttribute(getRootNode(), attr);
+        }
+        getNodeHandler().setValue(getRootNode(), null);
+        fireEvent(EVENT_CLEAR, null, null, false);
+    }
+
     /**
      * Removes all values of the property with the given name and of keys that
      * start with this name. So if there is a property with the key
diff --git a/src/test/java/org/apache/commons/configuration2/TestInMemoryConfiguration.java b/src/test/java/org/apache/commons/configuration2/TestInMemoryConfiguration.java
index 17b331f3c8..4f27487c3e 100644
--- a/src/test/java/org/apache/commons/configuration2/TestInMemoryConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration2/TestInMemoryConfiguration.java
@@ -179,6 +179,14 @@ public void testSetProperty()
         assertEquals(42, config.getInt("test.items.item"));
     }
 
+    public void testClear()
+    {
+        config.setProperty(null, "value");
+        config.addProperty("[@attr]", "defined");
+        config.clear();
+        assertTrue("Configuration not empty", config.isEmpty());
+    }
+
     public void testClearProperty()
     {
         config.clearProperty("tables.table(0).fields.field(0).name");
