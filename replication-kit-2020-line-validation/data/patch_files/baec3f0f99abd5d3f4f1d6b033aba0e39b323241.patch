From baec3f0f99abd5d3f4f1d6b033aba0e39b323241 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 11 May 2010 00:05:11 +0000
Subject: [PATCH] NET-264 Telnet spyStream NullPointerException

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/branches/NET_2_0@942955 13f79535-47bb-0310-9956-ffa450edef68
---
 .../org/apache/commons/net/telnet/Telnet.java  | 18 ++++++++++--------
 1 file changed, 10 insertions(+), 8 deletions(-)

diff --git a/src/main/java/org/apache/commons/net/telnet/Telnet.java b/src/main/java/org/apache/commons/net/telnet/Telnet.java
index 064778ae1..ff54b33ca 100644
--- a/src/main/java/org/apache/commons/net/telnet/Telnet.java
+++ b/src/main/java/org/apache/commons/net/telnet/Telnet.java
@@ -125,7 +125,7 @@ class Telnet extends SocketClient
     /***
      * The stream on which to spy
      ***/
-    private OutputStream spyStream = null;
+    private volatile OutputStream spyStream = null;
 
     /***
      * The notification handler
@@ -1248,18 +1248,19 @@ void _stopSpyStream()
      ***/
     void _spyRead(int ch)
     {
-        if (spyStream != null)
+        OutputStream spy = spyStream;
+        if (spy != null)
         {
             try
             {
                 if (ch != '\r')
                 {
-                    spyStream.write(ch);
+                    spy.write(ch);
                     if (ch == '\n')
                     {
-                        spyStream.write('\r');
+                        spy.write('\r');
                     }
-                    spyStream.flush();
+                    spy.flush();
                 }
             }
             catch (IOException e)
@@ -1279,12 +1280,13 @@ void _spyWrite(int ch)
         if (!(_stateIsDo(TelnetOption.ECHO)
             && _requestedDo(TelnetOption.ECHO)))
         {
-            if (spyStream != null)
+            OutputStream spy = spyStream;
+            if (spy != null)
             {
                 try
                 {
-                    spyStream.write(ch);
-                    spyStream.flush();
+                    spy.write(ch);
+                    spy.flush();
                 }
                 catch (IOException e)
                 {
