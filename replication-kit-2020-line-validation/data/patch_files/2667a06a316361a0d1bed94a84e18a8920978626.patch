From 2667a06a316361a0d1bed94a84e18a8920978626 Mon Sep 17 00:00:00 2001
From: Scokart Gilles <gscokart@apache.org>
Date: Sun, 20 Jul 2008 10:12:00 +0000
Subject: [PATCH] FIX: Ivy causes IveDE to fail where a properties file is
 relative to ivyconf.xml (IVY-573) (thank to Jamie Burns)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@678265 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  2 +
 .../core/settings/XmlSettingsParserTest.java  |  9 ++++
 ...ivyconf-properties-relative-to-ivyconf.xml | 50 +++++++++++++++++++
 3 files changed, 61 insertions(+)
 create mode 100644 test/java/org/apache/ivy/core/settings/ivyconf-properties-relative-to-ivyconf.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 2c25a75f7..101deeba6 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -21,6 +21,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Matthieu Brouillard
 	Carlton Brown
 	Mirko Bulovic
+	Jamie Burns
 	Kristian Cibulskis
 	Andrea Bernardo Ciddio
 	Archie Cobbs
@@ -161,6 +162,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: The Bundle-Version is 0.0.0 in the build artifacts (IVY-802)
 - FIX: Fix the encoding used in XML reports (IVY-816)
 - FIX: Properties tag in ivy conf do not support relative path (IVY-89)
+- FIX: Ivy causes IveDE to fail where a properties file is relative to ivyconf.xml (IVY-573)
 
 - DOCUMENTATION: Fixed more than a hundred (100+) obsolete "configuration" references; replaced with "settings" (IVY-863) (thanks to Sakari Maaranen)
 - DOCUMENTATION: Elaborated documentation of ivy files and deliver/publish tasks (IVY-847) (thanks to Sakari Maaranen)
diff --git a/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java b/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java
index 50fa89a52..069887580 100644
--- a/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java
+++ b/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java
@@ -475,6 +475,15 @@ public void testIncludeMissingFile() throws Exception {
     }
 
     
+    public void testRelativePropertiesFile() throws Exception {
+        IvySettings settings = new IvySettings();
+        XmlSettingsParser parser = new XmlSettingsParser(settings);
+        parser.parse(XmlSettingsParser.class
+                .getResource("ivyconf-properties-relative-to-ivyconf.xml"));
+
+        assertEquals("lib", settings.getVariable("libraries.dir"));
+    }
+    
     public void testParser() throws Exception {
         IvySettings settings = new IvySettings();
         XmlSettingsParser parser = new XmlSettingsParser(settings);
diff --git a/test/java/org/apache/ivy/core/settings/ivyconf-properties-relative-to-ivyconf.xml b/test/java/org/apache/ivy/core/settings/ivyconf-properties-relative-to-ivyconf.xml
new file mode 100644
index 000000000..cbc4c45a4
--- /dev/null
+++ b/test/java/org/apache/ivy/core/settings/ivyconf-properties-relative-to-ivyconf.xml
@@ -0,0 +1,50 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivysettings>
+	<!-- properties file is relative to ivyconf.xml - ie this file -->
+	<properties file="ivysettings.properties"/>
+	
+	<conf defaultCache="mycache" defaultResolver="libraries"	validate="false"
+	   checkUpToDate="false" cacheIvyPattern="[module]/ivys/ivy-[revision].xml"
+	   cacheArtifactPattern="[module]/[type]s/[artifact]-[revision].[ext]"/>
+	   
+	<latest-strategies>
+	   <latest-revision name="mylatest-revision">
+	    	<specialMeaning name="PRE" value="-2"/>
+	    	<specialMeaning name="QA" value="4"/>
+	   </latest-revision>
+	</latest-strategies>
+	<resolvers>
+		<chain name="internal">
+			<filesystem name="int1" latest="latest-time">
+				<ivy pattern="${shared}/[organisation]/[module]/ivys/ivy-[revision].xml"/>
+				<artifact pattern="${shared}/[organisation]/[module]/[type]s/[artifact]-[revision].[type]"/>
+			</filesystem>
+			<ibiblio name="int2"/>
+		</chain>
+		<filesystem name="libraries" latest="latest-revision">
+			<ivy pattern="${libraries.dir}/[organisation]/[module]/ivys/ivy-[revision].xml"/>
+			<artifact pattern="${libraries.dir}/[organisation]/[module]/[type]s/[artifact]-[revision].[type]"/>
+		</filesystem>
+	</resolvers>
+	<modules>
+		<module organisation="jayasoft" name="ivy*" matcher="glob" resolver="int1"/>
+		<module organisation="jayasoft" name=".*" resolver="internal"/>
+	</modules>
+</ivysettings>
