From 49a9e6e8742cb6e05abf0219705338d95f732e12 Mon Sep 17 00:00:00 2001
From: Gilles <erans@apache.org>
Date: Wed, 19 Aug 2015 23:10:07 +0200
Subject: [PATCH] MATH-1257

Increased accuracy.
---
 src/changes/changes.xml                               |  4 ++++
 .../math3/distribution/NormalDistribution.java        |  2 +-
 .../math3/distribution/NormalDistributionTest.java    | 11 +++++++++++
 3 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 124bfce626..0e1fc5f155 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -51,6 +51,10 @@ If the output is not quite correct, check for invisible trailing spaces!
   </properties>
   <body>
     <release version="3.6" date="XXXX-XX-XX" description="">
+      <action dev="erans" type="fix" issue="MATH-1257" due-to="Bill Murphy">
+        Better accuracy in computation of cumulative probability of "NormalDistribution"
+        (package "o.a.c.m.distribution").
+      </action>
       <action dev="erans" type="fix" issue="MATH-1256">
         Boundary check to construct an "Interval" (package "o.a.c.m.geometry.euclidean.oned").
       </action>
diff --git a/src/main/java/org/apache/commons/math3/distribution/NormalDistribution.java b/src/main/java/org/apache/commons/math3/distribution/NormalDistribution.java
index 0fc839f678..08cde66526 100644
--- a/src/main/java/org/apache/commons/math3/distribution/NormalDistribution.java
+++ b/src/main/java/org/apache/commons/math3/distribution/NormalDistribution.java
@@ -191,7 +191,7 @@ public double cumulativeProbability(double x)  {
         if (FastMath.abs(dev) > 40 * standardDeviation) {
             return dev < 0 ? 0.0d : 1.0d;
         }
-        return 0.5 * (1 + Erf.erf(dev / (standardDeviation * SQRT2)));
+        return 0.5 * Erf.erfc(-dev / (standardDeviation * SQRT2));
     }
 
     /** {@inheritDoc}
diff --git a/src/test/java/org/apache/commons/math3/distribution/NormalDistributionTest.java b/src/test/java/org/apache/commons/math3/distribution/NormalDistributionTest.java
index 5a7597bba4..1cd9d0f19f 100644
--- a/src/test/java/org/apache/commons/math3/distribution/NormalDistributionTest.java
+++ b/src/test/java/org/apache/commons/math3/distribution/NormalDistributionTest.java
@@ -110,6 +110,17 @@ public void testInverseCumulativeProbabilityExtremes() {
         verifyInverseCumulativeProbabilities();
     }
 
+    // MATH-1257
+    @Test
+    public void testCumulativeProbability() {
+        final RealDistribution dist = new NormalDistribution(0, 1);
+        double x = -10;
+        double expected = 7.61985e-24;
+        double v = dist.cumulativeProbability(x);
+        double tol = 1e-5;
+        Assert.assertEquals(1, v / expected, 1e-5);
+    }
+
     @Test
     public void testGetMean() {
         NormalDistribution distribution = (NormalDistribution) getDistribution();
