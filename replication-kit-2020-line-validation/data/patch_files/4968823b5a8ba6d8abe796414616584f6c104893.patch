From 4968823b5a8ba6d8abe796414616584f6c104893 Mon Sep 17 00:00:00 2001
From: Lewis John McGibbney <lewis.j.mcgibbney@jpl.nasa.gov>
Date: Tue, 26 Jan 2016 21:15:54 -0800
Subject: [PATCH] GORA-459 Resource leak due to unclosed Table this closes #51

---
 .../org/apache/gora/hbase/util/HBaseClusterSingleton.java  | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/gora-hbase/src/test/java/org/apache/gora/hbase/util/HBaseClusterSingleton.java b/gora-hbase/src/test/java/org/apache/gora/hbase/util/HBaseClusterSingleton.java
index 9de2dc218..41106453c 100644
--- a/gora-hbase/src/test/java/org/apache/gora/hbase/util/HBaseClusterSingleton.java
+++ b/gora-hbase/src/test/java/org/apache/gora/hbase/util/HBaseClusterSingleton.java
@@ -27,6 +27,7 @@
 import org.apache.hadoop.hbase.HTableDescriptor;
 import org.apache.hadoop.hbase.MiniHBaseCluster;
 import org.apache.hadoop.hbase.client.HBaseAdmin;
+import org.apache.hadoop.hbase.client.HTable;
 import org.apache.hadoop.hbase.util.Bytes;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -152,7 +153,8 @@ public void ensureTable(String tableName, String... columnFamilies) throws IOExc
   public void ensureTable(byte[] tableName, byte[][] cfs) throws IOException {
     HBaseAdmin admin = htu.getHBaseAdmin();
     if (!admin.tableExists(tableName)) {
-      htu.createTable(tableName, cfs);
+      HTable hTable = htu.createTable(tableName, cfs);
+      hTable.close();
     }
   }
 
@@ -163,7 +165,8 @@ public void ensureTable(byte[] tableName, byte[][] cfs) throws IOException {
   public void truncateAllTables() throws Exception {
     HBaseAdmin admin = htu.getHBaseAdmin();
     for(HTableDescriptor table:admin.listTables()) {
-      htu.truncateTable(table.getName());
+      HTable hTable = htu.truncateTable(table.getName());
+      hTable.close();
     }
   }
   
