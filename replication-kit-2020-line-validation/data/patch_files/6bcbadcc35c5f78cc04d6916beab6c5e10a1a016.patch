From 6bcbadcc35c5f78cc04d6916beab6c5e10a1a016 Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Thu, 21 Jul 2016 03:55:02 +0000
Subject: [PATCH] [DBCP-446] NullPointerException thrown when calling
 ManagedConnection.isClosed().

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1753636 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                   | 3 +++
 .../org/apache/commons/dbcp2/DelegatingConnection.java    | 3 +--
 .../apache/commons/dbcp2/TestDelegatingConnection.java    | 8 ++++++++
 3 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 6a5207653e..13f9f5c157 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -67,6 +67,9 @@ The <action> type attribute can be add,update,fix,remove.
         enables container-managed pools created from JNDI Resource
         definitions to enable JMX by supplying a valid root JMX name.  
       </action>
+      <action dev="ggregory" type="fix" issue="DBCP-446" due-to="Gary Gregory, feng yang, Euclides M, Phil Steitz">
+        NullPointerException thrown when calling ManagedConnection.isClosed().
+      </action>
       <action dev="psteitz" type="fix" issue="DBCP-444">
         InvalidateConnection can result in closed connection returned by getConnection.
       </action>
diff --git a/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java b/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java
index 71798b07b3..ac8320ed00 100644
--- a/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java
+++ b/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java
@@ -591,10 +591,9 @@ public void setTypeMap(final Map<String,Class<?>> map) throws SQLException {
         }
     }
 
-
     @Override
     public boolean isClosed() throws SQLException {
-        return _closed || _conn.isClosed();
+        return _closed || _conn == null || _conn.isClosed();
     }
 
     protected void checkOpen() throws SQLException {
diff --git a/src/test/java/org/apache/commons/dbcp2/TestDelegatingConnection.java b/src/test/java/org/apache/commons/dbcp2/TestDelegatingConnection.java
index ade401fd9d..610daf468d 100644
--- a/src/test/java/org/apache/commons/dbcp2/TestDelegatingConnection.java
+++ b/src/test/java/org/apache/commons/dbcp2/TestDelegatingConnection.java
@@ -139,4 +139,12 @@ public void testIsClosed() throws Exception {
         assertTrue(conn.isClosed());
     }
 
+    @Test
+    public void testIsClosedNullDelegate() throws Exception {
+        conn.checkOpen();
+        assertFalse(conn.isClosed());
+        conn.setDelegate(null);
+        assertTrue(conn.isClosed());
+    }
+
 }
