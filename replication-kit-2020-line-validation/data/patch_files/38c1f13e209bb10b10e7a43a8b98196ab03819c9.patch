From 38c1f13e209bb10b10e7a43a8b98196ab03819c9 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 25 Dec 2009 23:54:14 +0000
Subject: [PATCH] FIX: Ivy cannot parse alternate format for Maven MD5 files
 (IVY-1155)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@893901 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                         |  1 +
 src/java/org/apache/ivy/util/ChecksumHelper.java    | 13 +++++++++++++
 .../checksums/allright/allright-IVY-1155-1.0.jar    |  1 +
 .../allright/allright-IVY-1155-1.0.jar.md5          |  1 +
 test/repositories/checksums/allright/ivy-1.0.xml    |  1 +
 .../repositories/checksums/allright/ivy-1.0.xml.md5 |  2 +-
 6 files changed, 18 insertions(+), 1 deletion(-)
 create mode 100644 test/repositories/checksums/allright/allright-IVY-1155-1.0.jar
 create mode 100644 test/repositories/checksums/allright/allright-IVY-1155-1.0.jar.md5

diff --git a/CHANGES.txt b/CHANGES.txt
index c3d9a7ed5..14570aef0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -102,6 +102,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Trace a message when a property file referenced from the settings doesn't exixts (IVY-1074)
 - IMPROVEMENT: use defaultconf in combination with defaultconfmapping (IVY-1135) (thanks to Jon Schneider)
 
+- FIX: Ivy cannot parse alternate format for Maven MD5 files (IVY-1155)
 - FIX: Ivy does not close URL connection to ivy-report.xsl properly (IVY-1152)
 - FIX: Artifact report throws NPE when artifact is not in cache (IVY-1150) (thanks to Steve Jones)
 - FIX: resolve fails for transitive relocated maven modules when the type of the dependency was set to 'jar'
diff --git a/src/java/org/apache/ivy/util/ChecksumHelper.java b/src/java/org/apache/ivy/util/ChecksumHelper.java
index 26acad7a1..89379e64b 100644
--- a/src/java/org/apache/ivy/util/ChecksumHelper.java
+++ b/src/java/org/apache/ivy/util/ChecksumHelper.java
@@ -63,6 +63,19 @@ public static void check(File dest, File checksumFile, String algorithm) throws
             int spaceIndex = csFileContent.indexOf(' ');
             if (spaceIndex != -1) {
                 expected = csFileContent.substring(0, spaceIndex);
+                
+                // IVY-1155: support some strange formats like this one:
+                // http://repo2.maven.org/maven2/org/apache/pdfbox/fontbox/0.8.0-incubator/fontbox-0.8.0-incubator.jar.md5
+                if (expected.endsWith(":")) {
+                    StringBuffer result = new StringBuffer();
+                    char[] chars = csFileContent.substring(spaceIndex + 1).toCharArray();
+                    for (int i = 0; i < chars.length; i++) {
+                        if (!Character.isWhitespace(chars[i])) {
+                            result.append(chars[i]);
+                        }
+                    }
+                    expected = result.toString();
+                }
             } else {
                 expected = csFileContent;
             }
diff --git a/test/repositories/checksums/allright/allright-IVY-1155-1.0.jar b/test/repositories/checksums/allright/allright-IVY-1155-1.0.jar
new file mode 100644
index 000000000..caf506969
--- /dev/null
+++ b/test/repositories/checksums/allright/allright-IVY-1155-1.0.jar
@@ -0,0 +1 @@
+this is a completely fake jar file !!!
\ No newline at end of file
diff --git a/test/repositories/checksums/allright/allright-IVY-1155-1.0.jar.md5 b/test/repositories/checksums/allright/allright-IVY-1155-1.0.jar.md5
new file mode 100644
index 000000000..579086257
--- /dev/null
+++ b/test/repositories/checksums/allright/allright-IVY-1155-1.0.jar.md5
@@ -0,0 +1 @@
+allright-IVY-1155-1.0.jar: c6 72 cb e1 16 29 03 c3 c3 8c ce 53 47 9b 69 ad
\ No newline at end of file
diff --git a/test/repositories/checksums/allright/ivy-1.0.xml b/test/repositories/checksums/allright/ivy-1.0.xml
index b17aa4033..21acfac25 100644
--- a/test/repositories/checksums/allright/ivy-1.0.xml
+++ b/test/repositories/checksums/allright/ivy-1.0.xml
@@ -24,6 +24,7 @@
 	/>
 	<publications>
 		<artifact />
+        <artifact name="allright-IVY-1155" />
 		<artifact name="allright-with-path" />
 		<artifact name="allright-with-openssl" />
 	</publications>
diff --git a/test/repositories/checksums/allright/ivy-1.0.xml.md5 b/test/repositories/checksums/allright/ivy-1.0.xml.md5
index 9fcda6732..4ddb8d847 100644
--- a/test/repositories/checksums/allright/ivy-1.0.xml.md5
+++ b/test/repositories/checksums/allright/ivy-1.0.xml.md5
@@ -1 +1 @@
-e623dc9cd994a8b48e539882704afc54
\ No newline at end of file
+d60a4d715e3440514ab30c509f8678d4
\ No newline at end of file
