From 4aa4c6d31f98d8cd80ccbcf99ded77bfc6de25c5 Mon Sep 17 00:00:00 2001
From: Phil Steitz <phil.steitz@gmail.com>
Date: Sun, 8 Mar 2015 14:10:25 -0700
Subject: [PATCH] Made getKernel return a constant distribution for zero
 variance bins.  JIRA: MATH-1203.

---
 src/changes/changes.xml                           |  3 +++
 .../math4/random/EmpiricalDistribution.java       |  2 +-
 .../math4/random/EmpiricalDistributionTest.java   | 15 +++++++++++++++
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 4e5eb4d58b..08ba014028 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -54,6 +54,9 @@ If the output is not quite correct, check for invisible trailing spaces!
     </release>
 
     <release version="4.0" date="XXXX-XX-XX" description="">
+      <action dev="psteitz" type="fix" issue="MATH-1203">
+        EmpiricalDistribution getKernel fails for buckets with only multiple instances of the same value.
+      </action>
       <action dev="tn" type="update" issue="MATH-869">
         "SpearmansCorrelation" will now throw an "MathIllegalArgumentException"
         if provided with a "NaturalRanking" instance that uses "REMOVED" as "NaNStrategy".
diff --git a/src/main/java/org/apache/commons/math4/random/EmpiricalDistribution.java b/src/main/java/org/apache/commons/math4/random/EmpiricalDistribution.java
index 9458289fde..3b3a8642df 100644
--- a/src/main/java/org/apache/commons/math4/random/EmpiricalDistribution.java
+++ b/src/main/java/org/apache/commons/math4/random/EmpiricalDistribution.java
@@ -799,7 +799,7 @@ private double cumBinP(int binIndex) {
      * @return within-bin kernel parameterized by bStats
      */
     protected RealDistribution getKernel(SummaryStatistics bStats) {
-        if (bStats.getN() == 1) {
+        if (bStats.getN() == 1 || bStats.getVariance() == 0) {
             return new ConstantRealDistribution(bStats.getMean());
         } else {
             return new NormalDistribution(randomData.getRandomGenerator(),
diff --git a/src/test/java/org/apache/commons/math4/random/EmpiricalDistributionTest.java b/src/test/java/org/apache/commons/math4/random/EmpiricalDistributionTest.java
index fd4bd5a46d..9290c07032 100644
--- a/src/test/java/org/apache/commons/math4/random/EmpiricalDistributionTest.java
+++ b/src/test/java/org/apache/commons/math4/random/EmpiricalDistributionTest.java
@@ -430,6 +430,21 @@ public void testSampleValuesRange() {
         }
     }
     
+    /**
+     * MATH-1203
+     */
+    @Test
+    public void testNoBinVariance() {
+        final double[] data = {0, 0, 1, 1};
+        EmpiricalDistribution dist = new EmpiricalDistribution(2);
+        dist.load(data);
+        dist.reseedRandomGenerator(1000);
+        for (int i = 0; i < 1000; i++) {
+            final double dev = dist.sample();
+            Assert.assertTrue(dev == 0 || dev == 1);
+        }
+    }
+    
     /**
      * Find the bin that x belongs (relative to {@link #makeDistribution()}).
      */
