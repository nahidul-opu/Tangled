From 40f35da565aaba9ef14256ac36bbc04ae7e96116 Mon Sep 17 00:00:00 2001
From: Thomas Neidhart <thomas.neidhart@gmail.com>
Date: Thu, 22 Oct 2015 22:32:50 +0200
Subject: [PATCH] [MATH-1283] Fixed Gamma#gamma function for values smaller
 than -20. Thanks to Jean Noel Delavalade

---
 src/changes/changes.xml                           |  3 +++
 .../org/apache/commons/math3/special/Gamma.java   |  2 +-
 .../apache/commons/math3/special/GammaTest.java   | 15 +++++++++++++++
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 167f79fa2d..7a019df8ef 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -51,6 +51,9 @@ If the output is not quite correct, check for invisible trailing spaces!
   </properties>
   <body>
     <release version="3.6" date="XXXX-XX-XX" description="">
+      <action dev="tn" type="fix" issue="MATH-1283" due-to="Jean Noel Delavalade">
+        Fixed "Gamma#gamma(double)" for negative values smaller than -20.
+      </action>    
       <action dev="tn" type="fix" issue="MATH-1237" due-to="Ken Williams">
         Fixed javadoc of methods {floorDiv,floorMod} in class "FastMath".
       </action>
diff --git a/src/main/java/org/apache/commons/math3/special/Gamma.java b/src/main/java/org/apache/commons/math3/special/Gamma.java
index 47bf8aa203..aaa561ba44 100644
--- a/src/main/java/org/apache/commons/math3/special/Gamma.java
+++ b/src/main/java/org/apache/commons/math3/special/Gamma.java
@@ -695,7 +695,7 @@ public static double gamma(final double x) {
             }
         } else {
             final double y = absX + LANCZOS_G + 0.5;
-            final double gammaAbs = SQRT_TWO_PI / x *
+            final double gammaAbs = SQRT_TWO_PI / absX *
                                     FastMath.pow(y, absX + 0.5) *
                                     FastMath.exp(-y) * lanczos(absX);
             if (x > 0.0) {
diff --git a/src/test/java/org/apache/commons/math3/special/GammaTest.java b/src/test/java/org/apache/commons/math3/special/GammaTest.java
index 54691fd813..db4be46777 100644
--- a/src/test/java/org/apache/commons/math3/special/GammaTest.java
+++ b/src/test/java/org/apache/commons/math3/special/GammaTest.java
@@ -974,6 +974,21 @@ public void testGammaNegativeInteger() {
         }
     }
 
+    @Test
+    public void testGammaNegativeDouble() {
+        // check that the gamma function properly switches sign
+        // see: https://en.wikipedia.org/wiki/Gamma_function
+
+        double previousGamma = Gamma.gamma(-18.5);
+        for (double x = -19.5; x > -25; x -= 1.0) {
+            double gamma = Gamma.gamma(x);
+            Assert.assertEquals(  (int) FastMath.signum(previousGamma),
+                                - (int) FastMath.signum(gamma));
+
+            previousGamma = gamma;
+        }
+    }
+
     private void checkRelativeError(String msg, double expected, double actual,
                                     double tolerance) {
 
