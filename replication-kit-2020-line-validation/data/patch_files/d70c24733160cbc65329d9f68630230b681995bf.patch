From d70c24733160cbc65329d9f68630230b681995bf Mon Sep 17 00:00:00 2001
From: Joerg Schaible <joehni@apache.org>
Date: Tue, 3 May 2011 00:40:07 +0000
Subject: [PATCH] DBCP-359: DelegatingConnection.equals fails if both delegates
 are null

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1098877 13f79535-47bb-0310-9956-ffa450edef68
---
 src/java/org/apache/commons/dbcp/DelegatingConnection.java  | 6 ++----
 .../org/apache/commons/dbcp/TestDelegatingConnection.java   | 1 +
 2 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/src/java/org/apache/commons/dbcp/DelegatingConnection.java b/src/java/org/apache/commons/dbcp/DelegatingConnection.java
index 78b8da89e2..2c2e9576ac 100644
--- a/src/java/org/apache/commons/dbcp/DelegatingConnection.java
+++ b/src/java/org/apache/commons/dbcp/DelegatingConnection.java
@@ -182,12 +182,10 @@ public boolean equals(Object obj) {
             return true;
         }
         Connection delegate = getInnermostDelegateInternal();
-        if (delegate == null) {
-            return false;
-        }
         if (obj instanceof DelegatingConnection) {    
             DelegatingConnection c = (DelegatingConnection) obj;
-            return c.innermostDelegateEquals(delegate);
+            Connection cDelegate = c.getInnermostDelegateInternal();
+            return delegate == cDelegate || (delegate != null && delegate.equals(cDelegate));
         }
         else {
             return delegate.equals(obj);
diff --git a/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java b/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java
index b4d5932b9f..9032deafdb 100644
--- a/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java
+++ b/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java
@@ -81,6 +81,7 @@ public void testEquals() {
         assertTrue(conn3.equals(conn3));
         assertTrue(conn.equals(conn));
         assertTrue(conn2.equals(conn2));
+        assertTrue(conn3.equals(new DelegatingConnection(null)));
     }
     
     public void testCheckOpen() throws Exception {
