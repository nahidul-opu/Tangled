From 416bc3ab8fb1771f8d5e0acae7c7c2aa7ac3776f Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 29 Feb 2008 12:03:19 +0000
Subject: [PATCH] FIX: XML entity parsing does not work properly (IVY-737)
 (thanks to Patrick Woodworth)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@632301 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  2 ++
 .../ivy/core/settings/XmlSettingsParser.java  |  5 ++-
 .../xml/XmlModuleDescriptorUpdater.java       |  6 +++-
 src/java/org/apache/ivy/util/XMLHelper.java   | 11 ++++++-
 .../apache/ivy/core/resolve/ResolveTest.java  | 15 +++++++++
 test/repositories/xml-entities/bar.txt        |  1 +
 test/repositories/xml-entities/foo.txt        |  3 ++
 test/repositories/xml-entities/ivy.xml        | 29 ++++++++++++++++
 .../repositories/xml-entities/ivysettings.xml | 33 +++++++++++++++++++
 .../xml-entities/module1/ivy-1.0.xml          | 25 ++++++++++++++
 .../xml-entities/module2/ivy-2.0.xml          | 28 ++++++++++++++++
 11 files changed, 155 insertions(+), 3 deletions(-)
 create mode 100644 test/repositories/xml-entities/bar.txt
 create mode 100644 test/repositories/xml-entities/foo.txt
 create mode 100644 test/repositories/xml-entities/ivy.xml
 create mode 100644 test/repositories/xml-entities/ivysettings.xml
 create mode 100644 test/repositories/xml-entities/module1/ivy-1.0.xml
 create mode 100644 test/repositories/xml-entities/module2/ivy-2.0.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index b71a50ad0..5ab4d3e02 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -59,11 +59,13 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Jason Trump
 	Tjeerd Verhagen
 	John Williams
+	Patrick Woodworth
 	Jaroslaw Wypychowski
 
    trunk version
 =====================================
 - FIX: PublishEventsTest fails when Ivy sources are located in a directory with a + (IVY-755)
+- FIX: XML entity parsing does not work properly (IVY-737) (thanks to Patrick Woodworth)
 
    2.0.0-beta2
 =====================================
diff --git a/src/java/org/apache/ivy/core/settings/XmlSettingsParser.java b/src/java/org/apache/ivy/core/settings/XmlSettingsParser.java
index ee1153357..97aeb3b3f 100644
--- a/src/java/org/apache/ivy/core/settings/XmlSettingsParser.java
+++ b/src/java/org/apache/ivy/core/settings/XmlSettingsParser.java
@@ -43,6 +43,7 @@
 import org.apache.ivy.util.url.URLHandlerRegistry;
 import org.xml.sax.Attributes;
 import org.xml.sax.SAXException;
+import org.xml.sax.InputSource;
 import org.xml.sax.helpers.DefaultHandler;
 
 /**
@@ -96,7 +97,9 @@ private void doParse(URL settingsUrl) throws IOException, ParseException {
         InputStream stream = null;
         try {
             stream = URLHandlerRegistry.getDefault().openStream(settingsUrl);
-            SAXParserFactory.newInstance().newSAXParser().parse(stream, this);
+            InputSource inSrc = new InputSource(stream);
+            inSrc.setSystemId(settingsUrl.toExternalForm());
+            SAXParserFactory.newInstance().newSAXParser().parse(settingsUrl.toExternalForm(), this);
         } catch (IOException e) {
             throw e;
         } catch (Exception e) {
diff --git a/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java b/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java
index 27dca0aec..df1ecca89 100644
--- a/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java
+++ b/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java
@@ -57,6 +57,7 @@
 import org.xml.sax.Attributes;
 import org.xml.sax.SAXException;
 import org.xml.sax.SAXParseException;
+import org.xml.sax.InputSource;
 import org.xml.sax.ext.LexicalHandler;
 import org.xml.sax.helpers.DefaultHandler;
 
@@ -738,7 +739,10 @@ public static void update(final ParserSettings settings, URL inStreamCtx, InputS
         try {
             UpdaterHandler updaterHandler = new UpdaterHandler(settings, out, resolvedRevisions,
                     status, revision, pubdate, ns, replaceInclude, confsToExclude, inStreamCtx);
-            XMLHelper.parse(in, null, updaterHandler, updaterHandler);
+            InputSource inSrc = new InputSource(in);
+            if (inStreamCtx != null)
+                inSrc.setSystemId(inStreamCtx.toExternalForm());
+            XMLHelper.parse(inSrc, null, updaterHandler, updaterHandler);
         } catch (ParserConfigurationException e) {
             IllegalStateException ise = new IllegalStateException(
                     "impossible to update Ivy files: parser problem");
diff --git a/src/java/org/apache/ivy/util/XMLHelper.java b/src/java/org/apache/ivy/util/XMLHelper.java
index 067cdb7ec..197283312 100644
--- a/src/java/org/apache/ivy/util/XMLHelper.java
+++ b/src/java/org/apache/ivy/util/XMLHelper.java
@@ -32,6 +32,7 @@
 import org.w3c.dom.Document;
 import org.xml.sax.SAXException;
 import org.xml.sax.SAXNotRecognizedException;
+import org.xml.sax.InputSource;
 import org.xml.sax.ext.LexicalHandler;
 import org.xml.sax.helpers.DefaultHandler;
 
@@ -94,7 +95,9 @@ public static void parse(
             throws SAXException, IOException, ParserConfigurationException {
         InputStream xmlStream = URLHandlerRegistry.getDefault().openStream(xmlURL);
         try {
-            parse(xmlStream, schema, handler, lHandler);
+            InputSource inSrc = new InputSource(xmlStream);
+            inSrc.setSystemId(xmlURL.toExternalForm());
+            parse(inSrc, schema, handler, lHandler);
         } finally {
             try {
                 xmlStream.close();
@@ -107,6 +110,12 @@ public static void parse(
     public static void parse(
             InputStream xmlStream, URL schema, DefaultHandler handler, LexicalHandler lHandler) 
             throws SAXException, IOException, ParserConfigurationException {
+        parse(new InputSource(xmlStream), schema, handler, lHandler );
+    }
+
+    public static void parse(
+            InputSource xmlStream, URL schema, DefaultHandler handler, LexicalHandler lHandler)
+            throws SAXException, IOException, ParserConfigurationException {
         InputStream schemaStream = null;
         try {
             if (schema != null) {
diff --git a/test/java/org/apache/ivy/core/resolve/ResolveTest.java b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
index e7b83d77c..71322a804 100644
--- a/test/java/org/apache/ivy/core/resolve/ResolveTest.java
+++ b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
@@ -235,6 +235,21 @@ public void testResolveBadStatus() throws Exception {
         assertTrue(report.hasError());
     }
 
+    public void testResolveWithXmlEntities() throws Exception {
+        Ivy ivy = new Ivy();
+        Throwable th = null;
+        try {
+            ivy.configure(new File("test/repositories/xml-entities/ivysettings.xml").toURL());
+            ResolveReport report = ivy.resolve(new File("test/repositories/xml-entities/ivy.xml").toURL(),
+                getResolveOptions(new String[] {"*"}));
+            assertNotNull(report);
+            assertFalse(report.hasError());
+        } catch(Throwable e) {
+            th = e;
+        }
+        assertNull(th);
+    }
+
     public void testResolveNoRevisionInPattern() throws Exception {
         // module1 depends on latest version of module2, for which there is no revision in the
         // pattern
diff --git a/test/repositories/xml-entities/bar.txt b/test/repositories/xml-entities/bar.txt
new file mode 100644
index 000000000..95069c327
--- /dev/null
+++ b/test/repositories/xml-entities/bar.txt
@@ -0,0 +1 @@
+    <settings defaultResolver="myresolver"/>
diff --git a/test/repositories/xml-entities/foo.txt b/test/repositories/xml-entities/foo.txt
new file mode 100644
index 000000000..b730d6642
--- /dev/null
+++ b/test/repositories/xml-entities/foo.txt
@@ -0,0 +1,3 @@
+    <dependencies>
+        <dependency conf="myconf->*" org="myorg" name="module2" rev="latest.integration" />
+    </dependencies>
diff --git a/test/repositories/xml-entities/ivy.xml b/test/repositories/xml-entities/ivy.xml
new file mode 100644
index 000000000..191dd96b1
--- /dev/null
+++ b/test/repositories/xml-entities/ivy.xml
@@ -0,0 +1,29 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.
+-->
+<!DOCTYPE ivy-module [
+       <!ENTITY foo SYSTEM "foo.txt">
+]>
+<ivy-module version="1.3">
+    <info organisation="myorg" module="moduleB" revision="1.0"/>
+    <configurations>
+    	<conf name="myconf"/>
+    </configurations>
+    <publications/>
+    &foo;
+</ivy-module>
diff --git a/test/repositories/xml-entities/ivysettings.xml b/test/repositories/xml-entities/ivysettings.xml
new file mode 100644
index 000000000..c5971bb46
--- /dev/null
+++ b/test/repositories/xml-entities/ivysettings.xml
@@ -0,0 +1,33 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<!DOCTYPE ivysettings [
+       <!ENTITY bar SYSTEM "bar.txt">
+]>
+<ivysettings>
+    &bar;
+    <resolvers>
+        <url name="myresolver">
+            <ivy pattern="${ivy.settings.dir}/[module]/ivy-[revision].xml"/>
+            <artifact pattern="${ivy.settings.dir}/[module]/[artifact]-[revision].[ext]"/>
+        </url>
+    </resolvers>
+    <modules>
+        <module organisation="myorg" name=".*" resolver="myresolver"/>
+    </modules>
+</ivysettings>
diff --git a/test/repositories/xml-entities/module1/ivy-1.0.xml b/test/repositories/xml-entities/module1/ivy-1.0.xml
new file mode 100644
index 000000000..81c65c1c3
--- /dev/null
+++ b/test/repositories/xml-entities/module1/ivy-1.0.xml
@@ -0,0 +1,25 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.
+-->
+<ivy-module version="1.3">
+    <info organisation="myorg" module="module1" revision="1.0"/>
+    <configurations>
+    	<conf name="myconf"/>
+    </configurations>
+    <publications/>
+</ivy-module>
diff --git a/test/repositories/xml-entities/module2/ivy-2.0.xml b/test/repositories/xml-entities/module2/ivy-2.0.xml
new file mode 100644
index 000000000..a56e375d4
--- /dev/null
+++ b/test/repositories/xml-entities/module2/ivy-2.0.xml
@@ -0,0 +1,28 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.3">
+    <info organisation="myorg" module="module2" revision="2.0"/>
+    <configurations>
+    	<conf name="myconf"/>
+    </configurations>
+    <publications/>
+    <dependencies>
+        <dependency conf="myconf->*" org="myorg" name="module1" rev="1.0" />
+    </dependencies>
+</ivy-module>
