From 2353e1adf1bc9a54c4448cd521bf80c39fc55c62 Mon Sep 17 00:00:00 2001
From: Maja Kabiljo <majakabiljo@maja-mbp.thefacebook.com>
Date: Tue, 9 Apr 2013 09:50:33 -0700
Subject: [PATCH] GIRAPH-611: Vertex/EdgeReaderWrapper should configure inner
 reader (majakabiljo)

---
 CHANGELOG                                                | 2 ++
 .../apache/giraph/io/iterables/EdgeReaderWrapper.java    | 9 +++++++++
 .../apache/giraph/io/iterables/VertexReaderWrapper.java  | 9 +++++++++
 .../giraph/hive/output/HiveVertexOutputFormat.java       | 3 +--
 4 files changed, 21 insertions(+), 2 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index f7e0af635..08437736c 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,8 @@
 Giraph Change Log
 
 Release 0.2.0 - unreleased
+  GIRAPH-611: Vertex/EdgeReaderWrapper should configure inner reader (majakabiljo)
+
   GIRAPH-609: More information on runtime exceptions for Callables (aching)
 
   GIRAPH-607: Hive IO bump (nitay)
diff --git a/giraph-core/src/main/java/org/apache/giraph/io/iterables/EdgeReaderWrapper.java b/giraph-core/src/main/java/org/apache/giraph/io/iterables/EdgeReaderWrapper.java
index 6d09d1590..efd8fe742 100644
--- a/giraph-core/src/main/java/org/apache/giraph/io/iterables/EdgeReaderWrapper.java
+++ b/giraph-core/src/main/java/org/apache/giraph/io/iterables/EdgeReaderWrapper.java
@@ -19,6 +19,8 @@
 package org.apache.giraph.io.iterables;
 
 import java.io.IOException;
+
+import org.apache.giraph.conf.ImmutableClassesGiraphConfiguration;
 import org.apache.giraph.edge.Edge;
 import org.apache.giraph.io.EdgeReader;
 import org.apache.hadoop.io.Writable;
@@ -49,6 +51,13 @@ public EdgeReaderWrapper(GiraphReader<EdgeWithSource<I, E>> edgeReader) {
     iterator = new IteratorToReaderWrapper<EdgeWithSource<I, E>>(edgeReader);
   }
 
+  @Override
+  public void setConf(
+      ImmutableClassesGiraphConfiguration<I, Writable, E, Writable> conf) {
+    super.setConf(conf);
+    conf.configureIfPossible(edgeReader);
+  }
+
   @Override
   public boolean nextEdge() throws IOException, InterruptedException {
     return iterator.nextObject();
diff --git a/giraph-core/src/main/java/org/apache/giraph/io/iterables/VertexReaderWrapper.java b/giraph-core/src/main/java/org/apache/giraph/io/iterables/VertexReaderWrapper.java
index dabc4c428..614f9453a 100644
--- a/giraph-core/src/main/java/org/apache/giraph/io/iterables/VertexReaderWrapper.java
+++ b/giraph-core/src/main/java/org/apache/giraph/io/iterables/VertexReaderWrapper.java
@@ -19,6 +19,8 @@
 package org.apache.giraph.io.iterables;
 
 import java.io.IOException;
+
+import org.apache.giraph.conf.ImmutableClassesGiraphConfiguration;
 import org.apache.giraph.graph.Vertex;
 import org.apache.giraph.io.VertexReader;
 import org.apache.hadoop.io.Writable;
@@ -50,6 +52,13 @@ public VertexReaderWrapper(GiraphReader<Vertex<I, V, E, ?>> vertexReader) {
     iterator = new IteratorToReaderWrapper<Vertex<I, V, E, ?>>(vertexReader);
   }
 
+  @Override
+  public void setConf(
+      ImmutableClassesGiraphConfiguration<I, V, E, Writable> conf) {
+    super.setConf(conf);
+    conf.configureIfPossible(vertexReader);
+  }
+
   @Override
   public boolean nextVertex() throws IOException, InterruptedException {
     return iterator.nextObject();
diff --git a/giraph-hive/src/main/java/org/apache/giraph/hive/output/HiveVertexOutputFormat.java b/giraph-hive/src/main/java/org/apache/giraph/hive/output/HiveVertexOutputFormat.java
index 70ef36009..45c9ca3b3 100644
--- a/giraph-hive/src/main/java/org/apache/giraph/hive/output/HiveVertexOutputFormat.java
+++ b/giraph-hive/src/main/java/org/apache/giraph/hive/output/HiveVertexOutputFormat.java
@@ -57,10 +57,9 @@ public VertexWriter<I, V, E> createVertexWriter(TaskAttemptContext context)
     throws IOException, InterruptedException {
     RecordWriter<WritableComparable, HiveWritableRecord> baseWriter =
         hiveOutputFormat.getRecordWriter(context);
-    HiveVertexWriter writer = new HiveVertexWriter();
+    HiveVertexWriter<I, V, E> writer = new HiveVertexWriter<I, V, E>();
     writer.setBaseWriter(baseWriter);
     writer.setTableSchema(hiveOutputFormat.getTableSchema(getConf()));
-    writer.initialize(context);
     return writer;
   }
 
