From 9c831fa54599e7f4465a09a60e487c4ba4127cfb Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 2 Oct 2008 20:19:59 +0000
Subject: [PATCH] FIX: Maven2 parser doesn't support POMs with <model> as root
 (IVY-932)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@701232 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/plugins/parser/m2/PomReader.java      |  3 +-
 .../m2/PomModuleDescriptorParserTest.java     | 20 ++++++++++++
 .../ivy/plugins/parser/m2/test-model.pom      | 31 +++++++++++++++++++
 4 files changed, 54 insertions(+), 1 deletion(-)
 create mode 100644 test/java/org/apache/ivy/plugins/parser/m2/test-model.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index ca2063058..2eb5cd262 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -99,6 +99,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: ivy:settings doesn't work if id is a property (IVY-925)
 - FIX: HttpClientHandler hanging in certain cases (IVY-930) (thanks to Scott Hebert)
 - FIX: Can't download files containing space or + in their names by HTTP (IVY-923)
+- FIX: Maven2 parser doesn't support POMs with <model> as root (IVY-932)
 
    2.0.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java b/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java
index f4a1cf33a..525a31ef2 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java
@@ -58,6 +58,7 @@ public class PomReader {
     private static final String DEPENDENCIES = "dependencies";
     private static final String DEPENDENCY_MGT = "dependencyManagement";
     private static final String PROJECT = "project";
+    private static final String MODEL = "model";
     private static final String GROUP_ID = "groupId";
     private static final String ARTIFACT_ID = "artifactId";
     private static final String VERSION = "version";
@@ -99,7 +100,7 @@ public InputSource resolveEntity(String publicId, String systemId)
                 }
             });
             projectElement = pomDomDoc.getDocumentElement();
-            if (!PROJECT.equals(projectElement.getNodeName())) {
+            if (!PROJECT.equals(projectElement.getNodeName()) && !MODEL.equals(projectElement.getNodeName())) {
                 throw new SAXParseException("project must be the root tag" , res.getName() , 
                                             res.getName(), 0, 0);
             }
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index b6fae1876..f78e85aa3 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -631,5 +631,25 @@ public void testPomWithEntity() throws Exception {
             settings, getClass().getResource("test-entity.pom"), true);
         assertNotNull(md);        
     }
+    
+    public void testModel() throws Exception {
+        ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
+            settings, getClass().getResource("test-model.pom"), false);
+        assertNotNull(md);
+
+        ModuleRevisionId mrid = ModuleRevisionId.newInstance("org.apache", "test", "1.0");
+        assertEquals(mrid, md.getModuleRevisionId());
+
+        assertNotNull(md.getConfigurations());
+        assertEquals(Arrays.asList(PomModuleDescriptorBuilder.MAVEN2_CONFIGURATIONS), Arrays
+                .asList(md.getConfigurations()));
+
+        Artifact[] artifact = md.getArtifacts("master");
+        assertEquals(1, artifact.length);
+        assertEquals(mrid, artifact[0].getModuleRevisionId());
+        assertEquals("test", artifact[0].getName());
+        assertEquals("jar", artifact[0].getExt());
+        assertEquals("jar", artifact[0].getType());
+    }
 
 }
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/test-model.pom b/test/java/org/apache/ivy/plugins/parser/m2/test-model.pom
new file mode 100644
index 000000000..c71c67a30
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/parser/m2/test-model.pom
@@ -0,0 +1,31 @@
+<?xml version="1.0"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<model>
+  <modelVersion>4.0.0</modelVersion>
+  <groupId>org.apache</groupId>
+  <artifactId>test</artifactId>
+  <name>Test Module for Ivy M2 parsing</name>
+  <version>1.0</version>
+  <url>http://ant.apache.org/ivy</url>
+  <organization>
+    <name>Jayasoft</name>
+    <url>http://www.jayasoft.org/</url>
+  </organization>
+</model>
