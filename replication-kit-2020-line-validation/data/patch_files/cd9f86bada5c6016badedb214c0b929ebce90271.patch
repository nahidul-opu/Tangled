From cd9f86bada5c6016badedb214c0b929ebce90271 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 30 Sep 2008 20:34:15 +0000
Subject: [PATCH] FIX: Maven Pom reader doesn't handle optional dependencies
 correctly in some instances (IVY-926) (thanks to Phil Messenger)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@700571 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                           |  2 ++
 .../org/apache/ivy/plugins/parser/m2/PomReader.java   |  3 ++-
 .../parser/m2/PomModuleDescriptorParserTest.java      | 11 ++++++++++-
 .../apache/ivy/plugins/parser/m2/test-optional.pom    |  8 +++++++-
 4 files changed, 21 insertions(+), 3 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index c81b9c330..8317d3da9 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -53,6 +53,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Bernard Niset
 	David Maplesden
 	Glen Marchesani
+	Phil Messenger
 	Mathias Muller
 	Peter Oxenham
 	Emmanuel Pellereau
@@ -90,6 +91,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: build.xml: checkstyle + checkstyle-report dont work together (IVY-919)
 - FIX: Maven packaging of "pom" should add a "jar" artifact if present (IVY-920)
 - FIX: StackOverflow when using ivy:settings with "ivy.instance" as id (IVY-924)
+- FIX: Maven Pom reader doesn't handle optional dependencies correctly in some instances (IVY-926) (thanks to Phil Messenger)
 
    2.0.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java b/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java
index 829b12562..e6598ac8b 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomReader.java
@@ -364,7 +364,8 @@ public String getType() {
         }
 
         public boolean isOptional() {
-            return getFirstChildElement(depElement, OPTIONAL) != null;
+            Element e = getFirstChildElement(depElement, OPTIONAL); 
+            return (e != null) && "true".equalsIgnoreCase(getTextContent(e));
         }
         
         public List /*<ModuleId>*/ getExcludedModules() {
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index d5ca10cc3..213550c41 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -384,7 +384,7 @@ public void testOptional() throws Exception {
 
         DependencyDescriptor[] dds = md.getDependencies();
         assertNotNull(dds);
-        assertEquals(2, dds.length);
+        assertEquals(3, dds.length);
         assertEquals(ModuleRevisionId.newInstance("commons-logging", "commons-logging", "1.0.4"),
             dds[0].getDependencyRevisionId());
         assertEquals(new HashSet(Arrays.asList(new String[] {"optional"})), new HashSet(Arrays
@@ -402,6 +402,15 @@ public void testOptional() throws Exception {
             new HashSet(Arrays.asList(dds[1].getDependencyConfigurations("compile"))));
         assertEquals(new HashSet(Arrays.asList(new String[] {"runtime(*)"})), new HashSet(Arrays
                 .asList(dds[1].getDependencyConfigurations("runtime"))));
+
+        assertEquals(ModuleRevisionId.newInstance("cglib", "cglib-extra", "2.0.2"), dds[2]
+                .getDependencyRevisionId());
+        assertEquals(new HashSet(Arrays.asList(new String[] {"compile", "runtime"})), new HashSet(
+                Arrays.asList(dds[2].getModuleConfigurations())));
+        assertEquals(new HashSet(Arrays.asList(new String[] {"master(*)", "compile(*)"})),
+            new HashSet(Arrays.asList(dds[2].getDependencyConfigurations("compile"))));
+        assertEquals(new HashSet(Arrays.asList(new String[] {"runtime(*)"})), new HashSet(Arrays
+                .asList(dds[2].getDependencyConfigurations("runtime"))));
     }
 
     public void testDependenciesWithScope() throws Exception {
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/test-optional.pom b/test/java/org/apache/ivy/plugins/parser/m2/test-optional.pom
index 3c9079801..8f1bea55e 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/test-optional.pom
+++ b/test/java/org/apache/ivy/plugins/parser/m2/test-optional.pom
@@ -33,12 +33,18 @@
       <groupId>commons-logging</groupId>
       <artifactId>commons-logging</artifactId>
       <version>1.0.4</version>
-      <optional/>
+      <optional>true</optional>
     </dependency>
     <dependency>
       <groupId>cglib</groupId>
       <artifactId>cglib</artifactId>
       <version>2.0.2</version>
     </dependency>
+    <dependency>
+      <groupId>cglib</groupId>
+      <artifactId>cglib-extra</artifactId>
+      <version>2.0.2</version>
+      <optional>false</optional>
+    </dependency>
   </dependencies>
 </project>
