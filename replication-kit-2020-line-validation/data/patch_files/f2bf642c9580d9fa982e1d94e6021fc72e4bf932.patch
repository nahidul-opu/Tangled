From f2bf642c9580d9fa982e1d94e6021fc72e4bf932 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Thu, 31 Aug 2006 13:00:20 +0000
Subject: [PATCH] FIX: Endless recursion in report (IVY-284)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484494 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                    | 1 +
 src/java/fr/jayasoft/ivy/report/ivy-report.xsl | 5 +++++
 2 files changed, 6 insertions(+)

diff --git a/CHANGES.txt b/CHANGES.txt
index c5383568d..2d96303ad 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -53,6 +53,7 @@ Changes:
   - IMPROVE: suport empty dependencies tag in an ivy file (IVY-281)
   - IMPROVE: isolate dependency resolution from artifact downloading (IVY-254)
 
+  - FIX: Endless recursion in report (IVY-284)
   - FIX: http url lister doesn't work when link text has spaces (IVY-282)
   - FIX: Incorrect ant log level (IVY-279)
   - FIX: Wrong resolution of dependencies if artifacts specified explicitly (IVY-261)
diff --git a/src/java/fr/jayasoft/ivy/report/ivy-report.xsl b/src/java/fr/jayasoft/ivy/report/ivy-report.xsl
index 673a15a94..6bcd16437 100644
--- a/src/java/fr/jayasoft/ivy/report/ivy-report.xsl
+++ b/src/java/fr/jayasoft/ivy/report/ivy-report.xsl
@@ -49,6 +49,7 @@
       <tbody>
         <xsl:for-each select="$modules/revision/caller[@organisation=$org and @name=$mod]">
           <xsl:call-template name="called">
+            <xsl:with-param name="callstack"     select="concat($org, string('/'), $mod)"/>
             <xsl:with-param name="indent"        select="string('')"/>
             <xsl:with-param name="revision"      select=".."/>
           </xsl:call-template>
@@ -59,6 +60,7 @@
 </xsl:template>
 
 <xsl:template name="called">
+    <xsl:param name="callstack"/>
     <xsl:param name="indent"/>
     <xsl:param name="revision"/>
 
@@ -108,13 +110,16 @@
     </td>
     </tr>
     <xsl:if test="not($revision/@evicted)">
+    <xsl:if test="not(contains($callstack, concat($organisation, string('/'), $module)))">
     <xsl:for-each select="$modules/revision/caller[@organisation=$organisation and @name=$module]">
           <xsl:call-template name="called">
+            <xsl:with-param name="callstack"     select="concat($callstack, string('#'), $organisation, string('/'), $module)"/>
             <xsl:with-param name="indent"        select="concat($indent, string('---'))"/>
             <xsl:with-param name="revision"      select=".."/>
           </xsl:call-template>
     </xsl:for-each>   
     </xsl:if>
+    </xsl:if>
 </xsl:template>
 
 <xsl:template name="licenses">
