From b1987f221f0655811991852eb57472c4367ec1c8 Mon Sep 17 00:00:00 2001
From: Emmanuel Bourg <ebourg@apache.org>
Date: Sun, 21 Jun 2009 13:23:24 +0000
Subject: [PATCH] Fixed empty dictionaries <dict/> (CONFIGURATION-362)

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@787009 13f79535-47bb-0310-9956-ffa450edef68
---
 conf/test.plist.xml                           |  3 +++
 .../plist/XMLPropertyListConfiguration.java   | 10 +++++++-
 .../TestXMLPropertyListConfiguration.java     | 23 +++++++++++++++++++
 xdocs/changes.xml                             |  4 ++++
 4 files changed, 39 insertions(+), 1 deletion(-)

diff --git a/conf/test.plist.xml b/conf/test.plist.xml
index 2f30da4a1e..d59cb90266 100644
--- a/conf/test.plist.xml
+++ b/conf/test.plist.xml
@@ -80,5 +80,8 @@
             </dict>
         </dict>
 
+        <key>empty-dictionary</key>
+        <dict/>
+
     </dict>
 </plist>
diff --git a/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java b/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java
index 84f79b83a0..7d75b295e2 100644
--- a/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java
+++ b/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java
@@ -304,6 +304,10 @@ private void printNode(PrintWriter out, int indentLevel, Node node)
 
             out.println(padding + "</dict>");
         }
+        else if (node.getValue() == null)
+        {
+            out.println(padding + "<dict/>");
+        }
         else
         {
             Object value = node.getValue();
@@ -400,10 +404,14 @@ else if (value instanceof byte[])
             String base64 = new String(Base64.encodeBase64((byte[]) value));
             out.println(padding + "<data>" + StringEscapeUtils.escapeXml(base64) + "</data>");
         }
-        else
+        else if (value != null)
         {
             out.println(padding + "<string>" + StringEscapeUtils.escapeXml(String.valueOf(value)) + "</string>");
         }
+        else
+        {
+            out.println(padding + "<string/>");
+        }
     }
 
     /**
diff --git a/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java b/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java
index 0ac50644c4..75df6639f0 100644
--- a/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java
+++ b/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java
@@ -270,6 +270,29 @@ else if (value instanceof List)
         }
     }
 
+    public void testSaveEmptyDictionary() throws Exception
+    {
+        File savedFile = new File("target/testsave.plist.xml");
+
+        // remove the file previously saved if necessary
+        if (savedFile.exists())
+        {
+            assertTrue(savedFile.delete());
+        }
+        
+        // save the configuration
+        String filename = savedFile.getAbsolutePath();
+        config.save(filename);
+
+        assertTrue("The saved file doesn't exist", savedFile.exists());
+
+        // read the configuration and compare the properties
+        Configuration checkConfig = new XMLPropertyListConfiguration(new File(filename));
+        
+        assertEquals(null, config.getProperty("empty-dictionary"));
+        assertEquals(null, checkConfig.getProperty("empty-dictionary"));
+    }
+
     /**
      * Ensure that setProperty doesn't alter an array of byte
      * since it's a first class type in plist file
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 7d0d2a70e1..5a3b00462d 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.7" date="in SVN" description="">
+      <action dev="ebourg" type="fix" issue="CONFIGURATION-362">
+        Empty dictionary elements in an XML PropertyList are now preserved and no longer
+        turned into a string when the configuration is saved.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-385">
         DatabaseConfiguration now generates correct events for the clear() and
         clearProperty() methods.
