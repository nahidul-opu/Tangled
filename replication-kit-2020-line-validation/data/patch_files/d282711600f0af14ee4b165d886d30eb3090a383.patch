From d282711600f0af14ee4b165d886d30eb3090a383 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 16 Apr 2009 21:52:30 +0000
Subject: [PATCH] FIX: Ivy doesn't handle maven dependencies with type
 'test-jar' correctly (IVY-1066)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@765780 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                           |  3 ++-
 .../plugins/parser/m2/PomModuleDescriptorBuilder.java | 11 +++++++++--
 2 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 52ff7126a..32470967f 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -88,7 +88,8 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
    trunk
 =====================================
 - FIX: Wrong BuildException messages (findmodules) (IVY-1056)
-- FIX: PomModuleDescriptorBuilder does not resolve ejb type dependencies to jar extension (IVY-1058) (thanks to Andrey Lomakin)   
+- FIX: PomModuleDescriptorBuilder does not resolve ejb type dependencies to jar extension (IVY-1058) (thanks to Andrey Lomakin)
+- FIX: Ivy doesn't handle maven dependencies with type 'test-jar' correctly (IVY-1066)
 	
    2.1.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
index 876c3e02e..6184784d4 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
@@ -293,9 +293,16 @@ public void addDependency(Resource res, PomDependencyData dep) {
                 type = dep.getType();
             }
             String ext = type;
-            if (JAR_PACKAGINGS.contains(type)) {
+
+            // if type is 'test-jar', the extension is 'jar' and the classifier is 'tests'
+            // Cfr. http://maven.apache.org/guides/mini/guide-attached-tests.html
+            if ("test-jar".equals(type)) {
                 ext = "jar";
-            }
+                extraAtt.put("m:classifier", "tests");
+            } else if (JAR_PACKAGINGS.contains(type)) {
+                ext = "jar";
+            }            
+            
             // we deal with classifiers by setting an extra attribute and forcing the
             // dependency to assume such an artifact is published
             if (dep.getClassifier() != null) {
