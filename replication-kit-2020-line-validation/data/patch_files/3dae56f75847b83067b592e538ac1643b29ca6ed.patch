From 3dae56f75847b83067b592e538ac1643b29ca6ed Mon Sep 17 00:00:00 2001
From: Scokart Gilles <gscokart@apache.org>
Date: Fri, 27 Jul 2007 15:10:24 +0000
Subject: [PATCH] FIX: cachepath based on a resolve done in a previous build
 broken (IVY-583)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@560268 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   | 1 +
 src/java/org/apache/ivy/ant/IvyCacheTask.java | 7 ++++++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 9b878f1e8..c8606dfce 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -51,6 +51,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 
    version in SVN
 =====================================
+- FIX: cachepath based on a resolve done in a previous build broken (IVY-583)
 
    2.0.0-alpha2-incubating
 =====================================
diff --git a/src/java/org/apache/ivy/ant/IvyCacheTask.java b/src/java/org/apache/ivy/ant/IvyCacheTask.java
index 37f645729..02aa66aef 100644
--- a/src/java/org/apache/ivy/ant/IvyCacheTask.java
+++ b/src/java/org/apache/ivy/ant/IvyCacheTask.java
@@ -34,6 +34,7 @@
 import org.apache.ivy.core.report.ArtifactDownloadReport;
 import org.apache.ivy.core.report.ConfigurationResolveReport;
 import org.apache.ivy.core.report.ResolveReport;
+import org.apache.ivy.core.resolve.ResolveOptions;
 import org.apache.ivy.plugins.report.XmlReportParser;
 import org.apache.ivy.util.Message;
 import org.apache.tools.ant.BuildException;
@@ -85,8 +86,12 @@ private Collection getAllArtifacts() throws ParseException, IOException {
 
             XmlReportParser parser = new XmlReportParser();
             CacheManager cacheMgr = getIvyInstance().getCacheManager(getCache());
+            String resolvedId = getResolveId();
+            if (resolvedId==null) {
+                resolvedId = ResolveOptions.getDefaultResolveId(getResolvedModuleId());
+            }
             for (int i = 0; i < confs.length; i++) {
-                File reportFile = cacheMgr.getConfigurationResolveReportInCache(getResolveId(),
+                File reportFile = cacheMgr.getConfigurationResolveReportInCache(resolvedId,
                     confs[i]);
                 parser.parse(reportFile);
 
