From 4951344fb2ce246e0cc5a2dff90d24cea6eb3a75 Mon Sep 17 00:00:00 2001
From: Thomas Neidhart <tn@apache.org>
Date: Sun, 14 Jul 2013 19:09:25 +0000
Subject: [PATCH] [COLLECTIONS-475] Fixed conversion of timeout parameters in
 PassiveExpiringMap.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/collections/trunk@1503029 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                             |  4 +++-
 src/changes/changes.xml                       |  7 ++++--
 .../collections4/map/PassiveExpiringMap.java  |  4 ++--
 src/site/xdoc/release_4_0.xml                 |  1 +
 .../map/PassiveExpiringMapTest.java           | 24 +++++++++++++++++++
 5 files changed, 35 insertions(+), 5 deletions(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index 5ed8757846..e1d61bf727 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -46,7 +46,8 @@ Major changes since 3.2.1
 Changes since 4.0-alpha1
 ------------------------
 
- - renamed CompliantBag to CollectionBag
+ - [COLLECTIONS-468] Renamed CompliantBag to CollectionBag.
+ - [COLLECTIONS-475] Fixed conversion of timeout parameters in "PassiveExpiringMap".
 
 
 Removed classes
@@ -206,6 +207,7 @@ Changed classes / methods
 Fixed Bugs
 ----------
 
+ o [COLLECTIONS-475] Fixed conversion of timeout parameters in "PassiveExpiringMap".
  o [COLLECTIONS-474] ListOrderedMap#putAll(index, Object, Object) does not throw an exception anymore if the
                      map contains null values. Additionally added javadoc clarification on the supported bounds
                      for the index parameter. Thanks to Ning Chen.
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index f801a7e3d4..19ac684b34 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -22,8 +22,11 @@
   <body>
 
   <release version="4.0" date="TBA" description="Next release">
-    <action issue="COLLECTIONS-474" dev="sebb" type="fix" due-to="Ning Chen ">
-     Exception in ListOrderedMap#putAll if map contains null values.
+    <action issue="COLLECTIONS-475" dev="tn" type="fix">
+     Fixed conversion of timeout parameters in "PassiveExpiringMap".
+    </action>
+    <action issue="COLLECTIONS-474" dev="sebb" type="fix" due-to="Ning Chen">
+     Exception in "ListOrderedMap#putAll" if map contains null values.
     </action>
     <action issue="COLLECTIONS-473" dev="tn" type="update" due-to="sebb">
       Made field "collection" in class "AbstractCollectionDecorator" private and added
diff --git a/src/main/java/org/apache/commons/collections4/map/PassiveExpiringMap.java b/src/main/java/org/apache/commons/collections4/map/PassiveExpiringMap.java
index c6776a70cd..2a18e45fc3 100644
--- a/src/main/java/org/apache/commons/collections4/map/PassiveExpiringMap.java
+++ b/src/main/java/org/apache/commons/collections4/map/PassiveExpiringMap.java
@@ -121,7 +121,7 @@ public ConstantTimeToLiveExpirationPolicy(final long timeToLiveMillis) {
          */
         public ConstantTimeToLiveExpirationPolicy(final long timeToLive,
                                                   final TimeUnit timeUnit) {
-            this(validateAndConvertToMillis(timeToLive, TimeUnit.MILLISECONDS));
+            this(validateAndConvertToMillis(timeToLive, timeUnit));
         }
 
         /**
@@ -196,7 +196,7 @@ private static long validateAndConvertToMillis(final long timeToLive,
         if (timeUnit == null) {
             throw new IllegalArgumentException("Time unit must not be null");
         }
-        return timeUnit.convert(timeToLive, TimeUnit.MILLISECONDS);
+        return TimeUnit.MILLISECONDS.convert(timeToLive, timeUnit);
     }
 
     /** map used to manage expiration times for the actual map entries. */
diff --git a/src/site/xdoc/release_4_0.xml b/src/site/xdoc/release_4_0.xml
index 5cd313089e..0d3676ede5 100644
--- a/src/site/xdoc/release_4_0.xml
+++ b/src/site/xdoc/release_4_0.xml
@@ -186,6 +186,7 @@ This release is <b>not</b> source or binary compatible with v3.x.
 
 <center><h3>Bugfixes</h3></center>
 <ul>
+<li>Fixed conversion of timeout parameters in "PassiveExpiringMap".</li>
 <li>ListOrderedMap#putAll(index, Object, Object) does not throw an exception anymore if the map contains null values. Additionally added javadoc clarification on the supported bounds for the index parameter. Thanks to Ning Chen.</li>
 <li>Improved performance of "AbstractMapBag#containsAll(Collection)" by returning immediately after a difference has been found. Thanks to Adrian Nistor.</li>
 <li>Added additional clarification to javadoc of interface "Put" wrt return type of "put(Object, Object)" method. Thanks to Matt Benson, sebb.</li>
diff --git a/src/test/java/org/apache/commons/collections4/map/PassiveExpiringMapTest.java b/src/test/java/org/apache/commons/collections4/map/PassiveExpiringMapTest.java
index 70a07b03d0..77d9a28fc6 100644
--- a/src/test/java/org/apache/commons/collections4/map/PassiveExpiringMapTest.java
+++ b/src/test/java/org/apache/commons/collections4/map/PassiveExpiringMapTest.java
@@ -225,4 +225,28 @@ public void testZeroTimeToLive() {
         m.put("a", "b");
         assertNull(m.get("a"));
     }
+    
+    public void testExpiration() {
+        validateExpiration(new PassiveExpiringMap<String, String>(500), 500);
+        validateExpiration(new PassiveExpiringMap<String, String>(1000), 1000);
+        validateExpiration(new PassiveExpiringMap<String, String>(
+                new PassiveExpiringMap.ConstantTimeToLiveExpirationPolicy<String, String>(500)), 500);
+        validateExpiration(new PassiveExpiringMap<String, String>(
+                new PassiveExpiringMap.ConstantTimeToLiveExpirationPolicy<String, String>(1, TimeUnit.SECONDS)), 1000);
+    }
+
+    private void validateExpiration(final Map<String, String> map, long timeout) {
+        map.put("a", "b");
+        
+        assertNotNull(map.get("a"));
+        
+        try {
+            Thread.sleep(2 * timeout);
+        } catch (InterruptedException e) {
+            fail();
+        }
+
+        assertNull(map.get("a"));
+    }
+    
 }
