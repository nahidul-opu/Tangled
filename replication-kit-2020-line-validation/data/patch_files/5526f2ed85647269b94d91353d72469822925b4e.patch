From 5526f2ed85647269b94d91353d72469822925b4e Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Fri, 5 Mar 2010 01:27:08 +0000
Subject: [PATCH] IO-207 Race condition in forceMkdir

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@919263 13f79535-47bb-0310-9956-ffa450edef68
---
 src/java/org/apache/commons/io/FileUtils.java | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

diff --git a/src/java/org/apache/commons/io/FileUtils.java b/src/java/org/apache/commons/io/FileUtils.java
index 9ca6f8367e3..d89202cf8ff 100644
--- a/src/java/org/apache/commons/io/FileUtils.java
+++ b/src/java/org/apache/commons/io/FileUtils.java
@@ -1539,9 +1539,14 @@ public static void forceMkdir(File directory) throws IOException {
             }
         } else {
             if (!directory.mkdirs()) {
-                String message =
-                    "Unable to create directory " + directory;
-                throw new IOException(message);
+                // Double-check that some other thread or process hasn't made
+                // the directory in the background
+                if (!directory.isDirectory())
+                {
+                    String message =
+                        "Unable to create directory " + directory;
+                    throw new IOException(message);
+                }
             }
         }
     }
