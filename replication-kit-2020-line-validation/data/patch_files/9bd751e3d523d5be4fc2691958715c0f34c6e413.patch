From 9bd751e3d523d5be4fc2691958715c0f34c6e413 Mon Sep 17 00:00:00 2001
From: "Maria Odea B. Ching" <oching@apache.org>
Date: Fri, 20 Mar 2009 16:05:05 +0000
Subject: [PATCH] [MRM-1136] o remove namespaces before getting child nodes of
 metadata o added test case

git-svn-id: https://svn.apache.org/repos/asf/archiva/trunk@756559 13f79535-47bb-0310-9956-ffa450edef68
---
 .../metadata/RepositoryMetadataReader.java         |  4 +++-
 .../examples/maven-metadata-codehaus-snapshots.xml | 14 ++++++++++++++
 .../apache/maven/archiva/xml/XMLReaderTest.java    | 13 +++++++++++++
 3 files changed, 30 insertions(+), 1 deletion(-)
 create mode 100644 archiva-modules/archiva-base/archiva-xml-tools/src/test/examples/maven-metadata-codehaus-snapshots.xml

diff --git a/archiva-modules/archiva-base/archiva-repository-layer/src/main/java/org/apache/maven/archiva/repository/metadata/RepositoryMetadataReader.java b/archiva-modules/archiva-base/archiva-repository-layer/src/main/java/org/apache/maven/archiva/repository/metadata/RepositoryMetadataReader.java
index b1639aac1e..a6fc50b82a 100644
--- a/archiva-modules/archiva-base/archiva-repository-layer/src/main/java/org/apache/maven/archiva/repository/metadata/RepositoryMetadataReader.java
+++ b/archiva-modules/archiva-base/archiva-repository-layer/src/main/java/org/apache/maven/archiva/repository/metadata/RepositoryMetadataReader.java
@@ -50,7 +50,9 @@ public static ArchivaRepositoryMetadata read( File metadataFile )
         try
         {
             XMLReader xml = new XMLReader( "metadata", metadataFile );
-
+            // invoke this to remove namespaces, see MRM-1136
+            xml.removeNamespaces();
+            
             ArchivaRepositoryMetadata metadata = new ArchivaRepositoryMetadata();
 
             metadata.setGroupId( xml.getElementText( "//metadata/groupId" ) );
diff --git a/archiva-modules/archiva-base/archiva-xml-tools/src/test/examples/maven-metadata-codehaus-snapshots.xml b/archiva-modules/archiva-base/archiva-xml-tools/src/test/examples/maven-metadata-codehaus-snapshots.xml
new file mode 100644
index 0000000000..f101ae619f
--- /dev/null
+++ b/archiva-modules/archiva-base/archiva-xml-tools/src/test/examples/maven-metadata-codehaus-snapshots.xml
@@ -0,0 +1,14 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<metadata xsi:schemaLocation="http://maven.apache.org/METADATA/1.0.0 http://maven.apache.org/xsd/metadata-1.0.0.xsd" xmlns="http://maven.apache.org/METADATA/1.0.0"
+    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
+  <groupId>org.codehaus.mojo</groupId>
+  <artifactId>idlj-maven-plugin</artifactId>
+  <version>1.1-SNAPSHOT</version>
+  <versioning>
+    <snapshot>
+      <timestamp>20090312.163710</timestamp>
+      <buildNumber>16</buildNumber>
+    </snapshot>
+    <lastUpdated>20090312163712</lastUpdated>
+  </versioning>
+</metadata>
diff --git a/archiva-modules/archiva-base/archiva-xml-tools/src/test/java/org/apache/maven/archiva/xml/XMLReaderTest.java b/archiva-modules/archiva-base/archiva-xml-tools/src/test/java/org/apache/maven/archiva/xml/XMLReaderTest.java
index 1fb12fba85..86a30530f3 100644
--- a/archiva-modules/archiva-base/archiva-xml-tools/src/test/java/org/apache/maven/archiva/xml/XMLReaderTest.java
+++ b/archiva-modules/archiva-base/archiva-xml-tools/src/test/java/org/apache/maven/archiva/xml/XMLReaderTest.java
@@ -89,5 +89,18 @@ public void testPrologUtf8Read()
         List<Element> names = reader.getElementList( "//basic/names/name" );
         assertElementTexts( names, new String[] { TRYGVIS, INFINITE_ARCHIVA } );
     }
+    
+    // MRM-1136
+    public void testProxiedMetadataRead()
+        throws XMLException
+    {
+        File xmlFile = getExampleXml( "maven-metadata-codehaus-snapshots.xml" );
+        XMLReader reader = new XMLReader( "metadata", xmlFile );        
+        reader.removeNamespaces();
+        
+        Element groupId = reader.getElement( "//metadata/groupId" );        
+        assertNotNull( groupId );
+        assertEquals( "org.codehaus.mojo", groupId.getTextTrim() );   
+    }
 
 }
