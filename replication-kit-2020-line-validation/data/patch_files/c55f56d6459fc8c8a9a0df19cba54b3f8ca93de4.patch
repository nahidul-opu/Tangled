From c55f56d6459fc8c8a9a0df19cba54b3f8ca93de4 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 22 Mar 2011 17:22:48 +0000
Subject: [PATCH] NET-362 TelnetInputStream has various threading bugs.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1084258 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                      | 3 +++
 .../org/apache/commons/net/telnet/TelnetInputStream.java     | 5 +++--
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 49b87949e..ebb48339f 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -57,6 +57,9 @@ The <action> type attribute can be add,update,fix,remove.
 
     <body>
         <release version="3.0" date="TBA" description="TBA">
+            <action issue="NET-362" dev="sebb" type="fix">
+            TelnetInputStream has various threading bugs.
+            </action>
             <action issue="NET-89" dev="sebb" type="fix">
             TelnetClient use of FromNetASCIIInputStream and ToNetASCIIOutputStream breaks binary mode.
             See also NET-387.
diff --git a/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java b/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
index 47b9a33ae..6fe074e8e 100644
--- a/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
+++ b/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
@@ -46,7 +46,8 @@ final class TelnetInputStream extends BufferedInputStream implements Runnable
                      _STATE_WONT = 3, _STATE_DO = 4, _STATE_DONT = 5,
                      _STATE_SB = 6, _STATE_SE = 7, _STATE_CR = 8, _STATE_IAC_SB = 9;
 
-    private boolean __hasReachedEOF, __isClosed;
+    private boolean __hasReachedEOF;
+    private volatile boolean __isClosed;
     private boolean __readIsWaiting;
     private int __receiveState, __queueHead, __queueTail, __bytesAvailable;
     private final int[] __queue;
@@ -59,7 +60,7 @@ final class TelnetInputStream extends BufferedInputStream implements Runnable
     private int __suboption_count = 0;
     /* TERMINAL-TYPE option (end)*/
 
-    private boolean __threaded;
+    private volatile boolean __threaded;
 
     TelnetInputStream(InputStream input, TelnetClient client,
                       boolean readerThread)
