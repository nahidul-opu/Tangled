From 821a3ddf69bdbfdab5aa9f3ba9f99b30ea63dcaf Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 23 Sep 2008 20:57:13 +0000
Subject: [PATCH] FIX: Properties needed to parse version in POM (IVY-914)
 (thanks to Tom Widmer)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@698345 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                        |  1 +
 .../parser/m2/PomModuleDescriptorParser.java       | 14 +++++++-------
 .../ivy/plugins/parser/m2/test-properties.pom      |  5 ++++-
 3 files changed, 12 insertions(+), 8 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 8bc7301c9..92861087d 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -86,6 +86,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: Environment properties in ivy settings are no longer resolved (IVY-907)
 - FIX: Resolve failed on certain proxy environment (IVY-911)
 - FIX: Ivy can't handle bare POM ${groupId} property (IVY-913) (thanks to Tom Widmer)
+- FIX: Properties needed to parse version in POM (IVY-914) (thanks to Tom Widmer)
 
    2.0.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
index 212d4997d..d421b24d0 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
@@ -113,6 +113,13 @@ public ModuleDescriptor parseDescriptor(ParserSettings ivySettings, URL descript
         try {           
             PomReader domReader = new PomReader(descriptorURL, res);            
             domReader.setProperty("parent.version", domReader.getParentVersion());
+
+            Map pomProperties = domReader.getPomProperties();
+            for (Iterator iter = pomProperties.entrySet().iterator(); iter.hasNext();) {
+                Map.Entry prop = (Map.Entry) iter.next();
+                domReader.setProperty((String) prop.getKey(), (String) prop.getValue());
+                mdBuilder.addProperty((String) prop.getKey(), (String) prop.getValue());
+            }
             
             ModuleDescriptor parentDescr = null;
             if (domReader.hasParent()) {
@@ -198,13 +205,6 @@ public ModuleDescriptor parseDescriptor(ParserSettings ivySettings, URL descript
                 domReader.setProperty("pom.version", version);
                 domReader.setProperty("version", version);
 
-                Map pomProperties = domReader.getPomProperties();
-                for (Iterator iter = pomProperties.entrySet().iterator(); iter.hasNext();) {
-                    Map.Entry prop = (Map.Entry) iter.next();
-                    domReader.setProperty((String) prop.getKey(), (String) prop.getValue());
-                    mdBuilder.addProperty((String) prop.getKey(), (String) prop.getValue());
-                }
-                
                 if (parentDescr != null) {
                     mdBuilder.addExtraInfos(parentDescr.getExtraInfo());
                     
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/test-properties.pom b/test/java/org/apache/ivy/plugins/parser/m2/test-properties.pom
index e3cc08e9a..a3fdfae82 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/test-properties.pom
+++ b/test/java/org/apache/ivy/plugins/parser/m2/test-properties.pom
@@ -21,7 +21,7 @@
   <groupId>drools</groupId>
   <artifactId>drools-smf</artifactId>
   <name>Drools :: Semantics Module Framework</name>
-  <version>2.0-beta-18</version>
+  <version>${my-version}</version>
   <dependencies>
     <dependency>
       <groupId>${pom.groupId}</groupId>
@@ -29,4 +29,7 @@
       <version>${pom.version}</version>
     </dependency>
   </dependencies>
+  <properties>
+    <my-version>2.0-beta-18</my-version>
+  </properties>
 </project>
