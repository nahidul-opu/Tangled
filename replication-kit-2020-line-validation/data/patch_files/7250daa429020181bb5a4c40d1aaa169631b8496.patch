From 7250daa429020181bb5a4c40d1aaa169631b8496 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Fri, 5 Feb 2016 21:20:19 +0100
Subject: [PATCH] COMPRESS-335 yet another strange case of tar checksum

---
 src/changes/changes.xml                          |   4 ++++
 .../commons/compress/archivers/tar/TarUtils.java |   7 +------
 .../commons/compress/DetectArchiverTestCase.java |   7 +++++++
 src/test/resources/COMPRESS-335.tar              | Bin 0 -> 3072 bytes
 4 files changed, 12 insertions(+), 6 deletions(-)
 create mode 100644 src/test/resources/COMPRESS-335.tar

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index a5130264810..5612f69e58d 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -44,6 +44,10 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
     <release version="1.11" date="not released, yet"
              description="Release 1.11">
+      <action issue="COMPRESS-335" type="fix" date="2016-02-05">
+        checksums of tars that pad the checksum field to the left are
+        now calculated properly.
+      </action>
       <action issue="COMPRESS-334" type="fix" date="2016-02-05"
               due-to="Jeremy Gustie">
         ArArchiveInputStream failed to read past the first entry when
diff --git a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
index 65088eb2939..204debff8ab 100644
--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
@@ -591,7 +591,7 @@ public static long computeCheckSum(final byte[] buf) {
      * @since 1.5
      */
     public static boolean verifyCheckSum(byte[] header) {
-        long storedSum = 0;
+        long storedSum = parseOctal(header, CHKSUM_OFFSET, CHKSUMLEN);
         long unsignedSum = 0;
         long signedSum = 0;
 
@@ -599,11 +599,6 @@ public static boolean verifyCheckSum(byte[] header) {
         for (int i = 0; i < header.length; i++) {
             byte b = header[i];
             if (CHKSUM_OFFSET  <= i && i < CHKSUM_OFFSET + CHKSUMLEN) {
-                if ('0' <= b && b <= '7' && digits++ < 6) {
-                    storedSum = storedSum * 8 + b - '0';
-                } else if (digits > 0) {
-                    digits = 6; // only look at the first octal digit sequence
-                }
                 b = ' ';
             }
             unsignedSum += 0xff & b;
diff --git a/src/test/java/org/apache/commons/compress/DetectArchiverTestCase.java b/src/test/java/org/apache/commons/compress/DetectArchiverTestCase.java
index ad1890237d6..8e1e7bf7c56 100644
--- a/src/test/java/org/apache/commons/compress/DetectArchiverTestCase.java
+++ b/src/test/java/org/apache/commons/compress/DetectArchiverTestCase.java
@@ -55,6 +55,13 @@ public void testCOMPRESS117() throws Exception {
         assertTrue(tar instanceof TarArchiveInputStream);
     }
 
+    @Test
+    public void testCOMPRESS335() throws Exception {
+        final ArchiveInputStream tar = getStreamFor("COMPRESS-335.tar");
+        assertNotNull(tar);
+        assertTrue(tar instanceof TarArchiveInputStream);
+    }
+
     @Test
     public void testDetection() throws Exception {
 
diff --git a/src/test/resources/COMPRESS-335.tar b/src/test/resources/COMPRESS-335.tar
new file mode 100644
index 0000000000000000000000000000000000000000..0266b6318e1bfd7a47ab23c4c11dc31b5c40650a
GIT binary patch
literal 3072
zcmeHJ-%r~}5bi7d6?1B(0?H*$_;D3Ioz6HLvXZfV-VKx|YV1v8DX}AaLreeq`(_P=
z0y>F@d%BARUhnSr&CEBmvz|A`*rNT_>mMBq$|_%O3NvWTdYR>BWh&d^B`elh+pZT)
z)|&p}&8vSy&pSFgpf{d3{O!==C;#rB-ogIxkcQs=;b`O?9qb<w_8obLhp)EtKj8HW
z4E88aM0BFY6sPi3Mt*oq4|VW!>S=GVy*=35dKa%v1;{ZyEsov|4g32v^1RW&I~t5W
z&~S9TKRO<bXjLwkrm-Zxt?AuX$Fxm*6x8e6ru?$7w3F{L(j#3L1qFRNa}fHS-}~Lm
zpLxA$tZB2VpVzBDn805y$q}@0r!~!uDf*b_rPLH<Yn$?VW6QdttSV^J8pKB}XmaCb
zuFEQGZfRaOtF}j9OS_=DanE{VnPpWM<-E)@=IBw@7+RZVRa$EbS~vAgSzurnnZ-W?
zp5?OsT2@~uudAYDP|GZgTN!)I<6-}aYc19Dd!O>Uz|Ku;5suB^E3;<T^^F1JomNbO
zUsc;OH$ChqTUsJirg<>y!u#1L=#ek8a%CFUh(^yHfx$<L+&h9eiwy+(cYNWDfcY+}
zqRuzmdz|1L!vOiHvEI-sv!*GtW&0q!OBlQLIMpt={XS{TSJ}$2F1#n(*agT|*)3~F
z*M{o>$*aj!Mctq_u!>k$wMCX)%+_TOVi&NC+M+p@JH^|2ZohI~*#{I0wQG}esQ_AX
z4K-XORaY);i%PgJOg)u~R6Nlaekus#B#qDISd8iOXJ29B{d@AGG5#(|d`eQG6wW8f
zvm}(*1XSurS_;);&14jWv$2d$dvr3>6vdiCc_uY>>bOUG3KP$e6i?_(q`?$K{)r5w
zzGN=8I*~eJixZgiDe+S+gIVaOl+4m3R)W~+u~b3m%QG?V6Fh)b66Ye)q^5otG8NnP
zXL<^j69JF>lTdV=h-xfT5$GO}52FAIz?rZ|DiMLifN8`h0q6bnvd0nxaiqjwGwj1U
zjr}wKR4Cf{X9<`F3J0@PoUw}tUCmCEmU^ZIoyPIl$*V+qE(4)HQW&$~6PhW}gAwgJ
z+n|6n>Lb%}P%|Z+PBPLWO=pRgakNX*_yR(}Qy*wfAzEwXG6_NA^pbg53@5pZ@M0>k
zg!D!no=$xhM(I=roXGo~Y*NRmeiST4;xv?}A_@dnom)(FA(hxgk|g{)WmYbu3m=wI
z9k9-cfp6XLQ6ctR21!ns$seDC2EKRuk#{9KpLt5ng6W<5T+_H0-j?&KFmt*}g+ESw
zrIKmtD{(cw+J1}qvNA6%{eVsVbMXWU&O2b5Bv&Gs##ixV!hO&C=6PFN1C-dNsc^RE
zWb#E#JJ_CWmUg$#9z6#~jAii9fkTs_r#d7~=2J+DDnpH4X?@9%k%LUKa!IA@B{=qI
zx>Zfq-aZ54<OCu_A*9aUK?kn+$|<WgIt4loZV7a>oIk3b+IH|+lH9>RyaeB@aSOc+
zS9}mpr0${}c2X(agKO6W7r1TF<89Z;oIlSzP#XQj$;APTI*JsZf*q)}MTxtRd+4Ar
zHv?$kiXdNP4Ql7-&w?G?NVuB1wcd|sTYfiJwg*A%?nmSr9T>_YsV|g*BY)WO%ack$
Ok@1e#fByXE5q|^o4Zm3c

literal 0
HcmV?d00001

