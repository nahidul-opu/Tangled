From 110d77c5536f7d5e00c08f4df575cd8de6c75792 Mon Sep 17 00:00:00 2001
From: Maja Kabiljo <majakabiljo@gmsloaner5t430.thefacebook.com>
Date: Wed, 26 Jun 2013 15:07:59 -0700
Subject: [PATCH] GIRAPH-311:  Master halting in superstep 0 is ignored by
 workers (majakabiljo)

---
 CHANGELOG                                          |  2 ++
 .../org/apache/giraph/graph/GraphTaskManager.java  |  4 ++--
 .../test/java/org/apache/giraph/TestBspBasic.java  | 14 ++++++++++++++
 3 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 7d37d5247..5804cab35 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,8 @@
 Giraph Change Log
 
 Release 1.1.0 - unreleased
+  GIRAPH-311:  Master halting in superstep 0 is ignored by workers (majakabiljo)
+
   GIRAPH-688: Make sure Giraph builds against all compatible YARN-enabled Hadoop versions,
   warns if none set, works w/new 1.1.0 line (ereisman)
 
diff --git a/giraph-core/src/main/java/org/apache/giraph/graph/GraphTaskManager.java b/giraph-core/src/main/java/org/apache/giraph/graph/GraphTaskManager.java
index f2ad8b636..e7af82565 100644
--- a/giraph-core/src/main/java/org/apache/giraph/graph/GraphTaskManager.java
+++ b/giraph-core/src/main/java/org/apache/giraph/graph/GraphTaskManager.java
@@ -249,7 +249,7 @@ public void execute() throws IOException, InterruptedException {
     int numComputeThreads = conf.getNumComputeThreads();
 
     // main superstep processing loop
-    do {
+    while (!finishedSuperstepStats.allVerticesHalted()) {
       final long superstep = serviceWorker.getSuperstep();
       GiraphTimerContext superstepTimerContext =
         getTimerForThisSuperstep(superstep);
@@ -286,7 +286,7 @@ public void execute() throws IOException, InterruptedException {
       finishedSuperstepStats = completeSuperstepAndCollectStats(
         partitionStatsList, superstepTimerContext);
       // END of superstep compute loop
-    } while (!finishedSuperstepStats.allVerticesHalted());
+    }
 
     if (LOG.isInfoEnabled()) {
       LOG.info("execute: BSP application done (global vertices marked done)");
diff --git a/giraph-examples/src/test/java/org/apache/giraph/TestBspBasic.java b/giraph-examples/src/test/java/org/apache/giraph/TestBspBasic.java
index c4286abb5..0e3503c97 100644
--- a/giraph-examples/src/test/java/org/apache/giraph/TestBspBasic.java
+++ b/giraph-examples/src/test/java/org/apache/giraph/TestBspBasic.java
@@ -494,4 +494,18 @@ public void testBspMasterCompute()
       assertEquals(32.5, finalSum, 0d);
     }
   }
+
+  /**
+   * Test halting at superstep 0
+   */
+  @Test
+  public void testHaltSuperstep0()
+      throws IOException, InterruptedException, ClassNotFoundException {
+    GiraphConfiguration conf = new GiraphConfiguration();
+    GiraphConstants.MAX_NUMBER_OF_SUPERSTEPS.set(conf, 0);
+    conf.setComputationClass(SimpleMsgComputation.class);
+    conf.setVertexInputFormatClass(SimpleSuperstepVertexInputFormat.class);
+    GiraphJob job = prepareJob(getCallingMethodName(), conf);
+    assertTrue(job.run(true));
+  }
 }
