From 6bcd611226fda54d2f6f83ae4c99a563c91a7312 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Thu, 28 Oct 2010 20:23:18 +0000
Subject: [PATCH] [CONFIGURATION-424] INIConfigurationSource was also partly
 affected.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/configuration2_experimental@1028460 13f79535-47bb-0310-9956-ffa450edef68
---
 .../base/impl/INIConfigurationSource.java     | 13 ++---
 .../base/impl/TestINIConfigurationSource.java | 54 ++++++++++++++++---
 2 files changed, 54 insertions(+), 13 deletions(-)

diff --git a/src/main/java/org/apache/commons/configuration2/base/impl/INIConfigurationSource.java b/src/main/java/org/apache/commons/configuration2/base/impl/INIConfigurationSource.java
index 96d3b0d4b5..c3597b1c58 100644
--- a/src/main/java/org/apache/commons/configuration2/base/impl/INIConfigurationSource.java
+++ b/src/main/java/org/apache/commons/configuration2/base/impl/INIConfigurationSource.java
@@ -214,21 +214,22 @@ public Set<String> getSections()
     {
         Set<String> sections = new LinkedHashSet<String>();
         boolean globalSection = false;
+        boolean inSection = false;
 
         for (ConfigurationNode node : getRootNode().getChildren())
         {
             if (isSectionNode(node))
             {
-                if (globalSection)
-                {
-                    sections.add(null);
-                    globalSection = false;
-                }
+                inSection = true;
                 sections.add(node.getName());
             }
             else
             {
-                globalSection = true;
+                if(!inSection && !globalSection)
+                {
+                    globalSection = true;
+                    sections.add(null);
+                }
             }
         }
 
diff --git a/src/test/java/org/apache/commons/configuration2/base/impl/TestINIConfigurationSource.java b/src/test/java/org/apache/commons/configuration2/base/impl/TestINIConfigurationSource.java
index eabf9158f8..5e2b2bc2d0 100644
--- a/src/test/java/org/apache/commons/configuration2/base/impl/TestINIConfigurationSource.java
+++ b/src/test/java/org/apache/commons/configuration2/base/impl/TestINIConfigurationSource.java
@@ -89,9 +89,13 @@ public class TestINIConfigurationSource
             + LINE_SEPARATOR + "  line 2" + LINE_SEPARATOR
             + "continueNoLine = one \\" + LINE_SEPARATOR;
 
+    /** An ini file that contains only a property in the global section. */
+    private static final String INI_DATA_GLOBAL_ONLY = "globalVar = testGlobal"
+            + LINE_SEPARATOR + LINE_SEPARATOR;
+
     /** An ini file with a global section. */
-    private static final String INI_DATA_GLOBAL = "globalVar = testGlobal"
-            + LINE_SEPARATOR + LINE_SEPARATOR + INI_DATA;
+    private static final String INI_DATA_GLOBAL = INI_DATA_GLOBAL_ONLY
+            + INI_DATA;
 
     /** Constant for the name of the test output file. */
     private static final String TEST_OUT_FILE = "test.ini";
@@ -185,6 +189,23 @@ public void testSave() throws Exception
         assertEquals("Wrong content of ini file", INI_DATA, writer.toString());
     }
 
+    /**
+     * Helper method for testing a save operation. This method constructs a
+     * configuration source from the specified content string. Then it saves
+     * this source and checks whether the result matches the original content.
+     *
+     * @param content the content of the configuration source
+     * @throws ConfigurationException if an error occurs
+     */
+    private void checkSave(String content) throws ConfigurationException,
+            IOException
+    {
+        load(content);
+        StringWriter writer = new StringWriter();
+        source.save(writer);
+        assertEquals("Wrong content of ini file", content, writer.toString());
+    }
+
     /**
      * Tests whether a configuration source with a global section can be saved.
      */
@@ -192,11 +213,18 @@ public void testSave() throws Exception
     public void testSaveWithGlobalSection() throws ConfigurationException,
             IOException
     {
-        load(INI_DATA_GLOBAL);
-        StringWriter writer = new StringWriter();
-        source.save(writer);
-        assertEquals("Wrong content of ini file", INI_DATA_GLOBAL, writer
-                .toString());
+        checkSave(INI_DATA_GLOBAL);
+    }
+
+    /**
+     * Tests whether a configuration source that contains only a global section
+     * can be saved correctly.
+     */
+    @Test
+    public void testSaveWithOnlyGlobalSection() throws ConfigurationException,
+            IOException
+    {
+        checkSave(INI_DATA_GLOBAL_ONLY);
     }
 
     /**
@@ -465,6 +493,18 @@ public void testGetSectionsNoGlobal() throws ConfigurationException
         });
     }
 
+    /**
+     * Tests whether the sections of a configuration can be queried that
+     * contains only a global section.
+     */
+    @Test
+    public void testGetSectionsGlobalOnly() throws ConfigurationException
+    {
+        checkSectionNames(INI_DATA_GLOBAL_ONLY, new String[] {
+            null
+        });
+    }
+
     /**
      * Tests whether variables containing a dot are not misinterpreted as
      * sections. This test is related to CONFIGURATION-327.
