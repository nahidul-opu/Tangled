From 82aa33b5464fae8a107b9c72398aad5853e62f30 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 7 Dec 2009 23:37:38 +0000
Subject: [PATCH] Attempt to fix IVY-1148

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@888191 13f79535-47bb-0310-9956-ffa450edef68
---
 .../org/apache/ivy/core/resolve/IvyNode.java     | 16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

diff --git a/src/java/org/apache/ivy/core/resolve/IvyNode.java b/src/java/org/apache/ivy/core/resolve/IvyNode.java
index 24e8a1ffb..bce378e57 100644
--- a/src/java/org/apache/ivy/core/resolve/IvyNode.java
+++ b/src/java/org/apache/ivy/core/resolve/IvyNode.java
@@ -853,12 +853,16 @@ private void addArtifactsFromMergedUsage(String rootModuleConf, Set artifacts) {
                 for (Iterator it = mergedDependencyArtifacts.iterator(); it.hasNext();) {
                     DependencyArtifactDescriptor dad = (DependencyArtifactDescriptor) it.next();
                     Map extraAttributes = new HashMap(dad.getQualifiedExtraAttributes());
-                    // this is later used to know that this is a merged artifact
-                    extraAttributes.put("ivy:merged", 
-                        dad.getDependencyDescriptor().getParentRevisionId() 
-                        + " -> " + usage.getNode().getId()); 
-                    artifacts.add(new MDArtifact(md, dad.getName(), dad.getType(), dad.getExt(),
-                        dad.getUrl(), extraAttributes));
+                    MDArtifact artifact = new MDArtifact(md, dad.getName(), dad.getType(), dad.getExt(),
+                            dad.getUrl(), extraAttributes);
+                    
+                    if (!artifacts.contains(artifact)) {
+                        // this is later used to know that this is a merged artifact
+                        extraAttributes.put("ivy:merged", 
+                            dad.getDependencyDescriptor().getParentRevisionId() 
+                            + " -> " + usage.getNode().getId()); 
+                        artifacts.add(artifact);
+                    }
                 }
             }
         }
