From ed6115b320aa309100ba2edabff22f5e0c51a71b Mon Sep 17 00:00:00 2001
From: Benedikt Ritter <britter@apache.org>
Date: Mon, 20 Jun 2016 17:00:17 +0000
Subject: [PATCH] IMAGING-176: TiffImageParser.getImageInfo() throws exception
 when "Compression" field is missing. Thank you to Gabriel Axel. This also
 fixes #19 from GitHub.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/imaging/trunk@1749362 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                         |   3 +++
 .../imaging/formats/tiff/TiffImageParser.java   |  13 ++++++++++---
 .../data/images/tiff/8/no-compression-tag.tiff  | Bin 0 -> 80320 bytes
 3 files changed, 13 insertions(+), 3 deletions(-)
 create mode 100644 src/test/data/images/tiff/8/no-compression-tag.tiff

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 64c294658..14f224a22 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -46,6 +46,9 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
 
     <release version="1.0" date="TBA" description="First major release">
+      <action issue="IMAGING-176" dev="britter" type="fix" due-to="Gabriel Axel">
+        TiffImageParser.getImageInfo() throws exception when "Compression" field is missing.
+      </action>
       <action issue="IMAGING-178" dev="britter" type="fix" due-to="emopers">
         PnmImageParser does not check the validity of input PAM header.
       </action>
diff --git a/src/main/java/org/apache/commons/imaging/formats/tiff/TiffImageParser.java b/src/main/java/org/apache/commons/imaging/formats/tiff/TiffImageParser.java
index 2d204ed72..df1fd8c6c 100644
--- a/src/main/java/org/apache/commons/imaging/formats/tiff/TiffImageParser.java
+++ b/src/main/java/org/apache/commons/imaging/formats/tiff/TiffImageParser.java
@@ -259,8 +259,11 @@ public ImageInfo getImageInfo(final ByteSource byteSource, final Map<String, Obj
 
         final ImageInfo.ColorType colorType = ImageInfo.ColorType.RGB;
 
-        final int compression = 0xffff & directory
-                .getSingleFieldValue(TiffTagConstants.TIFF_TAG_COMPRESSION);
+        final short[] compressionFieldValues = directory
+            .getFieldValue(TiffTagConstants.TIFF_TAG_COMPRESSION, false);
+        final short compressionFieldValue = compressionFieldValues != null ?
+            compressionFieldValues[0] : TIFF_COMPRESSION_UNCOMPRESSED_1;
+        final int compression = 0xffff & compressionFieldValue;
         ImageInfo.CompressionAlgorithm compressionAlgorithm;
 
         switch (compression) {
@@ -552,7 +555,11 @@ protected BufferedImage getBufferedImage(final TiffDirectory directory,
 
         final int photometricInterpretation = 0xffff & directory.getSingleFieldValue(
                 TiffTagConstants.TIFF_TAG_PHOTOMETRIC_INTERPRETATION);
-        final int compression = 0xffff & directory.getSingleFieldValue(TiffTagConstants.TIFF_TAG_COMPRESSION);
+        final short[] compressionFieldValues = directory
+            .getFieldValue(TiffTagConstants.TIFF_TAG_COMPRESSION, false);
+        final short compressionFieldValue = compressionFieldValues != null ?
+                compressionFieldValues[0] : TIFF_COMPRESSION_UNCOMPRESSED_1;
+        final int compression = 0xffff & compressionFieldValue;
         final int width = directory.getSingleFieldValue(TiffTagConstants.TIFF_TAG_IMAGE_WIDTH);
         final int height = directory.getSingleFieldValue(TiffTagConstants.TIFF_TAG_IMAGE_LENGTH);      
         
diff --git a/src/test/data/images/tiff/8/no-compression-tag.tiff b/src/test/data/images/tiff/8/no-compression-tag.tiff
new file mode 100644
index 0000000000000000000000000000000000000000..1c6435bf6f45bc674009561a653fba40dd3678da
GIT binary patch
literal 80320
zcmeI2cW4z~7RTSq#;&Wz-h(yPSg?!6ZWJqa#F|8-F$sxF*2-Ey5xZaq6%`f5@`r+o
z4ciJ<6cM{(S1j1;-T9u)8Rosb7bm|2e+0iLJm$`wbK7U`x%b>NiH@%0$?x%aihF)~
zLOot9CF1>ur2lK(c+=A{RyxE=hg#Pg)-P{*eu$MW;tlcCv#t-U-#@K%m|U$|y`dgF
z54S1~OV>vmrP9-=t8{ug%1W0>*N?E2%6s!j9~xTe3hC(<R=T32o{01`+UV!Vw{ERb
z{r@j=Kx%ACYUJ2aqvJ>YJ2oM*Q&L)DLei+1)X0A&j!BxBoD!Rw8XMDKQhZ#Tr(;U&
zs7bLg;c4-c#)Wr{?%Br^WwjV})~e1z@t<Umr<;|uvh1s&kN^pg011!)36KB@kN^pg
z011!)36KB@kN^pg011!)36KB@kN^pg011!)36KB@kN^pg011!)36KB@kN^pg011!)
z36KB@kN^pg011!)36KB@kN^pg011!)36KB@kN^pg011!)36KB@kN^pg011!)36KB@
zkN^pg011!)36KB@kN^pg011!)36KB@kN^pg011!)36KB@kN^pg011!)36KB@kN^pg
z011!)36KB@kN^pg011!)36KB@kic&yuyEl*Q?g`9bN>AKpe-LecFdG0QNpZQvnHqx
zALLE~2?+@%A|k?k{`@)U0Orn}Ydjv0tKZO}L#3XzYuC!WI(6!lUGMGNw@rfv4UE_8
z4O&;hf(4D1$*R8HP!1*r4H_hU-Lz>_&{~%-UoJXh$BqrE!w0#OK$9j-<lR1b@+9a0
z_U_$lI(6z~I(F=6|MKL?Bjwt(X=CT%`O>9Jr5?-`*wo6EEA4tGPo6A!;o;$?YuBy;
zfBpLPGxzS@lQLP=w;RgA1nnaSVdlcB+}KB;VU;OUCR4i#WFMNhdiCl+Rc6S`s(ywF
zav+2DkpmEOaTR}ueZco}BWfRR_1)B&Rh_?TAMi85_Sv&%CMG7vlr3A<6fRuYv~Jzn
z_8*;ndH(#liHnOfb?VeH@G<MxuWxYn`SRt9Q_Z}2^Ts44C7H;`NK>d#A!%dElqu%p
z$B#aGXuoOGrsmwabEaLpc2Z}B3Kh)k*|W{hpFho(En7_8x^+!~0tHO%+O^HbjT?Q+
z4<0<&v}n=7Jbd`j3>!AglrCM`6f0KDbm-8*95`^mM|Z`F74rPdnKNe0m@%eQsZvt!
z;>C+?y_YXv8oW=mS)@o2;jn)Fdg+TQy?_7S%$hYz`h$LfS^xh1&8171R7I|C^`Pvg
zUFgAQ!I-O5sUrRB+_|%yIcXoD6I}kPeN?Mf&GscRAEKk9#h--FnJ-^HbLY+-yV09B
zZ<_Mu%Zonda%^m@Y1pu#+z%W$(4Iqhhm|T-lKi%9+loE4Y}r!oG4I~KeQVdL?ZYN(
z)~qS-J}fLubcYWgE@!~TjT;-(pFe+o$;bRw(ejlmS2pF!m6P&)`}P%^#2B1w7HmS#
zry(IBrdhLQ2L0NzXOC2eb0lmN;~qJ3q=7xRYSl{0Oq@7Tn>0Oo^pLzpjT)Kw_;@p5
zzyJe39=3Av;>9fMxo!9I<;!CG7z54-=p)YLSf{WiAV0J7hutwpB0K(-ldYr549VQQ
zf9U+eynXQCfjzcq)20b;TvdAZ>?wK9_}AC3Uu_%FdE2{pZ_!(|YLylh+nGLny5y&(
zrrP=1KGwwV-@i-#!Gi}y5AS>G)Ty@avSrI8KQS@U&eQVP@33d7T)TEn<|}ON_3PJ?
zt@eSreEj%vRkg1;Q^IaepFVBp{rK@i=0Ey^_#gIJq-)fuVXp^J#vX%s4)#)rTRrHy
zX%~BGR8*9-y?OIy6chRO?VA}rdbG{!ciIOy1o~mEyKv!xc2V}@Kzf?zuWuL3!9;fV
zk0VEp`1D5SDAsL=zHhAYcvnt=Z?kRNHiLHs{|n>By5_I<;ll^<-4J8eXF9(zpH-ed
zeJXW?hKBmgdCX7L-KS3<RW(}v<jIqEo+i{DcJJOTS$dz6lA<d1^~H-9Qa9$Hzo2fk
zi@oC0r%z&c=-c+~+YQE~;`ANe>bY(A(W6JwhkEtu+3d7k_-5Gi(8u3tAMl;A7W)6-
z=i(iz=>FkWU(4m>b;yt*!e_&V4MD4gpRMm%m2`f+di6@P<a*-73DL#aAv!nVXJ;ly
zj~<nBu-8DM{+PZ;ZQnW1u->DeIBz%w`xElv->7JL=iJn13l=O8{dx1|NtW6N=C!}5
z4WRyDKW%sC&YebmK<q^rQ*v^$oS~fcy3upn?%~6SrC-=*0}0N9=(lnWq!TFbPw}td
zhk(zVIdcMGkUXrL(80V>(fRf6-8;>atG|6<e?eLJ+L;Ob7U%_gkNB>H=h$Z;+CJ7>
z6}1oed``*CKAiTYW#-SHFKsPav`DhlK6F1(JzNhRIwZQyn>RQ3j^_VEUAJ!CvWwvC
zy?_6H1OF3eEd5rtWXTd+2Z>+lxoub1r(j&MHiIke!w0{8vvuoM;nTi-`waUpl;GPd
zL%dfNou9w54{!&6tW)Y6X&v|P-#6Hsum`EX5J(Sm7_ltGja0P#?Ak}5^91&J^m*UD
zebQWJ_VM`fW6|x>rHgjWzGA#s=fMbLKn%@)9>R98mmo#}ajWOHUG+J!X87|*yaTZT
z+K2thG9<80>0Co>6z66Y_#W8*!4Ed#e5Pf7WgmDa_*RNK5OY<5-66h;{2e=XNOrGY
zz2x5M>!G~van3Whwx3=5Kp&jvbDR(J=FKZ{H1)kQvk&wSF(K>&*gKt~{Z30uGrM-}
zlCdFvr||^nVqL%)pkl>}Qq--U+jgOcZ{LCVj~h2m^6|{yZk^)@l>SrvD~ug$T=C+?
zg%$o63o#w|3q^|-l{~O;#vf5e=jX5N1G?9*UzhI(cn`3Z@#Du!j1>2X!|Qyxd-txy
zNu7Ec--WLZTUOEbvuhuSCnNTZ?<qLHV?D)s?)0THvk&y=#*G^WjBxhG`3dn|#ELNv
z^b;`(tS$Inqj_i#aXmecAjSr9s|Q^-?LzO$l`HaoVZ+_Jb(8N^IIqJlHTF&W0IA@D
zbqsq2V*7}RBUXeMKK=*B`Q1Tlz<vV0&iRRFi1p%I8@_`%1^Yba8RAozgSgI|InyVO
z1AUw!@IQ0-eh8lm-wLn}`~UwO+Q++f?rBKZs#VL37%{@xw0r|ZpJvRMVdtxT!6p%-
zz<9AXbno8XoIQKi)<XjSe}?B*uU_@Zcitctgg6!E9r{(ZYE}8psplo=Vl6?eS{a}{
z>?clJ%!(d#-Lwlmd|QI;Vm&}y6nh@VIbp&CQ@wii4BuZ-CNqKk!x#2{|5^sId@#e>
ztFmt0I?2;`zUBwJW>r5}J%2|&zD+q})xWzBXy1QN%Ss>AJ`h``kN^qz5}<wf^57i_
zI0?``oHUpw0bc^}#c{Sle1}2;BtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{
z0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2J
zBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZr
zKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZrKmsH{0wh2JBtQZr@MjVD
EAE3d`c>n+a

literal 0
HcmV?d00001

