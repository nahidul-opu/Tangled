From e3fa880da97c75d598c6a9b826c6144998727ce6 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 4 Jun 2008 21:51:27 +0000
Subject: [PATCH] ivy:report will generate an HTML file that references
 non-existent ivy-report.css (IVY-826)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@663379 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 src/java/org/apache/ivy/ant/IvyReport.java    | 10 ++++++--
 .../org/apache/ivy/ant/IvyReportTest.java     | 25 +++++++++++++++++++
 3 files changed, 34 insertions(+), 2 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 93709457e..79779a508 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -81,6 +81,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: ivy:report will generate an HTML file that references non-existent ivy-report.css (IVY-826)
 - FIX: dynamic resolveMode not being dynamic on branch (IVY-825)
 - FIX: Filesystem repositories can not have () in the path (IVY-797)
 - FIX: Type tag in poms not supported (IVY-762)
diff --git a/src/java/org/apache/ivy/ant/IvyReport.java b/src/java/org/apache/ivy/ant/IvyReport.java
index 3e5077843..5504d4bb1 100644
--- a/src/java/org/apache/ivy/ant/IvyReport.java
+++ b/src/java/org/apache/ivy/ant/IvyReport.java
@@ -248,8 +248,14 @@ private void genreport(String[] confs)
         genStyled(confs, getReportStylePath(), xslext);
 
         // copy the css if required
-        if (todir != null && xslFile == null) {
-            File css = new File(todir, "ivy-report.css");
+        if (xslFile == null) {
+            File css;
+            if (todir != null) {
+                css = new File(todir, "ivy-report.css");
+            } else {
+                css = new File("ivy-report.css");
+            }
+            
             if (!css.exists()) {
                 Message.debug("copying report css to " + todir);
                 FileUtil.copy(XmlReportOutputter.class.getResourceAsStream("ivy-report.css"), css,
diff --git a/test/java/org/apache/ivy/ant/IvyReportTest.java b/test/java/org/apache/ivy/ant/IvyReportTest.java
index a29dbfc53..c7dd4249a 100644
--- a/test/java/org/apache/ivy/ant/IvyReportTest.java
+++ b/test/java/org/apache/ivy/ant/IvyReportTest.java
@@ -75,11 +75,36 @@ public void testSimple() throws Exception {
             report.execute();
             
             assertTrue(new File(cache, "report/apache-resolve-simple-default.html").exists());
+            assertTrue(new File(cache, "report/ivy-report.css").exists()); // IVY-826
             assertTrue(new File(cache, "report/apache-resolve-simple-default.graphml").exists());
         } finally {
             Locale.setDefault(oldLocale);
         }
     }
+    
+    public void testCopyCssIfTodirNotSet() {
+        Locale oldLocale = Locale.getDefault();
+        
+        try {
+            // set the locale to UK as workaround for SUN bug 6240963
+            Locale.setDefault(Locale.UK);
+
+            IvyResolve res = new IvyResolve();
+            res.setProject(project);
+            res.setFile(new File("test/java/org/apache/ivy/ant/ivy-simple.xml"));
+            res.execute();
+    
+            report.execute();
+            report.setGraph(false);
+            
+            assertTrue(new File("apache-resolve-simple-default.html").exists());
+            assertTrue(new File("ivy-report.css").exists()); // IVY-826
+        } finally {
+            Locale.setDefault(oldLocale);
+            new File("apache-resolve-simple-default.html").delete();
+            new File("ivy-report.css").delete();
+        }
+    }
 
     public void testNoRevisionInOutputPattern() throws Exception {
         Locale oldLocale = Locale.getDefault();
