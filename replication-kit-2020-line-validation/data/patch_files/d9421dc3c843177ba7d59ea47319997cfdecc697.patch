From d9421dc3c843177ba7d59ea47319997cfdecc697 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Mon, 9 Jan 2017 15:27:25 +0100
Subject: [PATCH] SnappyInputStream must slide then window when before writing
 beyond buffer

may be related to COMPRESS-358
---
 .../snappy/SnappyCompressorInputStream.java        | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java b/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java
index 781ebbf22e8..faeabffd5d9 100644
--- a/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java
+++ b/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java
@@ -310,6 +310,7 @@ private int readLiteralLength(final int b) throws IOException {
      * @return True if the decompressed data should be flushed
      */
     private boolean expandLiteral(final int length) throws IOException {
+        boolean shouldFlush = ensureBufferSpace(length);
         final int bytesRead = IOUtils.readFully(in, decompressBuf, writeIndex, length);
         count(bytesRead);
         if (length != bytesRead) {
@@ -317,7 +318,15 @@ private boolean expandLiteral(final int length) throws IOException {
         }
 
         writeIndex += length;
-        return writeIndex >= 2 * this.blockSize;
+        return shouldFlush || writeIndex >= 2 * this.blockSize;
+    }
+
+    private boolean ensureBufferSpace(final int length) {
+        if (writeIndex + length >= decompressBuf.length) {
+            slideBuffer();
+            return true;
+        }
+        return false;
     }
 
     /**
@@ -344,6 +353,7 @@ private boolean expandCopy(final long off, final int length) throws IOException
             throw new IOException("Offset is larger than block size");
         }
         final int offset = (int) off;
+        boolean shouldFlush = ensureBufferSpace(length);
 
         if (offset == 1) {
             final byte lastChar = decompressBuf[writeIndex - 1];
@@ -371,7 +381,7 @@ private boolean expandCopy(final long off, final int length) throws IOException
                 writeIndex += pad;
             }
         }
-        return writeIndex >= 2 * this.blockSize;
+        return shouldFlush || writeIndex >= 2 * this.blockSize;
     }
 
     /**
