From b4d7505f8eb531a70d0a56e2b76b36bc302b212b Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Wed, 13 Jul 2011 13:53:18 +0000
Subject: [PATCH] Make sure Inflator is cleaned up.  COMPRESS-139

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@1146027 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                   | 3 +++
 .../apache/commons/compress/archivers/zip/ZipFile.java    | 8 +++++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 409587cb79a..6c3b360c41c 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -45,6 +45,9 @@ The <action> type attribute can be add,update,fix,remove.
   </properties>
   <body>
     <release version="1.2" date="as in SVN" description="Release 1.2">
+      <action issue="COMPRESS-139" type="fix" date="2011-07-13">
+        ZipFile may leak resources on some JDKs.
+      </action> 
       <action type="update" date="2011-04-18">
         ZipFile now implements finalize which closes the underlying
         file.
diff --git a/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java b/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java
index 9dc06eedfd3..e34bc4a2240 100644
--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java
+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java
@@ -317,7 +317,13 @@ public InputStream getInputStream(ZipArchiveEntry ze)
                 return bis;
             case ZipArchiveEntry.DEFLATED:
                 bis.addDummy();
-                return new InflaterInputStream(bis, new Inflater(true));
+                final Inflater inflater = new Inflater(true);
+                return new InflaterInputStream(bis, inflater) {
+                    public void close() throws IOException {
+                        super.close();
+                        inflater.end();
+                    }
+                };
             default:
                 throw new ZipException("Found unsupported compression method "
                                        + ze.getMethod());
