From ea0c721e8dbdcf88e5e36103f7da7f69ab4a8da0 Mon Sep 17 00:00:00 2001
From: Avery Ching <aching@apache.org>
Date: Wed, 14 Sep 2011 03:50:57 +0000
Subject: [PATCH] GIRAPH-30: NPE in ZooKeeperManager if base directory cannot
 be created. apurtell via aching.

git-svn-id: https://svn.apache.org/repos/asf/incubator/giraph/trunk@1170427 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGELOG                                         |  3 +++
 .../org/apache/giraph/zk/ZooKeeperManager.java    | 15 +++++++++++++++
 2 files changed, 18 insertions(+)

diff --git a/CHANGELOG b/CHANGELOG
index 345788c2c..90c145d82 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -2,6 +2,9 @@ Giraph Change Log
 
 Release 0.70.0 - unreleased
 
+  GIRAPH-30: NPE in ZooKeeperManager if base directory cannot be
+  created. apurtell via aching.
+
   GIRAPH-27: Mutable static global state in Vertex.java should be
   refactored. jake.mannix via aching.
  
diff --git a/src/main/java/org/apache/giraph/zk/ZooKeeperManager.java b/src/main/java/org/apache/giraph/zk/ZooKeeperManager.java
index d0f9713c8..dd13f5ba7 100644
--- a/src/main/java/org/apache/giraph/zk/ZooKeeperManager.java
+++ b/src/main/java/org/apache/giraph/zk/ZooKeeperManager.java
@@ -229,6 +229,21 @@ public void createCandidateStamp() {
             LOG.error("createCandidateStamp: Failed to mkdirs " +
                       baseDirectory);
         }
+        // Check that the base directory exists and is a directory
+        try {
+            if (!fs.getFileStatus(baseDirectory).isDir()) {
+                throw new IllegalArgumentException(
+                    "createCandidateStamp: " + baseDirectory +
+                    " is not a directory, but should be.");
+            }
+        } catch (IOException e) {
+            throw new IllegalArgumentException(
+                "createCandidateStamp: Couldn't get file status " +
+                "for base directory " + baseDirectory + ".  If there is an " +
+                "issue with this directory, please set an accesible " +
+                "base directory with the Hadoop configuration option " +
+                GiraphJob.ZOOKEEPER_MANAGER_DIRECTORY);
+        }
 
         Path myCandidacyPath = new Path(
             taskDirectory, myHostname +
