From b9b9bae63e08432f620abd1c0e35abf662a6008d Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Mon, 31 Jan 2011 18:20:55 +0000
Subject: [PATCH] NET-351 - APOP authentication fails most of the time Fix by
 adding leading 0 if necessary Patch due to Bogdan Drozdowski

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1065701 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                                         | 2 ++
 src/main/java/org/apache/commons/net/pop3/POP3Client.java | 7 +++++--
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index e8db23bd1..af07ce140 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -21,6 +21,8 @@ o NET-263:  SubnetUtils / SubNetInfo toString() implementations
 o Javadoc fixes, improvements, and refactoring. 
 
 Fixed Bugs:
+o NET-351:  APOP authentication fails most of the time
+            Fix by adding leading 0 if necessary. Patch due to Bogdan Drozdowski
 o NET-334:  FromNetASCIIInputStream can throw a NullPointerException 
 o NET-341:  FTPClient.remoteAppend(String filename) uses STOR instead of APPE 
 o NET-339:  Incorrect parsing of timestamp on Windows CE
diff --git a/src/main/java/org/apache/commons/net/pop3/POP3Client.java b/src/main/java/org/apache/commons/net/pop3/POP3Client.java
index 45011dbd2..5c2f6811c 100644
--- a/src/main/java/org/apache/commons/net/pop3/POP3Client.java
+++ b/src/main/java/org/apache/commons/net/pop3/POP3Client.java
@@ -193,8 +193,11 @@ public boolean login(String username, String timestamp, String secret)
         digest = md5.digest(timestamp.getBytes());
         digestBuffer = new StringBuilder(128);
 
-        for (i = 0; i < digest.length; i++)
-            digestBuffer.append(Integer.toHexString(digest[i] & 0xff));
+        for (i = 0; i < digest.length; i++) {
+            int digit = digest[i] & 0xff;
+            if (digit <= 15) digestBuffer.append("0"); // Add leading zero if necessary (NET-351)
+            digestBuffer.append(Integer.toHexString(digit));
+	    }
 
         buffer = new StringBuilder(256);
         buffer.append(username);
