From e00a63dee360a98653d6a2cdf36a235e97cf5119 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Sun, 3 Sep 2006 19:13:34 +0000
Subject: [PATCH] add test case for IVY-283

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484496 13f79535-47bb-0310-9956-ffa450edef68
---
 test/java/fr/jayasoft/ivy/ResolveTest.java  | 22 ++++++++++++++++++++-
 test/repositories/IVY-283/B/ivy-1.0.xml     | 17 ++++++++++++++++
 test/repositories/IVY-283/B/lib_b_a-1.0.jar |  1 +
 test/repositories/IVY-283/B/lib_b_b-1.0.jar |  1 +
 test/repositories/IVY-283/C/ivy-1.0.xml     | 15 ++++++++++++++
 test/repositories/IVY-283/C/lib_c_a-1.0.jar |  1 +
 test/repositories/IVY-283/C/lib_c_b-1.0.jar |  1 +
 test/repositories/IVY-283/C/lib_c_c-1.0.jar |  1 +
 test/repositories/IVY-283/C/lib_c_d-1.0.jar |  1 +
 test/repositories/IVY-283/C/lib_c_e-1.0.jar |  1 +
 test/repositories/IVY-283/ivy.xml           | 21 ++++++++++++++++++++
 test/repositories/IVY-283/ivyconf.xml       |  9 +++++++++
 12 files changed, 90 insertions(+), 1 deletion(-)
 create mode 100644 test/repositories/IVY-283/B/ivy-1.0.xml
 create mode 100644 test/repositories/IVY-283/B/lib_b_a-1.0.jar
 create mode 100644 test/repositories/IVY-283/B/lib_b_b-1.0.jar
 create mode 100644 test/repositories/IVY-283/C/ivy-1.0.xml
 create mode 100644 test/repositories/IVY-283/C/lib_c_a-1.0.jar
 create mode 100644 test/repositories/IVY-283/C/lib_c_b-1.0.jar
 create mode 100644 test/repositories/IVY-283/C/lib_c_c-1.0.jar
 create mode 100644 test/repositories/IVY-283/C/lib_c_d-1.0.jar
 create mode 100644 test/repositories/IVY-283/C/lib_c_e-1.0.jar
 create mode 100644 test/repositories/IVY-283/ivy.xml
 create mode 100644 test/repositories/IVY-283/ivyconf.xml

diff --git a/test/java/fr/jayasoft/ivy/ResolveTest.java b/test/java/fr/jayasoft/ivy/ResolveTest.java
index 99a37f843..87e8d6b3e 100644
--- a/test/java/fr/jayasoft/ivy/ResolveTest.java
+++ b/test/java/fr/jayasoft/ivy/ResolveTest.java
@@ -582,7 +582,8 @@ public void testResolveMultipleExtends2() throws Exception {
         assertTrue(_ivy.getArchiveFileInCache(_cache, "org1", "mod1.2", "2.1", "mod1.2", "jar", "jar").exists());
     }
 
-    public void testResolveDefaultWithArtifacts() throws Exception {
+    public void testResolveSeveralDefaultWithArtifacts() throws Exception {
+    	// test case for IVY-261
     	// mod1.6 depends on
     	//   mod1.4, which depends on mod1.3 and selects one of its artifacts
     	//   mod1.3 and selects two of its artifacts
@@ -594,8 +595,27 @@ public void testResolveDefaultWithArtifacts() throws Exception {
         assertTrue(_ivy.getArchiveFileInCache(_cache, "org1", "mod1.3", "3.0", "mod1.3-A", "jar", "jar").exists());
         assertTrue(_ivy.getArchiveFileInCache(_cache, "org1", "mod1.3", "3.0", "mod1.3-B", "jar", "jar").exists());
     }
+
+    public void testResolveSeveralDefaultWithArtifactsAndConfs() throws Exception {
+    	// test case for IVY-283
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-283/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-283/ivy.xml").toURL(),
+                null, new String[] {"*"}, _cache, null, true);
+        assertFalse(report.hasError());
+        
+        // dependencies
+        ConfigurationResolveReport crr = report.getConfigurationReport("build");
+        assertNotNull(crr);
+        assertEquals(3, crr.getDownloadReports(ModuleRevisionId.newInstance("medicel", "C", "1.0")).length);
+
+        assertTrue(_ivy.getArchiveFileInCache(_cache, "medicel", "C", "1.0", "lib_c_a", "jar", "jar").exists());
+        assertTrue(_ivy.getArchiveFileInCache(_cache, "medicel", "C", "1.0", "lib_c_b", "jar", "jar").exists());
+        assertTrue(_ivy.getArchiveFileInCache(_cache, "medicel", "C", "1.0", "lib_c_d", "jar", "jar").exists());
+    }
     
 
+
     public void testResolveDefaultWithArtifactsConf1() throws Exception {
         // mod2.2 depends on mod1.3 and selects its artifacts
         ResolveReport report = _ivy.resolve(new File("test/repositories/1/org2/mod2.2/ivys/ivy-0.5.xml").toURL(),
diff --git a/test/repositories/IVY-283/B/ivy-1.0.xml b/test/repositories/IVY-283/B/ivy-1.0.xml
new file mode 100644
index 000000000..0e35ce243
--- /dev/null
+++ b/test/repositories/IVY-283/B/ivy-1.0.xml
@@ -0,0 +1,17 @@
+<ivy-module version="1.4">
+  <info organisation="medicel" module="B" revision="1.0"/>
+  <configurations defaultconfmapping="*->#;test->runtime">
+    <conf name="build" description="Buildtime dependency configuration" />
+    <conf name="runtime" extends="build" description="Runtime dependency configuration" />
+    <conf name="test" extends="runtime" description="Test dependency configuration" />
+  </configurations>
+  <publications>
+    <artifact name="lib_b_a" type="jar" />
+    <artifact name="lib_b_b" type="jar" />
+  </publications>
+  <dependencies>
+    <dependency name="C" rev="latest.integration" conf="build">
+      <artifact name="lib_c_a" type="jar" />
+    </dependency>
+  </dependencies>
+</ivy-module> 
\ No newline at end of file
diff --git a/test/repositories/IVY-283/B/lib_b_a-1.0.jar b/test/repositories/IVY-283/B/lib_b_a-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/B/lib_b_a-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/B/lib_b_b-1.0.jar b/test/repositories/IVY-283/B/lib_b_b-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/B/lib_b_b-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/C/ivy-1.0.xml b/test/repositories/IVY-283/C/ivy-1.0.xml
new file mode 100644
index 000000000..de674e827
--- /dev/null
+++ b/test/repositories/IVY-283/C/ivy-1.0.xml
@@ -0,0 +1,15 @@
+<ivy-module version="1.4">
+  <info organisation="medicel" module="C" revision="1.0"/>
+  <configurations defaultconfmapping="*->#;test->runtime">
+    <conf name="build" description="Buildtime dependency configuration" />
+    <conf name="runtime" extends="build" description="Runtime dependency configuration" />
+    <conf name="test" extends="runtime" description="Test dependency configuration" />
+  </configurations>
+  <publications>
+    <artifact name="lib_c_a" type="jar" />
+    <artifact name="lib_c_b" type="jar" />
+    <artifact name="lib_c_c" type="jar" />
+    <artifact name="lib_c_d" type="jar" />
+    <artifact name="lib_c_e" type="jar" />
+  </publications>
+</ivy-module> 
\ No newline at end of file
diff --git a/test/repositories/IVY-283/C/lib_c_a-1.0.jar b/test/repositories/IVY-283/C/lib_c_a-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/C/lib_c_a-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/C/lib_c_b-1.0.jar b/test/repositories/IVY-283/C/lib_c_b-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/C/lib_c_b-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/C/lib_c_c-1.0.jar b/test/repositories/IVY-283/C/lib_c_c-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/C/lib_c_c-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/C/lib_c_d-1.0.jar b/test/repositories/IVY-283/C/lib_c_d-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/C/lib_c_d-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/C/lib_c_e-1.0.jar b/test/repositories/IVY-283/C/lib_c_e-1.0.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/IVY-283/C/lib_c_e-1.0.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
diff --git a/test/repositories/IVY-283/ivy.xml b/test/repositories/IVY-283/ivy.xml
new file mode 100644
index 000000000..05d56eef4
--- /dev/null
+++ b/test/repositories/IVY-283/ivy.xml
@@ -0,0 +1,21 @@
+<ivy-module version="1.4">
+  <info organisation="medicel" module="A" />
+  <configurations defaultconfmapping="*->#;test->runtime">
+    <conf name="build" description="Buildtime dependency configuration" />
+    <conf name="runtime" extends="build" description="Runtime dependency configuration" />
+    <conf name="test" extends="runtime" description="Test dependency configuration" />
+  </configurations>
+  <publications>
+    <artifact name="lib_a_a" type="jar" />
+  </publications>
+  <dependencies>
+    <dependency name="B" rev="latest.integration" conf="build">
+      <artifact name="lib_b_a" type="jar" />
+    </dependency>
+    <dependency name="C" rev="latest.integration" conf="build">
+      <artifact name="lib_c_a" type="jar" />
+      <artifact name="lib_c_b" type="jar" />
+      <artifact name="lib_c_d" type="jar" />
+    </dependency>
+  </dependencies>
+</ivy-module> 
\ No newline at end of file
diff --git a/test/repositories/IVY-283/ivyconf.xml b/test/repositories/IVY-283/ivyconf.xml
new file mode 100644
index 000000000..db9271771
--- /dev/null
+++ b/test/repositories/IVY-283/ivyconf.xml
@@ -0,0 +1,9 @@
+<ivyconf>
+    <conf defaultResolver="myresolver"/>
+    <resolvers>
+			<filesystem name="myresolver">
+				<ivy pattern="${ivy.conf.dir}/[module]/ivy-[revision].xml" />
+				<artifact pattern="${ivy.conf.dir}/[module]/[artifact]-[revision].[ext]" />
+			</filesystem>
+    </resolvers>
+</ivyconf>
