From cc502dfc9d48fdd01b43869903bebeb7964286d9 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 4 Apr 2007 21:13:09 +0000
Subject: [PATCH] FIX: ivy-retrieve failure when explicit absolute
 'ivy.dep.file' path specified (IVY-396)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@525605 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                    |  1 +
 src/java/org/apache/ivy/ant/IvyResolve.java    |  2 +-
 .../org/apache/ivy/ant/IvyResolveTest.java     | 18 ++++++++++++++++++
 3 files changed, 20 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index a03500f0a..a4b7d4c7b 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -60,6 +60,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVE: New "modules in use" section in console report at the end of resolve (IVY-373) (thanks to John Wiliams)
 - IMPROVE: Generated XML reports now contains more information about the resolved module (IVY-446)
 
+- FIX: ivy-retrieve failure when explicit absolute 'ivy.dep.file' path specified (IVY-396)
 - FIX: IvyPostResolve Task doesn't reuse Ivy file of previous resolve (IVY-458)
 - FIX: Ivy standalone is passing null args to main method when invoking with no args (IVY-457)
 - FIX: Invalid error report with m2compatible resolver (IVY-456)
diff --git a/src/java/org/apache/ivy/ant/IvyResolve.java b/src/java/org/apache/ivy/ant/IvyResolve.java
index e1c61128e..acf31b6dc 100644
--- a/src/java/org/apache/ivy/ant/IvyResolve.java
+++ b/src/java/org/apache/ivy/ant/IvyResolve.java
@@ -171,7 +171,7 @@ public void execute() throws BuildException {
             		throw new BuildException("'module' not allowed when not using 'org' attribute");
             	}
 	            if (_file == null) {
-	                _file = new File(getProject().getBaseDir(), getProperty(settings, "ivy.dep.file"));
+	                _file = getProject().resolveFile(getProperty(settings, "ivy.dep.file"));
 	            }
 	            report = ivy.resolve(
 	                    _file.toURL(), 
diff --git a/test/java/org/apache/ivy/ant/IvyResolveTest.java b/test/java/org/apache/ivy/ant/IvyResolveTest.java
index aec8d0e7f..d5d708d10 100644
--- a/test/java/org/apache/ivy/ant/IvyResolveTest.java
+++ b/test/java/org/apache/ivy/ant/IvyResolveTest.java
@@ -24,6 +24,7 @@
 import org.apache.ivy.Ivy;
 import org.apache.ivy.TestHelper;
 import org.apache.ivy.core.module.id.ModuleRevisionId;
+import org.apache.ivy.core.report.ResolveReport;
 import org.apache.tools.ant.BuildException;
 import org.apache.tools.ant.Project;
 import org.apache.tools.ant.taskdefs.Delete;
@@ -287,6 +288,23 @@ public void testDifferentResolveWithSameResolveId() throws Exception {
         assertNotNull(project.getReference("ivy.resolved.configurations.ref.testWithResolveId"));
     }
     
+    public void testResolveWithAbsoluteFile() {
+    	// IVY-396
+    	File ivyFile = new File("test/java/org/apache/ivy/ant/ivy-simple.xml");
+    	_resolve.getProject().setProperty("ivy.dep.file", ivyFile.getAbsolutePath());
+    	_resolve.execute();
+        
+        assertTrue(getResolvedIvyFileInCache(ModuleRevisionId.newInstance("apache", "resolve-simple", "1.0")).exists());
+    }
+    
+    public void testResolveWithRelativeFile() {
+    	// IVY-396
+    	_resolve.getProject().setProperty("ivy.dep.file", "test/java/org/apache/ivy/ant/ivy-simple.xml");
+    	_resolve.execute();
+        
+        assertTrue(getResolvedIvyFileInCache(ModuleRevisionId.newInstance("apache", "resolve-simple", "1.0")).exists());
+    }
+    
     private Ivy getIvy() {
         return _resolve.getIvyInstance();
     }
