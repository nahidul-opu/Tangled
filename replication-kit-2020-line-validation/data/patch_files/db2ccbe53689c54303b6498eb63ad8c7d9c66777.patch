From db2ccbe53689c54303b6498eb63ad8c7d9c66777 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 14 Jan 2009 21:22:01 +0000
Subject: [PATCH] FIX: Ivy deliver fails to replace dynamic revision (IVY-999)
 (thanks to Martin Eigenbrodt)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@734517 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  2 ++
 .../apache/ivy/core/settings/IvySettings.java |  1 +
 .../conflict/LatestConflictManager.java       | 15 +++++++++++
 .../apache/ivy/core/resolve/ResolveTest.java  | 16 +++++++++++
 .../org/apache/ivy/core/resolve/ivy-999.xml   | 26 ++++++++++++++++++
 test/repositories/IVY-999/ivysettings.xml     | 27 +++++++++++++++++++
 .../IVY-999/junit/junit/ivy-3.8.xml           | 22 +++++++++++++++
 .../IVY-999/junit/junit/ivy-4.4.xml           | 22 +++++++++++++++
 test/repositories/IVY-999/test/a/ivy-1.xml    | 25 +++++++++++++++++
 test/repositories/IVY-999/test/b/ivy-1.5.xml  | 26 ++++++++++++++++++
 10 files changed, 182 insertions(+)
 create mode 100644 test/java/org/apache/ivy/core/resolve/ivy-999.xml
 create mode 100644 test/repositories/IVY-999/ivysettings.xml
 create mode 100644 test/repositories/IVY-999/junit/junit/ivy-3.8.xml
 create mode 100644 test/repositories/IVY-999/junit/junit/ivy-4.4.xml
 create mode 100644 test/repositories/IVY-999/test/a/ivy-1.xml
 create mode 100644 test/repositories/IVY-999/test/b/ivy-1.5.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 246003503..f0592e6d2 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -27,6 +27,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Kristian Cibulskis
 	Andrea Bernardo Ciddio
 	Archie Cobbs
+	Martin Eigenbrodt
 	Danno Ferrin
 	Benjamin Francisoud	
 	Jacob Grydholt Jensen
@@ -89,6 +90,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: Listing of URL's under a given URL does not handle fully specified URL's (IVY-959) (thanks to Randy Nott)
 - FIX: <ivy:buildnumber> returns wrong result when resolve fails (IVY-970)
 - FIX: listing possible token values doesn't work properly for the ibiblio resolver
+- FIX: Ivy deliver fails to replace dynamic revision (IVY-999) (thanks to Martin Eigenbrodt)
 
    2.0.0
 =====================================
diff --git a/src/java/org/apache/ivy/core/settings/IvySettings.java b/src/java/org/apache/ivy/core/settings/IvySettings.java
index 200d99dc6..8b8783095 100644
--- a/src/java/org/apache/ivy/core/settings/IvySettings.java
+++ b/src/java/org/apache/ivy/core/settings/IvySettings.java
@@ -1169,6 +1169,7 @@ public String getVariable(String name) {
     public ConflictManager getDefaultConflictManager() {
         if (defaultConflictManager == null) {
             defaultConflictManager = new LatestConflictManager(getDefaultLatestStrategy());
+            ((LatestConflictManager) defaultConflictManager).setSettings(this);
         }
         return defaultConflictManager;
     }
diff --git a/src/java/org/apache/ivy/plugins/conflict/LatestConflictManager.java b/src/java/org/apache/ivy/plugins/conflict/LatestConflictManager.java
index 2e74fd9e8..213e1fffe 100644
--- a/src/java/org/apache/ivy/plugins/conflict/LatestConflictManager.java
+++ b/src/java/org/apache/ivy/plugins/conflict/LatestConflictManager.java
@@ -24,6 +24,7 @@
 import java.util.List;
 
 import org.apache.ivy.core.module.descriptor.DependencyDescriptor;
+import org.apache.ivy.core.module.id.ModuleRevisionId;
 import org.apache.ivy.core.resolve.IvyNode;
 import org.apache.ivy.plugins.latest.ArtifactInfo;
 import org.apache.ivy.plugins.latest.LatestStrategy;
@@ -89,6 +90,20 @@ public Collection resolveConflicts(IvyNode parent, Collection conflicts) {
                 return Collections.singleton(node);
             }
         }
+        
+        /*
+         * If the list of conflicts contains dynamic revisions, delay the conflict
+         * calculation until they are resolved.
+         * TODO: we probably could already evict some of the dynamic revisions!
+         */
+        for (Iterator iter = conflicts.iterator(); iter.hasNext();) {
+            IvyNode node = (IvyNode) iter.next();
+            ModuleRevisionId modRev = node.getResolvedId();
+            if (getSettings().getVersionMatcher().isDynamic(modRev)) {
+                return null;
+            }
+        }
+        
         try {
             IvyNodeArtifactInfo latest = (IvyNodeArtifactInfo) 
                 getStrategy().findLatest(toArtifactInfo(conflicts), null);
diff --git a/test/java/org/apache/ivy/core/resolve/ResolveTest.java b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
index 1b462d0d4..3f332f5eb 100644
--- a/test/java/org/apache/ivy/core/resolve/ResolveTest.java
+++ b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
@@ -18,6 +18,7 @@
 package org.apache.ivy.core.resolve;
 
 import java.io.File;
+import java.io.FileInputStream;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collection;
@@ -25,8 +26,10 @@
 import java.util.Date;
 import java.util.HashMap;
 import java.util.HashSet;
+import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
+import java.util.Properties;
 import java.util.Set;
 
 import javax.xml.parsers.SAXParser;
@@ -3088,6 +3091,19 @@ public void testBug148b() throws Exception {
                 .exists());
     }
 
+    public void testIVY999() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/ivy-999/ivysettings.xml"));
+        ivy.getSettings().setDefaultCache(cache);
+
+        ResolveReport rr = ivy.resolve(ResolveTest.class.getResource("ivy-999.xml"), getResolveOptions(new String[] {"*"}));
+        ConfigurationResolveReport crr = rr.getConfigurationReport("default");
+        Set modRevIds = crr.getModuleRevisionIds();
+
+        assertTrue(modRevIds.contains(ModuleRevisionId.newInstance("junit", "junit", "4.4")));
+        assertFalse(modRevIds.contains(ModuleRevisionId.newInstance("junit", "junit", "3.8")));
+    }
+
     public void testBadFiles() throws Exception {
         Ivy ivy = new Ivy();
         ivy.configure(new File("test/repositories/badfile/ivysettings.xml"));
diff --git a/test/java/org/apache/ivy/core/resolve/ivy-999.xml b/test/java/org/apache/ivy/core/resolve/ivy-999.xml
new file mode 100644
index 000000000..fdea6e436
--- /dev/null
+++ b/test/java/org/apache/ivy/core/resolve/ivy-999.xml
@@ -0,0 +1,26 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+    <info organisation="apache" module="IVY-999" revision="1.0"/>
+	<dependencies>
+        <dependency org="test" name="a" rev="latest.integration"/>
+        <dependency org="test" name="b" rev="latest.integration"/>
+        <dependency org="junit" name="junit" rev="latest.integration"/>
+	</dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-999/ivysettings.xml b/test/repositories/IVY-999/ivysettings.xml
new file mode 100644
index 000000000..1619f597f
--- /dev/null
+++ b/test/repositories/IVY-999/ivysettings.xml
@@ -0,0 +1,27 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.
+-->
+<ivysettings>
+   <settings defaultResolver="local" />
+   <resolvers>
+            <filesystem name="local" >
+            <ivy pattern="${ivy.settings.dir}/[organisation]/[module]/ivy-[revision].xml"/>
+            <artifact pattern="${ivy.settings.dir}/[organisation]/[module]/[artifact]-[revision].[ext]"/>
+        </filesystem>
+    </resolvers>
+</ivysettings>
diff --git a/test/repositories/IVY-999/junit/junit/ivy-3.8.xml b/test/repositories/IVY-999/junit/junit/ivy-3.8.xml
new file mode 100644
index 000000000..cb911aed1
--- /dev/null
+++ b/test/repositories/IVY-999/junit/junit/ivy-3.8.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+    <info organisation="junit" module="junit" revision="3.8" status="integration" publication="20090108103716"/>
+    <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-999/junit/junit/ivy-4.4.xml b/test/repositories/IVY-999/junit/junit/ivy-4.4.xml
new file mode 100644
index 000000000..1383c5462
--- /dev/null
+++ b/test/repositories/IVY-999/junit/junit/ivy-4.4.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+    <info organisation="junit" module="junit" revision="4.4" status="integration" publication="20090108103715"/>
+    <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-999/test/a/ivy-1.xml b/test/repositories/IVY-999/test/a/ivy-1.xml
new file mode 100644
index 000000000..a3f9e0108
--- /dev/null
+++ b/test/repositories/IVY-999/test/a/ivy-1.xml
@@ -0,0 +1,25 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4">
+   <info organisation="test" module="a" revision="1" status="integration" publication="20090108103716"/>
+   <publications/>
+   <dependencies>
+      <dependency org="junit" name="junit" rev="4.4"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-999/test/b/ivy-1.5.xml b/test/repositories/IVY-999/test/b/ivy-1.5.xml
new file mode 100644
index 000000000..0c8c9dce6
--- /dev/null
+++ b/test/repositories/IVY-999/test/b/ivy-1.5.xml
@@ -0,0 +1,26 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+	<info organisation="test" module="b" revision="1.5" status="integration" publication="20090108103716"/>
+    <!-- uispec4j -->
+	<publications/>
+	<dependencies>
+		<dependency org="junit" name="junit" rev="3.8+" conf="default"/>
+	</dependencies>
+</ivy-module>
