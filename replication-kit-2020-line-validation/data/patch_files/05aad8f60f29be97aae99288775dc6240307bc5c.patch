From 05aad8f60f29be97aae99288775dc6240307bc5c Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Thu, 3 Apr 2008 16:45:44 +0000
Subject: [PATCH] FIX: NullPointerException during
 ResovleEngine.downloadArtifacts. (IVY-592)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@644402 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                             | 1 +
 src/java/org/apache/ivy/ant/IvyArtifactReport.java      | 6 ++++--
 src/java/org/apache/ivy/core/resolve/ResolveEngine.java | 3 ++-
 3 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 57e211d23..cf88682d9 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -76,6 +76,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: NullPointerException during ResovleEngine.downloadArtifacts. (IVY-592)
 - FIX: setting m2compatible on ibiblio resolver overwrite root and pattern settings (IVY-437) (thanks to Jing Xue)
 - FIX: unable to resolve snapshot versions (IVY-501)
 - FIX: No error or warning when a resolver references a non-existent cache (IVY-777)
diff --git a/src/java/org/apache/ivy/ant/IvyArtifactReport.java b/src/java/org/apache/ivy/ant/IvyArtifactReport.java
index e7d75baf1..91edca470 100644
--- a/src/java/org/apache/ivy/ant/IvyArtifactReport.java
+++ b/src/java/org/apache/ivy/ant/IvyArtifactReport.java
@@ -42,6 +42,7 @@
 import org.apache.ivy.core.report.ArtifactDownloadReport;
 import org.apache.ivy.core.resolve.IvyNode;
 import org.apache.ivy.core.resolve.ResolveOptions;
+import org.apache.ivy.core.resolve.ResolvedModuleRevision;
 import org.apache.ivy.core.retrieve.RetrieveOptions;
 import org.apache.tools.ant.BuildException;
 import org.apache.tools.ant.Project;
@@ -199,9 +200,10 @@ private void startModule(TransformerHandler saxHandler, IvyNode dependency)
         moduleAttrs.addAttribute(null, "organisation", "organisation", "CDATA", dependency
                 .getModuleId().getOrganisation());
         moduleAttrs.addAttribute(null, "name", "name", "CDATA", dependency.getModuleId().getName());
-        moduleAttrs.addAttribute(null, "rev", "rev", "CDATA", dependency.getModuleRevision()
+        ResolvedModuleRevision moduleRevision = dependency.getModuleRevision();
+        moduleAttrs.addAttribute(null, "rev", "rev", "CDATA", moduleRevision
                 .getId().getRevision());
-        moduleAttrs.addAttribute(null, "status", "status", "CDATA", dependency.getModuleRevision()
+        moduleAttrs.addAttribute(null, "status", "status", "CDATA", moduleRevision
                 .getDescriptor().getStatus());
         saxHandler.startElement(null, "module", "module", moduleAttrs);
     }
diff --git a/src/java/org/apache/ivy/core/resolve/ResolveEngine.java b/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
index 92c764dab..bc43b0035 100644
--- a/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
+++ b/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
@@ -334,7 +334,8 @@ public void downloadArtifacts(
         for (int i = 0; i < dependencies.length; i++) {
             checkInterrupted();
             // download artifacts required in all asked configurations
-            if (!dependencies[i].isCompletelyEvicted() && !dependencies[i].hasProblem()) {
+            if (!dependencies[i].isCompletelyEvicted() && !dependencies[i].hasProblem()
+                    && dependencies[i].getModuleRevision() != null) {
                 DependencyResolver resolver = dependencies[i].getModuleRevision()
                         .getArtifactResolver();
                 Artifact[] selectedArtifacts = dependencies[i].getSelectedArtifacts(artifactFilter);
