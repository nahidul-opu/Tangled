From 6b47c3dec01632f2f152c272f2eed5003e3de35d Mon Sep 17 00:00:00 2001
From: Alessandro Presta <apresta@apache.org>
Date: Tue, 21 Aug 2012 18:59:22 +0000
Subject: [PATCH] GIRAPH-309: Message count is wrong. (aching via apresta)

git-svn-id: https://svn.apache.org/repos/asf/giraph/trunk@1375717 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGELOG                                                   | 2 ++
 src/main/java/org/apache/giraph/graph/BspServiceMaster.java | 6 +++---
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index bd0ff2751..9f594761a 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -2,6 +2,8 @@ Giraph Change Log
 
 Release 0.2.0 - unreleased
 
+  GIRAPH-309: Message count is wrong. (aching via apresta)
+
   GIRAPH-246: Periodic worker calls to context.progress() will prevent
   timeout on some Hadoop clusters during barrier waits. (Eli Reisman
   via aching)
diff --git a/src/main/java/org/apache/giraph/graph/BspServiceMaster.java b/src/main/java/org/apache/giraph/graph/BspServiceMaster.java
index 3179b28a3..16ae80d59 100644
--- a/src/main/java/org/apache/giraph/graph/BspServiceMaster.java
+++ b/src/main/java/org/apache/giraph/graph/BspServiceMaster.java
@@ -848,11 +848,11 @@ private GlobalStats aggregateWorkerStats(long superstep) {
                     getConfiguration());
         for (Writable writable : writableList) {
           globalStats.addPartitionStats((PartitionStats) writable);
-          globalStats.addMessageCount(
-              workerFinishedInfoObj.getLong(
-                  JSONOBJ_NUM_MESSAGES_KEY));
           allPartitionStatsList.add((PartitionStats) writable);
         }
+        globalStats.addMessageCount(
+            workerFinishedInfoObj.getLong(
+                JSONOBJ_NUM_MESSAGES_KEY));
       } catch (JSONException e) {
         throw new IllegalStateException(
             "aggregateWorkerStats: JSONException", e);
