From 566a739015f86c5d88e80420361e1b61fc888329 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sun, 8 Nov 2009 20:53:52 +0000
Subject: [PATCH] [CONFIGURATION-399] Integrated EnvironmentLookup into the
 default interpolation mechanism.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@833923 13f79535-47bb-0310-9956-ffa450edef68
---
 .../interpol/ConfigurationInterpolator.java   |  8 +++++
 ...estAbstractConfigurationBasicFeatures.java | 29 +++++++++++++++++--
 2 files changed, 35 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java b/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java
index c87e5472ac..43bd05dbeb 100644
--- a/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java
+++ b/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java
@@ -116,6 +116,13 @@ public class ConfigurationInterpolator extends StrLookup
      */
     public static final String PREFIX_CONSTANTS = "const";
 
+    /**
+     * Constant for the prefix of the standard lookup object for resolving
+     * environment properties.
+     * @since 1.7
+     */
+    public static final String PREFIX_ENVIRONMENT = "env";
+
     /** Constant for the prefix separator. */
     private static final char PREFIX_SEPARATOR = ':';
 
@@ -376,5 +383,6 @@ public ConfigurationInterpolator getParentInterpolator()
         globalLookups = new HashMap();
         globalLookups.put(PREFIX_SYSPROPERTIES, StrLookup.systemPropertiesLookup());
         globalLookups.put(PREFIX_CONSTANTS, new ConstantLookup());
+        globalLookups.put(PREFIX_ENVIRONMENT, new EnvironmentLookup());
     }
 }
diff --git a/src/test/org/apache/commons/configuration/TestAbstractConfigurationBasicFeatures.java b/src/test/org/apache/commons/configuration/TestAbstractConfigurationBasicFeatures.java
index b04f639ca3..738f9342c2 100644
--- a/src/test/org/apache/commons/configuration/TestAbstractConfigurationBasicFeatures.java
+++ b/src/test/org/apache/commons/configuration/TestAbstractConfigurationBasicFeatures.java
@@ -24,12 +24,12 @@
 import java.util.List;
 import java.util.Map;
 
+import junit.framework.TestCase;
+
 import org.apache.commons.collections.CollectionUtils;
 import org.apache.commons.configuration.event.ConfigurationEvent;
 import org.apache.commons.configuration.event.ConfigurationListener;
 
-import junit.framework.TestCase;
-
 /**
  * A test class for some of the basic functionality implemented by
  * AbstractConfiguration.
@@ -254,6 +254,31 @@ public void testAppendNull()
         ConfigurationAssert.assertEquals(setUpDestConfig(), config);
     }
 
+    /**
+     * Tests whether environment variables can be interpolated.
+     */
+    public void testInterpolateEnvironmentVariables()
+    {
+        AbstractConfiguration config = new TestConfigurationImpl(
+                new PropertiesConfiguration());
+        EnvironmentConfiguration envConfig = new EnvironmentConfiguration();
+        Map env = new HashMap();
+        for (Iterator it = envConfig.getKeys(); it.hasNext();)
+        {
+            String key = (String) it.next();
+            String propKey = "envtest." + key;
+            env.put(propKey, envConfig.getProperty(key));
+            config.addProperty(propKey, "${env:" + key + "}");
+        }
+        assertFalse("No environment properties", env.isEmpty());
+        for (Iterator it = env.entrySet().iterator(); it.hasNext();)
+        {
+            Map.Entry e = (Map.Entry) it.next();
+            assertEquals("Wrong value for " + e.getKey(), e.getValue(), config
+                    .getString((String) e.getKey()));
+        }
+    }
+
     /**
      * Creates the source configuration for testing the copy() and append()
      * methods. This configuration contains keys with an odd index and values
