From 99c953a63af4455049789e4af5a0003f12836f76 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 20 Dec 2012 23:16:22 +0000
Subject: [PATCH] FIX: Ivy generates wrong revision in URL for Maven snapshots
 (IVY-1396) (merged from trunk)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/branches/2.3.x@1424748 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/plugins/resolver/IBiblioResolver.java |  6 ++--
 .../2.0.0-SNAPSHOT/maven-metadata.xml         | 32 +++++++++++++++++++
 ...test-SNAPSHOT1-2.0.0-20070310.181613-3.jar |  1 +
 ...test-SNAPSHOT1-2.0.0-20070310.181613-3.pom | 26 +++++++++++++++
 .../apache/test-SNAPSHOT1/maven-metadata.xml  |  1 +
 6 files changed, 65 insertions(+), 2 deletions(-)
 create mode 100644 test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/maven-metadata.xml
 create mode 100644 test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.jar
 create mode 100644 test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index 5a6d146b9..70a89edc5 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -130,6 +130,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	
    2.3.x
 =====================================
+- FIX: Ivy generates wrong revision in URL for Maven snapshots (IVY-1396)
 - FIX: Maven2: resolve failure when parent has <dependencyManagement> with dependency in 'import' scope (IVY-1376)
 - FIX: IvyPublish fails when using extend tags with no explicit location attribute (IVY-1391)
 - FIX: *.lck files created by "artifact-lock" lock strategy are not cleaned up if ivy quits abruptly (IVY-1388) (thanks to Wei Chen)
diff --git a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
index 4731729bd..84058bbb1 100644
--- a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
@@ -400,14 +400,16 @@ protected ResolvedResource[] listResources(
                 for (Iterator iter = revs.iterator(); iter.hasNext();) {
                     String rev = (String) iter.next();
                     ModuleRevisionId historicalMrid = ModuleRevisionId.newInstance(mrid, rev);
+
+                    String patternForRev = pattern;
                     if (rev.endsWith("SNAPSHOT")) {
                         String snapshotVersion = findSnapshotVersion(historicalMrid);
                         if (snapshotVersion != null) {
-                            pattern = pattern.replaceFirst("\\-\\[revision\\]", "-" + snapshotVersion);
+                            patternForRev = pattern.replaceFirst("\\-\\[revision\\]", "-" + snapshotVersion);
                         }
                     }
                     String resolvedPattern = IvyPatternHelper.substitute(
-                        pattern, historicalMrid, artifact);
+                        patternForRev, historicalMrid, artifact);
                     try {
                         Resource res = repository.getResource(resolvedPattern);
                         if ((res != null) && res.exists()) {
diff --git a/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/maven-metadata.xml b/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/maven-metadata.xml
new file mode 100644
index 000000000..4e001a04c
--- /dev/null
+++ b/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/maven-metadata.xml
@@ -0,0 +1,32 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<metadata>
+  <groupId>org.apache</groupId>
+  <artifactId>test-SNAPSHOT1</artifactId>
+  <version>2.0.0-SNAPSHOT</version>
+  <versioning>
+    <snapshot>
+      <timestamp>20070310.181613</timestamp>
+
+      <buildNumber>3</buildNumber>
+    </snapshot>
+    <lastUpdated>20070310181754</lastUpdated>
+  </versioning>
+</metadata>
\ No newline at end of file
diff --git a/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.jar b/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.jar
new file mode 100644
index 000000000..56f3b36e2
--- /dev/null
+++ b/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.jar
@@ -0,0 +1 @@
+ 
diff --git a/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.pom b/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.pom
new file mode 100644
index 000000000..bf29054c3
--- /dev/null
+++ b/test/repositories/m2/org/apache/test-SNAPSHOT1/2.0.0-SNAPSHOT/test-SNAPSHOT1-2.0.0-20070310.181613-3.pom
@@ -0,0 +1,26 @@
+<?xml version="1.0"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<project>
+  <modelVersion>4.0.0</modelVersion>
+  <groupId>org.apache</groupId>
+  <artifactId>test-SNAPSHOT1</artifactId>
+  <name>Test Module for Ivy M2 parsing</name>
+  <version>2.0.0-SNAPSHOT</version>
+</project>
diff --git a/test/repositories/m2/org/apache/test-SNAPSHOT1/maven-metadata.xml b/test/repositories/m2/org/apache/test-SNAPSHOT1/maven-metadata.xml
index 852b93e90..8c33e3bff 100644
--- a/test/repositories/m2/org/apache/test-SNAPSHOT1/maven-metadata.xml
+++ b/test/repositories/m2/org/apache/test-SNAPSHOT1/maven-metadata.xml
@@ -23,6 +23,7 @@
   <version>2.0.2-SNAPSHOT</version>
   <versioning>
     <versions>
+      <version>2.0.0-SNAPSHOT</version>
       <version>2.0.2-SNAPSHOT</version>
     </versions>
 
