From 394b388fca735ad0d97cd80a54b94e6ae930e1f3 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 15 Dec 2008 22:12:54 +0000
Subject: [PATCH] FIX: NullPointerException when resolving module wihout
 revision in the pattern (IVY-980) (merged from trunk)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/branches/2.0.x@726842 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/plugins/resolver/BasicResolver.java   |  2 ++
 .../apache/ivy/core/resolve/ResolveTest.java  |  9 +++++++
 test/repositories/norev/ivy-latest.xml        | 27 +++++++++++++++++++
 test/repositories/norev/module3/module3.jar   |  1 +
 5 files changed, 40 insertions(+)
 create mode 100644 test/repositories/norev/ivy-latest.xml
 create mode 100644 test/repositories/norev/module3/module3.jar

diff --git a/CHANGES.txt b/CHANGES.txt
index a06ba8a71..0b4b19366 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -87,6 +87,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 
 - FIX: Log levels aren't respected in certain cases using the standalone functionality (IVY-960) (thanks to Patrick Woodworth)
 - FIX: NPE in LogReportOutputter (IVY-961)
+- FIX: NullPointerException when resolving module wihout revision in the pattern (IVY-980)
 
    2.0.0-rc2
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/resolver/BasicResolver.java b/src/java/org/apache/ivy/plugins/resolver/BasicResolver.java
index 43fbe45b0..02fa4b7dd 100644
--- a/src/java/org/apache/ivy/plugins/resolver/BasicResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/BasicResolver.java
@@ -454,6 +454,8 @@ private void resolveAndCheckRevision(ModuleDescriptor systemMd,
             if (!isDynamic) {
                 resolvedMrid = ModuleRevisionId.newInstance(
                     resolvedMrid, dependencyConstraint.getRevision());
+            } else if (ivyRef == null) {
+                resolvedMrid = systemMd.getMetadataArtifact().getModuleRevisionId();
             } else if (ivyRef.getRevision() == null || ivyRef.getRevision().length() == 0) {
                 resolvedMrid = ModuleRevisionId.newInstance(resolvedMrid, "working@"
                     + getName());
diff --git a/test/java/org/apache/ivy/core/resolve/ResolveTest.java b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
index 806163892..1b462d0d4 100644
--- a/test/java/org/apache/ivy/core/resolve/ResolveTest.java
+++ b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
@@ -267,6 +267,15 @@ public void testResolveNoRevisionInPattern() throws Exception {
         assertFalse(report.hasError());
     }
 
+    public void testResolveLatestWithNoRevisionInPattern() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/norev/ivysettings.xml").toURL());
+        ResolveReport report = ivy.resolve(new File("test/repositories/norev/ivy-latest.xml").toURL(),
+            getResolveOptions(new String[] {"*"}));
+        assertNotNull(report);
+        assertFalse(report.hasError());
+     }
+
     public void testResolveNoRevisionInDep() throws Exception {
         // mod1.4 depends on mod1.6, in which the ivy file has no revision
         ResolveReport report = ivy.resolve(new File(
diff --git a/test/repositories/norev/ivy-latest.xml b/test/repositories/norev/ivy-latest.xml
new file mode 100644
index 000000000..17b17c211
--- /dev/null
+++ b/test/repositories/norev/ivy-latest.xml
@@ -0,0 +1,27 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.0">
+    <info organisation="myorg" module="module1"/>
+    <configurations>
+    	<conf name="myconf"/>
+    </configurations>
+    <dependencies>
+        <dependency conf="myconf -> *" org="myorg" name="module3" rev="+" />
+	</dependencies>
+</ivy-module>
diff --git a/test/repositories/norev/module3/module3.jar b/test/repositories/norev/module3/module3.jar
new file mode 100644
index 000000000..945c9b46d
--- /dev/null
+++ b/test/repositories/norev/module3/module3.jar
@@ -0,0 +1 @@
+.
\ No newline at end of file
