From 3687d9331a0002f7735dddf93fc0bc19939bf94a Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Sun, 6 Apr 2008 22:54:49 +0000
Subject: [PATCH] NET-195 - fix incorrect double-checked locking

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/branches/NET_2_0@645323 13f79535-47bb-0310-9956-ffa450edef68
---
 .../org/apache/commons/net/ntp/NtpV3Impl.java     | 15 ++++++---------
 1 file changed, 6 insertions(+), 9 deletions(-)

diff --git a/src/main/java/org/apache/commons/net/ntp/NtpV3Impl.java b/src/main/java/org/apache/commons/net/ntp/NtpV3Impl.java
index b71c2f44c..7840bb711 100644
--- a/src/main/java/org/apache/commons/net/ntp/NtpV3Impl.java
+++ b/src/main/java/org/apache/commons/net/ntp/NtpV3Impl.java
@@ -508,15 +508,12 @@ private void setTimestamp(int index, TimeStamp t)
      *
      * @return a datagram packet.
      */
-    public DatagramPacket getDatagramPacket()
-    {
-        if (dp == null)
-            synchronized(this) {
-                if (dp == null) {
-                    dp = new DatagramPacket(buf, buf.length);
-                    dp.setPort(NTP_PORT);
-                }
-            }
+    public synchronized DatagramPacket getDatagramPacket()
+    {
+        if (dp == null) {
+            dp = new DatagramPacket(buf, buf.length);
+            dp.setPort(NTP_PORT);
+        }
         return dp;
     }
 
