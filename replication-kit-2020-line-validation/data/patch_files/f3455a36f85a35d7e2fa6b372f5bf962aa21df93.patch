From f3455a36f85a35d7e2fa6b372f5bf962aa21df93 Mon Sep 17 00:00:00 2001
From: Mark Thomas <markt@apache.org>
Date: Sun, 21 Jun 2009 16:41:18 +0000
Subject: [PATCH] =?UTF-8?q?Fix=20DBCP-288.=20When=20passivating=20a=20Dele?=
 =?UTF-8?q?gatingConnection,=20not=20all=20of=20the=20trace=20objects=20wi?=
 =?UTF-8?q?ll=20be=20statements=20so=20check=20each=20one=20before=20casti?=
 =?UTF-8?q?ng=20and=20closing.=20Based=20on=20a=20patch=20provided=20by=20?=
 =?UTF-8?q?Marc=20Kannegie=C3=9Fer?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@787049 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/dbcp/DelegatingConnection.java       | 16 ++++++++++------
 1 file changed, 10 insertions(+), 6 deletions(-)

diff --git a/src/java/org/apache/commons/dbcp/DelegatingConnection.java b/src/java/org/apache/commons/dbcp/DelegatingConnection.java
index aa7360bbd8..e4e991a84f 100644
--- a/src/java/org/apache/commons/dbcp/DelegatingConnection.java
+++ b/src/java/org/apache/commons/dbcp/DelegatingConnection.java
@@ -24,6 +24,7 @@
 import java.sql.SQLException;
 import java.sql.SQLWarning;
 import java.sql.Statement;
+import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
 /* JDBC_4_ANT_KEY_BEGIN */
@@ -410,12 +411,15 @@ protected void passivate() throws SQLException {
         try {
             // The JDBC spec requires that a Connection close any open
             // Statement's when it is closed.
-            List statements = getTrace();
-            if( statements != null) {
-                Statement[] set = new Statement[statements.size()];
-                statements.toArray(set);
-                for (int i = 0; i < set.length; i++) {
-                    set[i].close();
+            // POOL-288. Not all the traced objects will be statements
+            List traces = getTrace();
+            if(traces != null) {
+                Iterator traceIter = traces.iterator();
+                while (traceIter.hasNext()) {
+                    Object trace = traceIter.next();
+                    if (trace instanceof Statement) {
+                        ((Statement) trace).close();
+                    }
                 }
                 clearTrace();
             }
