From 8191d10c39079dedcc75a63b222026e211619b1b Mon Sep 17 00:00:00 2001
From: Mark Thomas <markt@apache.org>
Date: Sun, 2 Feb 2014 20:44:12 +0000
Subject: [PATCH] Fix DBCP-341 LocalXAConnectionFactory does not properly check
 if Xid is equal to currentXid when resuming which may result in an
 XAException. Patch by Ioannis Canellos

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1563709 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                       | 4 ++++
 .../commons/dbcp2/managed/LocalXAConnectionFactory.java       | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index f74871bcf4..bcc48787d0 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -136,6 +136,10 @@ The <action> type attribute can be add,update,fix,remove.
         DelegatingDatabaseMetaData.isWrapperFor() and
         DelegatingResultSet.isWrapperFor() that had the same problem.
       </action>
+      <action dev="markt" issue="DBCP-341" type="fix" due-to="Ioannis Canellos">
+        LocalXAConnectionFactory does not properly check if Xid is equal to
+        currentXid when resuming which may result in an XAException.
+      </action>
     </release>
     <release version="1.4.1" date="TBD" description="TBD">
       <action dev="psteitz" issue="DBCP-334" type="update" due-to="Alberto Mozzone">
diff --git a/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java b/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java
index bfbad78437..01aff3d7cf 100644
--- a/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java
+++ b/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java
@@ -139,7 +139,7 @@ public synchronized void start(Xid xid, int flag) throws XAException {
 
                 this.currentXid = xid;
             } else if (flag == XAResource.TMRESUME) {
-                if (xid != this.currentXid) {
+                if (!xid.equals(this.currentXid)) {
                     throw new XAException("Attempting to resume in different transaction: expected " + this.currentXid + ", but was " + xid);
                 }
             } else {
