From 3734d6da5deeda8ef852e0a3947ad436f98ce92f Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 8 Mar 2007 22:39:03 +0000
Subject: [PATCH] FIX: ivy.revision property not set correctly for second
 resolve (IVY-429)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@516201 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                      | 1 +
 src/java/org/apache/ivy/ant/IvyResolve.java      | 1 -
 test/java/org/apache/ivy/ant/IvyResolveTest.java | 2 ++
 test/java/org/apache/ivy/ant/ivy-double.xml      | 2 +-
 4 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index a62c16e2c..6f33bd410 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -16,6 +16,7 @@ for detailed view of each issue, please consult http://jira.jayasoft.org/
 - IMPROVE: Add a unit test to verify that latest.integration accepts released modules (IVY-394) (thanks to Gilles Scokart)
 - IMPROVE: New "modules in use" section in console report at the end of resolve (IVY-373) (thanks to John Wiliams)
 
+- FIX: ivy.revision property not set correctly for second resolve (IVY-429)
 - FIX: NPE when no organisation or no name is provided in module element of ivyconf (IVY-422)
 - FIX: FileUtil#copy(File src, File dest, CopyProgressListener l, boolean overwrite) (IVY-420)
 - FIX: ${project.groupId} and ${project.version} not processed correctly in poms (IVY-425)
diff --git a/src/java/org/apache/ivy/ant/IvyResolve.java b/src/java/org/apache/ivy/ant/IvyResolve.java
index 22778c37e..38e81a240 100644
--- a/src/java/org/apache/ivy/ant/IvyResolve.java
+++ b/src/java/org/apache/ivy/ant/IvyResolve.java
@@ -173,7 +173,6 @@ public void execute() throws BuildException {
 	            if (_file == null) {
 	                _file = new File(getProject().getBaseDir(), getProperty(settings, "ivy.dep.file"));
 	            }
-	            _revision = getProperty(_revision, settings, "ivy.revision");
 	            report = ivy.resolve(
 	                    _file.toURL(), 
 	                    getResolveOptions(confs, settings));
diff --git a/test/java/org/apache/ivy/ant/IvyResolveTest.java b/test/java/org/apache/ivy/ant/IvyResolveTest.java
index ff1a780af..cf6ee11ee 100644
--- a/test/java/org/apache/ivy/ant/IvyResolveTest.java
+++ b/test/java/org/apache/ivy/ant/IvyResolveTest.java
@@ -138,11 +138,13 @@ public void testDouble() throws Exception {
         _resolve.execute();
         
         assertEquals("resolve-simple", getIvy().getVariable("ivy.module"));
+        assertEquals("1.0", getIvy().getVariable("ivy.revision"));
 
         _resolve.setFile(new File("test/java/org/apache/ivy/ant/ivy-double.xml"));
         _resolve.execute();
         
         assertEquals("resolve-double", getIvy().getVariable("ivy.module"));
+        assertEquals("1.1", getIvy().getVariable("ivy.revision"));
     }
 
     public void testFailure() throws Exception {
diff --git a/test/java/org/apache/ivy/ant/ivy-double.xml b/test/java/org/apache/ivy/ant/ivy-double.xml
index a30ff2479..dc4678351 100644
--- a/test/java/org/apache/ivy/ant/ivy-double.xml
+++ b/test/java/org/apache/ivy/ant/ivy-double.xml
@@ -1,7 +1,7 @@
 <ivy-module version="1.0"> 
 	<info organisation="apache"
 	       module="resolve-double"
-	       revision="1.0"
+	       revision="1.1"
 	       status="release"
 	/>
 	<dependencies>
