From 621d0f57e3fdd279ef1e8e0e9beda859e9d7be74 Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Tue, 19 Sep 2017 19:59:48 +0000
Subject: [PATCH] [VFS-644] AbstractFileSystem.streamClosed() always sets
 openStream count to zero.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@1808940 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/vfs2/provider/AbstractFileSystem.java     | 11 +----------
 src/changes/changes.xml                               |  3 +++
 2 files changed, 4 insertions(+), 10 deletions(-)

diff --git a/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java b/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java
index d77f15f264..ba3d34040d 100644
--- a/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java
+++ b/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java
@@ -575,16 +575,7 @@ void streamOpened() {
     }
 
     void streamClosed() {
-        int count;
-
-        do {
-            count = openStreams.get();
-            if (count < 1) {
-                return;
-            }
-        } while (openStreams.compareAndSet(count, count - 1));
-
-        if (count == 1) {
+        if (openStreams.decrementAndGet() == 0) {
             notifyAllStreamsClosed();
         }
     }
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index ece34a88a8..44d5e2ba5b 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -89,6 +89,9 @@ The <action> type attribute can be add,update,fix,remove.
       <action issue="VFS-291" dev="ggregory" type="fix">
         ZIP archives are not properly closed after unzipping and cannot be deleted until the JVM exists.
       </action>
+      <action issue="VFS-644" dev="ggregory" type="fix">
+        AbstractFileSystem.streamClosed() always sets openStream count to zero.
+      </action>
     </release>  
     <release version="2.1" date="2016-05-19" description="New features and bug fix release.
 
