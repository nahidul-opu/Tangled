From 9ae844dbf476eba54ac52d9842cba0505c4c6666 Mon Sep 17 00:00:00 2001
From: Phil Steitz <psteitz@apache.org>
Date: Sun, 19 Jul 2015 23:15:15 +0000
Subject: [PATCH] Added null check to DelegatingConnection#closeInternal. Prior
 to this change, NPEs were being generated by ManagedConnection#close.

JIRA: DBCP-438


git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1691861 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                          |  3 +++
 .../commons/dbcp2/DelegatingConnection.java      | 10 +++++++---
 .../dbcp2/managed/TestManagedDataSource.java     | 16 ++++++++++++++++
 .../dbcp2/managed/TestManagedDataSourceInTx.java |  6 ++++++
 4 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 3ecc054551..67e81f03f0 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -61,6 +61,9 @@ The <action> type attribute can be add,update,fix,remove.
 
   <body>
     <release version="2.1.1" date="TBD" description="Bug fixes.">
+      <action issue="DBCP-438" dev="psteitz" type="fix" due-to="Raihan Kibria">
+        Nested connections in a transaction (local) throws null pointer. 
+      </action>
       <action issue="DBCP-437" dev="psteitz" type="fix">
         BasicDataSource does not set disconnectionSql properties on its PoolableConnectionFactory.
       </action>
diff --git a/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java b/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java
index bbb56dc8cf..00657379b6 100644
--- a/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java
+++ b/src/main/java/org/apache/commons/dbcp2/DelegatingConnection.java
@@ -231,9 +231,13 @@ protected final void closeInternal() throws SQLException {
         try {
             passivate();
         } finally {
-            try {
-                _conn.close();
-            } finally {
+            if (_conn != null) {
+                try {
+                    _conn.close();
+                } finally {
+                    _closed = true;
+                }
+            } else {
                 _closed = true;
             }
         }
diff --git a/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSource.java b/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSource.java
index 8ccd755987..acae0bf515 100644
--- a/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSource.java
+++ b/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSource.java
@@ -242,4 +242,20 @@ public void testManagedConnectionEqualInnermost() throws Exception {
         assertTrue(con2.innermostDelegateEquals(inner));
         assertFalse(con.equals(con2));
     }
+    
+    @Test
+    public void testNestedConnections() throws Exception {
+        transactionManager.begin();
+        
+        Connection c1 = null;
+        Connection c2 = null;
+        
+        c1 = newConnection();
+        c2 = newConnection();
+        
+        transactionManager.commit();
+        
+        c1.close();
+        c2.close();
+    }   
 }
diff --git a/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSourceInTx.java b/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSourceInTx.java
index d2d67b8727..d6726014a8 100644
--- a/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSourceInTx.java
+++ b/src/test/java/org/apache/commons/dbcp2/managed/TestManagedDataSourceInTx.java
@@ -70,6 +70,12 @@ public void testManagedConnectionEqualsFail() throws Exception {
         // two connections to the same datasource are supposed to share
         // a single connection
     }
+    
+    @Override
+    @Test
+    public void testNestedConnections() {
+        // Not supported
+    }
 
     @Override
     @Test
