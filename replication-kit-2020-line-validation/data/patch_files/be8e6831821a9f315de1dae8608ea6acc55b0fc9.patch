From be8e6831821a9f315de1dae8608ea6acc55b0fc9 Mon Sep 17 00:00:00 2001
From: Nicolas Lalevee <hibou@apache.org>
Date: Sat, 16 Jul 2011 16:08:55 +0000
Subject: [PATCH] IVY-1305:  - File descriptor leak in OSGI repo core while
 running buildobr Ant Task Thanks to Stephen Evanchik.

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1147446 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                         |  1 +
 .../ivy/osgi/repo/AbstractFSManifestIterable.java   | 13 +++++++++++--
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 57ab7d7e1..4941c440a 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -38,6 +38,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Flavio Coutinho da Costa
 	Stefan De Boey
 	Martin Eigenbrodt
+	Stephen Evanchik
 	Gregory Fernandez
 	Danno Ferrin
 	Benjamin Francisoud	
diff --git a/src/java/org/apache/ivy/osgi/repo/AbstractFSManifestIterable.java b/src/java/org/apache/ivy/osgi/repo/AbstractFSManifestIterable.java
index 26addff98..54cad7d53 100644
--- a/src/java/org/apache/ivy/osgi/repo/AbstractFSManifestIterable.java
+++ b/src/java/org/apache/ivy/osgi/repo/AbstractFSManifestIterable.java
@@ -95,8 +95,9 @@ public boolean hasNext() {
                     }
                 } else if (bundleCandidates.hasNext()) {
                     String bundleCandidate = (String) bundleCandidates.next();
+                    JarInputStream in = null;
                     try {
-                        JarInputStream in = new JarInputStream(getInputStream(bundleCandidate));
+                        in = new JarInputStream(getInputStream(bundleCandidate));
                         Manifest manifest = in.getManifest();
                         if (manifest != null) {
                             next = new ManifestAndLocation(manifest,
@@ -108,6 +109,14 @@ public boolean hasNext() {
                         Message.debug("Jar file just removed: " + bundleCandidate + " (" + e + ")");
                     } catch (IOException e) {
                         Message.warn("Unreadable jar: " + bundleCandidate + " (" + e + ")");
+                    } finally {
+                        if (in != null) {
+                            try {
+                                in.close();
+                            } catch (IOException e) {
+                                // Don't care
+                            }
+                        }
                     }
                 } else {
                     // no more candidate on the current directory
@@ -137,4 +146,4 @@ public void remove() {
             throw new UnsupportedOperationException();
         }
     }
-}
\ No newline at end of file
+}
