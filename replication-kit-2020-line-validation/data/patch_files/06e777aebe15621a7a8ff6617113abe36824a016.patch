From 06e777aebe15621a7a8ff6617113abe36824a016 Mon Sep 17 00:00:00 2001
From: Mark Thomas <markt@apache.org>
Date: Mon, 3 Feb 2014 21:55:11 +0000
Subject: [PATCH] Fix DBCP-383 Avoid NullPointerException and throw an
 XAException if an attempt is made to commit the current transaction for a
 connection when no transaction has been started.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1564084 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                              |  5 +++++
 .../dbcp2/managed/LocalXAConnectionFactory.java      | 12 ++++++++++--
 2 files changed, 15 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index fadff977ae..be178a1e31 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -152,6 +152,11 @@ The <action> type attribute can be add,update,fix,remove.
       <action dev="markt" issue="DBCP-398" type="fix">
         Clarify Jaavdoc for isClosed() method of PoolableConnection.
       </action>
+      <action dev="markt" issue="DBCP-383" type="fix">
+        Avoid NullPointerException and throw an XAException if an attempt is
+        made to commit the current transaction for a connection when no
+        transaction has been started.
+      </action>
     </release>
     <release version="1.4.1" date="TBD" description="TBD">
       <action dev="psteitz" issue="DBCP-334" type="update" due-to="Alberto Mozzone">
diff --git a/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java b/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java
index 01aff3d7cf..b56c0ab681 100644
--- a/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java
+++ b/src/main/java/org/apache/commons/dbcp2/managed/LocalXAConnectionFactory.java
@@ -203,8 +203,16 @@ public synchronized int prepare(Xid xid) {
          */
         @Override
         public synchronized void commit(Xid xid, boolean flag) throws XAException {
-            if (xid == null) throw new NullPointerException("xid is null");
-            if (!this.currentXid.equals(xid)) throw new XAException("Invalid Xid: expected " + this.currentXid + ", but was " + xid);
+            if (xid == null) {
+                throw new NullPointerException("xid is null");
+            }
+            if (this.currentXid == null) {
+                throw new XAException("There is no current transaction");
+            }
+            if (!this.currentXid.equals(xid)) {
+                throw new XAException("Invalid Xid: expected " +
+                        this.currentXid + ", but was " + xid);
+            }
 
             try {
                 // make sure the connection isn't already closed
