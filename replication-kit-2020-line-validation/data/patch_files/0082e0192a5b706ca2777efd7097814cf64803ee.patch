From 0082e0192a5b706ca2777efd7097814cf64803ee Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 27 Jul 2009 22:32:28 +0000
Subject: [PATCH] Trying to minimize the number of simultaneous open
 connections by following the guidelines mentioned in
 http://java.sun.com/j2se/1.5.0/docs/guide/net/http-keepalive.html (IVY-1105)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@798314 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/ivy/util/url/BasicURLHandler.java  | 35 ++++++++++++++++++-
 1 file changed, 34 insertions(+), 1 deletion(-)

diff --git a/src/java/org/apache/ivy/util/url/BasicURLHandler.java b/src/java/org/apache/ivy/util/url/BasicURLHandler.java
index 6c10c2ab4..c91315974 100644
--- a/src/java/org/apache/ivy/util/url/BasicURLHandler.java
+++ b/src/java/org/apache/ivy/util/url/BasicURLHandler.java
@@ -143,7 +143,7 @@ public InputStream openStream(URL url) throws IOException {
             disconnect(conn);
         }
     }
-
+    
     public void download(URL src, File dest, CopyProgressListener l) throws IOException {
         URLConnection srcConn = null;
         try {
@@ -211,6 +211,14 @@ public void upload(File source, URL dest, CopyProgressListener l) throws IOExcep
 
     private void disconnect(URLConnection con) {
         if (con instanceof HttpURLConnection) {
+            if (!"HEAD".equals(((HttpURLConnection) con).getRequestMethod())) {
+                // We must read the response body before disconnecting!
+                // Cfr. http://java.sun.com/j2se/1.5.0/docs/guide/net/http-keepalive.html
+                // [quote]Do not abandon a connection by ignoring the response body. Doing
+                // so may results in idle TCP connections.[/quote]
+                readResponseBody((HttpURLConnection) con);
+            }
+            
             ((HttpURLConnection) con).disconnect();
         } else if (con != null
                 && "sun.net.www.protocol.file.FileURLConnection".equals(con.getClass().getName())) {
@@ -227,4 +235,29 @@ private void disconnect(URLConnection con) {
         }
     }
 
+    private void readResponseBody(HttpURLConnection conn) {
+        byte[] buffer = new byte[BUFFER_SIZE];
+        
+        try {
+            InputStream inStream = conn.getInputStream();
+            while (inStream.read(buffer) > 0) {
+            }
+            inStream.close();
+        } catch (IOException e) {
+            // ignore
+        }
+        
+        InputStream errStream = ((HttpURLConnection) conn).getErrorStream();
+        if (errStream != null) {
+            try {
+                while (errStream.read(buffer) > 0) {
+                }
+                errStream.close();
+            } catch (IOException e) {
+                // ignore
+            }
+        }
+    }
+
+
 }
