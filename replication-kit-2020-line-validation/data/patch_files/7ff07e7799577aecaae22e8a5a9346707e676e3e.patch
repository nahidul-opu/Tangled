From 7ff07e7799577aecaae22e8a5a9346707e676e3e Mon Sep 17 00:00:00 2001
From: Benedikt Ritter <britter@apache.org>
Date: Mon, 7 Jul 2014 19:54:07 +0000
Subject: [PATCH] VALIDATOR-273: EmailValidator does not support mailboxes at
 TLDs. Thanks to Chris Lee

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1608584 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                              |  3 +++
 .../commons/validator/routines/EmailValidator.java   |  3 ++-
 .../java/org/apache/commons/validator/EmailTest.java | 12 ++++++++++++
 3 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index cd1b1c026..435d2eec6 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -43,6 +43,9 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
 
   <release version="1.4.1" date="TBA" description="TBA">
+    <action dev="britter" type="fix" issue="VALIDATOR-273" due-to="Chris Lee" >
+      EmailValidator does not support mailboxes at TLDs
+    </action>
     <action dev="britter" type="fix" issue="VALIDATOR-317" due-to="ArÅ«nas Bendoraitis" >
       DomainValidator missing sTLD - "xxx"
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
index 6db711a52..d41c26ae7 100644
--- a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
+++ b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
@@ -160,7 +160,8 @@ protected boolean isValidDomain(String domain) {
             // Domain is symbolic name
             DomainValidator domainValidator =
                     DomainValidator.getInstance(allowLocal);
-            return domainValidator.isValid(domain);
+            return domainValidator.isValid(domain) ||
+                    domainValidator.isValidTld(domain);
         }
     }
 
diff --git a/src/test/java/org/apache/commons/validator/EmailTest.java b/src/test/java/org/apache/commons/validator/EmailTest.java
index 3ee3a0e73..09de92edf 100644
--- a/src/test/java/org/apache/commons/validator/EmailTest.java
+++ b/src/test/java/org/apache/commons/validator/EmailTest.java
@@ -210,6 +210,18 @@ public void testEmailWithControlChars() {
         assertFalse("Test control char 127", validator.isValid("foo" + ((char)127) + "bar@domain.com"));
     }
 
+   /**
+    * Tests the e-mail validation with a user at a TLD
+    */
+   public void testEmailAtTLD() throws ValidatorException {
+      // Create bean to run test on.
+      ValueBean info = new ValueBean();
+
+      info.setValue("m@de");
+      valueTest(info, true);
+
+   }
+
     /**
      * Test that @localhost and @localhost.localdomain
      *  addresses aren't declared valid by default 
