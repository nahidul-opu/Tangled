From df0b3837f1118d1b97a802da85a6984f1ca223c5 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sat, 16 Mar 2013 17:46:31 +0000
Subject: [PATCH] [CONFIGURATION-525] PropertiesConfiguration now supports a
 footer comment.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@1457277 13f79535-47bb-0310-9956-ffa450edef68
---
 .../PropertiesConfiguration.java              | 24 ++++++
 .../PropertiesConfigurationLayout.java        | 80 ++++++++++++++++---
 .../TestPropertiesConfiguration.java          | 33 ++++++++
 .../TestPropertiesConfigurationLayout.java    |  8 +-
 src/test/resources/test.properties            |  2 +
 5 files changed, 134 insertions(+), 13 deletions(-)

diff --git a/src/main/java/org/apache/commons/configuration/PropertiesConfiguration.java b/src/main/java/org/apache/commons/configuration/PropertiesConfiguration.java
index 0994f67987..79e2482bc2 100644
--- a/src/main/java/org/apache/commons/configuration/PropertiesConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration/PropertiesConfiguration.java
@@ -352,6 +352,30 @@ public void setHeader(String header)
         getLayout().setHeaderComment(header);
     }
 
+    /**
+     * Returns the footer comment. This is a comment at the very end of the
+     * file.
+     *
+     * @return the footer comment
+     * @since 2.0
+     */
+    public String getFooter()
+    {
+        return getLayout().getFooterComment();
+    }
+
+    /**
+     * Sets the footer comment. If set, this comment is written after all
+     * properties at the end of the file.
+     *
+     * @param footer the footer comment
+     * @since 2.0
+     */
+    public void setFooter(String footer)
+    {
+        getLayout().setFooterComment(footer);
+    }
+
     /**
      * Returns the encoding to be used when loading or storing configuration
      * data. This implementation ensures that the default encoding will be used
diff --git a/src/main/java/org/apache/commons/configuration/PropertiesConfigurationLayout.java b/src/main/java/org/apache/commons/configuration/PropertiesConfigurationLayout.java
index 5d33c56792..b3f5f125f2 100644
--- a/src/main/java/org/apache/commons/configuration/PropertiesConfigurationLayout.java
+++ b/src/main/java/org/apache/commons/configuration/PropertiesConfigurationLayout.java
@@ -131,6 +131,9 @@ public class PropertiesConfigurationLayout implements ConfigurationListener
     /** Stores the header comment. */
     private String headerComment;
 
+    /** Stores the footer comment. */
+    private String footerComment;
+
     /** The global separator that will be used for all properties. */
     private String globalSeparator;
 
@@ -206,15 +209,7 @@ public PropertiesConfiguration getConfiguration()
      */
     public String getCanonicalComment(String key, boolean commentChar)
     {
-        String comment = getComment(key);
-        if (comment == null)
-        {
-            return null;
-        }
-        else
-        {
-            return trimComment(comment, commentChar);
-        }
+        return constructCanonicalComment(getComment(key), commentChar);
     }
 
     /**
@@ -283,8 +278,7 @@ public void setBlancLinesBefore(String key, int number)
      */
     public String getCanonicalHeaderComment(boolean commentChar)
     {
-        return (getHeaderComment() == null) ? null : trimComment(
-                getHeaderComment(), commentChar);
+        return constructCanonicalComment(getHeaderComment(), commentChar);
     }
 
     /**
@@ -311,6 +305,47 @@ public void setHeaderComment(String comment)
         headerComment = comment;
     }
 
+    /**
+     * Returns the footer comment of the represented properties file in a
+     * canonical form. This method works like
+     * {@code getCanonicalHeaderComment()}, but reads the footer comment.
+     *
+     * @param commentChar determines the presence of comment characters
+     * @return the footer comment (can be <b>null</b>)
+     * @see #getCanonicalHeaderComment(boolean)
+     * @since 2.0
+     */
+    public String getCanonicalFooterCooment(boolean commentChar)
+    {
+        return constructCanonicalComment(getFooterComment(), commentChar);
+    }
+
+    /**
+     * Returns the footer comment of the represented properties file. This
+     * method returns the footer comment exactly as it was set using
+     * {@code setFooterComment()} or extracted from the loaded properties
+     * file.
+     *
+     * @return the footer comment (can be <b>null</b>)
+     * @since 2.0
+     */
+    public String getFooterComment()
+    {
+        return footerComment;
+    }
+
+    /**
+     * Sets the footer comment for the represented properties file. This comment
+     * will be output at the bottom of the file.
+     *
+     * @param footerComment the footer comment
+     * @since 2.0
+     */
+    public void setFooterComment(String footerComment)
+    {
+        this.footerComment = footerComment;
+    }
+
     /**
      * Returns a flag whether the specified property is defined on a single
      * line. This is meaningful only if this property has multiple values.
@@ -512,6 +547,9 @@ public void load(Reader in) throws ConfigurationException
                     }
                 }
             }
+
+            setFooterComment(extractComment(reader.getCommentLines(), 0, reader
+                    .getCommentLines().size() - 1));
         }
         catch (IOException ioex)
         {
@@ -575,6 +613,8 @@ public void save(Writer out) throws ConfigurationException
                             key), singleLine);
                 }
             }
+
+            writeComment(writer, getCanonicalFooterCooment(true));
             writer.flush();
         }
         catch (IOException ioex)
@@ -821,6 +861,9 @@ private void copyFrom(PropertiesConfigurationLayout c)
             PropertyLayoutData data = c.layoutData.get(key);
             layoutData.put(key, data.clone());
         }
+
+        setHeaderComment(c.getHeaderComment());
+        setFooterComment(c.getFooterComment());
     }
 
     /**
@@ -842,6 +885,21 @@ private static void writeComment(
         }
     }
 
+    /**
+     * Helper method for generating a comment string. Depending on the boolean
+     * argument the resulting string either has no comment characters or a
+     * leading comment character at each line.
+     *
+     * @param comment the comment string to be processed
+     * @param commentChar determines the presence of comment characters
+     * @return the canonical comment string (can be <b>null</b>)
+     */
+    private static String constructCanonicalComment(String comment,
+            boolean commentChar)
+    {
+        return (comment == null) ? null : trimComment(comment, commentChar);
+    }
+
     /**
      * A helper class for storing all layout related information for a
      * configuration property.
diff --git a/src/test/java/org/apache/commons/configuration/TestPropertiesConfiguration.java b/src/test/java/org/apache/commons/configuration/TestPropertiesConfiguration.java
index 0cf6873220..bd3fefb87f 100644
--- a/src/test/java/org/apache/commons/configuration/TestPropertiesConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration/TestPropertiesConfiguration.java
@@ -68,6 +68,9 @@ public class TestPropertiesConfiguration
     /** Constant for a test property value.*/
     private static final String PROP_VALUE = "value";
 
+    /** Constant for the line break character. */
+    private static final String CR = System.getProperty("line.separator");
+
     /** The configuration to be tested.*/
     private PropertiesConfiguration conf;
 
@@ -1077,6 +1080,36 @@ public void testSetPropertyListWithDelimiterParsingDisabled()
         assertEquals("Wrong list property", list, conf.getProperty(prop));
     }
 
+    /**
+     * Tests whether a footer comment is correctly read.
+     */
+    @Test
+    public void testReadFooterComment()
+    {
+        assertEquals("Wrong footer comment", "\n# This is a foot comment\n",
+                conf.getFooter());
+        assertEquals("Wrong footer comment from layout",
+                "\nThis is a foot comment\n", conf.getLayout()
+                        .getCanonicalFooterCooment(false));
+    }
+
+    /**
+     * Tests whether a footer comment is correctly written out.
+     */
+    @Test
+    public void testWriteFooterComment() throws ConfigurationException,
+            IOException
+    {
+        final String footer = "my footer";
+        conf.clear();
+        conf.setProperty(PROP_NAME, PROP_VALUE);
+        conf.setFooter(footer);
+        StringWriter out = new StringWriter();
+        conf.write(out);
+        assertEquals("Wrong result", PROP_NAME + " = " + PROP_VALUE + CR + "# "
+                + footer + CR, out.toString());
+    }
+
     /**
      * Helper method for testing the content of a list with elements that
      * contain backslashes.
diff --git a/src/test/java/org/apache/commons/configuration/TestPropertiesConfigurationLayout.java b/src/test/java/org/apache/commons/configuration/TestPropertiesConfigurationLayout.java
index bb2a8d25c9..11026fcad7 100644
--- a/src/test/java/org/apache/commons/configuration/TestPropertiesConfigurationLayout.java
+++ b/src/test/java/org/apache/commons/configuration/TestPropertiesConfigurationLayout.java
@@ -601,11 +601,14 @@ public void testInitCopy()
                 config, layout);
         assertEquals("Wrong number of keys", layout.getKeys().size(), l2
                 .getKeys().size());
-        for (Iterator<String> it = layout.getKeys().iterator(); it.hasNext();)
+        for (String key : layout.getKeys())
         {
-            Object key = it.next();
             assertTrue("Key was not found: " + key, l2.getKeys().contains(key));
         }
+        assertEquals("Wrong header comment", layout.getHeaderComment(),
+                l2.getHeaderComment());
+        assertEquals("Wrong footer comment", layout.getFooterComment(),
+                l2.getFooterComment());
     }
 
     /**
@@ -699,6 +702,7 @@ private void fillLayout()
         builder.addComment(TEST_COMMENT);
         builder.addProperty(TEST_KEY, TEST_VALUE);
         builder.addProperty("anotherProp", "anotherValue");
+        builder.addComment("A footer comment");
         try
         {
             layout.load(builder.getReader());
diff --git a/src/test/resources/test.properties b/src/test/resources/test.properties
index f578df6ef9..491742fa9a 100644
--- a/src/test/resources/test.properties
+++ b/src/test/resources/test.properties
@@ -122,3 +122,5 @@ test.share2 = \\\\share2a
 test.share2 = \\\\share2b
 test.share3 = \\\\\\\\share3a\\\\\\\\,\\\\\\\\share3b\\
 
+# This is a foot comment
+
