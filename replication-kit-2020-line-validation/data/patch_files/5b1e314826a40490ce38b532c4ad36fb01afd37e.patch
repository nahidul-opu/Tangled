From 5b1e314826a40490ce38b532c4ad36fb01afd37e Mon Sep 17 00:00:00 2001
From: Thomas Vandahl <tv@apache.org>
Date: Wed, 1 Apr 2015 15:18:51 +0000
Subject: [PATCH] Fix JCS-144: BlockDiskCache hangs on SEVERE: Region [TMS]
 Failure getting from disk--IOException

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/jcs/trunk@1670668 13f79535-47bb-0310-9956-ffa450edef68
---
 .../auxiliary/disk/block/BlockDiskCache.java  | 21 ++++++++++---------
 1 file changed, 11 insertions(+), 10 deletions(-)

diff --git a/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCache.java b/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCache.java
index 865ed2fdf..26c7a4839 100644
--- a/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCache.java
+++ b/commons-jcs-core/src/main/java/org/apache/commons/jcs/auxiliary/disk/block/BlockDiskCache.java
@@ -327,15 +327,21 @@ protected ICacheElement<K, V> processGet( K key )
         }
 
         ICacheElement<K, V> object = null;
-        storageLock.readLock().lock();
+
 
         try
         {
-            int[] ded = this.keyStore.get( key );
-            if ( ded != null )
-            {
-                object = this.dataFile.read( ded );
+            storageLock.readLock().lock();
+            try {
+                int[] ded = this.keyStore.get( key );
+                if ( ded != null )
+                {
+                    object = this.dataFile.read( ded );
+                }
+            } finally {
+                storageLock.readLock().unlock();
             }
+
         }
         catch ( IOException ioe )
         {
@@ -346,11 +352,6 @@ protected ICacheElement<K, V> processGet( K key )
         {
             log.error( logCacheName + "Failure getting from disk, key = " + key, e );
         }
-        finally
-        {
-            storageLock.readLock().unlock();
-        }
-
         return object;
     }
 
