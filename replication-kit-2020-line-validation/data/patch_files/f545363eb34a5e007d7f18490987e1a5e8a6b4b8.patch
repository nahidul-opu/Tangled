From f545363eb34a5e007d7f18490987e1a5e8a6b4b8 Mon Sep 17 00:00:00 2001
From: Ferdy Galema <ferdy@apache.org>
Date: Mon, 9 Jul 2012 13:11:05 +0000
Subject: [PATCH] GORA-147 fix threading issue caused by multiple threads
 trying to flush

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1359146 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                | 2 ++
 .../org/apache/gora/hbase/store/HBaseTableConnection.java  | 7 ++++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 970c63489..89afe592d 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -6,6 +6,8 @@ Gora Change Log
 
 0.3 (trunk) Current Development:
 
+* GORA-147 fix threading issue caused by multiple threads trying to flush (ferdy)
+
 * GORA-146 HBaseStore does not properly set endkey (ferdy)
 
 * GORA-140 Requires some adjustments on dependency at gora-cassandra (kazk, lewismc)
diff --git a/gora-hbase/src/main/java/org/apache/gora/hbase/store/HBaseTableConnection.java b/gora-hbase/src/main/java/org/apache/gora/hbase/store/HBaseTableConnection.java
index 800dc69e2..1e1a7bc0f 100644
--- a/gora-hbase/src/main/java/org/apache/gora/hbase/store/HBaseTableConnection.java
+++ b/gora-hbase/src/main/java/org/apache/gora/hbase/store/HBaseTableConnection.java
@@ -78,7 +78,12 @@ public HBaseTableConnection(Configuration conf, String tableName,
   private HTable getTable() throws IOException {
     HTable table = tables.get();
     if (table == null) {
-      table = new HTable(conf, tableName);
+      table = new HTable(conf, tableName) {
+        @Override
+        public synchronized void flushCommits() throws IOException {
+          super.flushCommits();
+        }
+      };
       table.setAutoFlush(autoflush);
       pool.add(table); //keep track
       tables.set(table);
