From 0d744de2743b78cfd8481908a5736063ce23fe86 Mon Sep 17 00:00:00 2001
From: Emmanuel Bourg <ebourg@apache.org>
Date: Mon, 18 Feb 2008 12:37:19 +0000
Subject: [PATCH] Fixed the date format for XMLPropertyListConfiguration
 (CONFIGURATION-260)

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@628705 13f79535-47bb-0310-9956-ffa450edef68
---
 conf/test.plist.xml                           |  5 ++-
 .../plist/PropertyListConfiguration.java      |  2 +-
 .../plist/XMLPropertyListConfiguration.java   | 43 +++++++++++++++----
 .../TestXMLPropertyListConfiguration.java     | 15 +++++++
 xdocs/changes.xml                             |  3 ++
 5 files changed, 58 insertions(+), 10 deletions(-)

diff --git a/conf/test.plist.xml b/conf/test.plist.xml
index 867ca89fca..0dfb57fb91 100644
--- a/conf/test.plist.xml
+++ b/conf/test.plist.xml
@@ -19,7 +19,10 @@
         <false/>
 
         <key>date</key>
-        <date>2005-01-01T12:00:00-0700</date>
+        <date>2005-01-01T12:00:00Z</date>
+
+        <key>date-gnustep</key>
+        <date>2002-03-22 11:30:00 +0100</date>
 
         <key>data</key>
         <data>RHJhY28gRG9ybWllbnMgTnVucXVhbSBUaXRpbGxhbmR1cw==</data>
diff --git a/src/java/org/apache/commons/configuration/plist/PropertyListConfiguration.java b/src/java/org/apache/commons/configuration/plist/PropertyListConfiguration.java
index cde29a0fb2..fb5e0017fe 100644
--- a/src/java/org/apache/commons/configuration/plist/PropertyListConfiguration.java
+++ b/src/java/org/apache/commons/configuration/plist/PropertyListConfiguration.java
@@ -40,7 +40,7 @@
 
 /**
  * NeXT / OpenStep style configuration. This configuration can read and write
- * ASCII plist files. It support the GNUStep extension to specify date objects.
+ * ASCII plist files. It supports the GNUStep extension to specify date objects.
  * <p>
  * References:
  * <ul>
diff --git a/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java b/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java
index dfe79765f4..efeedc5790 100644
--- a/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java
+++ b/src/java/org/apache/commons/configuration/plist/XMLPropertyListConfiguration.java
@@ -28,10 +28,12 @@
 import java.text.SimpleDateFormat;
 import java.util.ArrayList;
 import java.util.Calendar;
+import java.util.Collection;
 import java.util.Date;
 import java.util.Iterator;
 import java.util.List;
 import java.util.Map;
+import java.util.TimeZone;
 import javax.xml.parsers.SAXParser;
 import javax.xml.parsers.SAXParserFactory;
 
@@ -73,7 +75,7 @@
  *         &lt;true/>
  *
  *         &lt;key>date&lt;/key>
- *         &lt;date>2005-01-01T12:00:00-0700&lt;/date>
+ *         &lt;date>2005-01-01T12:00:00Z&lt;/date>
  *
  *         &lt;key>data&lt;/key>
  *         &lt;data>RHJhY28gRG9ybWllbnMgTnVucXVhbSBUaXRpbGxhbmR1cw==&lt;/data>
@@ -317,7 +319,10 @@ private void printValue(PrintWriter out, int indentLevel, Object value)
 
         if (value instanceof Date)
         {
-            out.println(padding + "<date>" + PListNode.format.format((Date) value) + "</date>");
+            synchronized (PListNode.format)
+            {
+                out.println(padding + "<date>" + PListNode.format.format((Date) value) + "</date>");
+            }
         }
         else if (value instanceof Calendar)
         {
@@ -557,8 +562,15 @@ public static class PListNode extends Node
          */
         private static final long serialVersionUID = -7614060264754798317L;
 
-        /** The standard format of dates in plist files. */
-        private static DateFormat format = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssZ");
+        /** The MacOS format of dates in plist files. */
+        private static DateFormat format = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'");
+        static
+        {
+            format.setTimeZone(TimeZone.getTimeZone("UTC"));
+        }
+
+        /** The GNUstep format of dates in plist files. */
+        private static DateFormat gnustepFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss Z");
 
         /**
          * Update the value of the node. If the existing value is null, it's
@@ -574,10 +586,10 @@ public void addValue(Object value)
             {
                 setValue(value);
             }
-            else if (getValue() instanceof List)
+            else if (getValue() instanceof Collection)
             {
-                List list = (List) getValue();
-                list.add(value);
+                Collection collection = (Collection) getValue();
+                collection.add(value);
             }
             else
             {
@@ -597,7 +609,22 @@ public void addDateValue(String value)
         {
             try
             {
-                addValue(format.parse(value));
+                if (value.indexOf(' ') != -1)
+                {
+                    // parse the date using the GNUstep format
+                    synchronized (gnustepFormat)
+                    {
+                        addValue(gnustepFormat.parse(value));
+                    }
+                }
+                else
+                {
+                    // parse the date using the MacOS X format
+                    synchronized (format)
+                    {
+                        addValue(format.parse(value));
+                    }
+                }
             }
             catch (ParseException e)
             {
diff --git a/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java b/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java
index 98dff92434..338624456b 100644
--- a/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java
+++ b/src/test/org/apache/commons/configuration/plist/TestXMLPropertyListConfiguration.java
@@ -73,6 +73,21 @@ public void testDictionary()
         assertEquals("3rd element", "value3", config.getProperty("dictionary.key3"));
     }
 
+    public void testDate() throws Exception
+    {
+        Calendar calendar = Calendar.getInstance();
+        calendar.clear();
+        calendar.setTimeZone(TimeZone.getTimeZone("UTC"));
+        calendar.set(2005, Calendar.JANUARY, 1, 12, 0, 0);
+
+        assertEquals("'date' property", calendar.getTime(), config.getProperty("date"));
+
+        calendar.setTimeZone(TimeZone.getTimeZone("CET"));
+        calendar.set(2002, Calendar.MARCH, 22, 11, 30, 0);
+
+        assertEquals("'date-gnustep' property", calendar.getTime(), config.getProperty("date-gnustep"));
+    }
+
     public void testSubset()
     {
         Configuration subset = config.subset("dictionary");
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index b9c2af5f82..bfb19d2437 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -44,6 +44,9 @@
         It's now possible to read a configuration file containing
         a '#' in its name (requires Java 1.4 or above).
       </action>
+      <action dev="ebourg" type="fix" issue="CONFIGURATION-260">
+        Fixed the date format for XMLPropertyListConfiguration.
+      </action>
     </release>
 
     <release version="1.5" date="2007-11-24" description="Many smaller bugfixes">
