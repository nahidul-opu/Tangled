From 6683216e612474b605a5bfb7fa684352528ab784 Mon Sep 17 00:00:00 2001
From: Thomas Neidhart <tn@apache.org>
Date: Thu, 17 Oct 2013 21:12:28 +0000
Subject: [PATCH] [MATH-1029] Make overflow check symmetric for
 positive/negative values.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/math/trunk@1533260 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                            |  5 +++++
 .../apache/commons/math3/fraction/BigFraction.java |  3 ++-
 .../commons/math3/fraction/BigFractionTest.java    | 14 +++++++++++++-
 3 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 046b44ba85..eb1bb735de 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -51,6 +51,11 @@ If the output is not quite correct, check for invisible trailing spaces!
   </properties>
   <body>
     <release version="x.y" date="TBD" description="TBD">
+      <action dev="tn" type="fix" issue="MATH-1029">
+        The "BigFraction" constructor will throw a "FractionConversionException"
+        also in case negative values are provided which exceed the allowed range
+        (+/- Integer.MAX_VALUE).
+      </action>
       <action dev="erans" type="add" issue="MATH-1041" due-to="Sean Owen">
         "Pair": added factory method and "toString" method.
       </action>
diff --git a/src/main/java/org/apache/commons/math3/fraction/BigFraction.java b/src/main/java/org/apache/commons/math3/fraction/BigFraction.java
index 4ca33eb044..338464a9b8 100644
--- a/src/main/java/org/apache/commons/math3/fraction/BigFraction.java
+++ b/src/main/java/org/apache/commons/math3/fraction/BigFraction.java
@@ -272,7 +272,8 @@ private BigFraction(final double value, final double epsilon,
         long overflow = Integer.MAX_VALUE;
         double r0 = value;
         long a0 = (long) FastMath.floor(r0);
-        if (a0 > overflow) {
+
+        if (FastMath.abs(a0) > overflow) {
             throw new FractionConversionException(value, a0, 1l);
         }
 
diff --git a/src/test/java/org/apache/commons/math3/fraction/BigFractionTest.java b/src/test/java/org/apache/commons/math3/fraction/BigFractionTest.java
index 71efb97bac..229da69302 100644
--- a/src/test/java/org/apache/commons/math3/fraction/BigFractionTest.java
+++ b/src/test/java/org/apache/commons/math3/fraction/BigFractionTest.java
@@ -156,7 +156,19 @@ public void testDigitLimitConstructor() throws ConvergenceException {
         assertFraction(769, 1250, new BigFraction(0.6152, 9999));
         
         // MATH-996
-        assertFraction(1, 2, new BigFraction(0.5000000001, 10));
+        assertFraction(1, 2, new BigFraction(0.5000000001, 10));        
+    }
+
+    // MATH-1029
+    @Test(expected=FractionConversionException.class)
+    public void testPositiveValueOverflow() {
+        assertFraction((long) 1e10, 1, new BigFraction(1e10, 1000));
+    }
+
+    // MATH-1029
+    @Test(expected=FractionConversionException.class)
+    public void testNegativeValueOverflow() {
+        assertFraction((long) -1e10, 1, new BigFraction(-1e10, 1000));
     }
 
     @Test
