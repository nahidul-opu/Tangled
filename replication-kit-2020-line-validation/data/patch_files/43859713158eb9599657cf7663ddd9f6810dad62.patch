From 43859713158eb9599657cf7663ddd9f6810dad62 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Fri, 12 Apr 2013 20:24:46 +0000
Subject: [PATCH] [CONFIGURATION-524] BaseHierarchicalConfiguration.clone() now
 ensures that the configuration's interpolator is cloned, too.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@1467446 13f79535-47bb-0310-9956-ffa450edef68
---
 .../BaseHierarchicalConfiguration.java        |  1 +
 .../TestHierarchicalConfiguration.java        | 19 +++++++++++++++++++
 2 files changed, 20 insertions(+)

diff --git a/src/main/java/org/apache/commons/configuration/BaseHierarchicalConfiguration.java b/src/main/java/org/apache/commons/configuration/BaseHierarchicalConfiguration.java
index ab16c91ddf..b0d20e3c91 100644
--- a/src/main/java/org/apache/commons/configuration/BaseHierarchicalConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration/BaseHierarchicalConfiguration.java
@@ -940,6 +940,7 @@ public Object clone()
             CloneVisitor v = new CloneVisitor();
             getRootNode().visit(v);
             copy.setRootNode(v.getClone());
+            copy.cloneInterpolator(this);
 
             return copy;
         }
diff --git a/src/test/java/org/apache/commons/configuration/TestHierarchicalConfiguration.java b/src/test/java/org/apache/commons/configuration/TestHierarchicalConfiguration.java
index cd24ec71d3..ed9db58822 100644
--- a/src/test/java/org/apache/commons/configuration/TestHierarchicalConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration/TestHierarchicalConfiguration.java
@@ -742,6 +742,25 @@ public void configurationChanged(ConfigurationEvent event)
                 .getConfigurationListeners().isEmpty());
     }
 
+    /**
+     * Tests whether interpolation works as expected after cloning.
+     */
+    @Test
+    public void testCloneInterpolation()
+    {
+        final String keyAnswer = "answer";
+        final String keyValue = "value";
+        config.addProperty(keyAnswer, "The answer is ${" + keyValue + "}.");
+        config.addProperty(keyValue, 42);
+        BaseHierarchicalConfiguration clone =
+                (BaseHierarchicalConfiguration) config.clone();
+        clone.setProperty(keyValue, 43);
+        assertEquals("Wrong interpolation in original", "The answer is 42.",
+                config.getString(keyAnswer));
+        assertEquals("Wrong interpolation in clone", "The answer is 43.",
+                clone.getString(keyAnswer));
+    }
+
     @Test
     public void testAddNodes()
     {
