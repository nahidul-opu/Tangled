From 1662de3263f7c947e83058681c34002f1215b99d Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 22 Mar 2010 21:24:51 +0000
Subject: [PATCH] FIX: Can't deal with [VERSION] version pattern from Maven
 (IVY-1177) (thanks to Richard Vowles)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@926346 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                        |  2 ++
 .../ivy/core/module/id/ModuleRevisionId.java       | 14 +++++++++++++-
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index ce45405e9..0e2cf54f0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -93,6 +93,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Johan Stuyts
 	Jason Trump
 	Tjeerd Verhagen
+	Richard Vowles
 	Sven Walter
 	James P. White
 	Tom Widmer
@@ -116,6 +117,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Trace a message when a property file referenced from the settings doesn't exixts (IVY-1074)
 - IMPROVEMENT: use defaultconf in combination with defaultconfmapping (IVY-1135) (thanks to Jon Schneider)
 
+- FIX: Can't deal with [VERSION] version pattern from Maven (IVY-1177) (thanks to Richard Vowles)
 - FIX: verbose/debug messages were not logged while running ivy:configure task
 - FIX: ApacheURLLister does not allow directories not containing a dot on Artifactory (IVY-1175) (thanks to Anders Jacobsson)
 - FIX: artifact-lock strategy could hang Ivy when resolving dynamic revisions
diff --git a/src/java/org/apache/ivy/core/module/id/ModuleRevisionId.java b/src/java/org/apache/ivy/core/module/id/ModuleRevisionId.java
index 8707b31c9..d94bf883a 100644
--- a/src/java/org/apache/ivy/core/module/id/ModuleRevisionId.java
+++ b/src/java/org/apache/ivy/core/module/id/ModuleRevisionId.java
@@ -210,7 +210,7 @@ private ModuleRevisionId(ModuleId moduleId, String branch, String revision,
             // just to get the default branch
             ? (context.peekIvy() == null ? null : context.getSettings().getDefaultBranch(moduleId)) 
             : branch;
-        this.revision = revision == null ? Ivy.getWorkingRevision() : revision;
+        this.revision = revision == null ? Ivy.getWorkingRevision() : normalizeRevision(revision);
         setStandardAttribute(IvyPatternHelper.ORGANISATION_KEY, this.moduleId.getOrganisation());
         setStandardAttribute(IvyPatternHelper.MODULE_KEY, this.moduleId.getName());
         setStandardAttribute(IvyPatternHelper.BRANCH_KEY, this.branch);
@@ -337,4 +337,16 @@ public static ModuleRevisionId decode(String encoded) {
     public String getBranch() {
         return branch;
     }
+    
+    /**
+     * [revision] is a valid revision in maven. This method strips the '[' and ']'
+     * characters. Cfr. http://docs.codehaus.org/x/IGU
+     */
+    private static String normalizeRevision(String revision) {
+        if (revision.startsWith("[") && revision.endsWith("]") && revision.indexOf(',') == -1 ) {
+            return revision.substring(1, revision.length() - 1);
+        } else {
+            return revision;
+        }
+    }
 }
