From c11f829b8e5468221983ae63b7090e50d6120339 Mon Sep 17 00:00:00 2001
From: Rahul Akolkar <rahul@apache.org>
Date: Fri, 21 Nov 2008 16:38:50 +0000
Subject: [PATCH] event attribute of <send> is not evaluated SCXML-90

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/scxml/trunk@719632 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                               | 10 ++++++++--
 .../org/apache/commons/scxml/model/Send.java    | 17 +++++++++++++----
 .../commons/scxml/env/jexl/eventdata-03.xml     |  2 +-
 .../commons/scxml/env/jexl/eventdata-04.xml     |  2 +-
 .../apache/commons/scxml/env/jexl/wizard-02.xml |  2 +-
 .../apache/commons/scxml/invoke/invoked-02.xml  |  2 +-
 .../java/org/apache/commons/scxml/send-02.xml   | 14 +++++++-------
 7 files changed, 32 insertions(+), 17 deletions(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index 49f28b0bf..9bad59fd4 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -23,8 +23,14 @@ $Id$
 INTRODUCTION:
 
 Commons SCXML 0.9 is a minor release containing a few enhancements and
-bug fixes. See about section at the end for general information on
-Commons SCXML.
+bug fixes. Changes to SCXML documents may be necessary before upgrading
+from 0.8, see detailed changes list below. See about section at the end
+for general information on Commons SCXML.
+
+BREAKING CHANGES:
+
+ o The "event" attribute of the <send> element is now correctly evaluated
+   as an expression, rather than a String.
 
 NEW FEATURES:
 
diff --git a/src/main/java/org/apache/commons/scxml/model/Send.java b/src/main/java/org/apache/commons/scxml/model/Send.java
index 51691cc19..864650ee4 100644
--- a/src/main/java/org/apache/commons/scxml/model/Send.java
+++ b/src/main/java/org/apache/commons/scxml/model/Send.java
@@ -324,6 +324,15 @@ public void execute(final EventDispatcher evtDispatcher,
                 wait = parseDelay(delayString, appLog);
             }
         }
+        String eventValue = event;
+        if (!SCXMLHelper.isStringEmpty(event)) {
+            eventValue = (String) eval.eval(ctx, event);
+            if (SCXMLHelper.isStringEmpty(eventValue)
+                    && appLog.isWarnEnabled()) {
+                appLog.warn("<send>: event expression \"" + event
+                    + "\" evaluated to null or empty String");
+            }
+        }
         // Lets see if we should handle it ourselves
         if (targettypeValue != null
               && targettypeValue.trim().equalsIgnoreCase(TARGETTYPE_SCXML)) {
@@ -331,10 +340,10 @@ public void execute(final EventDispatcher evtDispatcher,
                 // TODO: Remove both short-circuit passes in v1.0
                 if (wait == 0L) {
                     if (appLog.isDebugEnabled()) {
-                        appLog.debug("<send>: Enqueued event '" + event
+                        appLog.debug("<send>: Enqueued event '" + eventValue
                             + "' with no delay");
                     }
-                    derivedEvents.add(new TriggerEvent(event,
+                    derivedEvents.add(new TriggerEvent(eventValue,
                         TriggerEvent.SIGNAL_EVENT, params));
                     return;
                 }
@@ -353,13 +362,13 @@ public void execute(final EventDispatcher evtDispatcher,
         }
         ctx.setLocal(getNamespacesKey(), null);
         if (appLog.isDebugEnabled()) {
-            appLog.debug("<send>: Dispatching event '" + event
+            appLog.debug("<send>: Dispatching event '" + eventValue
                 + "' to target '" + targetValue + "' of target type '"
                 + targettypeValue + "' with suggested delay of " + wait
                 + "ms");
         }
         // Else, let the EventDispatcher take care of it
-        evtDispatcher.send(sendid, targetValue, targettypeValue, event,
+        evtDispatcher.send(sendid, targetValue, targettypeValue, eventValue,
             params, hintsValue, wait, externalNodes);
     }
 
diff --git a/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-03.xml b/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-03.xml
index c8f413eeb..8329b97cd 100644
--- a/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-03.xml
+++ b/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-03.xml
@@ -36,7 +36,7 @@
         <onentry>
             <var name="one" expr="Data(rootdata,'root/one')"/>
             <var name="two" expr="Data(rootdata,'root/two')"/>
-            <send event="event.bar" namelist="one two"/>
+            <send event="'event.bar'" namelist="one two"/>
         </onentry>
         <transition event="event.bar"
             cond="_eventdatamap['event.bar'].one + _eventdatamap['event.bar'].two eq 3"
diff --git a/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-04.xml b/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-04.xml
index c2876d7d9..541d2e9a7 100644
--- a/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-04.xml
+++ b/src/test/java/org/apache/commons/scxml/env/jexl/eventdata-04.xml
@@ -28,7 +28,7 @@
            </datamodel>
 
            <onentry>
-               <send event="event.bar" namelist="one two" delay="'100ms'"/>
+               <send event="'event.bar'" namelist="one two" delay="'100ms'"/>
            </onentry>
            <transition event="event.bar">
                <log label="'simulatedUser'" expr="_eventdatamap['event.bar'].one + ', ' + _eventdatamap['event.bar'].two"/>
diff --git a/src/test/java/org/apache/commons/scxml/env/jexl/wizard-02.xml b/src/test/java/org/apache/commons/scxml/env/jexl/wizard-02.xml
index b6df4810a..49caaf275 100644
--- a/src/test/java/org/apache/commons/scxml/env/jexl/wizard-02.xml
+++ b/src/test/java/org/apache/commons/scxml/env/jexl/wizard-02.xml
@@ -24,7 +24,7 @@
                       default to be chosen as "scxml".
                       This will cause the first transition
                       to state2 to be immediately followed. -->
-                 <send event="event2" />
+                 <send event="'event2'" />
            </onentry>
            <transition event="event2" target="state2"/>
            <transition event="event3" target="state3"/>
diff --git a/src/test/java/org/apache/commons/scxml/invoke/invoked-02.xml b/src/test/java/org/apache/commons/scxml/invoke/invoked-02.xml
index 31868bd1c..b1b471aac 100644
--- a/src/test/java/org/apache/commons/scxml/invoke/invoked-02.xml
+++ b/src/test/java/org/apache/commons/scxml/invoke/invoked-02.xml
@@ -21,7 +21,7 @@
 
     <state id="state1">
         <onentry>
-            <send event="invoked.next" />
+            <send event="'invoked.next'" />
         </onentry>
         <transition event="invoked.next" target="state2" />
     </state>
diff --git a/src/test/java/org/apache/commons/scxml/send-02.xml b/src/test/java/org/apache/commons/scxml/send-02.xml
index adca5f8bc..e9fcdd60e 100644
--- a/src/test/java/org/apache/commons/scxml/send-02.xml
+++ b/src/test/java/org/apache/commons/scxml/send-02.xml
@@ -25,49 +25,49 @@
          the state "seventy", then hop over and end up in "ninety" -->
     <state id="ten">
         <onentry>
-            <send event="ten.done" />
+            <send event="'ten.' + 'done'" />
         </onentry>
         <transition event="ten.done" target="twenty" />
     </state>
 
     <state id="twenty">
         <onentry>
-            <send event="twenty.done" targettype="'scxml'" />
+            <send event="'twenty.done'" targettype="'scxml'" />
         </onentry>
         <transition event="twenty.done" target="thirty" />
     </state>
 
     <state id="thirty">
         <onentry>
-            <send event="thirty.done" targettype="' sCxML  '" />
+            <send event="'thirty.done'" targettype="' sCxML  '" />
         </onentry>
         <transition event="thirty.done" target="forty" />
     </state>
 
     <state id="forty">
         <onentry>
-            <send event="forty.done" targettype=" " target=" " />
+            <send event="'forty.done'" targettype=" " target=" " />
         </onentry>
         <transition event="forty.done" target="fifty" />
     </state>
 
     <state id="fifty">
         <onentry>
-            <send event="fifty.done" target="'  '" />
+            <send event="'fifty.done'" target="'  '" />
         </onentry>
         <transition event="fifty.done" target="sixty" />
     </state>
 
     <state id="sixty">
         <onentry>
-            <send event="sixty.done" targettype="'scxml'" target=" " />
+            <send event="'sixty.done'" targettype="'scxml'" target=" " />
         </onentry>
         <transition event="sixty.done" target="seventy" />
     </state>
 
     <state id="seventy">
         <onentry>
-            <send event="seventy.done" targettype="'scxml'" target="'foo'" />
+            <send event="'seventy.done'" targettype="'scxml'" target="'foo'" />
         </onentry>
 
         <!-- This transition should not be followed since
