From 8371e0eaa4d62c02208742000b91a40f62e188df Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Mon, 15 Aug 2011 20:19:25 +0000
Subject: [PATCH] [CONFIGURATION-460] Ported fix to configuration2 branch.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/configuration2_experimental@1157982 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  5 +++
 .../DefaultConfigurationBuilder.java          | 28 ++++++++++++++++-
 .../TestDefaultConfigurationBuilder.java      | 31 ++++++++++++++++++-
 .../resources/testComplexInitialization.xml   |  3 +-
 4 files changed, 64 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 7b5b1cba31..bf64acd001 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -79,6 +79,11 @@
     </release>
 
     <release version="1.7" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-460">
+        Reloading now also works for configuration sources declared in the
+        additional section of a configuration definition file for
+        DefaultConfigurationBuilder.
+      </action>
       <action dev="oheger" type="add" issue="CONFIGURATION-458">
         HierarchicalConfiguration now provides a specific implementation of the
         clear() method. This is more efficient and also solves some other
diff --git a/src/main/java/org/apache/commons/configuration2/DefaultConfigurationBuilder.java b/src/main/java/org/apache/commons/configuration2/DefaultConfigurationBuilder.java
index d199855848..c4a353c3b6 100644
--- a/src/main/java/org/apache/commons/configuration2/DefaultConfigurationBuilder.java
+++ b/src/main/java/org/apache/commons/configuration2/DefaultConfigurationBuilder.java
@@ -616,7 +616,7 @@ public CombinedConfiguration getConfiguration(boolean load)
         List<SubConfiguration<ConfigurationNode>> additionals = fetchChildConfigs(KEY_UNION);
         if (!additionals.isEmpty())
         {
-            CombinedConfiguration addConfig = new CombinedConfiguration(new UnionCombiner());
+            CombinedConfiguration addConfig = createAdditionalsConfiguration(result);
             result.addConfiguration(addConfig, ADDITIONAL_NAME);
             initCombinedConfiguration(addConfig, additionals, KEY_ADDITIONAL_LIST);
         }
@@ -652,6 +652,32 @@ protected CombinedConfiguration createResultConfiguration()
         return result;
     }
 
+    /**
+     * Creates the <code>CombinedConfiguration</code> for the configuration
+     * sources in the <code>&lt;additional&gt;</code> section. This method is
+     * called when the builder constructs the final configuration. It creates a
+     * new <code>CombinedConfiguration</code> and initializes some properties
+     * from the result configuration.
+     *
+     * @param resultConfig the result configuration (this is the configuration
+     *        that will be returned by the builder)
+     * @return the <code>CombinedConfiguration</code> for the additional
+     *         configuration sources
+     * @since 1.7
+     */
+    protected CombinedConfiguration createAdditionalsConfiguration(
+            CombinedConfiguration resultConfig)
+    {
+        CombinedConfiguration addConfig =
+                new CombinedConfiguration(new UnionCombiner());
+        addConfig.setDelimiterParsingDisabled(resultConfig
+                .isDelimiterParsingDisabled());
+        addConfig.setForceReloadCheck(resultConfig.isForceReloadCheck());
+        addConfig.setIgnoreReloadExceptions(resultConfig
+                .isIgnoreReloadExceptions());
+        return addConfig;
+    }
+
     /**
      * Initializes a combined configuration for the configurations of a specific
      * section. This method is called for the override and for the additional
diff --git a/src/test/java/org/apache/commons/configuration2/TestDefaultConfigurationBuilder.java b/src/test/java/org/apache/commons/configuration2/TestDefaultConfigurationBuilder.java
index 9508b9c77f..d921e599ab 100644
--- a/src/test/java/org/apache/commons/configuration2/TestDefaultConfigurationBuilder.java
+++ b/src/test/java/org/apache/commons/configuration2/TestDefaultConfigurationBuilder.java
@@ -741,7 +741,7 @@ public void testComplexInitialization() throws ConfigurationException
     /**
      * Tests if the returned combined configuration has the expected structure.
      */
-    public void testCombinedConfiguration() throws ConfigurationException
+    public void testCombinedConfigurationStructure() throws ConfigurationException
     {
         factory.setFile(INIT_FILE);
         CombinedConfiguration cc = (CombinedConfiguration) factory
@@ -762,6 +762,35 @@ public void testCombinedConfiguration() throws ConfigurationException
         assertTrue("Config 2 not contained", names.contains("combiner2"));
     }
 
+    /**
+     * Helper method for testing the attributes of a combined configuration
+     * created by the builder.
+     *
+     * @param cc the configuration to be checked
+     */
+    private void checkCombinedConfigAttrs(CombinedConfiguration cc)
+    {
+        assertTrue("Wrong delimiter parsing flag",
+                cc.isDelimiterParsingDisabled());
+        assertTrue("Wrong reload check", cc.isForceReloadCheck());
+        assertTrue("Wrong ignore reload ex flag", cc.isIgnoreReloadExceptions());
+    }
+
+    /**
+     * Tests whether attributes are correctly set on the combined configurations
+     * for the override and additional sections.
+     */
+    public void testCombinedConfigurationAttributes() throws ConfigurationException
+    {
+        factory.setFile(INIT_FILE);
+        CombinedConfiguration cc = (CombinedConfiguration) factory
+                .getConfiguration();
+        checkCombinedConfigAttrs(cc);
+        CombinedConfiguration cc2 = (CombinedConfiguration) cc
+                .getConfiguration(DefaultConfigurationBuilder.ADDITIONAL_NAME);
+        checkCombinedConfigAttrs(cc2);
+    }
+
     /**
      * Tests the structure of the returned combined configuration if there is no
      * additional section.
diff --git a/src/test/resources/testComplexInitialization.xml b/src/test/resources/testComplexInitialization.xml
index 6a6fbdd959..3d1727e7c4 100644
--- a/src/test/resources/testComplexInitialization.xml
+++ b/src/test/resources/testComplexInitialization.xml
@@ -2,7 +2,8 @@
 <!-- Test configuration definition file that demonstrates complex initialization -->
 <configuration>
   <header>
-    <result delimiterParsingDisabled="true">
+    <result delimiterParsingDisabled="true" forceReloadCheck="true"
+      ignoreReloadExceptions="true">
       <nodeCombiner config-class="org.apache.commons.configuration2.combined.OverrideCombiner"/>
       <expressionEngine config-class="org.apache.commons.configuration2.expr.xpath.XPathExpressionEngine"/>
     </result>
