From 80badab34b8680b45535f3d118d12163d0e44385 Mon Sep 17 00:00:00 2001
From: Benedikt Ritter <britter@apache.org>
Date: Thu, 1 Jan 2015 16:44:02 +0000
Subject: [PATCH] VALIDATOR-346: SedolCheckDigit fails to reject invalid
 (non-numeric) check digits. Fix implemented by Sebb.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1648878 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                          |  3 +++
 .../routines/checkdigit/SedolCheckDigit.java     |  6 ++++--
 .../routines/checkdigit/SedolCheckDigitTest.java | 16 ++++++++++++++++
 3 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 29aa96168..238f0fbb6 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -43,6 +43,9 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
 
   <release version="1.4.1" date="tba" description="1.4 Maintenance release">
+    <action issue="VALIDATOR-346" dev="sebb" type="fix" >
+      SedolCheckDigit fails to reject invalid (non-numeric) check digits
+    </action>
     <action issue="VALIDATOR-345" dev="sebb" type="fix" >
       ISINCheckDigit fails to reject invalid (non-numeric) check digits
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigit.java b/src/main/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigit.java
index 3fb4c79a0..544e9229b 100644
--- a/src/main/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigit.java
+++ b/src/main/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigit.java
@@ -97,9 +97,11 @@ protected int weightedValue(int charValue, int leftPos, int rightPos) {
     protected int toInt(char character, int leftPos, int rightPos)
             throws CheckDigitException {
         int charValue = Character.getNumericValue(character);
-        if (charValue < 0 || charValue > 35) {
+        // the check digit is only allowed to reach 9
+        final int charMax = rightPos == 1 ? 9 : 35;
+        if (charValue < 0 || charValue > charMax) {
             throw new CheckDigitException("Invalid Character[" +
-                    leftPos + "] = '" + charValue + "'");
+                    leftPos + "," + rightPos + "] = '" + charValue + "' out of range 0 to " + charMax);
         }
         return charValue;
     }
diff --git a/src/test/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigitTest.java b/src/test/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigitTest.java
index aac7e61fe..add392814 100644
--- a/src/test/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigitTest.java
+++ b/src/test/java/org/apache/commons/validator/routines/checkdigit/SedolCheckDigitTest.java
@@ -49,4 +49,20 @@ protected void setUp() throws Exception {
         invalid = new String[] {"123#567"};
         zeroSum = "0000000";
     }
+
+    private static String invalidCheckDigits[] = {
+                "026349E", // proper check digit is '4', see above
+                "087061C", // proper check digit is '2', see above
+                "B06LQ9H", // proper check digit is '7', see above
+                "343757F", // proper check digit is '5', see above
+                "B07LF5F", // proper check digit is '5', see above
+               };
+
+    public void testVALIDATOR_346() {
+        for (int i = 0; i < invalidCheckDigits.length; i++) {
+            String invalidCheckDigit = invalidCheckDigits[i];
+            assertFalse("Should fail: " + invalidCheckDigit, routine.isValid(invalidCheckDigit));
+        }
+    }
+
 }
