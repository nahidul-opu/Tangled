From cf0e5a5364d13c840a8a21fd23ce87410266ea8b Mon Sep 17 00:00:00 2001
From: Simone Tripodi <simonetripodi@apache.org>
Date: Fri, 21 Dec 2012 21:27:00 +0000
Subject: [PATCH] [DIGESTER-175] Regression:
 DigesterTestCase#testPopNamedStackNotPushed expects EmptyStackException

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/digester/trunk@1425150 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/commons/digester3/Digester.java    | 21 +++++++------------
 src/changes/changes.xml                       |  3 +++
 2 files changed, 11 insertions(+), 13 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/digester3/Digester.java b/core/src/main/java/org/apache/commons/digester3/Digester.java
index 541ddde9a..0debf871c 100644
--- a/core/src/main/java/org/apache/commons/digester3/Digester.java
+++ b/core/src/main/java/org/apache/commons/digester3/Digester.java
@@ -2741,6 +2741,7 @@ public <T> void push( String stackName, T value )
      */
     public <T> T pop( String stackName )
     {
+        T result = null;
         Stack<Object> namedStack = stacksByName.get( stackName );
         if ( namedStack == null )
         {
@@ -2748,23 +2749,17 @@ public <T> T pop( String stackName )
             {
                 log.debug( "Stack '" + stackName + "' is empty" );
             }
-            return null;
+            throw new EmptyStackException();
         }
 
-        try
-        {
-            T popped = this.<T> npeSafeCast( namedStack.pop() );
-            if ( stackAction != null )
-            {
-                popped = stackAction.onPop( this, stackName, popped );
-            }
-            return popped;
-        }
-        catch ( EmptyStackException e )
+        result = this.<T> npeSafeCast( namedStack.pop() );
+
+        if ( stackAction != null )
         {
-            log.warn( "Empty stack (returning null)" );
-            return ( null );
+            result = stackAction.onPop( this, stackName, result );
         }
+
+        return result;
     }
 
     /**
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index dfed1938e..e5a8187f5 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -23,6 +23,9 @@
   </properties>
   <body>
   <release version="3.3" date="201?-??-??" description="Maintenance release.">
+    <action dev="simonetripodi" type="fix" issue="DIGESTER-175">
+      Regression: DigesterTestCase#testPopNamedStackNotPushed expects EmptyStackException
+    </action>
     <action dev="simonetripodi" type="fix" issue="DIGESTER-174" due-to="Andreas Sahlbach">
       Inner List Annotation has wrong @Target for most of the predefined annotation rules
     </action>
