From a92d32a912e30c63696d18a4d0a5ac9e5f6f5452 Mon Sep 17 00:00:00 2001
From: Mark Thomas <markt@apache.org>
Date: Fri, 31 Jan 2014 20:44:56 +0000
Subject: [PATCH] Fix DBCP-391 Ensure that the close state of a pooled
 connection and the underlying connection is consistent when the underlying
 connection is closed as a result of an error condition.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1563253 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  5 ++++
 .../commons/dbcp2/PoolableConnection.java     | 25 ++++++++++++++++---
 2 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index e772754a2f..4592a1ff77 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -99,6 +99,11 @@ The <action> type attribute can be add,update,fix,remove.
         Fix threading issue when using multiple instances of the
         SharedPoolDataSource concurrently.
       </action>
+      <action dev="markt" issue="DBCP-391" type="fix">
+        Ensure that the close state of a pooled connection and the underlying
+        connection is consistent when the underlying connection is closed as a
+        result of an error condition.
+      </action>
     </release>
     <release version="1.5.1" date="TBD" description="TBD">
       <action dev="markt" issue="DBCP-400" type="fix">
diff --git a/src/main/java/org/apache/commons/dbcp2/PoolableConnection.java b/src/main/java/org/apache/commons/dbcp2/PoolableConnection.java
index 433faaf1de..e234a9bae8 100644
--- a/src/main/java/org/apache/commons/dbcp2/PoolableConnection.java
+++ b/src/main/java/org/apache/commons/dbcp2/PoolableConnection.java
@@ -46,6 +46,26 @@ public PoolableConnection(Connection conn,
     }
 
 
+
+    @Override
+    public boolean isClosed() throws SQLException {
+        if (_closed) {
+            return true;
+        }
+
+        if (getDelegateInternal().isClosed()) {
+            // Something has gone wrong. The underlying connection has been
+            // closed without the connection being returned to the pool. Return
+            // it now.
+            close();
+            return true;
+        }
+
+        return false;
+    }
+
+
+
     /**
      * Returns me to my pool.
      */
@@ -97,10 +117,9 @@ public synchronized void close() throws SQLException {
                 // pool is closed, so close the connection
                 passivate();
                 getInnermostDelegate().close();
-            } catch (Exception ie) {
-                // DO NOTHING, "Already closed" exception thrown below
+            } catch (Exception e) {
+                throw (SQLException) new SQLException("Cannot close connection (invalidating pooled object failed)").initCause(e);
             }
-            throw new SQLException("Already closed.");
         }
         _closed = true;
     }
