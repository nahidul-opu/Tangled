From 33e453a0dcb89751280d6008a960103be5e965db Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 4 Jul 2008 11:16:12 +0000
Subject: [PATCH] FIX: Ivy files are not retrieved when using useOrigin=true
 (IVY-713)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@674011 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../org/apache/ivy/ant/IvyRetrieveTest.java   | 21 +++++++++++++++++++
 2 files changed, 22 insertions(+)

diff --git a/CHANGES.txt b/CHANGES.txt
index f71d12a66..8b7c8b197 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -91,6 +91,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: Ivy files are not retrieved when using useOrigin=true (IVY-713)
 - FIX: NPE in Ivy:install task if the repository cache dir has been cleared (IVY-843)
 - FIX: Maven version ranges with ( ) are not supported (IVY-678) (thanks to Michael Kebe)
 - FIX: Ignore maven metadata files when listing revisions (IVY-765)
diff --git a/test/java/org/apache/ivy/ant/IvyRetrieveTest.java b/test/java/org/apache/ivy/ant/IvyRetrieveTest.java
index 504b7f744..84e544057 100644
--- a/test/java/org/apache/ivy/ant/IvyRetrieveTest.java
+++ b/test/java/org/apache/ivy/ant/IvyRetrieveTest.java
@@ -218,6 +218,27 @@ public void testUseOrigin() throws Exception {
             "mod1.2", "jar", "jar")).exists());
     }
     
+    public void testUseOriginWithIvyPattern() throws Exception {
+        // mod2.5 depends on virtual mod2.3 which depends on mod2.1 which depends on mod1.1 which
+        // depends on mod1.2
+        project.setProperty("ivy.dep.file", "test/repositories/1/org2/mod2.5/ivys/ivy-0.6.1.xml");
+
+        String ivyPattern = IVY_RETRIEVE_PATTERN;
+
+        retrieve.setIvypattern(ivyPattern);
+        retrieve.setUseOrigin(true);
+        retrieve.execute();
+
+        assertTrue(new File(IvyPatternHelper.substitute(ivyPattern, "org2", "mod2.3", "0.4.1",
+            "ivy", "ivy", "xml")).exists());
+        assertTrue(new File(IvyPatternHelper.substitute(ivyPattern, "org2", "mod2.1", "0.3", "ivy",
+            "ivy", "xml")).exists());
+        assertTrue(new File(IvyPatternHelper.substitute(ivyPattern, "org1", "mod1.1", "1.0", "ivy",
+            "ivy", "xml")).exists());
+        assertFalse(new File(IvyPatternHelper.substitute(ivyPattern, "org1", "mod1.2", "2.0",
+            "ivy", "ivy", "xml")).exists());
+    }
+    
     public void testRetrieveWithOriginalNamePattern() throws Exception {
         retrieve.setFile(new File("test/java/org/apache/ivy/ant/ivy-631.xml"));
         retrieve.setConf("default");
