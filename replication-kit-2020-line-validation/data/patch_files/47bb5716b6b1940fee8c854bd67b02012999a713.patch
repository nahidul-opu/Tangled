From 47bb5716b6b1940fee8c854bd67b02012999a713 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sat, 8 Nov 2008 16:37:48 +0000
Subject: [PATCH] CONFIGURATION-348: AbstractHierarchicalFileConfiguration now
 overrides getKeys() to perform a reload check.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@712405 13f79535-47bb-0310-9956-ffa450edef68
---
 ...AbstractHierarchicalFileConfiguration.java | 10 ++++++++--
 .../configuration/TestXMLConfiguration.java   | 20 +++++++++++++++++++
 xdocs/changes.xml                             |  4 ++++
 3 files changed, 32 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java b/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
index e88d11b60c..87c1202df9 100644
--- a/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
+++ b/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
@@ -17,11 +17,11 @@
 
 package org.apache.commons.configuration;
 
-import java.io.Reader;
-import java.io.Writer;
 import java.io.File;
 import java.io.InputStream;
 import java.io.OutputStream;
+import java.io.Reader;
+import java.io.Writer;
 import java.net.URL;
 import java.util.Collection;
 import java.util.Iterator;
@@ -308,6 +308,12 @@ public boolean containsKey(String key)
         return super.containsKey(key);
     }
 
+    public Iterator getKeys()
+    {
+        reload();
+        return super.getKeys();
+    }
+
     public Iterator getKeys(String prefix)
     {
         reload();
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 9c080693b7..b50a15a35b 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -963,6 +963,26 @@ public void testConfigurationsAtWithReload() throws ConfigurationException
                         .getString("entity"));
     }
 
+    /**
+     * Tests whether reloads are recognized when querying the configuration's
+     * keys.
+     */
+    public void testGetKeysWithReload() throws ConfigurationException
+    {
+        XMLConfiguration c = setUpReloadTest();
+        conf.addProperty("aNewKey", "aNewValue");
+        conf.save(testSaveConf);
+        boolean found = false;
+        for (Iterator it = c.getKeys(); it.hasNext();)
+        {
+            if ("aNewKey".equals(it.next()))
+            {
+                found = true;
+            }
+        }
+        assertTrue("Reload not performed", found);
+    }
+
     /**
      * Tests accessing properties when the XPATH expression engine is set.
      */
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 82f0c598a7..93a0266c77 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-348">
+        AbstractHierarchicalFileConfiguration.getKeys() now also checks whether
+        a reload is required.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-347">
         AbstractFileConfiguration.getKeys() now returns an iterator that points
         to a snapshot of the keys of the configuration. This prevents
