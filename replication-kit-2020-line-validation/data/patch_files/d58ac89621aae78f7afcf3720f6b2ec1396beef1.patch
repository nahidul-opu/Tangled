From d58ac89621aae78f7afcf3720f6b2ec1396beef1 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Wed, 14 Mar 2012 02:48:08 +0000
Subject: [PATCH] IO-300 FileUtils.moveDirectoryToDirectory removes source
 directory if destination is a subdirectory

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@1300447 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                           |  3 +++
 .../java/org/apache/commons/io/FileUtils.java     |  4 ++++
 .../org/apache/commons/io/FileUtilsTestCase.java  | 15 +++++++++++++++
 3 files changed, 22 insertions(+)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index d1445b63652..7868227b738 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -40,6 +40,9 @@ The <action> type attribute can be add,update,fix,remove.
 
   <body>
     <release version="2.2" date="TBA">
+      <action issue="IO-300" dev="sebb" type="fix">
+        FileUtils.moveDirectoryToDirectory removes source directory if destination is a subdirectory
+      </action>        
       <action issue="IO-307" dev="sebb" type="fix">
         ReaderInputStream#read(byte[] b, int off, int len) should check for valid parameters
       </action>        
diff --git a/src/main/java/org/apache/commons/io/FileUtils.java b/src/main/java/org/apache/commons/io/FileUtils.java
index 7da001c7798..5ddcf5e1e3b 100644
--- a/src/main/java/org/apache/commons/io/FileUtils.java
+++ b/src/main/java/org/apache/commons/io/FileUtils.java
@@ -32,6 +32,7 @@
 import java.nio.ByteBuffer;
 import java.nio.channels.FileChannel;
 import java.nio.charset.Charset;
+import java.security.InvalidParameterException;
 import java.util.ArrayList;
 import java.util.Collection;
 import java.util.Date;
@@ -2491,6 +2492,9 @@ public static void moveDirectory(File srcDir, File destDir) throws IOException {
         }
         boolean rename = srcDir.renameTo(destDir);
         if (!rename) {
+            if (destDir.getCanonicalPath().startsWith(srcDir.getCanonicalPath())) {
+                throw new IOException("Cannot move directory: "+srcDir+" to a subdirectory of itself: "+destDir);
+            }
             copyDirectory( srcDir, destDir );
             deleteDirectory( srcDir );
             if (srcDir.exists()) {
diff --git a/src/test/java/org/apache/commons/io/FileUtilsTestCase.java b/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
index 931fe04a023..d89b9aec4c9 100644
--- a/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
+++ b/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
@@ -2310,6 +2310,21 @@ public void testMoveToDirectory_Errors() throws Exception {
         }
     }
 
+    public void testIO300() throws Exception {
+        final File testDirectory = getTestDirectory();
+        File src = new File(testDirectory, "dir1");
+        File dest = new File(src,"dir2");
+        assertTrue(dest.mkdirs());
+        assertTrue(src.exists());
+        try {
+            FileUtils.moveDirectoryToDirectory(src, dest, false);
+            fail("expected IOException");
+        } catch (IOException ioe) {
+            // expected
+        }
+        assertTrue(src.exists());
+    }
+
     public void testIO276() throws Exception {
         File dir = new File("target", "IO276");
         assertTrue(dir+" should not be present",dir.mkdirs());
