From d2f27093d7d95a07da901902f894d88b4ecc3e95 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Sun, 26 Mar 2017 17:22:08 +0000
Subject: [PATCH] CODEC-229 StringUtils.newStringxxx(null) should return null,
 not NPE

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/codec/trunk@1788755 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                |  3 ++-
 .../org/apache/commons/codec/binary/StringUtils.java   | 10 +++++-----
 .../apache/commons/codec/binary/StringUtilsTest.java   | 10 ++++++++++
 3 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 9e5827145e..13a91d51a5 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -42,9 +42,10 @@ The <action> type attribute can be add,update,fix,remove.
     <author>Apache Commons Developers</author>
   </properties>
   <body>
-    <release version="1.11" date="2016-MM-DD" description="Feature and fix release.">
+    <release version="1.11" date="2017-MM-DD" description="Feature and fix release.">
       <!-- The first attribute below should be the issue id; makes it easier to navigate in the IDE outline -->
 
+      <action issue="CODEC-229" dev="sebb" type="fix">StringUtils.newStringxxx(null) should return null, not NPE</action>
       <action issue="CODEC-220" dev="sebb" type="add">Fluent interface for DigestUtils</action>
       <action issue="CODEC-222" dev="sebb" type="add">Fluent interface for HmacUtils</action>
       <action issue="CODEC-225" dev="jochen" type="fix" due-to="Svetlin Zarev">Fix minor resource leaks</action>
diff --git a/src/main/java/org/apache/commons/codec/binary/StringUtils.java b/src/main/java/org/apache/commons/codec/binary/StringUtils.java
index 84a2a727cb..7bb15e3327 100644
--- a/src/main/java/org/apache/commons/codec/binary/StringUtils.java
+++ b/src/main/java/org/apache/commons/codec/binary/StringUtils.java
@@ -336,7 +336,7 @@ public static String newString(final byte[] bytes, final String charsetName) {
      * @since As of 1.7, throws {@link NullPointerException} instead of UnsupportedEncodingException
      */
     public static String newStringIso8859_1(final byte[] bytes) {
-        return new String(bytes, Charsets.ISO_8859_1);
+        return newString(bytes, Charsets.ISO_8859_1);
     }
 
     /**
@@ -352,7 +352,7 @@ public static String newStringIso8859_1(final byte[] bytes) {
      * @since As of 1.7, throws {@link NullPointerException} instead of UnsupportedEncodingException
      */
     public static String newStringUsAscii(final byte[] bytes) {
-        return new String(bytes, Charsets.US_ASCII);
+        return newString(bytes, Charsets.US_ASCII);
     }
 
     /**
@@ -368,7 +368,7 @@ public static String newStringUsAscii(final byte[] bytes) {
      * @since As of 1.7, throws {@link NullPointerException} instead of UnsupportedEncodingException
      */
     public static String newStringUtf16(final byte[] bytes) {
-        return new String(bytes, Charsets.UTF_16);
+        return newString(bytes, Charsets.UTF_16);
     }
 
     /**
@@ -384,7 +384,7 @@ public static String newStringUtf16(final byte[] bytes) {
      * @since As of 1.7, throws {@link NullPointerException} instead of UnsupportedEncodingException
      */
     public static String newStringUtf16Be(final byte[] bytes) {
-        return new String(bytes, Charsets.UTF_16BE);
+        return newString(bytes, Charsets.UTF_16BE);
     }
 
     /**
@@ -400,7 +400,7 @@ public static String newStringUtf16Be(final byte[] bytes) {
      * @since As of 1.7, throws {@link NullPointerException} instead of UnsupportedEncodingException
      */
     public static String newStringUtf16Le(final byte[] bytes) {
-        return new String(bytes, Charsets.UTF_16LE);
+        return newString(bytes, Charsets.UTF_16LE);
     }
 
     /**
diff --git a/src/test/java/org/apache/commons/codec/binary/StringUtilsTest.java b/src/test/java/org/apache/commons/codec/binary/StringUtilsTest.java
index 55e0cc2b30..8a6e219315 100644
--- a/src/test/java/org/apache/commons/codec/binary/StringUtilsTest.java
+++ b/src/test/java/org/apache/commons/codec/binary/StringUtilsTest.java
@@ -145,6 +145,16 @@ public void testNewStringNullInput() {
         Assert.assertNull(StringUtils.newString(null, "UNKNOWN"));
     }
 
+    @Test
+    public void testNewStringNullInput_CODEC229() {
+        Assert.assertNull(StringUtils.newStringUtf8(null));
+        Assert.assertNull(StringUtils.newStringIso8859_1(null));
+        Assert.assertNull(StringUtils.newStringUsAscii(null));
+        Assert.assertNull(StringUtils.newStringUtf16(null));
+        Assert.assertNull(StringUtils.newStringUtf16Be(null));
+        Assert.assertNull(StringUtils.newStringUtf16Le(null));
+    }
+
     @Test
     public void testNewStringIso8859_1() throws UnsupportedEncodingException {
         final String charsetName = "ISO-8859-1";
