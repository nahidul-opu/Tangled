From 243defb4c96d911683bc5a2c2b1e630770d49121 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Thu, 30 Mar 2006 11:10:17 +0000
Subject: [PATCH] FIX: M2 compatibility does not take into account the .
 replacement for publishing artifacts (IVY-191) (thanks to Peter Hayes)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484255 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                       |  1 +
 .../jayasoft/ivy/resolver/RepositoryResolver.java | 15 ++++++++++++++-
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 6de4dd18c..0bafd9ed9 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -3,6 +3,7 @@
 - FIX: problem with conflict resolution in transitive dependencies (IVY-199)
 - FIX: pb with force when it comes after a conflict has already been solved (IVY-193)
 - FIX: POM files that reference to the parent artifact download fails (IVY-195) (thanks to Tat Leung)
+- FIX: M2 compatibility does not take into account the . replacement for publishing artifacts (IVY-191) (thanks to Peter Hayes)
 - FIX: artifactproperty does not set the [conf] token in the pattern to the correct value. It is always set to 'default'. (IVY-123) (thanks to Peter Oxenham)
 
    version 1.3 - 2006-03-17
diff --git a/src/java/fr/jayasoft/ivy/resolver/RepositoryResolver.java b/src/java/fr/jayasoft/ivy/resolver/RepositoryResolver.java
index ed4637624..d9e477e4a 100644
--- a/src/java/fr/jayasoft/ivy/resolver/RepositoryResolver.java
+++ b/src/java/fr/jayasoft/ivy/resolver/RepositoryResolver.java
@@ -137,7 +137,20 @@ public void publish(Artifact artifact, File src, boolean overwrite) throws IOExc
         } else {
             destPattern =  (String)getArtifactPatterns().get(0);
         }
-        String dest = IvyPatternHelper.substitute(destPattern, artifact);
+        // Check for m2 compatibility
+        ModuleRevisionId mrid = artifact.getModuleRevisionId();
+        if (isM2compatible()) {
+            mrid = convertM2IdForResourceSearch(mrid);
+        }
+        
+        String dest = IvyPatternHelper.substitute(destPattern,
+                mrid.getOrganisation(),
+                mrid.getName(),
+                mrid.getRevision(),
+                artifact.getName(),
+                artifact.getType(),
+                artifact.getExt()); 
+        
         _repository.put(src, dest, overwrite);
         Message.info("\tpublished "+artifact.getName()+" to "+dest);
     }
