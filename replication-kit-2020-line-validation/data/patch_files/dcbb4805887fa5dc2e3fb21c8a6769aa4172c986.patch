From dcbb4805887fa5dc2e3fb21c8a6769aa4172c986 Mon Sep 17 00:00:00 2001
From: Claudio Martella <claudio@apache.org>
Date: Fri, 21 Mar 2014 22:49:31 +0100
Subject: [PATCH] GIRAPH-871

---
 CHANGELOG                                          |  2 ++
 .../org/apache/giraph/comm/netty/NettyClient.java  | 14 +++++++++++---
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 360e0f8ee..628741890 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,8 @@
 Giraph Change Log
 
 Release 1.1.0 - unreleased
+  GIRAPH-871: Map task jvm never exits since netty 4 upgrade (cmuchinsky via claudio)
+
   GIRAPH-869: Log Vertex/Edge Count for All Workers (yhdong via majakabiljo)
 
   GIRAPH-868: Fix race condition with WorkerProgress (majakabiljo)
diff --git a/giraph-core/src/main/java/org/apache/giraph/comm/netty/NettyClient.java b/giraph-core/src/main/java/org/apache/giraph/comm/netty/NettyClient.java
index c40c2b824..ae40c3b22 100644
--- a/giraph-core/src/main/java/org/apache/giraph/comm/netty/NettyClient.java
+++ b/giraph-core/src/main/java/org/apache/giraph/comm/netty/NettyClient.java
@@ -543,6 +543,9 @@ private void authenticateOnChannel(Integer taskId, Channel channel) {
    * Stop the client.
    */
   public void stop() {
+    if (LOG.isInfoEnabled()) {
+      LOG.info("stop: Halting netty client");
+    }
     // Close connections asynchronously, in a Netty-approved
     // way, without cleaning up thread pools until all channels
     // in addressChannelMap are closed (success or failure)
@@ -561,18 +564,23 @@ public void operationComplete(ChannelFuture cf) {
             if (LOG.isInfoEnabled()) {
               LOG.info("stop: reached wait threshold, " +
                   done + " connections closed, releasing " +
-                  "NettyClient.bootstrap resources now.");
+                  "resources now.");
             }
             workerGroup.shutdownGracefully();
-            ProgressableUtils.awaitTerminationFuture(executionGroup, context);
             if (executionGroup != null) {
               executionGroup.shutdownGracefully();
-              ProgressableUtils.awaitTerminationFuture(executionGroup, context);
             }
           }
         }
       });
     }
+    ProgressableUtils.awaitTerminationFuture(workerGroup, context);
+    if (executionGroup != null) {
+      ProgressableUtils.awaitTerminationFuture(executionGroup, context);
+    }
+    if (LOG.isInfoEnabled()) {
+      LOG.info("stop: Netty client halted");
+    }
   }
 
   /**
