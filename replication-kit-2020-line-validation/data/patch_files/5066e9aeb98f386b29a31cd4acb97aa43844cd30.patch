From 5066e9aeb98f386b29a31cd4acb97aa43844cd30 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Thu, 7 Jan 2010 09:34:55 +0000
Subject: [PATCH] ZipArchiveEntry#equals is broken if the String-arg
 constructor is used.  COMPRESS-94 - submitted by Anon Devs

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@896818 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                               |  6 ++++++
 .../compress/archivers/zip/ZipArchiveEntry.java       | 11 +++++++----
 .../compress/archivers/zip/ZipArchiveEntryTest.java   | 10 ++++++++++
 3 files changed, 23 insertions(+), 4 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index b58d95f784f..0216cd02a43 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -23,6 +23,12 @@
   </properties>
   <body>
     <release version="1.1" date="as in SVN" description="Release 1.1">
+      <action type="fix" issue="COMPRESS-94" date="2010-01-07"
+              due-to="Anon Devs">
+        ZipArchiveEntry's equals method was broken for entries created
+        with the String-arg constructor.  This lead to broken ZIP
+        archives if two different entries had the same hash code.
+      </action>
       <action type="fix" issue="COMPRESS-87" date="2009-10-30"
               due-to="Antoni Mylka">
         ZipArchiveInputStream could repeatedly return 0 on read() when
diff --git a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntry.java b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntry.java
index cab4c1ceddc..fe5270fdba0 100644
--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntry.java
+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntry.java
@@ -61,6 +61,7 @@ public class ZipArchiveEntry extends java.util.zip.ZipEntry
      */
     public ZipArchiveEntry(String name) {
         super(name);
+        setName(name);
     }
 
     /**
@@ -96,7 +97,7 @@ public ZipArchiveEntry(ZipArchiveEntry entry) throws ZipException {
     /**
      */
     protected ZipArchiveEntry() {
-        super("");
+        this("");
     }
 
     public ZipArchiveEntry(File inputFile, String entryName) {
@@ -459,11 +460,13 @@ public boolean equals(Object obj) {
             return false;
         }
         ZipArchiveEntry other = (ZipArchiveEntry) obj;
-        if (name == null) {
-            if (other.name != null) {
+        String myName = getName();
+        String otherName = other.getName();
+        if (myName == null) {
+            if (otherName != null) {
                 return false;
             }
-        } else if (!name.equals(other.name)) {
+        } else if (!myName.equals(otherName)) {
             return false;
         }
         return true;
diff --git a/src/test/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntryTest.java b/src/test/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntryTest.java
index c50defe4aac..1ce7822ac66 100644
--- a/src/test/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntryTest.java
+++ b/src/test/java/org/apache/commons/compress/archivers/zip/ZipArchiveEntryTest.java
@@ -219,4 +219,14 @@ public void testCompressionMethod() {
         assertFalse(entry.isSupportedCompressionMethod());
     }
 
+    /**
+     * Test case for
+     * <a href="https://issues.apache.org/jira/browse/COMPRESS-94"
+     * >COMPRESS-94</a>.
+     */
+    public void testNotEquals() {
+        ZipArchiveEntry entry1 = new ZipArchiveEntry("foo");
+        ZipArchiveEntry entry2 = new ZipArchiveEntry("bar");
+        assertFalse(entry1.equals(entry2));
+    }
 }
