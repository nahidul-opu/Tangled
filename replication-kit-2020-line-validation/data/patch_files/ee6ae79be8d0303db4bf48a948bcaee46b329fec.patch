From ee6ae79be8d0303db4bf48a948bcaee46b329fec Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 30 Aug 2012 11:03:17 +0000
Subject: [PATCH] FIX: Resolve does not deliver all dependent artifacts
 (IVY-1366) (thanks to Wolfgang Frank)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1378882 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  2 ++
 .../org/apache/ivy/core/resolve/IvyNode.java  |  4 +--
 .../ivy/core/resolve/ResolveEngine.java       | 11 +++---
 .../apache/ivy/core/resolve/ResolveTest.java  | 17 +++++++++-
 test/repositories/IVY-1366/a/1/ivy.xml        | 30 ++++++++++++++++
 test/repositories/IVY-1366/a/1/jars/a-1.jar   |  0
 test/repositories/IVY-1366/b/1/ivy.xml        | 30 ++++++++++++++++
 test/repositories/IVY-1366/b/1/jars/b-1.jar   |  0
 test/repositories/IVY-1366/c/1/ivy.xml        | 34 +++++++++++++++++++
 test/repositories/IVY-1366/c/1/jars/c-1.jar   |  0
 test/repositories/IVY-1366/ivy.xml            | 34 +++++++++++++++++++
 test/repositories/IVY-1366/ivysettings.xml    | 27 +++++++++++++++
 12 files changed, 182 insertions(+), 7 deletions(-)
 create mode 100644 test/repositories/IVY-1366/a/1/ivy.xml
 create mode 100644 test/repositories/IVY-1366/a/1/jars/a-1.jar
 create mode 100644 test/repositories/IVY-1366/b/1/ivy.xml
 create mode 100644 test/repositories/IVY-1366/b/1/jars/b-1.jar
 create mode 100644 test/repositories/IVY-1366/c/1/ivy.xml
 create mode 100644 test/repositories/IVY-1366/c/1/jars/c-1.jar
 create mode 100644 test/repositories/IVY-1366/ivy.xml
 create mode 100644 test/repositories/IVY-1366/ivysettings.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 6fc10425c..dfb1a94f9 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -45,6 +45,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Gregory Fernandez
 	Danno Ferrin
 	Benjamin Francisoud	
+	Wolfgang Frank
 	Jacob Grydholt Jensen
 	John Gibson
 	Mitch Gitman
@@ -130,6 +131,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	
    trunk
 =====================================
+- FIX: Resolve does not deliver all dependent artifacts (IVY-1366) (thanks to Wolfgang Frank)
 - FIX: Ivy descriptors are merged incorrectly when there is an <exclude> element (IVY-1356)
 - FIX: SimpleDateFormat is not thread safe (IVY-1373)
 - FIX: Maven 'hk2-jar' packaging is now supported (IVY-1357)
diff --git a/src/java/org/apache/ivy/core/resolve/IvyNode.java b/src/java/org/apache/ivy/core/resolve/IvyNode.java
index 400adda08..669245483 100644
--- a/src/java/org/apache/ivy/core/resolve/IvyNode.java
+++ b/src/java/org/apache/ivy/core/resolve/IvyNode.java
@@ -288,7 +288,7 @@ private void moveToRealNode(String rootModuleConf, IvyNode parent, String parent
         }
     }
 
-    public Collection getDependencies(String rootModuleConf, String[] confs) {
+    public Collection getDependencies(String rootModuleConf, String[] confs, String requestedConf) {
         if (md == null) {
             throw new IllegalStateException(
                     "impossible to get dependencies when data has not been loaded");
@@ -302,7 +302,7 @@ public Collection getDependencies(String rootModuleConf, String[] confs) {
         }
         Collection deps = new HashSet();
         for (int i = 0; i < confs.length; i++) {
-            deps.addAll(getDependencies(rootModuleConf, confs[i], confs[i]));
+            deps.addAll(getDependencies(rootModuleConf, confs[i], requestedConf));
         }
         return deps;
     }
diff --git a/src/java/org/apache/ivy/core/resolve/ResolveEngine.java b/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
index e9c230391..47c4e428f 100644
--- a/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
+++ b/src/java/org/apache/ivy/core/resolve/ResolveEngine.java
@@ -1084,7 +1084,8 @@ private Collection computeConflicts(VisitNode node, VisitNode ancestor, String c
             // In this case we need to compute selected nodes again. 
             Collection deps = ancestor.getNode().getDependencies(
                 node.getRootModuleConf(), 
-                ancestor.getNode().getConfigurations(node.getRootModuleConf()));
+                ancestor.getNode().getConfigurations(node.getRootModuleConf()), 
+                ancestor.getRequestedConf());
             for (Iterator iter = deps.iterator(); iter.hasNext();) {
                 IvyNode dep = (IvyNode) iter.next();
                 if (dep.getModuleId().equals(node.getModuleId())) {
@@ -1099,9 +1100,11 @@ private Collection computeConflicts(VisitNode node, VisitNode ancestor, String c
              * (otherwise previous block would have been reached). We can compute conflicts based on
              * the parent direct dependencies in current root module conf.
              */
-            Collection parentDepIvyNodes = node.getParent().getNode()
-                        .getDependencies(node.getRootModuleConf(), 
-                            new String[] {node.getParentConf()});
+            VisitNode parent = node.getParent();
+            Collection parentDepIvyNodes = parent.getNode().getDependencies(
+                node.getRootModuleConf(), 
+                parent.getNode().getConfigurations(node.getRootModuleConf()), 
+                parent.getRequestedConf());
             for (Iterator it = parentDepIvyNodes.iterator(); it.hasNext();) {
                 IvyNode parentDep = (IvyNode) it.next();
                 if (parentDep.getModuleId().equals(node.getModuleId())) {
diff --git a/test/java/org/apache/ivy/core/resolve/ResolveTest.java b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
index a889d1257..45afbb0c4 100644
--- a/test/java/org/apache/ivy/core/resolve/ResolveTest.java
+++ b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
@@ -110,7 +110,7 @@ protected void tearDown() throws Exception {
         FileUtil.forceDelete(deliverDir);
         FileUtil.forceDelete(workDir);
     }
-
+    
     public void testResolveWithRetainingArtifactName() throws Exception {
         ((DefaultRepositoryCacheManager) ivy.getSettings().getDefaultRepositoryCacheManager())
                 .setArtifactPattern(ivy.substitute("[module]/[originalname].[ext]"));
@@ -3430,6 +3430,21 @@ public void testIVY999() throws Exception {
         assertFalse(modRevIds.contains(ModuleRevisionId.newInstance("junit", "junit", "3.8")));
     }
 
+    public void testIVY1366() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-1366/ivysettings.xml"));
+
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-1366/ivy.xml"), 
+                new ResolveOptions().setConfs(new String[] {"runtime"}));
+        assertFalse(report.hasError());
+        
+        List artifacts = report.getArtifacts();
+        assertEquals(3, artifacts.size());
+        assertEquals("test#a;1!a.jar", artifacts.get(0).toString());
+        assertEquals("test#c;1!c.jar", artifacts.get(1).toString());
+        assertEquals("test#b;1!b.jar", artifacts.get(2).toString());
+    }
+    
     public void testBadFiles() throws Exception {
         Ivy ivy = new Ivy();
         ivy.configure(new File("test/repositories/badfile/ivysettings.xml"));
diff --git a/test/repositories/IVY-1366/a/1/ivy.xml b/test/repositories/IVY-1366/a/1/ivy.xml
new file mode 100644
index 000000000..c5f4c3627
--- /dev/null
+++ b/test/repositories/IVY-1366/a/1/ivy.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="2.0">
+	<info organisation="test" module="a" revision="1" status="release"/>
+	<configurations>
+        <conf name="runtime" extends="requires, compile" transitive="true" />
+        <conf name="requires" />
+        <conf name="compile" />
+    </configurations>
+    <publications>
+		<artifact name="a" type="jar" conf="compile"/>
+	</publications>
+</ivy-module>
diff --git a/test/repositories/IVY-1366/a/1/jars/a-1.jar b/test/repositories/IVY-1366/a/1/jars/a-1.jar
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-1366/b/1/ivy.xml b/test/repositories/IVY-1366/b/1/ivy.xml
new file mode 100644
index 000000000..17495b709
--- /dev/null
+++ b/test/repositories/IVY-1366/b/1/ivy.xml
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="2.0">
+	<info organisation="test" module="b" revision="1" status="release"/>
+	<configurations>
+        <conf name="runtime" extends="requires, compile" transitive="true" />
+        <conf name="requires" />
+        <conf name="compile"/>
+    </configurations>
+    <publications>
+		<artifact name="b" type="jar" conf="compile"/>
+	</publications>
+</ivy-module>
diff --git a/test/repositories/IVY-1366/b/1/jars/b-1.jar b/test/repositories/IVY-1366/b/1/jars/b-1.jar
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-1366/c/1/ivy.xml b/test/repositories/IVY-1366/c/1/ivy.xml
new file mode 100644
index 000000000..1b99f2f45
--- /dev/null
+++ b/test/repositories/IVY-1366/c/1/ivy.xml
@@ -0,0 +1,34 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="2.0">
+	<info organisation="test" module="c" revision="1" status="release"/>
+	<configurations>
+        <conf name="runtime" extends="requires, compile" transitive="true" />
+        <conf name="requires" />
+        <conf name="compile"/>
+    </configurations>
+    <publications>
+		<artifact name="c" type="jar" conf="compile"/>
+	</publications>
+	<dependencies>
+		<dependency org="test" name="a" rev="1" conf="requires->#"/>
+		<dependency org="test" name="b" rev="1" conf="requires->#"/>
+	</dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-1366/c/1/jars/c-1.jar b/test/repositories/IVY-1366/c/1/jars/c-1.jar
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-1366/ivy.xml b/test/repositories/IVY-1366/ivy.xml
new file mode 100644
index 000000000..407367696
--- /dev/null
+++ b/test/repositories/IVY-1366/ivy.xml
@@ -0,0 +1,34 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="2.0">
+<info
+	organisation="test"
+	module="test"/>
+	<configurations>
+		<conf name="runtime" extends="requires, compile" transitive="true"/>
+		<conf name="requires" />
+        <conf name="compile"/>
+	</configurations>
+	<dependencies>
+	   <dependency org="test" name="a" rev="1" conf="requires->#"/>
+	   <dependency org="test" name="c" rev="1" conf="requires->#"/>
+        
+	</dependencies>
+</ivy-module>
+
diff --git a/test/repositories/IVY-1366/ivysettings.xml b/test/repositories/IVY-1366/ivysettings.xml
new file mode 100644
index 000000000..15f5baf79
--- /dev/null
+++ b/test/repositories/IVY-1366/ivysettings.xml
@@ -0,0 +1,27 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivysettings>
+    <settings defaultResolver="test"/>
+    <resolvers>
+        <filesystem name="test">
+            <ivy pattern="${ivy.settings.dir}/[module]/[revision]/ivy.xml" />
+            <artifact pattern="${ivy.settings.dir}/[module]/[revision]/[type]s/[artifact]-[revision].[ext]" />
+        </filesystem>
+    </resolvers>
+</ivysettings>
\ No newline at end of file
