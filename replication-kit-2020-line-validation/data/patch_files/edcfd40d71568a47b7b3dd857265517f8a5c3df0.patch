From edcfd40d71568a47b7b3dd857265517f8a5c3df0 Mon Sep 17 00:00:00 2001
From: Henri Yandell <bayard@apache.org>
Date: Wed, 16 Mar 2011 03:53:22 +0000
Subject: [PATCH] Fixing LANG-685 so that EqualsBuilder synchronizes on itself
 and not HashCodeBuilder

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/lang/trunk@1082042 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/commons/lang3/builder/EqualsBuilder.java  | 4 ++--
 src/site/changes/changes.xml                                  | 1 +
 src/site/xdoc/upgradeto3_0.xml                                | 1 +
 3 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/lang3/builder/EqualsBuilder.java b/src/main/java/org/apache/commons/lang3/builder/EqualsBuilder.java
index 156106a45ff..3e4146963f6 100644
--- a/src/main/java/org/apache/commons/lang3/builder/EqualsBuilder.java
+++ b/src/main/java/org/apache/commons/lang3/builder/EqualsBuilder.java
@@ -175,7 +175,7 @@ static boolean isRegistered(Object lhs, Object rhs) {
      * @param rhs the other object to register
      */
     static void register(Object lhs, Object rhs) {
-        synchronized (HashCodeBuilder.class) {
+        synchronized (EqualsBuilder.class) {
             if (getRegistry() == null) {
                 REGISTRY.set(new HashSet<Pair<IDKey, IDKey>>());
             }
@@ -203,7 +203,7 @@ static void unregister(Object lhs, Object rhs) {
         if (registry != null) {
             Pair<IDKey, IDKey> pair = getRegisterPair(lhs, rhs);
             registry.remove(pair);
-            synchronized (HashCodeBuilder.class) {
+            synchronized (EqualsBuilder.class) {
                 //read again
                 registry = getRegistry();
                 if (registry != null && registry.isEmpty()) {
diff --git a/src/site/changes/changes.xml b/src/site/changes/changes.xml
index bfba3c75e53..9e63995354c 100644
--- a/src/site/changes/changes.xml
+++ b/src/site/changes/changes.xml
@@ -22,6 +22,7 @@
   <body>
 
   <release version="3.0" date="Unreleased" description="Backwards incompatible update of Commons Lang to Java 5">
+    <action type="fix" issue="LANG-685">EqualsBuilder synchronizes on HashCodeBuilder</action>
     <action type="fix" issue="LANG-428">StringUtils.isAlpha, isAlphanumeric and isNumeric now return false for ""</action>
     <action type="add" issue="LANG-678">Add support for ConcurrentMap.putIfAbsent()</action>
     <action type="add" issue="LANG-676">Documented potential NPE if auto-boxing occurs for some BooleanUtils methods</action>
diff --git a/src/site/xdoc/upgradeto3_0.xml b/src/site/xdoc/upgradeto3_0.xml
index 927c0a1ee98..c28a324c71e 100644
--- a/src/site/xdoc/upgradeto3_0.xml
+++ b/src/site/xdoc/upgradeto3_0.xml
@@ -157,6 +157,7 @@ BUG FIXES IN 3.0
     [LANG-664] NumberUtils.isNumber(String) is not right when the String is "1.1L"
     [LANG-672] Doc bug in DateUtils#ceiling
     [LANG-677] DateUtils.isSameLocalTime compares using 12 hour clock and not 24 hour
+    [LANG-685] EqualsBuilder synchronizes on HashCodeBuilder.
 
 </source>
 </p>
