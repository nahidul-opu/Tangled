From 9c621e90fe8691d5632d2065a732e67033a4004e Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 30 Sep 2005 13:55:01 +0000
Subject: [PATCH] FIX: better root configuration isolation (IVY-84)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484042 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |   1 +
 src/java/fr/jayasoft/ivy/Ivy.java             |   3 +-
 src/java/fr/jayasoft/ivy/IvyNode.java         |   7 +
 test/java/fr/jayasoft/ivy/ResolveTest.java    | 169 ++++++++++++++++++
 test/repositories/IVY-84/ivyconf.xml          |  12 ++
 .../IVY-84/repo/test/a/1.0.1/a-1.0.1.txt      |   0
 .../IVY-84/repo/test/a/1.0.1/a-bt-1.0.1.txt   |   0
 .../IVY-84/repo/test/a/1.0.2/a-1.0.2.txt      |   0
 .../IVY-84/repo/test/a/1.0.2/a-bt-1.0.2.txt   |   0
 .../IVY-84/repo/test/a/ivy-1.0.1.xml          |  15 ++
 .../IVY-84/repo/test/a/ivy-1.0.2.xml          |  15 ++
 .../IVY-84/repo/test/b/1.0.1/b-1.0.1.txt      |   0
 .../IVY-84/repo/test/b/1.0.1/b-bt-1.0.1.txt   |   0
 .../IVY-84/repo/test/b/1.0.2/b-1.0.2.txt      |   0
 .../IVY-84/repo/test/b/1.0.2/b-bt-1.0.2.txt   |   0
 .../IVY-84/repo/test/b/ivy-1.0.1.xml          |  18 ++
 .../IVY-84/repo/test/b/ivy-1.0.2.xml          |  18 ++
 .../IVY-84/repo/test/c/1.0.1/c-1.0.1.txt      |   0
 .../IVY-84/repo/test/c/1.0.1/c-bt-1.0.1.txt   |   0
 .../IVY-84/repo/test/c/1.0.2/c-1.0.2.txt      |   0
 .../IVY-84/repo/test/c/1.0.2/c-bt-1.0.2.txt   |   0
 .../IVY-84/repo/test/c/ivy-1.0.1.xml          |  18 ++
 .../IVY-84/repo/test/c/ivy-1.0.2.xml          |  18 ++
 test/repositories/IVY-84/tests/1/ivy.xml      |  18 ++
 test/repositories/IVY-84/tests/2/ivy.xml      |  18 ++
 test/repositories/IVY-84/tests/3/ivy.xml      |  18 ++
 test/repositories/IVY-84/tests/4/ivy.xml      |  18 ++
 test/repositories/IVY-84/tests/5/ivy.xml      |  18 ++
 test/repositories/IVY-84/tests/6/ivy.xml      |  18 ++
 test/repositories/IVY-84/tests/7/ivy.xml      |  18 ++
 30 files changed, 419 insertions(+), 1 deletion(-)
 create mode 100644 test/repositories/IVY-84/ivyconf.xml
 create mode 100644 test/repositories/IVY-84/repo/test/a/1.0.1/a-1.0.1.txt
 create mode 100644 test/repositories/IVY-84/repo/test/a/1.0.1/a-bt-1.0.1.txt
 create mode 100644 test/repositories/IVY-84/repo/test/a/1.0.2/a-1.0.2.txt
 create mode 100644 test/repositories/IVY-84/repo/test/a/1.0.2/a-bt-1.0.2.txt
 create mode 100644 test/repositories/IVY-84/repo/test/a/ivy-1.0.1.xml
 create mode 100644 test/repositories/IVY-84/repo/test/a/ivy-1.0.2.xml
 create mode 100644 test/repositories/IVY-84/repo/test/b/1.0.1/b-1.0.1.txt
 create mode 100644 test/repositories/IVY-84/repo/test/b/1.0.1/b-bt-1.0.1.txt
 create mode 100644 test/repositories/IVY-84/repo/test/b/1.0.2/b-1.0.2.txt
 create mode 100644 test/repositories/IVY-84/repo/test/b/1.0.2/b-bt-1.0.2.txt
 create mode 100644 test/repositories/IVY-84/repo/test/b/ivy-1.0.1.xml
 create mode 100644 test/repositories/IVY-84/repo/test/b/ivy-1.0.2.xml
 create mode 100644 test/repositories/IVY-84/repo/test/c/1.0.1/c-1.0.1.txt
 create mode 100644 test/repositories/IVY-84/repo/test/c/1.0.1/c-bt-1.0.1.txt
 create mode 100644 test/repositories/IVY-84/repo/test/c/1.0.2/c-1.0.2.txt
 create mode 100644 test/repositories/IVY-84/repo/test/c/1.0.2/c-bt-1.0.2.txt
 create mode 100644 test/repositories/IVY-84/repo/test/c/ivy-1.0.1.xml
 create mode 100644 test/repositories/IVY-84/repo/test/c/ivy-1.0.2.xml
 create mode 100644 test/repositories/IVY-84/tests/1/ivy.xml
 create mode 100644 test/repositories/IVY-84/tests/2/ivy.xml
 create mode 100644 test/repositories/IVY-84/tests/3/ivy.xml
 create mode 100644 test/repositories/IVY-84/tests/4/ivy.xml
 create mode 100644 test/repositories/IVY-84/tests/5/ivy.xml
 create mode 100644 test/repositories/IVY-84/tests/6/ivy.xml
 create mode 100644 test/repositories/IVY-84/tests/7/ivy.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 3e6fc6371..da6f1cfe4 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -1,3 +1,4 @@
+- FIX: root module configurations isolation bug fixed (IVY-84)
 - FIX: changed the place where ivy stores master ivy files in cache to not overlap
        with dependencies one (IVY-85)
 - FIX: bug in ResourceHelper didn't let override resource easily (IVY-80)
diff --git a/src/java/fr/jayasoft/ivy/Ivy.java b/src/java/fr/jayasoft/ivy/Ivy.java
index ea5191838..c730ab29b 100644
--- a/src/java/fr/jayasoft/ivy/Ivy.java
+++ b/src/java/fr/jayasoft/ivy/Ivy.java
@@ -839,6 +839,7 @@ public IvyNode[] getDependencies(ModuleDescriptor md, String[] confs, File cache
     
     private void fetchDependencies(IvyNode node, String conf, boolean shouldBePublic) {
         resolveConflict(node, node.getParent(), Collections.EMPTY_SET);
+        
         if (node.loadData(conf)) {
             node = node.getRealNode(); // if data loading discarded the node, get the real one
             resolveConflict(node, node.getParent(), Collections.EMPTY_SET);
@@ -905,7 +906,7 @@ private void doFetchDependencies(IvyNode node, String conf, boolean shouldBePubl
 
 
     private void resolveConflict(IvyNode node, IvyNode parent, Collection toevict) {
-        if (parent == null) {
+        if (parent == null || node == parent) {
             return;
         }
         if (node.getId().equals(node.getResolvedId()) && parent.getResolvedRevisions(node.getModuleId(), node.getRootModuleConf()).contains(node.getId())) {
diff --git a/src/java/fr/jayasoft/ivy/IvyNode.java b/src/java/fr/jayasoft/ivy/IvyNode.java
index dede58a28..96de6c768 100644
--- a/src/java/fr/jayasoft/ivy/IvyNode.java
+++ b/src/java/fr/jayasoft/ivy/IvyNode.java
@@ -969,6 +969,9 @@ public String getRootModuleConf() {
     
 
     public void setRootModuleConf(String rootModuleConf) {
+        if (_rootModuleConf != null) {
+            _confsToFetch.clear(); // we change of root module conf => we discard all confs to fetch
+        }
         if (rootModuleConf != null && rootModuleConf.equals(_rootModuleConf)) {
             _selected.put(new ModuleIdConf(_id.getModuleId(), rootModuleConf), Collections.singleton(this));
         }
@@ -1002,4 +1005,8 @@ private boolean isCircular(IvyNode node) {
         }
         return isCircular;
     }
+
+    public boolean isFetched(String conf) {
+        return _fetchedConfigurations.contains(conf);
+    }
 }
diff --git a/test/java/fr/jayasoft/ivy/ResolveTest.java b/test/java/fr/jayasoft/ivy/ResolveTest.java
index 843310500..7cff71be5 100644
--- a/test/java/fr/jayasoft/ivy/ResolveTest.java
+++ b/test/java/fr/jayasoft/ivy/ResolveTest.java
@@ -6,6 +6,7 @@
 package fr.jayasoft.ivy;
 
 import java.io.File;
+import java.util.Date;
 
 import javax.xml.parsers.SAXParser;
 import javax.xml.parsers.SAXParserFactory;
@@ -17,6 +18,7 @@
 import org.xml.sax.SAXException;
 import org.xml.sax.helpers.DefaultHandler;
 
+import fr.jayasoft.ivy.report.ArtifactDownloadReport;
 import fr.jayasoft.ivy.report.ConfigurationResolveReport;
 import fr.jayasoft.ivy.report.ResolveReport;
 import fr.jayasoft.ivy.report.XmlReportOutputter;
@@ -819,4 +821,171 @@ public void testResolverDirectlyUsingCache() throws Exception {
         assertTrue(depIvyFileInCache.exists());
         assertTrue(!ivy.getArchiveFileInCache(_cache, "org1", "mod1.1", "1.0", "mod1.1", "jar", "jar").exists());
     }
+    
+    ///////////////////////////////////////////////////////////
+    // here comes a series of test provided by Chris Rudd
+    // about configuration mapping and eviction
+    ///////////////////////////////////////////////////////////
+    
+    public void testConfigurationMapping1() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/1/ivy.xml").toURL(),
+                null, new String[] {"*"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("default");
+        
+        assertContainsArtifact("test", "a", "1.0.2", "a", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.2", "a-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.2", "b", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.2", "b-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.2", "c", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.2", "c-bt", "txt", "txt", conf);        
+    }
+
+    public void testConfigurationMapping2() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/2/ivy.xml").toURL(),
+                null, new String[] {"*"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("default");
+        
+        assertContainsArtifact("test", "a", "1.0.1", "a", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.1", "a-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.1", "b", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.1", "b-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.1", "c", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.1", "c-bt", "txt", "txt", conf);        
+    }
+
+    public void testConfigurationMapping3() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/3/ivy.xml").toURL(),
+                null, new String[] {"buildtime"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("buildtime");
+        
+        assertContainsArtifact("test", "a", "1.0.2", "a-bt", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.2", "a", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.1", "b-bt", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.1", "b", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.1", "c-bt", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.1", "c", "txt", "txt", conf);        
+    }
+
+    public void testConfigurationMapping4() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/4/ivy.xml").toURL(),
+                null, new String[] {"default"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("default");
+        
+        assertContainsArtifact("test", "a", "1.0.2", "a", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.2", "a-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.1", "b", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.1", "b-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.1", "c", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.1", "c-bt", "txt", "txt", conf);        
+    }
+
+    public void testConfigurationMapping5() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/5/ivy.xml").toURL(),
+                null, new String[] {"*"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("default");
+        
+        assertContainsArtifact("test", "a", "1.0.2", "a", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.2", "a-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.1", "b", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.1", "b-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.1", "c", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.1", "c-bt", "txt", "txt", conf);        
+    }
+
+    public void testConfigurationMapping6() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/6/ivy.xml").toURL(),
+                null, new String[] {"default", "buildtime"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("default");
+        
+        assertContainsArtifact("test", "a", "1.0.2", "a", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.2", "a-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.1", "b", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.1", "b-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.1", "c", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.1", "c-bt", "txt", "txt", conf);        
+    }
+
+    public void testConfigurationMapping7() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-84/ivyconf.xml"));
+        ResolveReport report = ivy.resolve(new File("test/repositories/IVY-84/tests/7/ivy.xml").toURL(),
+                null, new String[] {"buildtime", "default"}, _cache, null, true);
+        
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        ConfigurationResolveReport conf = report.getConfigurationReport("default");
+        
+        assertContainsArtifact("test", "a", "1.0.2", "a", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "a", "1.0.2", "a-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "b", "1.0.1", "b", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "b", "1.0.1", "b-bt", "txt", "txt", conf);        
+        assertContainsArtifact("test", "c", "1.0.1", "c", "txt", "txt", conf);
+        assertDoesntContainArtifact("test", "c", "1.0.1", "c-bt", "txt", "txt", conf);        
+    }
+
+    ////////////////////////////////////////////////////////////
+    // helper methods to ease the tests
+    ////////////////////////////////////////////////////////////
+    
+    private void assertContainsArtifact(String org, String module, String rev, String artName, String type, String ext, ConfigurationResolveReport conf) {
+        Artifact art = getArtifact(org, module, rev, artName, type, ext);
+        if (!containsArtifact(art, conf.getDownloadedArtifactsReports())) {
+            fail("artifact "+art+" should be part of "+conf.getConfiguration()+" from "+conf.getModuleDescriptor().getModuleRevisionId());
+        }        
+    }
+    
+    private void assertDoesntContainArtifact(String org, String module, String rev, String artName, String type, String ext, ConfigurationResolveReport conf) {
+        Artifact art = getArtifact(org, module, rev, artName, type, ext);
+        if (containsArtifact(art, conf.getDownloadedArtifactsReports())) {
+            fail("artifact "+art+" should NOT be part of "+conf.getConfiguration()+" from "+conf.getModuleDescriptor().getModuleRevisionId());
+        }        
+    }
+
+    private Artifact getArtifact(String org, String module, String rev, String artName, String type, String ext) {
+         return new DefaultArtifact(ModuleRevisionId.newInstance(org, module, rev), new Date(), artName, type, ext);
+    }
+
+    private boolean containsArtifact(Artifact art, ArtifactDownloadReport[] adr) {
+        for (int i = 0; i < adr.length; i++) {
+            Artifact artifact = adr[i].getArtifact();
+            if (artifact.getModuleRevisionId().equals(art.getModuleRevisionId())
+                    && artifact.getName().equals(art.getName())
+                    && artifact.getType().equals(art.getType())
+                    && artifact.getExt().equals(art.getExt())) {
+                return true;
+            }
+        }
+        return false;
+    }
+
 }
diff --git a/test/repositories/IVY-84/ivyconf.xml b/test/repositories/IVY-84/ivyconf.xml
new file mode 100644
index 000000000..996b00a37
--- /dev/null
+++ b/test/repositories/IVY-84/ivyconf.xml
@@ -0,0 +1,12 @@
+<ivyconf>
+	<conf defaultResolver="LOCAL"/>
+	<latest-strategies>latest-revision</latest-strategies>
+	<resolvers>
+	    <filesystem name="LOCAL">
+		<artifact pattern="${ivy.conf.dir}/repo/[organisation]/[module]/[revision]/[artifact]-[revision].[ext]" />
+		<ivy pattern="${ivy.conf.dir}/repo/[organisation]/[module]/ivy-[revision].xml" />
+	    </filesystem>
+	</resolvers>
+	<modules>
+	</modules>
+</ivyconf>
diff --git a/test/repositories/IVY-84/repo/test/a/1.0.1/a-1.0.1.txt b/test/repositories/IVY-84/repo/test/a/1.0.1/a-1.0.1.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/a/1.0.1/a-bt-1.0.1.txt b/test/repositories/IVY-84/repo/test/a/1.0.1/a-bt-1.0.1.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/a/1.0.2/a-1.0.2.txt b/test/repositories/IVY-84/repo/test/a/1.0.2/a-1.0.2.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/a/1.0.2/a-bt-1.0.2.txt b/test/repositories/IVY-84/repo/test/a/1.0.2/a-bt-1.0.2.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/a/ivy-1.0.1.xml b/test/repositories/IVY-84/repo/test/a/ivy-1.0.1.xml
new file mode 100644
index 000000000..f1bcfa316
--- /dev/null
+++ b/test/repositories/IVY-84/repo/test/a/ivy-1.0.1.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="a" revision="1.0.1" status="integration" publication="20050926033111"/>
+    <configurations>
+		<conf name="default"/>
+		<conf name="global" extends="default" visibility="private"/>
+		<conf name="buildtime" visibility="private"/>
+		<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+	<artifact name="a" type="txt" conf="default"/>
+	<artifact name="a-bt" type="txt" conf="buildtime"/>
+    </publications>
+</ivy-module>
\ No newline at end of file
diff --git a/test/repositories/IVY-84/repo/test/a/ivy-1.0.2.xml b/test/repositories/IVY-84/repo/test/a/ivy-1.0.2.xml
new file mode 100644
index 000000000..d877ba63b
--- /dev/null
+++ b/test/repositories/IVY-84/repo/test/a/ivy-1.0.2.xml
@@ -0,0 +1,15 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="a" revision="1.0.2" status="integration" publication="20050926033111"/>
+    <configurations>
+		<conf name="default"/>
+		<conf name="global" extends="default" visibility="private"/>
+		<conf name="buildtime" visibility="private"/>
+		<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+	<artifact name="a" type="txt" conf="default"/>
+	<artifact name="a-bt" type="txt" conf="buildtime"/>
+    </publications>
+</ivy-module>
\ No newline at end of file
diff --git a/test/repositories/IVY-84/repo/test/b/1.0.1/b-1.0.1.txt b/test/repositories/IVY-84/repo/test/b/1.0.1/b-1.0.1.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/b/1.0.1/b-bt-1.0.1.txt b/test/repositories/IVY-84/repo/test/b/1.0.1/b-bt-1.0.1.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/b/1.0.2/b-1.0.2.txt b/test/repositories/IVY-84/repo/test/b/1.0.2/b-1.0.2.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/b/1.0.2/b-bt-1.0.2.txt b/test/repositories/IVY-84/repo/test/b/1.0.2/b-bt-1.0.2.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/b/ivy-1.0.1.xml b/test/repositories/IVY-84/repo/test/b/ivy-1.0.1.xml
new file mode 100644
index 000000000..a8bd572fd
--- /dev/null
+++ b/test/repositories/IVY-84/repo/test/b/ivy-1.0.1.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="b" revision="1.0.1" status="integration" publication="20050926033111"/>
+    <configurations>
+		<conf name="default"/>
+		<conf name="global" extends="default" visibility="private"/>
+		<conf name="buildtime" visibility="private"/>
+		<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+	<artifact name="b" type="txt" conf="default"/>
+	<artifact name="b-bt" type="txt" conf="buildtime"/>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
\ No newline at end of file
diff --git a/test/repositories/IVY-84/repo/test/b/ivy-1.0.2.xml b/test/repositories/IVY-84/repo/test/b/ivy-1.0.2.xml
new file mode 100644
index 000000000..181bef410
--- /dev/null
+++ b/test/repositories/IVY-84/repo/test/b/ivy-1.0.2.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="b" revision="1.0.2" status="integration" publication="20050926033111"/>
+    <configurations>
+		<conf name="default"/>
+		<conf name="global" extends="default" visibility="private"/>
+		<conf name="buildtime" visibility="private"/>
+		<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+	<artifact name="b" type="txt" conf="default"/>
+	<artifact name="b-bt" type="txt" conf="buildtime"/>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="1.0.2"/>
+   </dependencies>
+</ivy-module>
\ No newline at end of file
diff --git a/test/repositories/IVY-84/repo/test/c/1.0.1/c-1.0.1.txt b/test/repositories/IVY-84/repo/test/c/1.0.1/c-1.0.1.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/c/1.0.1/c-bt-1.0.1.txt b/test/repositories/IVY-84/repo/test/c/1.0.1/c-bt-1.0.1.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/c/1.0.2/c-1.0.2.txt b/test/repositories/IVY-84/repo/test/c/1.0.2/c-1.0.2.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/c/1.0.2/c-bt-1.0.2.txt b/test/repositories/IVY-84/repo/test/c/1.0.2/c-bt-1.0.2.txt
new file mode 100644
index 000000000..e69de29bb
diff --git a/test/repositories/IVY-84/repo/test/c/ivy-1.0.1.xml b/test/repositories/IVY-84/repo/test/c/ivy-1.0.1.xml
new file mode 100644
index 000000000..328bd642b
--- /dev/null
+++ b/test/repositories/IVY-84/repo/test/c/ivy-1.0.1.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="c" revision="1.0.1" status="integration" publication="20050926033111"/>
+    <configurations>
+		<conf name="default"/>
+		<conf name="global" extends="default" visibility="private"/>
+		<conf name="buildtime" visibility="private"/>
+		<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+	<artifact name="c" type="txt" conf="default"/>
+	<artifact name="c-bt" type="txt" conf="buildtime"/>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
\ No newline at end of file
diff --git a/test/repositories/IVY-84/repo/test/c/ivy-1.0.2.xml b/test/repositories/IVY-84/repo/test/c/ivy-1.0.2.xml
new file mode 100644
index 000000000..7745b65d8
--- /dev/null
+++ b/test/repositories/IVY-84/repo/test/c/ivy-1.0.2.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="c" revision="1.0.2" status="integration" publication="20050926033111"/>
+    <configurations>
+		<conf name="default"/>
+		<conf name="global" extends="default" visibility="private"/>
+		<conf name="buildtime" visibility="private"/>
+		<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+	<artifact name="c" type="txt" conf="default"/>
+	<artifact name="c-bt" type="txt" conf="buildtime"/>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="1.0.2"/>
+   </dependencies>
+</ivy-module>
\ No newline at end of file
diff --git a/test/repositories/IVY-84/tests/1/ivy.xml b/test/repositories/IVY-84/tests/1/ivy.xml
new file mode 100644
index 000000000..0ad6ca19e
--- /dev/null
+++ b/test/repositories/IVY-84/tests/1/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-1"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="latest.integration"/>
+	<dependency org="test" name="b" rev="latest.integration"/>
+	<dependency org="test" name="c" rev="latest.integration"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-84/tests/2/ivy.xml b/test/repositories/IVY-84/tests/2/ivy.xml
new file mode 100644
index 000000000..af8fc1352
--- /dev/null
+++ b/test/repositories/IVY-84/tests/2/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-2"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="1.0.1"/>
+	<dependency org="test" name="b" rev="1.0.1"/>
+	<dependency org="test" name="c" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-84/tests/3/ivy.xml b/test/repositories/IVY-84/tests/3/ivy.xml
new file mode 100644
index 000000000..9d8120977
--- /dev/null
+++ b/test/repositories/IVY-84/tests/3/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-3"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="latest.integration"/>
+	<dependency org="test" name="b" rev="1.0.1"/>
+	<dependency org="test" name="c" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-84/tests/4/ivy.xml b/test/repositories/IVY-84/tests/4/ivy.xml
new file mode 100644
index 000000000..60c17dc9f
--- /dev/null
+++ b/test/repositories/IVY-84/tests/4/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-4"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="latest.integration"/>
+	<dependency org="test" name="b" rev="1.0.1"/>
+	<dependency org="test" name="c" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-84/tests/5/ivy.xml b/test/repositories/IVY-84/tests/5/ivy.xml
new file mode 100644
index 000000000..2132ab18a
--- /dev/null
+++ b/test/repositories/IVY-84/tests/5/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-5"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="latest.integration"/>
+	<dependency org="test" name="b" rev="1.0.1"/>
+	<dependency org="test" name="c" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-84/tests/6/ivy.xml b/test/repositories/IVY-84/tests/6/ivy.xml
new file mode 100644
index 000000000..b8a5d3311
--- /dev/null
+++ b/test/repositories/IVY-84/tests/6/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-6"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="latest.integration"/>
+	<dependency org="test" name="b" rev="1.0.1"/>
+	<dependency org="test" name="c" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
diff --git a/test/repositories/IVY-84/tests/7/ivy.xml b/test/repositories/IVY-84/tests/7/ivy.xml
new file mode 100644
index 000000000..b124169d6
--- /dev/null
+++ b/test/repositories/IVY-84/tests/7/ivy.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="ISO-8859-1"?>
+<?xml-stylesheet type="text/xsl" href="/ivy/ivy-doc.xsl"?>
+<ivy-module version="1.0">
+    <info organisation="test" module="test-7"/>
+    <configurations>
+	<conf name="default"/>
+	<conf name="global" extends="default" visibility="private"/>
+	<conf name="buildtime" visibility="private"/>
+	<conf name="test" visibility="private"/>
+    </configurations>    
+    <publications>
+    </publications>
+    <dependencies defaultconf="default;buildtime">
+	<dependency org="test" name="a" rev="latest.integration"/>
+	<dependency org="test" name="b" rev="1.0.1"/>
+	<dependency org="test" name="c" rev="1.0.1"/>
+   </dependencies>
+</ivy-module>
