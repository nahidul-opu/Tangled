From 36335e3face4b866c7bb88b39fa8a99959d0a907 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Fri, 5 Feb 2016 18:30:46 +0100
Subject: [PATCH] COMPRESS-334 ArArchiveInputStream fails for BSD long names

---
 src/changes/changes.xml                                      | 5 +++++
 .../commons/compress/archivers/ar/ArArchiveInputStream.java  | 1 +
 2 files changed, 6 insertions(+)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 80f49d0ab40..a5130264810 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -44,6 +44,11 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
     <release version="1.11" date="not released, yet"
              description="Release 1.11">
+      <action issue="COMPRESS-334" type="fix" date="2016-02-05"
+              due-to="Jeremy Gustie">
+        ArArchiveInputStream failed to read past the first entry when
+        BSD long names have been used.
+      </action>
       <action issue="COMPRESS-333" type="fix" date="2016-02-03" due-to="Dawid Weiss">
         Added buffering for random access which speeds up 7Z support.
       </action>
diff --git a/src/main/java/org/apache/commons/compress/archivers/ar/ArArchiveInputStream.java b/src/main/java/org/apache/commons/compress/archivers/ar/ArArchiveInputStream.java
index aeb3a157e7f..99d90e3f88b 100644
--- a/src/main/java/org/apache/commons/compress/archivers/ar/ArArchiveInputStream.java
+++ b/src/main/java/org/apache/commons/compress/archivers/ar/ArArchiveInputStream.java
@@ -347,6 +347,7 @@ private String getBSDLongName(String bsdLongName) throws IOException {
         byte[] name = new byte[nameLen];
         int read = IOUtils.readFully(input, name);
         count(read);
+        offset += read > 0 ? read : 0;
         if (read != nameLen) {
             throw new EOFException();
         }
