From ec6dbad43a1f82f61ec6dbd43fd7766e92762e52 Mon Sep 17 00:00:00 2001
From: Luc Maisonobe <luc@apache.org>
Date: Thu, 5 May 2011 19:41:28 +0000
Subject: [PATCH] Fixed conversion problems to/from 0 in Decimal Floating Point
 (Dfp) class.

JIRA: MATH-567

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/math/trunk@1099938 13f79535-47bb-0310-9956-ffa450edef68
---
 src/main/java/org/apache/commons/math/dfp/Dfp.java    | 11 +++++++++--
 src/site/xdoc/changes.xml                             |  3 +++
 .../java/org/apache/commons/math/dfp/DfpTest.java     | 11 +++++++++++
 3 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/math/dfp/Dfp.java b/src/main/java/org/apache/commons/math/dfp/Dfp.java
index 04e66132d0..54aabc411b 100644
--- a/src/main/java/org/apache/commons/math/dfp/Dfp.java
+++ b/src/main/java/org/apache/commons/math/dfp/Dfp.java
@@ -163,7 +163,7 @@ public class Dfp implements FieldElement<Dfp> {
     /** Mantissa. */
     protected int[] mant;
 
-    /** Sign bit: & for positive, -1 for negative. */
+    /** Sign bit: 1 for positive, -1 for negative. */
     protected byte sign;
 
     /** Exponent. */
@@ -269,6 +269,10 @@ protected Dfp(final DfpField field, double x) {
         if (exponent == -1023) {
             // Zero or sub-normal
             if (x == 0) {
+                // make sure 0 has the right sign
+                if ((bits & 0x8000000000000000L) != 0) {
+                    sign = -1;
+                }
                 return;
             }
 
@@ -2315,7 +2319,10 @@ public double toDouble() {
 
         Dfp y = this;
         boolean negate = false;
-        if (lessThan(getZero())) {
+        int cmp0 = compare(this, getZero());
+        if (cmp0 == 0) {
+            return sign < 0 ? -0.0 : +0.0;
+        } else if (cmp0 < 0) {
             y = negate();
             negate = true;
         }
diff --git a/src/site/xdoc/changes.xml b/src/site/xdoc/changes.xml
index 8f3901486b..dd5c56276a 100644
--- a/src/site/xdoc/changes.xml
+++ b/src/site/xdoc/changes.xml
@@ -52,6 +52,9 @@ The <action> type attribute can be add,update,fix,remove.
     If the output is not quite correct, check for invisible trailing spaces!
      -->
     <release version="3.0" date="TBD" description="TBD">
+      <action dev="luc" type="add" issue="MATH-567" due-to="Michel">
+        Fixed conversion problems to/from 0 in Decimal Floating Point (Dfp) class.
+      </action>
       <action dev="luc" type="fix" >
         Fixed initialization of multistep ODE integrators. Relying on the interpolation model
         of the starter integrator inside only one step was wrong. The model may have a too
diff --git a/src/test/java/org/apache/commons/math/dfp/DfpTest.java b/src/test/java/org/apache/commons/math/dfp/DfpTest.java
index db5c05ce5c..d8426c3aea 100644
--- a/src/test/java/org/apache/commons/math/dfp/DfpTest.java
+++ b/src/test/java/org/apache/commons/math/dfp/DfpTest.java
@@ -17,6 +17,8 @@
 
 package org.apache.commons.math.dfp;
 
+import org.apache.commons.math.util.FastMath;
+import org.apache.commons.math.util.MathUtils;
 import org.junit.After;
 import org.junit.Assert;
 import org.junit.Before;
@@ -1504,4 +1506,13 @@ public void testSqrt()
              DfpField.FLAG_INVALID, "Sqrt #9");
     }
 
+    @Test
+    public void testIssue567() {
+        DfpField field = new DfpField(100);
+        Assert.assertEquals(0.0, field.getZero().toDouble(), MathUtils.SAFE_MIN);
+        Assert.assertEquals(0.0, field.newDfp(0.0).toDouble(), MathUtils.SAFE_MIN);
+        Assert.assertEquals(-1, FastMath.copySign(1, field.newDfp(-0.0).toDouble()), MathUtils.EPSILON);
+        Assert.assertEquals(+1, FastMath.copySign(1, field.newDfp(+0.0).toDouble()), MathUtils.EPSILON);
+    }
+
 }
