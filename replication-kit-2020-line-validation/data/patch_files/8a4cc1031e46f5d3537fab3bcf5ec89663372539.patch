From 8a4cc1031e46f5d3537fab3bcf5ec89663372539 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 21 Sep 2007 13:06:01 +0000
Subject: [PATCH] FIX: java.lang.IllegalArgumentException: Invalid uri when
 working with version ranges (IVY-390)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@578092 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                          |  1 +
 .../org/apache/ivy/util/url/HttpClientHandler.java   |  3 +++
 .../ivy/util/url/HttpclientURLHandlerTest.java       | 12 ++++++++++++
 3 files changed, 16 insertions(+)

diff --git a/CHANGES.txt b/CHANGES.txt
index 219034fc0..1228c68b9 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -51,6 +51,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 
    version in SVN
 =====================================
+- FIX: java.lang.IllegalArgumentException: Invalid uri when working with version ranges (IVY-390)
 - FIX: Ivy settings include -tag url attribute does not work correctly (IVY-601)
 - FIX: Static revision replacement is not working when a dynamic revision is evicted by a transitive dependency (IVY-603) (with contribution from Matthias Kilian)
 - FIX: NullPointerException whilst resolving transitive dependencies (IVY-590)
diff --git a/src/java/org/apache/ivy/util/url/HttpClientHandler.java b/src/java/org/apache/ivy/util/url/HttpClientHandler.java
index 762228581..214c10196 100644
--- a/src/java/org/apache/ivy/util/url/HttpClientHandler.java
+++ b/src/java/org/apache/ivy/util/url/HttpClientHandler.java
@@ -126,6 +126,9 @@ public URLInfo getURLInfo(URL url, int timeout) {
                 + "a proxy server that is not well configured.");
         } catch (IOException e) {
             Message.error("HttpClientHandler: " + e.getMessage() + " url=" + url);
+        } catch (IllegalArgumentException e) {
+            // thrown by HttpClient to indicate the URL is not valid, this happens for instance
+            // when trying to download a dynamic version (cfr IVY-390)
         } finally {
             if (head != null) {
                 head.releaseConnection();
diff --git a/test/java/org/apache/ivy/util/url/HttpclientURLHandlerTest.java b/test/java/org/apache/ivy/util/url/HttpclientURLHandlerTest.java
index 4ba876d35..e87b62ecf 100644
--- a/test/java/org/apache/ivy/util/url/HttpclientURLHandlerTest.java
+++ b/test/java/org/apache/ivy/util/url/HttpclientURLHandlerTest.java
@@ -19,6 +19,8 @@
 
 import java.net.URL;
 
+import org.apache.ivy.util.url.URLHandler.URLInfo;
+
 import junit.framework.TestCase;
 
 /**
@@ -31,4 +33,14 @@ public void testIsReachable() throws Exception {
         assertTrue(handler.isReachable(new URL("http://www.google.fr/")));
         assertFalse(handler.isReachable(new URL("http://www.google.fr/unknownpage.html")));
     }
+
+    public void testGetURLInfo() throws Exception {
+        // IVY-390
+        URLHandler handler = new HttpClientHandler();
+        URLInfo info = handler
+                .getURLInfo(new URL(
+                        "http://repo1.maven.org/maven2/commons-lang/commons-lang/[1.0,3.0[/commons-lang-[1.0,3.0[.pom"));
+        
+        assertEquals(URLHandler.UNAVAILABLE, info);
+    }
 }
