From 4cef5296135cf1a056f44158b00977239e4fc3ae Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 1 Mar 2012 17:18:00 +0000
Subject: [PATCH] IO-276 "FileUtils#deleteDirectoryOnExit(File)" does not work

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@1295683 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                  | 3 +++
 src/main/java/org/apache/commons/io/FileUtils.java       | 2 +-
 .../java/org/apache/commons/io/FileUtilsTestCase.java    | 9 +++++++++
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 360c1522e78..a9af0ac4925 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -40,6 +40,9 @@ The <action> type attribute can be add,update,fix,remove.
 
   <body>
     <release version="2.2" date="TBA">
+      <action dev="sebb" type="fix" issue="IO-276" due-to="nkami">
+        "FileUtils#deleteDirectoryOnExit(File)" does not work
+      </action>        
       <action dev="sebb" type="fix" issue="IO-273" due-to="sebb">
         BoundedInputStream.read() treats max differently from BoundedInputStream.read(byte[]...)
       </action>        
diff --git a/src/main/java/org/apache/commons/io/FileUtils.java b/src/main/java/org/apache/commons/io/FileUtils.java
index 0705a9406d8..62718328133 100644
--- a/src/main/java/org/apache/commons/io/FileUtils.java
+++ b/src/main/java/org/apache/commons/io/FileUtils.java
@@ -2061,10 +2061,10 @@ private static void deleteDirectoryOnExit(File directory) throws IOException {
             return;
         }
 
+        directory.deleteOnExit();
         if (!isSymlink(directory)) {
             cleanDirectoryOnExit(directory);
         }
-        directory.deleteOnExit();
     }
 
     /**
diff --git a/src/test/java/org/apache/commons/io/FileUtilsTestCase.java b/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
index cdafd1b52ff..035777b3afc 100644
--- a/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
+++ b/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
@@ -2254,6 +2254,15 @@ public void testMoveToDirectory_Errors() throws Exception {
         }
     }
 
+    public void testIO276() throws Exception {
+        File dir = new File("target", "IO276");
+        assertTrue(dir+" should not be present",dir.mkdirs());
+        File file = new File(dir,"IO276.txt");
+        assertTrue(file+" should not be present",file.createNewFile());
+        FileUtils.forceDeleteOnExit(dir); 
+        // If this does not work, test will fail next time (assuming target is not cleaned)
+    }
+
     /**
      * DirectoryWalker implementation that recursively lists all files and directories.
      */
