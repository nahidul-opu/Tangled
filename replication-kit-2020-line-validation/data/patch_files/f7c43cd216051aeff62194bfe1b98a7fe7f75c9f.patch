From f7c43cd216051aeff62194bfe1b98a7fe7f75c9f Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 10 Nov 2015 01:00:59 +0000
Subject: [PATCH] VALIDATOR-330 IBANCheckDigit.isValid() returns True for some
 invalid IBANs

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1713572 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                    | 3 +++
 .../validator/routines/checkdigit/IBANCheckDigit.java      | 4 ++++
 .../validator/routines/checkdigit/IBANCheckDigitTest.java  | 7 ++++++-
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 296b25425..f96ebac25 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -90,6 +90,9 @@ The dependencies for Validator have not changed since the 1.4 release.
 For the current list of dependencies, please see
 http://commons.apache.org/validator/dependencies.html
   ">
+    <action issue="VALIDATOR-330" type="fix" dev="sebb">
+    IBANCheckDigit.isValid() returns True for some invalid IBANs
+    </action>
     <action issue="VALIDATOR-380" type="fix" dev="sebb">
     UrlValidator does not allow for optional port digits
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java b/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java
index 3bcc9bfc4..e6234fde0 100644
--- a/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java
+++ b/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java
@@ -68,6 +68,10 @@ public boolean isValid(String code) {
         if (code == null || code.length() < 5) {
             return false;
         }
+        String check = code.substring(2,4);
+        if ("00".equals(check) || "01".equals(check) || "99".equals(check)) {
+            return false;
+        }
         try {
             int modulusResult = calculateModulus(code);
             return (modulusResult == 1);
diff --git a/src/test/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigitTest.java b/src/test/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigitTest.java
index 623954442..c6489f7a9 100644
--- a/src/test/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigitTest.java
+++ b/src/test/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigitTest.java
@@ -101,7 +101,12 @@ protected void setUp() throws Exception {
          *  https://intranet.birmingham.ac.uk/finance/documents/public/IBAN.pdf
          *  http://www.paymentscouncil.org.uk/resources_and_publications/ibans_in_europe/
          */
-        invalid = new String[] {"510007+47061BE63"};
+        invalid = new String[] {
+                "510007+47061BE63",
+                "IE01AIBK93118702569045",
+                "AA0000000000089",
+                "AA9900000000053",
+        };
         zeroSum = null;
         missingMessage = "Invalid Code length=0";
 
