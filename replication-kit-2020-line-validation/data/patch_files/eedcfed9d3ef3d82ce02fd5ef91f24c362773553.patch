From eedcfed9d3ef3d82ce02fd5ef91f24c362773553 Mon Sep 17 00:00:00 2001
From: Renato Marroquin <renatoj.marroquin@gmail.com>
Date: Sun, 9 Nov 2014 12:11:29 +0100
Subject: [PATCH] GORA-399

Signed-off-by: Renato Marroquin <rmarroquin@apache.org>
---
 .../gora/cassandra/serializers/GoraSerializerTypeInferer.java | 4 +++-
 .../java/org/apache/gora/cassandra/store/CassandraClient.java | 2 ++
 .../java/org/apache/gora/cassandra/store/CassandraStore.java  | 3 +--
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/serializers/GoraSerializerTypeInferer.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/serializers/GoraSerializerTypeInferer.java
index c95d51c1e..e9521c88a 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/serializers/GoraSerializerTypeInferer.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/serializers/GoraSerializerTypeInferer.java
@@ -55,6 +55,8 @@ public static <T> Serializer<T> getSerializer(Object value) {
     Serializer serializer = null;
     if (value == null) {
       serializer = ByteBufferSerializer.get();
+    } else if (value instanceof CharSequence) {
+      serializer = CharSequenceSerializer.get();
     } else if (value instanceof Utf8) {
       serializer = CharSequenceSerializer.get();
     } else if (value instanceof Boolean) {
@@ -103,7 +105,7 @@ public static <T> Serializer<T> getSerializer(Object value) {
   @SuppressWarnings({ "rawtypes", "unchecked" })
   public static <T> Serializer<T> getSerializer(Class<?> valueClass) {
     Serializer serializer = null;
-    if (valueClass.equals(Utf8.class)) {
+    if (valueClass.equals(Utf8.class) || valueClass.equals(CharSequence.class)) {
       serializer = CharSequenceSerializer.get();
     } else if (valueClass.equals(Boolean.class) || valueClass.equals(boolean.class)) {
       serializer = BooleanSerializer.get();
diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java
index 59bf8bdff..4df1aa4a8 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java
@@ -148,6 +148,8 @@ public void initialize(Class<K> keyClass, Class<T> persistentClass, Properties p
     this.keyspace = HFactory.createKeyspace(this.cassandraMapping.getKeyspaceName(), this.cluster);
     
     this.keySerializer = GoraSerializerTypeInferer.getSerializer(keyClass);
+    if (this.keySerializer == null)
+      LOG.error("Serializer for " + keyClass + " not found.");
     this.mutator = HFactory.createMutator(this.keyspace, this.keySerializer);
   }
 
diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
index 660391ed3..95f80905b 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
@@ -46,7 +46,6 @@
 import org.apache.avro.io.BinaryEncoder;
 import org.apache.avro.specific.SpecificData;
 import org.apache.avro.specific.SpecificDatumWriter;
-import org.apache.avro.util.Utf8;
 import org.apache.gora.cassandra.query.CassandraQuery;
 import org.apache.gora.cassandra.query.CassandraResult;
 import org.apache.gora.cassandra.query.CassandraResultSet;
@@ -629,7 +628,7 @@ private int getUnionSchema(Object pValue, Schema pUnionSchema){
     Iterator<Schema> it = pUnionSchema.getTypes().iterator();
     while ( it.hasNext() ){
       Type schemaType = it.next().getType();
-      if (pValue instanceof Utf8 && schemaType.equals(Type.STRING))
+      if (pValue instanceof CharSequence && schemaType.equals(Type.STRING))
         return unionSchemaPos;
       else if (pValue instanceof ByteBuffer && schemaType.equals(Type.BYTES))
         return unionSchemaPos;
