From 38e3e41049464fa3b8ffc1e810f87c18d91a7bc4 Mon Sep 17 00:00:00 2001
From: Stian Soiland-Reyes <stain@apache.org>
Date: Wed, 14 Sep 2016 11:58:34 +0000
Subject: [PATCH] BEANUTILS-493 handle setting by list index dynabeans

Author: Bernhard Seebass

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/beanutils/trunk@1760685 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  5 ++-
 .../commons/beanutils/BeanUtilsBean.java      |  3 ++
 .../beanutils/bugs/Jira493TestCase.java       | 43 +++++++++++++++++++
 3 files changed, 50 insertions(+), 1 deletion(-)
 create mode 100644 src/test/java/org/apache/commons/beanutils/bugs/Jira493TestCase.java

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 92acc77fa..e4a3aa4c9 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -19,7 +19,7 @@
   </properties>
   <body>
 
-    <release version="1.9.3" date="2016-06-02" description="Buf fix release">
+    <release version="1.9.3" date="2016-09-14" description="Bug fix release">
       <action issue="BEANUTILS-433" dev="ggregory" type="update" due-to="Benedikt Ritter, Gary Gregory">
         Update dependency from JUnit 3.8.1 to 4.12.
       </action>
@@ -44,6 +44,9 @@
       <action issue="BEANUTILS-465" dev="oheger" type="fix" due-to="Daniel Atallah">
         Indexed List Setters no longer work
       </action>
+      <action issue="BEANUTILS-493" dev="stain" type="fix" due-to="Bernhard Seebass">
+        Exception when setting indexed properties: "Default conversion to ArrayList failed"
+      </action>
     </release>
 
     <release version="1.9.2" date="2014-05-29"
diff --git a/src/main/java/org/apache/commons/beanutils/BeanUtilsBean.java b/src/main/java/org/apache/commons/beanutils/BeanUtilsBean.java
index be3a4f5e5..fbdf92709 100644
--- a/src/main/java/org/apache/commons/beanutils/BeanUtilsBean.java
+++ b/src/main/java/org/apache/commons/beanutils/BeanUtilsBean.java
@@ -921,6 +921,9 @@ public void setProperty(final Object bean, String name, final Object value)
                 return; // Skip this property setter
             }
             type = dynaPropertyType(dynaProperty, value);
+            if (index >= 0 && List.class.isAssignableFrom(type)) {
+            	type = Object.class;
+            }
         } else if (target instanceof Map) {
             type = Object.class;
         } else if (target != null && target.getClass().isArray() && index >= 0) {
diff --git a/src/test/java/org/apache/commons/beanutils/bugs/Jira493TestCase.java b/src/test/java/org/apache/commons/beanutils/bugs/Jira493TestCase.java
new file mode 100644
index 000000000..810424cb2
--- /dev/null
+++ b/src/test/java/org/apache/commons/beanutils/bugs/Jira493TestCase.java
@@ -0,0 +1,43 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.commons.beanutils.bugs;
+
+import static org.junit.Assert.assertEquals;
+
+import org.apache.commons.beanutils.BeanUtilsBean;
+import org.apache.commons.beanutils.LazyDynaBean;
+import org.junit.Test;
+
+/** 
+ * Test setting indexed properties on dynabeans
+ *
+ * @see <a href="https://issues.apache.org/jira/browse/BEANUTILS-493">BEANUTILS-493</a>
+ */
+
+public class Jira493TestCase {
+	
+	@Test
+	public void testIndexedProperties() throws Exception {
+		LazyDynaBean lazyDynaBean = new LazyDynaBean();
+		BeanUtilsBean beanUtilsBean = BeanUtilsBean.getInstance();
+		beanUtilsBean.setProperty(lazyDynaBean, "x[0]", "x1");
+		beanUtilsBean.setProperty(lazyDynaBean, "x[1]", "x2");
+		Object x = lazyDynaBean.get("x");
+		assertEquals("[x1, x2]", x.toString());
+	}
+	
+}
\ No newline at end of file
