From 3b7c125b16fc762a81091fa7ecd0e177a5b7b373 Mon Sep 17 00:00:00 2001
From: Niall Pemberton <niallp@apache.org>
Date: Sun, 23 Mar 2008 23:26:11 +0000
Subject: [PATCH] Fix BEANUTILS-294 BeanUtilsBean.setProperty() does not
 support nested map - reported by Stephen Leung

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/beanutils/trunk@640274 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/beanutils/BeanUtilsBean.java      | 12 +++--------
 .../commons/beanutils/BeanUtilsTestCase.java  | 20 +++++++++++++++++++
 2 files changed, 23 insertions(+), 9 deletions(-)

diff --git a/src/java/org/apache/commons/beanutils/BeanUtilsBean.java b/src/java/org/apache/commons/beanutils/BeanUtilsBean.java
index ebd67e348..c668e5f22 100644
--- a/src/java/org/apache/commons/beanutils/BeanUtilsBean.java
+++ b/src/java/org/apache/commons/beanutils/BeanUtilsBean.java
@@ -924,6 +924,8 @@ public void setProperty(Object bean, String name, Object value)
                 return; // Skip this property setter
             }
             type = dynaProperty.getType();
+        } else if (target instanceof Map) {
+            type = Object.class;
         } else {
             PropertyDescriptor descriptor = null;
             try {
@@ -1009,15 +1011,7 @@ public void setProperty(Object bean, String name, Object value)
 
         // Invoke the setter method
         try {
-            if (index >= 0) {
-                getPropertyUtils().setIndexedProperty(target, propName,
-                                                 index, newValue);
-            } else if (key != null) {
-                getPropertyUtils().setMappedProperty(target, propName,
-                                                key, newValue);
-            } else {
-                getPropertyUtils().setProperty(target, propName, newValue);
-            }
+          getPropertyUtils().setProperty(target, name, newValue);
         } catch (NoSuchMethodException e) {
             throw new InvocationTargetException
                 (e, "Cannot set " + propName);
diff --git a/src/test/org/apache/commons/beanutils/BeanUtilsTestCase.java b/src/test/org/apache/commons/beanutils/BeanUtilsTestCase.java
index 2b10b90e4..cfeb99911 100644
--- a/src/test/org/apache/commons/beanutils/BeanUtilsTestCase.java
+++ b/src/test/org/apache/commons/beanutils/BeanUtilsTestCase.java
@@ -1471,6 +1471,26 @@ public void testSetPropertyWriteOnly() throws Exception {
 
     }
 
+    /**
+     * Test setting a value out of a mapped Map
+     */
+    public void testSetMappedMap() {
+        TestBean bean = new TestBean();
+        Map map = new HashMap();
+        map.put("sub-key-1", "sub-value-1");
+        map.put("sub-key-2", "sub-value-2");
+        map.put("sub-key-3", "sub-value-3");
+        bean.getMapProperty().put("mappedMap", map);
+
+        assertEquals("BEFORE", "sub-value-3", ((Map)bean.getMapProperty().get("mappedMap")).get("sub-key-3"));
+        try {
+            BeanUtils.setProperty(bean, "mapProperty(mappedMap)(sub-key-3)", "SUB-KEY-3-UPDATED");
+        } catch (Throwable t) {
+            fail("Threw " + t + "");
+        }
+        assertEquals("AFTER", "SUB-KEY-3-UPDATED", ((Map)bean.getMapProperty().get("mappedMap")).get("sub-key-3"));
+    }
+
     /** Tests that separate instances can register separate instances */
     public void testSeparateInstances() throws Exception {
         BeanUtilsBean utilsOne = new BeanUtilsBean(
