From 476395d79f05ed4dee56d964d15aeba2928c6fe9 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Fri, 6 Dec 2013 20:40:56 +0000
Subject: [PATCH] NET-518 FTPClient#initFeatureMap should not initialize empty
 map if reply code is 530

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1548716 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                 | 4 ++++
 src/main/java/org/apache/commons/net/ftp/FTPClient.java | 6 +++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 93928cde5..a98b8876a 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -64,6 +64,10 @@ The <action> type attribute can be add,update,fix,remove.
     <body>
         <release version="3.4" date="2013-??-??" description="
         ">
+            <action issue="NET-518" dev="sebb" type="fix" due-to="David Kocher">
+            FTPClient#initFeatureMap should not initialize empty map if reply code is 530
+            </action>
+        </release>
             <action issue="NET-514" dev="sebb" type="fix">
             IMAP APPEND multiple issues in IMapClient.
             Deprecated unusable append methods.
diff --git a/src/main/java/org/apache/commons/net/ftp/FTPClient.java b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
index 31a690030..22e613342 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
@@ -2322,7 +2322,11 @@ public boolean hasFeature(String feature, String value) throws IOException {
     private boolean initFeatureMap() throws IOException {
         if (__featuresMap == null) {
             // Don't create map here, because next line may throw exception
-            boolean success = FTPReply.isPositiveCompletion(feat());
+            final int replyCode = feat();
+            if (replyCode == FTPReply.NOT_LOGGED_IN) { // 503
+                return false; // NET-518; don't create empy map
+            }
+            boolean success = FTPReply.isPositiveCompletion(replyCode);
             // we init the map here, so we don't keep trying if we know the command will fail
             __featuresMap = new HashMap<String, Set<String>>();
             if (!success) {
