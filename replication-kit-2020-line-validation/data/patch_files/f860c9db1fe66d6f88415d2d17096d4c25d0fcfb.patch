From f860c9db1fe66d6f88415d2d17096d4c25d0fcfb Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sun, 27 Sep 2009 20:05:50 +0000
Subject: [PATCH] CONFIGURATION-396: HierarchicalConfiguration.NodeVisitor is
 now passed the correct key to its visitAfterChildren() method.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@819395 13f79535-47bb-0310-9956-ffa450edef68
---
 .../HierarchicalConfiguration.java            |  2 +-
 .../TestHierarchicalConfiguration.java        | 43 +++++++++++++++++--
 xdocs/changes.xml                             |  4 ++
 3 files changed, 44 insertions(+), 5 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java b/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java
index 3df7844a58..28d9a62306 100644
--- a/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java
+++ b/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java
@@ -1356,11 +1356,11 @@ public void visit(NodeVisitor visitor, ConfigurationKey key)
                 }
             }
 
+            visitor.visitAfterChildren(this, key);
             if (key != null)
             {
                 key.setLength(length);
             }
-            visitor.visitAfterChildren(this, key);
         }
     }
 
diff --git a/src/test/org/apache/commons/configuration/TestHierarchicalConfiguration.java b/src/test/org/apache/commons/configuration/TestHierarchicalConfiguration.java
index c4b0a62ca1..0b9854fcf1 100644
--- a/src/test/org/apache/commons/configuration/TestHierarchicalConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestHierarchicalConfiguration.java
@@ -766,8 +766,27 @@ public void testNodeVisitor()
     {
         CountVisitor v = new CountVisitor();
         config.getRoot().visit(v, null);
-        assertEquals(28, v.beforeCount);
-        assertEquals(v.beforeCount, v.afterCount);
+        assertEquals("Wrong number of visits", 28, v.beforeCount);
+        assertEquals("Different number of before and after visits",
+                v.beforeCount, v.afterCount);
+    }
+
+    /**
+     * Tests the visitor mechanism if a ConfigurationKey is passed in.
+     */
+    public void testNodeVisitorKeys()
+    {
+        CountVisitor v = new CountVisitor();
+        ConfigurationKey configKey = new ConfigurationKey();
+        config.getRoot().visit(v, configKey);
+        for (Iterator it = config.getKeys(); it.hasNext();)
+        {
+            String key = (String) it.next();
+            assertTrue("Key not found in before keys: " + key, v.beforeKeys
+                    .contains(key));
+            assertTrue("Key not found in after keys: " + key, v.afterKeys
+                    .contains(key));
+        }
     }
 
     /**
@@ -1112,20 +1131,36 @@ private static HierarchicalConfiguration.Node createNode(String name, Object val
      */
     static class CountVisitor extends HierarchicalConfiguration.NodeVisitor
     {
-        public int beforeCount;
+        /** The number of invocations of visitBeforeChildren(). */
+        int beforeCount;
+
+        /** The number of invocations of visitAfterChildren(). */
+        int afterCount;
 
-        public int afterCount;
+        /** A set with the keys passed to visitBeforeChildren(). */
+        final Set beforeKeys = new HashSet();
+
+        /** A set with the keys passed to visitAfterChildren(). */
+        final Set afterKeys = new HashSet();
 
         public void visitAfterChildren(Node node, ConfigurationKey key)
         {
             super.visitAfterChildren(node, key);
             afterCount++;
+            if (key != null)
+            {
+                afterKeys.add(key.toString());
+            }
         }
 
         public void visitBeforeChildren(Node node, ConfigurationKey key)
         {
             super.visitBeforeChildren(node, key);
             beforeCount++;
+            if (key != null)
+            {
+                beforeKeys.add(key.toString());
+            }
         }
     }
 }
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 0b3ee17639..1bbb50296e 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.7" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-396">
+        HierarchicalConfiguration.NodeVisitor is now passed the correct key to
+        its visitAfterChildren() method.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-393">
         BaseConfiguration.clone() now also clones collections stored in the
         internal map. This causes list properties to be handled correctly.
