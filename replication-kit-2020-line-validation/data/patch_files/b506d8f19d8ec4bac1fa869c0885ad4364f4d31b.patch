From b506d8f19d8ec4bac1fa869c0885ad4364f4d31b Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 20 Aug 2008 22:30:44 +0000
Subject: [PATCH] FIX: URLRepository does not allow some valid file scheme
 uri's (IVY-884)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@687492 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                          |  1 +
 .../ivy/plugins/repository/url/URLRepository.java    | 12 +++++++++++-
 .../apache/ivy/plugins/resolver/URLResolverTest.java |  8 +++-----
 3 files changed, 15 insertions(+), 6 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 060593438..c0d8b7e92 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -108,6 +108,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Add a memory cache for the module descriptor that are parsed from the cache (IVY-883)
 - IMPROVEMENT: Improve performance (IVY-872)
 
+- FIX: URLRepository does not allow some valid file scheme uri's (IVY-884)
 - FIX: Incorrect parsing artifactPattern attribute in a sftp resolver (IVY-661) (thanks to Alexey Kiselev)
 - FIX: Maven2 "ejb" packaging is not supported (IVY-873)
 - FIX: Config files with # in path can't be read (IVY-868) (thanks to Simon Steiner)
diff --git a/src/java/org/apache/ivy/plugins/repository/url/URLRepository.java b/src/java/org/apache/ivy/plugins/repository/url/URLRepository.java
index 06df31ece..f2d694091 100644
--- a/src/java/org/apache/ivy/plugins/repository/url/URLRepository.java
+++ b/src/java/org/apache/ivy/plugins/repository/url/URLRepository.java
@@ -19,6 +19,8 @@
 
 import java.io.File;
 import java.io.IOException;
+import java.net.URI;
+import java.net.URISyntaxException;
 import java.net.URL;
 import java.util.*;
 import org.apache.ivy.plugins.repository.AbstractRepository;
@@ -106,7 +108,15 @@ public List list(String parent) throws IOException {
                 return ret;
             }
         } else if (parent.startsWith("file")) {
-            String path = new URL(parent).getPath();
+            String path;
+            try {
+                path = new URI(parent).getPath();
+            } catch (URISyntaxException e) {
+                IOException ioe = new IOException("Couldn't list content of '" + parent + "'");
+                ioe.initCause(e);
+                throw ioe;
+            }
+            
             File file = new File(path);
             if (file.exists() && file.isDirectory()) {
                 String[] files = file.list();
diff --git a/test/java/org/apache/ivy/plugins/resolver/URLResolverTest.java b/test/java/org/apache/ivy/plugins/resolver/URLResolverTest.java
index 482b7a3f0..b734f4643 100644
--- a/test/java/org/apache/ivy/plugins/resolver/URLResolverTest.java
+++ b/test/java/org/apache/ivy/plugins/resolver/URLResolverTest.java
@@ -121,11 +121,9 @@ public void testFile() throws Exception {
     public void testLatestFile() throws Exception {
         URLResolver resolver = new URLResolver();
         resolver.setSettings(_settings);
-        String rootpath = new File("test/repositories/1").getAbsolutePath().replaceAll("\\\\", "/");
-        resolver.addIvyPattern("file:" + rootpath
-                + "/[organisation]/[module]/ivys/ivy-[revision].xml");
-        resolver.addArtifactPattern("file:" + rootpath
-                + "/[organisation]/[module]/[type]s/[artifact]-[revision].[type]");
+        String rootpath = new File("test/repositories/1").toURI().toURL().toExternalForm();
+        resolver.addIvyPattern(rootpath + "[organisation]/[module]/ivys/ivy-[revision].xml");
+        resolver.addArtifactPattern(rootpath + "[organisation]/[module]/[type]s/[artifact]-[revision].[type]");
         resolver.setName("test");
         assertEquals("test", resolver.getName());
 
