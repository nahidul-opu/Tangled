From 84c5386d736344633e1020e04e14f963247445a5 Mon Sep 17 00:00:00 2001
From: Mario Ivankovits <imario@apache.org>
Date: Fri, 10 Aug 2007 18:58:49 +0000
Subject: [PATCH] VFS-120: check if session is down and recreate it then

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@564717 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/commons/vfs/provider/sftp/SftpFileSystem.java  | 8 +++++---
 1 file changed, 5 insertions(+), 3 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileSystem.java b/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileSystem.java
index 680bcb4a62..b64002bc6a 100644
--- a/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileSystem.java
+++ b/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileSystem.java
@@ -76,9 +76,11 @@ protected void doCloseCommunicationLink()
      */
     protected ChannelSftp getChannel() throws IOException
     {
-        if (this.session == null)
+        if (this.session == null || !this.session.isConnected())
         {
-            // channel closed. e.g. by freeUnusedResources, but now we need it again
+			doCloseCommunicationLink();
+			
+			// channel closed. e.g. by freeUnusedResources, but now we need it again
             Session session;
 			UserAuthenticationData authData = null;
 			try
@@ -119,7 +121,7 @@ protected ChannelSftp getChannel() throws IOException
             }
             else
             {
-                channel = (ChannelSftp) session.openChannel("sftp");
+				channel = (ChannelSftp) session.openChannel("sftp");
                 channel.connect();
 
                 Boolean userDirIsRoot = SftpFileSystemConfigBuilder.getInstance().getUserDirIsRoot(getFileSystemOptions());
