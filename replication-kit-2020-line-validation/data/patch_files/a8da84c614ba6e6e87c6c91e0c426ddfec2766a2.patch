From a8da84c614ba6e6e87c6c91e0c426ddfec2766a2 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Mon, 14 Sep 2009 00:33:44 +0000
Subject: [PATCH] NET-294 UnixFTPEntryParser fails to parse some entries

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@814451 13f79535-47bb-0310-9956-ffa450edef68
---
 .../net/ftp/parser/UnixFTPEntryParser.java    | 22 ++++++++++---------
 .../ftp/parser/UnixFTPEntryParserTest.java    | 17 +++++++++++++-
 xdocs/changes.xml                             |  3 +++
 3 files changed, 31 insertions(+), 11 deletions(-)

diff --git a/src/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java b/src/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
index 3ef4dc6bf..78d33b3f7 100644
--- a/src/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
+++ b/src/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
@@ -88,23 +88,25 @@ public class UnixFTPEntryParser extends ConfigurableFTPFileEntryParserImpl
     private static final String REGEX =
         "([bcdlfmpSs-])"
         +"(((r|-)(w|-)([xsStTL-]))((r|-)(w|-)([xsStTL-]))((r|-)(w|-)([xsStTL-])))\\+?\\s+"
-        + "(\\d+)\\s+"
-        + "(\\S+)\\s+"
-        + "(?:(\\S+(?:\\s\\S+)*)\\s+)?"
-        + "(\\d+(?:,\\s*\\d+)?)\\s+"
+        + "(\\d+)\\s+"                    // link count
+        + "(\\S+)\\s+"                    // owner name
+        + "(?:(\\S+(?:\\s\\S+)*)\\s+)?"   // group name (optional spaces)
+        + "(\\d+(?:,\\s*\\d+)?)\\s+"      // size or n,m
         
         /*
-          numeric or standard format date
+         * numeric or standard format date:
+         *   yyyy-mm-dd (expecting hh:mm to follow)
+         *   MMMM [d]d
+         *   [d]d MMM
         */
-        + "((?:\\d+[-/]\\d+[-/]\\d+)|(?:\\S+\\s+\\S+))\\s+"
-        
+        + "((?:\\d+[-/]\\d+[-/]\\d+)|(?:[a-zA-Z]{3}\\s+\\d{1,2})|(?:\\d{1,2}\\s+[a-zA-Z]{3}))\\s+"
         /* 
-           year (for non-recent standard format) 
-           or time (for numeric or recent standard format  
+           year (for non-recent standard format) - yyyy
+           or time (for numeric or recent standard format [h]h:mm  
         */
         + "(\\d+(?::\\d+)?)\\s+"
         
-        + "(\\S*)(\\s*.*)";
+        + "(\\S*)(\\s*.*)"; // the rest
 
 
     /**
diff --git a/src/test/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java b/src/test/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java
index 6d386de9f..95a18411d 100644
--- a/src/test/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java
+++ b/src/test/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java
@@ -74,7 +74,8 @@ public class UnixFTPEntryParserTest extends FTPParseTestFramework {
             "lrwxrwxrwx   1 neeme neeme             23 Mar  2 18:06 macros -> ./../../global/macros/.",
             "-rw-r--r--   1 ftp      group with spaces in it as allowed in cygwin see bug 38634   83853 Jan 22  2001 zxJDBC-1.2.4.tar.gz",
             "crw-r----- 1 root kmem 0, 27 Jan 30 11:42 kmem",  //FreeBSD device
-            "crw-------   1 root     sys      109,767 Jul  2  2004 pci@1c,600000:devctl" //Solaris device
+            "crw-------   1 root     sys      109,767 Jul  2  2004 pci@1c,600000:devctl", //Solaris device
+            "-rwxrwx---   1 ftp      ftp-admin 816026400 Oct  5  2008 bloplab 7 cd1.img", // NET-294
 
 
         };
@@ -233,6 +234,18 @@ public void testParseFieldsOnFile() throws Exception {
         assertEquals(df.format(cal.getTime()), df.format(f.getTimestamp().getTime()));
     }
     
+    public void testNET294() {
+        FTPFile f = getParser().parseFTPEntry(
+                "-rwxrwx---   1 ftp      ftp-admin 816026400 Oct  5  2008 bloplab 7 cd1.img");
+        assertNotNull(f);
+        assertEquals("ftp", f.getUser());
+        assertEquals("ftp-admin", f.getGroup());
+        assertEquals(816026400L,f.getSize());
+        assertNotNull("Timestamp should not be null",f.getTimestamp());
+        assertEquals(2008,f.getTimestamp().get(Calendar.YEAR));
+        assertEquals("bloplab 7 cd1.img",f.getName());
+    }
+    
 
     /**
      * Method suite.
@@ -268,6 +281,7 @@ protected void doAdditionalGoodTests(String test, FTPFile f) {
         case 'b':
         case 'c':
             assertEquals(0, f.getHardLinkCount());
+            //$FALL-THROUGH$ TODO fix if DEVICE_TYPE introduced
         case 'f':
         case '-':
             assertEquals("Type of "+ test, type, FTPFile.FILE_TYPE);
@@ -290,5 +304,6 @@ protected void doAdditionalGoodTests(String test, FTPFile f) {
             }
         }
 
+        assertNotNull("Expecting valid timestamp",f.getTimestamp());
     }
 }
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 4f363619f..b8a77cd80 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -104,6 +104,9 @@ limitations under the License.
             </action>
             <action dev="sebb" type="fix" issue="NET-225">
                 FTPFileEntryParserImpl.preParse() doesn't remove unparsable entries at the end of the file list
+            </action>
+            <action dev="sebb" type="fix" issue="NET-294">
+                UnixFTPEntryParser fails to parse some entries
             </action>
 		</release> 
 		
