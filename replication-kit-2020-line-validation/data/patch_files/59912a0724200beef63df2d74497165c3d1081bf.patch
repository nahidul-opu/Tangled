From 59912a0724200beef63df2d74497165c3d1081bf Mon Sep 17 00:00:00 2001
From: Phil Steitz <phil.steitz@gmail.com>
Date: Sun, 8 Mar 2015 15:11:03 -0700
Subject: [PATCH] Made getKernel return a constant distribution for zero
 variance bins.  JIRA: MATH-1203.

---
 src/changes/changes.xml                           |  3 +++
 .../math3/random/EmpiricalDistribution.java       |  2 +-
 .../math3/random/EmpiricalDistributionTest.java   | 15 +++++++++++++++
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index b512dc821c..03d6fa97c0 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -54,6 +54,9 @@ If the output is not quite correct, check for invisible trailing spaces!
     </release>
 
     <release version="3.5" date="2015-01-11" description="">
+      <action dev="psteitz" type="fix" issue="MATH-1203">
+        EmpiricalDistribution getKernel fails for buckets with only multiple instances of the same value.
+      </action>
       <action dev="evanward" type="fix" issue="MATH-1204">
         "UnivariateSolverUtils#bracket(...)" sometimes failed to bracket
         if a reached the lower bound.
diff --git a/src/main/java/org/apache/commons/math3/random/EmpiricalDistribution.java b/src/main/java/org/apache/commons/math3/random/EmpiricalDistribution.java
index 3dd2d7f825..fc273003c0 100644
--- a/src/main/java/org/apache/commons/math3/random/EmpiricalDistribution.java
+++ b/src/main/java/org/apache/commons/math3/random/EmpiricalDistribution.java
@@ -826,7 +826,7 @@ private double cumBinP(int binIndex) {
      * @return within-bin kernel parameterized by bStats
      */
     protected RealDistribution getKernel(SummaryStatistics bStats) {
-        if (bStats.getN() == 1) {
+        if (bStats.getN() == 1 || bStats.getVariance() == 0) {
             return new ConstantRealDistribution(bStats.getMean());
         } else {
             return new NormalDistribution(randomData.getRandomGenerator(),
diff --git a/src/test/java/org/apache/commons/math3/random/EmpiricalDistributionTest.java b/src/test/java/org/apache/commons/math3/random/EmpiricalDistributionTest.java
index 42e9a7f9c0..580be9ece6 100644
--- a/src/test/java/org/apache/commons/math3/random/EmpiricalDistributionTest.java
+++ b/src/test/java/org/apache/commons/math3/random/EmpiricalDistributionTest.java
@@ -432,6 +432,21 @@ public void testSampleValuesRange() {
         }
     }
     
+    /**
+     * MATH-1203
+     */
+    @Test
+    public void testNoBinVariance() {
+        final double[] data = {0, 0, 1, 1};
+        EmpiricalDistribution dist = new EmpiricalDistribution(2);
+        dist.load(data);
+        dist.reseedRandomGenerator(1000);
+        for (int i = 0; i < 1000; i++) {
+            final double dev = dist.sample();
+            Assert.assertTrue(dev == 0 || dev == 1);
+        }
+    }   
+    
     /**
      * Find the bin that x belongs (relative to {@link #makeDistribution()}).
      */
