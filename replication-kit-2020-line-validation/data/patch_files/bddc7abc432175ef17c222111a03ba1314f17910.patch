From bddc7abc432175ef17c222111a03ba1314f17910 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Fri, 1 Aug 2008 19:38:42 +0000
Subject: [PATCH] CONFIGURATION-332: DataConfiguration now collaborates better
 with PropertiesConfiguration.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@681798 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/DataConfiguration.java      | 10 +++++++++
 .../TestPropertiesConfiguration.java          | 21 +++++++++++++++++--
 xdocs/changes.xml                             |  5 +++++
 3 files changed, 34 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/DataConfiguration.java b/src/java/org/apache/commons/configuration/DataConfiguration.java
index 69d56c5b54..56d7a6dbee 100644
--- a/src/java/org/apache/commons/configuration/DataConfiguration.java
+++ b/src/java/org/apache/commons/configuration/DataConfiguration.java
@@ -140,6 +140,11 @@ protected void addPropertyDirect(String key, Object obj)
         }
     }
 
+    public void addProperty(String key, Object value)
+    {
+        getConfiguration().addProperty(key, value);
+    }
+
     public boolean isEmpty()
     {
         return configuration.isEmpty();
@@ -155,6 +160,11 @@ public void clearProperty(String key)
         configuration.clearProperty(key);
     }
 
+    public void setProperty(String key, Object value)
+    {
+        configuration.setProperty(key, value);
+    }
+
     public Iterator getKeys()
     {
         return configuration.getKeys();
diff --git a/src/test/org/apache/commons/configuration/TestPropertiesConfiguration.java b/src/test/org/apache/commons/configuration/TestPropertiesConfiguration.java
index d6ce32cb7c..6302d9c581 100644
--- a/src/test/org/apache/commons/configuration/TestPropertiesConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestPropertiesConfiguration.java
@@ -34,11 +34,11 @@
 import java.util.Iterator;
 import java.util.List;
 
+import junit.framework.TestCase;
+
 import org.apache.commons.configuration.reloading.FileChangedReloadingStrategy;
 import org.apache.commons.lang.SystemUtils;
 
-import junit.framework.TestCase;
-
 /**
  * Test for loading and saving properties files.
  *
@@ -798,6 +798,23 @@ public void testAppendAndSave() throws ConfigurationException
         checkCopiedConfig(copyConf);
     }
 
+    /**
+     * Tests adding properties through a DataConfiguration. This is related to
+     * CONFIGURATION-332.
+     */
+    public void testSaveWithDataConfig() throws ConfigurationException
+    {
+        conf = new PropertiesConfiguration(testSavePropertiesFile);
+        DataConfiguration dataConfig = new DataConfiguration(conf);
+        dataConfig.setProperty("foo", "bar");
+        assertEquals("Property not set", "bar", conf.getString("foo"));
+
+        conf.save();
+        PropertiesConfiguration config2 = new PropertiesConfiguration(
+                testSavePropertiesFile);
+        assertEquals("Property not saved", "bar", config2.getString("foo"));
+    }
+
     /**
      * Creates a configuration that can be used for testing copy operations.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index bfa93aab77..74a55971c8 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-332">
+        Properties written through a DataConfiguration to a wrapped
+        PropertiesConfiguration got lost when the PropertiesConfiguration was
+        saved. This has been fixed.
+      </action>
       <action dev="oheger" type="add" issue="CONFIGURATION-331">
         XMLBeanDeclaration now defines a factory method createBeanDeclaration()
         for creating the declarations for complex nested properties. This
