From 35aee57a2b910d9d75c5d63e21e251558bda6387 Mon Sep 17 00:00:00 2001
From: Mario Ivankovits <imario@apache.org>
Date: Tue, 7 Nov 2006 21:57:33 +0000
Subject: [PATCH] VFS-98: try to avoid deadlock

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/vfs/trunk@472293 13f79535-47bb-0310-9956-ffa450edef68
---
 .../AbstractOriginatingFileProvider.java      | 26 +++++++++++--------
 1 file changed, 15 insertions(+), 11 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs/provider/AbstractOriginatingFileProvider.java b/core/src/main/java/org/apache/commons/vfs/provider/AbstractOriginatingFileProvider.java
index 6880e34cd4..df4ee289e5 100644
--- a/core/src/main/java/org/apache/commons/vfs/provider/AbstractOriginatingFileProvider.java
+++ b/core/src/main/java/org/apache/commons/vfs/provider/AbstractOriginatingFileProvider.java
@@ -64,20 +64,24 @@ public FileObject findFile(final FileObject baseFile,
     /**
      * Locates a file from its parsed URI.
      */
-    protected synchronized FileObject findFile(final FileName name, final FileSystemOptions fileSystemOptions)
+    protected FileObject findFile(final FileName name, final FileSystemOptions fileSystemOptions)
         throws FileSystemException
     {
-        // Check in the cache for the file system
-        final FileName rootName = getContext().getFileSystemManager().resolveName(name, FileName.ROOT_PATH);
-        FileSystem fs = findFileSystem(rootName, fileSystemOptions);
-        if (fs == null)
-        {
-            // Need to create the file system, and cache it
-            fs = doCreateFileSystem(rootName, fileSystemOptions);
-            addFileSystem(rootName, fs);
-        }
+		FileSystem fs;
+		synchronized (this)
+		{
+			// Check in the cache for the file system
+			final FileName rootName = getContext().getFileSystemManager().resolveName(name, FileName.ROOT_PATH);
+			fs = findFileSystem(rootName, fileSystemOptions);
+			if (fs == null)
+			{
+				// Need to create the file system, and cache it
+				fs = doCreateFileSystem(rootName, fileSystemOptions);
+				addFileSystem(rootName, fs);
+			}
+		}
 
-        // Locate the file
+		// Locate the file
         // return fs.resolveFile(name.getPath());
         return fs.resolveFile(name);
     }
