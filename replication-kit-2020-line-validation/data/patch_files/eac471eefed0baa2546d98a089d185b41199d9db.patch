From eac471eefed0baa2546d98a089d185b41199d9db Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 10 Feb 2010 22:01:29 +0000
Subject: [PATCH] FIX: parent.groupId is not resolved in maven 2 parser
 (IVY-1169) (thanks to Achim Huegen)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@908664 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  2 ++
 .../parser/m2/PomModuleDescriptorParser.java  |  2 ++
 .../m2/PomModuleDescriptorParserTest.java     | 14 ++++++++
 .../plugins/parser/m2/test-parent.groupid.pom | 36 +++++++++++++++++++
 4 files changed, 54 insertions(+)
 create mode 100644 test/java/org/apache/ivy/plugins/parser/m2/test-parent.groupid.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index 78a697e17..4faf5ec6b 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -45,6 +45,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Ben Hale
 	Peter Hayes
 	Scott Hebert
+	Achim Huegen
 	Matt Inger
 	Anders Janmyr
 	Steve Jones
@@ -107,6 +108,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Trace a message when a property file referenced from the settings doesn't exixts (IVY-1074)
 - IMPROVEMENT: use defaultconf in combination with defaultconfmapping (IVY-1135) (thanks to Jon Schneider)
 
+- FIX: parent.groupId is not resolved in maven 2 parser (IVY-1169) (thanks to Achim Huegen)
 - FIX: Creation of symlinks problematic in Windows with Cygwin 1.7 (IVY-1165)
 - FIX: add ability to programmatically change default resolver (IVY-1163) (thanks to Jason Trump)
 - FIX: ivy.settings.dir space escaping problem (IVY-1162)
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
index 47c8236ee..4cf67fd11 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
@@ -116,7 +116,9 @@ public ModuleDescriptor parseDescriptor(ParserSettings ivySettings, URL descript
         try {           
             PomReader domReader = new PomReader(descriptorURL, res);            
             domReader.setProperty("parent.version", domReader.getParentVersion());
+            domReader.setProperty("parent.groupId", domReader.getParentGroupId());
             domReader.setProperty("project.parent.version", domReader.getParentVersion());
+            domReader.setProperty("project.parent.groupId", domReader.getParentGroupId());
 
             Map pomProperties = domReader.getPomProperties();
             for (Iterator iter = pomProperties.entrySet().iterator(); iter.hasNext();) {
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index ba6f9d48c..7be195bc6 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -221,6 +221,20 @@ public void testParentVersion() throws Exception {
         assertEquals("test", artifact[0].getName());
     }
 
+    public void testParentGroupId() throws Exception {
+        ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
+            settings, getClass().getResource("test-parent.groupid.pom"), false);
+        assertNotNull(md);
+
+        ModuleRevisionId mrid = ModuleRevisionId.newInstance("org.apache", "test", "1.0");
+        assertEquals(mrid, md.getModuleRevisionId());
+
+        Artifact[] artifact = md.getArtifacts("master");
+        assertEquals(1, artifact.length);
+        assertEquals(mrid, artifact[0].getModuleRevisionId());
+        assertEquals("test", artifact[0].getName());
+    }
+
     public void testProjectParentVersion() throws Exception {
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
             settings, getClass().getResource("test-project.parent.version.pom"), false);
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/test-parent.groupid.pom b/test/java/org/apache/ivy/plugins/parser/m2/test-parent.groupid.pom
new file mode 100644
index 000000000..e94e18fab
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/parser/m2/test-parent.groupid.pom
@@ -0,0 +1,36 @@
+<?xml version="1.0"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<project>
+  <parent>
+    <artifactId>test-parent</artifactId>
+    <groupId>org.apache</groupId>
+    <version>1.0</version>
+  </parent>
+  <modelVersion>4.0.0</modelVersion>
+  <artifactId>test</artifactId>
+  <name>Test Module for Ivy M2 parsing</name>
+  <groupId>${parent.groupId}</groupId>
+  <version>1.0</version>
+  <url>http://ivy.jayasoft.org/</url>
+  <organization>
+    <name>Jayasoft</name>
+    <url>http://www.jayasoft.org/</url>
+  </organization>
+</project>
