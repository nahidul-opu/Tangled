From e8fa6c252720175fa9466aa017ada4078789c0c8 Mon Sep 17 00:00:00 2001
From: Mark Thomas <markt@apache.org>
Date: Thu, 30 Jan 2014 20:53:41 +0000
Subject: [PATCH] Add a test case for DBCP-369. It current passes need to check
 if there is still a bug here.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@1562957 13f79535-47bb-0310-9956-ffa450edef68
---
 .../datasources/TestSharedPoolDataSource.java | 41 +++++++++++++++++++
 1 file changed, 41 insertions(+)

diff --git a/src/test/org/apache/commons/dbcp2/datasources/TestSharedPoolDataSource.java b/src/test/org/apache/commons/dbcp2/datasources/TestSharedPoolDataSource.java
index 9427d21b08..68a33b196e 100644
--- a/src/test/org/apache/commons/dbcp2/datasources/TestSharedPoolDataSource.java
+++ b/src/test/org/apache/commons/dbcp2/datasources/TestSharedPoolDataSource.java
@@ -21,6 +21,7 @@
 import java.sql.PreparedStatement;
 import java.sql.ResultSet;
 import java.sql.SQLException;
+import java.util.ArrayList;
 
 import javax.sql.DataSource;
 
@@ -603,4 +604,44 @@ public void testChangePassword() throws Exception {
             TesterDriver.addUser("foo","bar");
         }
     }
+
+    public void testDbcp369() {
+        final ArrayList<SharedPoolDataSource> dataSources = new ArrayList<>();
+        for (int j = 0; j < 10000; j++) {
+            SharedPoolDataSource dataSource = new SharedPoolDataSource();
+            dataSources.add(dataSource);
+        }
+
+        Thread t1 = new Thread(new Runnable() {
+            @Override
+            public void run() {
+                for (SharedPoolDataSource dataSource : dataSources) {
+                    dataSource.setDataSourceName("a");
+                }
+            }
+        });
+
+        Thread t2 = new Thread(new Runnable() {
+            @Override
+            public void run() {
+                for (SharedPoolDataSource dataSource : dataSources) {
+                    try {
+                        dataSource.close();
+                    } catch (Exception e) {
+                        // Ignore
+                    }
+                }
+            }
+        });
+
+        t1.start();
+        t2.start();
+
+        try {
+            t1.join();
+            t2.join();
+        } catch (InterruptedException ie) {
+            // Ignore
+        }
+    }
 }
