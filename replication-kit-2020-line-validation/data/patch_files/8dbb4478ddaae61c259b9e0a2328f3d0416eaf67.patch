From 8dbb4478ddaae61c259b9e0a2328f3d0416eaf67 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Wed, 9 Mar 2011 01:16:02 +0000
Subject: [PATCH] NET-276 NNTPClient has problems with group listings for large
 groups.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1079634 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  3 +++
 .../java/examples/nntp/ExtendedNNTPOps.java   |  4 ++--
 .../java/examples/nntp/MessageThreading.java  |  4 ++--
 src/main/java/examples/nntp/NNTPUtils.java    |  2 +-
 .../commons/net/nntp/ArticlePointer.java      |  2 +-
 .../org/apache/commons/net/nntp/NNTP.java     | 16 ++++++-------
 .../apache/commons/net/nntp/NNTPClient.java   | 24 +++++++++----------
 .../commons/net/nntp/NewsgroupInfo.java       | 17 ++++++-------
 8 files changed, 38 insertions(+), 34 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 6e120890d..8e6a01f6f 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -57,6 +57,9 @@ The <action> type attribute can be add,update,fix,remove.
 
     <body>
         <release version="3.0" date="TBA" description="TBA">
+            <action issue="NET-276" dev="sebb" type="fix">
+            NNTPClient has problems with group listings for large groups.
+            </action>
             <action issue="NET-185" dev="sebb" type="fix">
             Possible NPE in Threader.java
             </action>
diff --git a/src/main/java/examples/nntp/ExtendedNNTPOps.java b/src/main/java/examples/nntp/ExtendedNNTPOps.java
index 754870acd..4f4035b2b 100644
--- a/src/main/java/examples/nntp/ExtendedNNTPOps.java
+++ b/src/main/java/examples/nntp/ExtendedNNTPOps.java
@@ -58,8 +58,8 @@ public void demo(String host, String user, String password) {
             // XOVER
             NewsgroupInfo testGroup = new NewsgroupInfo();
             client.selectNewsgroup("alt.test", testGroup);
-            int lowArticleNumber = testGroup.getFirstArticle();
-            int  highArticleNumber = lowArticleNumber + 100;
+            long lowArticleNumber = testGroup.getFirstArticle();
+            long  highArticleNumber = lowArticleNumber + 100;
             List<Article> articles = NNTPUtils.getArticleInfo(client, lowArticleNumber, highArticleNumber);
 
             for (Article article : articles) {
diff --git a/src/main/java/examples/nntp/MessageThreading.java b/src/main/java/examples/nntp/MessageThreading.java
index 19f5f1646..7ec11b41d 100644
--- a/src/main/java/examples/nntp/MessageThreading.java
+++ b/src/main/java/examples/nntp/MessageThreading.java
@@ -69,8 +69,8 @@ public static void main(String[] args) throws SocketException, IOException {
         NewsgroupInfo group = new NewsgroupInfo();
         client.selectNewsgroup(newsgroup, group);
         
-        int lowArticleNumber = group.getFirstArticle();
-        int highArticleNumber = lowArticleNumber + 5000;
+        long lowArticleNumber = group.getFirstArticle();
+        long highArticleNumber = lowArticleNumber + 5000;
         
         System.out.println("Retrieving articles between [" + lowArticleNumber + "] and [" + highArticleNumber + "]");
         List<Article> articles = NNTPUtils.getArticleInfo(client, lowArticleNumber, highArticleNumber);
diff --git a/src/main/java/examples/nntp/NNTPUtils.java b/src/main/java/examples/nntp/NNTPUtils.java
index 369013f1b..ad97977a6 100644
--- a/src/main/java/examples/nntp/NNTPUtils.java
+++ b/src/main/java/examples/nntp/NNTPUtils.java
@@ -41,7 +41,7 @@ public class NNTPUtils {
      * @return Article[] An array of Article
      * @throws IOException
      */
-    public  static List<Article> getArticleInfo(NNTPClient client, int lowArticleNumber, int highArticleNumber)
+    public  static List<Article> getArticleInfo(NNTPClient client, long lowArticleNumber, long highArticleNumber)
     throws IOException {
         Reader reader = null;
         List<Article> articles = new ArrayList<Article>();
diff --git a/src/main/java/org/apache/commons/net/nntp/ArticlePointer.java b/src/main/java/org/apache/commons/net/nntp/ArticlePointer.java
index 113f6dc10..f4b89f7cd 100644
--- a/src/main/java/org/apache/commons/net/nntp/ArticlePointer.java
+++ b/src/main/java/org/apache/commons/net/nntp/ArticlePointer.java
@@ -28,7 +28,7 @@
 public final class ArticlePointer
 {
     /** The number of the referenced article. */
-    public int articleNumber;
+    public long articleNumber;
     /**
      * The unique id of the referenced article, including the enclosing
      * &lt and &gt symbols which are technically not part of the
diff --git a/src/main/java/org/apache/commons/net/nntp/NNTP.java b/src/main/java/org/apache/commons/net/nntp/NNTP.java
index 54f7e29e8..a5cbd3420 100644
--- a/src/main/java/org/apache/commons/net/nntp/NNTP.java
+++ b/src/main/java/org/apache/commons/net/nntp/NNTP.java
@@ -444,9 +444,9 @@ public int article(String messageId) throws IOException
      * @exception IOException  If an I/O error occurs while either sending the
      *      command or receiving the server reply.
      ***/
-    public int article(int articleNumber) throws IOException
+    public int article(long articleNumber) throws IOException
     {
-        return sendCommand(NNTPCommand.ARTICLE, Integer.toString(articleNumber));
+        return sendCommand(NNTPCommand.ARTICLE, Long.toString(articleNumber));
     }
 
     /***
@@ -504,9 +504,9 @@ public int body(String messageId) throws IOException
      * @exception IOException  If an I/O error occurs while either sending the
      *      command or receiving the server reply.
      ***/
-    public int body(int articleNumber) throws IOException
+    public int body(long articleNumber) throws IOException
     {
-        return sendCommand(NNTPCommand.BODY, Integer.toString(articleNumber));
+        return sendCommand(NNTPCommand.BODY, Long.toString(articleNumber));
     }
 
     /***
@@ -564,9 +564,9 @@ public int head(String messageId) throws IOException
      * @exception IOException  If an I/O error occurs while either sending the
      *      command or receiving the server reply.
      ***/
-    public int head(int articleNumber) throws IOException
+    public int head(long articleNumber) throws IOException
     {
-        return sendCommand(NNTPCommand.HEAD, Integer.toString(articleNumber));
+        return sendCommand(NNTPCommand.HEAD, Long.toString(articleNumber));
     }
 
     /***
@@ -624,9 +624,9 @@ public int stat(String messageId) throws IOException
      * @exception IOException  If an I/O error occurs while either sending the
      *      command or receiving the server reply.
      ***/
-    public int stat(int articleNumber) throws IOException
+    public int stat(long articleNumber) throws IOException
     {
-        return sendCommand(NNTPCommand.STAT, Integer.toString(articleNumber));
+        return sendCommand(NNTPCommand.STAT, Long.toString(articleNumber));
     }
 
     /***
diff --git a/src/main/java/org/apache/commons/net/nntp/NNTPClient.java b/src/main/java/org/apache/commons/net/nntp/NNTPClient.java
index f2a5cdd1c..4ba4ffef0 100644
--- a/src/main/java/org/apache/commons/net/nntp/NNTPClient.java
+++ b/src/main/java/org/apache/commons/net/nntp/NNTPClient.java
@@ -100,7 +100,7 @@ private void __parseArticlePointer(String reply, ArticlePointer pointer)
             try
             {
                 // Get article number
-                pointer.articleNumber = Integer.parseInt(tokens[i++]);
+                pointer.articleNumber = Long.parseLong(tokens[i++]);
                 // Get article id
                 pointer.articleId = tokens[i++];
                 return; // done
@@ -131,11 +131,11 @@ private void __parseGroupReply(String reply, NewsgroupInfo info)
             try
             {
                 // Get estimated article count
-                info._setArticleCount(Integer.parseInt(tokens[i++]));
+                info._setArticleCount(Long.parseLong(tokens[i++]));
                 // Get first article number
-                info._setFirstArticle(Integer.parseInt(tokens[i++]));
+                info._setFirstArticle(Long.parseLong(tokens[i++]));
                 // Get last article number
-                info._setLastArticle(Integer.parseInt(tokens[i++]));
+                info._setLastArticle(Long.parseLong(tokens[i++]));
                 // Get newsgroup name
                 info._setNewsgroup(tokens[i++]);
 
@@ -168,8 +168,8 @@ private NewsgroupInfo __parseNewsgroupListEntry(String entry)
 
         try
         {
-            int lastNum = Integer.parseInt(tokens[i++]);
-            int firstNum = Integer.parseInt(tokens[i++]);
+            long lastNum = Long.parseLong(tokens[i++]);
+            long firstNum = Long.parseLong(tokens[i++]);
             result._setFirstArticle(firstNum);
             result._setLastArticle(lastNum);
             if((firstNum == 0) && (lastNum == 0))
@@ -795,7 +795,7 @@ public boolean selectArticle(ArticlePointer pointer) throws IOException
      * @exception IOException  If an I/O error occurs while either sending a
      *      command to the server or receiving a reply from the server.
      ***/
-    public boolean selectArticle(int articleNumber, ArticlePointer pointer)
+    public boolean selectArticle(long articleNumber, ArticlePointer pointer)
     throws IOException
     {
         if (!NNTPReply.isPositiveCompletion(stat(articleNumber)))
@@ -809,7 +809,7 @@ public boolean selectArticle(int articleNumber, ArticlePointer pointer)
 
 
     /*** Same as <code> selectArticle(articleNumber, null) </code> ***/
-    public boolean selectArticle(int articleNumber) throws IOException
+    public boolean selectArticle(long articleNumber) throws IOException
     {
         return selectArticle(articleNumber, null);
     }
@@ -1208,8 +1208,8 @@ public Reader retrieveArticleInfo(int articleNumber) throws IOException
      * @return a DotTerminatedReader if successful, null otherwise
      * @throws IOException
      */
-    public Reader retrieveArticleInfo(int lowArticleNumber,
-                                      int highArticleNumber)
+    public Reader retrieveArticleInfo(long lowArticleNumber,
+            long highArticleNumber)
         throws IOException
     {
         return
@@ -1246,10 +1246,10 @@ private Reader __retrieveHeader(String header, String articleRange)
      * @return a DotTerminatedReader if successful, null otherwise
      * @throws IOException
      */
-    public Reader retrieveHeader(String header, int articleNumber)
+    public Reader retrieveHeader(String header, long articleNumber)
         throws IOException
     {
-        return __retrieveHeader(header, Integer.toString(articleNumber));
+        return __retrieveHeader(header, Long.toString(articleNumber));
     }
 
     /**
diff --git a/src/main/java/org/apache/commons/net/nntp/NewsgroupInfo.java b/src/main/java/org/apache/commons/net/nntp/NewsgroupInfo.java
index d7415deb6..942443ff1 100644
--- a/src/main/java/org/apache/commons/net/nntp/NewsgroupInfo.java
+++ b/src/main/java/org/apache/commons/net/nntp/NewsgroupInfo.java
@@ -54,8 +54,9 @@ public final class NewsgroupInfo
     public static final int PROHIBITED_POSTING_PERMISSION = 3;
 
     private String __newsgroup;
-    private int __estimatedArticleCount;
-    private int __firstArticle, __lastArticle;
+    private long __estimatedArticleCount;
+    private long __firstArticle;
+    private long __lastArticle;
     private int __postingPermission;
 
     void _setNewsgroup(String newsgroup)
@@ -63,17 +64,17 @@ void _setNewsgroup(String newsgroup)
         __newsgroup = newsgroup;
     }
 
-    void _setArticleCount(int count)
+    void _setArticleCount(long count)
     {
         __estimatedArticleCount = count;
     }
 
-    void _setFirstArticle(int first)
+    void _setFirstArticle(long first)
     {
         __firstArticle = first;
     }
 
-    void _setLastArticle(int last)
+    void _setLastArticle(long last)
     {
         __lastArticle = last;
     }
@@ -99,7 +100,7 @@ public String getNewsgroup()
      * <p>
      * @return The estimated number of articles in the newsgroup.
      ***/
-    public int getArticleCount()
+    public long getArticleCount()
     {
         return __estimatedArticleCount;
     }
@@ -109,7 +110,7 @@ public int getArticleCount()
      * <p>
      * @return The number of the first article in the newsgroup.
      ***/
-    public int getFirstArticle()
+    public long getFirstArticle()
     {
         return __firstArticle;
     }
@@ -119,7 +120,7 @@ public int getFirstArticle()
      * <p>
      * @return The number of the last article in the newsgroup.
      ***/
-    public int getLastArticle()
+    public long getLastArticle()
     {
         return __lastArticle;
     }
