From 7c12992af95b013b9380acd3a6843ee89fae7a3e Mon Sep 17 00:00:00 2001
From: Matthias Boehm <mboehm@us.ibm.com>
Date: Mon, 22 Aug 2016 10:51:50 -0700
Subject: [PATCH] [SYSTEMML-864] Fix nrow/ncol operations over csv frame w/
 unknown size

---
 .../org/apache/sysml/hops/OptimizerUtils.java |  9 +++++++++
 .../cp/AggregateUnaryCPInstruction.java       | 20 ++++++++++++-------
 2 files changed, 22 insertions(+), 7 deletions(-)

diff --git a/src/main/java/org/apache/sysml/hops/OptimizerUtils.java b/src/main/java/org/apache/sysml/hops/OptimizerUtils.java
index 8e53e96988f..52ee3789255 100644
--- a/src/main/java/org/apache/sysml/hops/OptimizerUtils.java
+++ b/src/main/java/org/apache/sysml/hops/OptimizerUtils.java
@@ -590,6 +590,15 @@ public static boolean isSparkExecutionMode() {
 				|| DMLScript.rtplatform == RUNTIME_PLATFORM.HYBRID_SPARK);
 	}
 	
+	/**
+	 * 
+	 * @return
+	 */
+	public static boolean isHadoopExecutionMode() {
+		return (   DMLScript.rtplatform == RUNTIME_PLATFORM.HADOOP
+				|| DMLScript.rtplatform == RUNTIME_PLATFORM.HYBRID);
+	}
+	
 	/**
 	 * 
 	 * @return
diff --git a/src/main/java/org/apache/sysml/runtime/instructions/cp/AggregateUnaryCPInstruction.java b/src/main/java/org/apache/sysml/runtime/instructions/cp/AggregateUnaryCPInstruction.java
index 24b24388312..bafaeb20250 100644
--- a/src/main/java/org/apache/sysml/runtime/instructions/cp/AggregateUnaryCPInstruction.java
+++ b/src/main/java/org/apache/sysml/runtime/instructions/cp/AggregateUnaryCPInstruction.java
@@ -21,9 +21,10 @@
 
 import org.apache.sysml.api.DMLScript;
 import org.apache.sysml.api.DMLScript.RUNTIME_PLATFORM;
+import org.apache.sysml.hops.OptimizerUtils;
 import org.apache.sysml.parser.Expression.DataType;
 import org.apache.sysml.runtime.DMLRuntimeException;
-import org.apache.sysml.runtime.controlprogram.caching.MatrixObject;
+import org.apache.sysml.runtime.controlprogram.caching.CacheableData;
 import org.apache.sysml.runtime.controlprogram.context.ExecutionContext;
 import org.apache.sysml.runtime.functionobjects.Builtin;
 import org.apache.sysml.runtime.instructions.InstructionUtils;
@@ -101,13 +102,18 @@ else if(opcode.equalsIgnoreCase("length"))
 			//Note: check on matrix characteristics to cover incorrect length (-1*-1 -> 1)
 			if( !mc.dimsKnown() ) //invalid nrow/ncol/length
 			{
-				if( DMLScript.rtplatform == RUNTIME_PLATFORM.SINGLE_NODE )
+				if(    DMLScript.rtplatform == RUNTIME_PLATFORM.SINGLE_NODE 
+					|| (input1.getDataType() == DataType.FRAME && OptimizerUtils.isHadoopExecutionMode()) )
 				{
-					//read the input data and explicitly refresh input data
-					MatrixObject mo = (MatrixObject)ec.getVariable(input1.getName());
-					mo.acquireRead();
-					mo.refreshMetaData();
-					mo.release();
+					if( OptimizerUtils.isHadoopExecutionMode() ) {
+						LOG.warn("Reading csv input frame of unkown size into memory for '"+opcode+"'.");
+					}
+					
+					//read the input matrix/frame and explicitly refresh meta data
+					CacheableData<?> obj = ec.getCacheableData(input1.getName());
+					obj.acquireRead();
+					obj.refreshMetaData();
+					obj.release();
 					
 					//update meta data information
 					mc = ec.getMatrixCharacteristics(input1.getName());
