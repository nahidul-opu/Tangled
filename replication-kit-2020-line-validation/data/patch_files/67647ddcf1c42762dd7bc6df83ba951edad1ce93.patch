From 67647ddcf1c42762dd7bc6df83ba951edad1ce93 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 10 Feb 2009 22:02:15 +0000
Subject: [PATCH] FIX: Snapshot issues when using ibiblio resolver when
 m2compatible is false (IVY-1028)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@743126 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                 | 1 +
 .../org/apache/ivy/plugins/resolver/IBiblioResolver.java    | 6 +++++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 5d3dbe2c4..15d414340 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -95,6 +95,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Error message is not clear when specifying an invalid value for checksums (IVY-977)
 - IMPROVEMENT: catch AccessControlException on System.getProperties() (IVY-1015)
 
+- FIX: Snapshot issues when using ibiblio resolver with m2compatible is false (IVY-1028)
 - FIX: Ivy Standalone hangs after publishing to SSH resolver (IVY-1009)
 - FIX: overwrite='false' completely prevents publishing into url repositories (IVY-1007)
 - FIX: Fixed broken logo link in ivy-report.xsl (IVY-1024) (thanks to Carlton Brown)
diff --git a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
index a2400ba10..e8b461bbe 100644
--- a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
@@ -115,7 +115,7 @@ protected ResolvedResource findArtifactRef(Artifact artifact, Date date) {
             mrid = convertM2IdForResourceSearch(mrid);
         }
         ResolvedResource rres = null;
-        if (artifact.getId().getRevision().endsWith("SNAPSHOT")) {
+        if (artifact.getId().getRevision().endsWith("SNAPSHOT") && isM2compatible()) {
             rres = findSnapshotArtifact(artifact, date, mrid);            
             if (rres != null) {
                 return rres;
@@ -158,6 +158,10 @@ private ResolvedResource findSnapshotDescriptor(DependencyDescriptor dd, Resolve
     }
     
     private String findSnapshotVersion(ModuleRevisionId mrid) {
+        if (!isM2compatible()) {
+            return null;
+        }
+        
         String pattern = (String) getIvyPatterns().get(0);
         if (shouldUseMavenMetadata(pattern)) {
             InputStream metadataStream = null;
