From 36fccb4325f924bf46babd4d8d60226f8dd3f154 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Fri, 28 Sep 2018 22:47:42 +0000
Subject: [PATCH] CODEC-250 Wrong value calculated by Cologne Phonetic if a
 special character is placed between equal letters

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/codec/trunk@1842290 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                              |  1 +
 .../commons/codec/language/ColognePhonetic.java      | 12 ++++++------
 .../commons/codec/language/ColognePhoneticTest.java  |  6 ++++++
 3 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index b9227aed47..9b1093bdb9 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -44,6 +44,7 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
     <release version="1.12" date="2017-MM-DD" description="Feature and fix release.">
       <!-- The first attribute below should be the issue id; makes it easier to navigate in the IDE outline -->
+      <action issue="CODEC-250" dev="sebb" type="fix" due-to="Alex Volodko">Wrong value calculated by Cologne Phonetic if a special character is placed between equal letters</action>
       <action issue="CODEC-244" dev="ggregory" type="update">Update from Java 6 to Java 7</action>
       <action issue="CODEC-240" dev="ggregory" type="add" due-to="Ioannis Sermetziadis">Add Percent-Encoding Codec (described in RFC3986 and RFC7578)</action>
       <action issue="CODEC-246" dev="ggregory" type="fix" due-to="Oscar Luis Vera PÃ©rez">ColognePhoneticTest.testIsEncodeEquals missing assertions</action>
diff --git a/src/main/java/org/apache/commons/codec/language/ColognePhonetic.java b/src/main/java/org/apache/commons/codec/language/ColognePhonetic.java
index 8fb973fafa..805aa348c7 100644
--- a/src/main/java/org/apache/commons/codec/language/ColognePhonetic.java
+++ b/src/main/java/org/apache/commons/codec/language/ColognePhonetic.java
@@ -337,13 +337,13 @@ public String colognePhonetic(String text) {
                 nextChar = CHAR_IGNORE;
             }
 
+            // OK to ignore H here because it only affects nextChar which has already been set up
+            if (chr == 'H' || chr < 'A' || chr > 'Z') {
+                    continue; // ignore unwanted characters
+            }
+
             if (arrayContains(AEIJOUY, chr)) {
                 code = '0';
-            } else if (chr == 'H' || chr < 'A' || chr > 'Z') {
-                if (lastCode == CHAR_FIRST_POS) {
-                    continue; // ignore leading unwanted characters
-                }
-                code = CHAR_IGNORE;
             } else if (chr == 'B' || (chr == 'P' && nextChar != 'H')) {
                 code = '1';
             } else if ((chr == 'D' || chr == 'T') && !arrayContains(SCZ, nextChar)) {
@@ -380,7 +380,7 @@ public String colognePhonetic(String text) {
             } else if (chr == 'M' || chr == 'N') {
                 code = '6';
             } else {
-                code = chr;
+                code = chr; // should not happen?
             }
 
             if (code != CHAR_IGNORE && (lastCode != code && (code != '0' || lastCode == CHAR_FIRST_POS) || code < '0' || code > '8')) {
diff --git a/src/test/java/org/apache/commons/codec/language/ColognePhoneticTest.java b/src/test/java/org/apache/commons/codec/language/ColognePhoneticTest.java
index 3e16b14bf0..737d2c9cd0 100644
--- a/src/test/java/org/apache/commons/codec/language/ColognePhoneticTest.java
+++ b/src/test/java/org/apache/commons/codec/language/ColognePhoneticTest.java
@@ -235,6 +235,12 @@ public void testVariationsMeyer() throws EncoderException {
         this.checkEncodingVariations("67", data);
     }
 
+    @Test
+    public void testSpecialCharsBetweenSameLetters() throws EncoderException {
+        final String data[] = {"Test test", "Testtest", "Test-test", "TesT#Test", "TesT?test"};
+        this.checkEncodingVariations("28282", data);
+    }
+
     // Allow command-line testing
     public static void main(String args[]) {
         ColognePhonetic coder = new ColognePhonetic();
