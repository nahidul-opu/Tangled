From 0657990e851a8d0a30236cbe0ad5b4b562cfc08d Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Sat, 17 Mar 2007 10:14:04 +0000
Subject: [PATCH] FIX: setting m2compatible on ibiblio resolver overwrite root
 and pattern settings (IVY-437)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@519279 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                    |  1 +
 .../ivy/plugins/resolver/IBiblioResolver.java  | 17 +++++++++++++++--
 .../plugins/resolver/IBiblioResolverTest.java  | 18 +++++++++++++++++-
 .../plugins/resolver/ibiblioresolverconf.xml   |  2 ++
 4 files changed, 35 insertions(+), 3 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 60cc71d21..16a812eef 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -16,6 +16,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVE: Add a unit test to verify that latest.integration accepts released modules (IVY-394) (thanks to Gilles Scokart)
 - IMPROVE: New "modules in use" section in console report at the end of resolve (IVY-373) (thanks to John Wiliams)
 
+- FIX: setting m2compatible on ibiblio resolver overwrite root and pattern settings (IVY-437)
 - FIX: ivy.revision property not set correctly for second resolve (IVY-429)
 - FIX: NPE when no organisation or no name is provided in module element of ivyconf (IVY-422)
 - FIX: FileUtil#copy(File src, File dest, CopyProgressListener l, boolean overwrite) (IVY-420)
diff --git a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
index cbe0418af..d6a41c781 100644
--- a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
@@ -38,6 +38,7 @@
 import org.apache.ivy.core.search.RevisionEntry;
 import org.apache.ivy.core.settings.IvySettings;
 import org.apache.ivy.plugins.resolver.util.ResolvedResource;
+import org.apache.ivy.util.Message;
 
 
 /**
@@ -78,8 +79,12 @@ protected void logIvyNotFound(ModuleRevisionId mrid) {
     public void setM2compatible(boolean m2compatible) {
         super.setM2compatible(m2compatible);
         if (m2compatible) {
-            _root = "http://www.ibiblio.org/maven2/";
-            _pattern = "[organisation]/[module]/[revision]/[artifact]-[revision](-[classifier]).[ext]";
+        	if (_root == null) {
+        		_root = "http://www.ibiblio.org/maven2/";
+        	}
+        	if (_pattern == null) {
+        		_pattern = "[organisation]/[module]/[revision]/[artifact]-[revision](-[classifier]).[ext]";
+        	}
             updateWholePattern();
         }
     }
@@ -214,4 +219,12 @@ public void setUsepoms(boolean usepoms) {
 		_usepoms = usepoms;
 		updateWholePattern();
 	}
+	
+	public void dumpConfig() {
+		ensureConfigured(getSettings());
+		super.dumpConfig();
+		Message.debug("\t\troot: "+getRoot());
+		Message.debug("\t\tpattern: "+getPattern());
+		Message.debug("\t\tusepoms: "+_usepoms);
+	}
 }
diff --git a/test/java/org/apache/ivy/plugins/resolver/IBiblioResolverTest.java b/test/java/org/apache/ivy/plugins/resolver/IBiblioResolverTest.java
index 962ce5264..1a1072113 100644
--- a/test/java/org/apache/ivy/plugins/resolver/IBiblioResolverTest.java
+++ b/test/java/org/apache/ivy/plugins/resolver/IBiblioResolverTest.java
@@ -118,7 +118,23 @@ public void testInitFromConf() throws Exception {
         assertNotNull(l);
         assertEquals(1, l.size());
         assertEquals("http://www.ibiblio.org/maven/[module]/jars/[artifact]-[revision].jar", l.get(0));
-}
+
+        resolver = (IBiblioResolver)_settings.getResolver("ibiblioE");
+        assertTrue(resolver.isM2compatible());
+        assertNotNull(resolver);
+        l = resolver.getArtifactPatterns();
+        assertNotNull(l);
+        assertEquals(1, l.size());
+        assertEquals("http://www.ibiblio.org/mymaven/[organisation]/[module]/[revision]/[artifact]-[revision](-[classifier]).[ext]", l.get(0));
+
+        resolver = (IBiblioResolver)_settings.getResolver("ibiblioF");
+        assertTrue(resolver.isM2compatible());
+        assertNotNull(resolver);
+        l = resolver.getArtifactPatterns();
+        assertNotNull(l);
+        assertEquals(1, l.size());
+        assertEquals("http://www.ibiblio.org/mymaven/[organisation]/[module]/[revision]/[artifact]-[revision](-[classifier]).[ext]", l.get(0));
+    }
 
     public void testIBiblio() throws Exception {
         String ibiblioRoot = IBiblioHelper.getIBiblioMirror();
diff --git a/test/java/org/apache/ivy/plugins/resolver/ibiblioresolverconf.xml b/test/java/org/apache/ivy/plugins/resolver/ibiblioresolverconf.xml
index 2cb5dbc5a..66de52871 100644
--- a/test/java/org/apache/ivy/plugins/resolver/ibiblioresolverconf.xml
+++ b/test/java/org/apache/ivy/plugins/resolver/ibiblioresolverconf.xml
@@ -4,5 +4,7 @@
   	<ibiblio name="ibiblioB" root="${my.ibiblio.root}" pattern="[organisation]/jars/[artifact]-[revision].jar" />
   	<ibiblio name="ibiblioC" m2compatible="true"/>
   	<ibiblio name="ibiblioD"/>
+  	<ibiblio name="ibiblioE" m2compatible="true" root="${my.ibiblio.root}"/>
+  	<ibiblio name="ibiblioF" root="${my.ibiblio.root}" m2compatible="true"/>
   </resolvers>
 </ivyconf>
