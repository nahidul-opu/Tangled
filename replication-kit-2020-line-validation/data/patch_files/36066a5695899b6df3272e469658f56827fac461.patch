From 36066a5695899b6df3272e469658f56827fac461 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Fri, 21 Aug 2015 11:32:35 +0000
Subject: [PATCH] BCEL-251 Pass3aVerifier visitANEWARRAY() does not allow 255
 array dimensions

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/bcel/trunk@1696944 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                  | 1 +
 src/main/java/org/apache/commons/bcel6/Constants.java    | 9 +++++++++
 .../commons/bcel6/verifier/statics/Pass3aVerifier.java   | 6 ++++--
 3 files changed, 14 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 8481608e0f..dfff4f1a62 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -63,6 +63,7 @@ The <action> type attribute can be add,update,fix,remove.
 
   <body>
     <release version="6.0" date="TBA" description="Major release with Java 7 and 8 support">
+      <action issue="BCEL-251" type="fix">Pass3aVerifier visitANEWARRAY() does not allow 255 array dimensions</action>
       <action issue="BCEL-211" type="update">Some additional clone methods should be public.</action>
       <action issue="BCEL-249" type="fix">Check for max Short seems wrong</action>
       <action issue="BCEL-127" type="update">Document that Instruction Factory returns singleton instances</action>
diff --git a/src/main/java/org/apache/commons/bcel6/Constants.java b/src/main/java/org/apache/commons/bcel6/Constants.java
index 8d00219c5a..a35fac3ba1 100644
--- a/src/main/java/org/apache/commons/bcel6/Constants.java
+++ b/src/main/java/org/apache/commons/bcel6/Constants.java
@@ -362,6 +362,15 @@ public final class Constants {
    */
   public static final int MAX_CODE_SIZE      = 65536; //bytes
 
+  /**
+   * The maximum number of dimensions in an array ({@value}).
+   * One of the limitations of the Java Virtual Machine.
+   *
+   * @see <a href="http://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.3.2-150">
+   * Field Descriptors in The Java Virtual Machine Specification</a>
+   */
+  public static final int MAX_ARRAY_DIMENSIONS = 255;
+
   /** Java VM opcode.
    * @see <a href="http://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5.nop">
    * Opcode definitions in The Java Virtual Machine Specification</a> */
diff --git a/src/main/java/org/apache/commons/bcel6/verifier/statics/Pass3aVerifier.java b/src/main/java/org/apache/commons/bcel6/verifier/statics/Pass3aVerifier.java
index 2170e4f34f..e9b771141a 100644
--- a/src/main/java/org/apache/commons/bcel6/verifier/statics/Pass3aVerifier.java
+++ b/src/main/java/org/apache/commons/bcel6/verifier/statics/Pass3aVerifier.java
@@ -812,8 +812,10 @@ public void visitANEWARRAY(ANEWARRAY o){
             Type t = o.getType(cpg);
             if (t instanceof ArrayType){
                 int dimensions = ((ArrayType) t).getDimensions();
-                if (dimensions >= 255){
-                    constraintViolated(o, "Not allowed to create an array with more than 255 dimensions.");
+                if (dimensions > Constants.MAX_ARRAY_DIMENSIONS){
+                    constraintViolated(o,
+                        "Not allowed to create an array with more than "+ Constants.MAX_ARRAY_DIMENSIONS + " dimensions;"+
+                        " actual: " + dimensions);
                 }
             }
         }
