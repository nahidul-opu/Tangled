From 21fd172fe67cbe87641957c748cbe8fbddc1ead2 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 7 Jan 2009 20:53:00 +0000
Subject: [PATCH] FIX: NullPointerException at
 PomModuleDescriptorBuilder.addDependency (IVY-995)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/branches/2.0.0@732483 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                          |  1 +
 doc/release-notes.html                               |  1 +
 .../parser/m2/PomModuleDescriptorBuilder.java        | 12 ++++--------
 3 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 755231a72..1fdebe876 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -86,6 +86,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Ivy Standalone setting to overwrite publications (IVY-976)
 - IMPROVEMENT: Support useOrigin for artifacts with a set url attribute (IVY-965) (thanks to alex322)
 
+- FIX: NullPointerException at PomModuleDescriptorBuilder.addDependency (IVY-995)
 - FIX: Log levels aren't respected in certain cases using the standalone functionality (IVY-960) (thanks to Patrick Woodworth)
 - FIX: NPE in LogReportOutputter (IVY-961)
 - FIX: NullPointerException when resolving module wihout revision in the pattern (IVY-980)
diff --git a/doc/release-notes.html b/doc/release-notes.html
index ed15b9c14..03374a8f8 100644
--- a/doc/release-notes.html
+++ b/doc/release-notes.html
@@ -157,6 +157,7 @@ <h3>8. List of Changes in this Release</h3>
 - IMPROVEMENT: Ivy Standalone setting to overwrite publications (IVY-976)
 - IMPROVEMENT: Support useOrigin for artifacts with a set url attribute (IVY-965) (thanks to alex322)
 
+- FIX: NullPointerException at PomModuleDescriptorBuilder.addDependency (IVY-995)
 - FIX: Log levels aren't respected in certain cases using the standalone functionality (IVY-960) (thanks to Patrick Woodworth)
 - FIX: NPE in LogReportOutputter (IVY-961)
 - FIX: NullPointerException when resolving module wihout revision in the pattern (IVY-980)
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
index c3f276e00..8532a301a 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
@@ -17,7 +17,6 @@
  */
 package org.apache.ivy.plugins.parser.m2;
 
-import java.text.ParseException;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Collection;
@@ -270,14 +269,11 @@ public void addMainArtifact(String artifactId, String packaging) {
         ivyModuleDescriptor.addArtifact("master", mainArtifact);
     }
 
-
-    public void addDependency(Resource res, PomDependencyData dep) throws ParseException {
+    public void addDependency(Resource res, PomDependencyData dep) {
         String scope = dep.getScope();
         if ((scope != null) && (scope.length() > 0) && !MAVEN2_CONF_MAPPING.containsKey(scope)) {
-            String msg = "Unknown scope '" + scope + "' for dependency "
-                    + ModuleId.newInstance(dep.getGroupId(), dep.getArtifactId()) + " in "
-                    + res.getName();
-            throw new ParseException(msg, 0);
+            // unknown scope, defaulting to 'compile'
+            scope = "compile";
         }
         
         String version = dep.getVersion();
@@ -408,7 +404,7 @@ private String getDefaultVersion(PomDependencyData dep) {
     private String getDefaultScope(PomDependencyData dep) {
         String key = getDependencyMgtExtraInfoKeyForScope(dep.getGroupId(), dep.getArtifactId());
         String result = (String) ivyModuleDescriptor.getExtraInfo().get(key);
-        if (result == null) {
+        if ((result == null) || !MAVEN2_CONF_MAPPING.containsKey(result)) {
             result = "compile";
         }
         return result;
