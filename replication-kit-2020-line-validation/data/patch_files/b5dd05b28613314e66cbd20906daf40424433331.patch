From b5dd05b28613314e66cbd20906daf40424433331 Mon Sep 17 00:00:00 2001
From: Ate Douma <ate@apache.org>
Date: Sun, 10 Dec 2017 15:33:02 +0100
Subject: [PATCH] SCXML-263 Javascript engine (Nashorn) cannot be shared
 between multiple SCXML instance executions

---
 src/changes/changes.xml                        |  4 ++++
 .../scxml2/env/javascript/JSEvaluator.java     | 18 ++++++++++--------
 2 files changed, 14 insertions(+), 8 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 369626ea4..f5c434c93 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -35,6 +35,10 @@
     <release version="2.0" date="In Git master"
       description="Latest unreleased code">
 
+      <action dev="ate" type="update" issue="SCXML-263">
+        [12-10-2017] Javascript engine (Nashorn) cannot be shared between multiple SCXML instance executions
+      </action>
+
       <action dev="ate" type="update" issue="SCXML-262">
         [12-10-2017] Support &lt;script&gt; loaded from external src
       </action>
diff --git a/src/main/java/org/apache/commons/scxml2/env/javascript/JSEvaluator.java b/src/main/java/org/apache/commons/scxml2/env/javascript/JSEvaluator.java
index 66f829c91..b007b6284 100644
--- a/src/main/java/org/apache/commons/scxml2/env/javascript/JSEvaluator.java
+++ b/src/main/java/org/apache/commons/scxml2/env/javascript/JSEvaluator.java
@@ -94,8 +94,8 @@ public Evaluator getEvaluator(final boolean strict, final SCXML document) {
     private static final String ERR_CTX_TYPE = "Error evaluating JavaScript "
             + "expression, Context must be a org.apache.commons.scxml2.env.javascript.JSContext";
 
-    /** shared singleton Nashorn ScriptEngine **/
-    private static ScriptEngine engine;
+    /** Nashorn ScriptEngine **/
+    private transient ScriptEngine engine;
 
     /** Nashorn Global initialization script, loaded from <code>init_global.js</code> classpath resource */
     private static String initGlobalsScript;
@@ -112,14 +112,16 @@ public Evaluator getEvaluator(final boolean strict, final SCXML document) {
      * initialization of a new Javascript (Nashorn) Global.
      * </p>
      */
-    protected synchronized static void initEngine() {
+    protected synchronized void initEngine() {
         if (engine == null) {
             engine = new ScriptEngineManager().getEngineByName("JavaScript");
-            try {
-                initGlobalsScript = IOUtils.toString(JSEvaluator.class.getResourceAsStream("init_global.js"), "UTF-8");
-            }
-            catch (IOException ioe) {
-                throw new RuntimeException("Failed to load init_global.js from classpath", ioe);
+            if (initGlobalsScript == null) {
+                try {
+                    initGlobalsScript = IOUtils.toString(JSEvaluator.class.getResourceAsStream("init_global.js"), "UTF-8");
+                }
+                catch (IOException ioe) {
+                    throw new RuntimeException("Failed to load init_global.js from classpath", ioe);
+                }
             }
         }
     }
