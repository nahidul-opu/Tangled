From 33625d900186b4bce99993d22db46d9d5ae2205a Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 16 Jan 2007 22:55:44 +0000
Subject: [PATCH] PomModuleDescriptorParser fails with nested profile
 dependency (IVY-392)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@496885 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  2 +
 .../m2/PomModuleDescriptorParser.java         |  2 +-
 .../m2/PomModuleDescriptorParserTest.java     | 13 ++++
 .../m2/test-dependencies-with-profile.pom     | 70 +++++++++++++++++++
 4 files changed, 86 insertions(+), 1 deletion(-)
 create mode 100644 test/java/org/apache/ivy/external/m2/test-dependencies-with-profile.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index efaf7d836..aa0761ed5 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -16,6 +16,8 @@ for detailed view of each issue, please consult http://jira.jayasoft.org/
 - FIX: Comments in ivy.xml duplicated (IVY-336) (thanks to Gilles Scokart)
 - FIX: Ivy failure when the ivy.xml file contains non US-ASCII characters (IVY-346) (thanks to Gilles Scokart)
 - FIX: Urlresolver is not possible to use dynamic revisions on nonstandard repository structure (IVY-350) (thanks to Pierre Hägnestrand)
+- FIX: PomModuleDescriptorParser fails with nested profile dependency (IVY-392) (thanks to William Lyvers)
+
 
    version 1.4.1 - 2006-11-09
 =====================================
diff --git a/src/java/org/apache/ivy/external/m2/PomModuleDescriptorParser.java b/src/java/org/apache/ivy/external/m2/PomModuleDescriptorParser.java
index 58ee20f88..8a6281363 100644
--- a/src/java/org/apache/ivy/external/m2/PomModuleDescriptorParser.java
+++ b/src/java/org/apache/ivy/external/m2/PomModuleDescriptorParser.java
@@ -172,7 +172,7 @@ public void endElement(String uri, String localName, String qName) throws SAXExc
                 _organisation = null;
                 _module = null;
             }
-            if ("dependency".equals(qName)) {
+            if ("project/dependencies/dependency".equals(getContext())) {
                 _organisation = null;
                 _module = null;
                 _revision = null;
diff --git a/test/java/org/apache/ivy/external/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/external/m2/PomModuleDescriptorParserTest.java
index 4f2bfabf0..95e7d5739 100644
--- a/test/java/org/apache/ivy/external/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/external/m2/PomModuleDescriptorParserTest.java
@@ -103,6 +103,19 @@ public void testDependencies() throws Exception {
         assertEquals(ModuleRevisionId.newInstance("commons-logging", "commons-logging", "1.0.4"), dds[0].getDependencyRevisionId());
     }
     
+    // IVY-392
+    public void testDependenciesWithProfile() throws Exception {
+        ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(new Ivy(), getClass().getResource("test-dependencies-with-profile.pom"), false);
+        assertNotNull(md);
+        
+        assertEquals(ModuleRevisionId.newInstance("org.apache", "test", "1.0"), md.getModuleRevisionId());
+        
+        DependencyDescriptor[] dds = md.getDependencies();
+        assertNotNull(dds);
+        assertEquals(1, dds.length);
+        assertEquals(ModuleRevisionId.newInstance("commons-logging", "commons-logging", "1.0.4"), dds[0].getDependencyRevisionId());
+    }
+    
     public void testWithoutVersion() throws Exception {
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(new Ivy(), getClass().getResource("test-without-version.pom"), false);
         assertNotNull(md);
diff --git a/test/java/org/apache/ivy/external/m2/test-dependencies-with-profile.pom b/test/java/org/apache/ivy/external/m2/test-dependencies-with-profile.pom
new file mode 100644
index 000000000..17b484ed4
--- /dev/null
+++ b/test/java/org/apache/ivy/external/m2/test-dependencies-with-profile.pom
@@ -0,0 +1,70 @@
+<?xml version="1.0"?>
+<project>
+  <modelVersion>4.0.0</modelVersion>
+  <groupId>org.apache</groupId>
+  <artifactId>test</artifactId>
+  <name>Test Module for Ivy M2 parsing</name>
+  <version>1.0</version>
+  <url>http://ivy.jayasoft.org/</url>
+  <organization>
+    <name>Jayasoft</name>
+    <url>http://www.jayasoft.org/</url>
+  </organization>
+  <profiles>
+    <profile>
+      <id>j4</id>
+      <build>
+        <plugins>
+          <plugin>
+            <groupId>org.codehaus.mojo</groupId>
+            <artifactId>retrotranslator-maven-plugin</artifactId>
+            <executions>
+              <execution>
+                <id>retrotranslate</id>
+              </execution>
+            </executions>
+          </plugin>
+          <plugin>
+            <artifactId>maven-jar-plugin</artifactId>
+            <executions>
+              <execution>
+                <id>create-j4-jar</id>
+                <goals>
+                  <goal>jar</goal>
+                </goals>
+                <configuration>
+                  <classesDirectory>${project.build.directory}/classes-retro</classesDirectory>
+                  <classifier>j4</classifier>
+                  <archive>
+                    <manifestEntries>
+                      <Extension-Name>${project.artifactId}-j4</Extension-Name>
+                      <Specification-Vendor>${project.organization.name}</Specification-Vendor>
+                      <Implementation-Vendor>${project.organization.name}</Implementation-Vendor>
+                      <Implementation-Title>${project.description}</Implementation-Title>
+                      <Implementation-Version>2.0.2-SNAPSHOT</Implementation-Version>
+                      <Revision>${scm.revision}</Revision>
+                    </manifestEntries>
+                  </archive>
+                </configuration>
+              </execution>
+            </executions>
+          </plugin>
+        </plugins>
+      </build>
+      <dependencies>
+        <dependency>
+          <groupId>net.sf.retrotranslator</groupId>
+          <artifactId>retrotranslator-runtime</artifactId>
+          <version>1.0.8</version>
+        </dependency>
+      </dependencies>
+    </profile>
+  </profiles>
+  <dependencies>
+    <dependency>
+      <groupId>commons-logging</groupId>
+      <artifactId>commons-logging</artifactId>
+      <version>1.0.4</version>
+    </dependency>
+  </dependencies>
+</project>
\ No newline at end of file
