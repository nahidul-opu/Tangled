From a29009716c694f44b5469735268f3397b57e0612 Mon Sep 17 00:00:00 2001
From: Rory Winston <rwinston@apache.org>
Date: Thu, 23 Apr 2009 03:23:57 +0000
Subject: [PATCH] NET-274: Restore socket i/o streams after CCC command

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/branches/NET_2_0@767772 13f79535-47bb-0310-9956-ffa450edef68
---
 src/main/java/org/apache/commons/net/ftp/FTPSClient.java | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/main/java/org/apache/commons/net/ftp/FTPSClient.java b/src/main/java/org/apache/commons/net/ftp/FTPSClient.java
index ac927d30d..03b72b41b 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPSClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPSClient.java
@@ -475,9 +475,16 @@ private boolean checkPROTValue(String prot) {
     @Override
     public int sendCommand(String command, String args) throws IOException {
         int repCode = super.sendCommand(command, args);
+        /* If CCC is issued, restore socket i/o streams to unsecured versions */
         if (FTPSCommand._commands[FTPSCommand.CCC].equals(command)) {
             if (FTPReply.COMMAND_OK == repCode) {
                 _socket_ = plainSocket;
+		_controlInput_ = new BufferedReader(
+				new InputStreamReader( 
+					_socket_ .getInputStream(), getControlEncoding()));
+		_controlOutput_ = new BufferedWriter(
+				new OutputStreamWriter( 
+					_socket_.getOutputStream(), getControlEncoding()));
                 setSocketFactory(null);
             } else {
                 throw new SSLException(getReplyString());
