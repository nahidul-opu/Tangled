From 3ce46ae21184aeb703468a3e1628b8de006fde02 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 22 Feb 2011 02:23:12 +0000
Subject: [PATCH] NET-359 CopyStreamAdapter unconditionally resets the
 CopyStreamEvent source and is inefficient

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1073207 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                         |  3 +++
 .../commons/net/io/CopyStreamAdapter.java       | 17 ++++++-----------
 2 files changed, 9 insertions(+), 11 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 9a0a93fc5..c5d5ccfde 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -53,6 +53,9 @@ The <action> type attribute can be add,update,fix,remove.
 
     <body>
         <release version="TBA" date="TBA" description="TBA"
+            <action issue="NET-359" dev="sebb" type="fix">
+            CopyStreamAdapter unconditionally resets the CopyStreamEvent source and is inefficient
+            </action>
             <action issue="NET-355" dev="sebb" type="fix">
             examples.nntp.NNTPUtils does not compile
             </action>
diff --git a/src/main/java/org/apache/commons/net/io/CopyStreamAdapter.java b/src/main/java/org/apache/commons/net/io/CopyStreamAdapter.java
index 29bc293ed..a42ccc76c 100644
--- a/src/main/java/org/apache/commons/net/io/CopyStreamAdapter.java
+++ b/src/main/java/org/apache/commons/net/io/CopyStreamAdapter.java
@@ -63,9 +63,10 @@ public CopyStreamAdapter()
      */
     public void bytesTransferred(CopyStreamEvent event)
     {
-        bytesTransferred(event.getTotalBytesTransferred(),
-                         event.getBytesTransferred(),
-                         event.getStreamSize());
+        for (EventListener listener : internalListeners)
+        {
+            ((CopyStreamListener) (listener)).bytesTransferred(event);
+        }
     }
 
     /**
@@ -86,16 +87,10 @@ public void bytesTransferred(CopyStreamEvent event)
     public void bytesTransferred(long totalBytesTransferred,
                                  int bytesTransferred, long streamSize)
     {
-        CopyStreamEvent event;
-
-        event = new CopyStreamEvent(this,
-                                    totalBytesTransferred,
-                                    bytesTransferred,
-                                    streamSize);
-
         for (EventListener listener : internalListeners)
         {
-            ((CopyStreamListener) (listener)).bytesTransferred(event);
+            ((CopyStreamListener) (listener)).bytesTransferred(
+                    totalBytesTransferred, bytesTransferred, streamSize);
         }
     }
 
