From 34acf5690d3b1370eec91abfee0665252b1c3ec7 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 2 Feb 2010 22:28:00 +0000
Subject: [PATCH] FIX: Creation of symlinks problematic in Windows with Cygwin
 1.7 (IVY-1165)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@905823 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                |  1 +
 src/java/org/apache/ivy/util/FileUtil.java | 10 +++++++++-
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index dd33299c9..78a697e17 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -107,6 +107,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Trace a message when a property file referenced from the settings doesn't exixts (IVY-1074)
 - IMPROVEMENT: use defaultconf in combination with defaultconfmapping (IVY-1135) (thanks to Jon Schneider)
 
+- FIX: Creation of symlinks problematic in Windows with Cygwin 1.7 (IVY-1165)
 - FIX: add ability to programmatically change default resolver (IVY-1163) (thanks to Jason Trump)
 - FIX: ivy.settings.dir space escaping problem (IVY-1162)
 - FIX: Ivy cannot parse alternate format for Maven MD5 files (IVY-1155)
diff --git a/src/java/org/apache/ivy/util/FileUtil.java b/src/java/org/apache/ivy/util/FileUtil.java
index 6a8e55e5d..522b42848 100644
--- a/src/java/org/apache/ivy/util/FileUtil.java
+++ b/src/java/org/apache/ivy/util/FileUtil.java
@@ -86,8 +86,16 @@ public static void symlink(File src, File dest, CopyProgressListener l, boolean
 
                 throw new IOException("error symlinking " + src + " to " + dest + ":\n" + error);
             }
+            
+            // check if the creation of the symbolic link was successful
             if (!dest.exists()) {
-                throw new IOException("error symlinking " + dest + " doesn't exists"); 
+                throw new IOException("error symlinking: " + dest + " doesn't exists");
+            }
+            
+            // check if the result is a true symbolic link
+            if (dest.getAbsolutePath().equals(dest.getCanonicalPath())) {
+                overwrite = true; // just make sure we do overwrite the invalid symlink!
+                throw new IOException("error symlinking: " + dest + " isn't a symlink"); 
             }
         } catch (IOException x) {
             Message.verbose("symlink failed; falling back to copy");
