From bd0593e136edca76a28757ad1be3d9f90099bfac Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sat, 11 Aug 2007 14:51:29 +0000
Subject: [PATCH] CONFIGURATION-291:
 AbstractHierarchicalFileConfiguration.addNodes() now correctly triggers the
 auto save mechanism

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@564927 13f79535-47bb-0310-9956-ffa450edef68
---
 ...AbstractHierarchicalFileConfiguration.java | 15 +++++++++++++++
 .../configuration/TestXMLConfiguration.java   | 19 +++++++++++++++++++
 xdocs/changes.xml                             |  4 ++++
 3 files changed, 38 insertions(+)

diff --git a/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java b/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
index 8708e78b95..d5cf327fec 100644
--- a/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
+++ b/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
@@ -23,6 +23,7 @@
 import java.io.InputStream;
 import java.io.OutputStream;
 import java.net.URL;
+import java.util.Collection;
 import java.util.Iterator;
 import java.util.List;
 
@@ -325,6 +326,20 @@ public boolean isEmpty()
         return super.isEmpty();
     }
 
+    /**
+     * Directly adds sub nodes to this configuration. This implementation checks
+     * whether auto save is necessary after executing the operation.
+     *
+     * @param the key where the nodes are to be added
+     * @param nodes a collection with the nodes to be added
+     * @since 1.5
+     */
+    public void addNodes(String key, Collection nodes)
+    {
+        super.addNodes(key, nodes);
+        delegate.possiblySave();
+    }
+
     /**
      * Fetches a list of nodes, which are selected by the specified key. This
      * implementation will perform a reload if necessary.
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 63afa181f5..ef6b503244 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -26,6 +26,8 @@
 import java.io.StringReader;
 import java.io.StringWriter;
 import java.net.URL;
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.Iterator;
 import java.util.List;
 
@@ -1157,6 +1159,23 @@ public void testAddNodesCopy() throws ConfigurationException
         checkSavedConfig(checkConf);
     }
 
+    /**
+     * Tests whether the addNodes() method triggers an auto save.
+     */
+    public void testAutoSaveAddNodes() throws ConfigurationException
+    {
+        conf.setFile(testSaveConf);
+        conf.setAutoSave(true);
+        HierarchicalConfiguration.Node node = new HierarchicalConfiguration.Node(
+                "addNodesTest", Boolean.TRUE);
+        Collection nodes = new ArrayList(1);
+        nodes.add(node);
+        conf.addNodes("test.autosave", nodes);
+        XMLConfiguration c2 = new XMLConfiguration(testSaveConf);
+        assertTrue("Added nodes are not saved", c2
+                .getBoolean("test.autosave.addNodesTest"));
+    }
+
     /**
      * Prepares a configuration object for testing a reload operation.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index deaaf7f212..980c7b9914 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.5-SNAPSHOT" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-291">
+        The addNodes() method of hierarchical file-based configurations now
+        correctly triggers an auto save.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-287">
         HierarchicalConfiguration.addNodes() now resets the reference property
         of all nodes to be added. This fixes a problem with XMLConfiguration,
