From 902a680951f318488a4bbe0184a3a223c5709b01 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Nicolas=20Laleve=CC=81e?= <nicolas.lalevee@hibnet.org>
Date: Tue, 28 Oct 2014 00:36:39 +0100
Subject: [PATCH] =?UTF-8?q?IVY-1452:=20NullPointerException=20when=20acces?=
 =?UTF-8?q?sing=20charset=20to=20invalid=20URL=20(Thanks=20to=20Fr=C3=A9d?=
 =?UTF-8?q?=C3=A9ric=20Riviere)?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 CHANGES.txt                                           | 1 +
 src/java/org/apache/ivy/util/url/ApacheURLLister.java | 9 ++++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 047cea0ed..4d18a9df0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -153,6 +153,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: The SSH resolvers fails if the un-required jsch jar is missing (IVY-1471)
 - FIX: failed to resolve dynamic revisions in some cases for URL repositories (IVY-1472)
 - FIX: ClassCastException in Eclipse 4.4.1 (IVY-1487) (Thanks to Carsten Pfeiffer)
+- FIX: NullPointerException when accessing charset to invalid URL (IVY-1452) (Thanks to Frédéric Riviere)
 
    2.4.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/util/url/ApacheURLLister.java b/src/java/org/apache/ivy/util/url/ApacheURLLister.java
index 1b92fb80a..2df69b084 100644
--- a/src/java/org/apache/ivy/util/url/ApacheURLLister.java
+++ b/src/java/org/apache/ivy/util/url/ApacheURLLister.java
@@ -29,6 +29,7 @@
 
 import org.apache.ivy.util.FileUtil;
 import org.apache.ivy.util.Message;
+import org.apache.ivy.util.url.URLHandler.URLInfo;
 
 /**
  * Utility class which helps to list urls under a given url. This has been tested with Apache 1.3.33
@@ -108,7 +109,13 @@ public List retrieveListing(URL url, boolean includeFiles, boolean includeDirect
         }
 
         URLHandler urlHandler = URLHandlerRegistry.getDefault();
-        String charset = urlHandler.getURLInfo(url).getBodyCharset();
+        URLInfo urlInfo = urlHandler.getURLInfo(url);
+        if (urlInfo == URLHandler.UNAVAILABLE) {
+            return urlList; // not found => return empty list
+        }
+        // here, urlInfo is valid
+        String charset = urlInfo.getBodyCharset();
+
         InputStream contentStream = urlHandler.openStream(url);
         BufferedReader r = new BufferedReader(new InputStreamReader(contentStream, charset));
 
