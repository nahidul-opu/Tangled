From b94a9e981799af5cd9856e63204c8f3b7b7e1555 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 11 May 2010 00:38:21 +0000
Subject: [PATCH] NET-302 FTP: initiateListParsing should not cache entryParser

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/branches/NET_2_0@942971 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/commons/net/ftp/FTPClient.java | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/main/java/org/apache/commons/net/ftp/FTPClient.java b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
index ae832199f..92ec26ac2 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
@@ -287,6 +287,9 @@ public class FTPClient extends FTP
     // __entryParser is a cached value that should not be referenced directly
     // except when assigned in listFiles(String, String) and __initDefaults.
     private FTPFileEntryParser __entryParser;
+    
+    // Key used to create the parser; necessary to ensure that the parser type is not ignored
+    private String __entryParserKey;
 
     private FTPClientConfig __configuration;
 
@@ -333,6 +336,7 @@ private void __initDefaults()
         __restartOffset      = 0;
         __systemName         = null;
         __entryParser        = null;
+        __entryParserKey    = "";
         __bufferSize         = Util.DEFAULT_COPY_BUFFER_SIZE;
     }
 
@@ -2386,12 +2390,13 @@ public FTPListParseEngine initiateListParsing(
     {
         // We cache the value to avoid creation of a new object every
         // time a file listing is generated.
-        if(__entryParser == null) {
+        if(__entryParser == null ||  ! __entryParserKey.equals(parserKey)) {
             if (null != parserKey) {
                 // if a parser key was supplied in the parameters,
-                // use that to create the paraser
+                // use that to create the parser
                 __entryParser =
                     __parserFactory.createFileEntryParser(parserKey);
+                __entryParserKey = parserKey;
 
             } else {
                 // if no parserKey was supplied, check for a configuration
@@ -2399,12 +2404,15 @@ public FTPListParseEngine initiateListParsing(
                 if (null != __configuration) {
                     __entryParser =
                         __parserFactory.createFileEntryParser(__configuration);
+                    __entryParserKey = __configuration.getServerSystemKey();
                 } else {
                     // if a parserKey hasn't been supplied, and a configuration
                     // hasn't been supplied, then autodetect by calling
                     // the SYST command and use that to choose the parser.
+                    final String systemName = getSystemName();
                     __entryParser =
-                        __parserFactory.createFileEntryParser(getSystemName());
+                        __parserFactory.createFileEntryParser(systemName);
+                    __entryParserKey = systemName;
                 }
             }
         }
