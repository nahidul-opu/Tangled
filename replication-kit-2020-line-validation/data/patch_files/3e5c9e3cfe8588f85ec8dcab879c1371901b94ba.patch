From 3e5c9e3cfe8588f85ec8dcab879c1371901b94ba Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 22 May 2014 21:12:24 +0000
Subject: [PATCH] FIX: failed to resolve dynamic revisions in some cases for
 URL repositories (IVY-1472)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1596968 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                        |  1 +
 .../ivy/plugins/resolver/util/ResolverHelper.java  | 14 +++++---------
 2 files changed, 6 insertions(+), 9 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 75c262dc8..ddf859191 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -149,6 +149,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: impossible to get artifacts when data has not been loaded. (IVY-1399) (Thanks to David Turner)
 - FIX: regression introduced by IVY-1457, dependency management wasn't properly handled introducing lots of resolution failures
 - FIX: The SSH resolvers fails if the un-required jsch jar is missing (IVY-1471)
+- FIX: failed to resolve dynamic revisions in some cases for URL repositories (IVY-1472)
 
    2.4.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java b/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java
index 750569648..91411a99b 100644
--- a/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java
+++ b/src/java/org/apache/ivy/plugins/resolver/util/ResolverHelper.java
@@ -61,10 +61,10 @@ public static String[] listTokenValues(Repository rep, String pattern, String to
 
             try {
                 Message.debug("\tusing " + rep + " to list all in " + root);
-                List all = rep.list(root);
+                String[] all = listAll(rep, root);
                 if (all != null) {
-                    Message.debug("\t\tfound " + all.size() + " urls");
-                    List ret = new ArrayList(all.size());
+                    Message.debug("\t\tfound " + all.length + " urls");
+                    List<String> ret = new ArrayList<String>(all.length);
                     int endNameIndex = pattern.indexOf(fileSep, slashIndex + 1);
                     String namePattern;
                     if (endNameIndex != -1) {
@@ -75,9 +75,8 @@ public static String[] listTokenValues(Repository rep, String pattern, String to
                     namePattern = namePattern.replaceAll("\\.", "\\\\.");
                     namePattern = IvyPatternHelper.substituteToken(namePattern, token, "(.+)");
                     Pattern p = Pattern.compile(namePattern);
-                    for (Iterator iter = all.iterator(); iter.hasNext();) {
-                        String path = (String) iter.next();
-                        Matcher m = p.matcher(path.substring(root.length() + 1));
+                    for (String path : all) {
+                        Matcher m = p.matcher(path);
                         if (m.matches()) {
                             String value = m.group(1);
                             ret.add(value);
@@ -88,9 +87,6 @@ public static String[] listTokenValues(Repository rep, String pattern, String to
                 } else {
                     return null;
                 }
-            } catch (IOException e) {
-                Message.verbose("problem while listing resources in " + root + " with " + rep, e);
-                return null;
             } catch (Exception e) {
                 Message.warn("problem while listing resources in " + root + " with " + rep, e);
                 return null;
