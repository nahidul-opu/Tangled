From d57060f6a7a345be121bb2f3b17bcb7a5292d87b Mon Sep 17 00:00:00 2001
From: Mario Ivankovits <imario@apache.org>
Date: Mon, 19 Mar 2007 19:47:13 +0000
Subject: [PATCH] VFS-112: avoid deadlock under some circumstances

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/vfs/trunk@520070 13f79535-47bb-0310-9956-ffa450edef68
---
 .../vfs/provider/AbstractFileSystem.java      | 46 +++++++++++--------
 1 file changed, 26 insertions(+), 20 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java b/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java
index 3dc0861e78..758165b481 100644
--- a/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java
+++ b/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java
@@ -504,30 +504,36 @@ void freeResources()
      */
     private void fireEvent(final AbstractFileChangeEvent event)
     {
-        synchronized (listenerMap)
+		FileListener[] fileListeners = null;
+		final FileObject file = event.getFile();
+
+		synchronized (listenerMap)
         {
-            final FileObject file = event.getFile();
             final ArrayList listeners = (ArrayList) listenerMap.get(file.getName());
             if (listeners != null)
             {
-            	FileListener[] fileListeners = (FileListener[]) listeners.toArray(new FileListener[listeners.size()]);
-                for (int i = 0; i < fileListeners.length; i++)
-                {
-                    final FileListener fileListener = fileListeners[i];
-                    try
-                    {
-                        event.notify(fileListener);
-                    }
-                    catch (final Exception e)
-                    {
-                        final String message = Messages.getString("vfs.provider/notify-listener.warn", file);
-                        // getLogger().warn(message, e);
-                        VfsLog.warn(getLogger(), log, message, e);
-                    }
-                }
-            }
-        }
-    }
+            	fileListeners = (FileListener[]) listeners.toArray(new FileListener[listeners.size()]);
+			}
+		}
+
+		if (fileListeners != null)
+		{
+			for (int i = 0; i < fileListeners.length; i++)
+			{
+				final FileListener fileListener = fileListeners[i];
+				try
+				{
+					event.notify(fileListener);
+				}
+				catch (final Exception e)
+				{
+					final String message = Messages.getString("vfs.provider/notify-listener.warn", file);
+					// getLogger().warn(message, e);
+					VfsLog.warn(getLogger(), log, message, e);
+				}
+			}
+		}
+	}
 
 	/*
 	void fileDetached(FileObject fileObject)
