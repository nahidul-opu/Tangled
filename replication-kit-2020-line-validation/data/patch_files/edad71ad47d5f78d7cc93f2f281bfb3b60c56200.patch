From edad71ad47d5f78d7cc93f2f281bfb3b60c56200 Mon Sep 17 00:00:00 2001
From: Benedikt Ritter <britter@apache.org>
Date: Wed, 18 Mar 2015 10:20:51 +0000
Subject: [PATCH] VALIDATOR-362: Local part of the email address should not be
 longer than 64 bytes. Thanks to Teo Bran.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1667480 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                      | 3 +++
 .../apache/commons/validator/routines/EmailValidator.java    | 5 +++++
 .../commons/validator/routines/EmailValidatorTest.java       | 1 +
 3 files changed, 9 insertions(+)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index f791a6984..4f516b287 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -43,6 +43,9 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
 
   <release version="1.5.0" date="tba" description="tba">
+    <action issue="VALIDATOR-362" dev="britter" type="fix" due-to="Teo Bran">
+      Local part of the email address should not be longer than 64 bytes
+    </action>
     <action issue="VALIDATOR-356" dev="seb" type="fix" >
       IDN.toASCII drops trailing dot in Java 6 & 7
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
index 2ddef4091..ec864d538 100644
--- a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
+++ b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
@@ -159,6 +159,11 @@ protected boolean isValidDomain(String domain) {
      * @return true if the user name is valid.
      */
     protected boolean isValidUser(String user) {
+        
+        if (user == null || user.length() > 64) {
+            return false;
+        }
+        
         return USER_PATTERN.matcher(user).matches();
     }
 
diff --git a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
index d228e2650..24d2b5caa 100644
--- a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
+++ b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
@@ -367,6 +367,7 @@ public void testEmailUserName()  {
 
         assertTrue(validator.isValid("\"..\"@apache.org"));
 
+        assertFalse(validator.isValid("john56789.john56789.john56789.john56789.john56789.john56789.john5@example.com"));
     }
 
     /**
