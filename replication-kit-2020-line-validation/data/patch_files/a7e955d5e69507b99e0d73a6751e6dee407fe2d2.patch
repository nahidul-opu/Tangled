From a7e955d5e69507b99e0d73a6751e6dee407fe2d2 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Thu, 1 Mar 2007 21:15:07 +0000
Subject: [PATCH] CONFIGURATION-254: Fix for XMLConfiguration.clone(); thanks
 to Carsten Kaiser

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/configuration/trunk@513498 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                               |  6 ++++++
 .../commons/configuration/XMLConfiguration.java |  2 +-
 .../configuration/TestXMLConfiguration.java     | 17 +++++++++++++++++
 xdocs/changes.xml                               |  6 ++++++
 4 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index 1266912195..9c177c75f4 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -85,6 +85,12 @@ BUG FIXES IN 1.4
   that on Unix under certain circumstances absolute file names are interpreted
   as relative ones.
 
+* [CONFIGURATION-254]
+  After cloning a XMLConfiguration there was still a connection to the original
+  configuration. So when the clone was modified and then saved the content of
+  the original configuration was written. This has now been fixed.
+
+
 IMPROVEMENTS IN 1.4
 ===================
 * [CONFIGURATION-155]
diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index 1922c688a0..11a3cf50ae 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -710,7 +710,7 @@ public Object clone()
 
         // clear document related properties
         copy.document = null;
-        copy.setDelegate(createDelegate());
+        copy.setDelegate(copy.createDelegate());
         // clear all references in the nodes, too
         clearReferences(copy.getRootNode());
 
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index f9e5c26bcd..0c4c6f54d7 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -669,6 +669,23 @@ public void testClone()
         assertEquals("foo", copy.getString("element3[@name]"));
     }
 
+    /**
+     * Tests saving a configuration after cloning to ensure that the clone and
+     * the original are completely detachted.
+     */
+    public void testCloneWithSave() throws ConfigurationException
+    {
+        XMLConfiguration c = (XMLConfiguration) conf.clone();
+        c.addProperty("test.newProperty", Boolean.TRUE);
+        conf.addProperty("test.orgProperty", Boolean.TRUE);
+        c.save(testSaveConf);
+        XMLConfiguration c2 = new XMLConfiguration(testSaveConf);
+        assertTrue("New property after clone() was not saved", c2
+                .getBoolean("test.newProperty"));
+        assertFalse("Property of original config was saved", c2
+                .containsKey("test.orgProperty"));
+    }
+
     /**
      * Tests the subset() method. There was a bug that calling subset() had
      * undesired side effects.
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 6f82dfa4b4..b7b24a7793 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,12 @@
 
   <body>
     <release version="1.4-SNAPSHOT" date="in SVN">
+      <action dev="oheger" type="update" issue="CONFIGURATION-254" due-to="Carsten Kaiser">
+        After cloning a XMLConfiguration there was still a connection to the
+        original configuration. So when the clone was modified and then saved
+        the content of the original configuration was written. This has now
+        been fixed.
+      </action>
       <action dev="oheger" type="update">
         Class loading in BeanHelper is now done using ClassUtils of Commons
         Lang.
