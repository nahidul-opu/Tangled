From d55dd62cc0b07e1124369d74dd0095cc2b491dfe Mon Sep 17 00:00:00 2001
From: Niall Pemberton <niallp@apache.org>
Date: Sat, 29 Nov 2008 01:50:11 +0000
Subject: [PATCH] Fix for IO-179 StringIndexOutOfBounds exception on
 FilenameUtils.getPathNoEndSeparator - thanks to Francisco Borges for the
 patch

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@721610 13f79535-47bb-0310-9956-ffa450edef68
---
 src/java/org/apache/commons/io/FilenameUtils.java         | 5 +++--
 src/test/org/apache/commons/io/FilenameUtilsTestCase.java | 4 ++++
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/io/FilenameUtils.java b/src/java/org/apache/commons/io/FilenameUtils.java
index d0fdae2b4c0..7a0f044ad5f 100644
--- a/src/java/org/apache/commons/io/FilenameUtils.java
+++ b/src/java/org/apache/commons/io/FilenameUtils.java
@@ -699,10 +699,11 @@ private static String doGetPath(String filename, int separatorAdd) {
             return null;
         }
         int index = indexOfLastSeparator(filename);
-        if (prefix >= filename.length() || index < 0) {
+        int endIndex = index+separatorAdd;
+        if (prefix >= filename.length() || index < 0 || prefix >= endIndex) {
             return "";
         }
-        return filename.substring(prefix, index + separatorAdd);
+        return filename.substring(prefix, endIndex);
     }
 
     /**
diff --git a/src/test/org/apache/commons/io/FilenameUtilsTestCase.java b/src/test/org/apache/commons/io/FilenameUtilsTestCase.java
index f9dd0248024..eede46628a3 100644
--- a/src/test/org/apache/commons/io/FilenameUtilsTestCase.java
+++ b/src/test/org/apache/commons/io/FilenameUtilsTestCase.java
@@ -556,6 +556,8 @@ public void testGetPrefix() {
     public void testGetPath() {
         assertEquals(null, FilenameUtils.getPath(null));
         assertEquals("", FilenameUtils.getPath("noseperator.inthispath"));
+        assertEquals("", FilenameUtils.getPath("/noseperator.inthispath"));
+        assertEquals("", FilenameUtils.getPath("\\noseperator.inthispath"));
         assertEquals("a/b/", FilenameUtils.getPath("a/b/c.txt"));
         assertEquals("a/b/", FilenameUtils.getPath("a/b/c"));
         assertEquals("a/b/c/", FilenameUtils.getPath("a/b/c/"));
@@ -590,6 +592,8 @@ public void testGetPath() {
     public void testGetPathNoEndSeparator() {
         assertEquals(null, FilenameUtils.getPath(null));
         assertEquals("", FilenameUtils.getPath("noseperator.inthispath"));
+        assertEquals("", FilenameUtils.getPathNoEndSeparator("/noseperator.inthispath"));
+        assertEquals("", FilenameUtils.getPathNoEndSeparator("\\noseperator.inthispath"));
         assertEquals("a/b", FilenameUtils.getPathNoEndSeparator("a/b/c.txt"));
         assertEquals("a/b", FilenameUtils.getPathNoEndSeparator("a/b/c"));
         assertEquals("a/b/c", FilenameUtils.getPathNoEndSeparator("a/b/c/"));
