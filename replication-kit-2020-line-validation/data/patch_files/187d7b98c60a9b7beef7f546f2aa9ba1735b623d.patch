From 3ecb70ad9bcfc9e97424af3c16a41b795f75f54a Mon Sep 17 00:00:00 2001
From: rherget <rherget@unknown>
Date: Tue, 12 Mar 2013 11:09:22 +0000
Subject: [PATCH] GORA-210 thread safety: fix
 java.util.ConcurrentModificationException

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1455488 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                    | 2 ++
 .../java/org/apache/gora/cassandra/store/CassandraStore.java   | 3 ++-
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 56af76c96..af81e9a59 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -6,6 +6,8 @@ Gora Change Log
 
 trunk (current development)
 
+* GORA-210 thread safety: fix java.util.ConcurrentModificationException (rherget)
+
 * GORA-190 Add "version" switch to bin/gora script (lewismc)
 
 * GORA-169 Implement correct logging for KeySpaces and attributes in CassandraMappingManager (lewismc)
diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
index d3f00ca00..2d6649cd6 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
@@ -27,6 +27,7 @@
 import java.util.Map;
 import java.util.Properties;
 import java.util.Set;
+import java.util.Collections;
 
 import me.prettyprint.cassandra.serializers.IntegerSerializer;
 import me.prettyprint.cassandra.serializers.StringSerializer;
@@ -72,7 +73,7 @@ public class CassandraStore<K, T extends PersistentBase> extends DataStoreBase<K
    * We want to iterate over the keys in insertion order.
    * We don't want to lock the entire collection before iterating over the keys, since in the meantime other threads are adding entries to the map.
    */
-  private Map<K, T> buffer = new LinkedHashMap<K, T>();
+  private Map<K, T> buffer = Collections.synchronizedMap(new LinkedHashMap<K, T>());
   
   public CassandraStore() throws Exception {
     // this.cassandraClient.initialize();
