From 1cfd0189d6d0c575a0e0ca848866b9c0c22ac0da Mon Sep 17 00:00:00 2001
From: Colm O Heigeartaigh <coheigea@apache.org>
Date: Thu, 7 Mar 2013 10:32:17 +0000
Subject: [PATCH] [SANTUARIO-353] - ReferenceSubTreeData.iterator() does not
 return nodes in document order

git-svn-id: https://svn.apache.org/repos/asf/santuario/xml-security-java/trunk@1453761 13f79535-47bb-0310-9956-ffa450edef68
---
 .../xml/security/signature/Reference.java     | 22 ++++++++++++++++++-
 .../reference/ReferenceSubTreeData.java       |  2 +-
 2 files changed, 22 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/xml/security/signature/Reference.java b/src/main/java/org/apache/xml/security/signature/Reference.java
index ba0ebd1099..289975b7aa 100644
--- a/src/main/java/org/apache/xml/security/signature/Reference.java
+++ b/src/main/java/org/apache/xml/security/signature/Reference.java
@@ -612,7 +612,27 @@ private void cacheDereferencedElement(XMLSignatureInput input) {
             try {
                 final Set<Node> s = input.getNodeSet();
                 referenceData = new ReferenceNodeSetData() {
-                    public Iterator<Node> iterator() { return s.iterator(); }
+                    public Iterator<Node> iterator() { 
+                        return new Iterator<Node>() {
+                            
+                            Iterator<Node> sIterator = s.iterator();
+                            
+                            @Override
+                            public boolean hasNext() {
+                                return sIterator.hasNext();
+                            }
+
+                            @Override
+                            public Node next() {
+                                return sIterator.next();
+                            }
+
+                            @Override
+                            public void remove() {
+                                throw new UnsupportedOperationException();
+                            }
+                        };
+                    }
                 };
             } catch (Exception e) {
                 // log a warning
diff --git a/src/main/java/org/apache/xml/security/signature/reference/ReferenceSubTreeData.java b/src/main/java/org/apache/xml/security/signature/reference/ReferenceSubTreeData.java
index 3374633040..a1ae12e2a6 100644
--- a/src/main/java/org/apache/xml/security/signature/reference/ReferenceSubTreeData.java
+++ b/src/main/java/org/apache/xml/security/signature/reference/ReferenceSubTreeData.java
@@ -131,13 +131,13 @@ private void nodeSetMinusCommentNodes(Node node, List<Node> nodeSet,
         {
             switch (node.getNodeType()) {
                 case Node.ELEMENT_NODE :
+                    nodeSet.add(node);
                     NamedNodeMap attrs = node.getAttributes();
                     if (attrs != null) {
                         for (int i = 0, len = attrs.getLength(); i < len; i++) {
                             nodeSet.add(attrs.item(i));
                         }
                     }
-                    nodeSet.add(node);
                     Node pSibling = null;
                     for (Node child = node.getFirstChild(); child != null;
                         child = child.getNextSibling()) {
