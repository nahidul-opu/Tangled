From c9bceeb3b4674be6097ca707de6e448efcc88c98 Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Mon, 16 Apr 2012 13:03:17 +0000
Subject: [PATCH] [IO-319] FileUtils.sizeOfDirectory follows symbolic links.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@1326588 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                            |  6 ++++++
 src/main/java/org/apache/commons/io/FileUtils.java | 14 +++++++++++---
 .../org/apache/commons/io/FileUtilsTestCase.java   | 13 +++++++++++++
 3 files changed, 30 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 8d538144255..1b8551baf02 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -45,6 +45,12 @@ The <action> type attribute can be add,update,fix,remove.
   </properties>
 
   <body>
+    <!-- The release date is the date RC is cut -->
+    <release version="2.4" date="2012-TDB-TDB" description="">
+      <action issue="IO-319" dev="ggregory" type="add" due-to="ggregory">
+        FileUtils.sizeOfDirectory follows symbolic links.
+      </action>            
+    </release>
     <!-- The release date is the date RC is cut -->
     <release version="2.3" date="2012-April-10" description="">
       <action issue="IO-322" dev="ggregory" type="add" due-to="ggregory">
diff --git a/src/main/java/org/apache/commons/io/FileUtils.java b/src/main/java/org/apache/commons/io/FileUtils.java
index baf7d103f47..ae88840df99 100644
--- a/src/main/java/org/apache/commons/io/FileUtils.java
+++ b/src/main/java/org/apache/commons/io/FileUtils.java
@@ -2354,12 +2354,20 @@ public static long sizeOfDirectory(File directory) {
 
         long size = 0;
 
-        File[] files = directory.listFiles();
+        final File[] files = directory.listFiles();
         if (files == null) {  // null if security restricted
             return 0L;
         }
-        for (File file : files) {
-            size += sizeOf(file);
+        for (final File file : files) {
+            boolean isSymLink;
+            try {
+                isSymLink = isSymlink(file);
+            } catch (IOException ioe) {
+                isSymLink = true;
+            }
+            if (!isSymLink) {
+                size += sizeOf(file);
+            }
         }
 
         return size;
diff --git a/src/test/java/org/apache/commons/io/FileUtilsTestCase.java b/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
index 619e49ea3ae..851c3c03cb4 100644
--- a/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
+++ b/src/test/java/org/apache/commons/io/FileUtilsTestCase.java
@@ -711,6 +711,19 @@ public void testSizeOfDirectory() throws Exception {
         file.delete();
         file.mkdir();
 
+        // Create a cyclic symlink
+        if(!FilenameUtils.isSystemWindows()) {
+            Runtime.getRuntime()
+                .exec("ln -s " + file + "/.. " + file + "/cycle");
+        } else {
+            try {
+                Runtime.getRuntime()
+                    .exec("mklink /D " + file + "/cycle" + file + "/.. ");
+            } catch(IOException ioe) { // So that tests run in FAT filesystems
+              //don't fail
+            }
+        }
+
         assertEquals(
             "Unexpected directory size",
             TEST_DIRECTORY_SIZE,
