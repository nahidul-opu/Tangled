From d2a54557bffc8e917d0790bd77b327171661da89 Mon Sep 17 00:00:00 2001
From: Thomas Vandahl <tv@apache.org>
Date: Sat, 31 Mar 2012 19:03:01 +0000
Subject: [PATCH] Apply patch to fix JCS-89

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/jcs/branches/generics-interface@1307877 13f79535-47bb-0310-9956-ffa450edef68
---
 .../jcs/utils/discovery/UDPDiscoveryReceiver.java   | 13 +++++++++++--
 1 file changed, 11 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/jcs/utils/discovery/UDPDiscoveryReceiver.java b/src/java/org/apache/jcs/utils/discovery/UDPDiscoveryReceiver.java
index 396dd1fda..3aecbb4ce 100644
--- a/src/java/org/apache/jcs/utils/discovery/UDPDiscoveryReceiver.java
+++ b/src/java/org/apache/jcs/utils/discovery/UDPDiscoveryReceiver.java
@@ -166,9 +166,18 @@ public Object waitForMessage()
             final ObjectInputStream objectStream = new ObjectInputStream( byteStream );
             obj = objectStream.readObject();
 
-            if ( log.isDebugEnabled() )
+            if ( (obj != null) && (obj instanceof UDPDiscoveryMessage) )
             {
-                log.debug( "Read object from address [" + packet.getSocketAddress() + "], object=[" + obj + "]" );
+            	// Ensure that the address we're supposed to send to is, indeed, the address
+            	// of the machine on the other end of this connection.  This guards against
+            	// instances where we don't exactly get the right local host address
+            	UDPDiscoveryMessage msg = (UDPDiscoveryMessage) obj;
+            	msg.setHost(packet.getAddress().getHostAddress());
+
+	            if ( log.isDebugEnabled() )
+	            {
+	                log.debug( "Read object from address [" + packet.getSocketAddress() + "], object=[" + obj + "]" );
+	            }
             }
         }
         catch ( Exception e )
