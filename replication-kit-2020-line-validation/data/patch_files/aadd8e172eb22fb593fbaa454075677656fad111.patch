From aadd8e172eb22fb593fbaa454075677656fad111 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Mon, 3 Mar 2014 21:44:15 +0000
Subject: [PATCH] LANG-981 DurationFormatUtils#lexx does not detect unmatched
 quote char

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/lang/trunk@1573770 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                    | 1 +
 .../org/apache/commons/lang3/time/DurationFormatUtils.java | 3 +++
 .../apache/commons/lang3/time/DurationFormatUtilsTest.java | 7 ++++++-
 3 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 8ec9e9d86b0..067f5dab07f 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -22,6 +22,7 @@
   <body>
 
   <release version="3.4" date="TBA" description="TBA">
+    <action issue="LANG-981" type="fix" dev="sebb">DurationFormatUtils#lexx does not detect unmatched quote char</action>
     <action issue="LANG-984" type="fix" dev="sebb">DurationFormatUtils does not handle large durations correctly</action>
     <action issue="LANG-982" type="fix" dev="sebb">DurationFormatUtils.formatDuration(61999, "s.SSSS") - ms field size should be 4 digits</action>
     <action issue="LANG-978" type="fix" dev="sebb">Failing tests with Java 8 b128</action>
diff --git a/src/main/java/org/apache/commons/lang3/time/DurationFormatUtils.java b/src/main/java/org/apache/commons/lang3/time/DurationFormatUtils.java
index 1a421259d4b..f1e1f90f8f8 100644
--- a/src/main/java/org/apache/commons/lang3/time/DurationFormatUtils.java
+++ b/src/main/java/org/apache/commons/lang3/time/DurationFormatUtils.java
@@ -542,6 +542,9 @@ static Token[] lexx(final String format) {
                 buffer = null;
             }
         }
+        if (inLiteral) { // i.e. we have not found the end of the literal
+            throw new IllegalArgumentException("Unmatched quote in format: " + format);
+        }
         return list.toArray(new Token[list.size()]);
     }
 
diff --git a/src/test/java/org/apache/commons/lang3/time/DurationFormatUtilsTest.java b/src/test/java/org/apache/commons/lang3/time/DurationFormatUtilsTest.java
index 07214486c26..1311d904fef 100644
--- a/src/test/java/org/apache/commons/lang3/time/DurationFormatUtilsTest.java
+++ b/src/test/java/org/apache/commons/lang3/time/DurationFormatUtilsTest.java
@@ -553,7 +553,12 @@ public void testDurationsByBruteForce() {
         bruteForce(1969, 1, 28, "M", Calendar.MONTH);  // tests for 48 years
         //bruteForce(1996, 1, 29, "M", Calendar.MONTH);  // this will fail
     }
-    
+
+    @Test(expected=IllegalArgumentException.class)
+    public void testLANG981() { // unmatched quote char in lexx
+        DurationFormatUtils.lexx("'yMdHms''S");
+    }
+
     private static final int FOUR_YEARS = 365 * 3 + 366;
     
     // Takes a minute to run, so generally turned off
