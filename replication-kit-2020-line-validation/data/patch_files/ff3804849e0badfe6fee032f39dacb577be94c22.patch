From ff3804849e0badfe6fee032f39dacb577be94c22 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Tue, 28 Feb 2006 09:19:06 +0000
Subject: [PATCH] FIX IVY-180

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484222 13f79535-47bb-0310-9956-ffa450edef68
---
 src/java/fr/jayasoft/ivy/Ivy.java             |  3 +--
 src/java/fr/jayasoft/ivy/ant/IvyRetrieve.java |  1 -
 .../fr/jayasoft/ivy/ant/IvyRetrieveTest.java  | 22 ++++-------------
 .../1/org2/mod2.3/ivys/ivy-0.4.1.xml          | 24 +++++++++++++++++++
 .../1/org2/mod2.5/ivys/ivy-0.6.1.xml          | 10 ++++++++
 5 files changed, 39 insertions(+), 21 deletions(-)
 create mode 100644 test/repositories/1/org2/mod2.3/ivys/ivy-0.4.1.xml
 create mode 100644 test/repositories/1/org2/mod2.5/ivys/ivy-0.6.1.xml

diff --git a/src/java/fr/jayasoft/ivy/Ivy.java b/src/java/fr/jayasoft/ivy/Ivy.java
index ed73417db..b0dd734da 100644
--- a/src/java/fr/jayasoft/ivy/Ivy.java
+++ b/src/java/fr/jayasoft/ivy/Ivy.java
@@ -1462,8 +1462,7 @@ public void retrieve(ModuleId moduleId, String[] confs, final File cache, String
                 if (destIvyPattern != null) {
                     ModuleRevisionId[] mrids = parser.getRealDependencyRevisionIds(moduleId, conf, cache);
                     for (int j = 0; j < mrids.length; j++) {
-                        ModuleRevisionId mrid = mrids[i];
-                        artifacts.add(new DefaultArtifact(mrid, new Date(), "ivy", "ivy", "xml"));
+                        artifacts.add(new DefaultArtifact(mrids[j], new Date(), "ivy", "ivy", "xml"));
                     }
                 }
                 for (Iterator iter = artifacts.iterator(); iter.hasNext();) {
diff --git a/src/java/fr/jayasoft/ivy/ant/IvyRetrieve.java b/src/java/fr/jayasoft/ivy/ant/IvyRetrieve.java
index ab4ca033f..e2a41e70c 100644
--- a/src/java/fr/jayasoft/ivy/ant/IvyRetrieve.java
+++ b/src/java/fr/jayasoft/ivy/ant/IvyRetrieve.java
@@ -77,7 +77,6 @@ public void execute() throws BuildException {
             _cache = ivy.getDefaultCache();
         }
         _pattern = getProperty(_pattern, ivy, "ivy.retrieve.pattern");
-        _ivypattern = getProperty(_ivypattern, ivy, "ivy.retrieve.ivy.pattern");
         _conf = getProperty(_conf, ivy, "ivy.resolved.configurations");
         if ("*".equals(_conf)) {
             _conf = getProperty(ivy, "ivy.resolved.configurations");
diff --git a/test/java/fr/jayasoft/ivy/ant/IvyRetrieveTest.java b/test/java/fr/jayasoft/ivy/ant/IvyRetrieveTest.java
index cb20ed701..2e819bf46 100644
--- a/test/java/fr/jayasoft/ivy/ant/IvyRetrieveTest.java
+++ b/test/java/fr/jayasoft/ivy/ant/IvyRetrieveTest.java
@@ -119,31 +119,17 @@ public void testHaltOnFailure() throws Exception {
         }
     }
 
-    public void testDefaultIvyPattern() throws Exception {
-        //       mod2.1 depends on mod1.1 which depends on mod1.2
-        _project.setProperty("ivy.dep.file", "test/repositories/1/org2/mod2.3/ivys/ivy-0.4.xml");
-        _project.setProperty("ivy.retrieve.ivy.pattern", IVY_RETRIEVE_PATTERN);
-
-        _retrieve.execute();
-
-        String ivyPattern = _project.getProperty("ivy.retrieve.ivy.pattern");
-        assertTrue(new File(IvyPatternHelper.substitute(ivyPattern,
-                "org2", "mod2.1", "0.3", "ivy", "ivy", "xml")).exists());
-        assertTrue(new File(IvyPatternHelper.substitute(ivyPattern,
-                "org1", "mod1.1", "1.0", "ivy", "ivy", "xml")).exists());
-        assertFalse(new File(IvyPatternHelper.substitute(ivyPattern,
-                "org1", "mod1.2", "2.0", "ivy", "ivy", "xml")).exists());
-    }
-
     public void testCustomIvyPattern() throws Exception {
-        //       mod2.3 depends on mod2.1 which depends on mod1.1 which depends on mod1.2
-        _project.setProperty("ivy.dep.file", "test/repositories/1/org2/mod2.3/ivys/ivy-0.4.xml");
+        //      mod2.5 depends on virtual mod2.3 which depends on mod2.1 which depends on mod1.1 which depends on mod1.2
+        _project.setProperty("ivy.dep.file", "test/repositories/1/org2/mod2.5/ivys/ivy-0.6.1.xml");
 
         String ivyPattern = IVY_RETRIEVE_PATTERN;
 
         _retrieve.setIvypattern(ivyPattern);
         _retrieve.execute();
 
+        assertTrue(new File(IvyPatternHelper.substitute(ivyPattern,
+                "org2", "mod2.3", "0.4.1", "ivy", "ivy", "xml")).exists());
         assertTrue(new File(IvyPatternHelper.substitute(ivyPattern,
                 "org2", "mod2.1", "0.3", "ivy", "ivy", "xml")).exists());
         assertTrue(new File(IvyPatternHelper.substitute(ivyPattern,
diff --git a/test/repositories/1/org2/mod2.3/ivys/ivy-0.4.1.xml b/test/repositories/1/org2/mod2.3/ivys/ivy-0.4.1.xml
new file mode 100644
index 000000000..75732497f
--- /dev/null
+++ b/test/repositories/1/org2/mod2.3/ivys/ivy-0.4.1.xml
@@ -0,0 +1,24 @@
+<ivy-module version="1.0">
+	<info organisation="org2"
+	       module="mod2.3"
+	       revision="0.4.1"
+	       status="integration"
+	       publication="20041101110000"
+	/>
+	<configurations>
+		<conf name="myconf1" description="desc 1"/>
+		<conf name="myconf2" description="desc 2"/>
+	</configurations>
+	<publications />
+	<dependencies>
+		<dependency name="mod2.1" rev="0.3">
+			<!-- only art21A of mod2.1 should be retrieved in myconf1, 
+			     and all artifacts will be retrieved in myconf2
+			     If you don't need all artifacts in myconf2,
+			     you should had conf information on the dependency itself
+			     saying you depend on mod2.1 only in myconf1:
+			     example: conf="myconf1->*" -->
+			<artifact name="art21A" type="jar" conf="myconf1"/>
+		</dependency>
+	</dependencies>
+</ivy-module>
diff --git a/test/repositories/1/org2/mod2.5/ivys/ivy-0.6.1.xml b/test/repositories/1/org2/mod2.5/ivys/ivy-0.6.1.xml
new file mode 100644
index 000000000..d9de94579
--- /dev/null
+++ b/test/repositories/1/org2/mod2.5/ivys/ivy-0.6.1.xml
@@ -0,0 +1,10 @@
+<ivy-module version="1.0">
+	<info organisation="org2"
+	       module="mod2.5"
+	       revision="0.6.1"
+	       status="integration"
+	/>
+	<dependencies>
+		<dependency name="mod2.3" rev="0.4.1"/>
+	</dependencies>
+</ivy-module>
