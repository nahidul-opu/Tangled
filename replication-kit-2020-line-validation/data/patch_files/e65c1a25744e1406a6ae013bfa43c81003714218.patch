From e65c1a25744e1406a6ae013bfa43c81003714218 Mon Sep 17 00:00:00 2001
From: Woonsan Ko <woonsan@apache.org>
Date: Thu, 28 Nov 2013 06:46:24 +0000
Subject: [PATCH] SCXML-167: remove timer first to avoid some corner cases
 (e.g, removing other timer by unexpected non-unique sendid)

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/scxml/trunk@1546299 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/commons/scxml2/env/SimpleScheduler.java     | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/main/java/org/apache/commons/scxml2/env/SimpleScheduler.java b/src/main/java/org/apache/commons/scxml2/env/SimpleScheduler.java
index 73f8be40f..31bc873f8 100644
--- a/src/main/java/org/apache/commons/scxml2/env/SimpleScheduler.java
+++ b/src/main/java/org/apache/commons/scxml2/env/SimpleScheduler.java
@@ -233,13 +233,13 @@ class DelayedEventTask extends TimerTask {
          */
         @Override
         public void run() {
+            timers.remove(sendId);
             try {
                 executor.triggerEvent(new TriggerEvent(event,
                     TriggerEvent.SIGNAL_EVENT, payload));
             } catch (ModelException me) {
                 log.error(me.getMessage(), me);
             }
-            timers.remove(sendId);
             if (log.isDebugEnabled()) {
                 log.debug("Fired event '" + event + "' as scheduled by "
                     + "<send> with id '" + sendId + "'");
