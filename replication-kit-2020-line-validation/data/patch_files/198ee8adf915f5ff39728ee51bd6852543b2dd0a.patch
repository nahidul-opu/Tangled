From 198ee8adf915f5ff39728ee51bd6852543b2dd0a Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Tue, 3 Nov 2009 01:43:58 +0000
Subject: [PATCH] Apply patch for VFS-286 provided by Kirill Safonov

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@832254 13f79535-47bb-0310-9956-ffa450edef68
---
 .../vfs/provider/sftp/SftpFileObject.java     | 20 ++++++++++++++++++-
 xdocs/changes.xml                             |  5 +++++
 2 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileObject.java b/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileObject.java
index 00e862aa64..ff3db66024 100644
--- a/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileObject.java
+++ b/core/src/main/java/org/apache/commons/vfs/provider/sftp/SftpFileObject.java
@@ -301,7 +301,25 @@ protected FileObject[] doListChildrenResolved() throws Exception
                 return null;
             }
 
-            vector = channel.ls(".");
+            try
+            {
+                vector = channel.ls(".");
+            }
+            catch (SftpException e)
+            {
+                try
+                {
+                    if (relPath != null)
+                    {
+                        channel.cd(workingDirectory);
+                    }
+                }
+                catch (SftpException e2)
+                {
+                    throw e;
+                }
+                throw e;
+            }
 
             try
             {
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 8e3c1e7368..6274567a12 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="2.0" date="in SVN" description="">
+      <action dev="rgoers" type="fix" issue="VFS-286" due-to="Kirill Safonov">
+        SftpFileObject.doListChildrenResolved() changes the working dir before doing ChannelSftp.ls() call.
+        If ls() throws an exception, the current directory is not reset. All the subsequent operations that rely on the
+        current dir will fail trying to change into nonexistent directory.
+      </action>
       <action dev="rgoers" type="add" issue="VFS-244">
         Rename HttpRandomAccesContent to HttpRandomAccessContent.
       </action>
