From 74c9be792942b8af66c9ba5648490d36a2c0de88 Mon Sep 17 00:00:00 2001
From: Nicolas Lalevee <hibou@apache.org>
Date: Thu, 8 May 2008 08:48:10 +0000
Subject: [PATCH] IVY-815: SFTPRepository incorrectly calculates last modified
 time for resources

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@654447 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                               | 2 ++
 .../ivy/plugins/repository/sftp/SFTPRepository.java       | 8 +++++---
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 6b797beb7..de0a3cbf3 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -44,6 +44,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Stephen Nesbitt
 	Joshua Nichols
 	Bernard Niset
+	David Maplesden
 	Glen Marchesani
 	Mathias Muller
 	Peter Oxenham
@@ -79,6 +80,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: SFTPRepository incorrectly calculates last modified time for resources (IVY-815)
 - FIX: Filesystem resolver does not evaluate [branch] token when publishing (IVY-814)
 - FIX: Using ivy:settings with the "id" attribute not behaving as expected (IVY-809)
 - FIX: onMissingDescriptor doesn't work due to == comparison (IVY-805) (thanks to Ben Hale)
diff --git a/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java b/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java
index 2a71cb039..bd2be55df 100644
--- a/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java
+++ b/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java
@@ -46,7 +46,9 @@
  * 0, 1, 2 and 3
  */
 public class SFTPRepository extends AbstractSshBasedRepository {
-    private static final int MILLIS_PER_SECOND = 1000;
+    // this must be a long to ensure the multiplication done below uses longs
+    // instead of ints which are not big enough to hold the result
+    private static final long MILLIS_PER_SECOND = 1000;
 
     private final class MyProgressMonitor implements SftpProgressMonitor {
         private long totalLength;
@@ -92,8 +94,8 @@ public Resource resolveResource(String path) {
                     if (obj instanceof LsEntry) {
                         LsEntry entry = (LsEntry) obj;
                         SftpATTRS attrs = entry.getAttrs();
-                        return new BasicResource(path, true, attrs.getSize(),
-                                attrs.getMTime() * MILLIS_PER_SECOND, false);
+                        return new BasicResource(path, true, attrs.getSize(), attrs.getMTime()
+                                * MILLIS_PER_SECOND, false);
                     }
                 }
             }
