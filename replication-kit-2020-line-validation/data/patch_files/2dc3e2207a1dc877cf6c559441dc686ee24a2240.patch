From 2dc3e2207a1dc877cf6c559441dc686ee24a2240 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Sun, 17 Oct 2010 09:02:27 +0000
Subject: [PATCH] FIX: Cached ivy.xml is invalid if the description contains
 the ampersand entity (&amp;) (IVY-1237)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1023438 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                     | 1 +
 .../ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java      | 2 +-
 .../org/apache/ivy/plugins/parser/xml/test-update-withvar.xml   | 2 +-
 test/java/org/apache/ivy/plugins/parser/xml/test-update.xml     | 2 +-
 test/java/org/apache/ivy/plugins/parser/xml/updated.xml         | 2 +-
 5 files changed, 5 insertions(+), 4 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index c355b766c..d6deb71ae 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -113,6 +113,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	
    trunk
 =====================================
+- FIX: Cached ivy.xml is invalid if the description contains the ampersand entity (&amp;) (IVY-1237)
 - FIX: Couldn't authenticate against sites having the same address as the proxy server (IVY-1234)
 - FIX: OutOfMemoryError when uploading large files using commons-httpclient (IVY-1197) (thanks to Torkild U. Resheim)
 
diff --git a/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java b/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java
index ac9a01a59..7d0bcff37 100644
--- a/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java
+++ b/src/java/org/apache/ivy/plugins/parser/xml/XmlModuleDescriptorUpdater.java
@@ -857,7 +857,7 @@ public void characters(char[] ch, int start, int length) throws SAXException {
                 write(">");
                 justOpen = null;
             }
-            write(String.valueOf(ch, start, length));
+            write(XMLHelper.escape(String.valueOf(ch, start, length)));
             
             //examine characters for current indent level, keeping in mind
             //that our indent might be split across multiple calls to characters()
diff --git a/test/java/org/apache/ivy/plugins/parser/xml/test-update-withvar.xml b/test/java/org/apache/ivy/plugins/parser/xml/test-update-withvar.xml
index f1917471b..0ae85c7b5 100644
--- a/test/java/org/apache/ivy/plugins/parser/xml/test-update-withvar.xml
+++ b/test/java/org/apache/ivy/plugins/parser/xml/test-update-withvar.xml
@@ -37,7 +37,7 @@
 
 		<description homepage="${homepage}">	       
 	This module is <b>great</b> !<br/>
-	You can use it especially with myconf1 and myconf2, and myconf4 is not too bad too.
+	You can use it especially with myconf1 &amp; myconf2, and myconf4 is not too bad too.
 		</description>
 	</info>
 	<configurations>
diff --git a/test/java/org/apache/ivy/plugins/parser/xml/test-update.xml b/test/java/org/apache/ivy/plugins/parser/xml/test-update.xml
index dd0fc4d7c..d868d72f9 100644
--- a/test/java/org/apache/ivy/plugins/parser/xml/test-update.xml
+++ b/test/java/org/apache/ivy/plugins/parser/xml/test-update.xml
@@ -37,7 +37,7 @@
 
 		<description homepage="http://www.my.org/mymodule/">	       
 	This module is <b>great</b> !<br/>
-	You can use it especially with myconf1 and myconf2, and myconf4 is not too bad too.
+	You can use it especially with myconf1 &amp; myconf2, and myconf4 is not too bad too.
 		</description>
 	</info>
 	<configurations>
diff --git a/test/java/org/apache/ivy/plugins/parser/xml/updated.xml b/test/java/org/apache/ivy/plugins/parser/xml/updated.xml
index e0c2e324c..45ae2f4f7 100644
--- a/test/java/org/apache/ivy/plugins/parser/xml/updated.xml
+++ b/test/java/org/apache/ivy/plugins/parser/xml/updated.xml
@@ -32,7 +32,7 @@
 
 		<description homepage="http://www.my.org/mymodule/">	       
 	This module is <b>great</b> !<br/>
-	You can use it especially with myconf1 and myconf2, and myconf4 is not too bad too.
+	You can use it especially with myconf1 &amp; myconf2, and myconf4 is not too bad too.
 		</description>
 	</info>
 	<configurations>
