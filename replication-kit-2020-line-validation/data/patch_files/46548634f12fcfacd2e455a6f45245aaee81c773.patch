From 46548634f12fcfacd2e455a6f45245aaee81c773 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Mon, 14 Sep 2009 00:17:50 +0000
Subject: [PATCH] NET-294 UnixFTPEntryParser fails to parse some entries

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/branches/NET_2_0@814446 13f79535-47bb-0310-9956-ffa450edef68
---
 .../net/ftp/parser/UnixFTPEntryParser.java    | 18 +++++++++++-------
 src/site/xdoc/changes.xml                     |  3 +++
 .../ftp/parser/UnixFTPEntryParserTest.java    | 19 ++++++++++++++++++-
 3 files changed, 32 insertions(+), 8 deletions(-)

diff --git a/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java b/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
index 408d247b2..e1b19190b 100644
--- a/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
+++ b/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
@@ -84,21 +84,24 @@ public class UnixFTPEntryParser extends ConfigurableFTPFileEntryParserImpl
     private static final String REGEX =
         "([bcdelfmpSs-])"
         +"(((r|-)(w|-)([xsStTL-]))((r|-)(w|-)([xsStTL-]))((r|-)(w|-)([xsStTL-])))\\+?\\s*"
-        + "(\\d+)\\s+"
+        + "(\\d+)\\s+"                                  // link count
         + "(?:(\\S+(?:\\s\\S+)*?)\\s+)?"                // owner name (optional spaces)
         + "(?:(\\S+(?:\\s\\S+)*)\\s+)?"                 // group name (optional spaces)
-        + "(\\d+(?:,\\s*\\d+)?)\\s+"
+        + "(\\d+(?:,\\s*\\d+)?)\\s+"                    // size or n,m
         /*
-          numeric or standard format date
+         * numeric or standard format date:
+         *   yyyy-mm-dd (expecting hh:mm to follow)
+         *   MMMM [d]d
+         *   [d]d MMM
         */
-        + "((?:\\d+[-/]\\d+[-/]\\d+)|(?:[a-zA-Z0-9]+\\s+\\S+))\\s+"
+        + "((?:\\d+[-/]\\d+[-/]\\d+)|(?:[a-zA-Z]{3}\\s+\\d{1,2})|(?:\\d{1,2}\\s+[a-zA-Z]{3}))\\s+"
         /* 
-           year (for non-recent standard format) 
-           or time (for numeric or recent standard format  
+           year (for non-recent standard format) - yyyy
+           or time (for numeric or recent standard format) [h]h:mm  
         */
         + "(\\d+(?::\\d+)?)\\s+"
         
-        + "(\\S*)(\\s*.*)";
+        + "(\\S*)(\\s*.*)"; // the rest
 
 
     /**
@@ -186,6 +189,7 @@ public FTPFile parseFTPEntry(String entry) {
             case 'c':
                 isDevice = true;
                 // break; - fall through
+                //$FALL-THROUGH$ TODO change this if DEVICE_TYPE implemented
             case 'f':
             case '-':
                 type = FTPFile.FILE_TYPE;
diff --git a/src/site/xdoc/changes.xml b/src/site/xdoc/changes.xml
index 930898a49..4d3d2ba59 100644
--- a/src/site/xdoc/changes.xml
+++ b/src/site/xdoc/changes.xml
@@ -99,6 +99,9 @@ limitations under the License.
 			<action dev="rwinston" type="fix">
 				Fix inconsistent handling of socket read/write buffer size
 			</action>
+            <action dev="sebb" type="fix" issue="NET-294">
+                UnixFTPEntryParser fails to parse some entries
+            </action>
 		</release>
 
 		<release version="2.0" date="October 20, 2008" description="Java 5.0 release">
diff --git a/src/test/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java b/src/test/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java
index c9423002e..2fb615e75 100644
--- a/src/test/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java
+++ b/src/test/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParserTest.java
@@ -74,7 +74,8 @@ public class UnixFTPEntryParserTest extends FTPParseTestFramework {
             "lrwxrwxrwx   1 neeme neeme             23 Mar  2 18:06 macros -> ./../../global/macros/.",
             "-rw-r--r--   1 ftp      group with spaces in it as allowed in cygwin see bug 38634   83853 Jan 22  2001 zxJDBC-1.2.4.tar.gz",
             "crw-r----- 1 root kmem 0, 27 Jan 30 11:42 kmem",  //FreeBSD device
-            "crw-------   1 root     sys      109,767 Jul  2  2004 pci@1c,600000:devctl" //Solaris device
+            "crw-------   1 root     sys      109,767 Jul  2  2004 pci@1c,600000:devctl", //Solaris device
+            "-rwxrwx---   1 ftp      ftp-admin 816026400 Oct  5  2008 bloplab 7 cd1.img", // NET-294
 
 
         };
@@ -158,6 +159,18 @@ public void testOwnerAndGroupNameWithSpaces() {
         assertEquals("test group", f.getGroup());
     }
     
+    public void testNET294() {
+        FTPFile f = getParser().parseFTPEntry(
+                "-rwxrwx---   1 ftp      ftp-admin 816026400 Oct  5  2008 bloplab 7 cd1.img");
+        assertNotNull(f);
+        assertEquals("ftp", f.getUser());
+        assertEquals("ftp-admin", f.getGroup());
+        assertEquals(816026400L,f.getSize());
+        assertNotNull("Timestamp should not be null",f.getTimestamp());
+        assertEquals(2008,f.getTimestamp().get(Calendar.YEAR));
+        assertEquals("bloplab 7 cd1.img",f.getName());
+    }
+    
     public void testGroupNameWithSpaces() {
         FTPFile f = getParser().parseFTPEntry("drwx------ 4 maxm Domain Users 512 Oct 2 10:59 .metadata");
         assertNotNull(f);
@@ -343,6 +356,7 @@ protected void doAdditionalGoodTests(String test, FTPFile f) {
         case 'b':
         case 'c':
             assertEquals(0, f.getHardLinkCount());
+            //$FALL-THROUGH$ TODO this needs to be fixed if a device type is introduced
         case 'f':
         case '-':
             assertEquals("Type of "+ test, type, FTPFile.FILE_TYPE);
@@ -365,5 +379,8 @@ protected void doAdditionalGoodTests(String test, FTPFile f) {
             }
         }
 
+        assertNotNull("Expected to find a timestamp",f.getTimestamp());
+// Perhaps check date range (need to ensure all good examples qualify)
+//        assertTrue(test,f.getTimestamp().get(Calendar.YEAR)>=2000);
     }
 }
