From ca9b94b4b7cdd4bd1282d6c7b2e0d1f81747d6d7 Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Sun, 8 Nov 2009 05:37:10 +0000
Subject: [PATCH] Apply patch for VFS-261

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@833831 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/commons/vfs/provider/webdav/WebdavFileObject.java  | 4 ++--
 xdocs/changes.xml                                             | 3 +++
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs/provider/webdav/WebdavFileObject.java b/core/src/main/java/org/apache/commons/vfs/provider/webdav/WebdavFileObject.java
index 7100224737..852865a4b1 100644
--- a/core/src/main/java/org/apache/commons/vfs/provider/webdav/WebdavFileObject.java
+++ b/core/src/main/java/org/apache/commons/vfs/provider/webdav/WebdavFileObject.java
@@ -21,7 +21,7 @@
 import org.apache.commons.httpclient.HttpMethod;
 import org.apache.commons.httpclient.URIException;
 import org.apache.commons.httpclient.methods.RequestEntity;
-import org.apache.commons.httpclient.methods.StringRequestEntity;
+import org.apache.commons.httpclient.methods.ByteArrayRequestEntity;
 import org.apache.commons.httpclient.util.DateUtil;
 import org.apache.commons.vfs.provider.URLFileName;
 import org.apache.commons.vfs.provider.DefaultFileContent;
@@ -566,7 +566,7 @@ public WebdavOutputStream(WebdavFileObject file) throws FileSystemException
          */
         protected void onClose() throws IOException
         {
-            RequestEntity entity = new StringRequestEntity(out.toString());
+            RequestEntity entity = new ByteArrayRequestEntity(((ByteArrayOutputStream) out).toByteArray());
             URLFileName fileName = (URLFileName) getName();
             String urlStr = urlString(fileName);
             if (builder.isVersioning(getFileSystem().getFileSystemOptions()))
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 4f99b2a92d..1c5d422a75 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,9 @@
 
   <body>
     <release version="2.0" date="in SVN" description="">
+      <action dev="rgoers" type="fix" issue="VFS-261" due-to="Simon Olofsson">
+        WebDAV upload corrupts binary files
+      </action>
       <action dev="rgoers" type="fix" issue="VFS-276" due-to="Vince Bonfanti">
         add ProviderTestConfig.getDefaultFileSystemManager() method
       </action>
