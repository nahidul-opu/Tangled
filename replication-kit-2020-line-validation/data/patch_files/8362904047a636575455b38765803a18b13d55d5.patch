From 8362904047a636575455b38765803a18b13d55d5 Mon Sep 17 00:00:00 2001
From: Thomas Vandahl <tv@apache.org>
Date: Sat, 4 Aug 2012 14:59:56 +0000
Subject: [PATCH] Fix for JCS-77: NullPointerException thrown by
 IndexedDiskCache if IndexedDisk calls fail to initialize.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/jcs/trunk@1369337 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                            |  4 ++++
 .../auxiliary/disk/indexed/IndexedDiskCache.java   | 14 +++++++-------
 2 files changed, 11 insertions(+), 7 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 43356f95a..f718ffdae 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -20,6 +20,10 @@
 	</properties>
 	<body>
 		<release version="2.0" date="unreleased" description="JDK 1.5 based major release">
+            <action dev="tv" type="fix" issue="JCS-77" due-to="Matt Morrisson">
+                NullPointerException thrown by IndexedDiskCache if IndexedDisk calls fail to 
+                initialize.
+            </action>
             <action dev="tv" type="fix" issue="JCS-90" due-to="Diego Rivera">
                 When issuing a shutDown() command, JCS fails to clean up the Queue Processor 
                 thread.
diff --git a/src/java/org/apache/jcs/auxiliary/disk/indexed/IndexedDiskCache.java b/src/java/org/apache/jcs/auxiliary/disk/indexed/IndexedDiskCache.java
index 2c7746060..186723bef 100644
--- a/src/java/org/apache/jcs/auxiliary/disk/indexed/IndexedDiskCache.java
+++ b/src/java/org/apache/jcs/auxiliary/disk/indexed/IndexedDiskCache.java
@@ -185,19 +185,19 @@ public IndexedDiskCache( IndexedDiskCacheAttributes cattr, IElementSerializer el
             {
                 log.info( logCacheName + "Indexed Disk Cache is alive." );
             }
+
+            // TODO: Should we improve detection of whether or not the file should be optimized.
+            if ( isRealTimeOptimizationEnabled && keyHash.size() > 0 )
+            {
+                // Kick off a real time optimization, in case we didn't do a final optimization.
+                doOptimizeRealTime();
+            }
         }
         catch ( Exception e )
         {
             log.error( logCacheName + "Failure initializing for fileName: " + fileName + " and directory: "
                 + this.rafDir.getAbsolutePath(), e );
         }
-
-        // TODO: Should we improve detection of whether or not the file should be optimized.
-        if ( isRealTimeOptimizationEnabled && keyHash.size() > 0 )
-        {
-            // Kick off a real time optimization, in case we didn't do a final optimization.
-            doOptimizeRealTime();
-        }
     }
 
     /**
