From a1a27490c8adc641ad0e48d5fe45e334002c2365 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Thu, 11 Nov 2010 20:28:05 +0000
Subject: [PATCH] [CONFIGURATION-428] Do not escape a backslash in the value of
 an XML element when an XMLConfiguration is saved.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@1034102 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/PropertyConverter.java      | 26 +++++++++++++++----
 .../configuration/XMLConfiguration.java       |  2 +-
 .../configuration/TestPropertyConverter.java  | 16 +++++++++---
 .../configuration/TestXMLConfiguration.java   | 19 ++++++++++++++
 4 files changed, 54 insertions(+), 9 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/PropertyConverter.java b/src/java/org/apache/commons/configuration/PropertyConverter.java
index 37cd2e5cac..6847eef74e 100644
--- a/src/java/org/apache/commons/configuration/PropertyConverter.java
+++ b/src/java/org/apache/commons/configuration/PropertyConverter.java
@@ -589,19 +589,35 @@ public static List split(String s, char delimiter)
 
     /**
      * Escapes the delimiters that might be contained in the given string. This
+     * method works like {@link #escapeListDelimiter(String, char)}. In addition,
+     * a single backslash will also be escaped.
+     *
+     * @param s the string with the value
+     * @param delimiter the list delimiter to use
+     * @return the correctly escaped string
+     */
+    public static String escapeDelimiters(String s, char delimiter)
+    {
+        String s1 = StringUtils.replace(s, LIST_ESCAPE, LIST_ESCAPE + LIST_ESCAPE);
+        return escapeListDelimiter(s1, delimiter);
+    }
+
+    /**
+     * Escapes the list delimiter if it is contained in the given string. This
      * method ensures that list delimiter characters that are part of a
      * property's value are correctly escaped when a configuration is saved to a
      * file. Otherwise when loaded again the property will be treated as a list
-     * property. A single backslash will also be escaped.
+     * property.
      *
      * @param s the string with the value
      * @param delimiter the list delimiter to use
-     * @return the correctly esaped string
+     * @return the escaped string
+     * @since 1.7
      */
-    public static String escapeDelimiters(String s, char delimiter)
+    public static String escapeListDelimiter(String s, char delimiter)
     {
-        String s1 = StringUtils.replace(s, LIST_ESCAPE, LIST_ESCAPE + LIST_ESCAPE);
-        return StringUtils.replace(s1, String.valueOf(delimiter), LIST_ESCAPE + delimiter);
+        return StringUtils.replace(s, String.valueOf(delimiter), LIST_ESCAPE
+                + delimiter);
     }
 
     /**
diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index 97a2e65fe0..44cc1c8038 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -1463,7 +1463,7 @@ protected Object insert(Node newNode, Node parent, Node sibling1, Node sibling2)
                     String txt = newNode.getValue().toString();
                     if (listDelimiter != 0)
                     {
-                        txt = PropertyConverter.escapeDelimiters(txt, listDelimiter);
+                        txt = PropertyConverter.escapeListDelimiter(txt, listDelimiter);
                     }
                     elem.appendChild(document.createTextNode(txt));
                 }
diff --git a/src/test/org/apache/commons/configuration/TestPropertyConverter.java b/src/test/org/apache/commons/configuration/TestPropertyConverter.java
index b925787aab..b6d7aca3df 100644
--- a/src/test/org/apache/commons/configuration/TestPropertyConverter.java
+++ b/src/test/org/apache/commons/configuration/TestPropertyConverter.java
@@ -22,10 +22,10 @@
 import java.util.Iterator;
 import java.util.List;
 
-import org.apache.commons.lang.SystemUtils;
-
 import junit.framework.TestCase;
 
+import org.apache.commons.lang.SystemUtils;
+
 /**
  * Test class for PropertyConverter.
  *
@@ -115,6 +115,16 @@ public void testEscapeDelimiters()
                         .escapeDelimiters("C:\\Temp\\,D:\\Data\\", ','));
     }
 
+    /**
+     * Tests whether only the list delimiter can be escaped.
+     */
+    public void testEscapeListDelimiter()
+    {
+        assertEquals("Wrong escaped list delimiter", "C:\\Temp\\\\,D:\\Data\\",
+                PropertyConverter.escapeListDelimiter("C:\\Temp\\,D:\\Data\\",
+                        ','));
+    }
+
     public void testToIterator()
     {
         int[] array = new int[]{1, 2, 3};
@@ -354,7 +364,7 @@ public void testToEnumFromInvalidNumber()
         {
             return;
         }
-        
+
         try
         {
             assertEquals(enumObject, PropertyConverter.toEnum(new Integer(-1), enumClass));
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 0f5daba1cc..4db4dfc235 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -1704,6 +1704,25 @@ public void testConcurrentGetAndReload() throws Exception
         }
     }
 
+    /**
+     * Tests whether a windows path can be saved correctly. This test is related
+     * to CONFIGURATION-428.
+     */
+    public void testSaveWindowsPath() throws ConfigurationException
+    {
+        conf.clear();
+        conf.addProperty("path", "C:\\Temp");
+        StringWriter writer = new StringWriter();
+        conf.save(writer);
+        String content = writer.toString();
+        assertTrue("Path not found: " + content,
+                content.indexOf("<path>C:\\Temp</path>") >= 0);
+        conf.save(testSaveFile);
+        XMLConfiguration conf2 = new XMLConfiguration(testSaveFile);
+        assertEquals("Wrong windows path", "C:\\Temp",
+                conf2.getString("path"));
+    }
+
     private class ReloadThread extends Thread
     {
         FileConfiguration config;
