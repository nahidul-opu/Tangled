From b39a4adf6f31875e375435ca720a8d2e06ebcc53 Mon Sep 17 00:00:00 2001
From: Ate Douma <ate@apache.org>
Date: Sun, 10 Dec 2017 18:04:41 +0100
Subject: [PATCH] SCXML-266 SCXMLSemantics#matchTransition - code flow bug

---
 src/changes/changes.xml                                      | 5 ++++-
 .../apache/commons/scxml2/semantics/SCXMLSemanticsImpl.java  | 5 +++--
 src/test/java/org/apache/commons/scxml2/w3c/tests.xml        | 2 +-
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 4c62ec4d6..f3b03ae66 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -35,11 +35,14 @@
     <release version="2.0" date="In Git master"
       description="Latest unreleased code">
 
+      <action dev="ate" type="fix" issue="SCXML-266">
+        [12-10-2017] SCXMLSemantics#matchTransition - code flow bug
+      </action>
+
       <action dev="ate" type="add" issue="SCXML-265">
         [12-10-2017] Support &lt;invoke&gt; namelist attribute
       </action>
 
-
       <action dev="ate" type="add" issue="SCXML-264">
         [12-10-2017] Support &lt;invoke&gt; with inline (<content> body) SCXML statemachine definition
       </action>
diff --git a/src/main/java/org/apache/commons/scxml2/semantics/SCXMLSemanticsImpl.java b/src/main/java/org/apache/commons/scxml2/semantics/SCXMLSemanticsImpl.java
index 4e476c258..a860d0fae 100644
--- a/src/main/java/org/apache/commons/scxml2/semantics/SCXMLSemanticsImpl.java
+++ b/src/main/java/org/apache/commons/scxml2/semantics/SCXMLSemanticsImpl.java
@@ -690,9 +690,10 @@ public boolean matchTransition(final SCXMLExecutionContext exctx, final Transiti
                 boolean eventMatch = false;
                 for (String event : transition.getEvents()) {
                     if (eventName.startsWith(event)) {
-                        if (eventName.length() == event.length() || eventName.charAt(event.length())=='.')
+                        if (eventName.length() == event.length() || eventName.charAt(event.length())=='.') {
                             eventMatch = true;
-                        break;
+                            break;
+                        }
                     }
                 }
                 if (!eventMatch) {
diff --git a/src/test/java/org/apache/commons/scxml2/w3c/tests.xml b/src/test/java/org/apache/commons/scxml2/w3c/tests.xml
index 6efb28819..4a6487247 100644
--- a/src/test/java/org/apache/commons/scxml2/w3c/tests.xml
+++ b/src/test/java/org/apache/commons/scxml2/w3c/tests.xml
@@ -31,7 +31,7 @@
   <test id="417" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
   <test id="419" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
   <test id="421" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
-  <test id="422" mandatory="true"                    manual="false" jexl="false" ecma="false"/>
+  <test id="422" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
   <test id="423" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
   <test id="503" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
   <test id="504" mandatory="true"                    manual="false" jexl="true"  ecma="true"/>
