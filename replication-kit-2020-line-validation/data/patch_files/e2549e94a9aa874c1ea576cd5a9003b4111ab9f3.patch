From e2549e94a9aa874c1ea576cd5a9003b4111ab9f3 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sun, 15 Jan 2012 21:32:26 +0000
Subject: [PATCH] [CONFIGURATION-476] Before casting the in-memory
 configuration it is checked whether the cast is possible.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@1231760 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  4 +++
 .../configuration/CompositeConfiguration.java | 16 ++++++----
 .../TestCompositeConfiguration.java           | 29 +++++++++++++++++++
 3 files changed, 44 insertions(+), 5 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index a9d3b14e43..b211a3ce23 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -27,6 +27,10 @@
   <body>
     <release version="1.8" date="in SVN"
       description="TBD">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-476">
+        Fixed possible ClassCastExceptions in CompositeConfiguration related to
+        special in-memory configurations.
+      </action>
       <action dev="oheger" type="update" issue="CONFIGURATION-475">
         Class ConfigurationKey was deprecated in favour of DefaultConfigurationKey.
       </action>
diff --git a/src/main/java/org/apache/commons/configuration/CompositeConfiguration.java b/src/main/java/org/apache/commons/configuration/CompositeConfiguration.java
index d09576ae06..1716c54ba4 100644
--- a/src/main/java/org/apache/commons/configuration/CompositeConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration/CompositeConfiguration.java
@@ -327,7 +327,7 @@ public String[] getStringArray(String key)
      */
     public Configuration getConfiguration(int index)
     {
-        return (Configuration) configList.get(index);
+        return configList.get(index);
     }
 
     /**
@@ -393,8 +393,11 @@ public Object clone()
     @Override
     public void setDelimiterParsingDisabled(boolean delimiterParsingDisabled)
     {
-        ((BaseConfiguration) getInMemoryConfiguration())
-                .setDelimiterParsingDisabled(delimiterParsingDisabled);
+        if (inMemoryConfiguration instanceof AbstractConfiguration)
+        {
+            ((AbstractConfiguration) inMemoryConfiguration)
+                    .setDelimiterParsingDisabled(delimiterParsingDisabled);
+        }
         super.setDelimiterParsingDisabled(delimiterParsingDisabled);
     }
 
@@ -408,8 +411,11 @@ public void setDelimiterParsingDisabled(boolean delimiterParsingDisabled)
     @Override
     public void setListDelimiter(char listDelimiter)
     {
-        ((BaseConfiguration) getInMemoryConfiguration())
-                .setListDelimiter(listDelimiter);
+        if (inMemoryConfiguration instanceof AbstractConfiguration)
+        {
+            ((AbstractConfiguration) inMemoryConfiguration)
+                    .setListDelimiter(listDelimiter);
+        }
         super.setListDelimiter(listDelimiter);
     }
 
diff --git a/src/test/java/org/apache/commons/configuration/TestCompositeConfiguration.java b/src/test/java/org/apache/commons/configuration/TestCompositeConfiguration.java
index 3eff4ba1da..0a8dfea20a 100644
--- a/src/test/java/org/apache/commons/configuration/TestCompositeConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration/TestCompositeConfiguration.java
@@ -39,6 +39,7 @@
 import org.apache.commons.configuration.event.ConfigurationEvent;
 import org.apache.commons.configuration.event.ConfigurationListener;
 import org.apache.commons.configuration.reloading.FileAlwaysReloadingStrategy;
+import org.easymock.EasyMock;
 import org.junit.Before;
 import org.junit.Test;
 
@@ -846,6 +847,34 @@ public void testInterpolationInMultipleConfigs()
                 cc.getString("property.one.ref"));
     }
 
+    /**
+     * Tests the behavior of setListDelimiter() if the in-memory configuration
+     * is not derived from BaseConfiguration. This test is related to
+     * CONFIGURATION-476.
+     */
+    @Test
+    public void testSetListDelimiterInMemoryConfigNonBaseConfig()
+    {
+        Configuration inMemoryConfig = EasyMock.createMock(Configuration.class);
+        EasyMock.replay(inMemoryConfig);
+        cc = new CompositeConfiguration(inMemoryConfig);
+        cc.setListDelimiter(';');
+    }
+
+    /**
+     * Tests the behavior of setDelimiterParsingDisabled() if the in-memory
+     * configuration is not derived from BaseConfiguration. This test is related
+     * to CONFIGURATION-476.
+     */
+    @Test
+    public void testSetDelimiterParsingDisabledInMemoryConfigNonBaseConfig()
+    {
+        Configuration inMemoryConfig = EasyMock.createMock(Configuration.class);
+        EasyMock.replay(inMemoryConfig);
+        cc = new CompositeConfiguration(inMemoryConfig);
+        cc.setDelimiterParsingDisabled(true);
+    }
+
     /**
      * A test configuration event listener that counts the number of received
      * events. Used for testing the event facilities.
