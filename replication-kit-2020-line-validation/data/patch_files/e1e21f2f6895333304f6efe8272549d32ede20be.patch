From e1e21f2f6895333304f6efe8272549d32ede20be Mon Sep 17 00:00:00 2001
From: Luc Maisonobe <luc@apache.org>
Date: Tue, 16 Sep 2008 21:00:28 +0000
Subject: [PATCH] Fixed an error in CorrelatedRandomVectorGenerator leading to
 a component of the generated vector being constant JIRA: MATH-226

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/math/branches/MATH_2_0@696054 13f79535-47bb-0310-9956-ffa450edef68
---
 .../CorrelatedRandomVectorGenerator.java      |  2 +-
 src/site/xdoc/changes.xml                     |  4 ++++
 .../CorrelatedRandomVectorGeneratorTest.java  | 23 +++++++++++++++++++
 3 files changed, 28 insertions(+), 1 deletion(-)

diff --git a/src/java/org/apache/commons/math/random/CorrelatedRandomVectorGenerator.java b/src/java/org/apache/commons/math/random/CorrelatedRandomVectorGenerator.java
index 06de222494..fd7a925d98 100644
--- a/src/java/org/apache/commons/math/random/CorrelatedRandomVectorGenerator.java
+++ b/src/java/org/apache/commons/math/random/CorrelatedRandomVectorGenerator.java
@@ -253,7 +253,7 @@ private void decompose(RealMatrix covariance, double small)
         // build the root matrix
         root = new RealMatrixImpl(order, rank);
         for (int i = 0; i < order; ++i) {
-            System.arraycopy(b[i], 0, root.getDataRef()[swap[i]], 0, rank);
+            System.arraycopy(b[i], 0, root.getDataRef()[index[i]], 0, rank);
         }
 
     }
diff --git a/src/site/xdoc/changes.xml b/src/site/xdoc/changes.xml
index f937a0e446..b626d7d0e2 100644
--- a/src/site/xdoc/changes.xml
+++ b/src/site/xdoc/changes.xml
@@ -39,6 +39,10 @@ The <action> type attribute can be add,update,fix,remove.
   </properties>
   <body>
     <release version="2.0" date="TBD" description="TBD">
+      <action dev="luc" type="fix" issue="MATH-226" due-to="Stuart Siegel">
+        Fixed an error in CorrelatedRandomVectorGenerator leading to a component of
+        the generated vector being constant.
+      </action>
       <action dev="luc" type="fix" issue="MATH-223" due-to="John Mulcahy">
         Greatly improved QR-decomposition speed using transposed matrices internally.
       </action>
diff --git a/src/test/org/apache/commons/math/random/CorrelatedRandomVectorGeneratorTest.java b/src/test/org/apache/commons/math/random/CorrelatedRandomVectorGeneratorTest.java
index 4d5cd8d2b5..b2f40dbf07 100644
--- a/src/test/org/apache/commons/math/random/CorrelatedRandomVectorGeneratorTest.java
+++ b/src/test/org/apache/commons/math/random/CorrelatedRandomVectorGeneratorTest.java
@@ -39,6 +39,29 @@ public void testRank() {
         assertEquals(3, generator.getRank());
     }
 
+    public void testMath226()
+        throws DimensionMismatchException, NotPositiveDefiniteMatrixException {
+        double[] mean = { 1, 1, 10, 1 };
+        double[][] cov = {
+                { 1, 3, 2, 6 },
+                { 3, 13, 16, 2 },
+                { 2, 16, 38, -1 },
+                { 6, 2, -1, 197 }
+        };
+        RealMatrix covRM = new RealMatrixImpl(cov, false);
+        JDKRandomGenerator jg = new JDKRandomGenerator();
+        jg.setSeed(5322145245211l);
+        NormalizedRandomGenerator rg = new GaussianRandomGenerator(jg);
+        CorrelatedRandomVectorGenerator sg =
+            new CorrelatedRandomVectorGenerator(mean, covRM, 0.00001, rg);
+
+        for (int i = 0; i < 10; i++) {
+            double[] generated = sg.nextVector();
+            assertTrue(Math.abs(generated[0] - 1) > 0.1);
+        }
+
+    }
+
     public void testRootMatrix() {
         RealMatrix b = generator.getRootMatrix();
         RealMatrix bbt = b.multiply(b.transpose());
