From f896e6c9eb751b24de5637ab86731068fa0e2096 Mon Sep 17 00:00:00 2001
From: Mark Emlyn David Thomas <markt@apache.org>
Date: Mon, 28 Jul 2014 20:33:34 +0000
Subject: [PATCH] Fix BCEL-177 MethodParameter parameter count is one byte, not
 two.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/bcel/trunk@1614159 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                     | 4 ++++
 .../java/org/apache/bcel/classfile/MethodParameters.java    | 6 +++---
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index cfb2e637f4..1b74ae94ec 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -246,6 +246,10 @@ The <action> type attribute can be add,update,fix,remove.
       <action issue="BCEL-174" type="fix">
         Verification of interfaces with default methods fails with Java 8
       </action>
+      <action issue="BCEL-177" type="fix" dev="markt">
+        When reading the number of parameters in a MethodParameters structure
+        only read a single byte as per the JVM specification.
+      </action>
     </release>
   </body>
 </document>
diff --git a/src/main/java/org/apache/bcel/classfile/MethodParameters.java b/src/main/java/org/apache/bcel/classfile/MethodParameters.java
index 6b64d2230a..2c4303f745 100644
--- a/src/main/java/org/apache/bcel/classfile/MethodParameters.java
+++ b/src/main/java/org/apache/bcel/classfile/MethodParameters.java
@@ -12,7 +12,7 @@
  *  distributed under the License is distributed on an "AS IS" BASIS,
  *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  *  See the License for the specific language governing permissions and
- *  limitations under the License. 
+ *  limitations under the License.
  */
 
 package org.apache.bcel.classfile;
@@ -25,7 +25,7 @@
 
 /**
  * This class represents a MethodParameters attribute.
- * 
+ *
  * @see <a href="http://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7.24">The class File Format : The MethodParameters Attribute</a>
  * @since 6.0
  */
@@ -39,7 +39,7 @@ public class MethodParameters extends Attribute {
         super(Constants.ATTR_METHOD_PARAMETERS, name_index, length, constant_pool);
         System.out.println("new MethodParameters");
 
-        int parameters_count = file.readUnsignedShort();
+        int parameters_count = file.readUnsignedByte();
         parameters = new MethodParameter[parameters_count];
         for (int i = 0; i < parameters_count; i++) {
             parameters[i] = new MethodParameter(file);
