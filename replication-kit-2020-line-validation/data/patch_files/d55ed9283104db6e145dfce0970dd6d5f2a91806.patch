From d55ed9283104db6e145dfce0970dd6d5f2a91806 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Tue, 28 Feb 2006 14:01:01 +0000
Subject: [PATCH] FIX: cryptic NPE due to spelling error in ivy.xml (IVY-177)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484229 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                | 1 +
 .../fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java     | 7 +++++--
 .../fr/jayasoft/ivy/xml/XmlModuleDescriptorParserTest.java | 4 ++--
 3 files changed, 8 insertions(+), 4 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 820c60e94..6dd52a84d 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -1,5 +1,6 @@
 - IMPROVE: Retrieve task now also optionally do ivy file downloads (IVY-167) (with the contribution of Costin Leau)
 
+- FIX: cryptic NPE due to spelling error in ivy.xml (IVY-177)
 - FIX: conflicts with dynamic revisions not resolved properly (IVY-181)
 - FIX: incorrect configuration definition gives misleading NullPointerException (IVY-175)
 - FIX: throw an error when using a non-existing conflict manager as default (IVY-179) (thanks to Maarten Coene)
diff --git a/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java b/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java
index 051f80954..4fca74d60 100644
--- a/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java
+++ b/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java
@@ -149,6 +149,7 @@ private void parse(URL xmlURL, Resource res, boolean validate) throws ParseExcep
             ise.initCause(ex);
             throw ise;
         } catch (Exception ex) {
+            checkErrors();
             ParseException pe = new ParseException(ex.getMessage()+" in "+xmlURL, 0);
             pe.initCause(ex);
             throw pe;
@@ -383,8 +384,10 @@ public void startElement(String uri, String localName, String qName, Attributes
                 addError("unknwon tag "+qName);
             }
         } catch (Exception ex) {
-            addError("exception while parsing: "+ex.getMessage());
-            throw new SAXException("exception while parsing: "+ex.getMessage(), ex);
+            if (ex instanceof SAXException) {
+                throw (SAXException)ex;
+            }
+            throw new SAXException("problem occured while parsing ivy file. message: "+ex.getMessage(), ex);
         }
     }
 
diff --git a/test/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParserTest.java b/test/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParserTest.java
index c10790e42..a0ba589f8 100644
--- a/test/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParserTest.java
+++ b/test/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParserTest.java
@@ -61,12 +61,12 @@ public void testBad() throws IOException {
         }
     }
 
-    public void testBad2() throws IOException {
+    public void testBadOrg() throws IOException {
         try {
             XmlModuleDescriptorParser.getInstance().parseDescriptor(_ivy, getClass().getResource("test-bad-org.xml"), true);
             fail("bad ivy file raised no error");
         } catch (ParseException ex) {
-            // ok
+            assertTrue(ex.getMessage().indexOf("organization") != -1);
         }
     }
 
