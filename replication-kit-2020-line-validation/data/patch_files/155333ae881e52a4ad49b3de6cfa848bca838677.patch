From 155333ae881e52a4ad49b3de6cfa848bca838677 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Mon, 9 Nov 2015 22:37:28 +0000
Subject: [PATCH] VALIDATOR-332 IIBANCheckDigit.calculate does not enforce
 initial checksum value

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1713565 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                       | 4 ++++
 .../commons/validator/routines/checkdigit/IBANCheckDigit.java | 3 ++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index c1be710e3..ba0c7731a 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -90,6 +90,10 @@ The dependencies for Validator have not changed since the 1.4 release.
 For the current list of dependencies, please see
 http://commons.apache.org/validator/dependencies.html
   ">
+    <action issue="VALIDATOR-332" type="update" dev="sebb">
+    IIBANCheckDigit.calculate does not enforce initial checksum value
+    Checkdigit field is now unconditionally set to "00" to ensure correct generation
+    </action>
     <action issue="VALIDATOR-353" type="update" dev="sebb">
     UrlValidator does not allow for optional userinfo in the authority
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java b/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java
index a01e87fe2..3bcc9bfc4 100644
--- a/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java
+++ b/src/main/java/org/apache/commons/validator/routines/checkdigit/IBANCheckDigit.java
@@ -80,7 +80,7 @@ public boolean isValid(String code) {
      * Calculate the <i>Check Digit</i> for an IBAN code.
      * <p>
      * <b>Note:</b> The check digit is the third and fourth
-     * characters and and should contain value "<code>00</code>".
+     * characters and is set to the value "<code>00</code>".
      *
      * @param code The code to calculate the Check Digit for
      * @return The calculated Check Digit as 2 numeric decimal characters, e.g. "42"
@@ -92,6 +92,7 @@ public String calculate(String code) throws CheckDigitException {
             throw new CheckDigitException("Invalid Code length=" +
                     (code == null ? 0 : code.length()));
         }
+        code = code.substring(0, 2) + "00" + code.substring(4);
         int modulusResult = calculateModulus(code);
         int charValue = (98 - modulusResult);
         String checkDigit = Integer.toString(charValue);
