From 1f5b8095272bd0516f8a1d352a0a6eaa00d7e096 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Sun, 13 Mar 2011 00:33:59 +0000
Subject: [PATCH] NET-354 FTPSClient not properly supporting CCC and PROT P.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1081024 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                  | 3 +++
 src/main/java/org/apache/commons/net/ftp/FTPSClient.java | 4 ++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index de4b5ad4f..698e0ed95 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -57,6 +57,9 @@ The <action> type attribute can be add,update,fix,remove.
 
     <body>
         <release version="3.0" date="TBA" description="TBA">
+            <action issue="NET-354" dev="sebb" type="fix" due-to="Leif John Korshavn">
+            FTPSClient not properly supporting CCC and PROT P.
+            </action>
             <action issue="NET-368" dev="sebb" type="update">
             Threader.thread should accept an Iterable rather than a List.
             </action>
diff --git a/src/main/java/org/apache/commons/net/ftp/FTPSClient.java b/src/main/java/org/apache/commons/net/ftp/FTPSClient.java
index 1556af5d3..c2b0c31c4 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPSClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPSClient.java
@@ -233,7 +233,7 @@ private void sslNegotiation() throws IOException {
         String ip = _socket_.getInetAddress().getHostAddress();
         int port = _socket_.getPort();
         SSLSocket socket =
-            (SSLSocket) ssf.createSocket(_socket_, ip, port, true);
+            (SSLSocket) ssf.createSocket(_socket_, ip, port, false);
         socket.setEnableSessionCreation(isCreation);
         socket.setUseClientMode(isClientMode);
         // server mode
@@ -476,6 +476,7 @@ public int sendCommand(String command, String args) throws IOException {
         /* If CCC is issued, restore socket i/o streams to unsecured versions */
         if (FTPSCommand._commands[FTPSCommand.CCC].equals(command)) {
             if (FTPReply.COMMAND_OK == repCode) {
+                _socket_.close();
                 _socket_ = plainSocket;
                 _controlInput_ = new BufferedReader(
                     new InputStreamReader(
@@ -483,7 +484,6 @@ public int sendCommand(String command, String args) throws IOException {
                 _controlOutput_ = new BufferedWriter(
                     new OutputStreamWriter(
                         _socket_.getOutputStream(), getControlEncoding()));
-                setSocketFactory(null);
             } else {
                 throw new SSLException(getReplyString());
             }
