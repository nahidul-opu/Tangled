From 4c55341a48427f7bc0ce30f0699c673f7e69f63d Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Tue, 9 Oct 2018 18:39:31 +0000
Subject: [PATCH] [CONFIGURATION-727]
 org.apache.commons.configuration2.DatabaseConfiguration never closes result
 sets.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@1843323 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  3 ++
 .../configuration2/DatabaseConfiguration.java | 51 ++++++++++---------
 2 files changed, 30 insertions(+), 24 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 967d41ce62..dd602afcaa 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -78,6 +78,9 @@
       <action dev="ggregory" type="add" issue="CONFIGURATION-726">
         Add support for Commons Text 1.5 new string lookups as default lookups.
       </action>
+      <action dev="ggregory" type="fix" issue="CONFIGURATION-727">
+        org.apache.commons.configuration2.DatabaseConfiguration never closes result sets.
+      </action>
     </release>
 
     <release version="2.3" date="2018-08-04"
diff --git a/src/main/java/org/apache/commons/configuration2/DatabaseConfiguration.java b/src/main/java/org/apache/commons/configuration2/DatabaseConfiguration.java
index a286c555f1..193b1f407c 100644
--- a/src/main/java/org/apache/commons/configuration2/DatabaseConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration2/DatabaseConfiguration.java
@@ -329,21 +329,21 @@ protected Object getPropertyInternal(final String key)
             @Override
             protected Object performOperation() throws SQLException
             {
-                final ResultSet rs =
-                        openResultSet(String.format(SQL_GET_PROPERTY,
-                                table, keyColumn), true, key);
-
                 final List<Object> results = new ArrayList<>();
-                while (rs.next())
+                try (final ResultSet rs =
+                        openResultSet(String.format(SQL_GET_PROPERTY,
+                                table, keyColumn), true, key))
                 {
-                    final Object value = extractPropertyValue(rs);
-                    // Split value if it contains the list delimiter
-                    for (final Object o : getListDelimiterHandler().parse(value))
+                    while (rs.next())
                     {
-                        results.add(o);
+                        final Object value = extractPropertyValue(rs);
+                        // Split value if it contains the list delimiter
+                        for (final Object o : getListDelimiterHandler().parse(value))
+                        {
+                            results.add(o);
+                        }
                     }
                 }
-
                 if (!results.isEmpty())
                 {
                     return (results.size() > 1) ? results : results
@@ -450,10 +450,11 @@ protected boolean isEmptyInternal()
             @Override
             protected Integer performOperation() throws SQLException
             {
-                final ResultSet rs = openResultSet(String.format(
-                        SQL_IS_EMPTY, table), true);
-
-                return rs.next() ? Integer.valueOf(rs.getInt(1)) : null;
+                try (final ResultSet rs = openResultSet(String.format(
+                        SQL_IS_EMPTY, table), true))
+                {
+                    return rs.next() ? Integer.valueOf(rs.getInt(1)) : null;
+                }
             }
         };
 
@@ -481,10 +482,11 @@ protected boolean containsKeyInternal(final String key)
             @Override
             protected Boolean performOperation() throws SQLException
             {
-                final ResultSet rs = openResultSet(
-                        String.format(SQL_GET_PROPERTY, table, keyColumn), true, key);
-
-                return rs.next();
+                try (final ResultSet rs = openResultSet(
+                        String.format(SQL_GET_PROPERTY, table, keyColumn), true, key))
+                {
+                    return rs.next();
+                }
             }
         };
 
@@ -563,14 +565,15 @@ protected Iterator<String> getKeysInternal()
             @Override
             protected Collection<String> performOperation() throws SQLException
             {
-                final ResultSet rs = openResultSet(String.format(
-                        SQL_GET_KEYS, keyColumn, table), true);
-
-                while (rs.next())
+                try (final ResultSet rs = openResultSet(String.format(
+                        SQL_GET_KEYS, keyColumn, table), true))
                 {
-                    keys.add(rs.getString(1));
+                    while (rs.next())
+                    {
+                        keys.add(rs.getString(1));
+                    }
+                    return keys;
                 }
-                return keys;
             }
         }
         .execute();
