From c65f83394f69213c6f105c639a0c49c1216691fd Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 21 Sep 2007 11:14:48 +0000
Subject: [PATCH] FIX: Ivy settings include -tag url attribute does not work
 correctly (IVY-601)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@578065 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/ant/IvyAntVariableContainer.java      |  6 +++++
 .../apache/ivy/ant/IvyAntSettingsTest.java    | 10 +++++++++
 .../ivy/ant/ivysettings-include-twice.xml     | 22 +++++++++++++++++++
 4 files changed, 39 insertions(+)
 create mode 100644 test/java/org/apache/ivy/ant/ivysettings-include-twice.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 3c4f4748e..219034fc0 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -51,6 +51,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 
    version in SVN
 =====================================
+- FIX: Ivy settings include -tag url attribute does not work correctly (IVY-601)
 - FIX: Static revision replacement is not working when a dynamic revision is evicted by a transitive dependency (IVY-603) (with contribution from Matthias Kilian)
 - FIX: NullPointerException whilst resolving transitive dependencies (IVY-590)
 - FIX: cachepath based on a resolve done in a previous build broken (IVY-583)
diff --git a/src/java/org/apache/ivy/ant/IvyAntVariableContainer.java b/src/java/org/apache/ivy/ant/IvyAntVariableContainer.java
index c1cc945e5..ca03c4488 100644
--- a/src/java/org/apache/ivy/ant/IvyAntVariableContainer.java
+++ b/src/java/org/apache/ivy/ant/IvyAntVariableContainer.java
@@ -96,4 +96,10 @@ private void setPropertyIfNotSet(String property, String value) {
             project.setProperty(property, value);
         }
     }
+    
+    public Object clone() {
+        IvyAntVariableContainer result = (IvyAntVariableContainer) super.clone();
+        result.overwrittenProperties = (HashMap) ((HashMap) this.overwrittenProperties).clone();
+        return result;
+    }
 }
diff --git a/test/java/org/apache/ivy/ant/IvyAntSettingsTest.java b/test/java/org/apache/ivy/ant/IvyAntSettingsTest.java
index d39455399..2ae148fcb 100644
--- a/test/java/org/apache/ivy/ant/IvyAntSettingsTest.java
+++ b/test/java/org/apache/ivy/ant/IvyAntSettingsTest.java
@@ -17,6 +17,8 @@
  */
 package org.apache.ivy.ant;
 
+import java.io.File;
+
 import org.apache.tools.ant.Project;
 
 import junit.framework.TestCase;
@@ -46,5 +48,13 @@ public void testExposeAntProperties() throws Exception {
             antSettings.getProject().getProperty("ivy.test.variable.this.id"));
     }
 
+    public void testIncludeTwice() throws Exception {
+        // IVY-601
+        antSettings.setFile(new File("test/java/org/apache/ivy/ant/ivysettings-include-twice.xml"));
+        antSettings.setId("this.id");
+
+        assertNotNull(antSettings.getConfiguredIvyInstance());
+    }
+
 
 }
diff --git a/test/java/org/apache/ivy/ant/ivysettings-include-twice.xml b/test/java/org/apache/ivy/ant/ivysettings-include-twice.xml
new file mode 100644
index 000000000..ca5038159
--- /dev/null
+++ b/test/java/org/apache/ivy/ant/ivysettings-include-twice.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivysettings>
+	<include url="file:${ivy.settings.dir}/ivysettings-props.xml"/>
+	<include url="file:${ivy.settings.dir}/ivysettings-test.xml"/>
+</ivysettings>
