From 28b7b958d39730fc278fd1919bf335c52133a1a2 Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Sun, 22 Mar 2015 18:48:52 +0000
Subject: [PATCH] [CODEC-199] Bug in HW rule in Soundex.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/codec/trunk@1668441 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                           |  1 +
 .../apache/commons/codec/language/Soundex.java    | 11 ++++++-----
 .../commons/codec/language/SoundexTest.java       | 15 +++++++++++++++
 3 files changed, 22 insertions(+), 5 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 68774ee86d..2bc92ad327 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -43,6 +43,7 @@ The <action> type attribute can be add,update,fix,remove.
   </properties>
   <body>
     <release version="1.11" date="DD MM 2014" description="Feature and fix release.">        
+      <action dev="ggregory" type="add" issue="CODEC-199" due-to="Yossi Tamari">Bug in HW rule in Soundex</action>         
       <action dev="ggregory" type="add" issue="CODEC-183">BaseNCodecOutputStream only supports writing EOF on close()</action>         
       <action dev="ggregory" type="add" issue="CODEC-195">Support SHA-224 in DigestUtils on Java 8</action>         
       <action dev="ggregory" type="add" issue="CODEC-194">Support java.nio.ByteBuffer in org.apache.commons.codec.binary.Hex</action>         
diff --git a/src/main/java/org/apache/commons/codec/language/Soundex.java b/src/main/java/org/apache/commons/codec/language/Soundex.java
index 71d1f07f74..404384db33 100644
--- a/src/main/java/org/apache/commons/codec/language/Soundex.java
+++ b/src/main/java/org/apache/commons/codec/language/Soundex.java
@@ -185,13 +185,14 @@ private char getMappingCode(final String str, final int index) {
         final char mappedChar = this.map(str.charAt(index));
         // HW rule check
         if (index > 1 && mappedChar != '0') {
-            final char hwChar = str.charAt(index - 1);
-            if ('H' == hwChar || 'W' == hwChar) {
-                final char preHWChar = str.charAt(index - 2);
-                final char firstCode = this.map(preHWChar);
-                if (firstCode == mappedChar || 'H' == preHWChar || 'W' == preHWChar) {
+            for (int i=index-1 ; i>=0 ; i--) {
+                final char prevChar = str.charAt(i);
+                if (this.map(prevChar)==mappedChar) {
                     return 0;
                 }
+                if ('H'!=prevChar && 'W'!=prevChar) {
+                    break;
+                }
             }
         }
         return mappedChar;
diff --git a/src/test/java/org/apache/commons/codec/language/SoundexTest.java b/src/test/java/org/apache/commons/codec/language/SoundexTest.java
index 87fe4eb5f3..cebfc0beba 100644
--- a/src/test/java/org/apache/commons/codec/language/SoundexTest.java
+++ b/src/test/java/org/apache/commons/codec/language/SoundexTest.java
@@ -228,6 +228,8 @@ public void testHWRuleEx1() {
         // for the F). It is not coded A-226.
         Assert.assertEquals("A261", this.getStringEncoder().encode("Ashcraft"));
         Assert.assertEquals("A261", this.getStringEncoder().encode("Ashcroft"));
+        Assert.assertEquals("Y330", this.getStringEncoder().encode("yehudit"));
+        Assert.assertEquals("Y330", this.getStringEncoder().encode("yhwdyt"));
     }
 
     /**
@@ -388,4 +390,17 @@ public void testUsMappingOWithDiaeresis() {
             Assert.assertEquals("", this.getStringEncoder().encode("\u00f6"));
         }
     }
+    
+    /**
+     * Tests example from http://en.wikipedia.org/wiki/Soundex#American_Soundex as of 2015-03-22.
+     */
+    @Test
+    public void testWikipediaAmericanSoundex() {
+        Assert.assertEquals("R163", this.getStringEncoder().encode("Robert"));        
+        Assert.assertEquals("R163", this.getStringEncoder().encode("Rupert"));        
+        Assert.assertEquals("A261", this.getStringEncoder().encode("Ashcraft"));        
+        Assert.assertEquals("A261", this.getStringEncoder().encode("Ashcroft"));        
+        Assert.assertEquals("T522", this.getStringEncoder().encode("Tymczak"));        
+        Assert.assertEquals("P236", this.getStringEncoder().encode("Pfister"));        
+    }
 }
