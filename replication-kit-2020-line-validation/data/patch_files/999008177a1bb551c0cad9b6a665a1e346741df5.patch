From 999008177a1bb551c0cad9b6a665a1e346741df5 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Mon, 3 Nov 2008 21:07:27 +0000
Subject: [PATCH] CONFIGURATION-346: ConfigurationUtils.convertToHierarchical()
 now correctly deals with multi-valued properties.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@710159 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/configuration/ConfigurationUtils.java |  2 +-
 .../configuration/TestConfigurationUtils.java     | 15 +++++++++++++++
 xdocs/changes.xml                                 |  5 +++++
 3 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/src/java/org/apache/commons/configuration/ConfigurationUtils.java b/src/java/org/apache/commons/configuration/ConfigurationUtils.java
index 4ab5d7b413..e6ae28708b 100644
--- a/src/java/org/apache/commons/configuration/ConfigurationUtils.java
+++ b/src/java/org/apache/commons/configuration/ConfigurationUtils.java
@@ -238,7 +238,7 @@ public static HierarchicalConfiguration convertToHierarchical(
             // Workaround for problem with copy()
             boolean delimiterParsingStatus = hc.isDelimiterParsingDisabled();
             hc.setDelimiterParsingDisabled(true);
-            ConfigurationUtils.copy(conf, hc);
+            hc.append(conf);
             hc.setDelimiterParsingDisabled(delimiterParsingStatus);
             return hc;
         }
diff --git a/src/test/org/apache/commons/configuration/TestConfigurationUtils.java b/src/test/org/apache/commons/configuration/TestConfigurationUtils.java
index 6adba4ccdb..c291a563f3 100644
--- a/src/test/org/apache/commons/configuration/TestConfigurationUtils.java
+++ b/src/test/org/apache/commons/configuration/TestConfigurationUtils.java
@@ -317,6 +317,21 @@ public void testConvertHierarchicalToHierarchicalNullEngine()
                 .getExpressionEngine());
     }
 
+    /**
+     * Tests converting a configuration to a hierarchical one that contains a
+     * property with multiple values. This test is related to CONFIGURATION-346.
+     */
+    public void testConvertToHierarchicalMultiValues()
+    {
+        BaseConfiguration config = new BaseConfiguration();
+        config.addProperty("test", "1,2,3");
+        HierarchicalConfiguration hc = ConfigurationUtils
+                .convertToHierarchical(config);
+        assertEquals("Wrong value 1", 1, hc.getInt("test(0)"));
+        assertEquals("Wrong value 2", 2, hc.getInt("test(1)"));
+        assertEquals("Wrong value 3", 3, hc.getInt("test(2)"));
+    }
+
     /**
      * Tests cloning a configuration that supports this operation.
      */
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index f82a30ca74..60e8f6366f 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-346">
+        ConfigurationUtils.convertToHierarchical() now creates multiple
+        configuration nodes for properties with multiple values. This
+        improves compatibility with queries.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-341">
         The "force reload check" mechanism of CombinedConfiguration now also
         works with sub configurations created by configurationAt().
