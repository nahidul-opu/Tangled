From aae0d3d15f12d70aba17b99647642e1cf539b981 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 4 Mar 2009 21:38:59 +0000
Subject: [PATCH] FIX: Buildnumber task does not work for chained resolvers
 (IVY-1037)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@750165 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                       |  1 +
 .../ivy/plugins/resolver/ChainResolver.java       | 15 +++++++++++++++
 2 files changed, 16 insertions(+)

diff --git a/CHANGES.txt b/CHANGES.txt
index 8a366c45f..fda741591 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -99,6 +99,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Error message is not clear when specifying an invalid value for checksums (IVY-977)
 - IMPROVEMENT: catch AccessControlException on System.getProperties() (IVY-1015)
 
+- FIX: Buildnumber task does not work for chained resolvers (IVY-1037)
 - FIX: Dependencies don't inherit exclusions from dependencyManagement (IVY-974) (thanks to John Gibson)
 - FIX: Dependency Configuration Negation does not work (IVY-982)
 - FIX: Ivy retrieve does not honor validate="false" from ivysettings (IVY-992)
diff --git a/src/java/org/apache/ivy/plugins/resolver/ChainResolver.java b/src/java/org/apache/ivy/plugins/resolver/ChainResolver.java
index cd087be69..04482d65b 100644
--- a/src/java/org/apache/ivy/plugins/resolver/ChainResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/ChainResolver.java
@@ -22,8 +22,12 @@
 import java.text.ParseException;
 import java.util.ArrayList;
 import java.util.Arrays;
+import java.util.HashMap;
+import java.util.HashSet;
 import java.util.Iterator;
 import java.util.List;
+import java.util.Map;
+import java.util.Set;
 
 import org.apache.ivy.core.cache.ArtifactOrigin;
 import org.apache.ivy.core.module.descriptor.Artifact;
@@ -207,6 +211,17 @@ public ResolvedResource findIvyFileRef(DependencyDescriptor dd, ResolveData data
         
         return null;
     }
+    
+    public Map[] listTokenValues(String[] tokens, Map criteria) {
+        Set result = new HashSet();
+        for (Iterator iter = chain.iterator(); iter.hasNext();) {
+            DependencyResolver resolver = (DependencyResolver) iter.next();
+            Map[] temp = resolver.listTokenValues(tokens, new HashMap(criteria));
+            result.addAll(Arrays.asList(temp));
+        }
+        
+        return (Map[]) result.toArray(new Map[result.size()]);
+    }
 
     public void reportFailure() {
         for (Iterator iter = chain.iterator(); iter.hasNext();) {
