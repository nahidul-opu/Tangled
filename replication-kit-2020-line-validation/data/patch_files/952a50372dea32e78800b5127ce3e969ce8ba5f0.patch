From 952a50372dea32e78800b5127ce3e969ce8ba5f0 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Thu, 26 May 2016 17:02:01 +0200
Subject: [PATCH] COMPRESS-357 better synchronize finished method

---
 src/changes/changes.xml                                       | 4 ++++
 .../compressors/bzip2/BZip2CompressorOutputStream.java        | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index e5517b30239..5af45067e9d 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -70,6 +70,10 @@ The <action> type attribute can be add,update,fix,remove.
         TarArchiveInputStream failed to parse PAX headers whose tar
         entry name ended with a slash.
       </action>
+      <action issue="COMPRESS-357" type="fix" date="2016-05-26">
+        BZip2CompressorOutputStream#finished is now synchronized to
+        avoid a race condition with the finalize method.
+      </action>
     </release>
     <release version="1.11" date="2016-04-06"
              description="Release 1.11">
diff --git a/src/main/java/org/apache/commons/compress/compressors/bzip2/BZip2CompressorOutputStream.java b/src/main/java/org/apache/commons/compress/compressors/bzip2/BZip2CompressorOutputStream.java
index 9de51d41b4c..3bdee5aa366 100644
--- a/src/main/java/org/apache/commons/compress/compressors/bzip2/BZip2CompressorOutputStream.java
+++ b/src/main/java/org/apache/commons/compress/compressors/bzip2/BZip2CompressorOutputStream.java
@@ -476,7 +476,7 @@ protected void finalize() throws Throwable {
     }
 
 
-    public void finish() throws IOException {
+    public synchronized void finish() throws IOException {
         if (out != null) {
             try {
                 if (this.runLength > 0) {
