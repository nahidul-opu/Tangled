From 5278cd419abc3ccaabc352ba67631b1985eb4bed Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 1 Nov 2011 14:13:54 +0000
Subject: [PATCH] NET-428 SubnetUtils throws ArrayIndexOutOfBoundsException for
 new SubnetUtils( "1.2.3.4/32" ).getInfo().getAllAddresses()

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1196001 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                          |  3 +++
 .../org/apache/commons/net/util/SubnetUtils.java |  6 +++++-
 .../org/apache/commons/net/SubnetUtilsTest.java  | 16 ++++++++++++++++
 3 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 4051ee1b1..299d00275 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -59,6 +59,9 @@ The <action> type attribute can be add,update,fix,remove.
         <release version="3.0.2-SNAPSHOT" date="TBA" description="
 TBA
         ">
+            <action issue="NET-428" dev="sebb" type="fix">
+            SubnetUtils throws ArrayIndexOutOfBoundsException for new SubnetUtils( "1.2.3.4/32" ).getInfo().getAllAddresses()
+            </action>
             <action issue="NET-421" dev="sebb" type="fix" due-to="Oliver Saggau">
             Problem connecting to TLS/SSL SMTP server using explicit mode.
             </action>
diff --git a/src/main/java/org/apache/commons/net/util/SubnetUtils.java b/src/main/java/org/apache/commons/net/util/SubnetUtils.java
index 68398c861..70c36854d 100644
--- a/src/main/java/org/apache/commons/net/util/SubnetUtils.java
+++ b/src/main/java/org/apache/commons/net/util/SubnetUtils.java
@@ -161,7 +161,11 @@ public String getCidrSignature() {
         }
 
         public String[] getAllAddresses() {
-            String[] addresses = new String[getAddressCount()];
+            int ct = getAddressCount();
+            String[] addresses = new String[ct];
+            if (ct == 0) {
+                return addresses;
+            }
             for (int add = low(), j=0; add <= high(); ++add, ++j) {
                 addresses[j] = format(toArray(add));
             }
diff --git a/src/test/java/org/apache/commons/net/SubnetUtilsTest.java b/src/test/java/org/apache/commons/net/SubnetUtilsTest.java
index 2d51862fa..7ae996d1a 100644
--- a/src/test/java/org/apache/commons/net/SubnetUtilsTest.java
+++ b/src/test/java/org/apache/commons/net/SubnetUtilsTest.java
@@ -290,4 +290,20 @@ public void testInvalidMasks(){
         } catch (IllegalArgumentException expected) {
         }
     }
+
+    public void testNET428_31() throws Exception {
+        final SubnetUtils subnetUtils = new SubnetUtils("1.2.3.4/31");
+        assertEquals(0,subnetUtils.getInfo().getAddressCount());
+        String[] address = subnetUtils.getInfo().getAllAddresses();
+        assertNotNull(address);
+        assertEquals(0,address.length);
+    }
+
+    public void testNET428_32() throws Exception {
+        final SubnetUtils subnetUtils = new SubnetUtils("1.2.3.4/32");
+        assertEquals(0,subnetUtils.getInfo().getAddressCount());
+        String[] address = subnetUtils.getInfo().getAllAddresses();
+        assertNotNull(address);
+        assertEquals(0,address.length);
+    }
 }
