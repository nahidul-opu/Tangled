From f4a6f21360811bde57d9abfdae928f522b803897 Mon Sep 17 00:00:00 2001
From: Jochen Wiedmann <jochen@apache.org>
Date: Tue, 1 Mar 2011 22:10:10 +0000
Subject: [PATCH] PR: COLLECTIONS-360 Prevent an NPE in
 FilterListIterator.next() and FilterListIterator.previous()

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/collections/branches/COLLECTIONS_3_2_BRANCH@1076034 13f79535-47bb-0310-9956-ffa450edef68
---
 pom.xml                                           |  3 +++
 .../collections/iterators/FilterListIterator.java |  7 +++++++
 .../iterators/TestFilterListIterator.java         | 15 +++++++++++++++
 3 files changed, 25 insertions(+)

diff --git a/pom.xml b/pom.xml
index 4a71e6a2f2..5c4a6d85a3 100644
--- a/pom.xml
+++ b/pom.xml
@@ -363,6 +363,9 @@
     <contributor>
       <name>Serhiy Yevtushenko</name>
     </contributor>
+    <contributor>
+      <name>Sai Zhang</name>
+    </contributor>
     <contributor>
       <name>Jason van Zyl</name>
     </contributor>
diff --git a/src/java/org/apache/commons/collections/iterators/FilterListIterator.java b/src/java/org/apache/commons/collections/iterators/FilterListIterator.java
index 26b29e17eb..5e36118e95 100644
--- a/src/java/org/apache/commons/collections/iterators/FilterListIterator.java
+++ b/src/java/org/apache/commons/collections/iterators/FilterListIterator.java
@@ -236,6 +236,10 @@ private boolean setNextObject() {
             }
         }
 
+        if (iterator == null) {
+            return false;
+        }
+
         while(iterator.hasNext()) {
             Object object = iterator.next();
             if(predicate.evaluate(object)) {
@@ -266,6 +270,9 @@ private boolean setPreviousObject() {
             }
         }
 
+        if (iterator == null) {
+            return false;
+        }
         while(iterator.hasPrevious()) {
             Object object = iterator.previous();
             if(predicate.evaluate(object)) {
diff --git a/src/test/org/apache/commons/collections/iterators/TestFilterListIterator.java b/src/test/org/apache/commons/collections/iterators/TestFilterListIterator.java
index fcf45f808d..ab9dffeab0 100644
--- a/src/test/org/apache/commons/collections/iterators/TestFilterListIterator.java
+++ b/src/test/org/apache/commons/collections/iterators/TestFilterListIterator.java
@@ -21,11 +21,14 @@
 import java.util.ListIterator;
 import java.util.Random;
 
+import junit.framework.Assert;
 import junit.framework.Test;
 import junit.framework.TestCase;
 import junit.framework.TestSuite;
 
 import org.apache.commons.collections.Predicate;
+import org.apache.commons.collections.PredicateUtils;
+import org.apache.commons.collections.list.GrowthList;
 
 /**
  * Tests the FilterListIterator class.
@@ -289,6 +292,18 @@ public void testFailingHasNextBug() {
         assertEquals(expected.previous(),filtered.previous());
     }
 
+    /**
+     * Test for {@link https://issues.apache.org/jira/browse/COLLECTIONS-360 COLLECTIONS-360}.
+     */
+    public void testCollections360() throws Throwable {
+        GrowthList var7 = new GrowthList();
+        Predicate var9 = PredicateUtils.anyPredicate((java.util.Collection)var7);
+        FilterListIterator var13 = new FilterListIterator(var9);
+        Assert.assertFalse(var13.hasNext());
+        org.apache.commons.collections.iterators.FilterListIterator var14 = new org.apache.commons.collections.iterators.FilterListIterator(var9);
+        Assert.assertFalse(var14.hasPrevious());
+    }
+
     // Utilities
 
     private void walkForward(ListIterator expected, ListIterator testing) {
