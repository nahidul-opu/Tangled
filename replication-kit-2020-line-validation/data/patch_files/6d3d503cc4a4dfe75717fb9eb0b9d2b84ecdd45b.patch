From 6d3d503cc4a4dfe75717fb9eb0b9d2b84ecdd45b Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Sat, 18 Aug 2012 10:24:36 +0000
Subject: [PATCH] NET-466 Regression: TelnetInputStream#available() blocks

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1374548 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                     | 3 +++
 .../org/apache/commons/net/telnet/TelnetInputStream.java    | 6 +++++-
 2 files changed, 8 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index eb0551106..a84248882 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -65,6 +65,9 @@ The <action> type attribute can be add,update,fix,remove.
         <release version="3.2" date="TBA" description="
 TBA
         ">
+            <action issue="NET-466" dev="sebb" type="fix" due-to="Martin Oberhuber">
+            Regression: TelnetInputStream#available() blocks.
+            </action>
             <action issue="NET-426" dev="sebb" type="fix" due-to="Ketan">
             FTPS: Hook to customize _openDataConnection_ SSLSocket before startHandshake() is called.
             Implement _openDataConnection(String, String) method to properly
diff --git a/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java b/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
index d90e5c6e0..ebc953820 100644
--- a/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
+++ b/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
@@ -561,7 +561,11 @@ public int available() throws IOException
         // Critical section because run() may change __bytesAvailable
         synchronized (__queue)
         {
-            return __bytesAvailable + super.available();
+            if (__threaded) { // Must not call super.available when running threaded: NET-466
+                return __bytesAvailable;
+            } else {
+                return __bytesAvailable + super.available();
+            }
         }
     }
 
