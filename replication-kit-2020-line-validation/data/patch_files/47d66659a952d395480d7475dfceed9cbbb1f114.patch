From 47d66659a952d395480d7475dfceed9cbbb1f114 Mon Sep 17 00:00:00 2001
From: Joerg Schaible <joehni@apache.org>
Date: Tue, 10 Mar 2009 00:55:40 +0000
Subject: [PATCH] Merge changes for CONFIGURATION-369 from experimental branch
 into trunk.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@751926 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/SubsetConfiguration.java    |  5 +--
 .../interpol/ConfigurationInterpolator.java   | 10 ++++++
 .../TestSubsetConfiguration.java              | 32 ++++++++++++++++++-
 3 files changed, 44 insertions(+), 3 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/SubsetConfiguration.java b/src/java/org/apache/commons/configuration/SubsetConfiguration.java
index e818eade04..e52ad8f7a8 100644
--- a/src/java/org/apache/commons/configuration/SubsetConfiguration.java
+++ b/src/java/org/apache/commons/configuration/SubsetConfiguration.java
@@ -120,7 +120,7 @@ protected String getChildKey(String key)
     }
 
     /**
-     * Return the parent configuation for this subset.
+     * Return the parent configuration for this subset.
      *
      * @return the parent configuration
      */
@@ -205,7 +205,7 @@ public Object transform(Object obj)
             }
         });
     }
-
+    
     protected Object interpolate(Object base)
     {
         if (delimiter == null && "".equals(prefix))
@@ -215,6 +215,7 @@ protected Object interpolate(Object base)
         else
         {
             SubsetConfiguration config = new SubsetConfiguration(parent, "");
+            getInterpolator().registerLocalLookups(config.getInterpolator());
             return config.interpolate(base);
         }
     }
diff --git a/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java b/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java
index 595f4224cc..36976f54f7 100644
--- a/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java
+++ b/src/java/org/apache/commons/configuration/interpol/ConfigurationInterpolator.java
@@ -322,6 +322,16 @@ protected StrLookup fetchLookupForPrefix(String prefix)
         }
         return lookup;
     }
+    
+    /**
+     * Registers the local lookup instances for the given interpolator.
+     * 
+     * @param interpolator the instance receiving the local lookups
+     * @since upcoming
+     */
+    public void registerLocalLookups(ConfigurationInterpolator interpolator) {
+        interpolator.localLookups.putAll(localLookups);
+    }
 
     // static initializer, sets up the map with the standard lookups
     static
diff --git a/src/test/org/apache/commons/configuration/TestSubsetConfiguration.java b/src/test/org/apache/commons/configuration/TestSubsetConfiguration.java
index 8397a4c18c..f4dabd515f 100644
--- a/src/test/org/apache/commons/configuration/TestSubsetConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestSubsetConfiguration.java
@@ -25,6 +25,8 @@
 import java.util.NoSuchElementException;
 import java.util.Set;
 
+import org.apache.commons.configuration.interpol.ConfigurationInterpolator;
+import org.apache.commons.lang.text.StrLookup;
 import junit.framework.TestCase;
 
 /**
@@ -158,7 +160,7 @@ public void testSetPrefix()
         assertEquals("prefix", "prefix", subset.getPrefix());
     }
 
-    public void testThrowtExceptionOnMissing()
+    public void testThrowExceptionOnMissing()
     {
         BaseConfiguration config = new BaseConfiguration();
         config.setThrowExceptionOnMissing(true);
@@ -281,4 +283,32 @@ public void testIsDelimiterParsingDisabled()
         assertFalse("Wrong value of list parsing flag in parent", config
                 .isDelimiterParsingDisabled());
     }
+
+    /**
+     * Tests manipulating the interpolator.
+     */
+    public void testInterpolator()
+    {
+        BaseConfiguration config = new BaseConfiguration();
+        AbstractConfiguration subset = (AbstractConfiguration) config
+                .subset("prefix");
+        InterpolationTestHelper.testGetInterpolator(subset);
+    }
+    
+    // TODO: Next step
+    public void todoTestLocalLookupsInInterpolorAreInherited() {
+        BaseConfiguration config = new BaseConfiguration();
+        ConfigurationInterpolator interpolator = config.getInterpolator();
+        interpolator.registerLookup("brackets", new StrLookup(){
+
+            public String lookup(String key) {
+                return "(" + key +")";
+            }
+            
+        });
+        config.setProperty("prefix.var", "${brackets:x}");
+        AbstractConfiguration subset = (AbstractConfiguration) config
+                .subset("prefix");
+        assertEquals("Local lookup was not inherited", "(x)", subset.getString("var", ""));
+    }
 }
