From cb9e256f9e69ebdbccb802fcd890d5d181cdd1d4 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 7 Jan 2016 15:20:52 +0000
Subject: [PATCH] VALIDATOR-384 EmailValidator does not support escaped quotes
 in a quoted string

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1723573 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                        | 3 +++
 .../org/apache/commons/validator/routines/EmailValidator.java  | 2 +-
 .../apache/commons/validator/routines/EmailValidatorTest.java  | 3 +++
 3 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 6f680d9f8..d1824b96b 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -96,6 +96,9 @@ http://commons.apache.org/validator/dependencies.html
     <action issue="VALIDATOR-359" type="fix" dev="sebb" due-to="Dora Kinghorn">
     EmailValidator does not catch invalid email address like dora@.com
     </action>
+    <action issue="VALIDATOR-384" type="fix" dev="sebb" due-to=" Kris Babic">
+    EmailValidator does not support escaped quotes in a quoted string
+    </action>
     <action type="update" dev="sebb">
     Updated to TLD list Version 2016010600, Last Updated Wed Jan  6 07:07:02 2016 UTC
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
index e344dcc45..91d56cfad 100644
--- a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
+++ b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
@@ -39,7 +39,7 @@ public class EmailValidator implements Serializable {
 
     private static final String SPECIAL_CHARS = "\\p{Cntrl}\\(\\)<>@,;:'\\\\\\\"\\.\\[\\]";
     private static final String VALID_CHARS = "(\\\\.)|[^\\s" + SPECIAL_CHARS + "]";
-    private static final String QUOTED_USER = "(\"[^\"]*\")";
+    private static final String QUOTED_USER = "(\"(\\\\\"|[^\"])*\")";
     private static final String WORD = "((" + VALID_CHARS + "|')+|" + QUOTED_USER + ")";
 
     private static final String EMAIL_REGEX = "^\\s*?(.+)@(.+?)\\s*$";
diff --git a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
index 8c75d2888..04a0ceede 100644
--- a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
+++ b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
@@ -367,6 +367,9 @@ public void testEmailUserName()  {
 
         assertTrue(validator.isValid("\"..\"@apache.org"));
 
+        // escaped quote character valid in quoted string
+        assertTrue(validator.isValid("\"john\\\"doe\"@apache.org"));
+
         assertTrue(validator.isValid("john56789.john56789.john56789.john56789.john56789.john56789.john@example.com"));
 
         assertFalse(validator.isValid("john56789.john56789.john56789.john56789.john56789.john56789.john5@example.com"));
