From aec7c943a7f797fa0c28a525a98964593bec89ae Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Wed, 9 Jan 2013 13:04:24 +0000
Subject: [PATCH] NET-494 FTPClient.CSL.cleanUp() fails to restore timeout
 value on exception

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1430831 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                        |  3 +++
 .../org/apache/commons/net/ftp/FTPClient.java  | 18 ++++++++++++------
 2 files changed, 15 insertions(+), 6 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index e000c1568..c1d23f606 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -64,6 +64,9 @@ The <action> type attribute can be add,update,fix,remove.
     <body>
         <release version="3.3" date="TBA" description="
         ">
+            <action issue="NET-494" dev="sebb" type="fix">
+            FTPClient.CSL.cleanUp() fails to restore timeout value on exception
+            </action>
             <action issue="NET-492" dev="sebb" type="fix">
             FTPClient.printWorkingDirectory() incorrectly parses certain valid PWD command results
             </action>
diff --git a/src/main/java/org/apache/commons/net/ftp/FTPClient.java b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
index 8bf6c665e..056830c6d 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
@@ -650,6 +650,9 @@ CopyStreamEvent.UNKNOWN_STREAM_SIZE, __mergeListeners(csl),
         catch (IOException e)
         {
             Util.closeQuietly(socket); // ignore close errors here
+            if (csl != null) {
+                csl.cleanUp(); // fetch any outstanding keepalive replies
+            }
             throw e;
         }
 
@@ -1825,11 +1828,11 @@ CopyStreamEvent.UNKNOWN_STREAM_SIZE, __mergeListeners(csl),
                     false);
         } finally {
             Util.closeQuietly(socket);
+            if (csl != null) {
+                csl.cleanUp(); // fetch any outstanding keepalive replies
+            }
         }
 
-        if (csl != null) {
-            csl.cleanUp(); // fetch any outstanding keepalive replies
-        }
         // Get the transfer response
         boolean ok = completePendingCommand();
         return ok;
@@ -3580,10 +3583,13 @@ public void bytesTransferred(long totalBytesTransferred,
         }
 
         void cleanUp() throws IOException {
-            while(notAcked-- > 0) {
-                parent.__getReplyNoReport();
+            try {
+                while(notAcked-- > 0) {
+                    parent.__getReplyNoReport();
+                }
+            } finally {
+                parent.setSoTimeout(currentSoTimeout);                
             }
-            parent.setSoTimeout(currentSoTimeout);
         }
 
     }
