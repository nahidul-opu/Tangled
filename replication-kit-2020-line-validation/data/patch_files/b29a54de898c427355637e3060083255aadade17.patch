From b29a54de898c427355637e3060083255aadade17 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 13 Feb 2009 12:39:11 +0000
Subject: [PATCH] FIX: Dependency Configuration Negation does not work
 (IVY-982)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@744101 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                | 1 +
 .../module/descriptor/DefaultDependencyDescriptor.java     | 7 ++++++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index f86d4c5db..b35473768 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -95,6 +95,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Error message is not clear when specifying an invalid value for checksums (IVY-977)
 - IMPROVEMENT: catch AccessControlException on System.getProperties() (IVY-1015)
 
+- FIX: Dependency Configuration Negation does not work (IVY-982)
 - FIX: Ivy retrieve does not honor validate="false" from ivysettings (IVY-992)
 - FIX: Snapshot issues when using ibiblio resolver with m2compatible is false (IVY-1028)
 - FIX: Ivy Standalone hangs after publishing to SSH resolver (IVY-1009)
diff --git a/src/java/org/apache/ivy/core/module/descriptor/DefaultDependencyDescriptor.java b/src/java/org/apache/ivy/core/module/descriptor/DefaultDependencyDescriptor.java
index 330a9951c..fd9c7452c 100644
--- a/src/java/org/apache/ivy/core/module/descriptor/DefaultDependencyDescriptor.java
+++ b/src/java/org/apache/ivy/core/module/descriptor/DefaultDependencyDescriptor.java
@@ -426,7 +426,12 @@ private Set mergeAll(Map artifactsMap) {
 
     public void addDependencyConfiguration(String masterConf, String depConf) {
         if ((md != null) && !"*".equals(masterConf) && !"%".equals(masterConf)) {
-            Configuration config = md.getConfiguration(masterConf);
+            Configuration config;
+            if (masterConf.startsWith("!")) {
+                config = md.getConfiguration(masterConf.substring(1));
+            } else {
+                config = md.getConfiguration(masterConf);                
+            }
             if (config == null) {
                 throw new IllegalArgumentException("Cannot add dependency '" + revId
                     + "' to configuration '" + masterConf + "' of module "
