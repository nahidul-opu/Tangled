From 131a120d7e3fc8cedf6552f9e5fdb4ff933a7386 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Sat, 7 Jun 2014 16:19:20 +0000
Subject: [PATCH] NET-543 telnet: spy read EOL is reversed

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1601150 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                 | 3 +++
 src/main/java/org/apache/commons/net/telnet/Telnet.java | 6 +++---
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index dd42d461f..910c94614 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -68,6 +68,9 @@ This is mainly a bug-fix release. See further details below.
   IMAPExportMbox (example app) allows IMAP folders to be exported into an mbox file.
   This is the inverse of the IMAPImportMbox example added previously
         ">
+            <action issue="NET-543" type="fix" dev="sebb" due-to="Ferry Huberts">
+            telnet: spy read EOL is reversed
+            </action>
             <action issue="NET-540" type="add" dev="sebb">
             Article#printThread should have option to use any PrintStream
             </action>
diff --git a/src/main/java/org/apache/commons/net/telnet/Telnet.java b/src/main/java/org/apache/commons/net/telnet/Telnet.java
index 8f56f0f8b..18828a039 100644
--- a/src/main/java/org/apache/commons/net/telnet/Telnet.java
+++ b/src/main/java/org/apache/commons/net/telnet/Telnet.java
@@ -1203,13 +1203,13 @@ void _spyRead(int ch)
         {
             try
             {
-                if (ch != '\r')
+                if (ch != '\r') // never write '\r' on its own
                 {
-                    spy.write(ch);
                     if (ch == '\n')
                     {
-                        spy.write('\r');
+                        spy.write('\r'); // add '\r' before '\n'
                     }
+                    spy.write(ch); // write original character
                     spy.flush();
                 }
             }
