From af395c546ec2e331e5ad70ad7601a2711aed962f Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Thu, 3 Apr 2008 16:36:14 +0000
Subject: [PATCH] FIX: setting m2compatible on ibiblio resolver overwrite root
 and pattern settings (IVY-437) (thanks to Jing Xue)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@644398 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                          |  1 +
 .../apache/ivy/plugins/resolver/IBiblioResolver.java | 12 +++++++++---
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 18a1269b3..57e211d23 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -76,6 +76,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: setting m2compatible on ibiblio resolver overwrite root and pattern settings (IVY-437) (thanks to Jing Xue)
 - FIX: unable to resolve snapshot versions (IVY-501)
 - FIX: No error or warning when a resolver references a non-existent cache (IVY-777)
 - FIX: ivy properties defined in an include file not available in the file that includes it (IVY-780)
diff --git a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
index 268288f53..591902c99 100644
--- a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
@@ -65,6 +65,7 @@ public class IBiblioResolver extends URLResolver {
     public static final String DEFAULT_PATTERN = "[module]/[type]s/[artifact]-[revision].[ext]";
 
     public static final String DEFAULT_ROOT = "http://www.ibiblio.org/maven/";
+    public static final String DEFAULT_M2_ROOT = "http://repo1.maven.org/maven2/";
 
     private String root = null;
 
@@ -214,7 +215,7 @@ public void setM2compatible(boolean m2compatible) {
         super.setM2compatible(m2compatible);
         if (m2compatible) {
             if (root == null) {
-                root = "http://repo1.maven.org/maven2/";
+                root = DEFAULT_M2_ROOT;
             }
             if (pattern == null) {
                 pattern = M2_PATTERN;
@@ -224,8 +225,13 @@ public void setM2compatible(boolean m2compatible) {
     }
 
     public void ensureConfigured(ResolverSettings settings) {
-        if (settings != null && (root == null || pattern == null)) {
-            if (root == null) {
+        Message.debug("Current IBIBLIO ROOT: " + root);
+        boolean isDefaultRoot = (root == null 
+                || (!isM2compatible() && root.equalsIgnoreCase(DEFAULT_ROOT))
+                || (isM2compatible() && root.equalsIgnoreCase(DEFAULT_M2_ROOT)));
+        Message.debug("Current settings: " + settings);
+        if (settings != null && (isDefaultRoot || pattern == null)) {
+            if (isDefaultRoot) {
                 String root = settings.getVariable("ivy.ibiblio.default.artifact.root");
                 if (root != null) {
                     this.root = root;
