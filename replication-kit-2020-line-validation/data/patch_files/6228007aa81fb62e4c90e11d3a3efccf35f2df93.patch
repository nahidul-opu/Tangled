From 6228007aa81fb62e4c90e11d3a3efccf35f2df93 Mon Sep 17 00:00:00 2001
From: "Bruno P. Kinoshita" <brunodepaulak@yahoo.com.br>
Date: Sat, 10 Feb 2018 22:39:50 +1300
Subject: [PATCH] IMAGING-215: prevent ArrayIndexOutOfBoundsException when
 creating Huffman table

---
 src/changes/changes.xml                       |   3 ++
 .../formats/jpeg/segments/DhtSegment.java     |   3 ++
 .../jpeg/JpegWithInvalidDhtSegmentTest.java   |  41 ++++++++++++++++++
 ...dexOutOfBoundsException_DhtSegment_79.jpeg | Bin 0 -> 2746 bytes
 4 files changed, 47 insertions(+)
 create mode 100644 src/test/java/org/apache/commons/imaging/formats/jpeg/JpegWithInvalidDhtSegmentTest.java
 create mode 100644 src/test/resources/IMAGING-215/ArrayIndexOutOfBoundsException_DhtSegment_79.jpeg

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 3237559be..d06dbbd47 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -46,6 +46,9 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
 
     <release version="1.0" date="TBA" description="First major release">
+      <action issue="IMAGING-215" dev="kinow" type="fix">
+        ArrayIndexOutOfBoundsException in DhtSegment
+      </action>
       <action issue="IMAGING-203" dev="kinow" type="fix" due-to="Rody Kersten">
         JPEG segment size not validated
       </action>
diff --git a/src/main/java/org/apache/commons/imaging/formats/jpeg/segments/DhtSegment.java b/src/main/java/org/apache/commons/imaging/formats/jpeg/segments/DhtSegment.java
index 81cfd20c9..8763aa8af 100644
--- a/src/main/java/org/apache/commons/imaging/formats/jpeg/segments/DhtSegment.java
+++ b/src/main/java/org/apache/commons/imaging/formats/jpeg/segments/DhtSegment.java
@@ -77,6 +77,9 @@ public static class HuffmanTable {
             int si = huffSize[0];
             huffCode = new int[lastK];
             while (true) {
+                if (k >= lastK) {
+                    break;
+                }
                 huffCode[k] = code;
                 code++;
                 k++;
diff --git a/src/test/java/org/apache/commons/imaging/formats/jpeg/JpegWithInvalidDhtSegmentTest.java b/src/test/java/org/apache/commons/imaging/formats/jpeg/JpegWithInvalidDhtSegmentTest.java
new file mode 100644
index 000000000..75cd4f7e7
--- /dev/null
+++ b/src/test/java/org/apache/commons/imaging/formats/jpeg/JpegWithInvalidDhtSegmentTest.java
@@ -0,0 +1,41 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.commons.imaging.formats.jpeg;
+
+import java.io.File;
+import java.util.Collections;
+import org.apache.commons.imaging.ImageReadException;
+import org.apache.commons.imaging.Imaging;
+import org.junit.Test;
+
+/**
+ * Test that an invalid segment will not cause an ArrayIndexOutOfBoundsException
+ * when the huffman table is created in a DHT segment.
+ */
+public class JpegWithInvalidDhtSegmentTest {
+
+    @Test(expected = ImageReadException.class)
+    public void testSingleImage() throws Exception {
+        // we cannot use ImagingTest and getImageByFileName, as it would cause others
+        // tests to fail
+        final File imageFile = new File(JpegWithInvalidDhtSegmentTest.class
+                .getResource("/IMAGING-215/ArrayIndexOutOfBoundsException_DhtSegment_79.jpeg")
+                .getFile());
+        Imaging.getMetadata(imageFile, Collections.<String, Object>emptyMap());
+    }
+}
diff --git a/src/test/resources/IMAGING-215/ArrayIndexOutOfBoundsException_DhtSegment_79.jpeg b/src/test/resources/IMAGING-215/ArrayIndexOutOfBoundsException_DhtSegment_79.jpeg
new file mode 100644
index 0000000000000000000000000000000000000000..afc33cd048fa02d14a95ec411e792382f1b578ca
GIT binary patch
literal 2746
zcmex=<NpH&0WUX42L?t)CI%TGWcYuZ!I?orMow8yQiE4fSyx-bz$V4f#@yWIe?+Wj
z%EX45)A}2Fx)yACcDR4lt+ib}C;p$l_3rEc|NmzneDVMPum8{f{{I0ogi%{p*T&SQ
z%-^x>$I_mqKX3!<-PYK^{{swy94rb93e1d-3``=7%!-WvkFfkd!k{X^z{JGJ!pO|Z
z00oRp%z_LoLW+h;j)8^3BF2defy%@ffdHlgLNhV}#iaxp8JL(MGQVKrf<j7;|8Fty
z0L7UEfri;Lgq0f}-66o+n7%M=Q*rGn1%|bfT5co)4}^Lv1QR<;7c3l(T@p>y7>OSS
zV_$$VP-smQ9+(5wp@J!cCW7RAG#NZxxO?!Z!6xO3O%PSA9>z^@gC$R>NQRqRC`=MY
zC&CzLG%%_DM-w82>qLxVM6&z;5iJcOr0}r*-@_wGSc(I;5^3C0C^9T4JkmKUp;`nn
zwbo+_fkd!}6UZHi5XYXz5%LI@DVV7e4W=9r;%F>j0q_eb1WM_8aH#}1%MHnHgdl#F
zCst_&v;YMvVrW428eCU9oOK1x0x@9u6)6{hgzZ2CZV=)I3fuo5K_n7D)8NR4CV<XG
zN%e4ZnBXjA#y4OFgY#wKEHnm%NgT~IBrYiNzX0)({eT|)Na~4VB6|r{gDm!Ri>ioN
z-g|^S9MHN6q7_oX0%cJuSX{<}106*_E|uhoBSMxTAHgP>1-D$7fq|8ofe}`@V>bvC
zh1g|qh(hu{Oi}~JK+r(@8xTAw%LSZa;7-HMz*EQqHG#5#97ywhyBYFuLj>R~C}Y|z
zbP;3+RUmWF*ofdjt@#)j(G&s;8YY;K1B`(|qqUzf<k19{^fRabo+)ZN=|+TCN~&$;
z1h2HqOIiYz=g+yaP~GKD<73&ap<xAAm#H7!D&NkNE0m|g>Mi^6Y+~lRDxX(NrUk5f
tm#o(C=>3I{z~Dg-0VMvkS!S+jDIvPcX1^*t=*95ons(E#=Y9Wg0sz8vE$9FM

literal 0
HcmV?d00001

