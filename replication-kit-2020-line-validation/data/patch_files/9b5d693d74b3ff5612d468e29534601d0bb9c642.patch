From 9b5d693d74b3ff5612d468e29534601d0bb9c642 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 2 Oct 2009 21:16:37 +0000
Subject: [PATCH] FIX: SearchEngine.listModules returns MRID without extra
 attributes (IVY-1128) (thanks to Michael Scheetz)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@821169 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/ivy/core/search/SearchEngine.java  | 19 ++++++++--------
 .../test/a/extraatt.a/extraatt2.a/ivy-1.xml   | 22 +++++++++++++++++++
 .../test/a/extraatt.a/extraatt2.a/ivy-2.xml   | 22 +++++++++++++++++++
 .../test/a/extraatt.a/extraatt2/ivy-1.xml     | 22 +++++++++++++++++++
 .../test/a/extraatt.a/extraatt2/ivy-2.xml     | 22 +++++++++++++++++++
 .../test/a/extraatt/extraatt2.a/ivy-1.xml     | 22 +++++++++++++++++++
 .../test/a/extraatt/extraatt2.a/ivy-2.xml     | 22 +++++++++++++++++++
 7 files changed, 141 insertions(+), 10 deletions(-)
 create mode 100644 test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-1.xml
 create mode 100644 test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-2.xml
 create mode 100644 test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-1.xml
 create mode 100644 test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-2.xml
 create mode 100644 test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-1.xml
 create mode 100644 test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-2.xml

diff --git a/src/java/org/apache/ivy/core/search/SearchEngine.java b/src/java/org/apache/ivy/core/search/SearchEngine.java
index 027f54014..f2fe2a40e 100644
--- a/src/java/org/apache/ivy/core/search/SearchEngine.java
+++ b/src/java/org/apache/ivy/core/search/SearchEngine.java
@@ -27,6 +27,7 @@
 import java.util.List;
 import java.util.Map;
 import java.util.Set;
+import java.util.Map.Entry;
 
 import org.apache.ivy.core.IvyPatternHelper;
 import org.apache.ivy.core.module.id.ModuleId;
@@ -228,11 +229,10 @@ public ModuleRevisionId[] listModules(ModuleRevisionId moduleCrit, PatternMatche
         List ret = new ArrayList();
 
         Map criteria = new HashMap();
-        addMatcher(matcher, moduleCrit.getOrganisation(), 
-                   criteria, IvyPatternHelper.ORGANISATION_KEY);
-        addMatcher(matcher, moduleCrit.getName(), criteria, IvyPatternHelper.MODULE_KEY);
-        addMatcher(matcher, moduleCrit.getBranch(), criteria, IvyPatternHelper.BRANCH_KEY);
-        addMatcher(matcher, moduleCrit.getRevision(), criteria, IvyPatternHelper.REVISION_KEY);
+        for (Iterator it = moduleCrit.getAttributes().entrySet().iterator(); it.hasNext(); ) {
+            Map.Entry entry = (Entry) it.next();
+            addMatcher(matcher, (String) entry.getValue(), criteria, (String) entry.getKey());
+        }
 
         String[] tokensToList = (String[]) moduleCrit.getAttributes().keySet().toArray(
                     new String[moduleCrit.getAttributes().size()]);
@@ -284,11 +284,10 @@ public ModuleRevisionId[] listModules(ModuleRevisionId moduleCrit, PatternMatche
     public ModuleRevisionId[] listModules(
             DependencyResolver resolver, ModuleRevisionId moduleCrit, PatternMatcher matcher) {
         Map criteria = new HashMap();
-        addMatcher(matcher, moduleCrit.getOrganisation(), 
-                   criteria, IvyPatternHelper.ORGANISATION_KEY);
-        addMatcher(matcher, moduleCrit.getName(), criteria, IvyPatternHelper.MODULE_KEY);
-        addMatcher(matcher, moduleCrit.getBranch(), criteria, IvyPatternHelper.BRANCH_KEY);
-        addMatcher(matcher, moduleCrit.getRevision(), criteria, IvyPatternHelper.REVISION_KEY);
+        for (Iterator it = moduleCrit.getAttributes().entrySet().iterator(); it.hasNext(); ) {
+            Map.Entry entry = (Entry) it.next();
+            addMatcher(matcher, (String) entry.getValue(), criteria, (String) entry.getKey());
+        }
         
         String[] tokensToList = (String[]) moduleCrit.getAttributes().keySet().toArray(
             new String[moduleCrit.getAttributes().size()]);
diff --git a/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-1.xml b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-1.xml
new file mode 100644
index 000000000..862f5f977
--- /dev/null
+++ b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-1.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4" xmlns:e="http://ant.apache.org/ivy/extra">
+   <info organisation="test" module="a" revision="1" status="integration" publication="20090108103716" e:att1="extraatt.a" e:att2="extraatt2.a"/>
+   <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-2.xml b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-2.xml
new file mode 100644
index 000000000..2002d9374
--- /dev/null
+++ b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2.a/ivy-2.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4" xmlns:e="http://ant.apache.org/ivy/extra">
+   <info organisation="test" module="a" revision="2" status="integration" publication="20090108103716" e:att1="extraatt.a" e:att2="extraatt2.a"/>
+   <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-1.xml b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-1.xml
new file mode 100644
index 000000000..b2a23ce30
--- /dev/null
+++ b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-1.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4" xmlns:e="http://ant.apache.org/ivy/extra">
+   <info organisation="test" module="a" revision="1" status="integration" publication="20090108103716" e:att1="extraatt.a" e:att2="extraatt2"/>
+   <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-2.xml b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-2.xml
new file mode 100644
index 000000000..382fec7d0
--- /dev/null
+++ b/test/repositories/IVY-1128/test/a/extraatt.a/extraatt2/ivy-2.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4" xmlns:e="http://ant.apache.org/ivy/extra">
+   <info organisation="test" module="a" revision="2" status="integration" publication="20090108103716" e:att1="extraatt.a" e:att2="extraatt2"/>
+   <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-1.xml b/test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-1.xml
new file mode 100644
index 000000000..85e2d1dfd
--- /dev/null
+++ b/test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-1.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4" xmlns:e="http://ant.apache.org/ivy/extra">
+   <info organisation="test" module="a" revision="1" status="integration" publication="20090108103716" e:att1="extraatt" e:att2="extraatt2.a"/>
+   <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-2.xml b/test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-2.xml
new file mode 100644
index 000000000..3061703c1
--- /dev/null
+++ b/test/repositories/IVY-1128/test/a/extraatt/extraatt2.a/ivy-2.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="1.4" xmlns:e="http://ant.apache.org/ivy/extra">
+   <info organisation="test" module="a" revision="2" status="integration" publication="20090108103716" e:att1="extraatt" e:att2="extraatt2.a"/>
+   <publications/>
+</ivy-module>
