From ebb65f0dc2e7ae6099f40837bf7c78f1e12f97de Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 9 Jun 2009 21:27:58 +0000
Subject: [PATCH] FIX: Ivy buildnumber task does not find artifact in Sonatype
 Nexus repo (IVY-1069)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@783144 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                        | 1 +
 src/java/org/apache/ivy/core/IvyPatternHelper.java | 7 ++++++-
 2 files changed, 7 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 635b7a7aa..e8a2e4d45 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -89,6 +89,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 =====================================
 - IMPROVEMENT: Pre and post retrieve artifact events (IVY-1084)
 
+- FIX: Ivy buildnumber task does not find artifact in Sonatype Nexus repo (IVY-1069)
 - FIX: Publish with SSH (sftp or ssh) prevents enclosing java process to terminate (IVY-1075)
 - FIX: Ibiblio resolver throws IndexOutOfBoundsException when using snapshot versions with usepoms='false' (IVY-1028)
 - FIX: Wrong BuildException messages (findmodules) (IVY-1056)
diff --git a/src/java/org/apache/ivy/core/IvyPatternHelper.java b/src/java/org/apache/ivy/core/IvyPatternHelper.java
index b592f11df..c8a364c12 100644
--- a/src/java/org/apache/ivy/core/IvyPatternHelper.java
+++ b/src/java/org/apache/ivy/core/IvyPatternHelper.java
@@ -206,6 +206,11 @@ private static String substituteVariables(
     }
 
     public static String substituteTokens(String pattern, Map tokens) {
+        Map tokensCopy = new HashMap(tokens);
+        if (tokensCopy.containsKey(ORGANISATION_KEY) && !tokensCopy.containsKey(ORGANISATION_KEY2)) {
+            tokensCopy.put(ORGANISATION_KEY2, tokensCopy.get(ORGANISATION_KEY));
+        }
+        
         StringBuffer buffer = new StringBuffer();
 
         char[] chars = pattern.toCharArray();
@@ -265,7 +270,7 @@ public static String substituteTokens(String pattern, Map tokens) {
                     }
 
                     String token = tokenBuffer.toString();
-                    Object tokenValue = tokens.get(token);
+                    Object tokenValue = tokensCopy.get(token);
                     String value = (tokenValue == null) ? null : tokenValue.toString();
 
                     if (insideOptionalPart) {
