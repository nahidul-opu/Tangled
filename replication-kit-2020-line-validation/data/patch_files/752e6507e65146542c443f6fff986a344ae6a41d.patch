From 752e6507e65146542c443f6fff986a344ae6a41d Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Mon, 19 May 2008 20:28:21 +0000
Subject: [PATCH] CONFIGURATION-328: Fixed a bug in XMLConfiguration.addNodes()
 that prevented attribute nodes to be added

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@657961 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/XMLConfiguration.java       |  1 +
 .../configuration/TestXMLConfiguration.java   | 22 +++++++++++++++++++
 xdocs/changes.xml                             |  4 ++++
 3 files changed, 27 insertions(+)

diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index 66f8b1fd3d..7619035847 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -869,6 +869,7 @@ private XMLNode convertToXMLNode(ConfigurationNode node)
 
         XMLNode nd = (XMLNode) createNode(node.getName());
         nd.setValue(node.getValue());
+        nd.setAttribute(node.isAttribute());
         for (Iterator it = node.getChildren().iterator(); it.hasNext();)
         {
             nd.addChild(convertToXMLNode((ConfigurationNode) it.next()));
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 2e41552039..2a9e793652 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -1364,6 +1364,28 @@ public void testCopyRootNameNoDocument() throws ConfigurationException
                 .getRootElementName());
     }
 
+    /**
+     * Tests adding an attribute node using the addNodes() method.
+     */
+    public void testAddNodesAttributeNode()
+    {
+        conf.addProperty("testAddNodes.property[@name]", "prop1");
+        conf.addProperty("testAddNodes.property(0).value", "value1");
+        conf.addProperty("testAddNodes.property(-1)[@name]", "prop2");
+        conf.addProperty("testAddNodes.property(1).value", "value2");
+        Collection nodes = new ArrayList();
+        nodes.add(new HierarchicalConfiguration.Node("property"));
+        conf.addNodes("testAddNodes", nodes);
+        nodes.clear();
+        ConfigurationNode nd = new HierarchicalConfiguration.Node("name",
+                "prop3");
+        nd.setAttribute(true);
+        nodes.add(nd);
+        conf.addNodes("testAddNodes.property(2)", nodes);
+        assertEquals("Attribute not added", "prop3", conf
+                .getString("testAddNodes.property(2)[@name]"));
+    }
+
     /**
      * Prepares a configuration object for testing a reload operation.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index deed0f1fbe..e970482663 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-328">
+        A bug in XMLConfiguration.addNodes() made it impossible to add
+        attribute nodes using this method. This has been fixed.
+      </action>
       <action dev="ebourg" type="fix" issue="CONFIGURATION-322">
         ConfigurationDynaBean now works properly with indexed properties
         stored internally in the underlying configuration as arrays.
