From 47a6aa3f50b605ec5a65c374c921ab9e6404ad74 Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Fri, 6 Nov 2009 19:56:40 +0000
Subject: [PATCH] Apply patch for VFS-287

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/branches/VFS281@833539 13f79535-47bb-0310-9956-ffa450edef68
---
 .../org/apache/commons/vfs/provider/AbstractFileSystem.java   | 4 ++++
 xdocs/changes.xml                                             | 3 +++
 2 files changed, 7 insertions(+)

diff --git a/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java b/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java
index 718e2f2c54..4bdab3d1db 100644
--- a/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java
+++ b/core/src/main/java/org/apache/commons/vfs/provider/AbstractFileSystem.java
@@ -544,6 +544,10 @@ public void removeListener(final FileObject file,
             if (listeners != null)
             {
                 listeners.remove(listener);
+                if (listeners.isEmpty())
+                {
+                    listenerMap.remove(file.getName());
+                }
             }
         }
     }
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 5915118b73..bc81a8c544 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,9 @@
 
   <body>
     <release version="2.0" date="in SVN" description="">
+      <action dev="rgoers" type="fix" issue="VFS-287" due-to="Mircea-Eugen Ionica">
+        LocalFileName objects are not released from AbstractFileSystem.listenerMap when all listeners are removed.
+      </action>      
       <action dev="rgoers" type="fix" issue="VFS-216" due-to="Reetu Mutti">
         The FTP Configuration includes an option to set a timeout for the data connection, but not for the socket
         timeout. This is a problem, as idle sockets can cause your download to hang forever and never timeout.
