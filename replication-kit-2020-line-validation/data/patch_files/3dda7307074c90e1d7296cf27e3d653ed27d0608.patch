From 3dda7307074c90e1d7296cf27e3d653ed27d0608 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 15 Sep 2006 12:23:34 +0000
Subject: [PATCH] FIX: invalid sha1 with sha1 with path (IVY-296)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484520 13f79535-47bb-0310-9956-ffa450edef68
---
 src/java/fr/jayasoft/ivy/util/ChecksumHelper.java      | 10 +++++++++-
 .../jayasoft/ivy/resolver/FileSystemResolverTest.java  |  4 ++--
 .../checksums/allright/allright-with-path-1.0.jar      |  1 +
 .../checksums/allright/allright-with-path-1.0.jar.sha1 |  1 +
 test/repositories/checksums/allright/ivy-1.0.xml       |  4 ++++
 test/repositories/checksums/allright/ivy-1.0.xml.md5   |  2 +-
 6 files changed, 18 insertions(+), 4 deletions(-)
 create mode 100644 test/repositories/checksums/allright/allright-with-path-1.0.jar
 create mode 100644 test/repositories/checksums/allright/allright-with-path-1.0.jar.sha1

diff --git a/src/java/fr/jayasoft/ivy/util/ChecksumHelper.java b/src/java/fr/jayasoft/ivy/util/ChecksumHelper.java
index 6e1e5b479..3dfaf8cac 100644
--- a/src/java/fr/jayasoft/ivy/util/ChecksumHelper.java
+++ b/src/java/fr/jayasoft/ivy/util/ChecksumHelper.java
@@ -20,7 +20,15 @@ public class ChecksumHelper {
 	}
 	
 	public static boolean check(File dest, File checksumFile, String algorithm) throws IOException {
-		String expected = FileUtil.readEntirely(new BufferedReader(new FileReader(checksumFile))).trim().toLowerCase();
+		String csFileContent = FileUtil.readEntirely(new BufferedReader(new FileReader(checksumFile))).trim().toLowerCase();
+		String expected;
+		int spaceIndex = csFileContent.indexOf(' ');
+		if (spaceIndex != -1) {
+			expected = csFileContent.substring(0, spaceIndex);
+		} else {
+			expected = csFileContent;
+		}
+		
 		String computed = computeAsString(dest, algorithm).trim().toLowerCase();
 		return expected.equals(computed);
 	}    
diff --git a/test/java/fr/jayasoft/ivy/resolver/FileSystemResolverTest.java b/test/java/fr/jayasoft/ivy/resolver/FileSystemResolverTest.java
index ad22723f3..f1fd4d582 100644
--- a/test/java/fr/jayasoft/ivy/resolver/FileSystemResolverTest.java
+++ b/test/java/fr/jayasoft/ivy/resolver/FileSystemResolverTest.java
@@ -142,8 +142,8 @@ public void testChecksum() throws Exception {
         ModuleRevisionId mrid = ModuleRevisionId.newInstance("test", "allright", "1.0");
         ResolvedModuleRevision rmr = resolver.getDependency(new DefaultDependencyDescriptor(mrid, false), _data);
         assertNotNull(rmr);
-        DownloadReport dr = resolver.download(new Artifact[] {new DefaultArtifact(mrid, rmr.getPublicationDate(), mrid.getName(), "jar", "jar")}, _ivy, _cache);
-        assertEquals(1, dr.getArtifactsReports(DownloadStatus.SUCCESSFUL).length);
+        DownloadReport dr = resolver.download(rmr.getDescriptor().getAllArtifacts(), _ivy, _cache);
+        assertEquals(2, dr.getArtifactsReports(DownloadStatus.SUCCESSFUL).length);
 
         resolver.setChecksums("md5");
         mrid = ModuleRevisionId.newInstance("test", "badivycs", "1.0");
diff --git a/test/repositories/checksums/allright/allright-with-path-1.0.jar b/test/repositories/checksums/allright/allright-with-path-1.0.jar
new file mode 100644
index 000000000..caf506969
--- /dev/null
+++ b/test/repositories/checksums/allright/allright-with-path-1.0.jar
@@ -0,0 +1 @@
+this is a completely fake jar file !!!
\ No newline at end of file
diff --git a/test/repositories/checksums/allright/allright-with-path-1.0.jar.sha1 b/test/repositories/checksums/allright/allright-with-path-1.0.jar.sha1
new file mode 100644
index 000000000..498107b80
--- /dev/null
+++ b/test/repositories/checksums/allright/allright-with-path-1.0.jar.sha1
@@ -0,0 +1 @@
+1acaeaa173e330150b59da1b2fd6bc8597b6992c /home/xhanin/repository-staging/allright-with-path-1.0.jar
\ No newline at end of file
diff --git a/test/repositories/checksums/allright/ivy-1.0.xml b/test/repositories/checksums/allright/ivy-1.0.xml
index 46e46ad4e..737354449 100644
--- a/test/repositories/checksums/allright/ivy-1.0.xml
+++ b/test/repositories/checksums/allright/ivy-1.0.xml
@@ -4,4 +4,8 @@
 	       revision="1.0"
 	       status="integration"
 	/>
+	<publications>
+		<artifact />
+		<artifact name="allright-with-path" />
+	</publications>
 </ivy-module>
diff --git a/test/repositories/checksums/allright/ivy-1.0.xml.md5 b/test/repositories/checksums/allright/ivy-1.0.xml.md5
index f7a93bec2..226f50cdd 100644
--- a/test/repositories/checksums/allright/ivy-1.0.xml.md5
+++ b/test/repositories/checksums/allright/ivy-1.0.xml.md5
@@ -1 +1 @@
-92b9f8e00de8474562aa1280bfcde4f9
\ No newline at end of file
+eb17df8d0fc75a736f494abff52f5caf
\ No newline at end of file
