From 007901c19daead0f9b76fda63f4fa67518206d1f Mon Sep 17 00:00:00 2001
From: Simone Tripodi <simonetripodi@apache.org>
Date: Thu, 15 Mar 2012 20:09:31 +0000
Subject: [PATCH] potential fix for [DIGESTER-163]

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/digester/trunk@1301177 13f79535-47bb-0310-9956-ffa450edef68
---
 .../digester3/binder/AbstractRulesModule.java  | 18 +++++++++---------
 1 file changed, 9 insertions(+), 9 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/digester3/binder/AbstractRulesModule.java b/core/src/main/java/org/apache/commons/digester3/binder/AbstractRulesModule.java
index 3717b38a1..acc128b42 100644
--- a/core/src/main/java/org/apache/commons/digester3/binder/AbstractRulesModule.java
+++ b/core/src/main/java/org/apache/commons/digester3/binder/AbstractRulesModule.java
@@ -28,26 +28,26 @@ public abstract class AbstractRulesModule
     implements RulesModule
 {
 
-    private RulesBinder rulesBinder;
+    private final ThreadLocal<RulesBinder> rulesBinders = new ThreadLocal<RulesBinder>();
 
     /**
      * {@inheritDoc}
      */
     public final void configure( RulesBinder rulesBinder )
     {
-        if ( this.rulesBinder != null )
+        if ( rulesBinders.get() != null )
         {
             throw new IllegalStateException( "Re-entry is not allowed." );
         }
 
-        this.rulesBinder = rulesBinder;
+        rulesBinders.set( rulesBinder );
         try
         {
             configure();
         }
         finally
         {
-            this.rulesBinder = null;
+            rulesBinders.remove();
         }
     }
 
@@ -68,7 +68,7 @@ public final void configure( RulesBinder rulesBinder )
      */
     protected void addError( String messagePattern, Object... arguments )
     {
-        rulesBinder.addError( messagePattern, arguments );
+        rulesBinders.get().addError( messagePattern, arguments );
     }
 
     /**
@@ -80,7 +80,7 @@ protected void addError( String messagePattern, Object... arguments )
      */
     protected void addError( Throwable t )
     {
-        rulesBinder.addError( t );
+        rulesBinders.get().addError( t );
     }
 
     /**
@@ -91,7 +91,7 @@ protected void addError( Throwable t )
      */
     protected void install( RulesModule rulesModule )
     {
-        rulesBinder.install( rulesModule );
+        rulesBinders.get().install( rulesModule );
     }
 
     /**
@@ -103,7 +103,7 @@ protected void install( RulesModule rulesModule )
      */
     protected LinkedRuleBuilder forPattern( String pattern )
     {
-        return rulesBinder.forPattern( pattern );
+        return rulesBinders.get().forPattern( pattern );
     }
 
     /**
@@ -113,7 +113,7 @@ protected LinkedRuleBuilder forPattern( String pattern )
      */
     protected RulesBinder rulesBinder()
     {
-        return rulesBinder;
+        return rulesBinders.get();
     }
 
 }
