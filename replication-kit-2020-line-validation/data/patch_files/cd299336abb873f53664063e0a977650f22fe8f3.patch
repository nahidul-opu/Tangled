From cd299336abb873f53664063e0a977650f22fe8f3 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Mon, 6 Feb 2017 16:43:40 +0000
Subject: [PATCH] NET-609 - DefaultUnixFTPFileEntryParserFactory Issue (leading
 spaces removal configuration)

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1781925 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                  | 3 +++
 .../net/ftp/parser/DefaultFTPFileEntryParserFactory.java | 9 +++++----
 .../commons/net/ftp/parser/UnixFTPEntryParser.java       | 2 +-
 .../ftp/parser/DefaultFTPFileEntryParserFactoryTest.java | 5 +++++
 4 files changed, 14 insertions(+), 5 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index c47ed76da..2a42c6580 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -64,6 +64,9 @@ The <action> type attribute can be add,update,fix,remove.
 
     <body>
         <release version="3.6" date="TBA" description="">
+            <action issue="NET-609" type="fix" dev="sebb" due-to="Tqup3">
+            DefaultUnixFTPFileEntryParserFactory Issue (leading spaces removal configuration)
+            </action>
             <action type="update" dev="sebb">
             POP3Mail example: support host port; allow reading password from Console/stdin/environment
             </action>
diff --git a/src/main/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactory.java b/src/main/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactory.java
index f4d0df0c7..75f200197 100644
--- a/src/main/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactory.java
+++ b/src/main/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactory.java
@@ -121,13 +121,14 @@ private FTPFileEntryParser createFileEntryParser(String key, FTPClientConfig con
 
         if (parser == null) { // Now try for aliases
             String ukey = key.toUpperCase(java.util.Locale.ENGLISH);
-            if (ukey.indexOf(FTPClientConfig.SYST_UNIX) >= 0)
+            if (ukey.indexOf(FTPClientConfig.SYST_UNIX_TRIM_LEADING) >= 0)
             {
-                parser = new UnixFTPEntryParser(config, false);
+                parser = new UnixFTPEntryParser(config, true);
             }
-            else if (ukey.indexOf(FTPClientConfig.SYST_UNIX_TRIM_LEADING) >= 0)
+            // must check this after SYST_UNIX_TRIM_LEADING as it is a substring of it
+            else if (ukey.indexOf(FTPClientConfig.SYST_UNIX) >= 0)
             {
-                parser = new UnixFTPEntryParser(config, true);
+                parser = new UnixFTPEntryParser(config, false);
             }
             else if (ukey.indexOf(FTPClientConfig.SYST_VMS) >= 0)
             {
diff --git a/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java b/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
index 3e70ebd17..7520b6641 100644
--- a/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
+++ b/src/main/java/org/apache/commons/net/ftp/parser/UnixFTPEntryParser.java
@@ -148,7 +148,7 @@ or time (for numeric or recent standard format) [h]h:mm
 
     // if true, leading spaces are trimmed from file names
     // this was the case for the original implementation
-    private final boolean trimLeadingSpaces;
+    final boolean trimLeadingSpaces; // package protected for access from test code
 
     /**
      * The default constructor for a UnixFTPEntryParser object.
diff --git a/src/test/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactoryTest.java b/src/test/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactoryTest.java
index 609d0b7b3..0bcb6e611 100644
--- a/src/test/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactoryTest.java
+++ b/src/test/java/org/apache/commons/net/ftp/parser/DefaultFTPFileEntryParserFactoryTest.java
@@ -32,6 +32,11 @@ public void testDefaultParserFactory() throws Exception {
 
         parser = factory.createFileEntryParser("UNIX");
         assertTrue(parser instanceof UnixFTPEntryParser);
+        assertFalse(((UnixFTPEntryParser)parser).trimLeadingSpaces);
+
+        parser = factory.createFileEntryParser("UNIX_LTRIM");
+        assertTrue(parser instanceof UnixFTPEntryParser);
+        assertTrue(((UnixFTPEntryParser)parser).trimLeadingSpaces);
 
         parser = factory.createFileEntryParser("Unix");
         assertTrue(parser instanceof UnixFTPEntryParser);
