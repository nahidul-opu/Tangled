From 823cdee9b18508e9e51913d110a20a406f55582b Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Fri, 20 May 2016 18:42:10 +0200
Subject: [PATCH] COMPRESS-356 properly deal with PAX header entries ending in
 slash

Suggested-by: Jeremy Gustie <jeremy at gustie dot com>
---
 src/changes/changes.xml                          |   5 +++++
 .../compress/archivers/tar/TarArchiveEntry.java  |   2 +-
 .../archivers/tar/TarArchiveInputStreamTest.java |  15 +++++++++++++++
 src/test/resources/COMPRESS-356.tar              | Bin 0 -> 8192 bytes
 4 files changed, 21 insertions(+), 1 deletion(-)
 create mode 100644 src/test/resources/COMPRESS-356.tar

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 276bb662500..e5517b30239 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -65,6 +65,11 @@ The <action> type attribute can be add,update,fix,remove.
         TarArchiveInputStream failed to parse PAX headers that
         included blank lines.
       </action>
+      <action issue="COMPRESS-356" type="fix" date="2016-05-20"
+              due-to="Jeremy Gustie">
+        TarArchiveInputStream failed to parse PAX headers whose tar
+        entry name ended with a slash.
+      </action>
     </release>
     <release version="1.11" date="2016-04-06"
              description="Release 1.11">
diff --git a/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveEntry.java b/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveEntry.java
index 941bbbd36a4..a5050bfa9dc 100644
--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveEntry.java
+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveEntry.java
@@ -856,7 +856,7 @@ public boolean isDirectory() {
             return true;
         }
 
-        if (getName().endsWith("/")) {
+        if (!isPaxHeader() && !isGlobalPaxHeader() && getName().endsWith("/")) {
             return true;
         }
 
diff --git a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java
index 015748b624a..161ee12a0e1 100644
--- a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java
+++ b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java
@@ -313,6 +313,21 @@ public void survivesBlankLinesInPaxHeader() throws Exception {
         }
     }
 
+    /**
+     * @link "https://issues.apache.org/jira/browse/COMPRESS-356"
+     */
+    @Test
+    public void survivesPaxHeaderWithNameEndingInSlash() throws Exception {
+        final TarArchiveInputStream is = getTestStream("/COMPRESS-356.tar");
+        try {
+            final TarArchiveEntry entry = is.getNextTarEntry();
+            assertEquals("package/package.json", entry.getName());
+            assertNull(is.getNextTarEntry());
+        } finally {
+            is.close();
+        }
+    }
+
     private TarArchiveInputStream getTestStream(final String name) {
         return new TarArchiveInputStream(
                 TarArchiveInputStreamTest.class.getResourceAsStream(name));
diff --git a/src/test/resources/COMPRESS-356.tar b/src/test/resources/COMPRESS-356.tar
new file mode 100644
index 0000000000000000000000000000000000000000..4dd6be9ff87a7f946cc9e02054b7c44690d9475e
GIT binary patch
literal 8192
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
Nnb_w1_`&L+e*sHllB)m!

literal 0
HcmV?d00001

