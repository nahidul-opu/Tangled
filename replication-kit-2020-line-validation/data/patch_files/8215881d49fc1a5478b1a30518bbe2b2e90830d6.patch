From 8215881d49fc1a5478b1a30518bbe2b2e90830d6 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 5 Jan 2012 19:07:55 +0000
Subject: [PATCH] NET-430 Can't login to POP3S Server using explicit mode

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1227768 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  3 +++
 .../org/apache/commons/net/pop3/POP3.java     | 20 +++++++++----------
 .../apache/commons/net/pop3/POP3SClient.java  |  6 ++++++
 3 files changed, 19 insertions(+), 10 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index e2b51b35b..a2693c811 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -59,6 +59,9 @@ The <action> type attribute can be add,update,fix,remove.
         <release version="3.1-SNAPSHOT" date="TBA" description="
 TBA
         ">
+            <action issue="NET-430" dev="sebb" type="fix">
+            Can't login to POP3S Server using explicit mode
+            </action>
             <action issue="NET-434" dev="sebb" type="fix">
             FTPClient fails to close local listener socket when command socket channel encounter "ReadTimeoutException"
             </action>
diff --git a/src/main/java/org/apache/commons/net/pop3/POP3.java b/src/main/java/org/apache/commons/net/pop3/POP3.java
index 21eba852f..c1ac22381 100644
--- a/src/main/java/org/apache/commons/net/pop3/POP3.java
+++ b/src/main/java/org/apache/commons/net/pop3/POP3.java
@@ -76,10 +76,10 @@ public class POP3 extends SocketClient
     // We have to ensure that the protocol communication is in ASCII
     // but we use ISO-8859-1 just in case 8-bit characters cross
     // the wire.
-    private static final String __DEFAULT_ENCODING = "ISO-8859-1";
+    static final String _DEFAULT_ENCODING = "ISO-8859-1";
 
     private int __popState;
-    private BufferedWriter __writer;
+    BufferedWriter _writer;
 
     BufferedReader _reader;
     int _replyCode;
@@ -101,7 +101,7 @@ public POP3()
         setDefaultPort(DEFAULT_PORT);
         __popState = DISCONNECTED_STATE;
         _reader = null;
-        __writer = null;
+        _writer = null;
         _replyLines = new ArrayList<String>();
         _commandSupport_ = new ProtocolCommandSupport(this);
     }
@@ -144,10 +144,10 @@ protected void _connectAction_() throws IOException
         super._connectAction_();
         _reader =
           new CRLFLineReader(new InputStreamReader(_input_,
-                                                   __DEFAULT_ENCODING));
-        __writer =
+                                                   _DEFAULT_ENCODING));
+        _writer =
           new BufferedWriter(new OutputStreamWriter(_output_,
-                                                    __DEFAULT_ENCODING));
+                                                    _DEFAULT_ENCODING));
         __getReply();
         setState(AUTHORIZATION_STATE);
     }
@@ -205,7 +205,7 @@ public void disconnect() throws IOException
     {
         super.disconnect();
         _reader = null;
-        __writer = null;
+        _writer = null;
         _lastReplyLine = null;
         _replyLines.clear();
         setState(DISCONNECTED_STATE);
@@ -221,7 +221,7 @@ public void disconnect() throws IOException
      ***/
     public int sendCommand(String command, String args) throws IOException
     {
-        if (__writer == null) {
+        if (_writer == null) {
             throw new IllegalStateException("Socket is not connected");
         }
         StringBuilder __commandBuffer = new StringBuilder();
@@ -235,8 +235,8 @@ public int sendCommand(String command, String args) throws IOException
         __commandBuffer.append(SocketClient.NETASCII_EOL);
 
         String message = __commandBuffer.toString();
-        __writer.write(message);
-        __writer.flush();
+        _writer.write(message);
+        _writer.flush();
 
         fireCommandSent(command, message);
 
diff --git a/src/main/java/org/apache/commons/net/pop3/POP3SClient.java b/src/main/java/org/apache/commons/net/pop3/POP3SClient.java
index 3f3c9a4e3..64eef21e7 100644
--- a/src/main/java/org/apache/commons/net/pop3/POP3SClient.java
+++ b/src/main/java/org/apache/commons/net/pop3/POP3SClient.java
@@ -17,7 +17,10 @@
 
 package org.apache.commons.net.pop3;
 
+import java.io.BufferedWriter;
 import java.io.IOException;
+import java.io.InputStreamReader;
+import java.io.OutputStreamWriter;
 import java.net.Socket;
 
 import javax.net.ssl.KeyManager;
@@ -27,6 +30,7 @@
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.TrustManager;
 
+import org.apache.commons.net.io.CRLFLineReader;
 import org.apache.commons.net.util.SSLContextUtils;
 
 /**
@@ -203,6 +207,8 @@ private void performSSLNegotiation() throws IOException
         _socket_ = socket;
         _input_ = socket.getInputStream();
         _output_ = socket.getOutputStream();
+        _reader = new CRLFLineReader(new InputStreamReader(_input_, _DEFAULT_ENCODING));
+        _writer = new BufferedWriter(new OutputStreamWriter(_output_, _DEFAULT_ENCODING));    
     }
 
     /**
