From 79f8be9d026dc5b2aa73531f5d10d9a41a76d9a6 Mon Sep 17 00:00:00 2001
From: Mario Ivankovits <imario@apache.org>
Date: Mon, 14 May 2007 06:00:47 +0000
Subject: [PATCH] VFS-136: Don't force-set the classloader - Thanks to Adam
 Heath for the patch

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/vfs/trunk@537717 13f79535-47bb-0310-9956-ffa450edef68
---
 .../vfs/impl/StandardFileSystemManager.java   | 22 +++++++++++++------
 1 file changed, 15 insertions(+), 7 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs/impl/StandardFileSystemManager.java b/core/src/main/java/org/apache/commons/vfs/impl/StandardFileSystemManager.java
index 1f1b49ca7e..6b26572a6e 100644
--- a/core/src/main/java/org/apache/commons/vfs/impl/StandardFileSystemManager.java
+++ b/core/src/main/java/org/apache/commons/vfs/impl/StandardFileSystemManager.java
@@ -103,12 +103,15 @@ public void init() throws FileSystemException
         setReplicator(new PrivilegedFileReplicator(replicator));
         setTemporaryFileStore(replicator);
 
-        if (classLoader == null)
+		/* replaced by findClassLoader
+		if (classLoader == null)
         {
             // Use default classloader
             classLoader = getClass().getClassLoader();
         }
-        if (configUri == null)
+        */
+
+		if (configUri == null)
         {
             // Use default config
             final URL url = getClass().getResource(CONFIG_RESOURCE);
@@ -146,7 +149,7 @@ protected void configurePlugins() throws FileSystemException
 		{
 			throw new FileSystemException(e);
 		}
-		
+
 		while (enumResources.hasMoreElements())
 		{
 			URL url = (URL) enumResources.nextElement();
@@ -156,6 +159,11 @@ protected void configurePlugins() throws FileSystemException
 
 	private ClassLoader findClassLoader()
 	{
+		if (classLoader != null)
+		{
+			return classLoader;
+		}
+
 		ClassLoader cl = Thread.currentThread().getContextClassLoader();
 		if (cl == null)
 		{
@@ -261,7 +269,7 @@ private void configure(final Element config) throws FileSystemException
             final Element operationProvider = (Element) operationProviders.item(i);
             addOperationProvider(operationProvider);
         }
-        
+
         // Add the default provider
         final NodeList defProviders = config.getElementsByTagName("default-provider");
         if (defProviders.getLength() > 0)
@@ -380,7 +388,7 @@ private void addOperationProvider(final Element providerDef) throws FileSystemEx
             }
         }
     }
-    
+
     /**
      * Tests if a class is available.
      */
@@ -388,7 +396,7 @@ private boolean findClass(final String className)
     {
         try
         {
-            classLoader.loadClass(className);
+            findClassLoader().loadClass(className);
             return true;
         }
         catch (final ClassNotFoundException e)
@@ -461,7 +469,7 @@ private Object createInstance(final String className)
     {
         try
         {
-            final Class clazz = classLoader.loadClass(className);
+            final Class clazz = findClassLoader().loadClass(className);
             return clazz.newInstance();
         }
         catch (final Exception e)
