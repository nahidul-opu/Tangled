From 4e52d16c4cf767f488d4e3265019d1fe03fda4dd Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 21 Oct 2008 21:03:57 +0000
Subject: [PATCH] FIX: Ivy doesn't throw an error when the parent POM cannot be
 loaded (IVY-931)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@706768 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../parser/m2/PomModuleDescriptorParser.java  |  4 +--
 .../m2/PomModuleDescriptorParserTest.java     | 13 +++++--
 .../parser/m2/test-parent-not-found.pom       | 36 +++++++++++++++++++
 4 files changed, 50 insertions(+), 4 deletions(-)
 create mode 100644 test/java/org/apache/ivy/plugins/parser/m2/test-parent-not-found.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index 6182af654..e3625a950 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -115,6 +115,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: Correctly set ivy.resolved.configurations property when the conf string includes a negation operator (IVY-951) (thanks to Patrick Woodworth)
 - FIX: Maven pom license url can contain xml entities (IVY-950)
 - FIX: Maven pom license has name as optional element (IVY-949)
+- FIX: Ivy doesn't throw an error when the parent POM cannot be loaded (IVY-931)
 
    2.0.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
index ecdd82198..a052d6091 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
@@ -135,8 +135,8 @@ public ModuleDescriptor parseDescriptor(ParserSettings ivySettings, URL descript
                 if (parentModule != null) {
                     parentDescr = parentModule.getDescriptor();
                 } else {
-                   Message.warn("impossible to load parent for " + descriptorURL + "."
-                       + " Parent=" + parentModRevID); 
+                    throw new IOException("Impossible to load parent for " + descriptorURL + "."
+                       + " Parent=" + parentModRevID);
                 }
                 if (parentDescr != null) {
                     Map parentPomProps = PomModuleDescriptorBuilder.extractPomProperties(
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index f78e85aa3..0a073401e 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -138,7 +138,6 @@ public void testEjbPackaging() throws Exception {
         assertEquals("ejb", artifact[0].getType());
     }
 
-    
     public void testParent() throws Exception {
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
             settings, getClass().getResource("test-parent.pom"), false);
@@ -152,7 +151,17 @@ public void testParent() throws Exception {
         assertEquals(mrid, artifact[0].getModuleRevisionId());
         assertEquals("test", artifact[0].getName());
     }
-
+    
+    public void testParentNotFound() throws Exception {
+        try {
+            PomModuleDescriptorParser.getInstance().parseDescriptor(
+                new IvySettings(), getClass().getResource("test-parent-not-found.pom"), false);
+            fail("IOException should have been thrown!");
+        } catch (IOException e) {
+            assertTrue(e.getMessage().indexOf("Impossible to load parent") != -1);
+        }
+    }
+    
     public void testParent2() throws Exception {
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
             settings, getClass().getResource("test-parent2.pom"), false);
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/test-parent-not-found.pom b/test/java/org/apache/ivy/plugins/parser/m2/test-parent-not-found.pom
new file mode 100644
index 000000000..70898fbe1
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/parser/m2/test-parent-not-found.pom
@@ -0,0 +1,36 @@
+<?xml version="1.0"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<project>
+  <parent>
+    <artifactId>test-parent</artifactId>
+    <groupId>org.apache.parent</groupId>
+    <version>1.0.parent.notfound</version>
+  </parent>
+  <modelVersion>4.0.0</modelVersion>
+  <groupId>org.apache</groupId>
+  <artifactId>test</artifactId>
+  <name>Test Module for Ivy M2 parsing</name>
+  <version>1.0</version>
+  <url>http://ivy.jayasoft.org/</url>
+  <organization>
+    <name>Jayasoft</name>
+    <url>http://www.jayasoft.org/</url>
+  </organization>
+</project>
