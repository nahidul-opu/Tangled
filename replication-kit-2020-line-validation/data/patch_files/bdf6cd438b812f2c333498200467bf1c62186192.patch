From bdf6cd438b812f2c333498200467bf1c62186192 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Thu, 8 Mar 2007 15:22:54 +0000
Subject: [PATCH] FIX: ${project.groupId} and ${project.version} not processed
 correctly in poms (IVY-425)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@516069 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |   3 +-
 .../parser/m2/PomModuleDescriptorParser.java  |   5 +-
 .../m2/PomModuleDescriptorParserTest.java     |  13 +++
 .../parser/m2/spring-hibernate3-2.0.2.pom     | 102 ++++++++++++++++++
 4 files changed, 120 insertions(+), 3 deletions(-)
 create mode 100644 test/java/org/apache/ivy/plugins/parser/m2/spring-hibernate3-2.0.2.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index a0c16da16..a62c16e2c 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -18,8 +18,10 @@ for detailed view of each issue, please consult http://jira.jayasoft.org/
 
 - FIX: NPE when no organisation or no name is provided in module element of ivyconf (IVY-422)
 - FIX: FileUtil#copy(File src, File dest, CopyProgressListener l, boolean overwrite) (IVY-420)
+- FIX: ${project.groupId} and ${project.version} not processed correctly in poms (IVY-425)
 - FIX: Incorrect pom parsing with profile (IVY-423)
 - FIX: Ivy doesn't recognize maven2 classifiers (IVY-418)
+- FIX: PomModuleDescriptorParser fails with nested profile dependency (IVY-392) (thanks to William Lyvers)
 - FIX: Static revision replacement is not working when delivering an artifact with a dependency having extra attributes (IVY-415)
 - FIX: Static revision replacement is not working when delivering an artifact with a dependency on a branch (IVY-404)
 - FIX: latest-time conflict manager not working properly (IVY-407)
@@ -28,7 +30,6 @@ for detailed view of each issue, please consult http://jira.jayasoft.org/
 - FIX: Comments in ivy.xml duplicated (IVY-336) (thanks to Gilles Scokart)
 - FIX: Ivy failure when the ivy.xml file contains non US-ASCII characters (IVY-346) (thanks to Gilles Scokart)
 - FIX: Urlresolver is not possible to use dynamic revisions on nonstandard repository structure (IVY-350) (thanks to Pierre Hägnestrand)
-- FIX: PomModuleDescriptorParser fails with nested profile dependency (IVY-392) (thanks to William Lyvers)
 
 
    version 1.4.1 - 2006-11-09
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
index 025aa181e..5b45e1f80 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
@@ -131,6 +131,9 @@ private void fillMrid() throws SAXException {
                 _revision = "SNAPSHOT";
             }
             ModuleRevisionId mrid = ModuleRevisionId.newInstance(_organisation, _module, _revision);
+            _properties.put("project.groupId", _organisation);
+            _properties.put("project.artifactId", _module);
+            _properties.put("project.version", _revision);
             _properties.put("pom.version", _revision);
             _md.setModuleRevisionId(mrid);
             _md.addArtifact("master", new DefaultArtifact(mrid, getDefaultPubDate(),_module, "jar", "jar"));
@@ -252,8 +255,6 @@ public void characters(char[] ch, int start, int length) throws SAXException {
             }
         }
         
-        
-
         private String getContext() {
             StringBuffer buf = new StringBuffer();
             for (Iterator iter = _contextStack.iterator(); iter.hasNext();) {
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index a26b8ae0c..5e5fde6ed 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -169,6 +169,19 @@ public void testReal() throws Exception {
         assertEquals(ModuleRevisionId.newInstance("junit", "junit", "3.7"), dds[0].getDependencyRevisionId());
     }
     
+    public void testVariables() throws Exception {
+    	// test case for IVY-425
+        ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(new IvySettings(), getClass().getResource("spring-hibernate3-2.0.2.pom"), false);
+        assertNotNull(md);
+        
+        assertEquals(ModuleRevisionId.newInstance("org.springframework", "spring-hibernate3", "2.0.2"), md.getModuleRevisionId());
+        
+        DependencyDescriptor[] dds = md.getDependencies();
+        assertNotNull(dds);
+        assertEquals(11, dds.length);
+        assertEquals(ModuleRevisionId.newInstance("org.springframework", "spring-web", "2.0.2"), dds[10].getDependencyRevisionId());
+    }
+    
     public void testDependenciesInProfile() throws Exception {
     	// test case for IVY-423
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(new IvySettings(), getClass().getResource("mule-module-builders-1.3.3.pom"), false);
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/spring-hibernate3-2.0.2.pom b/test/java/org/apache/ivy/plugins/parser/m2/spring-hibernate3-2.0.2.pom
new file mode 100644
index 000000000..59e8d6a88
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/parser/m2/spring-hibernate3-2.0.2.pom
@@ -0,0 +1,102 @@
+<?xml version="1.0"?>
+<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+  <modelVersion>4.0.0</modelVersion>
+  <groupId>org.springframework</groupId>
+  <artifactId>spring-hibernate3</artifactId>
+  <packaging>jar</packaging>
+  <name>Spring Framework: Hibernate3</name>
+
+  <version>2.0.2</version>
+  <description>Spring Framework: Hibernate3</description>
+  <url>http://www.springframework.org</url>
+  <licenses>
+    <license>
+      <name>The Apache Software License, Version 2.0</name>
+      <url>http://www.apache.org/licenses/LICENSE-2.0.txt</url>
+
+      <distribution>repo</distribution>
+    </license>
+  </licenses>
+  <scm>
+    <connection>scm:cvs:pserver:anonymous:@springframework.cvs.sourceforge.net:/cvsroot/springframework</connection>
+    <developerConnection>scm:cvs:ext:username@springframework.cvs.sourceforge.net:/cvsroot/springframework</developerConnection>
+    <tag>2.0.2</tag>
+
+    <url>http://springframework.cvs.sourceforge.net/springframework/</url>
+  </scm>
+  <organization>
+    <name>Spring Framework</name>
+    <url>http://www.springframework.org/</url>
+  </organization>
+  <dependencies>
+
+<!-- External Dependencies -->
+    <dependency>
+      <groupId>aopalliance</groupId>
+      <artifactId>aopalliance</artifactId>
+      <version>1.0</version>
+    </dependency>
+    <dependency>
+      <groupId>commons-logging</groupId>
+
+      <artifactId>commons-logging</artifactId>
+      <version>1.1</version>
+    </dependency>
+    <dependency>
+      <groupId>org.hibernate</groupId>
+      <artifactId>hibernate</artifactId>
+      <version>3.2.1.ga</version>
+
+    </dependency>
+    <dependency>
+      <groupId>javax.servlet</groupId>
+      <artifactId>servlet-api</artifactId>
+      <version>2.4</version>
+      <scope>provided</scope>
+    </dependency>
+
+<!-- Spring Dependencies -->
+    <dependency>
+      <groupId>${project.groupId}</groupId>
+      <artifactId>spring-aop</artifactId>
+      <version>${project.version}</version>
+      <optional>true</optional>
+    </dependency>
+
+    <dependency>
+      <groupId>${project.groupId}</groupId>
+      <artifactId>spring-beans</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>${project.groupId}</groupId>
+
+      <artifactId>spring-context</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>${project.groupId}</groupId>
+      <artifactId>spring-core</artifactId>
+      <version>${project.version}</version>
+
+    </dependency>
+    <dependency>
+      <groupId>${project.groupId}</groupId>
+      <artifactId>spring-dao</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+
+      <groupId>${project.groupId}</groupId>
+      <artifactId>spring-jdbc</artifactId>
+      <version>${project.version}</version>
+    </dependency>
+    <dependency>
+      <groupId>${project.groupId}</groupId>
+      <artifactId>spring-web</artifactId>
+
+      <version>${project.version}</version>
+      <optional>true</optional>
+    </dependency>
+  </dependencies>
+</project>
