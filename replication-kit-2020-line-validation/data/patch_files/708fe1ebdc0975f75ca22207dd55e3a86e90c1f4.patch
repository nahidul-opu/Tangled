From 708fe1ebdc0975f75ca22207dd55e3a86e90c1f4 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 5 Jan 2010 20:05:08 +0000
Subject: [PATCH] DBCP-318 PerUserPoolDataSource.getPooledConnectionAndInfo
 multi-threading bug

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@896195 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/dbcp/datasources/PerUserPoolDataSource.java   | 8 ++++++--
 xdocs/changes.xml                                         | 3 +++
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/dbcp/datasources/PerUserPoolDataSource.java b/src/java/org/apache/commons/dbcp/datasources/PerUserPoolDataSource.java
index 764c6fabae..594e8338b3 100644
--- a/src/java/org/apache/commons/dbcp/datasources/PerUserPoolDataSource.java
+++ b/src/java/org/apache/commons/dbcp/datasources/PerUserPoolDataSource.java
@@ -364,8 +364,9 @@ public int getNumIdle(String username, String password) {
         throws SQLException {
 
         PoolKey key = getPoolKey(username,password);
-        Object pool = pools.get(key);
+        Object pool;
         synchronized(this) {
+            pool = pools.get(key);
             if (pool == null) {
                 try {
                     registerPool(username, password);
@@ -498,7 +499,10 @@ private synchronized void registerPool(
                                   isRollbackAfterValidation(), 
                                   username, password);
            
-        pools.put(getPoolKey(username,password), pool);
+        Object old = pools.put(getPoolKey(username,password), pool);
+        if (old != null) {
+            throw new IllegalStateException("Pool already contains an entry for this user/password: "+username);
+        }
     }
 
     /**
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index fcc2668397..0a3de2ff7e 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -49,6 +49,9 @@ The <action> type attribute can be add,update,fix,remove.
      changes below since 1.2.2 applies to both the 1.3 and 1.4 release.  Other than
      the one issue related to adding JDBC 4 support (DBCP-191), all bug fixes
      or new features are included in both DBCP 1.3 and 1.4 ">
+      <action dev="sebb" type="fix" issue="DBCP-318" due-to="Sebastian Bazley">
+        PerUserPoolDataSource.getPooledConnectionAndInfo multi-threading bug.
+      </action>
       <action dev="sebb" type="fix" issue="DBCP-315" due-to="Sebastian Bazley">
         Remove throws clause from method that does not throw an exception.
       </action>
