From ce2799a5384000e034250c4cbfa3286b52d79c77 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 3 Apr 2014 22:39:03 +0000
Subject: [PATCH] JCS-113 Potential NPE in JDBCDiskCache Fixed NPEs in
 getSize() and getStatistics()

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/jcs/trunk@1584437 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  4 +++
 .../auxiliary/disk/jdbc/JDBCDiskCache.java    | 30 +++++++++++++++----
 2 files changed, 28 insertions(+), 6 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index ff9204048..5d0c2f5d9 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -20,6 +20,10 @@
 	</properties>
 	<body>
 		<release version="2.0" date="unreleased" description="JDK 1.6 based major release">
+            <action issue="JCS-113" dev="sebb" type="fix">
+                Potential NPE in JDBCDiskCache
+                Fixed NPEs in getSize() and getStatistics()
+            </action>
             <action issue="JCS-112" dev="sebb" type="fix">
                 RemoteCacheServer.logUpdateInfo bug updating put count
             </action>
diff --git a/src/java/org/apache/commons/jcs/auxiliary/disk/jdbc/JDBCDiskCache.java b/src/java/org/apache/commons/jcs/auxiliary/disk/jdbc/JDBCDiskCache.java
index 40da439ef..f7cb1e6a7 100644
--- a/src/java/org/apache/commons/jcs/auxiliary/disk/jdbc/JDBCDiskCache.java
+++ b/src/java/org/apache/commons/jcs/auxiliary/disk/jdbc/JDBCDiskCache.java
@@ -976,10 +976,14 @@ public int getSize()
         String selectString = "select count(*) from " + getJdbcDiskCacheAttributes().getTableName()
             + " where REGION = ?";
 
+        final JDBCDiskCachePoolAccess pool = getPoolAccess();
+        if (pool == null) {
+            return size;
+        }
         Connection con;
         try
         {
-            con = getPoolAccess().getConnection();
+            con = pool.getConnection();
         }
         catch ( SQLException e1 )
         {
@@ -1141,26 +1145,40 @@ public IStats getStatistics()
         se.setData( "" + getMatchingCount );
         elems.add( se );
 
+        final JDBCDiskCachePoolAccess pool = getPoolAccess();
+
         se = new StatElement();
         se.setName( "Size" );
-        se.setData( "" + getSize() );
+        if (pool != null) {
+            se.setData( "" + getSize() );
+        } else {
+            se.setData( "No db connection pool found" );
+        }
         elems.add( se );
 
         se = new StatElement();
         se.setName( "Active DB Connections" );
-        se.setData( "" + getPoolAccess().getNumActiveInPool() );
+        if (pool != null) {
+            se.setData( "" + pool.getNumActiveInPool() );
+        } else {
+            se.setData( "No db connection pool found" );
+        }
         elems.add( se );
 
         se = new StatElement();
         se.setName( "Idle DB Connections" );
-        se.setData( "" + getPoolAccess().getNumIdleInPool() );
+        if (pool != null) {
+            se.setData( "" + pool.getNumIdleInPool() );
+        } else {
+            se.setData( "No db connection pool found" );
+        }
         elems.add( se );
 
         se = new StatElement();
         se.setName( "DB URL" );
-        if ( getPoolAccess() != null )
+        if ( pool != null )
         {
-            se.setData( "" + getPoolAccess().getPoolUrl() );
+            se.setData( "" + pool.getPoolUrl() );
         }
         else
         {
