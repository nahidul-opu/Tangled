From eaec509f96957bb62ba7ee383e6be07ab29da104 Mon Sep 17 00:00:00 2001
From: Niall Pemberton <niallp@apache.org>
Date: Mon, 2 Jul 2007 03:27:17 +0000
Subject: [PATCH] BEANUTILS-43 - Support Mapped property inside a mapped
 property

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/beanutils/trunk@552391 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/beanutils/PropertyUtilsBean.java  | 14 +++++++
 .../beanutils/PropertyUtilsTestCase.java      | 39 +++++++++++++++++++
 2 files changed, 53 insertions(+)

diff --git a/src/java/org/apache/commons/beanutils/PropertyUtilsBean.java b/src/java/org/apache/commons/beanutils/PropertyUtilsBean.java
index e9f40a80c..9b8c39ce5 100644
--- a/src/java/org/apache/commons/beanutils/PropertyUtilsBean.java
+++ b/src/java/org/apache/commons/beanutils/PropertyUtilsBean.java
@@ -780,6 +780,13 @@ protected Object getPropertyOfMapBean(Map bean, String propertyName)
         throws IllegalArgumentException, IllegalAccessException, 
         InvocationTargetException, NoSuchMethodException {
 
+        if (resolver.isMapped(propertyName)) {
+            String name = resolver.getProperty(propertyName);
+            if (name == null || name.length() == 0) {
+                propertyName = resolver.getKey(propertyName);
+            }
+        }
+
         if (resolver.isIndexed(propertyName) ||
             resolver.isMapped(propertyName)) {
             throw new IllegalArgumentException(
@@ -1886,6 +1893,13 @@ protected void setPropertyOfMapBean(Map bean, String propertyName, Object value)
         throws IllegalArgumentException, IllegalAccessException, 
         InvocationTargetException, NoSuchMethodException {
 
+        if (resolver.isMapped(propertyName)) {
+            String name = resolver.getProperty(propertyName);
+            if (name == null || name.length() == 0) {
+                propertyName = resolver.getKey(propertyName);
+            }
+        }
+
         if (resolver.isIndexed(propertyName) ||
             resolver.isMapped(propertyName)) {
             throw new IllegalArgumentException(
diff --git a/src/test/org/apache/commons/beanutils/PropertyUtilsTestCase.java b/src/test/org/apache/commons/beanutils/PropertyUtilsTestCase.java
index 49ecce5a8..5574582e8 100755
--- a/src/test/org/apache/commons/beanutils/PropertyUtilsTestCase.java
+++ b/src/test/org/apache/commons/beanutils/PropertyUtilsTestCase.java
@@ -1121,6 +1121,25 @@ public void testGetMappedArguments() {
     }
 
 
+    /**
+     * Test getting a value out of a mapped Map
+     */
+    public void testGetMappedMap() {
+        TestBean bean = new TestBean();
+        Map map = new HashMap();
+        map.put("sub-key-1", "sub-value-1");
+        map.put("sub-key-2", "sub-value-2");
+        map.put("sub-key-3", "sub-value-3");
+        bean.getMapProperty().put("mappedMap", map);
+        try {
+            assertEquals("sub-value-1", PropertyUtils.getProperty(bean, "mapProperty(mappedMap)(sub-key-1)"));
+            assertEquals("sub-value-2", PropertyUtils.getProperty(bean, "mapProperty(mappedMap)(sub-key-2)"));
+            assertEquals("sub-value-3", PropertyUtils.getProperty(bean, "mapProperty(mappedMap)(sub-key-3)"));
+        } catch (Throwable t) {
+            fail("Threw " + t + "");
+        }
+    }
+
     /**
      * Test getting mapped values with periods in the key.
      */
@@ -2805,6 +2824,26 @@ public void testSetMappedArguments() {
     }
 
 
+    /**
+     * Test setting a value out of a mapped Map
+     */
+    public void testSetMappedMap() {
+        TestBean bean = new TestBean();
+        Map map = new HashMap();
+        map.put("sub-key-1", "sub-value-1");
+        map.put("sub-key-2", "sub-value-2");
+        map.put("sub-key-3", "sub-value-3");
+        bean.getMapProperty().put("mappedMap", map);
+
+        assertEquals("BEFORE", "sub-value-3", ((Map)bean.getMapProperty().get("mappedMap")).get("sub-key-3"));
+        try {
+            PropertyUtils.setProperty(bean, "mapProperty(mappedMap)(sub-key-3)", "SUB-KEY-3-UPDATED");
+        } catch (Throwable t) {
+            fail("Threw " + t + "");
+        }
+        assertEquals("AFTER", "SUB-KEY-3-UPDATED", ((Map)bean.getMapProperty().get("mappedMap")).get("sub-key-3"));
+    }
+
     /**
      * Positive and negative tests on setMappedProperty valid arguments.
      */
