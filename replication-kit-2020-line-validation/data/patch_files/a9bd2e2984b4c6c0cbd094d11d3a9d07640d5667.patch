From a9bd2e2984b4c6c0cbd094d11d3a9d07640d5667 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Tue, 26 Jul 2011 14:12:44 +0000
Subject: [PATCH] For non-ZIP64 entries this should actually fix COMPRESS-129

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@1151104 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                       | 4 ++++
 .../commons/compress/archivers/zip/ZipArchiveInputStream.java | 2 +-
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index f8ab7343fae..235c52b93dd 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -45,6 +45,10 @@ The <action> type attribute can be add,update,fix,remove.
   </properties>
   <body>
     <release version="1.2" date="as in SVN" description="Release 1.2">
+      <action issue="COMPRESS-129" type="fix" date="2011-07-26">
+        ZipArchiveInputStream could fail with a "Truncated ZIP" error
+        message for entries between 2 GByte and 4 GByte in size.
+      </action>
       <action issue="COMPRESS-145" type="fix" date="2011-07-23"
               due-tue="Patrick Dreyer">
         TarArchiveInputStream now detects sparse entries using the
diff --git a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java
index 09b008340e4..feea2703a7a 100644
--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java
+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java
@@ -420,7 +420,7 @@ private void closeEntry() throws IOException {
 
             long inB;
             if (current.getMethod() == ZipArchiveOutputStream.DEFLATED) {
-                inB = inf.getTotalIn();
+                inB = ZipUtil.adjustToLong(inf.getTotalIn());
             } else {
                 inB = readBytesOfEntry;
             }
