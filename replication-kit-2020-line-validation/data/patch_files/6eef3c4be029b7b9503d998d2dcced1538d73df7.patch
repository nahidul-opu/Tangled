From 6eef3c4be029b7b9503d998d2dcced1538d73df7 Mon Sep 17 00:00:00 2001
From: kazk <kazk@unknown>
Date: Thu, 10 Jan 2013 21:54:41 +0000
Subject: [PATCH] GORA-182 Nutch 2.1 does not work with gora-cassandra 0.2.1

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1431683 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                               | 2 ++
 .../org/apache/gora/cassandra/store/CassandraStore.java   | 8 +++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 7c0546476..7e856ee70 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -6,6 +6,8 @@ Gora Change Log
 
 trunk (current development)
 
+* GORA-182 Nutch 2.1 does not work with gora-cassandra 0.2.1 (kazk)
+
 * GORA-193 Make sure gora-core test dependency is always generated when packaging (lewismc)
 
 * GORA-186 Show better errors when a field is missing in HBase mapping (Alfonso Nishikawa via hsaputra)
diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
index 2b9c4e93e..d3f00ca00 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
@@ -304,7 +304,13 @@ public void put(K key, T value) {
             fieldValue = newRecord;
             break;
           case MAP:
-            // needs to keep State.DELETED.
+            StatefulHashMap map = (StatefulHashMap) fieldValue;
+            StatefulHashMap newMap = new StatefulHashMap();
+            for (Object mapKey : map.keySet()) {
+              newMap.put(mapKey, map.get(mapKey));
+              newMap.putState(mapKey, map.getState(mapKey));
+            }
+            fieldValue = newMap;
             break;
           case ARRAY:
             GenericArray array = (GenericArray) fieldValue;
