From 6eddefe29318d846c3f0f169565372923b0c8180 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sun, 2 Mar 2008 21:06:57 +0000
Subject: [PATCH] CONFIGURATION-315: Applying fix to configuration2-branch

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/configuration2_experimental@632845 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration2/CombinedConfiguration.java   |  5 ++++-
 .../TestCombinedConfiguration.java              | 17 ++++++++++++++++-
 xdocs/changes.xml                               |  5 +++++
 3 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/configuration2/CombinedConfiguration.java b/src/main/java/org/apache/commons/configuration2/CombinedConfiguration.java
index 8ad201a883..ce7cb5d4b7 100644
--- a/src/main/java/org/apache/commons/configuration2/CombinedConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration2/CombinedConfiguration.java
@@ -485,7 +485,10 @@ public void invalidate()
      */
     public void configurationChanged(ConfigurationEvent event)
     {
-        invalidate();
+        if (!event.isBeforeUpdate())
+        {
+            invalidate();
+        }
     }
 
     /**
diff --git a/src/test/java/org/apache/commons/configuration2/TestCombinedConfiguration.java b/src/test/java/org/apache/commons/configuration2/TestCombinedConfiguration.java
index d75dc5587e..440db30edd 100644
--- a/src/test/java/org/apache/commons/configuration2/TestCombinedConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration2/TestCombinedConfiguration.java
@@ -326,7 +326,7 @@ public void testUpdateContainedConfiguration()
         c.addProperty("test.otherTest", "yes");
         assertEquals("New property not found", "yes", config
                 .getString("test.otherTest"));
-        listener.checkEvent(3, 0);
+        listener.checkEvent(2, 0);
     }
 
     /**
@@ -576,6 +576,21 @@ public void testEscapeListDelimiters()
         assertEquals("Wrong value", "3,1415", config.getString("test.pi"));
     }
 
+    /**
+     * Tests whether an invalidate event is fired only after a change. This test
+     * is related to CONFIGURATION-315.
+     */
+    public void testInvalidateAfterChange()
+    {
+        ConfigurationEvent event = new ConfigurationEvent(config, 0, null,
+                null, true);
+        config.configurationChanged(event);
+        assertEquals("Invalidate event fired", 0, listener.invalidateEvents);
+        event = new ConfigurationEvent(config, 0, null, null, false);
+        config.configurationChanged(event);
+        assertEquals("No invalidate event fired", 1, listener.invalidateEvents);
+    }
+
     /**
      * Helper method for writing a file.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index d198fb7600..d409e77929 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -66,6 +66,11 @@
     </release>
 
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-315">
+        CombinedConfiguration used to send two EVENT_COMBINED_INVALIDATE events
+        for each modified child configuration. Now this event is sent only
+        once after the affected child configuration was updated.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-306">
         INIConfiguration now preserves whitespace in quoted values.
       </action>
