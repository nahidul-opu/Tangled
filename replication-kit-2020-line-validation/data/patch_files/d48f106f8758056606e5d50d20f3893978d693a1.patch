From d48f106f8758056606e5d50d20f3893978d693a1 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Wed, 3 Aug 2011 13:36:01 +0000
Subject: [PATCH] finalize deflater and inflater instances in ZIP streams. 
 COMPRESS-152

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@1153483 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                       | 4 ++++
 .../commons/compress/archivers/zip/ZipArchiveInputStream.java | 1 +
 .../compress/archivers/zip/ZipArchiveOutputStream.java        | 1 +
 3 files changed, 6 insertions(+)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index a93bdeaf387..63068553874 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -46,6 +46,10 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
     <release version="1.3" date="unreleased"
              description="Release 1.3 - API compatible to 1.2 but requires Java5 at runtime">
+      <action issue="COMPRESS-152" type="fix" date="2011-08-03">
+        ZipArchiveInputStream and ZipArchiveOutputStream could leak
+        resources on some JDKs.
+      </action> 
     </release>
     <release version="1.2" date="2011-07-31"
              description="Release 1.2 - a bugfix release, the last release expected to be compatible with Java 1.4">
diff --git a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java
index a78a9550e5f..92e083a3dbc 100644
--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java
+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveInputStream.java
@@ -364,6 +364,7 @@ public void close() throws IOException {
         if (!closed) {
             closed = true;
             in.close();
+            inf.end();
         }
     }
 
diff --git a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveOutputStream.java b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveOutputStream.java
index 3be2ad5ee37..9e0e0ab00f5 100644
--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveOutputStream.java
+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipArchiveOutputStream.java
@@ -357,6 +357,7 @@ public void finish() throws IOException {
         writeCentralDirectoryEnd();
         offsets.clear();
         entries.clear();
+        def.end();
         finished = true;
     }
 
