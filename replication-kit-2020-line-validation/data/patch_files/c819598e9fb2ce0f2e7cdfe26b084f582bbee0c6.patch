From c819598e9fb2ce0f2e7cdfe26b084f582bbee0c6 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 10 Feb 2010 22:34:40 +0000
Subject: [PATCH] FIX: Using SFTP resolver with full pattern URL prevents use
 of dynamic versions (IVY-1167) (thanks to Gregory Fernandez)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@908693 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                       |  2 ++
 .../plugins/repository/sftp/SFTPRepository.java   | 15 ++++++++++-----
 2 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 220871f35..f4cae28e9 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -34,6 +34,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 	Archie Cobbs
 	Flavio Coutinho da Costa
 	Martin Eigenbrodt
+	Gregory Fernandez
 	Danno Ferrin
 	Benjamin Francisoud	
 	Jacob Grydholt Jensen
@@ -110,6 +111,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Trace a message when a property file referenced from the settings doesn't exixts (IVY-1074)
 - IMPROVEMENT: use defaultconf in combination with defaultconfmapping (IVY-1135) (thanks to Jon Schneider)
 
+- FIX: Using SFTP resolver with full pattern URL prevents use of dynamic versions (IVY-1167) (thanks to Gregory Fernandez)
 - FIX: parent.groupId is not resolved in maven 2 parser (IVY-1169) (thanks to Achim Huegen)
 - FIX: Creation of symlinks problematic in Windows with Cygwin 1.7 (IVY-1165)
 - FIX: add ability to programmatically change default resolver (IVY-1163) (thanks to Jason Trump)
diff --git a/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java b/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java
index b90803479..cea187f45 100644
--- a/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java
+++ b/src/java/org/apache/ivy/plugins/repository/sftp/SFTPRepository.java
@@ -202,10 +202,11 @@ private String getPath(String sftpURI) throws URISyntaxException {
     public List list(String parent) throws IOException {
         try {
             ChannelSftp c = getSftpChannel(parent);
-            Collection r = c.ls(parent);
+            String path = getPath(parent);
+            Collection r = c.ls(path);
             if (r != null) {
-                if (!parent.endsWith("/")) {
-                    parent = parent + "/";
+                if (!path.endsWith("/")) {
+                	path = parent + "/";
                 }
                 List result = new ArrayList();
                 for (Iterator iter = r.iterator(); iter.hasNext();) {
@@ -215,7 +216,7 @@ public List list(String parent) throws IOException {
                         if (".".equals(entry.getFilename()) || "..".equals(entry.getFilename())) {
                             continue;
                         }
-                        result.add(parent + entry.getFilename());
+                        result.add(path + entry.getFilename());
                     }
                 }
                 return result;
@@ -224,7 +225,11 @@ public List list(String parent) throws IOException {
             IOException ex = new IOException("Failed to return a listing for '" + parent + "'");
             ex.initCause(e);
             throw ex;
-        }
+        } catch (URISyntaxException usex) {
+            IOException ex = new IOException("Failed to return a listing for '" + parent + "'");
+            ex.initCause(usex);
+            throw ex;
+        }            
         return null;
     }
 
