From 8af453cdab42b5276cec2e89d83ce5c87d70a137 Mon Sep 17 00:00:00 2001
From: Claudio Martella <claudio@apache.org>
Date: Thu, 15 Aug 2013 17:21:51 +0200
Subject: [PATCH] GIRAPH-734

---
 CHANGELOG                                                 | 3 +++
 .../apache/giraph/partition/DiskBackedPartitionStore.java | 8 ++++++--
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index c8d20c8ee..f3bba6eff 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,9 @@
 Giraph Change Log
 
 Release 1.1.0 - unreleased
+  GIRAPH-734: DiskBackedPartitionStore attempting to release a lock it doesn't own
+  (cmuchinsky via claudio)
+
   GIRAPH-739: Discrepancy among numeric constants corresponding to frequency of 
   writing in TextAggregatorWriter (korlando via claudio)
 
diff --git a/giraph-core/src/main/java/org/apache/giraph/partition/DiskBackedPartitionStore.java b/giraph-core/src/main/java/org/apache/giraph/partition/DiskBackedPartitionStore.java
index dbfb7916f..87e04c1b4 100644
--- a/giraph-core/src/main/java/org/apache/giraph/partition/DiskBackedPartitionStore.java
+++ b/giraph-core/src/main/java/org/apache/giraph/partition/DiskBackedPartitionStore.java
@@ -728,7 +728,9 @@ public Partition<I, V, E> call() throws Exception {
                 "illegal state " + pState + " for partition " + id);
           }
         } finally {
-          wLock.unlock();
+          if (lock.isWriteLockedByCurrentThread()) {
+            wLock.unlock();
+          }
         }
       }
       return partition;
@@ -854,7 +856,9 @@ public Void call() throws Exception {
         }
         return null;
       } finally {
-        wLock.unlock();
+        if (lock.isWriteLockedByCurrentThread()) {
+          wLock.unlock();
+        }
       }
     }
   }
