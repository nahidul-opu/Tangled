From cfd2560843033325d5ed7001f363e93fd5294000 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Thu, 13 Dec 2007 06:51:15 +0000
Subject: [PATCH] CONFIGURATION-301: Fix for NPE when saving an
 XMLConfiguration constructed from a HierarchicalConfiguration

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@603841 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/configuration/XMLConfiguration.java |  7 +++++--
 .../configuration/TestXMLConfiguration.java     | 17 +++++++++++++++++
 xdocs/changes.xml                               |  5 +++++
 3 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index 15317d534c..041fb2f7e9 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -200,6 +200,7 @@ public XMLConfiguration(HierarchicalConfiguration c)
     {
         super(c);
         clearReferences(getRootNode());
+        setRootElementName(getRootNode().getName());
     }
 
     /**
@@ -1266,8 +1267,10 @@ static void updateAttribute(Node node, String name, char listDelimiter)
          */
         private Element getElement(Node node)
         {
-            // special treatement for root node of the hierarchy
-            return (node.getName() != null) ? (Element) node.getReference() : document.getDocumentElement();
+            // special treatment for root node of the hierarchy
+            return (node.getName() != null && node.getReference() != null) ? (Element) node
+                    .getReference()
+                    : document.getDocumentElement();
         }
     }
 
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 01b2088f14..ac379d31c7 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -1278,6 +1278,23 @@ public void testRegisterEntityIdNull() throws IOException
         }
     }
 
+    /**
+     * Tests saving a configuration that was created from a hierarchical
+     * configuration. This test exposes bug CONFIGURATION-301.
+     */
+    public void testSaveAfterCreateWithCopyConstructor()
+            throws ConfigurationException
+    {
+        HierarchicalConfiguration hc = conf.configurationAt("element2");
+        conf = new XMLConfiguration(hc);
+        conf.save(testSaveConf);
+        XMLConfiguration checkConfig = new XMLConfiguration();
+        checkConfig.setFile(testSaveConf);
+        checkSavedConfig(checkConfig);
+        assertEquals("Wrong name of root element", "element2", checkConfig
+                .getRootElementName());
+    }
+
     /**
      * Prepares a configuration object for testing a reload operation.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 30b20fbd4e..a4616673ec 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-301">
+        Fixed a NullPointerException that could be thrown under certain
+        circumstances when saving an XMLConfiguration that was created using
+        the constructor that takes a HierarchicalConfiguration.
+      </action>
     </release>
 
     <release version="1.5" date="2007-11-24" description="Many smaller bugfixes">
