From e9999fd04a6338058d27421f427304699dc53c29 Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Wed, 19 Sep 2018 22:34:40 +0000
Subject: [PATCH] [VFS-675] NullPointerException at
 AbstractFileObject.java:221.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@1841400 13f79535-47bb-0310-9956-ffa450edef68
---
 .../vfs2/provider/AbstractFileObject.java     | 34 ++++++++++---------
 src/changes/changes.xml                       |  3 ++
 2 files changed, 21 insertions(+), 16 deletions(-)

diff --git a/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileObject.java b/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileObject.java
index a575d5a512..5010388c43 100644
--- a/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileObject.java
+++ b/commons-vfs2/src/main/java/org/apache/commons/vfs2/provider/AbstractFileObject.java
@@ -214,26 +214,28 @@ protected void childrenChanged(final FileName childName, final FileType newType)
     @Override
     public void close() throws FileSystemException {
         FileSystemException exc = null;
+        
+        synchronized (fs) {
+            // Close the content
+            if (content != null) {
+                try {
+                    content.close();
+                    content = null;
+                } catch (final FileSystemException e) {
+                    exc = e;
+                }
+            }
 
-        // Close the content
-        if (content != null) {
+            // Detach from the file
             try {
-                content.close();
-                content = null;
-            } catch (final FileSystemException e) {
-                exc = e;
+                detach();
+            } catch (final Exception e) {
+                exc = new FileSystemException("vfs.provider/close.error", fileName, e);
             }
-        }
-
-        // Detach from the file
-        try {
-            detach();
-        } catch (final Exception e) {
-            exc = new FileSystemException("vfs.provider/close.error", fileName, e);
-        }
 
-        if (exc != null) {
-            throw exc;
+            if (exc != null) {
+                throw exc;
+            }
         }
     }
 
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 7e5e27a385..b9a888901a 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -89,6 +89,9 @@ The <action> type attribute can be add,update,fix,remove.
       <action issue="VFS-671" dev="ggregory" type="update">
         Update Apache Commons Compress from 1.16.1 to 1.18.
       </action>
+      <action issue="VFS-675" dev="ggregory" type="fix">
+        NullPointerException at AbstractFileObject.java:221.
+      </action>
     </release>
     <release version="2.2" date="2017-10-06" description="New features and bug fix release.">
       <action issue="VFS-642" dev="pschumacher" type="update" due-to="ilangoldfeld">
