From 50f9c9370c1286039fb6750e08e0fcbc20c6adc0 Mon Sep 17 00:00:00 2001
From: Niall Pemberton <niallp@apache.org>
Date: Thu, 3 Jan 2008 04:47:17 +0000
Subject: [PATCH] IO-147 - Deletion of orphaned Softlinks does not work -
 reported by Stefan Lischke, patch from Sebb

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@608338 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                                     |  2 ++
 src/java/org/apache/commons/io/FileUtils.java         |  8 +++++---
 src/test/org/apache/commons/io/FileUtilsTestCase.java | 11 +++++++++++
 3 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index 9f318725471..32bc74f6123 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -26,6 +26,8 @@ Semantic compatible - ?
 
 Bug fixes from 1.3.2
 --------------------
+- FileUtils
+  - forceDelete of orphaned Softlinks does not work [IO-147]
 
 Enhancements from 1.3.2
 -----------------------
diff --git a/src/java/org/apache/commons/io/FileUtils.java b/src/java/org/apache/commons/io/FileUtils.java
index bf529a08bc5..35f0ceeb794 100644
--- a/src/java/org/apache/commons/io/FileUtils.java
+++ b/src/java/org/apache/commons/io/FileUtils.java
@@ -1232,16 +1232,18 @@ public static void writeLines(File file, Collection lines, String lineEnding) th
      *
      * @param file  file or directory to delete, must not be <code>null</code>
      * @throws NullPointerException if the directory is <code>null</code>
+     * @throws FileNotFoundException if the file was not found
      * @throws IOException in case deletion is unsuccessful
      */
     public static void forceDelete(File file) throws IOException {
         if (file.isDirectory()) {
             deleteDirectory(file);
         } else {
-            if (!file.exists()) {
-                throw new FileNotFoundException("File does not exist: " + file);
-            }
+            boolean filePresent = file.exists();
             if (!file.delete()) {
+                if (!filePresent){
+                    throw new FileNotFoundException("File does not exist: " + file);
+                }
                 String message =
                     "Unable to delete file: " + file;
                 throw new IOException(message);
diff --git a/src/test/org/apache/commons/io/FileUtilsTestCase.java b/src/test/org/apache/commons/io/FileUtilsTestCase.java
index f4019ff206b..be4b776f143 100644
--- a/src/test/org/apache/commons/io/FileUtilsTestCase.java
+++ b/src/test/org/apache/commons/io/FileUtilsTestCase.java
@@ -18,6 +18,7 @@
 
 import java.io.File;
 import java.io.FileInputStream;
+import java.io.FileNotFoundException;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.io.OutputStream;
@@ -780,6 +781,16 @@ public void testForceDeleteAFile2() throws Exception {
         assertTrue("Check No Exist", !destination.exists());
     }
 
+    public void testForceDeleteAFile3() throws Exception {
+        File destination = new File(getTestDirectory(), "no_such_file");
+        assertTrue("Check No Exist", !destination.exists());
+        try {
+            FileUtils.forceDelete(destination);
+            fail("Should generate FileNotFoundException");
+        } catch (FileNotFoundException ignored){
+        }
+    }
+
     // copyFileToDirectory
 
     public void testCopyFile1ToDir() throws Exception {
