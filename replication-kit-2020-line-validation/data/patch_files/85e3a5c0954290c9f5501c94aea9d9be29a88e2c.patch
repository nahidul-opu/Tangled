From 85e3a5c0954290c9f5501c94aea9d9be29a88e2c Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 15 Dec 2008 21:49:40 +0000
Subject: [PATCH] FIX: NPE in LogReportOutputter (IVY-961) (merged from trunk)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/branches/2.0.x@726818 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                            |  1 +
 .../apache/ivy/plugins/report/LogReportOutputter.java  |  3 ++-
 test/java/org/apache/ivy/ant/IvyResolveTest.java       | 10 ++++++++++
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index b4698ebcb..a06ba8a71 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -86,6 +86,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Ivy Standalone setting to overwrite publications (IVY-976)
 
 - FIX: Log levels aren't respected in certain cases using the standalone functionality (IVY-960) (thanks to Patrick Woodworth)
+- FIX: NPE in LogReportOutputter (IVY-961)
 
    2.0.0-rc2
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/report/LogReportOutputter.java b/src/java/org/apache/ivy/plugins/report/LogReportOutputter.java
index e1f8fee00..35aa519a6 100644
--- a/src/java/org/apache/ivy/plugins/report/LogReportOutputter.java
+++ b/src/java/org/apache/ivy/plugins/report/LogReportOutputter.java
@@ -48,6 +48,7 @@ public void output(
             ResolveReport report, ResolutionCacheManager cacheMgr, ResolveOptions options) 
             throws IOException {
         IvySettings settings = IvyContext.getContext().getSettings();
+
         if (settings.logModulesInUse() && ResolveOptions.LOG_DEFAULT.equals(options.getLog())) {
             Message.info("\t:: modules in use:");
             List dependencies = new ArrayList(report.getDependencies());
@@ -56,7 +57,7 @@ public void output(
                 String[] confs = report.getConfigurations();
                 for (int i = 0; i < dependencies.size(); i++) {
                     IvyNode node = (IvyNode) dependencies.get(i);
-                    if (node.isCompletelyEvicted()) {
+                    if (node.isCompletelyEvicted() || node.hasProblem()) {
                         continue;
                     }
                     List nodeConfs = new ArrayList(confs.length);
diff --git a/test/java/org/apache/ivy/ant/IvyResolveTest.java b/test/java/org/apache/ivy/ant/IvyResolveTest.java
index 96b64b8a0..c0e09784d 100644
--- a/test/java/org/apache/ivy/ant/IvyResolveTest.java
+++ b/test/java/org/apache/ivy/ant/IvyResolveTest.java
@@ -241,6 +241,16 @@ public void testFailure() throws Exception {
         }
     }
 
+    public void testIvyLogModulesInUseWithFailure() throws Exception {
+        resolve.getProject().setProperty("ivy.log.modules.in.use", "true");
+        resolve.setFile(new File("test/java/org/apache/ivy/ant/ivy-failure.xml"));
+        resolve.setHaltonfailure(false);
+        resolve.execute();
+        
+        // we did manage to get here, so no NPE has been thrown (IVY-961)
+    }
+
+    
     public void testFailureWithMissingConfigurations() throws Exception {
         try {
             resolve.setFile(new File("test/java/org/apache/ivy/ant/ivy-simple.xml"));
