From 2c8892a206c9374b0cde6fce72299b0fe630f3a0 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Sat, 17 Jun 2017 21:46:25 +0200
Subject: [PATCH] COMPRESS-411 Math.abs is dangerous

---
 .../org/apache/commons/compress/archivers/tar/TarUtils.java   | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
index c0dac4ca464..4e99a203a77 100644
--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
@@ -496,8 +496,8 @@ private static void formatLongBinary(final long value, final byte[] buf,
                                          final boolean negative) {
         final int bits = (length - 1) * 8;
         final long max = 1l << bits;
-        long val = Math.abs(value);
-        if (val >= max) {
+        long val = Math.abs(value); // Long.MIN_VALUE stays Long.MIN_VALUE
+        if (val < 0 || val >= max) {
             throw new IllegalArgumentException("Value " + value +
                 " is too large for " + length + " byte field.");
         }
