From eff38bf063fbd052cfe47bca56e4b2d8073b6ce6 Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Mon, 22 Nov 2010 23:23:59 +0000
Subject: [PATCH] Fox for VFS-343. Use AtomicInteger instead of synchronizing
 on FileSystem

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@1037935 13f79535-47bb-0310-9956-ffa450edef68
---
 .../vfs2/provider/AbstractFileSystem.java     | 31 +++++++++----------
 1 file changed, 15 insertions(+), 16 deletions(-)

diff --git a/core/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java b/core/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java
index 276316983a..81e05007e4 100644
--- a/core/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java
+++ b/core/src/main/java/org/apache/commons/vfs2/provider/AbstractFileSystem.java
@@ -46,6 +46,7 @@
 import java.util.HashSet;
 import java.util.Map;
 import java.lang.reflect.InvocationTargetException;
+import java.util.concurrent.atomic.AtomicInteger;
 
 /**
  * A partial {@link org.apache.commons.vfs2.FileSystem} implementation.
@@ -101,7 +102,7 @@ public abstract class AbstractFileSystem
     /**
      * open streams counter for this filesystem
      */
-    private int openStreams;
+    private AtomicInteger openStreams = new AtomicInteger(0);
 
     protected AbstractFileSystem(final FileName rootName,
                                  final FileObject parentLayer,
@@ -647,24 +648,25 @@ FileSystemKey getCacheKey()
 
     void streamOpened()
     {
-        synchronized (this)
-        {
-            openStreams++;
-        }
+        openStreams.incrementAndGet();
     }
 
     void streamClosed()
     {
-        synchronized (this)
+        int count;
+
+        do
         {
-            if (openStreams > 0)
+            count = openStreams.get();
+            if (count < 1)
             {
-                openStreams--;
-                if (openStreams < 1)
-                {
-                    notifyAllStreamsClosed();
-                }
+                return;
             }
+        } while(openStreams.compareAndSet(count, count - 1));
+
+        if (count == 1)
+        {
+            notifyAllStreamsClosed();
         }
     }
 
@@ -681,9 +683,6 @@ protected void notifyAllStreamsClosed()
      */
     public boolean isOpen()
     {
-        synchronized (this)
-        {
-            return openStreams > 0;
-        }
+        return openStreams.get() > 0;
     }
 }
