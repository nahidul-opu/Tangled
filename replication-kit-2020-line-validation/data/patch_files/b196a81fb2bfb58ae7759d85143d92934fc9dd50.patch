From b196a81fb2bfb58ae7759d85143d92934fc9dd50 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Thu, 9 Nov 2006 14:43:03 +0000
Subject: [PATCH] FIX: Some file descriptors are left open (IVY-338)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484582 13f79535-47bb-0310-9956-ffa450edef68
---
 .../ivy/external/m2/PomModuleDescriptorParser.java        | 8 +++++++-
 .../fr/jayasoft/ivy/parser/ModuleDescriptorParser.java    | 8 ++++++++
 .../fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java    | 4 ++++
 3 files changed, 19 insertions(+), 1 deletion(-)

diff --git a/src/java/fr/jayasoft/ivy/external/m2/PomModuleDescriptorParser.java b/src/java/fr/jayasoft/ivy/external/m2/PomModuleDescriptorParser.java
index a7bee8b3a..021f936eb 100644
--- a/src/java/fr/jayasoft/ivy/external/m2/PomModuleDescriptorParser.java
+++ b/src/java/fr/jayasoft/ivy/external/m2/PomModuleDescriptorParser.java
@@ -249,7 +249,13 @@ public ModuleDescriptor parseDescriptor(Ivy ivy, URL descriptorURL, Resource res
     }
 
     public void toIvyFile(InputStream is, Resource res, File destFile, ModuleDescriptor md) throws ParseException, IOException {
-        XmlModuleDescriptorWriter.write(md, destFile);        
+    	try {
+    		XmlModuleDescriptorWriter.write(md, destFile);
+    	} finally {
+    		if (is != null) {
+    			is.close();
+    		}
+    	}
     }
 
     public boolean accept(Resource res) {
diff --git a/src/java/fr/jayasoft/ivy/parser/ModuleDescriptorParser.java b/src/java/fr/jayasoft/ivy/parser/ModuleDescriptorParser.java
index dcfa1ed56..bfabbf014 100644
--- a/src/java/fr/jayasoft/ivy/parser/ModuleDescriptorParser.java
+++ b/src/java/fr/jayasoft/ivy/parser/ModuleDescriptorParser.java
@@ -20,6 +20,14 @@ public interface ModuleDescriptorParser {
     public ModuleDescriptor parseDescriptor(Ivy ivy, URL descriptorURL, boolean validate) throws ParseException, IOException;
     public ModuleDescriptor parseDescriptor(Ivy ivy, URL descriptorURL, Resource res, boolean validate) throws ParseException, IOException;
     
+    /**
+     * Convert a module descriptor to an ivy file.
+     * 
+     * This method MUST close the given input stream when job is finished
+     * 
+     * @param is input stream with opened on original module descriptor resource
+     * 
+     */
     public void toIvyFile(InputStream is, Resource res, File destFile, ModuleDescriptor md) throws ParseException, IOException;
 
     public boolean accept(Resource res);
diff --git a/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java b/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java
index 7f49627ab..976c7745b 100644
--- a/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java
+++ b/src/java/fr/jayasoft/ivy/xml/XmlModuleDescriptorParser.java
@@ -104,6 +104,10 @@ public void toIvyFile(InputStream is, Resource res, File destFile, ModuleDescrip
             ParseException ex = new ParseException("exception occured while parsing "+res, 0);
             ex.initCause(e);
             throw ex;
+        } finally {
+        	if (is != null) {
+        		is.close();
+        	}
         }
     }
 
