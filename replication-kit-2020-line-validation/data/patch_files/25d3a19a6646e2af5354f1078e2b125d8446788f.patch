From 25d3a19a6646e2af5354f1078e2b125d8446788f Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Fri, 12 Apr 2013 20:25:24 +0000
Subject: [PATCH] [CONFIGURATION-524] MapConfiguration.clone() now ensures that
 the configuration's interpolator is cloned, too.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@1467447 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/MapConfiguration.java       |  1 +
 .../configuration/TestMapConfiguration.java   | 19 +++++++++++++++++++
 2 files changed, 20 insertions(+)

diff --git a/src/main/java/org/apache/commons/configuration/MapConfiguration.java b/src/main/java/org/apache/commons/configuration/MapConfiguration.java
index 7ae3aea9c8..dbffc1476d 100644
--- a/src/main/java/org/apache/commons/configuration/MapConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration/MapConfiguration.java
@@ -239,6 +239,7 @@ public Object clone()
             @SuppressWarnings("unchecked")
             Map<String, Object> clonedMap = (Map<String, Object>) ConfigurationUtils.clone(map);
             copy.map = clonedMap;
+            copy.cloneInterpolator(this);
             return copy;
         }
         catch (CloneNotSupportedException cex)
diff --git a/src/test/java/org/apache/commons/configuration/TestMapConfiguration.java b/src/test/java/org/apache/commons/configuration/TestMapConfiguration.java
index ee3ce2e23f..5c8d4e45e7 100644
--- a/src/test/java/org/apache/commons/configuration/TestMapConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration/TestMapConfiguration.java
@@ -107,6 +107,25 @@ public void configurationChanged(ConfigurationEvent event)
                 .getString("key1"));
     }
 
+    /**
+     * Tests whether interpolation works as expected after cloning.
+     */
+    @Test
+    public void testCloneInterpolation()
+    {
+        final String keyAnswer = "answer";
+        final String keyValue = "value";
+        MapConfiguration config = (MapConfiguration) getConfiguration();
+        config.addProperty(keyAnswer, "The answer is ${" + keyValue + "}.");
+        config.addProperty(keyValue, 42);
+        MapConfiguration clone = (MapConfiguration) config.clone();
+        clone.setProperty(keyValue, 43);
+        assertEquals("Wrong interpolation in original", "The answer is 42.",
+                config.getString(keyAnswer));
+        assertEquals("Wrong interpolation in clone", "The answer is 43.",
+                clone.getString(keyAnswer));
+    }
+
     /**
      * Tests adding another value to an existing property.
      */
