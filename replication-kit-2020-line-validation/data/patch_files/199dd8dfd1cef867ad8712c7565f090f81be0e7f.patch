From 199dd8dfd1cef867ad8712c7565f090f81be0e7f Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 7 Jun 2012 23:54:49 +0000
Subject: [PATCH] IO-279 - Tailer erroneously considers file as new.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@1347836 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                               | 3 +++
 src/main/java/org/apache/commons/io/input/Tailer.java | 8 +++++---
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 953ebf4c39a..a0ec4ecfdb6 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -47,6 +47,9 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
     <!-- The release date is the date RC is cut -->
     <release version="2.4" date="2012-TDB-TDB" description="">
+      <action issue="IO-279" dev="sebb" type="fix" due-to="Sergio Bossa, Chris Baron">
+        Tailer erroneously considers file as new.
+      </action>            
       <action issue="IO-335" dev="sebb" type="fix">
         Tailer#readLines - incorrect CR handling.
       </action>            
diff --git a/src/main/java/org/apache/commons/io/input/Tailer.java b/src/main/java/org/apache/commons/io/input/Tailer.java
index 4f9594772fe..3cc4f5595a2 100644
--- a/src/main/java/org/apache/commons/io/input/Tailer.java
+++ b/src/main/java/org/apache/commons/io/input/Tailer.java
@@ -297,6 +297,8 @@ public void run() {
 
             while (run) {
 
+                boolean newer = FileUtils.isFileNewer(file, last); // IO-279, must be done first
+
                 // Check the file length to see if it was rotated
                 long length = file.length();
 
@@ -326,10 +328,10 @@ public void run() {
                     if (length > position) {
 
                         // The file has more content than it did last time
-                        last = System.currentTimeMillis();
                         position = readLines(reader);
+                        last = System.currentTimeMillis();
 
-                    } else if (FileUtils.isFileNewer(file, last)) {
+                    } else if (newer) {
 
                         /*
                          * This can happen if the file is truncated or overwritten with the exact same length of
@@ -339,8 +341,8 @@ public void run() {
                         reader.seek(position); // cannot be null here
 
                         // Now we can read new lines
-                        last = System.currentTimeMillis();
                         position = readLines(reader);
+                        last = System.currentTimeMillis();
                     }
                 }
                 try {
