From e1fc87d2d57c2d7ee941e651f33b582fb000dd73 Mon Sep 17 00:00:00 2001
From: Nicolas Lalevee <hibou@apache.org>
Date: Sun, 8 Sep 2013 14:48:35 +0000
Subject: [PATCH] IVY-1438:  - fix the parsing of header values with space

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1520874 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                              | 1 +
 .../org/apache/ivy/osgi/core/ManifestHeaderValue.java    | 9 +--------
 .../org/apache/ivy/osgi/core/ManifestHeaderTest.java     | 5 +++++
 3 files changed, 7 insertions(+), 8 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 64d03646a..e0638f90b 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -151,6 +151,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: add support for source bundles from p2 repositories
 - IMPROVEMENT: add support for source URI from OBR repositories
 
+- FIX: ParseException when "Bundle-Description" is present in OSGI MANIFEST.MF (IVY-1438)
 - FIX: NIO FileLocker released locks too early (IVY-1424) (thanks to Charles Duffy)
 - FIX: Ssh Resolver doesn't work with Java 7 (IVY-1408) (thanks to Mykhailo Delegan)
 - FIX: Parsing publication date in Ant tasks not thread-safe (IVY-1412)
diff --git a/src/java/org/apache/ivy/osgi/core/ManifestHeaderValue.java b/src/java/org/apache/ivy/osgi/core/ManifestHeaderValue.java
index 8a002b9b2..157f1d737 100644
--- a/src/java/org/apache/ivy/osgi/core/ManifestHeaderValue.java
+++ b/src/java/org/apache/ivy/osgi/core/ManifestHeaderValue.java
@@ -189,8 +189,6 @@ private void parseElement() throws ParseException {
         private void parseValueOrParameter() throws ParseException {
             // true if the value/parameter parsing has started, white spaces skipped
             boolean start = false;
-            // true if the value/parameter parsing is ended, then only white spaces are allowed
-            boolean end = false;
             do {
                 switch (readNext()) {
                     case '\0':
@@ -210,15 +208,10 @@ private void parseValueOrParameter() throws ParseException {
                     case '\n':
                     case '\r':
                         if (start) {
-                            end = true;
+                            buffer.append(c);
                         }
                         break;
                     default:
-                        if (end) {
-                            error("Expecting the end of a value or of an parameter name");
-                            // try to recover: restart the parsing of the value or parameter
-                            end = false;
-                        }
                         start = true;
                         buffer.append(c);
                 }
diff --git a/test/java/org/apache/ivy/osgi/core/ManifestHeaderTest.java b/test/java/org/apache/ivy/osgi/core/ManifestHeaderTest.java
index 859229923..3aaa8f651 100644
--- a/test/java/org/apache/ivy/osgi/core/ManifestHeaderTest.java
+++ b/test/java/org/apache/ivy/osgi/core/ManifestHeaderTest.java
@@ -112,4 +112,9 @@ private void genericTestSyntaxError(String value) {
             ManifestHeaderValue.writeParseException(System.out, value, e);
         }
     }
+
+    public void testSpaceInValue() throws Exception {
+        ManifestHeaderValue value = new ManifestHeaderValue("glassfish javax.servlet.3.1.0.b33");
+        assertEquals("glassfish javax.servlet.3.1.0.b33", value.getSingleValue());
+    }
 }
