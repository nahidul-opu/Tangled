From 9aea59329362a8100237a0076e1f071237eb76bd Mon Sep 17 00:00:00 2001
From: Bernd Eckenfels <ecki@apache.org>
Date: Sun, 12 Apr 2015 17:44:07 +0000
Subject: [PATCH] [VFS-236][smb] Allow SMB to be used with empty
 authentication.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@1673034 13f79535-47bb-0310-9956-ffa450edef68
---
 .../vfs2/provider/smb/SmbFileObject.java      | 50 +++++++++----------
 src/changes/changes.xml                       |  3 ++
 2 files changed, 28 insertions(+), 25 deletions(-)

diff --git a/sandbox/src/main/java/org/apache/commons/vfs2/provider/smb/SmbFileObject.java b/sandbox/src/main/java/org/apache/commons/vfs2/provider/smb/SmbFileObject.java
index 343d616413..b6d863f1f3 100644
--- a/sandbox/src/main/java/org/apache/commons/vfs2/provider/smb/SmbFileObject.java
+++ b/sandbox/src/main/java/org/apache/commons/vfs2/provider/smb/SmbFileObject.java
@@ -84,43 +84,43 @@ private SmbFile createSmbFile(final FileName fileName)
 
         UserAuthenticationData authData = null;
         SmbFile file;
-        NtlmPasswordAuthentication auth;
         try
         {
             authData = UserAuthenticatorUtils.authenticate(
                            getFileSystem().getFileSystemOptions(),
                            SmbFileProvider.AUTHENTICATOR_TYPES);
 
-            auth = new NtlmPasswordAuthentication(
-                UserAuthenticatorUtils.toString(
-                    UserAuthenticatorUtils.getData(
-                        authData,
-                        UserAuthenticationData.DOMAIN,
-                        UserAuthenticatorUtils.toChar(smbFileName.getDomain()))),
-                UserAuthenticatorUtils.toString(
-                    UserAuthenticatorUtils.getData(
-                        authData,
-                        UserAuthenticationData.USERNAME,
-                        UserAuthenticatorUtils.toChar(smbFileName.getUserName()))),
-                UserAuthenticatorUtils.toString(
-                    UserAuthenticatorUtils.getData(
-                        authData,
-                        UserAuthenticationData.PASSWORD,
-                        UserAuthenticatorUtils.toChar(smbFileName.getPassword()))));
+            NtlmPasswordAuthentication auth = null;
+            if (authData != null)
+            {
+                auth = new NtlmPasswordAuthentication(
+                    UserAuthenticatorUtils.toString(
+                        UserAuthenticatorUtils.getData(authData, UserAuthenticationData.DOMAIN,
+                            UserAuthenticatorUtils.toChar(smbFileName.getDomain()))),
+                    UserAuthenticatorUtils.toString(
+                        UserAuthenticatorUtils.getData(authData, UserAuthenticationData.USERNAME,
+                            UserAuthenticatorUtils.toChar(smbFileName.getUserName()))),
+                    UserAuthenticatorUtils.toString(
+                        UserAuthenticatorUtils.getData(authData, UserAuthenticationData.PASSWORD,
+                            UserAuthenticatorUtils.toChar(smbFileName.getPassword()))));
+            }
 
+            // if auth == null SmbFile uses default credentials
+            // ("jcifs.smb.client.domain", "?"), ("jcifs.smb.client.username", "GUEST"),
+            // ("jcifs.smb.client.password", BLANK);
+            // ANONYMOUS=("","","")
             file = new SmbFile(path, auth);
+
+            if (file.isDirectory() && !file.toString().endsWith("/"))
+            {
+                file = new SmbFile(path + "/", auth);
+            }
+            return file;
         }
         finally
         {
-            UserAuthenticatorUtils.cleanup(authData);
+            UserAuthenticatorUtils.cleanup(authData); // might be null
         }
-
-        if (file.isDirectory() && !file.toString().endsWith("/"))
-        {
-            file = new SmbFile(path + "/", auth);
-        }
-
-        return file;
     }
 
     /**
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index a810d96a47..1981ea88a6 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -26,6 +26,9 @@
 <!--       <action issue="VFS-443" dev="ggregory" type="update" due-to="nickallen"> -->
 <!--        [Local] Need an easy way to convert from a FileObject to a File. -->
 <!--       </action> -->
+      <action issue="VFS-236" dev="ecki" type="fix" due-to="Matt Casters">
+        [smb] Allow SMB to be used with no authentication.
+      </action>
       <action issue="VFS-564" dev="ecki" type="fix" due-to="Dmitry Konstantinov">
         Make some loggers static.
       </action>
