From 9ae37525134089dd0c9ee1cf8738192b70e0fc07 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Mon, 9 Jan 2017 15:26:30 +0100
Subject: [PATCH] SnappyInputStream didn't count bytes read when sliding the
 window

may be related to COMPRESS-358
---
 .../compressors/snappy/SnappyCompressorInputStream.java      | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java b/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java
index 69bf619580f..781ebbf22e8 100644
--- a/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java
+++ b/src/main/java/org/apache/commons/compress/compressors/snappy/SnappyCompressorInputStream.java
@@ -168,6 +168,7 @@ private void fill(final int len) throws IOException {
             case 0x00:
 
                 length = readLiteralLength(b);
+                uncompressedBytesRemaining -= length;
 
                 if (expandLiteral(length)) {
                     return;
@@ -186,6 +187,7 @@ private void fill(final int len) throws IOException {
                  */
 
                 length = 4 + ((b >> 2) & 0x07);
+                uncompressedBytesRemaining -= length;
                 offset = (b & 0xE0) << 3;
                 offset |= readOneByte();
 
@@ -205,6 +207,7 @@ private void fill(final int len) throws IOException {
                  */
 
                 length = (b >> 2) + 1;
+                uncompressedBytesRemaining -= length;
 
                 offset = readOneByte();
                 offset |= readOneByte() << 8;
@@ -224,6 +227,7 @@ private void fill(final int len) throws IOException {
                  */
 
                 length = (b >> 2) + 1;
+                uncompressedBytesRemaining -= length;
 
                 offset = readOneByte();
                 offset |= readOneByte() << 8;
@@ -237,7 +241,6 @@ private void fill(final int len) throws IOException {
             }
 
             readNow -= length;
-            uncompressedBytesRemaining -= length;
         }
     }
 
