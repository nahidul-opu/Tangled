From d9d4d97ef760a0ff5488c04cb88ca21878aeb7b5 Mon Sep 17 00:00:00 2001
From: kturner <kturner@unknown>
Date: Fri, 11 May 2012 14:48:27 +0000
Subject: [PATCH] GORA-130 cleare tablet location cache before computing
 partition queries for accumulo

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1337191 13f79535-47bb-0310-9956-ffa450edef68
---
 .../main/java/org/apache/gora/accumulo/store/AccumuloStore.java | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/gora-accumulo/src/main/java/org/apache/gora/accumulo/store/AccumuloStore.java b/gora-accumulo/src/main/java/org/apache/gora/accumulo/store/AccumuloStore.java
index 7433c669a..65ad1224f 100644
--- a/gora-accumulo/src/main/java/org/apache/gora/accumulo/store/AccumuloStore.java
+++ b/gora-accumulo/src/main/java/org/apache/gora/accumulo/store/AccumuloStore.java
@@ -691,6 +691,7 @@ public List<PartitionQuery<K,T>> getPartitions(Query<K,T> query) throws IOExcept
       
       Map<String,Map<KeyExtent,List<Range>>> binnedRanges = new HashMap<String,Map<KeyExtent,List<Range>>>();
       
+      tl.invalidateCache();
       while (tl.binRanges(Collections.singletonList(createRange(query)), binnedRanges).size() > 0) {
         // TODO log?
         if (!Tables.exists(conn.getInstance(), Tables.getTableId(conn.getInstance(), mapping.tableName)))
@@ -698,6 +699,7 @@ public List<PartitionQuery<K,T>> getPartitions(Query<K,T> query) throws IOExcept
         else if (Tables.getTableState(conn.getInstance(), Tables.getTableId(conn.getInstance(), mapping.tableName)) == TableState.OFFLINE)
           throw new TableOfflineException(conn.getInstance(), Tables.getTableId(conn.getInstance(), mapping.tableName));
         UtilWaitThread.sleep(100);
+        tl.invalidateCache();
       }
       
       List<PartitionQuery<K,T>> ret = new ArrayList<PartitionQuery<K,T>>();
