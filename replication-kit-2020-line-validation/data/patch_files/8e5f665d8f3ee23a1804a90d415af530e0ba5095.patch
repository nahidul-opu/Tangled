From 8e5f665d8f3ee23a1804a90d415af530e0ba5095 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Sun, 13 Apr 2014 08:56:31 +0000
Subject: [PATCH] COMPRESS-274 unnanmed entries cause trouble for
 ChangeSet#delete*

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@1586941 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                     | 4 ++++
 .../java/org/apache/commons/compress/changes/ChangeSet.java | 6 +++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index cb553e504ce..96a0d8951dd 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -67,6 +67,10 @@ The <action> type attribute can be add,update,fix,remove.
         ArjArchiveInputStream#canReadEntryData tested the current
         entry of the stream rather than its argument.
       </action>
+      <action type="fix" date="2014-04-13" issue="COMPRESS-274">
+        ChangeSet#delete and deleteDir now properly deal with unnamed
+        entries.
+      </action>
     </release>
     <release version="1.8" date="2014-03-12"
              description="Release 1.8">
diff --git a/src/main/java/org/apache/commons/compress/changes/ChangeSet.java b/src/main/java/org/apache/commons/compress/changes/ChangeSet.java
index 31155f62742..a9be42d2bbc 100644
--- a/src/main/java/org/apache/commons/compress/changes/ChangeSet.java
+++ b/src/main/java/org/apache/commons/compress/changes/ChangeSet.java
@@ -133,13 +133,17 @@ private void addDeletion(Change pChange) {
         }
         String source = pChange.targetFile();
 
-        if (!changes.isEmpty()) {
+        if (source != null && !changes.isEmpty()) {
             for (Iterator<Change> it = changes.iterator(); it.hasNext();) {
                 Change change = it.next();
                 if (change.type() == Change.TYPE_ADD
                         && change.getEntry() != null) {
                     String target = change.getEntry().getName();
 
+                    if (target == null) {
+                        continue;
+                    }
+
                     if (Change.TYPE_DELETE == pChange.type() && source.equals(target)) {
                         it.remove();
                     } else if (Change.TYPE_DELETE_DIR == pChange.type() && 
