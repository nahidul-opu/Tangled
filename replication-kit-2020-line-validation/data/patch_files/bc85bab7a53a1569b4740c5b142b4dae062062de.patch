From bc85bab7a53a1569b4740c5b142b4dae062062de Mon Sep 17 00:00:00 2001
From: Thomas Neidhart <tn@apache.org>
Date: Thu, 10 Apr 2014 21:55:29 +0000
Subject: [PATCH] [COLLECTIONS-512] Fix equals method for
 TransformingComparator. Thanks to Cyrille Artho.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/collections/trunk@1586477 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                           |  3 +++
 .../comparators/TransformingComparator.java       |  4 ++--
 .../comparators/TransformingComparatorTest.java   | 15 +++++++++++++++
 3 files changed, 20 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index d90ba2bdf4..6673cf8aee 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -22,6 +22,9 @@
   <body>
 
   <release version="4.1" date="TBD" description="">
+    <action issue="COLLECTIONS-512" dev="tn" type="fix" due-to="Cyrille Artho">
+      "TransformingComparator" did not comply with the contract of Object#equals.
+    </action>
     <action issue="COLLECTIONS-510" dev="tn" type="fix" due-to="Hollis Waite">
       Fix compilation errors when using source level 1.8 and a recent java 8 compiler.
     </action>
diff --git a/src/main/java/org/apache/commons/collections4/comparators/TransformingComparator.java b/src/main/java/org/apache/commons/collections4/comparators/TransformingComparator.java
index cb24d43140..51607b1aa7 100644
--- a/src/main/java/org/apache/commons/collections4/comparators/TransformingComparator.java
+++ b/src/main/java/org/apache/commons/collections4/comparators/TransformingComparator.java
@@ -120,8 +120,8 @@ public boolean equals(final Object object) {
         }
         if (object.getClass().equals(this.getClass())) {
             final TransformingComparator<?, ?> comp = (TransformingComparator<?, ?>) object;
-            return null == decorated ? null == comp.decorated : decorated.equals(comp.decorated) &&
-                    null == transformer ? null == comp.transformer : transformer.equals(comp.transformer);
+            return (null == decorated ? null == comp.decorated : decorated.equals(comp.decorated)) &&
+                   (null == transformer ? null == comp.transformer : transformer.equals(comp.transformer));
         }
         return false;
     }
diff --git a/src/test/java/org/apache/commons/collections4/comparators/TransformingComparatorTest.java b/src/test/java/org/apache/commons/collections4/comparators/TransformingComparatorTest.java
index 2ad7b1a025..788bde414d 100644
--- a/src/test/java/org/apache/commons/collections4/comparators/TransformingComparatorTest.java
+++ b/src/test/java/org/apache/commons/collections4/comparators/TransformingComparatorTest.java
@@ -21,6 +21,7 @@
 import java.util.List;
 
 import org.apache.commons.collections4.ComparatorUtils;
+import org.apache.commons.collections4.Transformer;
 import org.apache.commons.collections4.TransformerUtils;
 
 /**
@@ -60,6 +61,20 @@ public List<Integer> getComparableObjectsOrdered() {
         return list;
     }
 
+    public void testEquals() {
+        Transformer<String, String> t1 = TransformerUtils.nopTransformer();
+        TransformingComparator<String, String> comp1 = new TransformingComparator<String, String>(t1);
+        TransformingComparator<String, String> comp2 = new TransformingComparator<String, String>(t1, comp1);
+
+        // Checks the contract: equals-hashcode on comp1 and comp2
+        assertTrue("Contract failed: equals-hashcode",
+                comp1.equals(comp2) ? comp1.hashCode() == comp2.hashCode() : true);
+
+        // Checks the contract: equals-hashcode on comp1 and comp2
+        assertTrue("Contract failed: equals-hashcode",
+                comp2.equals(comp1) ? comp2.hashCode() == comp1.hashCode() : true);
+    }
+
     @Override
     public String getCompatibilityVersion() {
         return "4";
