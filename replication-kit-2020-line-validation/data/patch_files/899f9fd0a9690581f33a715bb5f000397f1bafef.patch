From 899f9fd0a9690581f33a715bb5f000397f1bafef Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 4 Jan 2012 20:41:10 +0000
Subject: [PATCH] FIX: cannot resolve from repositories that return HTTP 204 in
 response to an HTTP HEAD request (IVY-1328)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@1227311 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                             | 1 +
 src/java/org/apache/ivy/util/url/BasicURLHandler.java   | 6 ++++++
 src/java/org/apache/ivy/util/url/HttpClientHandler.java | 7 ++++++-
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 2628eb3be..a66bc352a 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -138,6 +138,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: ivy:retrieve can now convert 'dotted'-organisation names into a directory tree.
 - IMPROVEMENT: ivy:retrieve now accepts a nested mapper type.
 
+- FIX: cannot resolve from repositories that return HTTP 204 in response to an HTTP HEAD request (IVY-1328)
 - FIX: extra attributes lost from info when ivy file is merged with parent (IVY-1206)
 - FIX: ivy:report ant task intermittently "cannot compile stylesheet" (IVY-1325)
 - FIX: Maven 'eclipse-plugin', 'jbi-component' and 'jbi-shared-library' packaging is now mapped to 'jar' extension (IVY-899)
diff --git a/src/java/org/apache/ivy/util/url/BasicURLHandler.java b/src/java/org/apache/ivy/util/url/BasicURLHandler.java
index 39d55fe3a..f0f6b90a7 100644
--- a/src/java/org/apache/ivy/util/url/BasicURLHandler.java
+++ b/src/java/org/apache/ivy/util/url/BasicURLHandler.java
@@ -98,6 +98,12 @@ private boolean checkStatusCode(URL url, HttpURLConnection con) throws IOExcepti
         if (status == HttpStatus.SC_OK) {
             return true;
         }
+        
+        // IVY-1328: some servers return a 204 on a HEAD request
+        if ("HEAD".equals(con.getRequestMethod()) && (status == 204)) {
+            return true;
+        }
+        
         Message.debug("HTTP response status: " + status + " url=" + url);
         if (status == HttpStatus.SC_PROXY_AUTHENTICATION_REQUIRED) {
             Message.warn("Your proxy requires authentication.");
diff --git a/src/java/org/apache/ivy/util/url/HttpClientHandler.java b/src/java/org/apache/ivy/util/url/HttpClientHandler.java
index bab27243f..bc03d7a15 100644
--- a/src/java/org/apache/ivy/util/url/HttpClientHandler.java
+++ b/src/java/org/apache/ivy/util/url/HttpClientHandler.java
@@ -45,7 +45,6 @@
 import org.apache.commons.httpclient.auth.CredentialsProvider;
 import org.apache.commons.httpclient.methods.GetMethod;
 import org.apache.commons.httpclient.methods.HeadMethod;
-import org.apache.commons.httpclient.methods.InputStreamRequestEntity;
 import org.apache.commons.httpclient.methods.PutMethod;
 import org.apache.commons.httpclient.methods.RequestEntity;
 import org.apache.commons.httpclient.params.HttpMethodParams;
@@ -181,6 +180,12 @@ private boolean checkStatusCode(URL url, HttpMethodBase method) throws IOExcepti
         if (status == HttpStatus.SC_OK) {
             return true;
         }
+        
+        // IVY-1328: some servers return a 204 on a HEAD request
+        if ("HEAD".equals(method.getName()) && (status == 204)) {
+            return true;
+        }
+        
         Message.debug("HTTP response status: " + status + " url=" + url);
         if (status == HttpStatus.SC_PROXY_AUTHENTICATION_REQUIRED) {
             Message.warn("Your proxy requires authentication.");
