From 37d1f284aa969393149b625e2ff48a28268093b2 Mon Sep 17 00:00:00 2001
From: Mark Thomas <markt@apache.org>
Date: Tue, 10 Nov 2009 23:01:56 +0000
Subject: [PATCH] Fix DBCP-303. Patch provided by Dave Oxley.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@834702 13f79535-47bb-0310-9956-ffa450edef68
---
 .../dbcp/cpdsadapter/PooledConnectionImpl.java      | 13 ++++++++++---
 xdocs/changes.xml                                   |  4 ++++
 2 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/src/java/org/apache/commons/dbcp/cpdsadapter/PooledConnectionImpl.java b/src/java/org/apache/commons/dbcp/cpdsadapter/PooledConnectionImpl.java
index 3609fc31cd..e57639b3ea 100644
--- a/src/java/org/apache/commons/dbcp/cpdsadapter/PooledConnectionImpl.java
+++ b/src/java/org/apache/commons/dbcp/cpdsadapter/PooledConnectionImpl.java
@@ -410,9 +410,16 @@ public Object makeObject(Object obj) throws Exception {
             PStmtKey key = (PStmtKey)obj;
             if (null == key._resultSetType 
                     && null == key._resultSetConcurrency) {
-                return new PoolablePreparedStatementStub(
-                        connection.prepareStatement(key._sql),
-                        key, pstmtPool, delegatingConnection);
+                if (null == key._autoGeneratedKeys) {
+                    return new PoolablePreparedStatementStub(
+                            connection.prepareStatement(key._sql),
+                            key, pstmtPool, delegatingConnection);
+                } else {
+                    return new PoolablePreparedStatementStub(
+                            connection.prepareStatement(key._sql,
+                                    key._autoGeneratedKeys.intValue()),
+                            key, pstmtPool, delegatingConnection);
+                }
             } else {
                 return new PoolablePreparedStatementStub(
                         connection.prepareStatement(key._sql,
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 8b6d100ed3..fb51240f84 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -42,6 +42,10 @@ The <action> type attribute can be add,update,fix,remove.
      new features as well as bug fixes and instrumentation.  Some bug fixes
      will change semantics (e.g. connection close will become idempotent).
      The minimum JDK level will be increased to 1.4">
+      <action dev="markt" type="fix" issue="DBCP-303" due-to="Dave Oxley">
+        Ensure Statement.getGeneratedKeys() works correctly with the CPDS
+        adapter.
+      </action>
       <action dev="psteitz" type="fix" issue="DBCP-302" due-to="Sebastian Bazley">
         Removed incorrectly advertised ClassNotFoundException from
         JOCLContentHandler.ConstructorDetails.createObject().
