From 01adc7e46683394e583f878ec0d576c5715b16df Mon Sep 17 00:00:00 2001
From: Niall Pemberton <niallp@apache.org>
Date: Thu, 12 Jul 2007 14:25:21 +0000
Subject: [PATCH] BEANUTILS-271 - DateLocaleConverter does not always throw an
 Exception for invalid dates - thanks to Nico Hoogervorst

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/beanutils/trunk@555641 13f79535-47bb-0310-9956-ffa450edef68
---
 .../converters/DateLocaleConverter.java       | 14 ++++++++++++-
 .../DateLocaleConverterTestCase.java          | 21 +++++++++++++++++++
 2 files changed, 34 insertions(+), 1 deletion(-)

diff --git a/src/java/org/apache/commons/beanutils/locale/converters/DateLocaleConverter.java b/src/java/org/apache/commons/beanutils/locale/converters/DateLocaleConverter.java
index f270c5b35..07583316c 100755
--- a/src/java/org/apache/commons/beanutils/locale/converters/DateLocaleConverter.java
+++ b/src/java/org/apache/commons/beanutils/locale/converters/DateLocaleConverter.java
@@ -17,11 +17,13 @@
 
 package org.apache.commons.beanutils.locale.converters;
 
+import org.apache.commons.beanutils.ConversionException;
 import org.apache.commons.beanutils.locale.BaseLocaleConverter;
 import org.apache.commons.logging.LogFactory;
 import org.apache.commons.logging.Log;
 
 import java.text.ParseException;
+import java.text.ParsePosition;
 import java.text.SimpleDateFormat;
 import java.text.DateFormat;
 import java.text.DateFormatSymbols;
@@ -268,7 +270,17 @@ protected Object parse(Object value, String pattern) throws ParseException {
  
 
          // Parse the Date
-         return formatter.parse((String) value);
+        ParsePosition pos = new ParsePosition(0);
+        String strValue = value.toString();
+        Object parsedValue = formatter.parseObject(strValue, pos);
+        if (pos.getErrorIndex() > -1) {
+            throw new ConversionException("Error parsing date '" + value + "' at position="+ pos.getErrorIndex());
+        }
+        if (pos.getIndex() < strValue.length()) {
+            throw new ConversionException("Date '" + value + "' contains unparsed characters from position=" + pos.getIndex());
+        }
+
+        return parsedValue;
      }
    
      /**
diff --git a/src/test/org/apache/commons/beanutils/locale/converters/DateLocaleConverterTestCase.java b/src/test/org/apache/commons/beanutils/locale/converters/DateLocaleConverterTestCase.java
index 4fa1ec9bd..61f7e4ddb 100644
--- a/src/test/org/apache/commons/beanutils/locale/converters/DateLocaleConverterTestCase.java
+++ b/src/test/org/apache/commons/beanutils/locale/converters/DateLocaleConverterTestCase.java
@@ -409,5 +409,26 @@ public void testConstructor_9() {
 
     }
 
+    /**
+     * Test invalid date
+     */
+    public void testInvalidDate() {
+
+        converter = new DateLocaleConverter(defaultLocale);
+
+        try {
+            converter.convert("01/10/2004", "dd-MM-yyyy");
+        } catch (ConversionException e) {
+            assertEquals("Parse Error", "Error parsing date '01/10/2004' at position=2", e.getMessage());
+        }
+
+        try {
+            converter.convert("01-10-2004X", "dd-MM-yyyy");
+        } catch (ConversionException e) {
+            assertEquals("Parse Length", "Date '01-10-2004X' contains unparsed characters from position=10", e.getMessage());
+        }
+
+    }
+
 }
 
