From bf010f26487edbfdfd79588df01fe5c9458ca40b Mon Sep 17 00:00:00 2001
From: Enis Soztutar <enis@apache.org>
Date: Wed, 9 May 2012 20:48:43 +0000
Subject: [PATCH] GORA-127 Result objects are not closed properly from
 GoraRecordReader

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1336389 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                               | 2 ++
 .../java/org/apache/gora/mapreduce/GoraRecordReader.java  | 8 +++++++-
 2 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index e2de51b1b..9f6541fe5 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -10,6 +10,8 @@ Gora Change Log
 
 * GORA-123 Append correct submodule directories to SCM paths in submodule pom's (lewismc)
 
+* GORA-127 Result objects are not closed properly from GoraRecordReader. (enis)
+
 0.2 Release: 20/04/2012
 Jira Release Report: https://issues.apache.org/jira/secure/ReleaseNote.jspa?projectId=12311172&version=12315541
  
diff --git a/gora-core/src/main/java/org/apache/gora/mapreduce/GoraRecordReader.java b/gora-core/src/main/java/org/apache/gora/mapreduce/GoraRecordReader.java
index 01f04d0ea..2ee8c9fdc 100644
--- a/gora-core/src/main/java/org/apache/gora/mapreduce/GoraRecordReader.java
+++ b/gora-core/src/main/java/org/apache/gora/mapreduce/GoraRecordReader.java
@@ -95,6 +95,10 @@ public boolean nextKeyValue() throws IOException, InterruptedException {
           this.query.setLimit(counter.getRecordsMax() + 1);
         }
       }
+      if (this.result != null) {
+        this.result.close();
+      }
+      
       executeQuery();
       
       if (! firstBatch) {
@@ -109,7 +113,9 @@ public boolean nextKeyValue() throws IOException, InterruptedException {
 
   @Override
   public void close() throws IOException {
-    result.close();
+    if (result != null) {
+      result.close();
+    }
   }
 
 }
