From c608c3309b99ec69bfcdd6aaa1ad32851d09e94d Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Sat, 22 Feb 2014 07:00:42 +0000
Subject: [PATCH] COMPRESS-265 tariling backslashes are as bad for PAX headers
 as trailing slashes - on Windows

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@1570800 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                       |  5 +++++
 .../archivers/tar/TarArchiveOutputStream.java | 19 +++++++++++------
 .../tar/TarArchiveOutputStreamTest.java       | 21 +++++++++++++++++++
 3 files changed, 39 insertions(+), 6 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 807f65cf19a..be1c01ab838 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -72,6 +72,11 @@ The <action> type attribute can be add,update,fix,remove.
         bytes of a STORED entry if it was the very first entry of the
         archive.
       </action>
+      <action issue="COMPRESS-265" type="fix" date="2014-02-22">
+        When writing PAX/POSIX headers for TAR entries with
+        backslashes or certain non-ASCII characters in their name
+        TarArchiveOutputStream could fail.
+      </action>
     </release>
     <release version="1.7" date="2014-01-20"
              description="Release 1.7">
diff --git a/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java b/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java
index 8dbc4aaf314..cd7368ae5bd 100644
--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java
+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStream.java
@@ -443,11 +443,6 @@ void writePaxHeaders(String entryName,
         if (name.length() >= TarConstants.NAMELEN) {
             name = name.substring(0, TarConstants.NAMELEN - 1);
         }
-        while (name.endsWith("/")) {
-            // TarEntry's constructor would think this is a directory
-            // and not allow any data to be written
-            name = name.substring(0, name.length() - 1);
-        }
         TarArchiveEntry pex = new TarArchiveEntry(name,
                                                   TarConstants.LF_PAX_EXTENDED_HEADER_LC);
 
@@ -484,13 +479,25 @@ private String stripTo7Bits(String name) {
         StringBuilder result = new StringBuilder(length);
         for (int i = 0; i < length; i++) {
             char stripped = (char) (name.charAt(i) & 0x7F);
-            if (stripped != 0) { // would be read as Trailing null
+            if (shouldBeReplaced(stripped)) {
+                result.append("_");
+            } else {
                 result.append(stripped);
             }
         }
         return result.toString();
     }
 
+    /**
+     * @return true if the character could lead to problems when used
+     * inside a TarArchiveEntry name for a PAX header.
+     */
+    private boolean shouldBeReplaced(char c) {
+        return c == 0 // would be read as Trailing null
+            || c == '/' // when used as last character TAE will consider the PAX header a directory
+            || c == '\\'; // same as '/' as slashes get "normalized" on Windows
+    }
+
     /**
      * Write an EOF (end of archive) record to the tar archive.
      * An EOF record consists of a record of all zeros.
diff --git a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStreamTest.java b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStreamTest.java
index 68a36a96709..2abc319f409 100644
--- a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStreamTest.java
+++ b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveOutputStreamTest.java
@@ -468,6 +468,27 @@ public void testWriteNonAsciiDirectoryNamePosixMode() throws Exception {
         tin.close();
     }
 
+    /**
+     * @see "https://issues.apache.org/jira/browse/COMPRESS-265"
+     */
+    public void testWriteNonAsciiNameWithUnfortunateNamePosixMode() throws Exception {
+        String n = "f\u00f6\u00f6\u00dc";
+        TarArchiveEntry t = new TarArchiveEntry(n);
+        ByteArrayOutputStream bos = new ByteArrayOutputStream();
+        TarArchiveOutputStream tos = new TarArchiveOutputStream(bos);
+        tos.setAddPaxHeadersForNonAsciiNames(true);
+        tos.putArchiveEntry(t);
+        tos.closeArchiveEntry();
+        tos.close();
+        byte[] data = bos.toByteArray();
+        TarArchiveInputStream tin =
+            new TarArchiveInputStream(new ByteArrayInputStream(data));
+        TarArchiveEntry e = tin.getNextTarEntry();
+        assertEquals(n, e.getName());
+        assertFalse(e.isDirectory());
+        tin.close();
+    }
+
     /**
      * @see "https://issues.apache.org/jira/browse/COMPRESS-237"
      */
