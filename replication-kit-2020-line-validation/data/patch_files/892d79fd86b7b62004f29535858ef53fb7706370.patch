From 892d79fd86b7b62004f29535858ef53fb7706370 Mon Sep 17 00:00:00 2001
From: Emmanuel Bourg <ebourg@apache.org>
Date: Sun, 17 Feb 2008 23:18:59 +0000
Subject: [PATCH] CONFIGURATION-300: Fixed the creation of a file based
 configuration if the filename contains a '#'

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/configuration2_experimental@628577 13f79535-47bb-0310-9956-ffa450edef68
---
 .../AbstractFileConfiguration.java            |  2 +-
 .../configuration2/ConfigurationUtils.java    | 10 +++++-----
 .../TestPropertiesConfiguration.java          | 20 +++++++++++++------
 3 files changed, 20 insertions(+), 12 deletions(-)

diff --git a/src/main/java/org/apache/commons/configuration2/AbstractFileConfiguration.java b/src/main/java/org/apache/commons/configuration2/AbstractFileConfiguration.java
index d1f831260f..fd593fec07 100644
--- a/src/main/java/org/apache/commons/configuration2/AbstractFileConfiguration.java
+++ b/src/main/java/org/apache/commons/configuration2/AbstractFileConfiguration.java
@@ -239,7 +239,7 @@ public void load(File file) throws ConfigurationException
     {
         try
         {
-            load(file.toURL());
+            load(file.toURI().toURL());
         }
         catch (ConfigurationException e)
         {
diff --git a/src/main/java/org/apache/commons/configuration2/ConfigurationUtils.java b/src/main/java/org/apache/commons/configuration2/ConfigurationUtils.java
index afc301af43..53036022a0 100644
--- a/src/main/java/org/apache/commons/configuration2/ConfigurationUtils.java
+++ b/src/main/java/org/apache/commons/configuration2/ConfigurationUtils.java
@@ -291,7 +291,7 @@ public static URL getURL(String basePath, String file) throws MalformedURLExcept
         File f = new File(file);
         if (f.isAbsolute()) // already absolute?
         {
-            return f.toURL();
+            return f.toURI().toURL();
         }
 
         try
@@ -308,7 +308,7 @@ public static URL getURL(String basePath, String file) throws MalformedURLExcept
         }
         catch (MalformedURLException uex)
         {
-            return constructFile(basePath, file).toURL();
+            return constructFile(basePath, file).toURI().toURL();
         }
     }
 
@@ -449,7 +449,7 @@ public static URL locate(String base, String name)
             {
                 try
                 {
-                    url = file.toURL();
+                    url = file.toURI().toURL();
                     log.fine("Loading configuration from the absolute path " + name);
                 }
                 catch (MalformedURLException e)
@@ -467,7 +467,7 @@ public static URL locate(String base, String name)
                 File file = constructFile(base, name);
                 if (file != null && file.exists())
                 {
-                    url = file.toURL();
+                    url = file.toURI().toURL();
                 }
 
                 if (url != null)
@@ -489,7 +489,7 @@ public static URL locate(String base, String name)
                 File file = constructFile(System.getProperty("user.home"), name);
                 if (file != null && file.exists())
                 {
-                    url = file.toURL();
+                    url = file.toURI().toURL();
                 }
 
                 if (url != null)
diff --git a/src/test/java/org/apache/commons/configuration2/TestPropertiesConfiguration.java b/src/test/java/org/apache/commons/configuration2/TestPropertiesConfiguration.java
index dbc18591e1..e1283685df 100644
--- a/src/test/java/org/apache/commons/configuration2/TestPropertiesConfiguration.java
+++ b/src/test/java/org/apache/commons/configuration2/TestPropertiesConfiguration.java
@@ -34,12 +34,6 @@
 import java.util.Iterator;
 import java.util.List;
 
-import org.apache.commons.configuration2.BaseConfiguration;
-import org.apache.commons.configuration2.Configuration;
-import org.apache.commons.configuration2.ConfigurationException;
-import org.apache.commons.configuration2.ConfigurationFactory;
-import org.apache.commons.configuration2.PropertiesConfiguration;
-import org.apache.commons.configuration2.PropertiesConfigurationLayout;
 import org.apache.commons.configuration2.reloading.FileChangedReloadingStrategy;
 
 import junit.framework.TestCase;
@@ -745,6 +739,20 @@ public void testSaveToHTTPServerFail() throws Exception
         }
     }
 
+    /**
+     * Test the creation of a file containing a '#' in its name.
+     */
+    public void testFileWithSharpSymbol() throws Exception
+    {
+        File file = new File("target/sharp#1.properties");
+        file.createNewFile();
+
+        PropertiesConfiguration conf = new PropertiesConfiguration(file);
+        conf.save();
+
+        assertTrue("Missing file " + file, file.exists());
+    }
+
     /**
      * Tests initializing a properties configuration from a non existing file.
      * There was a bug, which caused properties getting lost when later save()
