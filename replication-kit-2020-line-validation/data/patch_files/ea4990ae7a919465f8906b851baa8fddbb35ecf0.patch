From ea4990ae7a919465f8906b851baa8fddbb35ecf0 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Wed, 6 Jun 2007 21:37:11 +0000
Subject: [PATCH] FIX: Retrieve Ant task ignores resolveId attribute (IVY-522)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@544965 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 src/java/org/apache/ivy/ant/IvyRetrieve.java  |  3 ++-
 .../org/apache/ivy/ant/IvyRetrieveTest.java   | 22 +++++++++++++++++++
 3 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index cac245022..6347fc59e 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -56,6 +56,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Remove @author tags (thanks to Stephane Bailliez)
 - IMPROVEMENT: Remove use of deprecated elements in ivysettings.xml (IVY-505) (with contribution from Jan Materne)
 
+- FIX: Retrieve Ant task ignores resolveId attribute (IVY-522)
 - FIX: The deprecated "keep" attribute on post resolve tasks causes an error (IVY-517)
 - FIX: Some circular dependencies not retrieved (IVY-400)
 - FIX: ${version} property not recognized in poms (IVY-512)
diff --git a/src/java/org/apache/ivy/ant/IvyRetrieve.java b/src/java/org/apache/ivy/ant/IvyRetrieve.java
index b759be9be..61ea5e9e3 100644
--- a/src/java/org/apache/ivy/ant/IvyRetrieve.java
+++ b/src/java/org/apache/ivy/ant/IvyRetrieve.java
@@ -54,7 +54,8 @@ public void doExecute() throws BuildException {
                 new RetrieveOptions().setConfs(splitConfs(getConf())).setCache(
                     CacheManager.getInstance(getIvyInstance().getSettings(), getCache()))
                         .setDestIvyPattern(_ivypattern).setArtifactFilter(artifactFilter).setSync(
-                            _sync).setUseOrigin(isUseOrigin()).setMakeSymlinks(_symlink));
+                            _sync).setUseOrigin(isUseOrigin()).setMakeSymlinks(_symlink)
+                        .setResolveId(getResolveId()));
             boolean haveTargetsBeenCopied = targetsCopied > 0;
             getProject().setProperty("ivy.nb.targets.copied", String.valueOf(targetsCopied));
             getProject().setProperty("ivy.targets.copied", String.valueOf(haveTargetsBeenCopied));
diff --git a/test/java/org/apache/ivy/ant/IvyRetrieveTest.java b/test/java/org/apache/ivy/ant/IvyRetrieveTest.java
index 452cbca33..45df1bdd0 100644
--- a/test/java/org/apache/ivy/ant/IvyRetrieveTest.java
+++ b/test/java/org/apache/ivy/ant/IvyRetrieveTest.java
@@ -175,6 +175,28 @@ public void testWithAPreviousResolve() throws Exception {
             "mod1.2", "jar", "jar")).exists());
     }
 
+    public void testWithAPreviousResolveAndResolveId() throws Exception {
+        // first we do a resolve in another project
+        Project project = new Project();
+        project.setProperty("ivy.settings.file", "test/repositories/ivysettings.xml");
+        project.setProperty("ivy.dep.file", "test/java/org/apache/ivy/ant/ivy-simple.xml");
+        IvyResolve resolve = new IvyResolve();
+        resolve.setProject(project);
+        resolve.setCache(_cache);
+        resolve.setResolveId("testWithAPreviousResolveAndResolveId");
+        resolve.execute();
+
+        // then we do a retrieve with the correct module information
+        _retrieve.setOrganisation("apache");
+        _retrieve.setModule("resolve-simple");
+        _retrieve.setConf("default");
+        _retrieve.setResolveId("testWithAPreviousResolveAndResolveId");
+        _retrieve.execute();
+
+        assertTrue(new File(IvyPatternHelper.substitute(RETRIEVE_PATTERN, "org1", "mod1.2", "2.0",
+            "mod1.2", "jar", "jar")).exists());
+    }
+
     public void testUseOrigin() throws Exception {
         // test case for IVY-304
         // first we do a resolve with useOrigin=true in another project
