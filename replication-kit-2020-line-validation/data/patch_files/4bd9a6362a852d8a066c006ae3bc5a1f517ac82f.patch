From 4bd9a6362a852d8a066c006ae3bc5a1f517ac82f Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 3 Dec 2009 20:10:23 +0000
Subject: [PATCH] FIX: Use of a shared DocumentBuilder causes SAXException
 during parallel resolutions (IVY-1147)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@886898 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                 |  1 +
 src/java/org/apache/ivy/util/XMLHelper.java | 26 +++++++++------------
 2 files changed, 12 insertions(+), 15 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 0df993fde..2dc10c920 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -100,6 +100,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Trace a message when a property file referenced from the settings doesn't exixts (IVY-1074)
 - IMPROVEMENT: use defaultconf in combination with defaultconfmapping (IVY-1135) (thanks to Jon Schneider)
 
+- FIX: Use of a shared DocumentBuilder causes SAXException during parallel resolutions (IVY-1147)
 - FIX: metadata lock files not always deleted from cache (IVY-1145) (thanks to Jason Trump)
 - FIX: FileSystem resolver with m2compatible=true throws error when publishing modules with dotted organisation names (IVY-968)
 - FIX: ivy:retrieve sync="true" does nothing if first variable is optional (IVY-1142) (thanks to Andreas Axelsson)
diff --git a/src/java/org/apache/ivy/util/XMLHelper.java b/src/java/org/apache/ivy/util/XMLHelper.java
index f16d2176b..e4aacd29b 100644
--- a/src/java/org/apache/ivy/util/XMLHelper.java
+++ b/src/java/org/apache/ivy/util/XMLHelper.java
@@ -51,8 +51,6 @@ public abstract class XMLHelper {
     static final String W3C_XML_SCHEMA = "http://www.w3.org/2001/XMLSchema";
 
     private static boolean canUseSchemaValidation = true;
-
-    private static DocumentBuilder docBuilder;
     
     private static SAXParser newSAXParser(URL schema, InputStream schemaStream)
             throws ParserConfigurationException, SAXException {
@@ -206,19 +204,17 @@ public static Document parseToDom(
     }
 
     public static DocumentBuilder getDocBuilder(EntityResolver entityResolver) {
-        if (docBuilder == null) {
-            try {
-                DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
-                factory.setValidating(false);
-                docBuilder = factory.newDocumentBuilder();
-                if (entityResolver != null) {
-                    docBuilder.setEntityResolver(entityResolver);
-                }
-            } catch (ParserConfigurationException e) {
-                throw new RuntimeException(e);
-            }        
-        }
-        return docBuilder;
+        try {
+            DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
+            factory.setValidating(false);
+            DocumentBuilder docBuilder = factory.newDocumentBuilder();
+            if (entityResolver != null) {
+                docBuilder.setEntityResolver(entityResolver);
+            }
+            return docBuilder;
+        } catch (ParserConfigurationException e) {
+            throw new RuntimeException(e);
+        }        
     }
 
 
