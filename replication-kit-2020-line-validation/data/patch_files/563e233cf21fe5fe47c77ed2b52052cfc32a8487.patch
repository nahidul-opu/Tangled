From 563e233cf21fe5fe47c77ed2b52052cfc32a8487 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 21 Sep 2007 14:42:25 +0000
Subject: [PATCH] FIX: Ivy:retrieve fails through proxy server (IVY-529)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@578149 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../apache/ivy/util/url/IvyAuthenticator.java | 29 ++++++++++++++-----
 2 files changed, 23 insertions(+), 7 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 1228c68b9..99c7c97d2 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -51,6 +51,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 
    version in SVN
 =====================================
+- FIX: Ivy:retrieve fails through proxy server (IVY-529)
 - FIX: java.lang.IllegalArgumentException: Invalid uri when working with version ranges (IVY-390)
 - FIX: Ivy settings include -tag url attribute does not work correctly (IVY-601)
 - FIX: Static revision replacement is not working when a dynamic revision is evicted by a transitive dependency (IVY-603) (with contribution from Matthias Kilian)
diff --git a/src/java/org/apache/ivy/util/url/IvyAuthenticator.java b/src/java/org/apache/ivy/util/url/IvyAuthenticator.java
index 817ef273b..8de88825b 100644
--- a/src/java/org/apache/ivy/util/url/IvyAuthenticator.java
+++ b/src/java/org/apache/ivy/util/url/IvyAuthenticator.java
@@ -47,13 +47,28 @@ private IvyAuthenticator() {
     // Overriding Authenticator *********************************************
 
     protected PasswordAuthentication getPasswordAuthentication() {
-        Credentials c = CredentialsStore.INSTANCE.getCredentials(getRequestingPrompt(),
-            getRequestingHost());
-        Message.debug("authentication: k='"
-                + Credentials.buildKey(getRequestingPrompt(), getRequestingHost()) + "' c='" + c
-                + "'");
-        return c != null ? new PasswordAuthentication(c.getUserName(), c.getPasswd().toCharArray())
-                : null;
+        PasswordAuthentication result = null;
+        
+        String proxyHost = System.getProperty("http.proxyHost");
+        if (getRequestingHost().equals(proxyHost)) {
+            String proxyUser = System.getProperty("http.proxyUser");
+            if ((proxyUser != null) && (proxyUser.trim().length() > 0)) {
+                String proxyPass = System.getProperty("http.proxyPassword", "");
+                Message.debug("authenicating to proxy server with username [" + proxyUser + "]");
+                result = new PasswordAuthentication(proxyUser, proxyPass.toCharArray());
+            }
+        } else {
+            Credentials c = CredentialsStore.INSTANCE.getCredentials(getRequestingPrompt(),
+                getRequestingHost());
+            Message.debug("authentication: k='"
+                    + Credentials.buildKey(getRequestingPrompt(), getRequestingHost()) + "' c='" + c
+                    + "'");
+            if (c != null) {
+                result = new PasswordAuthentication(c.getUserName(), c.getPasswd().toCharArray());
+            }
+        }
+        
+        return result;
     }
 
 }
