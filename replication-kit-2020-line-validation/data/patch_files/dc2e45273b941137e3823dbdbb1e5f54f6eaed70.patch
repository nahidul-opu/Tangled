From dc2e45273b941137e3823dbdbb1e5f54f6eaed70 Mon Sep 17 00:00:00 2001
From: Colm O Heigeartaigh <coheigea@apache.org>
Date: Thu, 20 Sep 2012 09:19:18 +0000
Subject: [PATCH] [SANTUARIO-344] - Explicitly close OctetStreamReal
 InputStream in Reference.calculateDigest

git-svn-id: https://svn.apache.org/repos/asf/santuario/xml-security-java/branches/1.5.x-fixes@1387927 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/xml/security/signature/Reference.java  | 7 ++++++-
 .../apache/xml/security/signature/XMLSignatureInput.java   | 2 +-
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/xml/security/signature/Reference.java b/src/main/java/org/apache/xml/security/signature/Reference.java
index 8e500d130c..2ec7978693 100644
--- a/src/main/java/org/apache/xml/security/signature/Reference.java
+++ b/src/main/java/org/apache/xml/security/signature/Reference.java
@@ -428,7 +428,7 @@ private XMLSignatureInput getContentsAfterTransformation(
             XMLSignatureInput output = null;
 
             if (transforms != null) {
-                output = transforms.performTransforms(input,os);
+                output = transforms.performTransforms(input, os);
                 this.transformsOutput = output;//new XMLSignatureInput(output.getBytes());
 
                 //this.transformsOutput.setSourceURI(output.getSourceURI());
@@ -702,6 +702,11 @@ private byte[] calculateDigest(boolean validating)
                 output.updateOutputStream(os);
             }
             os.flush();
+            
+            if (output.getOctetStreamReal() != null) {
+                output.getOctetStreamReal().close();
+            }
+            
             //this.getReferencedBytes(diOs);
             //mda.update(data);
 
diff --git a/src/main/java/org/apache/xml/security/signature/XMLSignatureInput.java b/src/main/java/org/apache/xml/security/signature/XMLSignatureInput.java
index 0efa18b83d..af2726e436 100644
--- a/src/main/java/org/apache/xml/security/signature/XMLSignatureInput.java
+++ b/src/main/java/org/apache/xml/security/signature/XMLSignatureInput.java
@@ -252,7 +252,7 @@ public InputStream getOctetStream() throws IOException  {
     /**
      * @return real octet stream
      */
-    public InputStream getOctetStreamReal () {
+    public InputStream getOctetStreamReal() {
         return inputOctetStreamProxy;
     }
 
