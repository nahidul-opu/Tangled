From fcff7ed74d0482eb60791adb0b82c2ca00e1de59 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Mon, 13 Oct 2008 21:42:26 +0000
Subject: [PATCH] FIX: Unable to resolve snapshot versions depending on xml
 elements order (IVY-940)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@704265 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                           |  1 +
 .../apache/ivy/plugins/resolver/IBiblioResolver.java  | 11 ++++++-----
 2 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 84af90104..e94f21138 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -102,6 +102,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: Maven2 parser doesn't support POMs with <model> as root (IVY-932)
 - FIX: Default retrieve, publish and deliver patterns doesn't include the [classifier] token (IVY-935)
 - FIX: Can't use latest.release for pom dependencies (IVY-936)
+- FIX: Unable to resolve snapshot versions depending on xml elements order (IVY-940)
 
    2.0.0-rc1
 =====================================
diff --git a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
index 22df985e3..ebbd056fd 100644
--- a/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
+++ b/src/java/org/apache/ivy/plugins/resolver/IBiblioResolver.java
@@ -167,25 +167,26 @@ private String findSnapshotVersion(ModuleRevisionId mrid) {
                 Resource metadata = getRepository().getResource(metadataLocation);
                 if (metadata.exists()) {
                     metadataStream = metadata.openStream();
-                    final StringBuffer snapshotRev = new StringBuffer();
+                    final StringBuffer timestamp = new StringBuffer();
+                    final StringBuffer buildNumer = new StringBuffer();
                     XMLHelper.parse(metadataStream, null, new ContextualSAXHandler() {
                         public void endElement(String uri, String localName, String qName) 
                                 throws SAXException {
                             if ("metadata/versioning/snapshot/timestamp".equals(getContext())) {
-                                snapshotRev.append(getText()).append("-");
+                                timestamp.append(getText());
                             }
                             if ("metadata/versioning/snapshot/buildNumber"
                                     .equals(getContext())) {
-                                snapshotRev.append(getText());
+                                buildNumer.append(getText());
                             }
                             super.endElement(uri, localName, qName);
                         }
                     }, null);
-                    if (snapshotRev.indexOf("-") != -1) {
+                    if (timestamp.length() > 0) {
                         // we have found a timestamp, so this is a snapshot unique version
                         String rev = mrid.getRevision();
                         rev = rev.substring(0, rev.length() - "SNAPSHOT".length());
-                        rev += snapshotRev;
+                        rev = rev + timestamp.toString() + "-" + buildNumer.toString();
                         
                         return rev;
                     }
