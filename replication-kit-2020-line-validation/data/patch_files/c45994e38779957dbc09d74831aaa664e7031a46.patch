From c45994e38779957dbc09d74831aaa664e7031a46 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Wed, 18 Nov 2015 23:26:54 +0000
Subject: [PATCH] VALIDATOR-364 Email Validator does not support quoted/escaped
 character in the local part of the email address

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1715080 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                   | 3 +++
 .../apache/commons/validator/routines/EmailValidator.java | 2 +-
 .../commons/validator/routines/EmailValidatorTest.java    | 8 ++++++++
 3 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index dd1437a26..3237f9706 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -90,6 +90,9 @@ The dependencies for Validator have not changed since the 1.4 release.
 For the current list of dependencies, please see
 http://commons.apache.org/validator/dependencies.html
   ">
+    <action issue="VALIDATOR-364" type="fix" dev="sebb" due-to="teo bran">
+    Email Validator does not support quoted/escaped character in the local part of the email address
+    </action>
     <action issue="VALIDATOR-381" type="fix" dev="ggregory">
     Update commons-collections from 3.2.1 to 3.2.2.
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
index 26f689ec2..abd8d5225 100644
--- a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
+++ b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
@@ -38,7 +38,7 @@ public class EmailValidator implements Serializable {
     private static final long serialVersionUID = 1705927040799295880L;
 
     private static final String SPECIAL_CHARS = "\\p{Cntrl}\\(\\)<>@,;:'\\\\\\\"\\.\\[\\]";
-    private static final String VALID_CHARS = "[^\\s" + SPECIAL_CHARS + "]";
+    private static final String VALID_CHARS = "(\\\\.)|[^\\s" + SPECIAL_CHARS + "]";
     private static final String QUOTED_USER = "(\"[^\"]*\")";
     private static final String WORD = "((" + VALID_CHARS + "|')+|" + QUOTED_USER + ")";
 
diff --git a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
index 8297ad9a3..eb1659333 100644
--- a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
+++ b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
@@ -370,6 +370,14 @@ public void testEmailUserName()  {
         assertTrue(validator.isValid("john56789.john56789.john56789.john56789.john56789.john56789.john@example.com"));
 
         assertFalse(validator.isValid("john56789.john56789.john56789.john56789.john56789.john56789.john5@example.com"));
+
+        assertTrue(validator.isValid("\\>escape\\\\special\\^characters\\<@example.com"));
+
+        assertTrue(validator.isValid("Abc\\@def@example.com"));
+
+        assertFalse(validator.isValid("Abc@def@example.com"));
+
+        assertTrue(validator.isValid("space\\ monkey@example.com"));
     }
 
     /**
