From 474c321dfbf17395ae09889384223f0f74c74057 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 8 Feb 2008 17:17:07 +0000
Subject: [PATCH] FIX: ivy:install task not using validate attribute (IVY-728)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@619946 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/core/install/InstallEngine.java       |  4 +++-
 .../apache/ivy/core/install/InstallTest.java  | 24 +++++++++++++++++++
 .../modfailure/jars/modfailure-1.0.jar        |  1 +
 4 files changed, 29 insertions(+), 1 deletion(-)
 create mode 100644 test/repositories/1/orgfailure/modfailure/jars/modfailure-1.0.jar

diff --git a/CHANGES.txt b/CHANGES.txt
index 0a5a68767..26aef8179 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -78,6 +78,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Downgrade Ant version requirement to 1.6 to build Ivy (IVY-687)
 - IMPROVEMENT: In the ResolveReport class, add the possibility to filter the evicted module while getting the list of DownloadArtifact (IVY-704) (thanks to Nicolas Lalevée)
 
+- FIX: ivy:install task not using validate attribute (IVY-728)
 - FIX: Bad conflict resolution leads to bad "configuration(s) not found" error (IVY-729)
 - FIX: Resolving for muyltiple configurations when one is not in the list of available configurations does not abort the build (IVY-720)
 - FIX: Branch attribute considered as both a standard and extra attribute on module info (IVY-726)
diff --git a/src/java/org/apache/ivy/core/install/InstallEngine.java b/src/java/org/apache/ivy/core/install/InstallEngine.java
index 98a0ec1de..381f44b32 100644
--- a/src/java/org/apache/ivy/core/install/InstallEngine.java
+++ b/src/java/org/apache/ivy/core/install/InstallEngine.java
@@ -126,7 +126,9 @@ public ResolveReport install(ModuleRevisionId mrid, String from, String to, bool
 
             Message.info(":: resolving dependencies ::");
             ResolveOptions options = new ResolveOptions()
-                                .setResolveId(resolveId).setConfs(new String[] {"default"});
+                                .setResolveId(resolveId)
+                                .setConfs(new String[] {"default"})
+                                .setValidate(validate);
             IvyNode[] dependencies = resolveEngine.getDependencies(md, options, report);
             report.setDependencies(Arrays.asList(dependencies), artifactFilter);
 
diff --git a/test/java/org/apache/ivy/core/install/InstallTest.java b/test/java/org/apache/ivy/core/install/InstallTest.java
index 81f60f003..345b94542 100644
--- a/test/java/org/apache/ivy/core/install/InstallTest.java
+++ b/test/java/org/apache/ivy/core/install/InstallTest.java
@@ -41,6 +41,30 @@ public void testSimple() throws Exception {
         assertTrue(new File("build/test/install/org1/mod1.2/mod1.2-2.0.jar").exists());
     }
 
+    public void testValidate() throws Exception {
+        Ivy ivy = Ivy.newInstance();
+        ivy.configure(new File("test/repositories/ivysettings.xml"));
+
+        ivy.install(ModuleRevisionId.newInstance("orgfailure", "modfailure", "1.0"), ivy.getSettings()
+                .getDefaultResolver().getName(), "install", true, true, true, null,
+            PatternMatcher.EXACT);
+
+        assertFalse(new File("build/test/install/orgfailure/modfailure/ivy-1.0.xml").exists());
+        assertFalse(new File("build/test/install/orgfailure/modfailure/modfailure-1.0.jar").exists());
+    }
+
+    public void testNoValidate() throws Exception {
+        Ivy ivy = Ivy.newInstance();
+        ivy.configure(new File("test/repositories/ivysettings.xml"));
+
+        ivy.install(ModuleRevisionId.newInstance("orgfailure", "modfailure", "1.0"), ivy.getSettings()
+                .getDefaultResolver().getName(), "install", true, false, true, null,
+            PatternMatcher.EXACT);
+
+        assertTrue(new File("build/test/install/orgfailure/modfailure/ivy-1.0.xml").exists());
+        assertTrue(new File("build/test/install/orgfailure/modfailure/modfailure-1.0.jar").exists());
+    }
+
     public void testSimpleWithoutDefaultResolver() throws Exception {
         Ivy ivy = Ivy.newInstance();
         ivy.configure(new File("test/repositories/ivysettings-nodefaultresolver.xml"));
diff --git a/test/repositories/1/orgfailure/modfailure/jars/modfailure-1.0.jar b/test/repositories/1/orgfailure/modfailure/jars/modfailure-1.0.jar
new file mode 100644
index 000000000..56f3b36e2
--- /dev/null
+++ b/test/repositories/1/orgfailure/modfailure/jars/modfailure-1.0.jar
@@ -0,0 +1 @@
+ 
