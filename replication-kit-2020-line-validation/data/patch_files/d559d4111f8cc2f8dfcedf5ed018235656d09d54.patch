From d559d4111f8cc2f8dfcedf5ed018235656d09d54 Mon Sep 17 00:00:00 2001
From: Rory Winston <rwinston@apache.org>
Date: Wed, 6 Jun 2007 23:41:10 +0000
Subject: [PATCH] NET-158: Try to handle intermediate return code during
 authentication

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/net/branches/JDK_1_5_BRANCH@544992 13f79535-47bb-0310-9956-ffa450edef68
---
 .../java/org/apache/commons/net/ftp/FTPClient.java    | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/src/main/java/org/apache/commons/net/ftp/FTPClient.java b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
index 66731415e..e0d84d89d 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
@@ -664,7 +664,16 @@ public boolean login(String username, String password) throws IOException
         if (!FTPReply.isPositiveIntermediate(_replyCode))
             return false;
 
-        return FTPReply.isPositiveCompletion(pass(password));
+        int replyCode = pass(password);
+        boolean replyOk = FTPReply.isPositiveCompletion(replyCode);
+        
+        // Work around stupid servers that send a 451 here
+        if (!replyOk && (replyCode == FTPReply.ACTION_ABORTED)) {
+        	replyCode = getReply();
+        	replyOk = FTPReply.isPositiveCompletion(replyCode);
+        }
+        
+        return replyOk;
     }
 
 
