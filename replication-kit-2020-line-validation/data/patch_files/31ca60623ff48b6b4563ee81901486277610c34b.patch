From 31ca60623ff48b6b4563ee81901486277610c34b Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 5 Jan 2012 22:04:17 +0000
Subject: [PATCH] NET-423 FTPClient.storeFIle might fail when
 ControlKeepAliveTimeout is set (ditto for FTPCLient.retrieveFile)

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1227866 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                 | 3 +++
 src/main/java/org/apache/commons/net/ftp/FTPClient.java | 8 ++++----
 2 files changed, 7 insertions(+), 4 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 750eb9b70..63885a2fb 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -59,6 +59,9 @@ The <action> type attribute can be add,update,fix,remove.
         <release version="3.1-SNAPSHOT" date="TBA" description="
 TBA
         ">
+            <action issue="NET-423" dev="sebb" type="fix" due-to="Jens Koch">
+            FTPClient.storeFIle might fail when ControlKeepAliveTimeout is set (ditto for FTPCLient.retrieveFile)
+            </action>
             <action issue="NET-426" dev="sebb" type="add" due-to="Ketan">
             FTPS: Hook to customize _openDataConnection_ SSLSocket before startHandshake() is called
             </action>
diff --git a/src/main/java/org/apache/commons/net/ftp/FTPClient.java b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
index 369ec2910..522da96b4 100644
--- a/src/main/java/org/apache/commons/net/ftp/FTPClient.java
+++ b/src/main/java/org/apache/commons/net/ftp/FTPClient.java
@@ -586,11 +586,11 @@ CopyStreamEvent.UNKNOWN_STREAM_SIZE, __mergeListeners(csl),
 
         output.close(); // ensure the file is fully written
         socket.close(); // done writing the file
-        // Get the transfer response
-        boolean ok = completePendingCommand();
         if (csl != null) {
             csl.cleanUp(); // fetch any outstanding keepalive replies
         }
+        // Get the transfer response
+        boolean ok = completePendingCommand();
         return ok;
     }
 
@@ -1668,11 +1668,11 @@ CopyStreamEvent.UNKNOWN_STREAM_SIZE, __mergeListeners(csl),
             Util.closeQuietly(socket);
         }
 
-        // Get the transfer response
-        boolean ok = completePendingCommand();
         if (csl != null) {
             csl.cleanUp(); // fetch any outstanding keepalive replies
         }
+        // Get the transfer response
+        boolean ok = completePendingCommand();
         return ok;
     }
 
