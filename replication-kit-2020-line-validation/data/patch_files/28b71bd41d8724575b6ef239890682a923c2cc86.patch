From 28b71bd41d8724575b6ef239890682a923c2cc86 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 5 Aug 2008 21:45:49 +0000
Subject: [PATCH] FIX: Maven2 "ejb" packaging is not supported (IVY-873)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@682974 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../parser/m2/PomModuleDescriptorBuilder.java | 12 +++++--
 .../m2/PomModuleDescriptorParserTest.java     | 16 ++++++++++
 .../plugins/parser/m2/test-ejb-packaging.pom  | 32 +++++++++++++++++++
 4 files changed, 59 insertions(+), 2 deletions(-)
 create mode 100644 test/java/org/apache/ivy/plugins/parser/m2/test-ejb-packaging.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index 228b5fd48..d273ea77c 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -101,6 +101,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 - IMPROVEMENT: Check branch consistency during resolve (IVY-858)
 
+- FIX: Maven2 "ejb" packaging is not supported (IVY-873)
 - FIX: Config files with # in path can't be read (IVY-868) (thanks to Simon Steiner)
 - FIX: Cache can't distinguish artifacts with classifiers (IVY-803) (thanks to James P. White)
 - FIX: Reports showing double dependencies in certain cases (IVY-578)
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
index 12d5dea7d..bdd5bf866 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorBuilder.java
@@ -213,7 +213,15 @@ public void setDescription(String description) {
 
 
     public void addArtifact(String artifactId, String packaging) {
-        String ext = packaging;
+        String ext;
+        if ("pom".equals(packaging)) {
+            // no artifact defined!
+            return;
+        } else if ("ejb".equals(packaging)) {
+            ext = "jar";
+        } else {
+            ext = packaging;
+        }
 
         // TODO: we should refactor the following code into something more configurable
 
@@ -231,7 +239,7 @@ public void addArtifact(String artifactId, String packaging) {
         }
 
         ivyModuleDescriptor.addArtifact("master", 
-                new DefaultArtifact(mrid, new Date(), artifactId, ext, ext));
+                new DefaultArtifact(mrid, new Date(), artifactId, packaging, ext));
     }
 
 
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index 39ee025d7..24e6f7e14 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -121,6 +121,22 @@ public void testPackaging() throws Exception {
         assertEquals("war", artifact[0].getType());
     }
 
+    public void testEjbPackaging() throws Exception {
+        ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
+            settings, getClass().getResource("test-ejb-packaging.pom"), false);
+        assertNotNull(md);
+
+        ModuleRevisionId mrid = ModuleRevisionId.newInstance("org.apache", "test", "1.0");
+        assertEquals(mrid, md.getModuleRevisionId());
+
+        Artifact[] artifact = md.getArtifacts("master");
+        assertEquals(1, artifact.length);
+        assertEquals(mrid, artifact[0].getModuleRevisionId());
+        assertEquals("test", artifact[0].getName());
+        assertEquals("jar", artifact[0].getExt());
+        assertEquals("ejb", artifact[0].getType());
+    }
+
     
     public void testParent() throws Exception {
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/test-ejb-packaging.pom b/test/java/org/apache/ivy/plugins/parser/m2/test-ejb-packaging.pom
new file mode 100644
index 000000000..b7187d1ab
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/parser/m2/test-ejb-packaging.pom
@@ -0,0 +1,32 @@
+<?xml version="1.0"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<project>
+  <modelVersion>4.0.0</modelVersion>
+  <groupId>org.apache</groupId>
+  <artifactId>test</artifactId>
+  <packaging>ejb</packaging>
+  <name>Test Module for Ivy M2 parsing</name>
+  <version>1.0</version>
+  <url>http://ivy.jayasoft.org/</url>
+  <organization>
+    <name>Jayasoft</name>
+    <url>http://www.jayasoft.org/</url>
+  </organization>
+</project>
