From 79ff10494b90ba99c339aadb87f6281c97aea966 Mon Sep 17 00:00:00 2001
From: Henri Yandell <bayard@apache.org>
Date: Mon, 3 Nov 2008 22:41:09 +0000
Subject: [PATCH] Applying Nathan Bubna's patch from COLLECTIONS-271 to fix the
 bug introduced in the last patch where getKeys() breaks after a combine() or
 subset() call.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/collections/trunk@710200 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/commons/collections/ExtendedProperties.java   | 3 ++-
 .../commons/collections/TestExtendedProperties.java      | 9 +++++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/src/java/org/apache/commons/collections/ExtendedProperties.java b/src/java/org/apache/commons/collections/ExtendedProperties.java
index c5bda4f32d..35245d58c8 100644
--- a/src/java/org/apache/commons/collections/ExtendedProperties.java
+++ b/src/java/org/apache/commons/collections/ExtendedProperties.java
@@ -820,7 +820,8 @@ public synchronized void save(OutputStream output, String header) throws IOExcep
     public void combine(ExtendedProperties props) {
         for (Iterator it = props.getKeys(); it.hasNext();) {
             String key = (String) it.next();
-            super.put(key, props.get(key));
+            clearProperty(key);
+            addPropertyDirect(key, props.get(key));
         }
     }
     
diff --git a/src/test/org/apache/commons/collections/TestExtendedProperties.java b/src/test/org/apache/commons/collections/TestExtendedProperties.java
index f303463ce9..07f5231b0e 100644
--- a/src/test/org/apache/commons/collections/TestExtendedProperties.java
+++ b/src/test/org/apache/commons/collections/TestExtendedProperties.java
@@ -405,6 +405,15 @@ public void testCollections271() {
         ExtendedProperties props2 = new ExtendedProperties();
         props2.combine(props);
         assertEquals( "\\\\192.168.1.91\\test", props2.getProperty("test") );
+
+        ExtendedProperties props3 = new ExtendedProperties();
+        props3.setProperty("sub.test", "foo");
+        props2.combine(props3);
+        assertEquals("foo", props2.getProperty("sub.test"));
+
+        ExtendedProperties subs = props2.subset("sub");
+        assertNotNull(subs);
+        assertEquals("foo", subs.getProperty("test"));
     }
 
     public void testCollections238() throws IOException {
