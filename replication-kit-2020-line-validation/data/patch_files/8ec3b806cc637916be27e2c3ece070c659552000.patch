From 8ec3b806cc637916be27e2c3ece070c659552000 Mon Sep 17 00:00:00 2001
From: Phil Steitz <psteitz@apache.org>
Date: Sat, 29 Sep 2007 19:07:27 +0000
Subject: [PATCH] Completed fix for DBCP-241.  Guard RTE in delegate toString.
 JIRA: DBCP-241

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/dbcp/trunk@580626 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/dbcp/DelegatingConnection.java    |  8 +++++-
 .../dbcp/TestDelegatingConnection.java        | 25 ++++++++++++++++++-
 2 files changed, 31 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/dbcp/DelegatingConnection.java b/src/java/org/apache/commons/dbcp/DelegatingConnection.java
index 3d183c213a..407e79ffb1 100644
--- a/src/java/org/apache/commons/dbcp/DelegatingConnection.java
+++ b/src/java/org/apache/commons/dbcp/DelegatingConnection.java
@@ -359,8 +359,14 @@ public boolean isClosed() throws SQLException {
     protected void checkOpen() throws SQLException {
         if(_closed) {
             if (null != _conn) {
+                String label = "";
+                try {
+                    label = _conn.toString();
+                } catch (Exception ex) {
+                    // ignore, leave label empty
+                }
                 throw new SQLException
-                    ("Connection " + _conn + " is closed.");
+                    ("Connection " + label + " is closed.");
             } else {
                 throw new SQLException
                     ("Connection is null.");
diff --git a/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java b/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java
index 2ba7ed1c1c..a5fe6ebcad 100644
--- a/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java
+++ b/src/test/org/apache/commons/dbcp/TestDelegatingConnection.java
@@ -125,6 +125,29 @@ public void testCheckOpenNull() throws Exception {
             fail("Expecting SQLException");
         } catch (SQLException ex) {
             assertTrue(ex.getMessage().endsWith("invalid PoolingConnection."));
-        }   
+        }  
+        
+        try {
+            conn = new DelegatingConnection(new RTEGeneratingConnection());
+            conn.close();
+            conn.checkOpen();
+            fail("Expecting SQLException");
+        } catch (SQLException ex) {
+            assertTrue(ex.getMessage().endsWith("is closed."));
+        }
+    }
+    
+    /**
+     * Delegate that will throw RTE on toString
+     * Used to validate fix for DBCP-241
+     */
+    class RTEGeneratingConnection extends TesterConnection {
+        public RTEGeneratingConnection() {
+            super("","");
+        }
+        public String toString() {
+            throw new RuntimeException("bang!");
+        }
+        
     }
 }
