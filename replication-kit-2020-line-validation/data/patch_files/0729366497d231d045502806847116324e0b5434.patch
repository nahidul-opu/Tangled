From 0729366497d231d045502806847116324e0b5434 Mon Sep 17 00:00:00 2001
From: Bernd Eckenfels <ecki@apache.org>
Date: Fri, 18 Sep 2015 15:24:25 +0000
Subject: [PATCH] [VFS-202][http] Allow 405 for HEAD requests.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/vfs/trunk@1703884 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/commons/vfs2/provider/http/HttpFileObject.java   | 3 ++-
 .../vfs2/provider/http/test/HttpProviderTestCase.java       | 6 ++++++
 src/changes/changes.xml                                     | 3 +++
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/core/src/main/java/org/apache/commons/vfs2/provider/http/HttpFileObject.java b/core/src/main/java/org/apache/commons/vfs2/provider/http/HttpFileObject.java
index cfd6f63914..354109e62b 100644
--- a/core/src/main/java/org/apache/commons/vfs2/provider/http/HttpFileObject.java
+++ b/core/src/main/java/org/apache/commons/vfs2/provider/http/HttpFileObject.java
@@ -173,7 +173,8 @@ protected FileType doGetType() throws Exception
     {
         // Use the HEAD method to probe the file.
         final int status = this.getHeadMethod().getStatusCode();
-        if (status == HttpURLConnection.HTTP_OK)
+        if (status == HttpURLConnection.HTTP_OK
+            || status == HttpURLConnection.HTTP_BAD_METHOD /* method is bad, but resource exist */)
         {
             return FileType.FILE;
         }
diff --git a/core/src/test/java/org/apache/commons/vfs2/provider/http/test/HttpProviderTestCase.java b/core/src/test/java/org/apache/commons/vfs2/provider/http/test/HttpProviderTestCase.java
index 469147fdfe..86c810c38c 100644
--- a/core/src/test/java/org/apache/commons/vfs2/provider/http/test/HttpProviderTestCase.java
+++ b/core/src/test/java/org/apache/commons/vfs2/provider/http/test/HttpProviderTestCase.java
@@ -202,6 +202,12 @@ public void testResloveFolderSlashYesRedirectOn() throws FileSystemException
         testResloveFolderSlash(ConnectionUri + "/read-tests/", true);
     }
 
+    public void testHttp405() throws FileSystemException
+    {
+        final FileObject f = VFS.getManager().resolveFile("http://www.w3schools.com/webservices/tempconvert.asmx?action=WSDL");
+        assert f.getContent().getSize() > 0;
+    }
+
 	/** Ensure VFS-453 options are present. */
     public void testHttpTimeoutConfig() throws FileSystemException
     {
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index ef9a0ae945..fe25b8ba04 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -26,6 +26,9 @@
 <!--       <action issue="VFS-443" dev="ggregory" type="update" due-to="nickallen"> -->
 <!--        [Local] Need an easy way to convert from a FileObject to a File. -->
 <!--       </action> -->
+      <action issue="VFS-202" dev="ecki" type="fix" due-to="Sergey Vladimirov, Simon Legner">
+        [http] Allow URLs responding with 405 to HEAD requests.
+      </action>
       <action issue="VFS-490" dev="ecki" type="fix">
         [hdfs] Make OSGi package imports for hdfs resolution=optional.
         Removed all scopes from dependency management.
