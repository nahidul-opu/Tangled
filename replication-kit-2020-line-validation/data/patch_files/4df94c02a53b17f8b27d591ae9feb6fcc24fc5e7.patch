From 4df94c02a53b17f8b27d591ae9feb6fcc24fc5e7 Mon Sep 17 00:00:00 2001
From: Woonsan Ko <woonsan@apache.org>
Date: Fri, 8 Nov 2013 03:53:58 +0000
Subject: [PATCH] SCXML-160: fixing cast exception in case that the state
 machine has nested parallels

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/scxml/trunk@1539916 13f79535-47bb-0310-9956-ffa450edef68
---
 .../semantics/TransitionTargetComparator.java | 21 +++++++++-------
 .../TransitionTargetComparatorTest.java       | 24 +++++++++++++++++++
 2 files changed, 37 insertions(+), 8 deletions(-)

diff --git a/src/main/java/org/apache/commons/scxml2/semantics/TransitionTargetComparator.java b/src/main/java/org/apache/commons/scxml2/semantics/TransitionTargetComparator.java
index 4d2dbe33a..eae4dfcd4 100644
--- a/src/main/java/org/apache/commons/scxml2/semantics/TransitionTargetComparator.java
+++ b/src/main/java/org/apache/commons/scxml2/semantics/TransitionTargetComparator.java
@@ -17,11 +17,11 @@
 package org.apache.commons.scxml2.semantics;
 
 import java.io.Serializable;
+import java.util.Collection;
 import java.util.Comparator;
 
 import org.apache.commons.scxml2.SCXMLHelper;
 import org.apache.commons.scxml2.model.Parallel;
-import org.apache.commons.scxml2.model.State;
 import org.apache.commons.scxml2.model.TransitionTarget;
 
 
@@ -75,7 +75,7 @@ public int compare(final T o1, final T o2) {
                 // - not a requirement
                 // - though useful for an impl to have repeatable behavior
                 // - downside is users may rely on this behavior
-                Parallel lca = (Parallel) SCXMLHelper.getLCA(tt1, tt2);
+                TransitionTarget lca = SCXMLHelper.getLCA(tt1, tt2);
                 TransitionTarget parent1 = tt1;
                 while (parent1.getParent() != lca) {
                     parent1 = parent1.getParent();
@@ -84,12 +84,17 @@ public int compare(final T o1, final T o2) {
                 while (parent2.getParent() != lca) {
                     parent2 = parent2.getParent();
                 }
-                for (TransitionTarget tt : lca.getChildren()) {
-                    State s = (State) tt;
-                    if (s == parent1) {
-                        return 1;
-                    } else if (s == parent2) {
-                        return -1;
+                Collection<TransitionTarget> children = null;
+                if (lca instanceof Parallel) {
+                    children = ((Parallel) lca).getChildren();
+                }
+                if (children != null) {
+                    for (TransitionTarget tt : children) {
+                        if (tt == parent1) {
+                            return 1;
+                        } else if (tt == parent2) {
+                            return -1;
+                        }
                     }
                 }
             }
diff --git a/src/test/java/org/apache/commons/scxml2/semantics/TransitionTargetComparatorTest.java b/src/test/java/org/apache/commons/scxml2/semantics/TransitionTargetComparatorTest.java
index d22424ff6..578206d6d 100644
--- a/src/test/java/org/apache/commons/scxml2/semantics/TransitionTargetComparatorTest.java
+++ b/src/test/java/org/apache/commons/scxml2/semantics/TransitionTargetComparatorTest.java
@@ -108,4 +108,28 @@ public void testComparatorSameParent() {
         
         Assert.assertEquals(1, comparator.compare(target1, target2));
     }
+
+    @Test
+    public void testComparatorSiblingParallels() {
+        Parallel ancestor = new Parallel();
+
+        State target1 = new State();
+        Parallel parent1 = new Parallel();
+        target1.setParent(parent1);
+        parent1.addChild(target1);
+
+        State target2 = new State();
+        Parallel parent2 = new Parallel();
+        target1.setParent(parent2);
+        parent1.addChild(target2);
+
+        parent1.setParent(ancestor);
+        ancestor.addChild(parent1);
+        parent2.setParent(ancestor);
+        ancestor.addChild(parent2);
+
+        Assert.assertEquals(1, comparator.compare(parent1, parent2));
+        Assert.assertEquals(-1, comparator.compare(parent2, parent1));
+    }
+
 }
