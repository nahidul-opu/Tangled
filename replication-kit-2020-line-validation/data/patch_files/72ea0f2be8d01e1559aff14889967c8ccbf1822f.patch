From 72ea0f2be8d01e1559aff14889967c8ccbf1822f Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Wed, 30 Jul 2014 22:28:51 +0000
Subject: [PATCH] NET-549 - Telnet does not convert LF to CRLF in ASCII mode

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1614785 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                            |  3 +++
 .../commons/net/telnet/TelnetOutputStream.java     | 14 +++++++++++---
 2 files changed, 14 insertions(+), 3 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 719371825..b55e7dd01 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -68,6 +68,9 @@ This is mainly a bug-fix release. See further details below.
   IMAPExportMbox (example app) allows IMAP folders to be exported into an mbox file.
   This is the inverse of the IMAPImportMbox example added previously
         ">
+            <action issue="NET-549" type="fix" dev="sebb" due-to="Pradeep Natarajan">
+            Telnet does not convert LF to CRLF in ASCII mode
+            </action>
             <action issue="NET-543" type="fix" dev="sebb" due-to="Ferry Huberts">
             telnet: spy read EOL is reversed
             </action>
diff --git a/src/main/java/org/apache/commons/net/telnet/TelnetOutputStream.java b/src/main/java/org/apache/commons/net/telnet/TelnetOutputStream.java
index 7cffde4c2..2f99f3ee9 100644
--- a/src/main/java/org/apache/commons/net/telnet/TelnetOutputStream.java
+++ b/src/main/java/org/apache/commons/net/telnet/TelnetOutputStream.java
@@ -25,8 +25,9 @@
  * <p>
  * In binary mode, the only conversion is to double IAC.
  * <p>
- * In ASCII mode, if convertCRtoCRLF is true, any CR is converted to CRLF.
+ * In ASCII mode, if convertCRtoCRLF is true (currently always true), any CR is converted to CRLF.
  * IACs are doubled.
+ * Also a bare LF is converted to CRLF and a bare CR is converted to CR\0
  * <p>
  ***/
 
@@ -78,20 +79,27 @@ else if (ch != '\n')
                     }
                 }
 
-                __lastWasCR = false;
-
                 switch (ch)
                 {
                 case '\r':
                     __client._sendByte('\r');
                     __lastWasCR = true;
                     break;
+                case '\n':
+                    if (!__lastWasCR) { // convert LF to CRLF
+                        __client._sendByte('\r');
+                    }
+                    __client._sendByte(ch);
+                    __lastWasCR = false;
+                    break;
                 case TelnetCommand.IAC:
                     __client._sendByte(TelnetCommand.IAC);
                     __client._sendByte(TelnetCommand.IAC);
+                    __lastWasCR = false;
                     break;
                 default:
                     __client._sendByte(ch);
+                    __lastWasCR = false;
                     break;
                 }
             } // end ASCII
