From eec5936b267c80eac7fbf077e88e0eb997f0c335 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Thu, 25 Oct 2007 20:01:31 +0000
Subject: [PATCH] CONFIGURATION-299: Fix for ClassCastExceptions in
 ConstantLookup when resolving non-String variables

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@588329 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/interpol/ConstantLookup.java    |  5 ++---
 .../interpol/TestConstantLookup.java              | 15 +++++++++++++++
 xdocs/changes.xml                                 |  5 +++++
 3 files changed, 22 insertions(+), 3 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/interpol/ConstantLookup.java b/src/java/org/apache/commons/configuration/interpol/ConstantLookup.java
index 2f8eb9b73e..82d1fdfeab 100644
--- a/src/java/org/apache/commons/configuration/interpol/ConstantLookup.java
+++ b/src/java/org/apache/commons/configuration/interpol/ConstantLookup.java
@@ -107,9 +107,8 @@ public String lookup(String var)
                 {
                     // In worst case, the value will be fetched multiple times
                     // because of this lax synchronisation, but for constant
-                    // values
-                    // this shouldn't be a problem.
-                    constantCache.put(var, value);
+                    // values this shouldn't be a problem.
+                    constantCache.put(var, String.valueOf(value));
                 }
                 result = value.toString();
             }
diff --git a/src/test/org/apache/commons/configuration/interpol/TestConstantLookup.java b/src/test/org/apache/commons/configuration/interpol/TestConstantLookup.java
index 26d5bad23e..a3d98cc3c1 100644
--- a/src/test/org/apache/commons/configuration/interpol/TestConstantLookup.java
+++ b/src/test/org/apache/commons/configuration/interpol/TestConstantLookup.java
@@ -16,6 +16,8 @@
  */
 package org.apache.commons.configuration.interpol;
 
+import java.awt.event.KeyEvent;
+
 import junit.framework.TestCase;
 
 /**
@@ -120,4 +122,17 @@ public void testLookupCache()
         testLookupConstant();
         testLookupConstant();
     }
+
+    /**
+     * Tests resolving a non string constant. Then looks the same variable up
+     * from the cache.
+     */
+    public void testLookupNonStringFromCache()
+    {
+        final String var = KeyEvent.class.getName() + ".VK_ESCAPE";
+        final String expected = String.valueOf(KeyEvent.VK_ESCAPE);
+        assertEquals("Wrong result of first lookup", expected, lookup
+                .lookup(var));
+        assertEquals("Wrong result of 2nd lookup", expected, lookup.lookup(var));
+    }
 }
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 1266d92c9f..b046a9dc32 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="1.5-SNAPSHOT" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-299">
+        Resolving of variables with the prefix const (constant fields) caused
+        a ClassCastException under certain circumstances if non-String fields
+        were involved. This has been fixed.
+      </action>
       <action dev="oheger" type="update" due-to="Nicolas De Loof">
         The dependencies to commons-codec and commons-jxpath have been marked
         as optional. They are not required by the core classes.
