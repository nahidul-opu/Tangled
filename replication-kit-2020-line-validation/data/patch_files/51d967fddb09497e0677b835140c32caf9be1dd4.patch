From 51d967fddb09497e0677b835140c32caf9be1dd4 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 12 Jun 2008 22:17:39 +0000
Subject: [PATCH] FIX: NPE in ivy:install if ivy.settings.xml contains custom
 attribute for a module (IVY-838)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@667269 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../ivy/plugins/matcher/MapMatcher.java       |  7 ++++--
 .../core/settings/XmlSettingsParserTest.java  |  8 +++++++
 .../ivysettings-extra-module-attribute.xml    | 24 +++++++++++++++++++
 4 files changed, 38 insertions(+), 2 deletions(-)
 create mode 100644 test/java/org/apache/ivy/core/settings/ivysettings-extra-module-attribute.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 73f4d2852..692fe9c54 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -86,6 +86,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: NPE in ivy:install if ivy.settings.xml contains custom attribute for a module (IVY-838)
 - FIX: Ivy unit tests fail because 'classifier' attribute of 'artifacts' element is missing in ivy.xsd (IVY-837)
 - FIX: Ivy build system: fix build.xml to allow "ant coverage-report" behind a proxy (IVY-832)
 - FIX: NPE in AbstractResolver.exists() if a resource cannot be found (IVY-831)
diff --git a/src/java/org/apache/ivy/plugins/matcher/MapMatcher.java b/src/java/org/apache/ivy/plugins/matcher/MapMatcher.java
index 425ac37c5..a915f3c1b 100644
--- a/src/java/org/apache/ivy/plugins/matcher/MapMatcher.java
+++ b/src/java/org/apache/ivy/plugins/matcher/MapMatcher.java
@@ -45,11 +45,14 @@ public MapMatcher(Map attributes, PatternMatcher pm) {
     public boolean matches(Map/*<String,String>*/ m) {
         for (Iterator iter = matchers.entrySet().iterator(); iter.hasNext();) {
             Entry entry = (Entry) iter.next();
-            if (!((Matcher) entry.getValue())
-                    .matches((String) m.get(entry.getKey()))) {
+            
+            Matcher matcher = (Matcher) entry.getValue();
+            String value = (String) m.get(entry.getKey());
+            if ((value == null) || !matcher.matches(value)) {
                 return false;
             }
         }
+        
         return true;
     }
 
diff --git a/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java b/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java
index 0c6461a09..a7b7605f5 100644
--- a/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java
+++ b/test/java/org/apache/ivy/core/settings/XmlSettingsParserTest.java
@@ -174,6 +174,14 @@ public void testResolveMode() throws Exception {
         assertEquals("dynamic", settings.getResolveMode(new ModuleId("apache", "ivyde")));
         assertEquals("default", settings.getResolveMode(new ModuleId("apache", "ant")));
     }
+    
+    public void testExtraModuleAttribute() throws Exception {
+        IvySettings settings = new IvySettings();
+        XmlSettingsParser parser = new XmlSettingsParser(settings);
+        parser.parse(XmlSettingsParserTest.class.getResource("ivysettings-extra-module-attribute.xml"));
+
+        assertEquals("default", settings.getResolveMode(new ModuleId("foo", "bar")));
+    }
 
     public void testCache() throws Exception {
         IvySettings settings = new IvySettings();
diff --git a/test/java/org/apache/ivy/core/settings/ivysettings-extra-module-attribute.xml b/test/java/org/apache/ivy/core/settings/ivysettings-extra-module-attribute.xml
new file mode 100644
index 000000000..ce3443900
--- /dev/null
+++ b/test/java/org/apache/ivy/core/settings/ivysettings-extra-module-attribute.xml
@@ -0,0 +1,24 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivysettings>
+	<modules>
+		<module organisation="apache" name="ivy" myattr="test.*" matcher="regexp" resolveMode="dynamic" />
+		<module organisation="apache" name=".*" />
+	</modules>
+</ivysettings>
