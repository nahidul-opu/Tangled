From 1d4504253d7e4b836e35620bb99614062d7fb4e1 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Tue, 6 Mar 2007 21:15:00 +0000
Subject: [PATCH] CONFIGURATION-256: MapConfiguration and the web-based
 configurations now treat escaped list delimiters correctly

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/configuration/trunk@515306 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                             |  5 ++
 .../configuration/MapConfiguration.java       |  2 +-
 .../web/AppletConfiguration.java              | 11 +---
 .../web/BaseWebConfiguration.java             | 23 ++++++++
 .../web/ServletConfiguration.java             | 11 +---
 .../web/ServletContextConfiguration.java      | 11 +---
 .../web/ServletFilterConfiguration.java       | 11 +---
 .../web/ServletRequestConfiguration.java      | 23 +++++++-
 .../TestAbstractConfiguration.java            | 14 ++++-
 .../configuration/TestMapConfiguration.java   |  1 +
 .../web/TestAppletConfiguration.java          |  4 +-
 .../web/TestServletConfiguration.java         |  1 +
 .../web/TestServletContextConfiguration.java  |  1 +
 .../web/TestServletFilterConfiguration.java   |  1 +
 .../web/TestServletRequestConfiguration.java  | 57 ++++++++++++++++---
 xdocs/changes.xml                             |  5 ++
 16 files changed, 127 insertions(+), 54 deletions(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index 4245cfe797..3650c73262 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -94,6 +94,11 @@ BUG FIXES IN 1.4
   DatabaseConfiguration now handles list delimiters in property values
   correctly.
 
+* [CONFIGURATION-256]
+  MapConfiguration and the web-based configurations now treat strings that
+  contain an escaped list delimiter correctly: The escape character will be
+  removed, so that for instance "foo\,bar" becomes "foo,bar".
+
 IMPROVEMENTS IN 1.4
 ===================
 * [CONFIGURATION-155]
diff --git a/src/java/org/apache/commons/configuration/MapConfiguration.java b/src/java/org/apache/commons/configuration/MapConfiguration.java
index 888ede1f80..056e8b8db2 100644
--- a/src/java/org/apache/commons/configuration/MapConfiguration.java
+++ b/src/java/org/apache/commons/configuration/MapConfiguration.java
@@ -62,7 +62,7 @@ public Object getProperty(String key)
         if ((value instanceof String) && (!isDelimiterParsingDisabled()))
         {
             List list = PropertyConverter.split((String) value, getListDelimiter());
-            return list.size() > 1 ? list : value;
+            return list.size() > 1 ? list : list.get(0);
         }
         else
         {
diff --git a/src/java/org/apache/commons/configuration/web/AppletConfiguration.java b/src/java/org/apache/commons/configuration/web/AppletConfiguration.java
index e6857be869..0b2b40211b 100644
--- a/src/java/org/apache/commons/configuration/web/AppletConfiguration.java
+++ b/src/java/org/apache/commons/configuration/web/AppletConfiguration.java
@@ -19,10 +19,8 @@
 
 import java.applet.Applet;
 import java.util.Iterator;
-import java.util.List;
 
 import org.apache.commons.collections.iterators.ArrayIterator;
-import org.apache.commons.configuration.PropertyConverter;
 
 /**
  * A configuration wrapper to read applet parameters. This configuration is
@@ -51,14 +49,7 @@ public AppletConfiguration(Applet applet)
 
     public Object getProperty(String key)
     {
-        Object value = applet.getParameter(key);
-        if (!isDelimiterParsingDisabled())
-        {
-            List list = PropertyConverter.split((String) value, getListDelimiter());
-            value = list.size() > 1 ? list : value;
-        }
-
-        return value;
+        return handleDelimiters(applet.getParameter(key));
     }
 
     public Iterator getKeys()
diff --git a/src/java/org/apache/commons/configuration/web/BaseWebConfiguration.java b/src/java/org/apache/commons/configuration/web/BaseWebConfiguration.java
index f0c6db8ddd..6d7c279157 100644
--- a/src/java/org/apache/commons/configuration/web/BaseWebConfiguration.java
+++ b/src/java/org/apache/commons/configuration/web/BaseWebConfiguration.java
@@ -16,7 +16,10 @@
  */
 package org.apache.commons.configuration.web;
 
+import java.util.List;
+
 import org.apache.commons.configuration.AbstractConfiguration;
+import org.apache.commons.configuration.PropertyConverter;
 
 /**
  * <p>
@@ -83,4 +86,24 @@ protected void addPropertyDirect(String key, Object obj)
     {
         throw new UnsupportedOperationException("Read only configuration");
     }
+
+    /**
+     * Takes care of list delimiters in property values. This method checks if
+     * delimiter parsing is enabled and the passed in value contains a delimiter
+     * character. If this is the case, a split operation is performed.
+     *
+     * @param value the property value to be examined
+     * @return the processed value
+     */
+    protected Object handleDelimiters(Object value)
+    {
+        if (!isDelimiterParsingDisabled() && value instanceof String)
+        {
+            List list = PropertyConverter.split((String) value,
+                    getListDelimiter());
+            value = list.size() > 1 ? list : list.get(0);
+        }
+
+        return value;
+    }
 }
diff --git a/src/java/org/apache/commons/configuration/web/ServletConfiguration.java b/src/java/org/apache/commons/configuration/web/ServletConfiguration.java
index 2e7d87577e..7318a0b3e3 100644
--- a/src/java/org/apache/commons/configuration/web/ServletConfiguration.java
+++ b/src/java/org/apache/commons/configuration/web/ServletConfiguration.java
@@ -18,12 +18,10 @@
 package org.apache.commons.configuration.web;
 
 import java.util.Iterator;
-import java.util.List;
 import javax.servlet.Servlet;
 import javax.servlet.ServletConfig;
 
 import org.apache.commons.collections.iterators.EnumerationIterator;
-import org.apache.commons.configuration.PropertyConverter;
 
 /**
  * A configuration wrapper around a {@link ServletConfig}. This configuration
@@ -62,14 +60,7 @@ public ServletConfiguration(ServletConfig config)
 
     public Object getProperty(String key)
     {
-        Object value = config.getInitParameter(key);
-        if (!isDelimiterParsingDisabled())
-        {
-            List list = PropertyConverter.split((String) value, getListDelimiter());
-            value = list.size() > 1 ? list : value;
-        }
-
-        return value;
+        return handleDelimiters(config.getInitParameter(key));
     }
 
     public Iterator getKeys()
diff --git a/src/java/org/apache/commons/configuration/web/ServletContextConfiguration.java b/src/java/org/apache/commons/configuration/web/ServletContextConfiguration.java
index 4cf25864cf..44224564d0 100644
--- a/src/java/org/apache/commons/configuration/web/ServletContextConfiguration.java
+++ b/src/java/org/apache/commons/configuration/web/ServletContextConfiguration.java
@@ -18,12 +18,10 @@
 package org.apache.commons.configuration.web;
 
 import java.util.Iterator;
-import java.util.List;
 import javax.servlet.Servlet;
 import javax.servlet.ServletContext;
 
 import org.apache.commons.collections.iterators.EnumerationIterator;
-import org.apache.commons.configuration.PropertyConverter;
 
 /**
  * A configuration wrapper to read the initialization parameters of a servlet
@@ -63,14 +61,7 @@ public ServletContextConfiguration(ServletContext context)
 
     public Object getProperty(String key)
     {
-        Object value = context.getInitParameter(key);
-        if (!isDelimiterParsingDisabled())
-        {
-            List list = PropertyConverter.split((String) value, getListDelimiter());
-            value = list.size() > 1 ? list : value;
-        }
-
-        return value;
+        return handleDelimiters(context.getInitParameter(key));
     }
 
     public Iterator getKeys()
diff --git a/src/java/org/apache/commons/configuration/web/ServletFilterConfiguration.java b/src/java/org/apache/commons/configuration/web/ServletFilterConfiguration.java
index 95ea866034..0acbffcb12 100644
--- a/src/java/org/apache/commons/configuration/web/ServletFilterConfiguration.java
+++ b/src/java/org/apache/commons/configuration/web/ServletFilterConfiguration.java
@@ -18,11 +18,9 @@
 package org.apache.commons.configuration.web;
 
 import java.util.Iterator;
-import java.util.List;
 import javax.servlet.FilterConfig;
 
 import org.apache.commons.collections.iterators.EnumerationIterator;
-import org.apache.commons.configuration.PropertyConverter;
 
 /**
  * A configuration wrapper around a {@link FilterConfig}. This configuration is
@@ -50,14 +48,7 @@ public ServletFilterConfiguration(FilterConfig config)
 
     public Object getProperty(String key)
     {
-        Object value = config.getInitParameter(key);
-        if (!isDelimiterParsingDisabled())
-        {
-            List list = PropertyConverter.split((String) value, getListDelimiter());
-            value = list.size() > 1 ? list : value;
-        }
-
-        return value;
+        return handleDelimiters(config.getInitParameter(key));
     }
 
     public Iterator getKeys()
diff --git a/src/java/org/apache/commons/configuration/web/ServletRequestConfiguration.java b/src/java/org/apache/commons/configuration/web/ServletRequestConfiguration.java
index 251b3f580f..49d581e8e1 100644
--- a/src/java/org/apache/commons/configuration/web/ServletRequestConfiguration.java
+++ b/src/java/org/apache/commons/configuration/web/ServletRequestConfiguration.java
@@ -17,8 +17,11 @@
 
 package org.apache.commons.configuration.web;
 
+import java.util.ArrayList;
+import java.util.Collection;
 import java.util.Iterator;
-import java.util.Arrays;
+import java.util.List;
+
 import javax.servlet.ServletRequest;
 
 import org.apache.commons.collections.iterators.EnumerationIterator;
@@ -57,11 +60,25 @@ public Object getProperty(String key)
         }
         else if (values.length == 1)
         {
-            return values[0];
+            return handleDelimiters(values[0]);
         }
         else
         {
-            return Arrays.asList(values);
+            // ensure that escape characters in all list elements are removed
+            List result = new ArrayList(values.length);
+            for (int i = 0; i < values.length; i++)
+            {
+                Object val = handleDelimiters(values[i]);
+                if (val instanceof Collection)
+                {
+                    result.addAll((Collection) val);
+                }
+                else
+                {
+                    result.add(val);
+                }
+            }
+            return result;
         }
     }
 
diff --git a/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java b/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java
index e11f9f99c3..de78cec7fe 100644
--- a/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java
@@ -36,11 +36,12 @@
 public abstract class TestAbstractConfiguration extends TestCase
 {
     /**
-     * Return an abstract configuration with 2 key/value pairs:<br>
+     * Return an abstract configuration with the following data:<br>
      * <pre>
      * key1 = value1
      * key2 = value2
      * list = value1, value2
+     * listesc = value1\\,value2
      * </pre>
      */
     protected abstract AbstractConfiguration getConfiguration();
@@ -69,6 +70,16 @@ public void testList()
         assertTrue("'value2' is not in the list", list.contains("value2"));
     }
 
+    /**
+     * Tests whether the escape character for list delimiters is recocknized and
+     * removed.
+     */
+    public void testListEscaped()
+    {
+        assertEquals("Wrong value for escaped list", "value1,value2",
+                getConfiguration().getString("listesc"));
+    }
+
     public void testAddPropertyDirect()
     {
         AbstractConfiguration config = getConfiguration();
@@ -118,6 +129,7 @@ public void testGetKeys()
         expectedKeys.add("key1");
         expectedKeys.add("key2");
         expectedKeys.add("list");
+        expectedKeys.add("listesc");
 
         assertNotNull("null iterator", keys);
         assertTrue("empty iterator", keys.hasNext());
diff --git a/src/test/org/apache/commons/configuration/TestMapConfiguration.java b/src/test/org/apache/commons/configuration/TestMapConfiguration.java
index a66ddab41d..946a1a6bd6 100644
--- a/src/test/org/apache/commons/configuration/TestMapConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestMapConfiguration.java
@@ -37,6 +37,7 @@ protected AbstractConfiguration getConfiguration()
         map.put("key1", "value1");
         map.put("key2", "value2");
         map.put("list", "value1, value2");
+        map.put("listesc", "value1\\,value2");
 
         return new MapConfiguration(map);
     }
diff --git a/src/test/org/apache/commons/configuration/web/TestAppletConfiguration.java b/src/test/org/apache/commons/configuration/web/TestAppletConfiguration.java
index f2a2cf21a7..439528d46a 100644
--- a/src/test/org/apache/commons/configuration/web/TestAppletConfiguration.java
+++ b/src/test/org/apache/commons/configuration/web/TestAppletConfiguration.java
@@ -64,6 +64,7 @@ protected AbstractConfiguration getConfiguration()
         parameters.setProperty("key1", "value1");
         parameters.setProperty("key2", "value2");
         parameters.setProperty("list", "value1, value2");
+        parameters.setProperty("listesc", "value1\\,value2");
 
         if (supportsApplet)
         {
@@ -80,7 +81,8 @@ public String[][] getParameterInfo()
                     {
                     { "key1", "String", "" },
                     { "key2", "String", "" },
-                    { "list", "String[]", "" } };
+                    { "list", "String[]", "" },
+                    { "listesc", "String", "" } };
                 }
             };
 
diff --git a/src/test/org/apache/commons/configuration/web/TestServletConfiguration.java b/src/test/org/apache/commons/configuration/web/TestServletConfiguration.java
index af8c215606..9ebc4200d6 100644
--- a/src/test/org/apache/commons/configuration/web/TestServletConfiguration.java
+++ b/src/test/org/apache/commons/configuration/web/TestServletConfiguration.java
@@ -39,6 +39,7 @@ protected AbstractConfiguration getConfiguration()
         config.setInitParameter("key1", "value1");
         config.setInitParameter("key2", "value2");
         config.setInitParameter("list", "value1, value2");
+        config.setInitParameter("listesc", "value1\\,value2");
 
         Servlet servlet = new HttpServlet() {
             public ServletConfig getServletConfig()
diff --git a/src/test/org/apache/commons/configuration/web/TestServletContextConfiguration.java b/src/test/org/apache/commons/configuration/web/TestServletContextConfiguration.java
index b3ac2d2705..f87b16ead9 100644
--- a/src/test/org/apache/commons/configuration/web/TestServletContextConfiguration.java
+++ b/src/test/org/apache/commons/configuration/web/TestServletContextConfiguration.java
@@ -43,6 +43,7 @@ protected AbstractConfiguration getConfiguration()
         parameters.setProperty("key1", "value1");
         parameters.setProperty("key2", "value2");
         parameters.setProperty("list", "value1, value2");
+        parameters.setProperty("listesc", "value1\\,value2");
 
         // create a servlet context
         ServletContext context = new MockServletContext()
diff --git a/src/test/org/apache/commons/configuration/web/TestServletFilterConfiguration.java b/src/test/org/apache/commons/configuration/web/TestServletFilterConfiguration.java
index 5bd0c8fedb..f66ef2e24b 100644
--- a/src/test/org/apache/commons/configuration/web/TestServletFilterConfiguration.java
+++ b/src/test/org/apache/commons/configuration/web/TestServletFilterConfiguration.java
@@ -39,6 +39,7 @@ protected AbstractConfiguration getConfiguration()
         config.setInitParameter("key1", "value1");
         config.setInitParameter("key2", "value2");
         config.setInitParameter("list", "value1, value2");
+        config.setInitParameter("listesc", "value1\\,value2");
 
         return new ServletFilterConfiguration(config);
     }
diff --git a/src/test/org/apache/commons/configuration/web/TestServletRequestConfiguration.java b/src/test/org/apache/commons/configuration/web/TestServletRequestConfiguration.java
index 3b09fc0cb5..f3f8c3f29b 100644
--- a/src/test/org/apache/commons/configuration/web/TestServletRequestConfiguration.java
+++ b/src/test/org/apache/commons/configuration/web/TestServletRequestConfiguration.java
@@ -18,6 +18,8 @@
 package org.apache.commons.configuration.web;
 
 import java.util.Enumeration;
+import java.util.List;
+
 import javax.servlet.ServletRequest;
 
 import com.mockobjects.servlet.MockHttpServletRequest;
@@ -26,6 +28,7 @@
 import org.apache.commons.configuration.BaseConfiguration;
 import org.apache.commons.configuration.Configuration;
 import org.apache.commons.configuration.TestAbstractConfiguration;
+import org.apache.commons.lang.StringUtils;
 
 /**
  * Test case for the {@link ServletRequestConfiguration} class.
@@ -38,16 +41,25 @@ public class TestServletRequestConfiguration extends TestAbstractConfiguration
     protected AbstractConfiguration getConfiguration()
     {
         final Configuration configuration = new BaseConfiguration();
+        ((BaseConfiguration) configuration).setListDelimiter('\0');
         configuration.setProperty("key1", "value1");
         configuration.setProperty("key2", "value2");
         configuration.addProperty("list", "value1");
         configuration.addProperty("list", "value2");
+        configuration.addProperty("listesc", "value1\\,value2");
+
+        return createConfiguration(configuration);
+    }
+
+    protected AbstractConfiguration getEmptyConfiguration()
+    {
+        final Configuration configuration = new BaseConfiguration();
 
         ServletRequest request = new MockHttpServletRequest()
         {
-            public String[] getParameterValues(String key)
+            public String getParameter(String key)
             {
-                return configuration.getStringArray(key);
+                return null;
             }
 
             public Enumeration getParameterNames()
@@ -59,20 +71,26 @@ public Enumeration getParameterNames()
         return new ServletRequestConfiguration(request);
     }
 
-    protected AbstractConfiguration getEmptyConfiguration()
+    /**
+     * Returns a new servlet request configuration that is backed by the passed
+     * in configuration.
+     *
+     * @param base the configuration with the underlying values
+     * @return the servlet request configuration
+     */
+    private ServletRequestConfiguration createConfiguration(
+            final Configuration base)
     {
-        final Configuration configuration = new BaseConfiguration();
-
         ServletRequest request = new MockHttpServletRequest()
         {
-            public String getParameter(String key)
+            public String[] getParameterValues(String key)
             {
-                return null;
+                return base.getStringArray(key);
             }
 
             public Enumeration getParameterNames()
             {
-                return new IteratorEnumeration(configuration.getKeys());
+                return new IteratorEnumeration(base.getKeys());
             }
         };
 
@@ -105,4 +123,27 @@ public void testClearProperty()
         }
     }
 
+    /**
+     * Tests a list with elements that contain an escaped list delimiter.
+     */
+    public void testListWithEscapedElements()
+    {
+        String[] values =
+        { "test1", "test2\\,test3", "test4\\,test5" };
+        final String listKey = "test.list";
+        BaseConfiguration config = new BaseConfiguration();
+        config.setListDelimiter('\0');
+        config.addProperty(listKey, values);
+        assertEquals("Wrong number of list elements", values.length, config
+                .getList(listKey).size());
+        Configuration c = createConfiguration(config);
+        List v = c.getList(listKey);
+        assertEquals("Wrong number of elements in list", values.length, v
+                .size());
+        for (int i = 0; i < values.length; i++)
+        {
+            assertEquals("Wrong value at index " + i, StringUtils.replace(
+                    values[i], "\\", StringUtils.EMPTY), v.get(i));
+        }
+    }
 }
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 5368042ee9..c561e39c23 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="1.4-SNAPSHOT" date="in SVN">
+      <action dev="oheger" type="update" issue="CONFIGURATION-256">
+        MapConfiguration and the web-based configurations now treat strings
+        that contain an escaped list delimiter correctly: The escape character
+        will be removed, so that for instance "foo\,bar" becomes "foo,bar".
+      </action>
       <action dev="oheger" type="update" issue="CONFIGURATION-255">
         DatabaseConfiguration now handles list delimiters in property values
         correctly.
