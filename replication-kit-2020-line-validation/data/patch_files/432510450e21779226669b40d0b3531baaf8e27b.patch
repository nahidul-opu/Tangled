From 432510450e21779226669b40d0b3531baaf8e27b Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 30 Aug 2011 14:48:15 +0000
Subject: [PATCH] NET-421 Problem connecting to TLS/SSL SMTP server using
 explicit mode

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1163241 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                  | 3 +++
 src/main/java/org/apache/commons/net/smtp/SMTP.java      | 2 +-
 .../java/org/apache/commons/net/smtp/SMTPSClient.java    | 9 +++++++++
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 0925da624..4051ee1b1 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -59,6 +59,9 @@ The <action> type attribute can be add,update,fix,remove.
         <release version="3.0.2-SNAPSHOT" date="TBA" description="
 TBA
         ">
+            <action issue="NET-421" dev="sebb" type="fix" due-to="Oliver Saggau">
+            Problem connecting to TLS/SSL SMTP server using explicit mode.
+            </action>
             <action issue="NET-415" dev="sebb" type="fix">
             typo in migration how-to.
             </action>
diff --git a/src/main/java/org/apache/commons/net/smtp/SMTP.java b/src/main/java/org/apache/commons/net/smtp/SMTP.java
index af2c6ec2c..5d4e111d8 100644
--- a/src/main/java/org/apache/commons/net/smtp/SMTP.java
+++ b/src/main/java/org/apache/commons/net/smtp/SMTP.java
@@ -93,7 +93,7 @@ public class SMTP extends SocketClient
     private static final String __DEFAULT_ENCODING = "ISO-8859-1";
 
     /** The encoding to use (user-settable) */
-    private final String encoding;
+    protected final String encoding;
 
     /**
      * A ProtocolCommandSupport object used to manage the registering of
diff --git a/src/main/java/org/apache/commons/net/smtp/SMTPSClient.java b/src/main/java/org/apache/commons/net/smtp/SMTPSClient.java
index 3da02026c..c9ddcac84 100644
--- a/src/main/java/org/apache/commons/net/smtp/SMTPSClient.java
+++ b/src/main/java/org/apache/commons/net/smtp/SMTPSClient.java
@@ -17,7 +17,10 @@
 
 package org.apache.commons.net.smtp;
 
+import java.io.BufferedWriter;
 import java.io.IOException;
+import java.io.InputStreamReader;
+import java.io.OutputStreamWriter;
 import java.net.Socket;
 import javax.net.ssl.KeyManager;
 import javax.net.ssl.SSLContext;
@@ -26,6 +29,7 @@
 import javax.net.ssl.SSLSocketFactory;
 import javax.net.ssl.TrustManager;
 
+import org.apache.commons.net.io.CRLFLineReader;
 import org.apache.commons.net.util.SSLContextUtils;
 
 /**
@@ -178,6 +182,11 @@ private void performSSLNegotiation() throws IOException
         _socket_ = socket;
         _input_ = socket.getInputStream();
         _output_ = socket.getOutputStream();
+        _reader = new CRLFLineReader(
+                        new InputStreamReader(_input_, encoding));
+        _writer = new BufferedWriter(
+                        new OutputStreamWriter(_output_, encoding));
+
     }
 
     /**
