From ab456436d20f386641e605c17de24cc8cd3c1770 Mon Sep 17 00:00:00 2001
From: Jukka Zitting <jukka@apache.org>
Date: Sun, 5 Aug 2012 19:51:15 +0000
Subject: [PATCH] COMPRESS-197: Tar file for Android backup cannot be read

Allow more than one or two NUL or space characters at the end of a field

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@1369655 13f79535-47bb-0310-9956-ffa450edef68
---
 .../compress/archivers/tar/TarUtils.java      |   7 ++---
 .../tar/TarArchiveInputStreamTest.java        |  24 +++++++++++++++++-
 src/test/resources/COMPRESS-197.tar           | Bin 0 -> 5120 bytes
 3 files changed, 27 insertions(+), 4 deletions(-)
 create mode 100644 src/test/resources/COMPRESS-197.tar

diff --git a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
index 4940d1d5a10..0a3833679d0 100644
--- a/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
+++ b/src/main/java/org/apache/commons/compress/archivers/tar/TarUtils.java
@@ -130,10 +130,11 @@ public static long parseOctal(final byte[] buffer, final int offset, final int l
             throw new IllegalArgumentException(
                     exceptionMessage(buffer, offset, length, end-1, trailer));
         }
-        // May have additional NUL or space
-        trailer = buffer[end-1];
-        if (trailer == 0 || trailer == ' '){
+        // May have additional NULs or spaces
+        trailer = buffer[end - 1];
+        while (start < end - 1 && (trailer == 0 || trailer == ' ')) {
             end--;
+            trailer = buffer[end - 1];
         }
 
         for ( ;start < end; start++) {
diff --git a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java
index 680cb8cf738..d76360f6cf0 100644
--- a/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java
+++ b/src/test/java/org/apache/commons/compress/archivers/tar/TarArchiveInputStreamTest.java
@@ -20,10 +20,12 @@
 
 import static org.junit.Assert.assertEquals;
 import static org.junit.Assert.assertTrue;
+import static org.junit.Assert.fail;
 
 import java.io.ByteArrayInputStream;
 import java.io.File;
 import java.io.FileInputStream;
+import java.io.IOException;
 import java.net.URI;
 import java.net.URL;
 import java.util.Calendar;
@@ -120,4 +122,24 @@ private void datePriorToEpoch(String archive) throws Exception {
         }
     }
 
-}
\ No newline at end of file
+    @Test
+    public void testCompress197() throws Exception {
+        TarArchiveInputStream tar = getTestStream("/COMPRESS-197.tar");
+        try {
+            TarArchiveEntry entry = tar.getNextTarEntry();
+            while (entry != null) {
+                entry = tar.getNextTarEntry();
+            }
+        } catch (IOException e) {
+            fail("COMPRESS-197: " + e.getMessage());
+        } finally {
+            tar.close();
+        }
+    }
+
+    private TarArchiveInputStream getTestStream(String name) {
+        return new TarArchiveInputStream(
+                TarArchiveInputStreamTest.class.getResourceAsStream(name));
+    }
+
+}
diff --git a/src/test/resources/COMPRESS-197.tar b/src/test/resources/COMPRESS-197.tar
new file mode 100644
index 0000000000000000000000000000000000000000..2f42ee047e219551da273586342380835e611b79
GIT binary patch
literal 5120
zcmeHK%T8QJ5M|9*jM%UW)T3V|8C%L1WS6B?UEOVvU_gN5<nMFt*hWcYTef6pWA0_9
z@1-8yT~+5)kKf%rocn&<-(HRL*EhbuTJz!Y=(}D-RETy*#5EH<KaCLJN|MqM3zRh1
zstP${Jlbu#Km2<8@aXqP^uNsY!#DHo6Y%ke<R5d{{*LLGkCmEGN_rSox)Ui0F+M^@
z)JBn!Yid5bmC=-FAjKx$N@}gFig(7Hal^DGW$Mr}Xlc%rs4zU{oK=}I5A&0xLE=dZ
zmnc>WoJpB@VrUj<!uErY3eAxQG;*0W!NSTE$_3+ANz4iQ@}%$3@2QrByTW_MCSg%j
zCUmh*noqhNx-~JR3G**_#2)^mqo2?ro{Zf?1fiOW!u{dK+Eub2qzVb%4qE?`{#>y_
zl_5Q!t)8uZP(GU$>Ir&>r$%xZnW!%+qgw8@8W*SJrKBj~C6m`dGZ7=%7PgA7(YaYR
zL4xY)G$pt0HS<at+3r0<mMW5$2VAZ^3*>ofie9L+In+l~*NHl-hJuJ}xnZ7JN?@Ye
z1jVxYEKAmG6=t=MY-6&Q&afGxEiHNP9Cn#ZBM*3vMXq@$iZ?5z?$c-qwQQ=s3e5<y
zRij1CisiK0M$h=}X%!wWimLAbO4rsV_pJ!K3L=m-s6yB007xuHfw$rwEN<|}%!>wN
z>(a=hhzDs0)FP_NvYArq0dQ&Ku#OES=T=?n_S~al<$V*!GO=XcqXO8oscH^Nm5@Cu
z(X$oB{6%;|(HoLCM-z)K(R;9wC0fdr=gbTHSrQHA84EYATD4S}1*>Yk_bOcNz)9*@
z*#MsKz461wMBo^VlK^0RQb?U(hZZIEt+`~j%s%o;qvh!Akz!%bn-52>-`fik(b(qp
zU+WFb^R<2e^5!6#p9#&t<fl7Be2gc;n+VknAfq>|^;z5>y2c0GqjofGSg<c{Od+$c
zUbki<>Wzh^wFYKj^r;3A3<rr<_ueM8MO)Tajylq0DHWx^nkA?@0r$g)xi2)P(o)m8
zl1*SHG1`g>z%Ri|#tfh-Z-t~4jV$+sa&^yvt~0Vr-yHE6L1t=oR3HU#1sK3A0_Z2I
zs{xui2$VHtf_zY9!mE!C@-T}vS+}BgbdUt}%v!Lvk=j@;1w_=<04E1FMyWPUr>7W^
zmewRgz@w<@o>ys}hgg*kcCpzEY%roHO`>3p;KJT=t_w^yl2>a<CM?n4JR&r6LsyTc
zeb~Ze@UxjUFdcvo7=x730*Y+L;=nn;9n1(O@6(+cpbUxu15^XamZqyO0UjEa>|u_0
ztqOk3vJiM$VC!uK01P&)!%V7#!4jARwRAoH_EXKX#n(o_|9SquKY!=f*LQw5?_Xc-
z*X`M#H`ib5=nHzt@|Vv405U(F|BEJ^|F<*V^ZEY^A^mQm7q5`x-5>M*;p%pOamr_O
zx|{pB9asA|7pHF@*DvjKho4CM;n%nOd2#yJd^p{`dU^cf-QDip)p)$TIN_A&WOq5Q
z-dsN74d;lH-QI8J#mUJoZg1{jw}$|aXCHoSoZVge!vtU4oS*%+J^qTv-#^yg$?p8+
WGw8otik}@lN8mXE&k^`!1pWpy+=3eb

literal 0
HcmV?d00001

