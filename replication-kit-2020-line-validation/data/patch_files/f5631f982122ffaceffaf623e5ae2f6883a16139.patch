From f5631f982122ffaceffaf623e5ae2f6883a16139 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Sat, 17 Mar 2007 10:05:03 +0000
Subject: [PATCH] FIX: Invalid pom parsing when version is only declared in
 parent (IVY-436)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/core/trunk@519276 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                   |  1 +
 .../parser/m2/PomModuleDescriptorParser.java  |  9 +-
 .../m2/PomModuleDescriptorParserTest.java     |  7 ++
 .../m2/wicket-1.3-incubating-SNAPSHOT.pom     | 97 +++++++++++++++++++
 4 files changed, 113 insertions(+), 1 deletion(-)
 create mode 100644 test/java/org/apache/ivy/plugins/parser/m2/wicket-1.3-incubating-SNAPSHOT.pom

diff --git a/CHANGES.txt b/CHANGES.txt
index eafc4ce55..60cc71d21 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -19,6 +19,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - FIX: ivy.revision property not set correctly for second resolve (IVY-429)
 - FIX: NPE when no organisation or no name is provided in module element of ivyconf (IVY-422)
 - FIX: FileUtil#copy(File src, File dest, CopyProgressListener l, boolean overwrite) (IVY-420)
+- FIX: Invalid pom parsing when version is only declared in parent (IVY-436)
 - FIX: ${project.groupId} and ${project.version} not processed correctly in poms (IVY-425)
 - FIX: Incorrect pom parsing with profile (IVY-423)
 - FIX: Ivy doesn't recognize maven2 classifiers (IVY-418)
diff --git a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
index 5b45e1f80..3b749f03c 100644
--- a/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
+++ b/src/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParser.java
@@ -114,7 +114,8 @@ public void startElement(String uri, String localName, String qName, Attributes
                 }
             } else if (_md.getModuleRevisionId() == null) {
             	if ("project/dependencies".equals(context)
-            			|| "project/profiles".equals(context)) {
+            			|| "project/profiles".equals(context)
+            			|| "project/build".equals(context)) {
             		fillMrid();
             	}
             }
@@ -234,6 +235,10 @@ public void characters(char[] ch, int start, int length) throws SAXException {
             	_organisation = txt;
                 return;
             }
+            if (context.equals("project/parent/version") && _revision == null) {
+            	_revision = txt;
+                return;
+            }
             if (context.startsWith("project/parent")) {
                 return;
             }
@@ -245,6 +250,8 @@ public void characters(char[] ch, int start, int length) throws SAXException {
                 	_organisation = txt;
                 } else if (_module == null && context.endsWith("artifactId")) {
                     _module = txt;
+                } else if (context.equals("project/version") || (_revision == null && context.endsWith("version"))) {
+                    _revision = txt;
                 } else if (_revision == null && context.endsWith("version")) {
                     _revision = txt;
                 } else if (_scope == null && context.endsWith("scope")) {
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
index 5e5fde6ed..be08c4dad 100644
--- a/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
+++ b/test/java/org/apache/ivy/plugins/parser/m2/PomModuleDescriptorParserTest.java
@@ -169,6 +169,13 @@ public void testReal() throws Exception {
         assertEquals(ModuleRevisionId.newInstance("junit", "junit", "3.7"), dds[0].getDependencyRevisionId());
     }
     
+    public void testReal2() throws Exception {
+        ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(new IvySettings(), getClass().getResource("wicket-1.3-incubating-SNAPSHOT.pom"), false);
+        assertNotNull(md);
+        
+        assertEquals(ModuleRevisionId.newInstance("org.apache.wicket", "wicket", "1.3-incubating-SNAPSHOT"), md.getModuleRevisionId());
+    }
+    
     public void testVariables() throws Exception {
     	// test case for IVY-425
         ModuleDescriptor md = PomModuleDescriptorParser.getInstance().parseDescriptor(new IvySettings(), getClass().getResource("spring-hibernate3-2.0.2.pom"), false);
diff --git a/test/java/org/apache/ivy/plugins/parser/m2/wicket-1.3-incubating-SNAPSHOT.pom b/test/java/org/apache/ivy/plugins/parser/m2/wicket-1.3-incubating-SNAPSHOT.pom
new file mode 100644
index 000000000..dc68e9598
--- /dev/null
+++ b/test/java/org/apache/ivy/plugins/parser/m2/wicket-1.3-incubating-SNAPSHOT.pom
@@ -0,0 +1,97 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one or more
+   contributor license agreements.  See the NOTICE file distributed with
+   this work for additional information regarding copyright ownership.
+   The ASF licenses this file to You under the Apache License, Version 2.0
+   (the "License"); you may not use this file except in compliance with
+   the License.  You may obtain a copy of the License at
+
+        http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing, software
+   distributed under the License is distributed on an "AS IS" BASIS,
+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+   See the License for the specific language governing permissions and
+   limitations under the License.
+-->
+<project xmlns="http://maven.apache.org/POM/4.0.0"
+	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
+
+	<modelVersion>4.0.0</modelVersion>
+	<parent>
+		<groupId>org.apache.wicket</groupId>
+		<artifactId>wicket-parent</artifactId>
+		<version>1.3-incubating-SNAPSHOT</version>
+		<relativePath>../wicket-parent</relativePath>
+	</parent>
+
+	<artifactId>wicket</artifactId>
+	<packaging>jar</packaging>
+	<name>Wicket</name>
+	<url>http://wicketframework.org/${project.artifactId}-1.3</url>
+	<description>Wicket is a Java web application framework that takes simplicity, separation of concerns and ease of development to a whole new level. Wicket pages can be mocked up, previewed and later revised using standard WYSIWYG HTML design tools. Dynamic content processing and form handling is all handled in Java code using a first-class component model backed by POJO data beans that can easily be persisted using your favorite technology.</description>
+
+	<build>
+		<plugins>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-compiler-plugin</artifactId>
+				<configuration>
+					<source>1.4</source>
+					<target>1.4</target>
+				</configuration>
+			</plugin>
+			<plugin>
+				<groupId>org.codehaus.mojo</groupId>
+				<artifactId>surefire-report-maven-plugin</artifactId>
+			</plugin>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-surefire-plugin</artifactId>
+				<version>2.1.3</version>
+			</plugin>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-javadoc-plugin</artifactId>
+			</plugin>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-source-plugin</artifactId>
+			</plugin>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-assembly-plugin</artifactId>
+			</plugin>
+		</plugins>
+	</build>
+	<reporting>
+		<plugins>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-project-info-reports-plugin</artifactId>
+				<reportSets>
+					<reportSet>
+						<reports>
+							<report>dependencies</report>
+							<report>project-team</report>
+							<report>mailing-list</report>
+							<report>issue-tracking</report>
+							<report>license</report>
+							<report>scm</report>
+						</reports>
+					</reportSet>
+				</reportSets>
+			</plugin>
+			<plugin>
+				<groupId>org.apache.maven.plugins</groupId>
+				<artifactId>maven-javadoc-plugin</artifactId>
+			</plugin>
+			<plugin>
+				<groupId>org.codehaus.mojo</groupId>
+				<artifactId>surefire-report-maven-plugin</artifactId>
+			</plugin>
+		</plugins>
+	</reporting>
+</project>
