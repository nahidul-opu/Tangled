From d2883e2ade18d07cb76b0bf99d1b9a0aa66afdb2 Mon Sep 17 00:00:00 2001
From: Emmanuel Bourg <ebourg@apache.org>
Date: Wed, 4 Feb 2015 21:53:42 +0000
Subject: [PATCH] Removed the 'index' variable from the LocalVariableGen's hash
 code, thanks to Mark Roberts (BCEL-194)

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/bcel/trunk@1657412 13f79535-47bb-0310-9956-ffa450edef68
---
 RELEASE-NOTES.txt                                         | 1 +
 src/changes/changes.xml                                   | 3 +++
 .../java/org/apache/bcel/generic/LocalVariableGen.java    | 8 +++-----
 3 files changed, 7 insertions(+), 5 deletions(-)

diff --git a/RELEASE-NOTES.txt b/RELEASE-NOTES.txt
index 3fc026a090..254430e495 100644
--- a/RELEASE-NOTES.txt
+++ b/RELEASE-NOTES.txt
@@ -96,6 +96,7 @@ Bug fixes from 5.2
 [BCEL-174] Verification of interfaces with default methods fails with Java 8
 [BCEL-177] MethodParameters should read 1 byte not two for parameter count
 [BCEL-181] ClassLoaderRepository.loadClass(String) leaks input streams
+[BCEL-194] LocalVariableGen hashCode() function is incorrrect
 
 
 Feedback
diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index c125c4be10..93f682f8c6 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -63,6 +63,9 @@ The <action> type attribute can be add,update,fix,remove.
 
   <body>
     <release version="6.0" date="TBA" description="Major release with Java 7 and 8 support">
+      <action issue="BCEL-194" type="fix" due-to="Mark Roberts">
+        Removed the 'index' variable from the LocalVariableGen's hash code.
+      </action>
       <action issue="BCEL-186" type="fix" dev="sebb">
         Performance degradation with the UTF8 cache
         getInstance no longer uses cache
diff --git a/src/main/java/org/apache/bcel/generic/LocalVariableGen.java b/src/main/java/org/apache/bcel/generic/LocalVariableGen.java
index ec3085c970..67194b213f 100644
--- a/src/main/java/org/apache/bcel/generic/LocalVariableGen.java
+++ b/src/main/java/org/apache/bcel/generic/LocalVariableGen.java
@@ -172,13 +172,11 @@ public boolean containsTarget( InstructionHandle ih ) {
     }
 
 
-    /** @return a hash code value for the object.
-     */
     @Override
     public int hashCode() {
-        //If the user changes the name or type, problems with the targeter hashmap will occur
-        int hc = index ^ name.hashCode() ^ type.hashCode();
-        return hc;
+        // If the user changes the name or type, problems with the targeter hashmap will occur.
+        // Note: index cannot be part of hash as it may be changed by the user.
+        return name.hashCode() ^ type.hashCode();
     }
 
 
