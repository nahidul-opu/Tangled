From ba93f9a3db44fda15e4afa536701563dc4e67004 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Wed, 22 Mar 2006 11:41:02 +0000
Subject: [PATCH] FIX: problem with conflict resolution in transitive
 dependencies (IVY-199)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484251 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                 |  1 +
 src/java/fr/jayasoft/ivy/Ivy.java           | 19 +++++++++++++++----
 test/java/fr/jayasoft/ivy/ResolveTest.java  | 18 ++++++++++++++++++
 test/repositories/2/mod3.2/ivy-1.2.1.xml    | 11 +++++++++++
 test/repositories/2/mod3.2/mod3.2-1.2.1.jar |  1 +
 test/repositories/2/mod4.1/ivy-4.13.xml     | 11 +++++++++++
 6 files changed, 57 insertions(+), 4 deletions(-)
 create mode 100644 test/repositories/2/mod3.2/ivy-1.2.1.xml
 create mode 100644 test/repositories/2/mod3.2/mod3.2-1.2.1.jar
 create mode 100644 test/repositories/2/mod4.1/ivy-4.13.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index de002e908..f2328d663 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -1,3 +1,4 @@
+- FIX: problem with conflict resolution in transitive dependencies (IVY-199)
 - FIX: pb with force when it comes after a conflict has already been solved (IVY-193)
 - FIX: POM files that reference to the parent artifact download fails (IVY-195) (thanks to Tat Leung)
 
diff --git a/src/java/fr/jayasoft/ivy/Ivy.java b/src/java/fr/jayasoft/ivy/Ivy.java
index bc72fde36..1212d26ac 100644
--- a/src/java/fr/jayasoft/ivy/Ivy.java
+++ b/src/java/fr/jayasoft/ivy/Ivy.java
@@ -1170,10 +1170,8 @@ private void resolveConflict(IvyNode node, IvyNode parent, Collection toevict) {
                 }
             }
             
-            // it's time to update parent resolved and evicted with what was found...
-            // if they have not been recomputed, it does not change anything
-            parent.setResolvedNodes(node.getModuleId(), node.getRootModuleConf(), resolved); 
-
+            // it's time to update parent resolved and evicted with what was found 
+            
             Collection evicted = new HashSet(parent.getEvictedNodes(node.getModuleId(), node.getRootModuleConf()));
             evicted.removeAll(resolved);
             evicted.addAll(toevict);
@@ -1185,6 +1183,19 @@ private void resolveConflict(IvyNode node, IvyNode parent, Collection toevict) {
             if (debugConflictResolution()) {
                 Message.debug("evicting "+node+" by "+node.getEvictedData(node.getRootModuleConf()));
             }
+
+            // if resolved changed we have to go up in the graph
+            Collection prevResolved = parent.getResolvedNodes(node.getModuleId(), node.getRootModuleConf());
+            if (!prevResolved.equals(resolved)) {                
+                parent.setResolvedNodes(node.getModuleId(), node.getRootModuleConf(), resolved);
+                for (Iterator iter = resolved.iterator(); iter.hasNext();) {
+                    IvyNode sel = (IvyNode)iter.next();
+                    if (!prevResolved.contains(sel)) {
+                        resolveConflict(sel, parent.getParent(), toevict);
+                    }
+                }
+            }
+
         }
     }
 
diff --git a/test/java/fr/jayasoft/ivy/ResolveTest.java b/test/java/fr/jayasoft/ivy/ResolveTest.java
index 5fcd5dda9..6af8c26b8 100644
--- a/test/java/fr/jayasoft/ivy/ResolveTest.java
+++ b/test/java/fr/jayasoft/ivy/ResolveTest.java
@@ -668,6 +668,24 @@ public void testTransitiveEviction() throws Exception {
         assertTrue(!_ivy.getArchiveFileInCache(_cache, "org1", "mod1.2", "2.0", "mod1.2", "jar", "jar").exists());
     }
     
+    public void testTransitiveEviction2() throws Exception {
+        // IVY-199
+        // mod4.1 v 4.13 depends on 
+        //   - mod3.2 v 1.2.1 which depends on 
+        //         - mod3.1 v 1.0 which depends on mod1.2 v 2.0
+        //         - mod1.2 v 2.1
+        ResolveReport report = _ivy.resolve(new File("test/repositories/2/mod4.1/ivy-4.13.xml").toURL(),
+                null, new String[] {"*"}, _cache, null, true);
+        assertNotNull(report);
+        ModuleDescriptor md = report.getModuleDescriptor();
+        
+        // dependencies
+        assertTrue(_ivy.getIvyFileInCache(_cache, ModuleRevisionId.newInstance("org1", "mod1.2", "2.1")).exists());
+        assertTrue(_ivy.getArchiveFileInCache(_cache, "org1", "mod1.2", "2.1", "mod1.2", "jar", "jar").exists());
+
+        assertFalse(_ivy.getArchiveFileInCache(_cache, "org1", "mod1.2", "2.0", "mod1.2", "jar", "jar").exists());
+    }
+    
     public void testResolveConflictInConf() throws Exception {
         // conflicts in separate confs are not conflicts
         
diff --git a/test/repositories/2/mod3.2/ivy-1.2.1.xml b/test/repositories/2/mod3.2/ivy-1.2.1.xml
new file mode 100644
index 000000000..0ec470ae2
--- /dev/null
+++ b/test/repositories/2/mod3.2/ivy-1.2.1.xml
@@ -0,0 +1,11 @@
+<ivy-module version="1.0">
+	<info organisation="org3"
+	       module="mod3.2"
+	       revision="1.2.1"
+	       status="integration"
+	/>
+	<dependencies>
+		<dependency org="org3" name="mod3.1" rev="1.0"/>
+		<dependency org="org1" name="mod1.2" rev="2.1"/>
+	</dependencies>
+</ivy-module>
diff --git a/test/repositories/2/mod3.2/mod3.2-1.2.1.jar b/test/repositories/2/mod3.2/mod3.2-1.2.1.jar
new file mode 100644
index 000000000..56f3b36e2
--- /dev/null
+++ b/test/repositories/2/mod3.2/mod3.2-1.2.1.jar
@@ -0,0 +1 @@
+ 
diff --git a/test/repositories/2/mod4.1/ivy-4.13.xml b/test/repositories/2/mod4.1/ivy-4.13.xml
new file mode 100644
index 000000000..114622b7a
--- /dev/null
+++ b/test/repositories/2/mod4.1/ivy-4.13.xml
@@ -0,0 +1,11 @@
+<ivy-module version="1.0">
+	<info organisation="org4"
+	       module="mod4.1"
+	       revision="4.13"
+	       status="integration"
+	       publication="20041202110000"
+	/>
+	<dependencies>
+		<dependency org="org3" name="mod3.2" rev="1.2.1"/>
+	</dependencies>
+</ivy-module>
