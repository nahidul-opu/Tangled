From b1e59b4648f69eebc870673c2e9eba4fef43beb1 Mon Sep 17 00:00:00 2001
From: Colm O Heigeartaigh <coheigea@apache.org>
Date: Mon, 14 Jan 2013 18:25:34 +0000
Subject: [PATCH] [SANTUARIO-351] - Removed ThreadLocal storage from
 OutputStreams

git-svn-id: https://svn.apache.org/repos/asf/santuario/xml-security-java/branches/1.5.x-fixes@1433022 13f79535-47bb-0310-9956-ffa450edef68
---
 .../utils/UnsyncBufferedOutputStream.java         | 15 ++++-----------
 .../utils/UnsyncByteArrayOutputStream.java        | 13 +++----------
 2 files changed, 7 insertions(+), 21 deletions(-)

diff --git a/src/main/java/org/apache/xml/security/utils/UnsyncBufferedOutputStream.java b/src/main/java/org/apache/xml/security/utils/UnsyncBufferedOutputStream.java
index 0b5c26a573..b27293a0a6 100644
--- a/src/main/java/org/apache/xml/security/utils/UnsyncBufferedOutputStream.java
+++ b/src/main/java/org/apache/xml/security/utils/UnsyncBufferedOutputStream.java
@@ -27,24 +27,18 @@
  */
 public class UnsyncBufferedOutputStream extends OutputStream {
     static final int size = 8*1024;
-    private static ThreadLocal<byte[]> bufCache = new ThreadLocal<byte[]>() {
-        @Override
-        protected synchronized byte[] initialValue() {
-            return new byte[size];
-        }
-    };
     
-    int pointer = 0;
-    final OutputStream out;
+    private int pointer = 0;
+    private final OutputStream out;
 
-    final byte[] buf;
+    private final byte[] buf;
     
     /**
      * Creates a buffered output stream without synchronization
      * @param out the outputstream to buffer
      */
     public UnsyncBufferedOutputStream(OutputStream out) {
-        buf = (byte[])bufCache.get();
+        buf = new byte[size];
         this.out = out;
     }
 
@@ -95,7 +89,6 @@ public void flush() throws IOException {
     public void close() throws IOException {
         flush();
         out.close();
-        bufCache.remove();
     }
 
 }
diff --git a/src/main/java/org/apache/xml/security/utils/UnsyncByteArrayOutputStream.java b/src/main/java/org/apache/xml/security/utils/UnsyncByteArrayOutputStream.java
index a4af8691f2..9d60b74476 100644
--- a/src/main/java/org/apache/xml/security/utils/UnsyncByteArrayOutputStream.java
+++ b/src/main/java/org/apache/xml/security/utils/UnsyncByteArrayOutputStream.java
@@ -29,19 +29,13 @@
 public class UnsyncByteArrayOutputStream extends OutputStream  {	
 
     private static final int INITIAL_SIZE = 8192;
-    private static ThreadLocal<byte[]> bufCache = new ThreadLocal<byte[]>() {
-        @Override
-        protected synchronized byte[] initialValue() {
-            return new byte[INITIAL_SIZE];
-        }
-    };
 
     private byte[] buf;
     private int size = INITIAL_SIZE;
     private int pos = 0;
 
     public UnsyncByteArrayOutputStream() {
-        buf = (byte[])bufCache.get();
+        buf = new byte[INITIAL_SIZE];
     }
 
     public void write(byte[] arg0) {
@@ -87,12 +81,11 @@ public byte[] toByteArray() {
 
     public void reset() {
         pos = 0;
-        bufCache.remove();
+        buf = new byte[INITIAL_SIZE];
     }
     
-    @Override
     public void close() throws IOException {
-        bufCache.remove();
+        buf = null;
     }
 
     private void expandSize(int newPos) {
