From 3a2d7f0eb6561c557fc512932643458af4c7343a Mon Sep 17 00:00:00 2001
From: kazk <kazk@unknown>
Date: Fri, 20 Jul 2012 05:48:11 +0000
Subject: [PATCH] Fixes GORA-151 to check if keyspace already exists

git-svn-id: https://svn.apache.org/repos/asf/gora/trunk@1363657 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                               | 2 ++
 .../org/apache/gora/cassandra/store/CassandraClient.java  | 8 ++++++++
 .../org/apache/gora/cassandra/store/CassandraStore.java   | 2 +-
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index ffa85e828..2d0bcd2ab 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -6,6 +6,8 @@ Gora Change Log
 
 0.3 (trunk) Current Development:
 
+* GORA-151 CassandraStore's schemaExists() method always returns false (kazk)
+
 * GORA-150 Introduce Configuration property preferred.schema.name (ferdy)
 
 * GORA-142 Creates org.apache.gora.cassandra.serializers package in order to clean the code of store and query packages and to support additional types in future. (kazk)
diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java
index 981da9580..a5643bfa8 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraClient.java
@@ -93,6 +93,14 @@ public void initialize(Class<K> keyClass, Class<T> persistentClass) throws Excep
     this.keySerializer = GoraSerializerTypeInferer.getSerializer(keyClass);
     this.mutator = HFactory.createMutator(this.keyspace, this.keySerializer);
   }
+
+  /**
+   * Check if keyspace already exists.
+   */
+  public boolean keyspaceExists() {
+    KeyspaceDefinition keyspaceDefinition = this.cluster.describeKeyspace(this.cassandraMapping.getKeyspaceName());
+    return (keyspaceDefinition != null);
+  }
   
   /**
    * Check if keyspace already exists. If not, create it.
diff --git a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
index 2cc83e689..0f377f9b6 100644
--- a/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
+++ b/gora-cassandra/src/main/java/org/apache/gora/cassandra/store/CassandraStore.java
@@ -390,7 +390,7 @@ private void addOrUpdateField(K key, Field field, Object value) {
   @Override
   public boolean schemaExists() throws IOException {
     LOG.info("schema exists");
-    return false;
+    return cassandraClient.keyspaceExists();
   }
 
 }
