From e9429c05e1a4797383fb405928088d2f8563ff97 Mon Sep 17 00:00:00 2001
From: "Gary D. Gregory" <ggregory@apache.org>
Date: Wed, 29 Feb 2012 14:39:01 +0000
Subject: [PATCH] [LANG-788] SerializationUtils throws ClassNotFoundException
 when cloning primitive classes

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/lang/trunk@1295134 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/lang3/SerializationUtils.java     | 26 +++++++++++++++++--
 src/site/changes/changes.xml                  |  1 +
 .../commons/lang3/SerializationUtilsTest.java | 10 +++++++
 3 files changed, 35 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/lang3/SerializationUtils.java b/src/main/java/org/apache/commons/lang3/SerializationUtils.java
index b766b21458b..7c89b61d790 100644
--- a/src/main/java/org/apache/commons/lang3/SerializationUtils.java
+++ b/src/main/java/org/apache/commons/lang3/SerializationUtils.java
@@ -25,6 +25,8 @@
 import java.io.ObjectStreamClass;
 import java.io.OutputStream;
 import java.io.Serializable;
+import java.util.HashMap;
+import java.util.Map;
 
 /**
  * <p>Assists with the serialization process and performs additional functionality based
@@ -234,8 +236,10 @@ public static Object deserialize(byte[] objectData) {
      * class here is a workaround, see the JIRA issue LANG-626. </p>
      */
      static class ClassLoaderAwareObjectInputStream extends ObjectInputStream {
+        private static final Map<String, Class<?>> primitiveTypes = 
+                new HashMap<String, Class<?>>();
         private ClassLoader classLoader;
-
+        
         /**
          * Constructor.
          * @param in The <code>InputStream</code>.
@@ -246,6 +250,16 @@ static class ClassLoaderAwareObjectInputStream extends ObjectInputStream {
         public ClassLoaderAwareObjectInputStream(InputStream in, ClassLoader classLoader) throws IOException {
             super(in);
             this.classLoader = classLoader;
+
+            primitiveTypes.put("byte", byte.class);
+            primitiveTypes.put("short", short.class);
+            primitiveTypes.put("int", int.class);
+            primitiveTypes.put("long", long.class);
+            primitiveTypes.put("float", float.class);
+            primitiveTypes.put("double", double.class);
+            primitiveTypes.put("boolean", boolean.class);
+            primitiveTypes.put("char", char.class);
+            primitiveTypes.put("void", void.class);
         }
 
         /**
@@ -262,7 +276,15 @@ protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, Clas
             try {
                 return Class.forName(name, false, classLoader);
             } catch (ClassNotFoundException ex) {
-                return Class.forName(name, false, Thread.currentThread().getContextClassLoader());
+                try {
+                    return Class.forName(name, false, Thread.currentThread().getContextClassLoader());
+                } catch (ClassNotFoundException cnfe) {
+                    Class<?> cls = primitiveTypes.get(name);
+                    if (cls != null)
+                        return cls;
+                    else
+                        throw cnfe;
+                }
             }
         }
 
diff --git a/src/site/changes/changes.xml b/src/site/changes/changes.xml
index e859411aeec..ec922c60c85 100644
--- a/src/site/changes/changes.xml
+++ b/src/site/changes/changes.xml
@@ -22,6 +22,7 @@
   <body>
 
   <release version="3.2" date="TBA" description="Next release">
+    <action type="fix" issue="LANG-788">SerializationUtils throws ClassNotFoundException when cloning primitive classes</action>
     <action type="fix" issue="LANG-786">StringUtils equals() relies on undefined behavior</action>
     <action type="fix" issue="LANG-783">Documentation bug: StringUtils.split</action>
     <action type="fix" issue="LANG-776">TypeUtilsTest contains incorrect type assignability assertion</action>
diff --git a/src/test/java/org/apache/commons/lang3/SerializationUtilsTest.java b/src/test/java/org/apache/commons/lang3/SerializationUtilsTest.java
index 01c98cd2d7e..9bf9c0d79d5 100644
--- a/src/test/java/org/apache/commons/lang3/SerializationUtilsTest.java
+++ b/src/test/java/org/apache/commons/lang3/SerializationUtilsTest.java
@@ -364,6 +364,16 @@ public void testCloneUnserializable() throws Exception {
         }
         fail();
     }
+    
+    public void testPrimitiveTypeClassSerialization() {
+        Class<?>[] primitiveTypes = { byte.class, short.class, int.class, long.class, float.class, double.class,
+                boolean.class, char.class, void.class };
+
+        for (Class<?> primitiveType : primitiveTypes) {
+            Class<?> clone = SerializationUtils.clone(primitiveType);
+            assertEquals(primitiveType, clone);
+        }
+    }
 
 }
 
