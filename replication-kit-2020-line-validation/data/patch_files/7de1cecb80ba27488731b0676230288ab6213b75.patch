From 7de1cecb80ba27488731b0676230288ab6213b75 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Fri, 25 Apr 2008 21:29:14 +0000
Subject: [PATCH] FIX: Using ivy:settings with the "id" attribute not behaving
 as expected (IVY-809)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@651702 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                                | 1 +
 src/java/org/apache/ivy/ant/IvyPostResolveTask.java        | 1 +
 test/java/org/apache/ivy/ant/IvyAntSettingsBuildFile.xml   | 5 +++++
 .../org/apache/ivy/ant/IvyAntSettingsBuildFileTest.java    | 7 ++++++-
 4 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/CHANGES.txt b/CHANGES.txt
index 988eac400..d857db297 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -79,6 +79,7 @@ for detailed view of each issue, please consult http://issues.apache.org/jira/br
 - IMPROVEMENT: Change allownomd and skipbuildwithoutivy into a more semantically correct name (IVY-297)
 - IMPROVEMENT: Smarter determination if an expression is exact or not for RegexpPatternMatcher and GlobPatternMatcher
 
+- FIX: Using ivy:settings with the "id" attribute not behaving as expected (IVY-809)
 - FIX: onMissingDescriptor doesn't work due to == comparison (IVY-805) (thanks to Ben Hale)
 - FIX: revision token is not set in report outputpattern (IVY-272)
 - FIX: Ivy uses the first set of configurations it sees when resolving multiple versions of a module (IVY-681)
diff --git a/src/java/org/apache/ivy/ant/IvyPostResolveTask.java b/src/java/org/apache/ivy/ant/IvyPostResolveTask.java
index f5a933d82..349879f38 100644
--- a/src/java/org/apache/ivy/ant/IvyPostResolveTask.java
+++ b/src/java/org/apache/ivy/ant/IvyPostResolveTask.java
@@ -288,6 +288,7 @@ protected IvyResolve createResolve(boolean haltOnFailure, boolean useOrigin) {
         resolve.setValidate(isValidate());
         resolve.setKeep(isKeep());
         resolve.setLog(getLog());
+        resolve.setSettingsRef(getSettingsRef());
         return resolve;
     }
 
diff --git a/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFile.xml b/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFile.xml
index 7ec7c40ea..e9df9d5f9 100644
--- a/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFile.xml
+++ b/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFile.xml
@@ -34,4 +34,9 @@
   	<ivy:settings id="test2" file="test/repositories/ivysettings.xml" override="false" />
   	<ivy:resolve settingsRef="test2" file="test/java/org/apache/ivy/ant/ivy-simple.xml" />
   </target>
+	  
+  <target name="testUnnecessaryDefaultIvyInstance">
+	  	<ivy:settings id="testUnnecessaryDefaultIvyInstance" file="test/repositories/ivysettings.xml" override="true" />
+	  	<ivy:cachepath settingsRef="testUnnecessaryDefaultIvyInstance" file="test/java/org/apache/ivy/ant/ivy-simple.xml" pathid="ptest" />
+	  </target>
 </project>
\ No newline at end of file
diff --git a/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFileTest.java b/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFileTest.java
index c51252db8..600225bf1 100644
--- a/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFileTest.java
+++ b/test/java/org/apache/ivy/ant/IvyAntSettingsBuildFileTest.java
@@ -41,5 +41,10 @@ public void testOverrideSetToFalse() {
         assertFalse(report.hasError());
         assertEquals(1, report.getDependencies().size());
     }
-
+    
+    public void testUnnecessaryDefaultIvyInstance() {
+        executeTarget("testUnnecessaryDefaultIvyInstance");
+        assertNull("Default ivy.instance settings shouldn't have been loaded", 
+                getProject().getReference("ivy.instance"));
+    }
 }
