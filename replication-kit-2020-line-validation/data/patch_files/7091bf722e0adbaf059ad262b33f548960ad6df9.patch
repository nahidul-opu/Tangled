From 7091bf722e0adbaf059ad262b33f548960ad6df9 Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sat, 21 Oct 2006 15:23:45 +0000
Subject: [PATCH] XPathExpressionEngine now constructs correct keys for
 attribute nodes; fixes CONFIGURATION-230

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/configuration/trunk@466413 13f79535-47bb-0310-9956-ffa450edef68
---
 .../tree/xpath/XPathExpressionEngine.java           |  5 +----
 .../commons/configuration/TestXMLConfiguration.java | 13 +++++++++++++
 .../tree/xpath/TestXPathExpressionEngine.java       |  2 +-
 xdocs/changes.xml                                   |  6 ++++++
 4 files changed, 21 insertions(+), 5 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/tree/xpath/XPathExpressionEngine.java b/src/java/org/apache/commons/configuration/tree/xpath/XPathExpressionEngine.java
index a143fdacdf..d2f2d29789 100644
--- a/src/java/org/apache/commons/configuration/tree/xpath/XPathExpressionEngine.java
+++ b/src/java/org/apache/commons/configuration/tree/xpath/XPathExpressionEngine.java
@@ -170,10 +170,7 @@ else if (node.getName() == null)
             if (parentKey.length() > 0)
             {
                 buf.append(parentKey);
-                if (!node.isAttribute())
-                {
-                    buf.append(PATH_DELIMITER);
-                }
+                buf.append(PATH_DELIMITER);
             }
             if (node.isAttribute())
             {
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index a9903d67ef..1cb930dfb5 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -34,6 +34,7 @@
 
 import org.apache.commons.configuration.reloading.FileChangedReloadingStrategy;
 import org.apache.commons.configuration.reloading.InvariantReloadingStrategy;
+import org.apache.commons.configuration.tree.xpath.XPathExpressionEngine;
 import org.xml.sax.SAXException;
 import org.xml.sax.SAXParseException;
 import org.xml.sax.helpers.DefaultHandler;
@@ -913,6 +914,18 @@ public void testConfigurationsAtWithReload() throws ConfigurationException
                         .getString("entity"));
     }
 
+    /**
+     * Tests accessing properties when the XPATH expression engine is set.
+     */
+    public void testXPathExpressionEngine()
+    {
+        conf.setExpressionEngine(new XPathExpressionEngine());
+        assertEquals("Wrong attribute value", "foo\"bar", conf
+                .getString("test[1]/entity/@name"));
+        conf.clear();
+        assertNull(conf.getString("test[1]/entity/@name"));
+    }
+
     /**
      * Prepares a configuration object for testing a reload operation.
      *
diff --git a/src/test/org/apache/commons/configuration/tree/xpath/TestXPathExpressionEngine.java b/src/test/org/apache/commons/configuration/tree/xpath/TestXPathExpressionEngine.java
index 893c80d66d..7c2b900bfd 100644
--- a/src/test/org/apache/commons/configuration/tree/xpath/TestXPathExpressionEngine.java
+++ b/src/test/org/apache/commons/configuration/tree/xpath/TestXPathExpressionEngine.java
@@ -152,7 +152,7 @@ public void testNodeKeyAttribute()
     {
         ConfigurationNode node = new DefaultConfigurationNode("attr");
         node.setAttribute(true);
-        assertEquals("Wrong attribute key", "node@attr", engine.nodeKey(node,
+        assertEquals("Wrong attribute key", "node/@attr", engine.nodeKey(node,
                 "node"));
     }
 
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 39d5cad294..761b3e3b5b 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,12 @@
 
   <body>
     <release version="1.4-dev" date="in SVN">
+      <action dev="oheger" type="update" issue="CONFIGURATION-230">
+        XPathExpressionEngine used to create wrong keys for attribute nodes.
+        This caused some operations on XMLConfiguration to fail when such an
+        expression engine was set (e.g. reloading). Now correct keys for
+        attributes are constructed.
+      </action>
       <action dev="oheger" type="update" issue="CONFIGURATION-228">
         Some of the methods of file-based hierarchical configurations (e.g.
         subset() or configurationAt()) did not take an eventually set reloading
