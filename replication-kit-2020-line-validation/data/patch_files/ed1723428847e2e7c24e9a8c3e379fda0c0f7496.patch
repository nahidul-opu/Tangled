From ed1723428847e2e7c24e9a8c3e379fda0c0f7496 Mon Sep 17 00:00:00 2001
From: Kristian Rosenvold <krosenvold@apache.org>
Date: Fri, 19 Jun 2015 17:03:34 +0000
Subject: [PATCH] IO-469 Self-supression with try-with-resources

Solution proposed by Grigory Fadeev

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/io/trunk@1686456 13f79535-47bb-0310-9956-ffa450edef68
---
 .../commons/io/input/BrokenInputStream.java       |  2 +-
 .../commons/io/output/BrokenOutputStream.java     |  2 +-
 .../commons/io/input/BrokenInputStreamTest.java   | 14 ++++++++++++++
 .../commons/io/output/BrokenOutputStreamTest.java | 15 +++++++++++++++
 4 files changed, 31 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/io/input/BrokenInputStream.java b/src/main/java/org/apache/commons/io/input/BrokenInputStream.java
index a8b0fe9073f..72943590839 100644
--- a/src/main/java/org/apache/commons/io/input/BrokenInputStream.java
+++ b/src/main/java/org/apache/commons/io/input/BrokenInputStream.java
@@ -102,7 +102,7 @@ public synchronized void reset() throws IOException {
      */
     @Override
     public void close() throws IOException {
-        throw exception;
+        throw new IOException(exception.getMessage());
     }
 
 }
diff --git a/src/main/java/org/apache/commons/io/output/BrokenOutputStream.java b/src/main/java/org/apache/commons/io/output/BrokenOutputStream.java
index 1f149ffa870..3fac0fece93 100644
--- a/src/main/java/org/apache/commons/io/output/BrokenOutputStream.java
+++ b/src/main/java/org/apache/commons/io/output/BrokenOutputStream.java
@@ -79,7 +79,7 @@ public void flush() throws IOException {
      */
     @Override
     public void close() throws IOException {
-        throw exception;
+        throw new IOException(exception.getMessage());
     }
 
 }
diff --git a/src/test/java/org/apache/commons/io/input/BrokenInputStreamTest.java b/src/test/java/org/apache/commons/io/input/BrokenInputStreamTest.java
index 2636afbbbc7..4bd3f965298 100644
--- a/src/test/java/org/apache/commons/io/input/BrokenInputStreamTest.java
+++ b/src/test/java/org/apache/commons/io/input/BrokenInputStreamTest.java
@@ -95,4 +95,18 @@ public void testClose() {
         }
     }
 
+    @SuppressWarnings("ResultOfMethodCallIgnored")
+    public void testSelfSupressed(){
+        BrokenInputStream bis = new BrokenInputStream();
+        try {
+            bis.read();
+        } catch (IOException e) {
+            try {
+                bis.close();
+            } catch (IOException e1) {
+                e1.addSuppressed( e); // Simulates try-with resources since we're not jdk7 yet
+            }
+        }
+    }
+
 }
diff --git a/src/test/java/org/apache/commons/io/output/BrokenOutputStreamTest.java b/src/test/java/org/apache/commons/io/output/BrokenOutputStreamTest.java
index 7fea25e97d0..491ef408db9 100644
--- a/src/test/java/org/apache/commons/io/output/BrokenOutputStreamTest.java
+++ b/src/test/java/org/apache/commons/io/output/BrokenOutputStreamTest.java
@@ -20,6 +20,7 @@
 import java.io.OutputStream;
 
 import junit.framework.TestCase;
+import org.apache.commons.io.input.BrokenInputStream;
 
 /**
  * JUnit Test Case for {@link BrokenOutputStream}.
@@ -77,4 +78,18 @@ public void testClose() {
         }
     }
 
+    @SuppressWarnings("ResultOfMethodCallIgnored")
+    public void testSelfSupressed(){
+        BrokenOutputStream bos = new BrokenOutputStream();
+        try {
+            bos.write(123);
+        } catch (IOException e) {
+            try {
+                bos.close();
+            } catch (IOException e1) {
+                e1.addSuppressed( e); // Simulates try-with resources since we're not jdk7 yet
+            }
+        }
+    }
+
 }
