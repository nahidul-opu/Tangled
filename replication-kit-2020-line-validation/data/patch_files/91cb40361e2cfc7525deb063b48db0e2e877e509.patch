From 91cb40361e2cfc7525deb063b48db0e2e877e509 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Tue, 30 Mar 2010 20:01:55 +0000
Subject: [PATCH] FIX: Transitive dependencies resolutions issue when eviction
 is triggered (IVY-1178)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@929239 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/ivy/core/resolve/ResolveTest.java  | 27 +++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/test/java/org/apache/ivy/core/resolve/ResolveTest.java b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
index 0e9a3b542..4c6cd52cf 100644
--- a/test/java/org/apache/ivy/core/resolve/ResolveTest.java
+++ b/test/java/org/apache/ivy/core/resolve/ResolveTest.java
@@ -3310,6 +3310,33 @@ public void testBug148b() throws Exception {
                 .exists());
     }
 
+    public void testIVY1178() throws Exception {
+        Ivy ivy = new Ivy();
+        ivy.configure(new File("test/repositories/IVY-1178/ivysettings.xml"));
+        ResolveReport report = ivy.resolve(ResolveTest.class.getResource("ivy-1178.xml"),
+            getResolveOptions(new String[] {"*"}));
+
+        assertNotNull(report);
+        assertNotNull(report.getUnresolvedDependencies());
+        assertEquals("Number of unresolved dependencies not correct", 0, report
+                .getUnresolvedDependencies().length);
+        
+        // dependencies
+        assertTrue(getIvyFileInCache(
+            ModuleRevisionId.newInstance("myorg", "modD", "1.1")).exists());
+        assertTrue(getArchiveFileInCache("myorg", "modD", "1.1", "modD", "jar", "jar").exists());
+
+        // evicted dependencies
+        assertFalse(getIvyFileInCache(
+            ModuleRevisionId.newInstance("myorg", "modD", "1.0")).exists());
+        assertFalse(getArchiveFileInCache("myorg", "modD", "1.0", "modD", "jar", "jar").exists());
+        
+        // transitive dependencies of modD-1.1 (must not exist: transitive="false" !)
+        assertFalse(getIvyFileInCache(
+            ModuleRevisionId.newInstance("myorg", "modE", "1.1")).exists());
+        assertFalse(getArchiveFileInCache("myorg", "modE", "1.1", "modE", "jar", "jar").exists());
+    }
+
     public void testIVY999() throws Exception {
         Ivy ivy = new Ivy();
         ivy.configure(new File("test/repositories/IVY-999/ivysettings.xml"));
