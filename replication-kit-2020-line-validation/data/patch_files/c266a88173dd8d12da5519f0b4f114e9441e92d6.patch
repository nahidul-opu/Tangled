From c266a88173dd8d12da5519f0b4f114e9441e92d6 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Tue, 10 Jan 2012 14:44:25 +0000
Subject: [PATCH] NET-437 TelnetInputStream doesn't support non-blocking IO
 when reader thread is not enabled

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/net/trunk@1229563 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                      | 5 ++++-
 .../org/apache/commons/net/telnet/TelnetInputStream.java     | 2 +-
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 9705d37a1..b52221329 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -59,7 +59,10 @@ The <action> type attribute can be add,update,fix,remove.
         <release version="3.1-SNAPSHOT" date="TBA" description="
 TBA
         ">
-            <action issue="NET346" dev="sebb" type="add" due-to="Kevin Samuel">
+            <action issue="NET-437" dev="sebb" type="fix" due-to="Gavin Camp">
+            TelnetInputStream doesn't support non-blocking IO when reader thread is not enabled
+            </action>
+            <action issue="NET-346" dev="sebb" type="add" due-to="Kevin Samuel">
             FTP should support reporting NATed external IP address
             </action>
             <action issue="NET-433" dev="sebb" type="add">
diff --git a/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java b/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
index 1f629f3a1..c17085858 100644
--- a/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
+++ b/src/main/java/org/apache/commons/net/telnet/TelnetInputStream.java
@@ -543,7 +543,7 @@ public int available() throws IOException
         // Critical section because run() may change __bytesAvailable
         synchronized (__queue)
         {
-            return __bytesAvailable;
+            return __bytesAvailable + super.available();
         }
     }
 
