From 2ebd474518813c065e774d831075d925f2b9b7d5 Mon Sep 17 00:00:00 2001
From: Maarten Coene <maartenc@apache.org>
Date: Thu, 5 Mar 2009 21:54:26 +0000
Subject: [PATCH] Added junit test for IVY-1037 (thanks to Martin Eigenbrodt)

git-svn-id: https://svn.apache.org/repos/asf/ant/ivy/core/trunk@750617 13f79535-47bb-0310-9956-ffa450edef68
---
 .../apache/ivy/ant/IvyBuildNumberTest.java    | 15 +++++++++
 test/repositories/IVY-1037/ivysettings.xml    | 33 +++++++++++++++++++
 .../IVY-1037/rep1/org/module/ivy-1.xml        | 22 +++++++++++++
 .../IVY-1037/rep2/org/module/ivy-2.xml        | 22 +++++++++++++
 4 files changed, 92 insertions(+)
 create mode 100644 test/repositories/IVY-1037/ivysettings.xml
 create mode 100644 test/repositories/IVY-1037/rep1/org/module/ivy-1.xml
 create mode 100644 test/repositories/IVY-1037/rep2/org/module/ivy-2.xml

diff --git a/test/java/org/apache/ivy/ant/IvyBuildNumberTest.java b/test/java/org/apache/ivy/ant/IvyBuildNumberTest.java
index ce4b3cd4e..658b1e24f 100644
--- a/test/java/org/apache/ivy/ant/IvyBuildNumberTest.java
+++ b/test/java/org/apache/ivy/ant/IvyBuildNumberTest.java
@@ -176,5 +176,20 @@ public void testWithBadChecksum() throws Exception {
         assertEquals("0", buildNumber.getProject().getProperty("ivy.build.number"));
         assertEquals("1", buildNumber.getProject().getProperty("ivy.new.build.number"));
     }
+    
+    public void testChainResolver() throws Exception {
+        // IVY-1037
+        Project project = new Project();
+        project.setProperty("ivy.settings.file", "test/repositories/IVY-1037/ivysettings.xml");
+
+        buildNumber = new IvyBuildNumber();
+        buildNumber.setProject(project);
+        buildNumber.setOrganisation("org");
+        buildNumber.setModule("module");
+        buildNumber.setResolver("chain");
+        buildNumber.execute();
+        assertEquals("3", buildNumber.getProject().getProperty("ivy.new.revision"));
+    }
+
 
 }
diff --git a/test/repositories/IVY-1037/ivysettings.xml b/test/repositories/IVY-1037/ivysettings.xml
new file mode 100644
index 000000000..70456be56
--- /dev/null
+++ b/test/repositories/IVY-1037/ivysettings.xml
@@ -0,0 +1,33 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivyconf>
+    <conf defaultResolver="chain"/>
+    <resolvers>
+        <chain name="chain" >
+            <filesystem name="rep1" >
+                <ivy pattern="${ivy.settings.dir}/rep1/[organisation]/[module]/ivy-[revision].xml"/>
+                <artifact pattern="${ivy.settings.dir}/rep1/[organisation]/[module]/[artifact]-[revision].[ext]"/>
+            </filesystem>
+            <filesystem name="rep2" >
+                <ivy pattern="${ivy.settings.dir}/rep2/[organisation]/[module]/ivy-[revision].xml"/>
+                <artifact pattern="${ivy.settings.dir}/rep2/[organisation]/[module]/[artifact]-[revision].[ext]"/>
+            </filesystem>
+        </chain>
+    </resolvers>
+</ivyconf>
\ No newline at end of file
diff --git a/test/repositories/IVY-1037/rep1/org/module/ivy-1.xml b/test/repositories/IVY-1037/rep1/org/module/ivy-1.xml
new file mode 100644
index 000000000..c01143698
--- /dev/null
+++ b/test/repositories/IVY-1037/rep1/org/module/ivy-1.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="2.0">
+    <info organisation="org" module="module" revision="1" status="integration" publication="20090108103716"/>
+    <publications/>
+</ivy-module>
diff --git a/test/repositories/IVY-1037/rep2/org/module/ivy-2.xml b/test/repositories/IVY-1037/rep2/org/module/ivy-2.xml
new file mode 100644
index 000000000..8ba67c5fc
--- /dev/null
+++ b/test/repositories/IVY-1037/rep2/org/module/ivy-2.xml
@@ -0,0 +1,22 @@
+<!--
+   Licensed to the Apache Software Foundation (ASF) under one
+   or more contributor license agreements.  See the NOTICE file
+   distributed with this work for additional information
+   regarding copyright ownership.  The ASF licenses this file
+   to you under the Apache License, Version 2.0 (the
+   "License"); you may not use this file except in compliance
+   with the License.  You may obtain a copy of the License at
+
+     http://www.apache.org/licenses/LICENSE-2.0
+
+   Unless required by applicable law or agreed to in writing,
+   software distributed under the License is distributed on an
+   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
+   KIND, either express or implied.  See the License for the
+   specific language governing permissions and limitations
+   under the License.    
+-->
+<ivy-module version="2.0">
+    <info organisation="org" module="module" revision="2" status="integration" publication="20090108103716"/>
+    <publications/>
+</ivy-module>
