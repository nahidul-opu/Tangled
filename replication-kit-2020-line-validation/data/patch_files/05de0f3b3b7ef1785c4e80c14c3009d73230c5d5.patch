From 05de0f3b3b7ef1785c4e80c14c3009d73230c5d5 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 7 Jan 2016 15:09:51 +0000
Subject: [PATCH] VALIDATOR-359 EmailValidator does not catch invalid email
 address like dora@.com

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/validator/trunk@1723569 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                         |  3 +++
 .../validator/routines/EmailValidator.java      |  2 +-
 .../validator/routines/EmailValidatorTest.java  | 17 +++++++++++++++++
 3 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index fc00dba51..6f680d9f8 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -93,6 +93,9 @@ http://commons.apache.org/validator/dependencies.html
     <action issue="VALIDATOR-386" type="fix" dev="sebb" due-to="Auke van Leeuwen">
     org.apache.commons.validator.routines.DomainValidator.ArrayType is not public
     </action>
+    <action issue="VALIDATOR-359" type="fix" dev="sebb" due-to="Dora Kinghorn">
+    EmailValidator does not catch invalid email address like dora@.com
+    </action>
     <action type="update" dev="sebb">
     Updated to TLD list Version 2016010600, Last Updated Wed Jan  6 07:07:02 2016 UTC
     </action>
diff --git a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
index cd0c6c237..e344dcc45 100644
--- a/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
+++ b/src/main/java/org/apache/commons/validator/routines/EmailValidator.java
@@ -199,7 +199,7 @@ protected boolean isValidDomain(String domain) {
         DomainValidator domainValidator =
                 DomainValidator.getInstance(allowLocal);
         if (allowTld) {
-            return domainValidator.isValid(domain) || domainValidator.isValidTld(domain);
+            return domainValidator.isValid(domain) || (!domain.startsWith(".") && domainValidator.isValidTld(domain));
         } else {
             return domainValidator.isValid(domain);
         }
diff --git a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
index eb1659333..8c75d2888 100644
--- a/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
+++ b/src/test/java/org/apache/commons/validator/routines/EmailValidatorTest.java
@@ -509,6 +509,23 @@ public void testValidator365() {
                 "Maecenaspharetraeuismodmetusegetefficitur.Suspendisseamet@gmail.com"));
     }
 
+    /**
+     * Tests the e-mail validation with a user at a TLD
+     *
+     * http://tools.ietf.org/html/rfc5321#section-2.3.5
+     * (In the case of a top-level domain used by itself in an
+     * email address, a single string is used without any dots)
+     */
+    public void testEmailAtTLD() {
+        EmailValidator val = EmailValidator.getInstance(false, true);
+        assertTrue(val.isValid("test@com"));
+    }
+
+    public void testValidator359() {
+        EmailValidator val = EmailValidator.getInstance(false, true);
+        assertFalse(val.isValid("test@.com"));
+    }
+
     public void testValidator374() {
         assertTrue(validator.isValid("abc@school.school"));
     }
