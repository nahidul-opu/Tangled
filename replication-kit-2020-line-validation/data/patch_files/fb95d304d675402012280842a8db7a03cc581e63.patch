From 5e55a95bf8108dbb6bc6e2a0df598838edb6e82a Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Sun, 27 Sep 2009 21:27:25 +0000
Subject: [PATCH 1/6] Creating branch for Jira CONFIGURATION 390

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/CONFIGURATION_390@819412 13f79535-47bb-0310-9956-ffa450edef68

From 02a28021041977904fba631de4014db04b1ded37 Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Sun, 27 Sep 2009 22:28:16 +0000
Subject: [PATCH 2/6] Fixes for CONFIGURATION-390 and CONFIGURATION-397

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/CONFIGURATION_390@819418 13f79535-47bb-0310-9956-ffa450edef68
---
 conf/configA.xml                              |   3 +
 conf/configB.xml                              |   3 +
 conf/log4j-test.xml                           |  17 ++
 ...=> testFileReloadConfigurationBuilder.xml} |   8 +-
 ...> testFileReloadConfigurationBuilder2.xml} |   8 +-
 conf/testMultiConfiguration.xsd               |  97 +++++++
 conf/testMultiConfiguration_2001.xml          |  12 +
 conf/testMultiConfiguration_2002.xml          |  17 ++
 conf/testMultiConfiguration_3001.xml          |  24 ++
 conf/testMultiConfiguration_3002.xml          |  16 ++
 conf/testMultiConfiguration_default.xml       |   3 +-
 conf/testMultiTenentConfigurationBuilder2.xml |  35 +++
 conf/testMultiTenentConfigurationBuilder3.xml |  35 +++
 ...estVFSMultiTenentConfigurationBuilder1.xml |  36 +++
 ...estVFSMultiTenentConfigurationBuilder2.xml |  36 +++
 pom.xml                                       |   5 +
 .../AbstractFileConfiguration.java            |  48 +++-
 ...AbstractHierarchicalFileConfiguration.java |  97 +++++--
 .../configuration/CombinedConfiguration.java  | 190 ++++++++++++-
 .../configuration/DefaultFileSystem.java      |  12 +
 .../DynamicCombinedConfiguration.java         |   3 +
 .../HierarchicalConfiguration.java            |  10 +
 .../HierarchicalReloadableConfiguration.java  | 206 ++++++++++++++
 .../MultiFileHierarchicalConfiguration.java   |  28 +-
 .../configuration/SubnodeConfiguration.java   |   4 +-
 .../configuration/XMLConfiguration.java       |   2 +-
 .../FileChangedReloadingStrategy.java         |  37 +++
 .../configuration/reloading/Reloadable.java   |   9 +
 .../VFSFileChangedReloadingStrategy.java      | 204 ++++++++++++++
 .../VFSFileMonitorReloadingStrategy.java      | 245 -----------------
 .../apache/commons/configuration/Logging.java | 259 ++++++++++++++++++
 .../TestAbstractConfiguration.java            |   2 +-
 .../configuration/TestCatalogResolver.java    |   4 +-
 .../TestCombinedConfiguration.java            |  72 +++++
 ...estMultiFileHierarchicalConfiguration.java | 246 +++++++++++++++++
 .../TestVFSConfigurationBuilder.java          | 153 ++++++-----
 .../TestWebdavConfigurationBuilder.java       |  27 +-
 .../configuration/TestXMLConfiguration.java   |  44 +++
 .../FileRandomReloadingStrategy.java          |  31 +++
 .../TestFileChangedReloadingStrategy.java     |  49 ++++
 ... TestVFSFileChangedReloadingStrategy.java} | 137 +++------
 xdocs/changes.xml                             |   7 +
 xdocs/userguide/howto_filesystems.xml         |  18 +-
 xdocs/userguide/howto_multitenant.xml         |   8 +
 44 files changed, 2017 insertions(+), 490 deletions(-)
 create mode 100644 conf/configA.xml
 create mode 100644 conf/configB.xml
 create mode 100644 conf/log4j-test.xml
 rename conf/{testFileMonitorConfigurationBuilder.xml => testFileReloadConfigurationBuilder.xml} (91%)
 rename conf/{testFileMonitorConfigurationBuilder2.xml => testFileReloadConfigurationBuilder2.xml} (91%)
 create mode 100644 conf/testMultiConfiguration.xsd
 create mode 100644 conf/testMultiConfiguration_2001.xml
 create mode 100644 conf/testMultiConfiguration_2002.xml
 create mode 100644 conf/testMultiConfiguration_3001.xml
 create mode 100644 conf/testMultiConfiguration_3002.xml
 create mode 100644 conf/testMultiTenentConfigurationBuilder2.xml
 create mode 100644 conf/testMultiTenentConfigurationBuilder3.xml
 create mode 100644 conf/testVFSMultiTenentConfigurationBuilder1.xml
 create mode 100644 conf/testVFSMultiTenentConfigurationBuilder2.xml
 create mode 100644 src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
 create mode 100644 src/java/org/apache/commons/configuration/reloading/Reloadable.java
 create mode 100644 src/java/org/apache/commons/configuration/reloading/VFSFileChangedReloadingStrategy.java
 delete mode 100644 src/java/org/apache/commons/configuration/reloading/VFSFileMonitorReloadingStrategy.java
 create mode 100644 src/test/org/apache/commons/configuration/Logging.java
 create mode 100644 src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java
 rename src/test/org/apache/commons/configuration/reloading/{TestVFSFileMonitorReloadingStrategy.java => TestVFSFileChangedReloadingStrategy.java} (52%)

diff --git a/conf/configA.xml b/conf/configA.xml
new file mode 100644
index 0000000000..597bda042b
--- /dev/null
+++ b/conf/configA.xml
@@ -0,0 +1,3 @@
+<configuration>  
+  <property name="config" value="100"/>
+</configuration>
\ No newline at end of file
diff --git a/conf/configB.xml b/conf/configB.xml
new file mode 100644
index 0000000000..e496692b4a
--- /dev/null
+++ b/conf/configB.xml
@@ -0,0 +1,3 @@
+<configuration>
+  <stuff>test</stuff>
+</configuration>
\ No newline at end of file
diff --git a/conf/log4j-test.xml b/conf/log4j-test.xml
new file mode 100644
index 0000000000..63b009e739
--- /dev/null
+++ b/conf/log4j-test.xml
@@ -0,0 +1,17 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<!DOCTYPE log4j:configuration SYSTEM "log4j.dtd">
+
+<log4j:configuration xmlns:log4j="http://jakarta.apache.org/log4j/">
+  <appender name="console" class="org.apache.log4j.ConsoleAppender">
+    <param name="Target" value="System.out"/>
+    <layout class="org.apache.log4j.PatternLayout">
+      <param name="ConversionPattern" value="%-5p %c{1} - %m%n"/>
+    </layout>
+  </appender>
+
+  <root>
+    <priority value ="debug" />
+    <appender-ref ref="console" />
+  </root>
+
+</log4j:configuration>
\ No newline at end of file
diff --git a/conf/testFileMonitorConfigurationBuilder.xml b/conf/testFileReloadConfigurationBuilder.xml
similarity index 91%
rename from conf/testFileMonitorConfigurationBuilder.xml
rename to conf/testFileReloadConfigurationBuilder.xml
index 69041c0092..8e7e9d1670 100644
--- a/conf/testFileMonitorConfigurationBuilder.xml
+++ b/conf/testFileReloadConfigurationBuilder.xml
@@ -21,15 +21,15 @@
                config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="false">
        <expressionEngine
           config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
-       <reloadingStrategy delay="500"
-          config-class="org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy"/>
+       <reloadingStrategy refreshDelay="0"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
     </multifile>
     <xml fileName="testMultiConfiguration_default.xml"
          config-name="defaultConfig" delimiterParsingDisabled="true">
       <expressionEngine
           config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
-      <reloadingStrategy
-          config-class="org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy"/>
+      <reloadingStrategy refreshDelay="0"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
     </xml>
   </override>
 </configuration>
\ No newline at end of file
diff --git a/conf/testFileMonitorConfigurationBuilder2.xml b/conf/testFileReloadConfigurationBuilder2.xml
similarity index 91%
rename from conf/testFileMonitorConfigurationBuilder2.xml
rename to conf/testFileReloadConfigurationBuilder2.xml
index af69b3cbf3..226f22aecb 100644
--- a/conf/testFileMonitorConfigurationBuilder2.xml
+++ b/conf/testFileReloadConfigurationBuilder2.xml
@@ -21,15 +21,15 @@
                config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="false">
        <expressionEngine
           config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
-       <reloadingStrategy delay="500"
-          config-class="org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy"/>
+       <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
     </multifile>
     <xml fileName="testMultiConfiguration_default.xml"
          config-name="defaultConfig" delimiterParsingDisabled="true">
       <expressionEngine
           config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
-      <reloadingStrategy
-          config-class="org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy"/>
+      <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
     </xml>
   </override>
 </configuration>
\ No newline at end of file
diff --git a/conf/testMultiConfiguration.xsd b/conf/testMultiConfiguration.xsd
new file mode 100644
index 0000000000..b5a0ccc039
--- /dev/null
+++ b/conf/testMultiConfiguration.xsd
@@ -0,0 +1,97 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<xs:schema attributeFormDefault="unqualified" elementFormDefault="qualified" xmlns:xs="http://www.w3.org/2001/XMLSchema">
+  <xs:element name="configuration" type="configurationType"/>
+  <xs:complexType name="configurationType">
+    <xs:sequence>
+      <xs:element type="colorsType" name="colors" minOccurs="0"/>
+      <xs:element type="xs:integer" name="rowsPerPage" minOccurs="0"/>
+      <xs:element type="buttonsType" name="buttons" minOccurs="0"/>
+      <xs:element type="numberFormatType" name="numberFormat" minOccurs="0"/>
+      <xs:element type="splitType" name="split" minOccurs="0">
+        <xs:annotation>
+          <xs:documentation>Comma delimited lists</xs:documentation>
+        </xs:annotation>
+      </xs:element>
+      <xs:element type="ChannelsType" name="Channels" minOccurs="0"/>
+    </xs:sequence>
+  </xs:complexType>
+  <xs:complexType name="splitType">
+    <xs:sequence>
+      <xs:element type="xs:string" name="list1" minOccurs="0"/>
+      <xs:element type="xs:string" name="list2" minOccurs="0"/>
+      <xs:element type="list3Type" name="list3" minOccurs="0"/>
+      <xs:element type="list4Type" name="list4" minOccurs="0"/>
+    </xs:sequence>
+  </xs:complexType>
+  <xs:complexType name="colorsType">
+    <xs:sequence>
+      <xs:element type="xs:string" name="background" minOccurs="0"/>
+      <xs:element type="xs:string" name="text" minOccurs="0"/>
+      <xs:element type="xs:string" name="header" minOccurs="0"/>
+      <xs:element type="linkType" name="link" minOccurs="0"/>
+      <xs:element type="xs:string" name="default" minOccurs="0"/>
+    </xs:sequence>
+  </xs:complexType>
+  <xs:complexType name="list4Type">
+    <xs:simpleContent>
+      <xs:extension base="xs:string">
+        <xs:attribute type="xs:string" name="values"/>
+      </xs:extension>
+    </xs:simpleContent>
+  </xs:complexType>
+  <xs:complexType name="linkType">
+    <xs:simpleContent>
+      <xs:extension base="xs:string">
+        <xs:attribute type="xs:string" name="normal"/>
+        <xs:attribute type="xs:string" name="visited"/>
+      </xs:extension>
+    </xs:simpleContent>
+  </xs:complexType>
+  <xs:complexType name="list3Type">
+    <xs:simpleContent>
+      <xs:extension base="xs:string">
+        <xs:attribute type="xs:string" name="values"/>
+      </xs:extension>
+    </xs:simpleContent>
+  </xs:complexType>
+  <xs:complexType name="buttonsType">
+    <xs:sequence>
+      <xs:element type="xs:string" name="name" minOccurs="0"/>
+    </xs:sequence>
+  </xs:complexType>
+  <xs:complexType name="numberFormatType">
+    <xs:simpleContent>
+      <xs:extension base="xs:string">
+        <xs:attribute type="xs:string" name="pattern"/>
+      </xs:extension>
+    </xs:simpleContent>
+  </xs:complexType>
+  <xs:complexType name="ChannelType">
+    <xs:sequence>
+      <xs:element name="Name" minOccurs="0">
+        <xs:simpleType>
+          <xs:restriction base="xs:string">
+          </xs:restriction>
+        </xs:simpleType>
+      </xs:element>
+      <xs:element name="ChannelData" minOccurs="0">
+        <xs:simpleType>
+          <xs:restriction base="xs:string">
+          </xs:restriction>
+        </xs:simpleType>
+      </xs:element>
+      <xs:element name="MoreChannelData" minOccurs="0">
+        <xs:simpleType>
+          <xs:restriction base="xs:string">
+          </xs:restriction>
+        </xs:simpleType>
+      </xs:element>
+    </xs:sequence>
+    <xs:attribute type="xs:string" name="id" use="optional"/>
+  </xs:complexType>
+  <xs:complexType name="ChannelsType">
+    <xs:choice maxOccurs="unbounded" minOccurs="0">
+      <xs:element type="ChannelType" name="Channel" minOccurs="0"/>
+    </xs:choice>
+  </xs:complexType>
+</xs:schema>
\ No newline at end of file
diff --git a/conf/testMultiConfiguration_2001.xml b/conf/testMultiConfiguration_2001.xml
new file mode 100644
index 0000000000..b8c6208db9
--- /dev/null
+++ b/conf/testMultiConfiguration_2001.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<configuration
+           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+           xsi:noNamespaceSchemaLocation="http://commons.apache.org/testMultiConfiguration.xsd">
+  <colors>
+    <undefined>This will throw a schema exception</undefined>
+  </colors>
+  <buttons>
+    <name>OK-1,Cancel-2,Help-3</name>
+  </buttons>
+  <numberFormat pattern="###\,###.##"/>
+</configuration>
\ No newline at end of file
diff --git a/conf/testMultiConfiguration_2002.xml b/conf/testMultiConfiguration_2002.xml
new file mode 100644
index 0000000000..38b1c84ad5
--- /dev/null
+++ b/conf/testMultiConfiguration_2002.xml
@@ -0,0 +1,17 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<configuration
+           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+           xsi:noNamespaceSchemaLocation="http://commons.apache.org/testMultiConfiguration.xsd">
+  <colors>
+    <background>#2222222</background>
+    <text>#000000</text>
+    <header>#222222</header>
+    <link normal="#020202" visited="#202020"/>
+    <default>${colors.header3}</default>
+  </colors>
+  <rowsPerPage>25</rowsPerPage>
+  <buttons>
+    <name>OK-2,Cancel-2,Help-2</name>
+  </buttons>
+  <numberFormat pattern="###\,###.##"/>
+</configuration>
\ No newline at end of file
diff --git a/conf/testMultiConfiguration_3001.xml b/conf/testMultiConfiguration_3001.xml
new file mode 100644
index 0000000000..53b0e234b5
--- /dev/null
+++ b/conf/testMultiConfiguration_3001.xml
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+           xsi:noNamespaceSchemaLocation="http://commons.apache.org/testMultiConfiguration.xsd">
+  <colors>
+    <background>#808080</background>
+    <text>#000000</text>
+    <header>#008000</header>
+    <link normal="#000080" visited="#800080"/>
+    <default>${colors.header}</default>
+  </colors>
+  <rowsPerPage>15</rowsPerPage>
+  <buttons>
+    <name>OK,Cancel,Help</name>
+  </buttons>
+  <numberFormat pattern="###\,###.##"/>
+  <Channels>
+    <Channel id="1">
+      <Name>My Channel</Name>
+    </Channel>
+    <Channel id="2">
+      <MoreChannelData>more test 2 data</MoreChannelData>
+    </Channel>
+  </Channels>
+</configuration>
diff --git a/conf/testMultiConfiguration_3002.xml b/conf/testMultiConfiguration_3002.xml
new file mode 100644
index 0000000000..0e376d9298
--- /dev/null
+++ b/conf/testMultiConfiguration_3002.xml
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+           xsi:noNamespaceSchemaLocation="http://commons.apache.org/testMultiConfiguration.xsd">
+  <colors>
+    <background>#2222222</background>
+    <text>#000000</text>
+    <header>#222222</header>
+    <link normal="#020202" visited="#202020"/>
+    <default>${colors.header3}</default>
+  </colors>
+  <rowsPerPage>25</rowsPerPage>
+  <buttons>
+    <name>OK-2,Cancel-2,Help-2</name>
+  </buttons>
+  <numberFormat pattern="###\,###.##"/>
+</configuration>
diff --git a/conf/testMultiConfiguration_default.xml b/conf/testMultiConfiguration_default.xml
index 82b68ff469..850188be53 100644
--- a/conf/testMultiConfiguration_default.xml
+++ b/conf/testMultiConfiguration_default.xml
@@ -1,5 +1,6 @@
 <?xml version="1.0" encoding="ISO-8859-1" ?>
-<configuration>
+<configuration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+           xsi:noNamespaceSchemaLocation="http://commons.apache.org/testMultiConfiguration.xsd">
   <colors>
     <background>#40404040</background>
     <text>#000000</text>
diff --git a/conf/testMultiTenentConfigurationBuilder2.xml b/conf/testMultiTenentConfigurationBuilder2.xml
new file mode 100644
index 0000000000..39f030bea6
--- /dev/null
+++ b/conf/testMultiTenentConfigurationBuilder2.xml
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<!-- Test configuration definition file that demonstrates complex initialization -->
+<configuration>
+  <header>
+    <result delimiterParsingDisabled="true" forceReloadCheck="true" loggerName="TestLogger"
+            config-class="org.apache.commons.configuration.DynamicCombinedConfiguration"
+            keyPattern="$${sys:Id}">
+      <nodeCombiner config-class="org.apache.commons.configuration.tree.MergeCombiner"/>
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+    </result>
+    <entity-resolver catalogFiles="catalog.xml"/>
+    <providers>
+      <provider config-tag="multifile"
+         config-class="org.apache.commons.configuration.DefaultConfigurationBuilder$FileConfigurationProvider"
+         configurationClass="org.apache.commons.configuration.MultiFileHierarchicalConfiguration"/>
+    </providers>
+  </header>
+  <override>
+    <multifile filePattern="testMultiConfiguration_$$${sys:Id}.xml"
+               config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="true">
+       <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+       <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.FileChangedReloadingStrategy"/>
+    </multifile>
+    <xml fileName="testMultiConfiguration_default.xml"
+         config-name="defaultConfig" delimiterParsingDisabled="true" schemaValidation="true">
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+      <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.FileChangedReloadingStrategy"/>
+    </xml>
+  </override>
+</configuration>
\ No newline at end of file
diff --git a/conf/testMultiTenentConfigurationBuilder3.xml b/conf/testMultiTenentConfigurationBuilder3.xml
new file mode 100644
index 0000000000..8b1712d5d2
--- /dev/null
+++ b/conf/testMultiTenentConfigurationBuilder3.xml
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<!-- Test configuration definition file that demonstrates complex initialization -->
+<configuration>
+  <header>
+    <result delimiterParsingDisabled="true" forceReloadCheck="true" loggerName="TestLogger"
+            config-class="org.apache.commons.configuration.DynamicCombinedConfiguration"
+            keyPattern="$${sys:Id}">
+      <nodeCombiner config-class="org.apache.commons.configuration.tree.MergeCombiner"/>
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+    </result>
+    <entity-resolver catalogFiles="catalog.xml"/>
+    <providers>
+      <provider config-tag="multifile"
+         config-class="org.apache.commons.configuration.DefaultConfigurationBuilder$FileConfigurationProvider"
+         configurationClass="org.apache.commons.configuration.MultiFileHierarchicalConfiguration"/>
+    </providers>
+  </header>
+  <override>
+    <multifile filePattern="testwrite/testMultiConfiguration_$$${sys:Id}.xml"
+               config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="true">
+       <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+       <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.FileChangedReloadingStrategy"/>
+    </multifile>
+    <xml fileName="testMultiConfiguration_default.xml"
+         config-name="defaultConfig" delimiterParsingDisabled="true" schemaValidation="true">
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+      <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.FileChangedReloadingStrategy"/>
+    </xml>
+  </override>
+</configuration>
\ No newline at end of file
diff --git a/conf/testVFSMultiTenentConfigurationBuilder1.xml b/conf/testVFSMultiTenentConfigurationBuilder1.xml
new file mode 100644
index 0000000000..fec0a632c2
--- /dev/null
+++ b/conf/testVFSMultiTenentConfigurationBuilder1.xml
@@ -0,0 +1,36 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<!-- Test configuration definition file that demonstrates complex initialization -->
+<configuration>
+  <header>
+    <result delimiterParsingDisabled="true" forceReloadCheck="true" loggerName="TestLogger"
+            config-class="org.apache.commons.configuration.DynamicCombinedConfiguration"
+            keyPattern="$${sys:Id}">
+      <nodeCombiner config-class="org.apache.commons.configuration.tree.MergeCombiner"/>
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+    </result>
+    <fileSystem config-class="org.apache.commons.configuration.VFSFileSystem"/>     
+    <entity-resolver catalogFiles="catalog.xml"/>
+    <providers>
+      <provider config-tag="multifile"
+         config-class="org.apache.commons.configuration.DefaultConfigurationBuilder$FileConfigurationProvider"
+         configurationClass="org.apache.commons.configuration.MultiFileHierarchicalConfiguration"/>
+    </providers>
+  </header>
+  <override>
+    <multifile filePattern="testMultiConfiguration_$$${sys:Id}.xml"
+               config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="true">
+       <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+       <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
+    </multifile>
+    <xml fileName="testMultiConfiguration_default.xml"
+         config-name="defaultConfig" delimiterParsingDisabled="true" schemaValidation="true">
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+      <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
+    </xml>
+  </override>
+</configuration>
\ No newline at end of file
diff --git a/conf/testVFSMultiTenentConfigurationBuilder2.xml b/conf/testVFSMultiTenentConfigurationBuilder2.xml
new file mode 100644
index 0000000000..3d29aded3a
--- /dev/null
+++ b/conf/testVFSMultiTenentConfigurationBuilder2.xml
@@ -0,0 +1,36 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<!-- Test configuration definition file that demonstrates complex initialization -->
+<configuration>
+  <header>
+    <result delimiterParsingDisabled="true" forceReloadCheck="true" loggerName="TestLogger"
+            config-class="org.apache.commons.configuration.DynamicCombinedConfiguration"
+            keyPattern="$${sys:Id}">
+      <nodeCombiner config-class="org.apache.commons.configuration.tree.MergeCombiner"/>
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+    </result>
+    <fileSystem config-class="org.apache.commons.configuration.VFSFileSystem"/>
+    <entity-resolver catalogFiles="catalog.xml"/>
+    <providers>
+      <provider config-tag="multifile"
+         config-class="org.apache.commons.configuration.DefaultConfigurationBuilder$FileConfigurationProvider"
+         configurationClass="org.apache.commons.configuration.MultiFileHierarchicalConfiguration"/>
+    </providers>
+  </header>
+  <override>
+    <multifile filePattern="testwrite/testMultiConfiguration_$$${sys:Id}.xml"
+               config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="true">
+       <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+       <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
+    </multifile>
+    <xml fileName="testMultiConfiguration_default.xml"
+         config-name="defaultConfig" delimiterParsingDisabled="true" schemaValidation="true">
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+      <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
+    </xml>
+  </override>
+</configuration>
\ No newline at end of file
diff --git a/pom.xml b/pom.xml
index c9f36bb9f1..b98d977d81 100644
--- a/pom.xml
+++ b/pom.xml
@@ -462,6 +462,7 @@
             <include>testdb.script</include>
             <include>*.properties</include>
             <include>*.dtd</include>
+            <include>*.xsd</include>
           </includes>
         </testResource>
         <testResource>
@@ -494,6 +495,10 @@
                 <name>java.awt.headless</name>
                 <value>true</value>
               </property>
+              <property>
+                <name>org.apache.commons.logging.Log</name>
+                <value>org.apache.commons.configuration.Logging</value>
+              </property>
             </systemProperties>
           </configuration>
         </plugin>
diff --git a/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java b/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java
index a9b434e88b..5b8215dc84 100644
--- a/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java
+++ b/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java
@@ -103,7 +103,7 @@ public abstract class AbstractFileConfiguration
     protected ReloadingStrategy strategy;
 
     /** A lock object for protecting reload operations.*/
-    private Object reloadLock = new Object();
+    protected Object reloadLock = new Object();
 
     /** Stores the encoding of the configuration file.*/
     private String encoding;
@@ -207,6 +207,11 @@ public FileSystem getFileSystem()
         return this.fileSystem;
     }
 
+    public Object getReloadLock()
+    {
+        return reloadLock;
+    }
+
 
     /**
      * Load the configuration from the underlying location.
@@ -747,8 +752,11 @@ protected void possiblySave()
      */
     public void addProperty(String key, Object value)
     {
-        super.addProperty(key, value);
-        possiblySave();
+        synchronized(reloadLock)
+        {
+            super.addProperty(key, value);
+            possiblySave();
+        }
     }
 
     /**
@@ -761,14 +769,20 @@ public void addProperty(String key, Object value)
      */
     public void setProperty(String key, Object value)
     {
-        super.setProperty(key, value);
-        possiblySave();
+        synchronized(reloadLock)
+        {
+            super.setProperty(key, value);
+            possiblySave();
+        }
     }
 
     public void clearProperty(String key)
     {
-        super.clearProperty(key);
-        possiblySave();
+        synchronized(reloadLock)
+        {
+            super.clearProperty(key);
+            possiblySave();
+        }
     }
 
     public ReloadingStrategy getReloadingStrategy()
@@ -794,6 +808,11 @@ public void setReloadingStrategy(ReloadingStrategy strategy)
      * event.
      */
     public void reload()
+    {
+        reload(false);
+    }
+
+    public boolean reload(boolean checkReload)
     {
         synchronized (reloadLock)
         {
@@ -833,6 +852,10 @@ public void reload()
                 {
                     fireError(EVENT_RELOAD, null, null, e);
                     // todo rollback the changes if the file can't be reloaded
+                    if (checkReload)
+                    {
+                        return false;
+                    }
                 }
                 finally
                 {
@@ -840,6 +863,7 @@ public void reload()
                 }
             }
         }
+        return true;
     }
 
     /**
@@ -920,13 +944,19 @@ public Object getProperty(String key)
     public boolean isEmpty()
     {
         reload();
-        return super.isEmpty();
+        synchronized(reloadLock)
+        {
+            return super.isEmpty();
+        }
     }
 
     public boolean containsKey(String key)
     {
         reload();
-        return super.containsKey(key);
+        synchronized(reloadLock)
+        {
+            return super.containsKey(key);
+        }
     }
 
     /**
diff --git a/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java b/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
index 2a6a70fdea..41565055d7 100644
--- a/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
+++ b/src/java/org/apache/commons/configuration/AbstractHierarchicalFileConfiguration.java
@@ -29,7 +29,10 @@
 
 import org.apache.commons.configuration.event.ConfigurationEvent;
 import org.apache.commons.configuration.event.ConfigurationListener;
+import org.apache.commons.configuration.event.ConfigurationErrorListener;
+import org.apache.commons.configuration.event.ConfigurationErrorEvent;
 import org.apache.commons.configuration.reloading.ReloadingStrategy;
+import org.apache.commons.configuration.reloading.Reloadable;
 
 /**
  * <p>Base class for implementing file based hierarchical configurations.</p>
@@ -45,7 +48,8 @@
  */
 public abstract class AbstractHierarchicalFileConfiguration
 extends HierarchicalConfiguration
-implements FileConfiguration, ConfigurationListener, FileSystemBased
+implements FileConfiguration, ConfigurationListener, ConfigurationErrorListener, FileSystemBased,
+        Reloadable
 {
     /** Stores the delegate used for implementing functionality related to the
      * <code>FileConfiguration</code> interface.
@@ -137,26 +141,38 @@ private void initialize()
 
     protected void addPropertyDirect(String key, Object obj)
     {
-        super.addPropertyDirect(key, obj);
-        delegate.possiblySave();
+        synchronized(delegate.getReloadLock())
+        {
+            super.addPropertyDirect(key, obj);
+            delegate.possiblySave();
+        }
     }
 
     public void clearProperty(String key)
     {
-        super.clearProperty(key);
-        delegate.possiblySave();
+        synchronized(delegate.getReloadLock())
+        {
+            super.clearProperty(key);
+            delegate.possiblySave();
+        }
     }
 
     public void clearTree(String key)
     {
-        super.clearTree(key);
-        delegate.possiblySave();
+        synchronized(delegate.getReloadLock())
+        {
+            super.clearTree(key);
+            delegate.possiblySave();
+        }
     }
 
     public void setProperty(String key, Object value)
     {
-        super.setProperty(key, value);
-        delegate.possiblySave();
+        synchronized(delegate.getReloadLock())
+        {
+            super.setProperty(key, value);
+            delegate.possiblySave();
+        }
     }
 
     public void load() throws ConfigurationException
@@ -280,11 +296,16 @@ public void setReloadingStrategy(ReloadingStrategy strategy)
     }
 
     public void reload()
+    {
+        reload(false);
+    }
+
+    private boolean reload(boolean checkReload)
     {
         setDetailEvents(false);
         try
         {
-            delegate.reload();
+            return delegate.reload(checkReload);
         }
         finally
         {
@@ -302,34 +323,58 @@ public void setEncoding(String encoding)
         delegate.setEncoding(encoding);
     }
 
+    public Object getReloadLock()
+    {
+        return delegate.getReloadLock();
+    }
+
     public boolean containsKey(String key)
     {
         reload();
-        return super.containsKey(key);
+        synchronized(delegate.getReloadLock())
+        {
+            return super.containsKey(key);
+        }
     }
 
     public Iterator getKeys()
     {
         reload();
-        return super.getKeys();
+        synchronized(delegate.getReloadLock())
+        {
+            return super.getKeys();
+        }
     }
 
     public Iterator getKeys(String prefix)
     {
         reload();
-        return super.getKeys(prefix);
+        synchronized(delegate.getReloadLock())
+        {
+            return super.getKeys(prefix);
+        }
     }
 
     public Object getProperty(String key)
     {
-        reload();
-        return super.getProperty(key);
+        if (reload(true))
+        {
+            // Avoid reloading again and getting the same error.
+            synchronized(delegate.getReloadLock())
+            {
+                return super.getProperty(key);
+            }
+        }
+        return null;
     }
 
     public boolean isEmpty()
     {
         reload();
-        return super.isEmpty();
+        synchronized(delegate.getReloadLock())
+        {
+            return super.isEmpty();
+        }
     }
 
     /**
@@ -342,8 +387,11 @@ public boolean isEmpty()
      */
     public void addNodes(String key, Collection nodes)
     {
-        super.addNodes(key, nodes);
-        delegate.possiblySave();
+        synchronized(delegate.getReloadLock())
+        {
+            super.addNodes(key, nodes);
+            delegate.possiblySave();
+        }
     }
 
     /**
@@ -356,7 +404,10 @@ public void addNodes(String key, Collection nodes)
     protected List fetchNodeList(String key)
     {
         reload();
-        return super.fetchNodeList(key);
+        synchronized(delegate.getReloadLock())
+        {
+            return super.fetchNodeList(key);
+        }
     }
 
     /**
@@ -394,6 +445,8 @@ protected FileConfigurationDelegate createDelegate()
     private void initDelegate(FileConfigurationDelegate del)
     {
         del.addConfigurationListener(this);
+        del.addErrorListener(this);
+        del.setLogger(getLogger());
     }
 
     /**
@@ -418,6 +471,12 @@ public void configurationChanged(ConfigurationEvent event)
         }
     }
 
+    public void configurationError(ConfigurationErrorEvent event)
+    {
+        fireError(event.getType(), event.getPropertyName(), event.getPropertyValue(),
+                event.getCause());
+    }
+
     /**
      * Returns the file configuration delegate.
      *
diff --git a/src/java/org/apache/commons/configuration/CombinedConfiguration.java b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
index e697b7dffe..f76f4bbece 100644
--- a/src/java/org/apache/commons/configuration/CombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
@@ -37,6 +37,7 @@
 import org.apache.commons.configuration.tree.UnionCombiner;
 import org.apache.commons.configuration.tree.ViewNode;
 import org.apache.commons.configuration.tree.TreeUtils;
+import org.apache.commons.configuration.reloading.Reloadable;
 
 /**
  * <p>
@@ -169,7 +170,7 @@
  * @since 1.3
  * @version $Id$
  */
-public class CombinedConfiguration extends HierarchicalConfiguration implements
+public class CombinedConfiguration extends HierarchicalReloadableConfiguration implements
         ConfigurationListener, Cloneable
 {
     /**
@@ -204,6 +205,13 @@ public class CombinedConfiguration extends HierarchicalConfiguration implements
     /** Stores a map with the named configurations. */
     private Map namedConfigurations;
 
+    /** The default behavior is to ignore exceptions that occur during reload */
+    private boolean ignoreReloadExceptions = true;
+
+    //private final Object reloadLock = new Object();
+
+    private boolean reloadRequired = false;
+
     /**
      * An expression engine used for converting child configurations to
      * hierarchical ones.
@@ -237,6 +245,12 @@ public CombinedConfiguration()
         this(null);
     }
 
+    /*
+    public Object getReloadLock()
+    {
+        return reloadLock;
+    } */
+
     /**
      * Returns the node combiner that is used for creating the combined node
      * structure.
@@ -329,6 +343,26 @@ public void setConversionExpressionEngine(
         this.conversionExpressionEngine = conversionExpressionEngine;
     }
 
+    /**
+     * Retrieves the value of the ignoreReloadExceptions flag.
+     * @return true if exceptions are ignored, false otherwise.
+     */
+    public boolean isIgnoreReloadExceptions()
+    {
+        return ignoreReloadExceptions;
+    }
+
+    /**
+     * If set to true then exceptions that occur during reloading will be
+     * ignored. If false then the exceptions will be allowed to be thrown
+     * back to the caller.
+     * @param ignoreReloadExceptions true if exceptions should be ignored.
+     */
+    public void setIgnoreReloadExceptions(boolean ignoreReloadExceptions)
+    {
+        this.ignoreReloadExceptions = ignoreReloadExceptions;
+    }
+
     /**
      * Adds a new configuration to this combined configuration. It is possible
      * (but not mandatory) to give the new configuration a name. This name must
@@ -546,7 +580,7 @@ public Set getConfigurationNames()
      */
     public void invalidate()
     {
-        combinedRoot = null;
+        reloadRequired = true;
         fireEvent(EVENT_COMBINED_INVALIDATE, null, null, false);
     }
 
@@ -578,13 +612,153 @@ else if (!event.isBeforeUpdate())
      */
     public ConfigurationNode getRootNode()
     {
-        if (combinedRoot == null)
+        synchronized(getReloadLock())
+        {
+            if (reloadRequired || combinedRoot == null)
+            {
+                combinedRoot = constructCombinedNode();
+                reloadRequired = false;
+            }
+            return combinedRoot;
+        }
+    }
+    /*
+    public Object getProperty(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.getProperty(key);
+        }
+    }
+
+    protected void addPropertyDirect(String key, Object obj)
+    {
+        synchronized(reloadLock)
+        {
+            super.addPropertyDirect(key, obj);
+        }
+    }
+
+    public void addNodes(String key, Collection nodes)
+    {
+        synchronized(reloadLock)
+        {
+            super.addNodes(key, nodes);
+        }
+    }
+
+    public boolean isEmpty()
+    {
+        synchronized(reloadLock)
+        {
+            return super.isEmpty();
+        }
+    }
+
+    public Configuration subset(String prefix)
+    {
+        synchronized(reloadLock)
+        {
+            return super.subset(prefix);
+        }
+    }
+
+    public SubnodeConfiguration configurationAt(String key, boolean supportUpdates)
+    {
+        synchronized(reloadLock)
+        {
+            return super.configurationAt(key, supportUpdates);
+        }
+    }
+
+    public SubnodeConfiguration configurationAt(String key)
+    {
+        synchronized(reloadLock)
         {
-            combinedRoot = constructCombinedNode();
+            return super.configurationAt(key);
         }
-        return combinedRoot;
     }
 
+    public List configurationsAt(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.configurationsAt(key);
+        }
+    }
+
+    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node)
+    {
+        synchronized(reloadLock)
+        {
+            return super.createSubnodeConfiguration(node);
+        }
+    }
+
+    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node, String subnodeKey)
+    {
+        synchronized(reloadLock)
+        {
+            return super.createSubnodeConfiguration(node, subnodeKey);
+        }
+    }
+
+    public boolean containsKey(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.containsKey(key);
+        }
+    }
+
+    public void setProperty(String key, Object value)
+    {
+        synchronized(reloadLock)
+        {
+            super.setProperty(key, value);
+        }
+    }
+
+    public void clearTree(String key)
+    {
+        synchronized(reloadLock)
+        {
+            super.clearTree(key);
+        }
+    }
+
+    public void clearProperty(String key)
+    {
+        synchronized(reloadLock)
+        {
+            super.clearProperty(key);
+        }
+    }
+
+    public Iterator getKeys()
+    {
+        synchronized(reloadLock)
+        {
+            return super.getKeys();
+        }
+    }
+
+    public Iterator getKeys(String prefix)
+    {
+        synchronized(reloadLock)
+        {
+            return super.getKeys(prefix);
+        }
+    }
+
+    public int getMaxIndex(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.getMaxIndex(key);
+        }
+    } */
+
     /**
      * Clears this configuration. All contained configurations will be removed.
      */
@@ -716,8 +890,10 @@ protected void performReloadCheck()
             }
             catch (Exception ex)
             {
-                // ignore all exceptions, e.g. missing property exceptions
-                ;
+                if (!ignoreReloadExceptions)
+                {
+                    throw new ConfigurationRuntimeException(ex);
+                }
             }
         }
     }
diff --git a/src/java/org/apache/commons/configuration/DefaultFileSystem.java b/src/java/org/apache/commons/configuration/DefaultFileSystem.java
index f20a1855e3..69f1c01990 100644
--- a/src/java/org/apache/commons/configuration/DefaultFileSystem.java
+++ b/src/java/org/apache/commons/configuration/DefaultFileSystem.java
@@ -16,6 +16,9 @@
  */
 package org.apache.commons.configuration;
 
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
+
 import java.io.InputStream;
 import java.io.File;
 import java.io.IOException;
@@ -35,6 +38,11 @@
  */
 public class DefaultFileSystem extends FileSystem
 {
+    /**
+     * The Log for diagnostic messages.
+     */
+    private Log log = LogFactory.getLog(DefaultFileSystem.class);
+
     public InputStream getInputStream(String basePath, String fileName)
         throws ConfigurationException
     {
@@ -254,6 +262,10 @@ public URL locateFromURL(String basePath, String fileName)
         }
         catch (IOException e)
         {
+            if (log.isDebugEnabled())
+            {
+                log.debug("Could not locate file " + fileName + " at " + basePath + ": " + e.getMessage());
+            }
             return null;
         }
     }
diff --git a/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java b/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
index f8d5b21644..d7ae6582d5 100644
--- a/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
@@ -87,6 +87,7 @@ public DynamicCombinedConfiguration(NodeCombiner comb)
     {
         super();
         setNodeCombiner(comb);
+        setIgnoreReloadExceptions(false);
     }
 
     /**
@@ -98,6 +99,7 @@ public DynamicCombinedConfiguration(NodeCombiner comb)
     public DynamicCombinedConfiguration()
     {
         super();
+        setIgnoreReloadExceptions(false);
     }
 
     public void setKeyPattern(String pattern)
@@ -768,6 +770,7 @@ private CombinedConfiguration getCurrentConfig()
                         config.setLogger(log);
                     }
                 }
+                config.setIgnoreReloadExceptions(isIgnoreReloadExceptions());
                 config.setExpressionEngine(this.getExpressionEngine());
                 config.setDelimiterParsingDisabled(isDelimiterParsingDisabled());
                 config.setConversionExpressionEngine(getConversionExpressionEngine());
diff --git a/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java b/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java
index 28d9a62306..8a87b0752c 100644
--- a/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java
+++ b/src/java/org/apache/commons/configuration/HierarchicalConfiguration.java
@@ -193,6 +193,16 @@ public HierarchicalConfiguration(HierarchicalConfiguration c)
         }
     }
 
+    /**
+     * Object to synchronize on a reload. This class is not reloadable so this
+     * object isn't important
+     * @return
+     */
+    public Object getReloadLock()
+    {
+        return this;
+    }
+
     /**
      * Returns the root node of this hierarchical configuration. This method
      * exists for backwards compatibility only. New code should use the
diff --git a/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java b/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
new file mode 100644
index 0000000000..5210d1d804
--- /dev/null
+++ b/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
@@ -0,0 +1,206 @@
+package org.apache.commons.configuration;
+
+import org.apache.commons.configuration.tree.ConfigurationNode;
+import org.apache.commons.configuration.event.ConfigurationEvent;
+import org.apache.commons.configuration.reloading.Reloadable;
+
+import java.util.Collection;
+import java.util.List;
+import java.util.Iterator;
+
+/**
+ *
+ */
+public class HierarchicalReloadableConfiguration extends HierarchicalConfiguration
+    implements Reloadable
+{
+    private final Object reloadLock;
+
+    /**
+     * Creates a new instance of <code>HierarchicalReloadableConfiguration</code>.
+     */
+    public HierarchicalReloadableConfiguration()
+    {
+        super();
+        reloadLock = new Object();
+    }
+
+    public HierarchicalReloadableConfiguration(Object lock)
+    {
+        super();
+        reloadLock = lock == null ? new Object() : lock;
+    }
+
+    /**
+     * Creates a new instance of <code>HierarchicalConfiguration</code> and
+     * copies all data contained in the specified configuration into the new
+     * one.
+     *
+     * @param c the configuration that is to be copied (if <b>null</b>, this
+     * constructor will behave like the standard constructor)
+     * @since 1.4
+     */
+    public HierarchicalReloadableConfiguration(HierarchicalConfiguration c)
+    {
+        super(c);
+        reloadLock = new Object();
+    }
+
+
+    public Object getReloadLock()
+    {
+        return reloadLock;
+    }
+
+    public Object getProperty(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.getProperty(key);
+        }
+    }
+
+    protected void addPropertyDirect(String key, Object obj)
+    {
+        synchronized(reloadLock)
+        {
+            super.addPropertyDirect(key, obj);
+        }
+    }
+
+    public void addNodes(String key, Collection nodes)
+    {
+        synchronized(reloadLock)
+        {
+            super.addNodes(key, nodes);
+        }
+    }
+
+    public boolean isEmpty()
+    {
+        synchronized(reloadLock)
+        {
+            return super.isEmpty();
+        }
+    }
+
+    public Configuration subset(String prefix)
+    {
+        synchronized(reloadLock)
+        {
+            return super.subset(prefix);
+        }
+    }
+
+    public SubnodeConfiguration configurationAt(String key, boolean supportUpdates)
+    {
+        synchronized(reloadLock)
+        {
+            return super.configurationAt(key, supportUpdates);
+        }
+    }
+
+    public SubnodeConfiguration configurationAt(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.configurationAt(key);
+        }
+    }
+
+    public List configurationsAt(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.configurationsAt(key);
+        }
+    }
+
+    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node)
+    {
+        synchronized(reloadLock)
+        {
+            return super.createSubnodeConfiguration(node);
+        }
+    }
+
+    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node, String subnodeKey)
+    {
+        synchronized(reloadLock)
+        {
+            return super.createSubnodeConfiguration(node, subnodeKey);
+        }
+    }
+
+    protected void subnodeConfigurationChanged(ConfigurationEvent event)
+    {
+        synchronized(reloadLock)
+        {
+            super.subnodeConfigurationChanged(event);
+        }
+    }
+
+    void registerSubnodeConfiguration(SubnodeConfiguration config)
+    {
+        synchronized(reloadLock)
+        {
+            super.registerSubnodeConfiguration(config);
+        }
+    }
+
+    public boolean containsKey(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.containsKey(key);
+        }
+    }
+
+    public void setProperty(String key, Object value)
+    {
+        synchronized(reloadLock)
+        {
+            super.setProperty(key, value);
+        }
+    }
+
+    public void clearTree(String key)
+    {
+        synchronized(reloadLock)
+        {
+            super.clearTree(key);
+        }
+    }
+
+    public void clearProperty(String key)
+    {
+        synchronized(reloadLock)
+        {
+            super.clearProperty(key);
+        }
+    }
+
+    public Iterator getKeys()
+    {
+        synchronized(reloadLock)
+        {
+            return super.getKeys();
+        }
+    }
+
+    public Iterator getKeys(String prefix)
+    {
+        synchronized(reloadLock)
+        {
+            return super.getKeys(prefix);
+        }
+    }
+
+    public int getMaxIndex(String key)
+    {
+        synchronized(reloadLock)
+        {
+            return super.getMaxIndex(key);
+        }
+    }
+}
diff --git a/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java b/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
index dfc84798ac..809e16e588 100644
--- a/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
+++ b/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
@@ -43,6 +43,7 @@
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
 import org.xml.sax.EntityResolver;
+import org.xml.sax.SAXParseException;
 
 /**
  * This class provides access to multiple configuration files that reside in a location that
@@ -92,7 +93,7 @@ protected synchronized Object initialValue()
     private boolean attributeSplittingDisabled;
 
     /** The Logger name to use */
-    private String loggerName = "";
+    private String loggerName = MultiFileHierarchicalConfiguration.class.getName();
 
     /** The Reloading strategy to use on created configurations */
     private ReloadingStrategy fileStrategy;
@@ -107,6 +108,7 @@ public MultiFileHierarchicalConfiguration()
     {
         super();
         this.init = true;
+        setLogger(LogFactory.getLog(loggerName));
     }
 
     /**
@@ -621,6 +623,14 @@ public void configurationError(ConfigurationErrorEvent event)
                 listener.configurationError(event);
             }
         }
+
+        if (event.getType() == AbstractFileConfiguration.EVENT_RELOAD)
+        {
+            if (isThrowable(event.getCause()))
+            {
+                throw new ConfigurationRuntimeException(event.getCause());
+            }
+        }
     }
 
     /*
@@ -730,7 +740,7 @@ public void save() throws ConfigurationException
         }
         catch (ConfigurationException ce)
         {
-            if (!ignoreException)
+            if (isThrowable(ce))
             {
                 throw new ConfigurationRuntimeException(ce);
             }
@@ -746,6 +756,20 @@ public void save() throws ConfigurationException
         return configuration;
     }
 
+    private boolean isThrowable(Throwable throwable)
+    {
+        if (!ignoreException)
+        {
+            return true;
+        }
+        Throwable cause = throwable.getCause();
+        while (cause != null && !(cause instanceof SAXParseException))
+        {
+            cause = cause.getCause();
+        }
+        return cause != null;
+    }
+
     /**
      * Clone the FileReloadingStrategy since each file needs its own.
      * @return A new FileReloadingStrategy.
diff --git a/src/java/org/apache/commons/configuration/SubnodeConfiguration.java b/src/java/org/apache/commons/configuration/SubnodeConfiguration.java
index 4b6f941ff3..457e8142da 100644
--- a/src/java/org/apache/commons/configuration/SubnodeConfiguration.java
+++ b/src/java/org/apache/commons/configuration/SubnodeConfiguration.java
@@ -23,6 +23,7 @@
 
 import org.apache.commons.configuration.interpol.ConfigurationInterpolator;
 import org.apache.commons.configuration.tree.ConfigurationNode;
+import org.apache.commons.configuration.reloading.Reloadable;
 
 /**
  * <p>
@@ -114,7 +115,7 @@
  * @author Oliver Heger
  * @version $Id$
  */
-public class SubnodeConfiguration extends HierarchicalConfiguration
+public class SubnodeConfiguration extends HierarchicalReloadableConfiguration
 {
     /**
      * The serial version UID.
@@ -136,6 +137,7 @@ public class SubnodeConfiguration extends HierarchicalConfiguration
      */
     public SubnodeConfiguration(HierarchicalConfiguration parent, ConfigurationNode root)
     {
+        super(parent instanceof Reloadable ? ((Reloadable) parent).getReloadLock() : null);
         if (parent == null)
         {
             throw new IllegalArgumentException(
diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index 89dd9b1f3b..c44e7be16c 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -939,11 +939,11 @@ private void load(InputSource source) throws ConfigurationException
         }
         catch (SAXParseException spe)
         {
-            this.getLogger().debug("Error parsing " + source.getSystemId(), spe);
             throw new ConfigurationException("Error parsing " + source.getSystemId(), spe);
         }
         catch (Exception e)
         {
+            this.getLogger().debug("Unable to load the configuraton", e);
             throw new ConfigurationException("Unable to load the configuration", e);
         }
     }
diff --git a/src/java/org/apache/commons/configuration/reloading/FileChangedReloadingStrategy.java b/src/java/org/apache/commons/configuration/reloading/FileChangedReloadingStrategy.java
index b2b390a475..ad54ea29b6 100644
--- a/src/java/org/apache/commons/configuration/reloading/FileChangedReloadingStrategy.java
+++ b/src/java/org/apache/commons/configuration/reloading/FileChangedReloadingStrategy.java
@@ -23,6 +23,8 @@
 
 import org.apache.commons.configuration.ConfigurationUtils;
 import org.apache.commons.configuration.FileConfiguration;
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
 
 /**
  * <p>A reloading strategy that will reload the configuration every time its
@@ -64,6 +66,9 @@ public class FileChangedReloadingStrategy implements ReloadingStrategy
     /** A flag whether a reload is required.*/
     private boolean reloading;
 
+    /** The Log to use for diagnostic messages */
+    private Log logger = LogFactory.getLog(FileChangedReloadingStrategy.class);
+
     public void setConfiguration(FileConfiguration configuration)
     {
         this.configuration = configuration;
@@ -85,6 +90,10 @@ public boolean reloadingRequired()
                 lastChecked = now;
                 if (hasChanged())
                 {
+                    if (logger.isDebugEnabled())
+                    {
+                        logger.debug("File change detected: " + getName());
+                    }
                     reloading = true;
                 }
             }
@@ -141,6 +150,11 @@ protected boolean hasChanged()
         File file = getFile();
         if (file == null || !file.exists())
         {
+            if (logger.isWarnEnabled() && lastModified != 0)
+            {
+                logger.warn("File was deleted: " + getName(file));
+                lastModified = 0;
+            }
             return false;
         }
 
@@ -186,4 +200,27 @@ private File fileFromURL(URL url)
             return ConfigurationUtils.fileFromURL(url);
         }
     }
+
+    private String getName()
+    {
+        return getName(getFile());
+    }
+
+    private String getName(File file)
+    {
+        String name = configuration.getURL().toString();
+        if (name == null)
+        {
+            if (file != null)
+            {
+                name = file.getAbsolutePath();
+            }
+            else
+            {
+                name = "base: " + configuration.getBasePath()
+                       + "file: " + configuration.getFileName();
+            }
+        }
+        return name;
+    }
 }
diff --git a/src/java/org/apache/commons/configuration/reloading/Reloadable.java b/src/java/org/apache/commons/configuration/reloading/Reloadable.java
new file mode 100644
index 0000000000..88a486c708
--- /dev/null
+++ b/src/java/org/apache/commons/configuration/reloading/Reloadable.java
@@ -0,0 +1,9 @@
+package org.apache.commons.configuration.reloading;
+
+/**
+ * Interface that allows other objects to synchronize on a root lock.
+ */
+public interface Reloadable
+{
+    Object getReloadLock();
+}
diff --git a/src/java/org/apache/commons/configuration/reloading/VFSFileChangedReloadingStrategy.java b/src/java/org/apache/commons/configuration/reloading/VFSFileChangedReloadingStrategy.java
new file mode 100644
index 0000000000..8b54b69eb4
--- /dev/null
+++ b/src/java/org/apache/commons/configuration/reloading/VFSFileChangedReloadingStrategy.java
@@ -0,0 +1,204 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.commons.configuration.reloading;
+
+import org.apache.commons.configuration.FileConfiguration;
+import org.apache.commons.configuration.FileSystemBased;
+import org.apache.commons.configuration.FileSystem;
+import org.apache.commons.configuration.ConfigurationRuntimeException;
+import org.apache.commons.vfs.FileSystemManager;
+import org.apache.commons.vfs.FileObject;
+import org.apache.commons.vfs.VFS;
+import org.apache.commons.vfs.FileSystemException;
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
+
+/**
+ * <p>A reloading strategy that will reload the configuration every time its
+ * underlying file is changed.</p>
+ * <p>This reloading strategy does not actively monitor a configuration file,
+ * but is triggered by its associated configuration whenever properties are
+ * accessed. It then checks the configuration file's last modification date
+ * and causes a reload if this has changed.</p>
+ * <p>To avoid permanent disc access on successive property lookups a refresh
+ * delay can be specified. This has the effect that the configuration file's
+ * last modification date is only checked once in this delay period. The default
+ * value for this refresh delay is 5 seconds.</p>
+ * <p>This strategy only works with FileConfiguration instances.</p>
+ *
+ * @author Emmanuel Bourg
+ * @version $Revision$, $Date$
+ * @since 1.1
+ */
+public class VFSFileChangedReloadingStrategy implements ReloadingStrategy
+{
+    /** Constant for the default refresh delay.*/
+    private static final int DEFAULT_REFRESH_DELAY = 5000;
+
+    /** Stores a reference to the configuration to be monitored.*/
+    protected FileConfiguration configuration;
+
+    /** The last time the configuration file was modified. */
+    protected long lastModified;
+
+    /** The last time the file was checked for changes. */
+    protected long lastChecked;
+
+    /** The minimum delay in milliseconds between checks. */
+    protected long refreshDelay = DEFAULT_REFRESH_DELAY;
+
+    /** A flag whether a reload is required.*/
+    private boolean reloading;
+
+    /** Stores the logger.*/
+    private Log log = LogFactory.getLog(getClass());
+
+    public void setConfiguration(FileConfiguration configuration)
+    {
+        this.configuration = configuration;
+    }
+
+    public void init()
+    {
+        if (configuration.getURL() == null && configuration.getFileName() == null)
+        {
+            return;
+        }
+        if (this.configuration == null)
+        {
+            throw new IllegalStateException("No configuration has been set for this strategy");
+        }
+        updateLastModified();
+    }
+
+    public boolean reloadingRequired()
+    {
+        if (!reloading)
+        {
+            long now = System.currentTimeMillis();
+
+            if (now > lastChecked + refreshDelay)
+            {
+                lastChecked = now;
+                if (hasChanged())
+                {
+                    reloading = true;
+                }
+            }
+        }
+
+        return reloading;
+    }
+
+    public void reloadingPerformed()
+    {
+        updateLastModified();
+    }
+
+    /**
+     * Return the minimal time in milliseconds between two reloadings.
+     *
+     * @return the refresh delay (in milliseconds)
+     */
+    public long getRefreshDelay()
+    {
+        return refreshDelay;
+    }
+
+    /**
+     * Set the minimal time between two reloadings.
+     *
+     * @param refreshDelay refresh delay in milliseconds
+     */
+    public void setRefreshDelay(long refreshDelay)
+    {
+        this.refreshDelay = refreshDelay;
+    }
+
+    /**
+     * Update the last modified time.
+     */
+    protected void updateLastModified()
+    {
+        FileObject file = getFile();
+        if (file != null)
+        {
+            try
+            {
+                lastModified = file.getContent().getLastModifiedTime();
+            }
+            catch (FileSystemException fse)
+            {
+                log.error("Unable to get last modified time for" + file.getName().getURI());
+            }
+        }
+        reloading = false;
+    }
+
+    /**
+     * Check if the configuration has changed since the last time it was loaded.
+     *
+     * @return a flag whether the configuration has changed
+     */
+    protected boolean hasChanged()
+    {
+        FileObject file = getFile();
+        try
+        {
+            if (file == null || !file.exists())
+            {
+                return false;
+            }
+
+            return file.getContent().getLastModifiedTime() > lastModified;
+        }
+        catch (FileSystemException ex)
+        {
+            log.error("Unable to get last modified time for" + file.getName().getURI());
+            return false;
+        }
+    }
+
+    /**
+     * Returns the file that is monitored by this strategy. Note that the return
+     * value can be <b>null </b> under some circumstances.
+     *
+     * @return the monitored file
+     */
+    protected FileObject getFile()
+    {
+        try
+        {
+            FileSystemManager fsManager = VFS.getManager();
+            FileSystem fs = ((FileSystemBased) configuration).getFileSystem();
+            String uri = fs.getPath(null, configuration.getURL(), configuration.getBasePath(),
+                configuration.getFileName());
+            if (uri == null)
+            {
+                throw new ConfigurationRuntimeException("Unable to determine file to monitor");
+            }
+            return fsManager.resolveFile(uri);
+        }
+        catch (FileSystemException fse)
+        {
+            String msg = "Unable to monitor " + configuration.getURL().toString();
+            log.error(msg);
+            throw new ConfigurationRuntimeException(msg, fse);
+        }
+    }
+}
diff --git a/src/java/org/apache/commons/configuration/reloading/VFSFileMonitorReloadingStrategy.java b/src/java/org/apache/commons/configuration/reloading/VFSFileMonitorReloadingStrategy.java
deleted file mode 100644
index c749477b7d..0000000000
--- a/src/java/org/apache/commons/configuration/reloading/VFSFileMonitorReloadingStrategy.java
+++ /dev/null
@@ -1,245 +0,0 @@
-/*
- * Licensed to the Apache Software Foundation (ASF) under one or more
- * contributor license agreements.  See the NOTICE file distributed with
- * this work for additional information regarding copyright ownership.
- * The ASF licenses this file to You under the Apache License, Version 2.0
- * (the "License"); you may not use this file except in compliance with
- * the License.  You may obtain a copy of the License at
- *
- *     http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package org.apache.commons.configuration.reloading;
-
-import org.apache.commons.configuration.FileConfiguration;
-import org.apache.commons.configuration.FileSystemBased;
-import org.apache.commons.configuration.ConfigurationRuntimeException;
-import org.apache.commons.configuration.FileSystem;
-import org.apache.commons.configuration.AbstractFileConfiguration;
-
-import org.apache.commons.vfs.impl.DefaultFileMonitor;
-import org.apache.commons.vfs.FileListener;
-import org.apache.commons.vfs.FileChangeEvent;
-import org.apache.commons.vfs.FileObject;
-import org.apache.commons.vfs.VFS;
-import org.apache.commons.vfs.FileSystemManager;
-import org.apache.commons.vfs.FileSystemException;
-
-import java.util.Iterator;
-import java.util.Map;
-import java.util.HashMap;
-
-/**
- * <p>A reloading strategy that will reload the configuration every time its
- * underlying file is changed.</p>
- * @since 1.7
- * @author <a
- * href="http://commons.apache.org/configuration/team-list.html">Commons Configuration team</a>
- */
-public class VFSFileMonitorReloadingStrategy implements ReloadingStrategy, FileListener
-{
-    /** Used to synchronize initialization of the monitor. */
-    private static final String INIT_GATE = "gate";
-
-    /** The FileMonitor */
-    private static DefaultFileMonitor fm;
-
-    /** The files being monitored */
-    private static Map strategies = new HashMap();
-
-    /** Mimimum delay value */
-    private static final long DEFAULT_DELAY = 1000;
-
-    /** Stores a reference to the configuration to be monitored. */
-    protected FileConfiguration configuration;
-
-    /** The reload status */
-    private boolean reloadRequired;
-
-    /** Delay interval between checking the files. */
-    private long delay;
-
-    /**
-     * Return the current delay interval.
-     * @return The delay interval.
-     */
-    public long getDelay()
-    {
-        return fm.getDelay();
-    }
-
-    /**
-     * Request a new delay interval. If the interval specified is less than
-     * what the monitor is currently using the interval will be ignored. If
-     * this method is called after the strategy has started it will be ignored.
-     * @param delay The requested delay interval.
-     */
-    public void setDelay(long delay)
-    {
-        this.delay = delay;
-    }
-
-    /**
-     * Specify the configuration to monitor. The configuration must be set before
-     * init is called.
-     * @param configuration The configuration to monitor.
-     */
-    public void setConfiguration(FileConfiguration configuration)
-    {
-        if (configuration == null || configuration instanceof FileSystemBased)
-        {
-            this.configuration = configuration;
-        }
-        else
-        {
-            throw new ConfigurationRuntimeException("Configuration must be based on a FileSystem");
-        }
-    }
-
-    /**
-     * Initialize the ReloadingStrategy.
-     */
-    public void init()
-    {
-        if (configuration.getURL() == null && configuration.getFileName() == null)
-        {
-            return;
-        }
-        if (this.configuration == null)
-        {
-            throw new IllegalStateException("No configuration has been set for this strategy");
-        }
-        FileObject file;
-
-        try
-        {
-            FileSystemManager fsManager = VFS.getManager();
-            FileSystem fs = ((FileSystemBased) configuration).getFileSystem();
-            String uri = fs.getPath(null, configuration.getURL(), configuration.getBasePath(),
-                configuration.getFileName());
-            if (uri == null)
-            {
-                throw new ConfigurationRuntimeException("Unable to determine file to monitor");
-            }
-            file = fsManager.resolveFile(uri);
-        }
-        catch (FileSystemException fse)
-        {
-            String msg = "Unable to monitor " + configuration.getURL().toString();
-            throw new ConfigurationRuntimeException(msg, fse);
-        }
-        synchronized (INIT_GATE)
-        {
-            if (fm == null)
-            {
-                fm = new DefaultFileMonitor(null);
-                long delayTime = (delay > DEFAULT_DELAY) ? delay : DEFAULT_DELAY;
-                fm.setDelay(delayTime);
-                fm.start();
-            }
-            else
-            {
-                long delayTime = fm.getDelay();
-                if (delay > delayTime)
-                {
-                    fm.setDelay(delay);
-                }
-            }
-            file.getFileSystem().addListener(file, this);
-            fm.addFile(file);
-            strategies.put(file, this);
-        }
-
-    }
-
-    /**
-     * Shutdown all reloading strategies
-     */
-    public static void stopMonitor()
-    {
-        synchronized (INIT_GATE)
-        {
-            if (fm != null)
-            {
-                fm.stop();
-                fm = null;
-            }
-
-            Iterator iter = strategies.entrySet().iterator();
-
-            while (iter.hasNext())
-            {
-                Map.Entry entry = (Map.Entry) iter.next();
-                FileObject file = (FileObject) entry.getKey();
-                VFSFileMonitorReloadingStrategy strategy = (VFSFileMonitorReloadingStrategy) entry.getValue();
-                file.getFileSystem().removeListener(file, strategy);
-            }
-            strategies.clear();
-        }
-    }
-
-    /**
-     * Tell if the evaluation of the strategy requires to reload the configuration.
-     *
-     * @return a flag whether a reload should be performed
-     */
-    public boolean reloadingRequired()
-    {
-        return reloadRequired;
-    }
-
-    /**
-     * Notify the strategy that the file has been reloaded.
-     */
-    public void reloadingPerformed()
-    {
-        reloadRequired = false;
-    }
-
-
-    /**
-     * Called when a file is created.
-     * @param event The event.
-     * @throws Exception If an error occurs.
-     */
-    public void fileCreated(FileChangeEvent event) throws Exception
-    {
-        reloadRequired = true;
-        fireEvent();
-    }
-
-    /**
-     * Called when a file is deleted.
-     * @param event The event.
-     * @throws Exception If an error occurs.
-     */
-    public void fileDeleted(FileChangeEvent event) throws Exception
-    {
-        // Ignore this event
-    }
-
-    /**
-     * Called when a file is changed.
-     * @param event The event.
-     * @throws Exception If an exception occurs.
-     */
-    public void fileChanged(FileChangeEvent event) throws Exception
-    {
-        reloadRequired = true;
-        fireEvent();
-    }
-
-    private void fireEvent()
-    {
-        if (configuration instanceof AbstractFileConfiguration)
-        {
-            ((AbstractFileConfiguration) configuration).configurationChanged();
-        }
-    }
-
-}
diff --git a/src/test/org/apache/commons/configuration/Logging.java b/src/test/org/apache/commons/configuration/Logging.java
new file mode 100644
index 0000000000..f7ff94ab10
--- /dev/null
+++ b/src/test/org/apache/commons/configuration/Logging.java
@@ -0,0 +1,259 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.commons.configuration;
+
+import org.apache.commons.logging.impl.Log4JLogger;
+import org.apache.log4j.Priority;
+import org.apache.log4j.Level;
+import org.apache.log4j.Appender;
+import org.apache.log4j.PatternLayout;
+import org.apache.log4j.ConsoleAppender;
+
+/**
+ * Configures logging for tests.
+ *
+ * When running with Maven do -Dmaven.surefire.debug="LogLevel=level" to set the
+ * Log Level to the desired value.
+ */
+public class Logging extends Log4JLogger
+{
+    /**
+     * The fully qualified name of the Log4JLogger class.
+     */
+    private static final String FQCN = Logging.class.getName();
+
+    private static Priority traceLevel;
+
+    static
+    {
+        // Releases of log4j1.2 >= 1.2.12 have Priority.TRACE available, earlier
+        // versions do not. If TRACE is not available, then we have to map
+        // calls to Log.trace(...) onto the DEBUG level.
+
+        try
+        {
+            traceLevel = (Priority) Level.class.getDeclaredField("TRACE").get(null);
+        }
+        catch (Exception ex)
+        {
+            // ok, trace not available
+            traceLevel = Priority.DEBUG;
+        }
+
+        String level = System.getProperty("LogLevel");
+        if (level != null)
+        {
+            org.apache.log4j.Logger log = org.apache.log4j.Logger.getRootLogger();
+            log.setLevel(Level.toLevel(level));
+            Appender appender = new ConsoleAppender(new PatternLayout("%p - %m%n"), ConsoleAppender.SYSTEM_OUT);
+            log.addAppender(appender);
+        }
+    }
+
+    public Logging()
+    {
+        super();
+    }
+
+
+    /**
+     * Base constructor.
+     */
+    public Logging(String name)
+    {
+        super(name);
+    }
+
+    /**
+     * For use with a log4j factory.
+     */
+    public Logging(org.apache.log4j.Logger logger)
+    {
+        super(logger);
+    }
+
+    // ---------------------------------------------------------
+    // Implementation
+    //
+    // Note that in the methods below the Priority class is used to define
+    // levels even though the Level class is supported in 1.2. This is done
+    // so that at compile time the call definitely resolves to a call to
+    // a method that takes a Priority rather than one that takes a Level.
+    //
+    // The Category class (and hence its subclass Logging) in version 1.2 only
+    // has methods that take Priority objects. The Category class (and hence
+    // Logging class) in version 1.3 has methods that take both Priority and
+    // Level objects. This means that if we use Level here, and compile
+    // against log4j 1.3 then calls would be bound to the versions of
+    // methods taking Level objects and then would fail to run against
+    // version 1.2 of log4j.
+    // ---------------------------------------------------------
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.TRACE</code>.
+     * When using a log4j version that does not support the <code>TRACE</code>
+     * level, the message will be logged at the <code>DEBUG</code> level.
+     *
+     * @param message to log
+     * @see org.apache.commons.logging.Log#trace(Object)
+     */
+    public void trace(Object message)
+    {
+        getLogger().log(FQCN, traceLevel, message, null);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.TRACE</code>.
+     * When using a log4j version that does not support the <code>TRACE</code>
+     * level, the message will be logged at the <code>DEBUG</code> level.
+     *
+     * @param message to log
+     * @param t       log this cause
+     * @see org.apache.commons.logging.Log#trace(Object, Throwable)
+     */
+    public void trace(Object message, Throwable t)
+    {
+        getLogger().log(FQCN, traceLevel, message, t);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.DEBUG</code>.
+     *
+     * @param message to log
+     * @see org.apache.commons.logging.Log#debug(Object)
+     */
+    public void debug(Object message)
+    {
+        getLogger().log(FQCN, Priority.DEBUG, message, null);
+    }
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.DEBUG</code>.
+     *
+     * @param message to log
+     * @param t       log this cause
+     * @see org.apache.commons.logging.Log#debug(Object, Throwable)
+     */
+    public void debug(Object message, Throwable t)
+    {
+        getLogger().log(FQCN, Priority.DEBUG, message, t);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.INFO</code>.
+     *
+     * @param message to log
+     * @see org.apache.commons.logging.Log#info(Object)
+     */
+    public void info(Object message)
+    {
+        getLogger().log(FQCN, Priority.INFO, message, null);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.INFO</code>.
+     *
+     * @param message to log
+     * @param t       log this cause
+     * @see org.apache.commons.logging.Log#info(Object, Throwable)
+     */
+    public void info(Object message, Throwable t)
+    {
+        getLogger().log(FQCN, Priority.INFO, message, t);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.WARN</code>.
+     *
+     * @param message to log
+     * @see org.apache.commons.logging.Log#warn(Object)
+     */
+    public void warn(Object message)
+    {
+        getLogger().log(FQCN, Priority.WARN, message, null);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.WARN</code>.
+     *
+     * @param message to log
+     * @param t       log this cause
+     * @see org.apache.commons.logging.Log#warn(Object, Throwable)
+     */
+    public void warn(Object message, Throwable t)
+    {
+        getLogger().log(FQCN, Priority.WARN, message, t);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.ERROR</code>.
+     *
+     * @param message to log
+     * @see org.apache.commons.logging.Log#error(Object)
+     */
+    public void error(Object message)
+    {
+        getLogger().log(FQCN, Priority.ERROR, message, null);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.ERROR</code>.
+     *
+     * @param message to log
+     * @param t       log this cause
+     * @see org.apache.commons.logging.Log#error(Object, Throwable)
+     */
+    public void error(Object message, Throwable t)
+    {
+        getLogger().log(FQCN, Priority.ERROR, message, t);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.FATAL</code>.
+     *
+     * @param message to log
+     * @see org.apache.commons.logging.Log#fatal(Object)
+     */
+    public void fatal(Object message)
+    {
+        getLogger().log(FQCN, Priority.FATAL, message, null);
+    }
+
+
+    /**
+     * Logs a message with <code>org.apache.log4j.Priority.FATAL</code>.
+     *
+     * @param message to log
+     * @param t       log this cause
+     * @see org.apache.commons.logging.Log#fatal(Object, Throwable)
+     */
+    public void fatal(Object message, Throwable t)
+    {
+        getLogger().log(FQCN, Priority.FATAL, message, t);
+    }
+
+}
diff --git a/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java b/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java
index 0c425d644b..61a607bc55 100644
--- a/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestAbstractConfiguration.java
@@ -152,7 +152,7 @@ public void testSetLogger()
         assertNotNull("Default logger is null", config.getLogger());
         Log log = LogFactory.getLog(config.getClass());
         config.setLogger(log);
-        assertSame("Logger was not set", log, config.getLogger());
+        assertSame("Logging was not set", log, config.getLogger());
     }
 
     /**
diff --git a/src/test/org/apache/commons/configuration/TestCatalogResolver.java b/src/test/org/apache/commons/configuration/TestCatalogResolver.java
index 0b7f5356b0..75d64bef22 100644
--- a/src/test/org/apache/commons/configuration/TestCatalogResolver.java
+++ b/src/test/org/apache/commons/configuration/TestCatalogResolver.java
@@ -85,8 +85,8 @@ public void testLogger() throws Exception
     {
         Log log = LogFactory.getLog(this.getClass());
         resolver.setLogger(log);
-        assertNotNull("No Logger returned", resolver.getLogger());
-        assertTrue("Incorrect Logger", log == resolver.getLogger());
+        assertNotNull("No Logging returned", resolver.getLogger());
+        assertTrue("Incorrect Logging", log == resolver.getLogger());
     }
 
 }
diff --git a/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java b/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java
index 420b28e459..21612461ba 100644
--- a/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java
@@ -34,10 +34,13 @@
 import org.apache.commons.configuration.event.ConfigurationEvent;
 import org.apache.commons.configuration.event.ConfigurationListener;
 import org.apache.commons.configuration.reloading.FileAlwaysReloadingStrategy;
+import org.apache.commons.configuration.reloading.FileRandomReloadingStrategy;
 import org.apache.commons.configuration.tree.DefaultExpressionEngine;
 import org.apache.commons.configuration.tree.NodeCombiner;
 import org.apache.commons.configuration.tree.OverrideCombiner;
 import org.apache.commons.configuration.tree.UnionCombiner;
+import org.apache.commons.configuration.tree.MergeCombiner;
+import org.apache.commons.configuration.tree.xpath.XPathExpressionEngine;
 
 /**
  * Test class for CombinedConfiguration.
@@ -764,6 +767,75 @@ public void testReloadWithSubNodeConfig() throws Exception
                 .getInt("xmlReload1"));
     }
 
+    public void testConcurrentGetAndReload() throws Exception
+    {
+        final int threadCount = 5;
+        final int loopCount = 1000;
+        config.setForceReloadCheck(true);
+        config.setNodeCombiner(new MergeCombiner());
+        final XMLConfiguration xml = new XMLConfiguration("configA.xml");
+        xml.setReloadingStrategy(new FileRandomReloadingStrategy());
+        config.addConfiguration(xml);
+        final XMLConfiguration xml2 = new XMLConfiguration("configB.xml");
+        xml2.setReloadingStrategy(new FileRandomReloadingStrategy());
+        config.addConfiguration(xml2);
+        config.setExpressionEngine(new XPathExpressionEngine());
+
+        assertEquals(config.getString("/property[@name='config']/@value"), "100");
+
+        Thread testThreads[] = new Thread[threadCount];
+        int failures[] = new int[threadCount];
+
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i] = new ReloadThread(config, failures, i, loopCount);
+            testThreads[i].start();
+        }
+
+        int totalFailures = 0;
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i].join();
+            totalFailures += failures[i];
+        }
+        assertTrue(totalFailures + " failures Occurred", totalFailures == 0);
+    }
+
+    private class ReloadThread extends Thread
+    {
+        CombinedConfiguration combined;
+        int[] failures;
+        int index;
+        int count;
+
+        ReloadThread(CombinedConfiguration config, int[] failures, int index, int count)
+        {
+            combined = config;
+            this.failures = failures;
+            this.index = index;
+            this.count = count;
+        }
+        public void run()
+        {
+            failures[index] = 0;
+            for (int i = 0; i < count; i++)
+            {
+                try
+                {
+                    String value = combined.getString("/property[@name='config']/@value");
+                    if (value == null || !value.equals("100"))
+                    {
+                        ++failures[index];
+                    }
+                }
+                catch (Exception ex)
+                {
+                    ++failures[index];
+                }
+            }
+        }
+    }
+
     /**
      * Helper method for writing a file. The file is also added to a list and
      * will be deleted in teadDown() automatically.
diff --git a/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java b/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java
index 2759cad192..6da689a54e 100644
--- a/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java
@@ -19,6 +19,9 @@
 
 import junit.framework.TestCase;
 import org.apache.commons.configuration.reloading.FileChangedReloadingStrategy;
+import org.xml.sax.SAXParseException;
+
+import java.io.*;
 
 /**
  * Unit test for simple MultiConfigurationTest.
@@ -27,6 +30,15 @@ public class TestMultiFileHierarchicalConfiguration extends TestCase
 {
     private static String PATTERN1 = "target/test-classes/testMultiConfiguration_${sys:Id}.xml";
 
+    private static final File MULTI_TENENT_FILE = new File(
+            "conf/testMultiTenentConfigurationBuilder2.xml");
+
+    private static final File MULTI_TENENT_FILE2 = new File(
+            "target/test-classes/testMultiTenentConfigurationBuilder2.xml");
+
+    private static final File MULTI_RELOAD_FILE = new File(
+            "conf/testMultiTenentConfigurationBuilder3.xml");
+
     /**
      * Rigourous Test :-)
      */
@@ -48,4 +60,238 @@ public void testMultiConfiguration()
         System.setProperty("Id", "1003");
         assertTrue(config.getInt("rowsPerPage") == 35);
     }
+
+    public void testSchemaValidationError() throws Exception
+    {
+        System.clearProperty("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+        try
+        {
+            System.setProperty("Id", "2001");
+            config.getInt("rowsPerPage");
+            fail("No exception thrown");
+        }
+        catch (Exception ex)
+        {
+            Throwable cause = ex.getCause();
+            while (cause != null && !(cause instanceof SAXParseException))
+            {
+                cause = cause.getCause();
+            }
+            assertTrue("SAXParseException was not thrown", cause instanceof SAXParseException);
+        }
+    }
+
+    public void testSchemaValidation() throws Exception
+    {
+        System.clearProperty("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+        System.setProperty("Id", "2002");
+        int rows = config.getInt("rowsPerPage");
+        assertTrue("expected: " + rows + " actual: " + "25", 25 == rows);
+    }
+
+    public void testMissingFile() throws Exception
+    {
+        System.clearProperty("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+        System.setProperty("Id", "3099");
+        int rows = config.getInt("rowsPerPage");
+        assertTrue("expected: " + rows + " actual: " + "50", 50 == rows);
+
+    }
+
+    public void testFileReload1() throws Exception
+    {
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_RELOAD_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+
+        // create a new configuration
+        File input = new File("target/test-classes/testMultiConfiguration_3001.xml");
+        File output = new File("target/test-classes/testwrite/testMultiConfiguration_3001.xml");
+        output.delete();
+        output.getParentFile().mkdir();
+        copyFile(input, output);
+
+        assertNotNull(config);
+        verify("3001", config, 15);
+        Thread.sleep(1100);
+        XMLConfiguration x = new XMLConfiguration();
+        x.setFile(output);
+        x.setAttributeSplittingDisabled(true);
+        x.setDelimiterParsingDisabled(true);
+        x.load();
+        x.setProperty("rowsPerPage", "35");
+        //Insure orginal timestamp and new timestamp aren't the same second.
+        Thread.sleep(1100);
+        x.save();
+        verify("3001", config, 35);
+        output.delete();
+    }
+
+    public void testFileReload2() throws Exception
+    {
+        // create a new configuration
+        File input = new File("target/test-classes/testMultiConfiguration_3002.xml");
+        File output = new File("target/test-classes/testwrite/testMultiConfiguration_3002.xml");
+        output.delete();
+
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_RELOAD_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+        assertNotNull(config);
+        // The file should not exist yet.
+        verify("3002", config, 50);
+
+        output.getParentFile().mkdir();
+        copyFile(input, output);
+        Thread.sleep(600);
+        verify("3002", config, 25);
+        output.delete();
+    }
+
+    public void testFileReload3() throws Exception
+    {
+        // create a new configuration
+        File input = new File("target/test-classes/testMultiConfiguration_3001.xml");
+        File output = new File("target/test-classes/testwrite/testMultiConfiguration_3001.xml");
+        output.delete();
+        output.getParentFile().mkdir();
+
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_RELOAD_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+        assertNotNull(config);
+        //The file does not exist yet.
+        verify("3001", config, 50);
+        copyFile(input, output);
+        //Sleep so refreshDelay elapses
+        Thread.sleep(600);
+        verify("3001", config, 15);
+        Thread.sleep(500);
+        XMLConfiguration x = new XMLConfiguration();
+        x.setFile(output);
+        x.setAttributeSplittingDisabled(true);
+        x.setDelimiterParsingDisabled(true);
+        x.load();
+        x.setProperty("rowsPerPage", "35");
+        // Insure original timestamp and new timestamp are not the same second.
+        Thread.sleep(1100);
+        x.save();
+        verify("3001", config, 35);
+        output.delete();
+    }
+
+
+    public void testReloadDefault() throws Exception
+    {
+        // create a new configuration
+        String defaultName = "target/test-classes/testMultiConfiguration_default.xml";
+        File input = new File(defaultName);
+
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE2);
+        CombinedConfiguration config = factory.getConfiguration(true);
+        assertNotNull(config);
+        verify("3001", config, 15);
+        verify("3002", config, 25);
+        System.setProperty("Id", "3002");
+        config.addProperty("/ TestProp", "Test");
+        assertTrue("Property not added", "Test".equals(config.getString("TestProp")));
+        System.getProperties().remove("Id");
+        //Sleep so refreshDelay elapses
+        Thread.sleep(600);
+        long time = System.currentTimeMillis();
+        long original = input.lastModified();
+        input.setLastModified(time);
+        File defaultFile = new File(defaultName);
+        long newTime = defaultFile.lastModified();
+        assertTrue("time mismatch", original != newTime);
+        Thread.sleep(600);
+        verify("3001", config, 15);
+        verify("3002", config, 25);
+        System.setProperty("Id", "3002");
+        String test = config.getString("TestProp");
+        assertNull("Property was not cleared by reload", test);
+    }
+
+
+    public void testFileReloadSchemaValidationError() throws Exception
+    {
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_RELOAD_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+
+        // create a new configuration
+        File input = new File("target/test-classes/testMultiConfiguration_3001.xml");
+        File output = new File("target/test-classes/testwrite/testMultiConfiguration_3001.xml");
+        output.delete();
+        output.getParentFile().mkdir();
+        copyFile(input, output);
+
+        assertNotNull(config);
+        verify("3001", config, 15);
+        Thread.sleep(1100);
+        XMLConfiguration x = new XMLConfiguration();
+        x.setFile(output);
+        x.setAttributeSplittingDisabled(true);
+        x.setDelimiterParsingDisabled(true);
+        x.load();
+        x.setProperty("rowsPerPage", "test");
+        //Insure orginal timestamp and new timestamp aren't the same second.
+        Thread.sleep(1100);
+        x.save();
+        System.setProperty("Id", "3001");
+        try
+        {
+            config.getInt("rowsPerPage");
+            fail("No exception was thrown");
+        }
+        catch (Exception ex)
+        {
+
+        }
+
+        output.delete();
+    }
+
+    private void copyFile(File input, File output) throws IOException
+    {
+        Reader reader = new FileReader(input);
+        Writer writer = new FileWriter(output);
+        char[] buffer = new char[4096];
+        int n = 0;
+        while (-1 != (n = reader.read(buffer)))
+        {
+            writer.write(buffer, 0, n);
+        }
+        reader.close();
+        writer.close();
+    }
+
+    private void verify(String key, CombinedConfiguration config, int rows)
+    {
+        if (key == null)
+        {
+            System.getProperties().remove("Id");
+        }
+        else
+        {
+            System.setProperty("Id", key);
+        }
+        int actual = config.getInt("rowsPerPage");
+        assertTrue("expected: " + rows + " actual: " + actual, actual == rows);
+    }
 }
diff --git a/src/test/org/apache/commons/configuration/TestVFSConfigurationBuilder.java b/src/test/org/apache/commons/configuration/TestVFSConfigurationBuilder.java
index 0ba9fce295..cc99f158de 100644
--- a/src/test/org/apache/commons/configuration/TestVFSConfigurationBuilder.java
+++ b/src/test/org/apache/commons/configuration/TestVFSConfigurationBuilder.java
@@ -31,7 +31,6 @@
 
 import org.apache.commons.configuration.beanutils.BeanHelper;
 import org.apache.commons.configuration.reloading.FileChangedReloadingStrategy;
-import org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy;
 import org.apache.commons.configuration.tree.DefaultConfigurationNode;
 import org.apache.commons.configuration.tree.xpath.XPathExpressionEngine;
 import org.apache.commons.configuration.event.ConfigurationListener;
@@ -91,14 +90,17 @@ public class TestVFSConfigurationBuilder extends TestCase implements Configurati
     private static final File FILESYSTEM_FILE = new File(
             "conf/testFileSystem.xml");
 
-    private static final File FILEMONITOR_FILE = new File(
-            "target/test-classes/testFileMonitorConfigurationBuilder.xml");
+    private static final File FILERELOAD_FILE = new File(
+            "target/test-classes/testFileReloadConfigurationBuilder.xml");
 
-    private static final File FILEMONITOR2_FILE = new File(
-            "target/test-classes/testFileMonitorConfigurationBuilder2.xml");
+    private static final File FILERELOAD2_FILE = new File(
+            "target/test-classes/testFileReloadConfigurationBuilder2.xml");
 
-    private static final String FILEMONITOR_URI = "file://" + System.getProperty("user.dir")
-            + "/target/test-classes/testFileMonitorConfigurationBuilder2.xml";
+      private static final File MULTI_RELOAD_FILE1 = new File(
+            "target/test-classes/testVFSMultiTenentConfigurationBuilder1.xml");
+
+    private static final File MULTI_RELOAD_FILE2 = new File(
+            "target/test-classes/testVFSMultiTenentConfigurationBuilder2.xml");
 
     /** Constant for the name of an optional configuration.*/
     private static final String OPTIONAL_NAME = "optionalConfig";
@@ -109,12 +111,6 @@ public class TestVFSConfigurationBuilder extends TestCase implements Configurati
     /** Stores the object to be tested. */
     DefaultConfigurationBuilder factory;
 
-    public TestVFSConfigurationBuilder()
-    {
-        super();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
-    }
-
     protected void setUp() throws Exception
     {
         super.setUp();
@@ -1005,7 +1001,7 @@ else if (conf instanceof CombinedConfiguration)
         }
     }
 
-    public void testFileMonitor1() throws Exception
+    public void testFileReload1() throws Exception
     {
         // create a new configuration
         File input = new File("target/test-classes/testMultiConfiguration_1001.xml");
@@ -1013,116 +1009,147 @@ public void testFileMonitor1() throws Exception
         output.delete();
         output.getParentFile().mkdir();
         copyFile(input, output);
+        // Sleep to make sure the file timestamp is not in the same second as "now".
+        Thread.sleep(1100);
 
-        factory.setFile(FILEMONITOR_FILE);
+        factory.setFile(FILERELOAD_FILE);
         FileSystem.resetDefaultFileSystem();
         System.getProperties().remove("Id");
 
         CombinedConfiguration config = factory.getConfiguration(true);
         assertNotNull(config);
-        config.addConfigurationListener(this);
         verify("1001", config, 15);
-
-        // Allow time for FileMonitor to set up.
-        Thread.sleep(1000);
         XMLConfiguration x = new XMLConfiguration(output);
         x.setProperty("rowsPerPage", "50");
         x.save();
-
-        waitForChange();
         verify("1001", config, 50);
         output.delete();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
     }
 
-    public void testFileMonitor2() throws Exception
+    public void testFileReload2() throws Exception
     {
         // create a new configuration
         File input = new File("target/test-classes/testMultiConfiguration_1002.xml");
         File output = new File("target/test-classes/testwrite/testMultiConfiguration_1002.xml");
         output.delete();
 
-        factory.setFile(FILEMONITOR_FILE);
+        factory.setFile(FILERELOAD_FILE);
         FileSystem.resetDefaultFileSystem();
         System.getProperties().remove("Id");
 
         CombinedConfiguration config = factory.getConfiguration(true);
-        config.addConfigurationListener(this);
         assertNotNull(config);
 
         verify("1002", config, 50);
-        Thread.sleep(1000);
-
+        // Sleep to make sure the file timestamp is not in the same second as "now".
+        Thread.sleep(1100);
         output.getParentFile().mkdir();
         copyFile(input, output);
-
-        // Allow time for the monitor to notice the change.
-        //Thread.sleep(2000);
-        waitForChange();
         verify("1002", config, 25);
         output.delete();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
     }
 
-
-    public void testFileMonitor3() throws Exception
+    public void testFileReload3() throws Exception
     {
         // create a new configuration
         File input = new File("target/test-classes/testMultiConfiguration_1001.xml");
         File output = new File("target/test-classes/testwrite/testMultiConfiguration_1001.xml");
         output.delete();
         output.getParentFile().mkdir();
-        copyFile(input, output);
 
-        factory.setFile(FILEMONITOR2_FILE);
+        factory.setFile(FILERELOAD_FILE);
+        FileSystem.resetDefaultFileSystem();
         System.getProperties().remove("Id");
 
         CombinedConfiguration config = factory.getConfiguration(true);
         assertNotNull(config);
-        config.addConfigurationListener(this);
+        verify("1001", config, 50);
+        copyFile(input, output);
+        // Sleep to make sure the file timestamp is not in the same second as "now".
+        Thread.sleep(1100);
         verify("1001", config, 15);
-
-        // Allow time for FileMonitor to set up.
-        Thread.sleep(1000);
         XMLConfiguration x = new XMLConfiguration(output);
-        x.setProperty("rowsPerPage", "50");
+        x.setProperty("rowsPerPage", "25");
         x.save();
-        // Let FileMonitor detect the change.
-        //Thread.sleep(2000);
-        waitForChange();
-        verify("1001", config, 50);
+         // Sleep to make sure the file timestamp is not in the same second as "now".
+        Thread.sleep(1100);
+        verify("1001", config, 25);
         output.delete();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
     }
 
-    public void testFileMonitor4() throws Exception
+    public void testReloadDefault() throws Exception
     {
         // create a new configuration
-        File input = new File("target/test-classes/testMultiConfiguration_1002.xml");
-        File output = new File("target/test-classes/testwrite/testMultiConfiguration_1002.xml");
-        output.delete();
+        String defaultName = "target/test-classes/testMultiConfiguration_default.xml";
+        File input = new File(defaultName);
 
-        factory.setFileName(FILEMONITOR_URI);
         System.getProperties().remove("Id");
-
+        factory.setFile(MULTI_RELOAD_FILE1);
         CombinedConfiguration config = factory.getConfiguration(true);
         assertNotNull(config);
-        config.addConfigurationListener(this);
+        verify("3001", config, 15);
+        verify("3002", config, 25);
+        System.setProperty("Id", "3002");
+        config.addProperty("/ TestProp", "Test");
+        assertTrue("Property not added", "Test".equals(config.getString("TestProp")));
+        System.getProperties().remove("Id");
+        //Sleep so refreshDelay elapses
+        Thread.sleep(600);
+        long time = System.currentTimeMillis();
+        long original = input.lastModified();
+        input.setLastModified(time);
+        File defaultFile = new File(defaultName);
+        long newTime = defaultFile.lastModified();
+        assertTrue("time mismatch", original != newTime);
+        Thread.sleep(600);
+        verify("3001", config, 15);
+        verify("3002", config, 25);
+        System.setProperty("Id", "3002");
+        String test = config.getString("TestProp");
+        assertNull("Property was not cleared by reload", test);
+    }
 
-        verify("1002", config, 50);
-        Thread.sleep(1000);
 
+    public void testFileReloadSchemaValidationError() throws Exception
+    {
+        System.getProperties().remove("Id");
+        factory.setFile(MULTI_RELOAD_FILE2);
+        CombinedConfiguration config = factory.getConfiguration(true);
+
+        // create a new configuration
+        File input = new File("target/test-classes/testMultiConfiguration_3001.xml");
+        File output = new File("target/test-classes/testwrite/testMultiConfiguration_3001.xml");
+        output.delete();
         output.getParentFile().mkdir();
         copyFile(input, output);
 
-        // Allow time for the monitor to notice the change.
-        //Thread.sleep(2000);
-        waitForChange();
-        verify("1002", config, 25);
+        assertNotNull(config);
+        verify("3001", config, 15);
+        Thread.sleep(1100);
+        XMLConfiguration x = new XMLConfiguration();
+        x.setFile(output);
+        x.setAttributeSplittingDisabled(true);
+        x.setDelimiterParsingDisabled(true);
+        x.load();
+        x.setProperty("rowsPerPage", "test");
+        //Insure orginal timestamp and new timestamp aren't the same second.
+        Thread.sleep(1100);
+        x.save();
+        System.setProperty("Id", "3001");
+        try
+        {
+            config.getInt("rowsPerPage");
+            fail("No exception was thrown");
+        }
+        catch (Exception ex)
+        {
+
+        }
+
         output.delete();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
     }
 
+
     private void copyFile(File input, File output) throws IOException
     {
         Reader reader = new FileReader(input);
@@ -1161,7 +1188,11 @@ private void waitForChange()
                 int count = 0;
                 while (!configChanged && count++ <= 3)
                 {
-                    this.wait(5000);
+                    this.wait(2000);
+                }
+                if (!configChanged)
+                {
+                  throw new IllegalStateException("No change detected");
                 }
             }
             catch (InterruptedException ie)
diff --git a/src/test/org/apache/commons/configuration/TestWebdavConfigurationBuilder.java b/src/test/org/apache/commons/configuration/TestWebdavConfigurationBuilder.java
index 3b4e116265..b19fa49b12 100644
--- a/src/test/org/apache/commons/configuration/TestWebdavConfigurationBuilder.java
+++ b/src/test/org/apache/commons/configuration/TestWebdavConfigurationBuilder.java
@@ -21,7 +21,6 @@
 import java.io.Reader;
 import java.io.FileReader;
 import java.io.Writer;
-import java.io.FileWriter;
 import java.io.OutputStreamWriter;
 import java.util.Collection;
 import java.util.HashMap;
@@ -32,7 +31,6 @@
 
 import org.apache.commons.configuration.beanutils.BeanHelper;
 import org.apache.commons.configuration.reloading.FileChangedReloadingStrategy;
-import org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy;
 import org.apache.commons.configuration.tree.DefaultConfigurationNode;
 import org.apache.commons.configuration.tree.xpath.XPathExpressionEngine;
 import org.apache.commons.configuration.event.ConfigurationEvent;
@@ -42,7 +40,6 @@
 import org.apache.commons.vfs.VFS;
 import org.apache.commons.vfs.FileName;
 import org.apache.commons.vfs.FileSystemOptions;
-import org.apache.commons.vfs.FileContent;
 
 /**
  * Test class for DefaultConfigurationBuilder.
@@ -93,13 +90,13 @@ public class TestWebdavConfigurationBuilder extends TestCase
     private static final String MULTI_TENENT_FILE =
             "testMultiTenentConfigurationBuilder.xml";
 
-    private static final String FILEMONITOR2_FILE =
-            "testFileMonitorConfigurationBuilder2.xml";
+    private static final String FILERELOAD2_FILE =
+            "testFileReloadConfigurationBuilder2.xml";
 
-    private static final String FILEMONITOR_1001_FILE =
+    private static final String FILERELOAD_1001_FILE =
             "testwrite/testMultiConfiguration_1001.xml";
 
-    private static final String FILEMONITOR_1002_FILE =
+    private static final String FILERELOAD_1002_FILE =
             "testwrite/testMultiConfiguration_1002.xml";
 
     private static final String TEST_PROPERTIES = "test.properties.xml";
@@ -900,16 +897,16 @@ public void testMultiTenentConfiguration3() throws Exception
         verify("1005", config, 50);
     }
 
-    public void testFileMonitor1() throws Exception
+    public void testFileChanged() throws Exception
     {
         // create a new configuration
         File input = new File("target/test-classes/testMultiConfiguration_1001.xml");
-        FileObject output = getFile(getBasePath() + FILEMONITOR_1001_FILE);
+        FileObject output = getFile(getBasePath() + FILERELOAD_1001_FILE);
         output.delete();
         output.getParent().createFolder();
         copyFile(input, output);
 
-        factory.setFileName(getBasePath() + FILEMONITOR2_FILE);
+        factory.setFileName(getBasePath() + FILERELOAD2_FILE);
         System.getProperties().remove("Id");
 
         CombinedConfiguration config = factory.getConfiguration(true);
@@ -919,7 +916,7 @@ public void testFileMonitor1() throws Exception
 
         // Allow time for FileMonitor to set up.
         Thread.sleep(1000);
-        XMLConfiguration x = new XMLConfiguration(getBasePath() + FILEMONITOR_1001_FILE);
+        XMLConfiguration x = new XMLConfiguration(getBasePath() + FILERELOAD_1001_FILE);
         x.setProperty("rowsPerPage", "50");
         x.save();
         // Let FileMonitor detect the change.
@@ -927,17 +924,16 @@ public void testFileMonitor1() throws Exception
         waitForChange();
         verify("1001", config, 50);
         output.delete();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
     }
 
-    public void testFileMonitor2() throws Exception
+    public void testFileChanged2() throws Exception
     {
         // create a new configuration
         File input = new File("target/test-classes/testMultiConfiguration_1002.xml");
-        FileObject output = getFile(getBasePath() + FILEMONITOR_1002_FILE);
+        FileObject output = getFile(getBasePath() + FILERELOAD_1002_FILE);
         output.delete();
 
-        factory.setFileName(getBasePath() + FILEMONITOR2_FILE);
+        factory.setFileName(getBasePath() + FILERELOAD2_FILE);
         System.getProperties().remove("Id");
 
         CombinedConfiguration config = factory.getConfiguration(true);
@@ -955,7 +951,6 @@ public void testFileMonitor2() throws Exception
         waitForChange();
         verify("1002", config, 25);
         output.delete();
-        VFSFileMonitorReloadingStrategy.stopMonitor();
     }
 
 
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 4166e2e166..509f87b1ef 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -1597,6 +1597,50 @@ public void testSaveWithValidationFailure() throws Exception
         }
     }
 
+    public void testConcurrentGetAndReload() throws Exception
+    {
+        //final FileConfiguration config = new PropertiesConfiguration("test.properties");
+        final FileConfiguration config = new XMLConfiguration("test.xml");
+        config.setReloadingStrategy(new FileAlwaysReloadingStrategy());
+
+        assertTrue("Property not found", config.getProperty("test.short") != null);
+
+        Thread testThreads[] = new Thread[5];
+
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i] = new ReloadThread(config);
+            testThreads[i].start();
+        }
+
+        for (int i = 0; i < 2000; i++)
+        {
+            assertTrue("Property not found", config.getProperty("test.short") != null); 
+        }
+
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i].join();
+        }
+    }
+
+    private class ReloadThread extends Thread
+    {
+        FileConfiguration config;
+
+        ReloadThread(FileConfiguration config)
+        {
+            this.config = config;
+        }
+        public void run()
+        {
+            for (int i = 0; i < 1000; i++)
+            {
+                config.reload();
+            }
+        }
+    }
+
     /**
      * Prepares a configuration object for testing a reload operation.
      *
diff --git a/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java b/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java
new file mode 100644
index 0000000000..6e9b580265
--- /dev/null
+++ b/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java
@@ -0,0 +1,31 @@
+package org.apache.commons.configuration.reloading;
+
+import java.io.File;
+import java.util.Random;
+
+/**
+ * A ReloadingStrategy that randomly returns true or false;
+ */
+public class FileRandomReloadingStrategy extends FileChangedReloadingStrategy
+{
+    Random random = new Random();
+    /**
+     * Checks whether a reload is necessary.
+     *
+     * @return a flag whether a reload is required
+     */
+    public boolean reloadingRequired()
+    {
+        return random.nextBoolean();
+    }
+
+    /**
+     * Returns the file that is watched by this strategy.
+     *
+     * @return the monitored file
+     */
+    public File getMonitoredFile()
+    {
+        return getFile();
+    }
+}
diff --git a/src/test/org/apache/commons/configuration/reloading/TestFileChangedReloadingStrategy.java b/src/test/org/apache/commons/configuration/reloading/TestFileChangedReloadingStrategy.java
index b31ba22920..8e2cd6e914 100644
--- a/src/test/org/apache/commons/configuration/reloading/TestFileChangedReloadingStrategy.java
+++ b/src/test/org/apache/commons/configuration/reloading/TestFileChangedReloadingStrategy.java
@@ -19,6 +19,7 @@
 
 import java.io.File;
 import java.io.FileWriter;
+import java.io.ByteArrayOutputStream;
 import java.net.URL;
 
 import junit.framework.TestCase;
@@ -26,6 +27,12 @@
 import org.apache.commons.configuration.ConfigurationException;
 import org.apache.commons.configuration.PropertiesConfiguration;
 import org.apache.commons.configuration.XMLConfiguration;
+import org.apache.log4j.Logger;
+import org.apache.log4j.Layout;
+import org.apache.log4j.PatternLayout;
+import org.apache.log4j.Appender;
+import org.apache.log4j.WriterAppender;
+import org.apache.log4j.Level;
 
 /**
  * Test case for the ReloadableConfiguration class.
@@ -163,4 +170,46 @@ protected boolean hasChanged()
         strategy.reloadingPerformed();
         assertFalse("Reloading still required", strategy.reloadingRequired());
     }
+
+    public void testFileDeletion() throws Exception
+    {
+        Logger logger = Logger.getLogger(FileChangedReloadingStrategy.class.getName());
+        Layout layout = new PatternLayout("%p - %m%n");
+        ByteArrayOutputStream os = new ByteArrayOutputStream();
+        Appender appender = new WriterAppender(layout, os);
+        logger.addAppender(appender);
+        logger.setLevel(Level.WARN);
+        logger.setAdditivity(false);
+        // create a new configuration
+        File file = new File("target/testReload.properties");
+
+        if (file.exists())
+        {
+            file.delete();
+        }
+
+        // create the configuration file
+        FileWriter out = new FileWriter(file);
+        out.write("string=value1");
+        out.flush();
+        out.close();
+
+        // load the configuration
+        PropertiesConfiguration config = new PropertiesConfiguration("target/testReload.properties");
+        FileChangedReloadingStrategy strategy = new FileChangedReloadingStrategy();
+        strategy.setRefreshDelay(500);
+        config.setReloadingStrategy(strategy);
+        assertEquals("Initial value", "value1", config.getString("string"));
+
+        Thread.sleep(2000);
+
+        // Delete the file.
+        file.delete();
+        //Old value should still be returned.
+        assertEquals("Initial value", "value1", config.getString("string"));
+        logger.removeAppender(appender);
+        String str = os.toString();
+        //System.out.println(str);
+        assertTrue("No error was logged", str != null && str.length() > 0);
+    }
 }
diff --git a/src/test/org/apache/commons/configuration/reloading/TestVFSFileMonitorReloadingStrategy.java b/src/test/org/apache/commons/configuration/reloading/TestVFSFileChangedReloadingStrategy.java
similarity index 52%
rename from src/test/org/apache/commons/configuration/reloading/TestVFSFileMonitorReloadingStrategy.java
rename to src/test/org/apache/commons/configuration/reloading/TestVFSFileChangedReloadingStrategy.java
index af070f348b..987cba00ce 100644
--- a/src/test/org/apache/commons/configuration/reloading/TestVFSFileMonitorReloadingStrategy.java
+++ b/src/test/org/apache/commons/configuration/reloading/TestVFSFileChangedReloadingStrategy.java
@@ -38,11 +38,10 @@
  * @author Ralph Goers
  * @version $Revision$
  */
-public class TestVFSFileMonitorReloadingStrategy extends TestCase
-        implements ConfigurationListener
+public class TestVFSFileChangedReloadingStrategy extends TestCase
 {
-    /** true when a file is changed */
-    private boolean configChanged = false;
+    /** Constant for the name of a test properties file.*/
+    private static final String TEST_FILE = "test.properties";
 
     protected void setUp() throws Exception
     {
@@ -74,12 +73,12 @@ public void testAutomaticReloading() throws Exception
 
         // load the configuration
         PropertiesConfiguration config = new PropertiesConfiguration("target/testReload.properties");
-        VFSFileMonitorReloadingStrategy strategy = new VFSFileMonitorReloadingStrategy();
-        strategy.setDelay(500);
+        VFSFileChangedReloadingStrategy strategy = new VFSFileChangedReloadingStrategy();
+        strategy.setRefreshDelay(500);
         config.setReloadingStrategy(strategy);
         assertEquals("Initial value", "value1", config.getString("string"));
 
-        Thread.sleep(1000);
+        Thread.sleep(2000);
 
         // change the file
         out = new FileWriter(file);
@@ -87,15 +86,8 @@ public void testAutomaticReloading() throws Exception
         out.flush();
         out.close();
 
-        Thread.sleep(2000);
-
         // test the automatic reloading
         assertEquals("Modified value with enabled reloading", "value2", config.getString("string"));
-        strategy.stopMonitor();
-        if (file.exists())
-        {
-            file.delete();
-        }
     }
 
     public void testNewFileReloading() throws Exception
@@ -110,9 +102,8 @@ public void testNewFileReloading() throws Exception
 
         PropertiesConfiguration config = new PropertiesConfiguration();
         config.setFile(file);
-        config.addConfigurationListener(this);
-        VFSFileMonitorReloadingStrategy strategy = new VFSFileMonitorReloadingStrategy();
-        strategy.setDelay(500);
+        VFSFileChangedReloadingStrategy strategy = new VFSFileChangedReloadingStrategy();
+        strategy.setRefreshDelay(500);
         config.setReloadingStrategy(strategy);
 
         assertNull("Initial value", config.getString("string"));
@@ -123,106 +114,40 @@ public void testNewFileReloading() throws Exception
         out.flush();
         out.close();
 
-        waitForChange();
+        Thread.sleep(2000);
 
         // test the automatic reloading
-        try
-        {
-            assertEquals("Modified value with enabled reloading", "value1", config.getString("string"));
-        }
-        finally
-        {
-            strategy.stopMonitor();
-            if (file.exists())
-            {
-                file.delete();
-            }
-        }
+        assertEquals("Modified value with enabled reloading", "value1", config.getString("string"));
     }
 
     public void testGetRefreshDelay() throws Exception
     {
-        // create a new configuration
-        File file = new File("target/testReload.properties");
-
-        if (file.exists())
-        {
-            file.delete();
-        }
-
-        // create the configuration file
-        FileWriter out = new FileWriter(file);
-        out.write("string=value1");
-        out.flush();
-        out.close();
-
-        PropertiesConfiguration config = new PropertiesConfiguration("target/testReload.properties");
-        VFSFileMonitorReloadingStrategy strategy = new VFSFileMonitorReloadingStrategy();
-        strategy.setDelay(500);
-        config.setReloadingStrategy(strategy);
-        // Minimum is 1 second.
-        assertEquals("refresh delay", 1000, strategy.getDelay());
-
-        config = new PropertiesConfiguration("target/testReload.properties");
-        strategy = new VFSFileMonitorReloadingStrategy();
-        strategy.setDelay(1500);
-        config.setReloadingStrategy(strategy);
-        // Can be made longer
-        assertEquals("refresh delay", 1500, strategy.getDelay());
-
-        config = new PropertiesConfiguration("target/testReload.properties");
-        strategy = new VFSFileMonitorReloadingStrategy();
-        strategy.setDelay(500);
-        config.setReloadingStrategy(strategy);
-        // Can't be made shorter
-        assertEquals("refresh delay", 1500, strategy.getDelay());
-
-        strategy.stopMonitor();
-        // Reset and verify everything clears
-        config = new PropertiesConfiguration("target/testReload.properties");
-        strategy = new VFSFileMonitorReloadingStrategy();
-        strategy.setDelay(1100);
-        config.setReloadingStrategy(strategy);
-        assertEquals("refresh delay", 1100, strategy.getDelay());
-        strategy.stopMonitor();
-        if (file.exists())
-        {
-            file.delete();
-        }
-    }
-
-    private void waitForChange()
-    {
-        synchronized(this)
-        {
-            try
-            {
-                int count = 0;
-                while (!configChanged && count++ <= 3)
-                {
-                    this.wait(5000);
-                }
-            }
-            catch (InterruptedException ie)
-            {
-                throw new IllegalStateException("wait timed out");
-            }
-            finally
-            {
-                configChanged = false;
-            }
-        }
+        VFSFileChangedReloadingStrategy strategy = new VFSFileChangedReloadingStrategy();
+        strategy.setRefreshDelay(500);
+        assertEquals("refresh delay", 500, strategy.getRefreshDelay());
     }
 
-    public void configurationChanged(ConfigurationEvent event)
+    /**
+     * Tests calling reloadingRequired() multiple times before a reload actually
+     * happens. This test is related to CONFIGURATION-302.
+     */
+    public void testReloadingRequiredMultipleTimes()
+            throws ConfigurationException
     {
-        if (event.getType() == AbstractFileConfiguration.EVENT_CONFIG_CHANGED)
+        VFSFileChangedReloadingStrategy strategy = new VFSFileChangedReloadingStrategy()
         {
-            synchronized(this)
+            protected boolean hasChanged()
             {
-                configChanged = true;
-                this.notify();
+                // signal always a change
+                return true;
             }
-        }
+        };
+        strategy.setRefreshDelay(100000);
+        PropertiesConfiguration config = new PropertiesConfiguration(TEST_FILE);
+        config.setReloadingStrategy(strategy);
+        assertTrue("Reloading not required", strategy.reloadingRequired());
+        assertTrue("Reloading no more required", strategy.reloadingRequired());
+        strategy.reloadingPerformed();
+        assertFalse("Reloading still required", strategy.reloadingRequired());
     }
 }
\ No newline at end of file
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 1bbb50296e..89e3bf758f 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,13 @@
 
   <body>
     <release version="1.7" date="in SVN" description="">
+      <action dev="rgoers" type="fix" issue="CONFIGURATION-397">
+        Schema violation exceptions are now propagated back to the caller.
+      </action>
+       <action dev="rgoers" type="fix" issue="CONFIGURATION-390">
+        XMLConfiguration and CombinedConfiguraton are now synchronized to fix problems
+        caused by reloading in a multithreaded environment.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-396">
         HierarchicalConfiguration.NodeVisitor is now passed the correct key to
         its visitAfterChildren() method.
diff --git a/xdocs/userguide/howto_filesystems.xml b/xdocs/userguide/howto_filesystems.xml
index 1a5ae29527..aba265164c 100644
--- a/xdocs/userguide/howto_filesystems.xml
+++ b/xdocs/userguide/howto_filesystems.xml
@@ -77,7 +77,7 @@
     </xml>
   </override>
 </configuration>
-]]></source>       
+]]></source>
       </subsection>
       <subsection name="File Options Provider">
         <p>
@@ -95,15 +95,11 @@
       </subsection>
       <subsection name="File Reloading Strategy">
         <p>
-          The <code><a href="../apidocs/org/apache/commons/configuration/reloading/VFSFileMonitorReloadingStrategy.html">VFSFileMonitorReloadingStrategy</a></code>
+          The <code><a href="../apidocs/org/apache/commons/configuration/reloading/VFSFileChangedReloadingStrategy.html">VFSFileChangedReloadingStrategy</a></code>
           can be used to cause Configurations accessed via the <code>VFSFileSystem</code> to be
           monitored and reloaded when the files are modified. The example below shows how
           <code>DefaultConfigurationBuilder</code> can be configured to use
-          <code>VFSFileMonitorReloadingStrategy</code>. While each declaration will result in
-          a new reloading strategy object, each instance will share a common <code>FileMonitor</code>.
-          The delay setting controls how often the <code>FileMonitor</code> checks for changes
-          and since there is only a single <code>FileMonitor</code>, only the largest value
-          specified on any <code>VFSFileMonitorReloadingStrategy</code> is used.
+          <code>VFSFilChangedReloadingStrategy</code>.
           In the example below both test.properties and settings.xml would be checked for changes
           once per minute.
         </p>
@@ -117,12 +113,12 @@
   </header>
   <override>
     <properties fileName="test.properties" throwExceptionOnMissing="true">
-      <reloadingStrategy delay="60000"
-        config-class="org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy"/>
+      <reloadingStrategy refreshDelay="60000"
+        config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
     </properties>
     <xml fileName="settings.xml" config-name="xml">
-      <reloadingStrategy
-         config-class="org.apache.commons.configuration.reloading.VFSFileMonitorReloadingStrategy"/>
+      <reloadingStrategy refreshDelay="60000"
+         config-class="org.apache.commons.configuration.reloading.VFSFileChangedReloadingStrategy"/>
     </xml>
   </override>
 </configuration>
diff --git a/xdocs/userguide/howto_multitenant.xml b/xdocs/userguide/howto_multitenant.xml
index c07d252f0d..857daba86a 100644
--- a/xdocs/userguide/howto_multitenant.xml
+++ b/xdocs/userguide/howto_multitenant.xml
@@ -54,6 +54,14 @@
           ReloadingStrategy and listeners will be propogated to each of the
           created configurations.
         </p>
+        <p>
+          When used in a combined configuration it is often acceptable for a file
+          matching a particular pattern to be missing so, by default, most exceptions
+          encountered when loading files are ignored. To change this behavior
+          call setIgnoreException(false) or configure the attribute to false in
+          DefaultConfigurationBuilder's configuration file. If schema validation
+          is enabled validation exceptions will always cause a failure.
+        </p>
       </subsection>
       <subsection name="DynamicCombinedConfiguration">
         <p>

From d067512c2b8efee925a8761f1a43b2dfca4ff0af Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Tue, 29 Sep 2009 23:38:52 +0000
Subject: [PATCH 3/6] Fix memory leak on reloading. Have
 DynamicCombinedConfiguration participate in locking

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/CONFIGURATION_390@820124 13f79535-47bb-0310-9956-ffa450edef68
---
 conf/testMultiTenentConfigurationBuilder4.xml |  39 ++++
 pom.xml                                       |  10 +
 .../AbstractFileConfiguration.java            |   2 +-
 .../configuration/CombinedConfiguration.java  |  14 +-
 .../DynamicCombinedConfiguration.java         |  18 +-
 .../HierarchicalReloadableConfiguration.java  |   8 +-
 .../apache/commons/configuration/Lock.java    |  36 ++++
 .../MultiFileHierarchicalConfiguration.java   |   6 +-
 .../configuration/XMLConfiguration.java       |   1 +
 .../apache/commons/configuration/Logging.java |   2 +-
 .../TestDynamicCombinedConfiguration.java     | 180 ++++++++++++++++++
 .../configuration/TestXMLConfiguration.java   |  35 +++-
 .../FileRandomReloadingStrategy.java          |  40 +++-
 13 files changed, 379 insertions(+), 12 deletions(-)
 create mode 100644 conf/testMultiTenentConfigurationBuilder4.xml
 create mode 100644 src/java/org/apache/commons/configuration/Lock.java

diff --git a/conf/testMultiTenentConfigurationBuilder4.xml b/conf/testMultiTenentConfigurationBuilder4.xml
new file mode 100644
index 0000000000..479dc80066
--- /dev/null
+++ b/conf/testMultiTenentConfigurationBuilder4.xml
@@ -0,0 +1,39 @@
+<?xml version="1.0" encoding="ISO-8859-1" ?>
+<!-- Test configuration definition file that demonstrates complex initialization -->
+<configuration>
+  <header>
+    <result delimiterParsingDisabled="true" forceReloadCheck="true" loggerName="TestLogger"
+            config-class="org.apache.commons.configuration.DynamicCombinedConfiguration"
+            keyPattern="$${test:Id}">
+      <nodeCombiner config-class="org.apache.commons.configuration.tree.MergeCombiner"/>
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+    </result>
+    <lookups>
+      <lookup config-prefix="test"
+              config-class="org.apache.commons.configuration.TestDynamicCombinedConfiguration$ThreadLookup"/>
+    </lookups>
+    <entity-resolver catalogFiles="catalog.xml"/>
+    <providers>
+      <provider config-tag="multifile"
+         config-class="org.apache.commons.configuration.DefaultConfigurationBuilder$FileConfigurationProvider"
+         configurationClass="org.apache.commons.configuration.MultiFileHierarchicalConfiguration"/>
+    </providers>
+  </header>
+  <override>
+    <multifile filePattern="testMultiConfiguration_$$${test:Id}.xml"
+               config-name="clientConfig" delimiterParsingDisabled="true" schemaValidation="true">
+       <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+       <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.FileRandomReloadingStrategy"/>
+    </multifile>
+    <xml fileName="testMultiConfiguration_default.xml"
+         config-name="defaultConfig" delimiterParsingDisabled="true" schemaValidation="true">
+      <expressionEngine
+          config-class="org.apache.commons.configuration.tree.xpath.XPathExpressionEngine"/>
+      <reloadingStrategy refreshDelay="500"
+          config-class="org.apache.commons.configuration.reloading.FileRandomReloadingStrategy"/>
+    </xml>
+  </override>
+</configuration>
\ No newline at end of file
diff --git a/pom.xml b/pom.xml
index b98d977d81..6533309d29 100644
--- a/pom.xml
+++ b/pom.xml
@@ -486,6 +486,8 @@
           <groupId>org.apache.maven.plugins</groupId>
           <artifactId>maven-surefire-plugin</artifactId>
           <configuration>
+            <!-- Uncomment to enable profiling unit tests -->
+            <!-- <argLine>-agentpath:"${yourkit.home}/bin/mac/libyjpagent.jnilib"</argLine> -->
             <forkMode>once</forkMode>
             <excludes>
               <exclude>**/TestWebdavConfigurationBuilder.java</exclude>
@@ -584,6 +586,14 @@
         </plugins>
       </build>
     </profile>
+    <!-- Uncomment this and set the path accordingly to enable YourKit -->
+    <!-- http://www.yourkit.com/docs/80/help/agent.jsp -->
+    <!-- <profile>
+      <id>yourkit-profile</id>
+      <properties>
+        <yourkit.home>/Applications/YourKit_Java_Profiler_8.0.17.app/</yourkit.home>
+      </properties>
+    </profile> -->
   </profiles>
   <reporting>
     <plugins>
diff --git a/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java b/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java
index 5b8215dc84..f19b485f2e 100644
--- a/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java
+++ b/src/java/org/apache/commons/configuration/AbstractFileConfiguration.java
@@ -103,7 +103,7 @@ public abstract class AbstractFileConfiguration
     protected ReloadingStrategy strategy;
 
     /** A lock object for protecting reload operations.*/
-    protected Object reloadLock = new Object();
+    protected Object reloadLock = new Lock("AbstractFileConfiguration");
 
     /** Stores the encoding of the configuration file.*/
     private String encoding;
diff --git a/src/java/org/apache/commons/configuration/CombinedConfiguration.java b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
index f76f4bbece..628b59f204 100644
--- a/src/java/org/apache/commons/configuration/CombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
@@ -234,6 +234,18 @@ public CombinedConfiguration(NodeCombiner comb)
         clear();
     }
 
+    public CombinedConfiguration(NodeCombiner comb, Lock lock)
+    {
+        super(lock);
+        setNodeCombiner((comb != null) ? comb : DEFAULT_COMBINER);
+        clear();
+    }
+
+    public CombinedConfiguration(Lock lock)
+    {
+        this(null, lock);
+    }
+
     /**
      * Creates a new instance of <code>CombinedConfiguration</code> that uses
      * a union combiner.
@@ -242,7 +254,7 @@ public CombinedConfiguration(NodeCombiner comb)
      */
     public CombinedConfiguration()
     {
-        this(null);
+        this(null, null);
     }
 
     /*
diff --git a/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java b/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
index d7ae6582d5..f194f46442 100644
--- a/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
@@ -32,8 +32,10 @@
 import org.apache.commons.configuration.tree.ConfigurationNode;
 import org.apache.commons.configuration.tree.ExpressionEngine;
 import org.apache.commons.configuration.tree.NodeCombiner;
+import org.apache.commons.configuration.interpol.ConfigurationInterpolator;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
+import org.apache.commons.lang.text.StrSubstitutor;
 
 /**
  * DynamicCombinedConfiguration allows a set of CombinedConfigurations to be used. Each CombinedConfiguration
@@ -73,8 +75,12 @@ protected synchronized Object initialValue()
     /** Stores the combiner. */
     private NodeCombiner nodeCombiner;
 
+    private Lock reloadLock = new Lock("DynamicCombinedConfiguration");
+
     /** The name of the logger to use for each CombinedConfiguration */
-    private String loggerName;
+    private String loggerName = DynamicCombinedConfiguration.class.getName();
+
+    StrSubstitutor localSubst = new StrSubstitutor(new ConfigurationInterpolator());
 
     /**
      * Creates a new instance of <code>CombinedConfiguration</code> and
@@ -88,6 +94,7 @@ public DynamicCombinedConfiguration(NodeCombiner comb)
         super();
         setNodeCombiner(comb);
         setIgnoreReloadExceptions(false);
+        setLogger(LogFactory.getLog(DynamicCombinedConfiguration.class));
     }
 
     /**
@@ -100,6 +107,7 @@ public DynamicCombinedConfiguration()
     {
         super();
         setIgnoreReloadExceptions(false);
+        setLogger(LogFactory.getLog(DynamicCombinedConfiguration.class));
     }
 
     public void setKeyPattern(String pattern)
@@ -754,14 +762,14 @@ protected Object resolveContainerStore(String key)
 
     private CombinedConfiguration getCurrentConfig()
     {
-        String key = getSubstitutor().replace(keyPattern);
+        String key = localSubst.replace(keyPattern);
         CombinedConfiguration config;
         synchronized (getNodeCombiner())
         {
             config = (CombinedConfiguration) configs.get(key);
             if (config == null)
             {
-                config = new CombinedConfiguration(getNodeCombiner());
+                config = new CombinedConfiguration(getNodeCombiner(), reloadLock);
                 if (loggerName != null)
                 {
                     Log log = LogFactory.getLog(loggerName);
@@ -798,6 +806,10 @@ private CombinedConfiguration getCurrentConfig()
                 configs.put(key, config);
             }
         }
+        if (getLogger().isDebugEnabled())
+        {
+            getLogger().debug("Returning config for " + key + ": " + config);
+        }
         return config;
     }
 
diff --git a/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java b/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
index 5210d1d804..c26d06a536 100644
--- a/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
+++ b/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
@@ -16,19 +16,21 @@ public class HierarchicalReloadableConfiguration extends HierarchicalConfigurati
 {
     private final Object reloadLock;
 
+    private static final String LOCK_NAME = "HierarchicalReloadableConfigurationLock";
+
     /**
      * Creates a new instance of <code>HierarchicalReloadableConfiguration</code>.
      */
     public HierarchicalReloadableConfiguration()
     {
         super();
-        reloadLock = new Object();
+        reloadLock = new Lock(LOCK_NAME);
     }
 
     public HierarchicalReloadableConfiguration(Object lock)
     {
         super();
-        reloadLock = lock == null ? new Object() : lock;
+        reloadLock = lock == null ? new Lock(LOCK_NAME) : lock;
     }
 
     /**
@@ -43,7 +45,7 @@ public HierarchicalReloadableConfiguration(Object lock)
     public HierarchicalReloadableConfiguration(HierarchicalConfiguration c)
     {
         super(c);
-        reloadLock = new Object();
+        reloadLock = new Lock(LOCK_NAME);
     }
 
 
diff --git a/src/java/org/apache/commons/configuration/Lock.java b/src/java/org/apache/commons/configuration/Lock.java
new file mode 100644
index 0000000000..c6e3206655
--- /dev/null
+++ b/src/java/org/apache/commons/configuration/Lock.java
@@ -0,0 +1,36 @@
+package org.apache.commons.configuration;
+
+/**
+ * Created by IntelliJ IDEA.
+ * User: rgoers
+ * Date: Sep 29, 2009
+ * Time: 12:50:36 PM
+ * To change this template use File | Settings | File Templates.
+ */
+public class Lock
+{
+    private final String name;
+    private final int instanceId;
+
+    private static String counterLock = "Lock";
+    private static int counter = 0;
+
+    public Lock(String name)
+    {
+        this.name = name;
+        synchronized(counterLock)
+        {
+            instanceId = ++counter;
+        }
+    }
+
+    public String getName()
+    {
+        return name;
+    }
+
+    public String toString()
+    {
+        return "Lock: " + name + " id = " + instanceId;
+    }
+}
diff --git a/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java b/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
index 809e16e588..c9c0c80568 100644
--- a/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
+++ b/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
@@ -39,9 +39,11 @@
 import org.apache.commons.configuration.tree.ExpressionEngine;
 import org.apache.commons.configuration.reloading.ReloadingStrategy;
 import org.apache.commons.configuration.resolver.EntityResolverSupport;
+import org.apache.commons.configuration.interpol.ConfigurationInterpolator;
 import org.apache.commons.beanutils.BeanUtils;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
+import org.apache.commons.lang.text.StrSubstitutor;
 import org.xml.sax.EntityResolver;
 import org.xml.sax.SAXParseException;
 
@@ -101,6 +103,8 @@ protected synchronized Object initialValue()
     /** The EntityResolver */
     private EntityResolver entityResolver;
 
+    private StrSubstitutor localSubst = new StrSubstitutor(new ConfigurationInterpolator());
+
     /**
      * Default Constructor.
      */
@@ -679,7 +683,7 @@ private AbstractHierarchicalFileConfiguration getConfiguration()
         {
             throw new ConfigurationRuntimeException("File pattern must be defined");
         }
-        String path = getSubstitutor().replace(pattern);
+        String path = localSubst.replace(pattern);
         synchronized (configurationsMap)
         {
             if (configurationsMap.containsKey(path))
diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index c44e7be16c..38d831c189 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -567,6 +567,7 @@ public Document getDocument()
     public void clear()
     {
         super.clear();
+        setRoot(new Node());
         document = null;
     }
 
diff --git a/src/test/org/apache/commons/configuration/Logging.java b/src/test/org/apache/commons/configuration/Logging.java
index f7ff94ab10..60ecf55d2a 100644
--- a/src/test/org/apache/commons/configuration/Logging.java
+++ b/src/test/org/apache/commons/configuration/Logging.java
@@ -59,7 +59,7 @@ public class Logging extends Log4JLogger
         {
             org.apache.log4j.Logger log = org.apache.log4j.Logger.getRootLogger();
             log.setLevel(Level.toLevel(level));
-            Appender appender = new ConsoleAppender(new PatternLayout("%p - %m%n"), ConsoleAppender.SYSTEM_OUT);
+            Appender appender = new ConsoleAppender(new PatternLayout("%p %l - %m%n"), ConsoleAppender.SYSTEM_OUT);
             log.addAppender(appender);
         }
     }
diff --git a/src/test/org/apache/commons/configuration/TestDynamicCombinedConfiguration.java b/src/test/org/apache/commons/configuration/TestDynamicCombinedConfiguration.java
index e1a9a4956c..e1a2345559 100644
--- a/src/test/org/apache/commons/configuration/TestDynamicCombinedConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestDynamicCombinedConfiguration.java
@@ -21,12 +21,15 @@
 
 import junit.framework.TestCase;
 import org.apache.commons.configuration.tree.xpath.XPathExpressionEngine;
+import org.apache.commons.lang.text.StrLookup;
 
 public class TestDynamicCombinedConfiguration extends TestCase
 {
     private static String PATTERN ="${sys:Id}";
     private static String PATTERN1 = "target/test-classes/testMultiConfiguration_${sys:Id}.xml";
     private static String DEFAULT_FILE = "target/test-classes/testMultiConfiguration_default.xml";
+    private static final File MULTI_TENENT_FILE = new File(
+            "conf/testMultiTenentConfigurationBuilder4.xml");
 
     public void testConfiguration() throws Exception
     {
@@ -57,9 +60,186 @@ public void testConfiguration() throws Exception
         assertEquals("a\\,b\\,c", config.getString("split/list2"));
     }
 
+    public void testConcurrentGetAndReload() throws Exception
+    {
+        final int threadCount = 5;
+        final int loopCount = 500;
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+
+        assertEquals(config.getString("rowsPerPage"), "50");
+        Thread testThreads[] = new Thread[threadCount];
+        int failures[] = new int[threadCount];
+
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i] = new ReloadThread(config, failures, i, loopCount, false, null, "50");
+            testThreads[i].start();
+        }
+
+        int totalFailures = 0;
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i].join();
+            totalFailures += failures[i];
+        }
+        assertTrue(totalFailures + " failures Occurred", totalFailures == 0);
+    }
+
+    public void testConcurrentGetAndReload2() throws Exception
+    {
+        final int threadCount = 5;
+        final int loopCount = 500;
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+
+        assertEquals(config.getString("rowsPerPage"), "50");
+
+        Thread testThreads[] = new Thread[threadCount];
+        int failures[] = new int[threadCount];
+        System.setProperty("Id", "2002");
+        assertEquals(config.getString("rowsPerPage"), "25");
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i] = new ReloadThread(config, failures, i, loopCount, false, null, "25");
+            testThreads[i].start();
+        }
+
+        int totalFailures = 0;
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i].join();
+            totalFailures += failures[i];
+        }
+        System.getProperties().remove("Id");
+        assertTrue(totalFailures + " failures Occurred", totalFailures == 0);
+    }
+
+    public void testConcurrentGetAndReloadMultipleClients() throws Exception
+    {
+        final int threadCount = 5;
+        final int loopCount = 500;
+        System.getProperties().remove("Id");
+        DefaultConfigurationBuilder factory = new DefaultConfigurationBuilder();
+        factory.setFile(MULTI_TENENT_FILE);
+        CombinedConfiguration config = factory.getConfiguration(true);
+
+        assertEquals(config.getString("rowsPerPage"), "50");
+
+        Thread testThreads[] = new Thread[threadCount];
+        int failures[] = new int[threadCount];
+        String[] ids = new String[] {null, "2002", "3001", "3002", "3003"};
+        String[] expected = new String[] {"50", "25", "15", "25", "50"};
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i] = new ReloadThread(config, failures, i, loopCount, true, ids[i], expected[i]);
+            testThreads[i].start();
+        }
+
+        int totalFailures = 0;
+        for (int i = 0; i < testThreads.length; ++i)
+        {
+            testThreads[i].join();
+            totalFailures += failures[i];
+        }
+        System.getProperties().remove("Id");
+        if (totalFailures != 0)
+        {
+            System.out.println("Failures:");
+            for (int i = 0; i < testThreads.length; ++i)
+            {
+                System.out.println("Thread " + i + " " + failures[i]);
+            }
+        }
+        assertTrue(totalFailures + " failures Occurred", totalFailures == 0);
+    }
+
+    private class ReloadThread extends Thread
+    {
+        CombinedConfiguration combined;
+        int[] failures;
+        int index;
+        int count;
+        String expected;
+        String id;
+        boolean useId;
+
+        ReloadThread(CombinedConfiguration config, int[] failures, int index, int count,
+                     boolean useId, String id, String expected)
+        {
+            combined = config;
+            this.failures = failures;
+            this.index = index;
+            this.count = count;
+            this.expected = expected;
+            this.id = id;
+            this.useId = useId;
+        }
+        public void run()
+        {
+            failures[index] = 0;
+
+            if (useId)
+            {
+                ThreadLookup.setId(id);
+            }
+            for (int i = 0; i < count; i++)
+            {
+                try
+                {
+                    String value = combined.getString("rowsPerPage", null);
+                    if (value == null || !value.equals(expected))
+                    {
+                        ++failures[index];
+                    }
+                }
+                catch (Exception ex)
+                {
+                    ++failures[index];
+                }
+            }
+        }
+    }
+
     private void verify(String key, DynamicCombinedConfiguration config, int rows)
     {
         System.setProperty("Id", key);
         assertTrue(config.getInt("rowsPerPage") == rows);
     }
+
+    public static class ThreadLookup extends StrLookup
+    {
+        private static ThreadLocal id = new ThreadLocal();
+
+
+
+        public ThreadLookup()
+        {
+
+        }
+
+        public static void setId(String value)
+        {
+            id.set(value);
+        }
+
+        public String lookup(String key)
+        {
+            if (key == null || !key.equals("Id"))
+            {
+                return null;
+            }
+            String value = System.getProperty("Id");
+            if (value != null)
+            {
+                return value;
+            }
+            return (String)id.get();
+
+        }
+    }
 }
diff --git a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
index 509f87b1ef..5a3354b028 100644
--- a/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestXMLConfiguration.java
@@ -639,6 +639,39 @@ public void testReloading() throws Exception
         }
     }
 
+    public void testReloadingOOM() throws Exception
+    {
+        assertNotNull(conf.getReloadingStrategy());
+        assertTrue(conf.getReloadingStrategy() instanceof InvariantReloadingStrategy);
+        PrintWriter out = null;
+
+        try
+        {
+            out = new PrintWriter(new FileWriter(testSaveConf));
+            out.println("<?xml version=\"1.0\"?><config><test>1</test></config>");
+            out.close();
+            out = null;
+            conf.setFile(testSaveConf);
+            FileAlwaysReloadingStrategy strategy = new FileAlwaysReloadingStrategy();
+            strategy.setRefreshDelay(100);
+            conf.setReloadingStrategy(strategy);
+            conf.load();
+            assertEquals(1, conf.getInt("test"));
+
+            for (int i = 1; i < 50000; ++i)
+            {
+               assertEquals(1, conf.getInt("test"));
+            }
+        }
+        finally
+        {
+            if (out != null)
+            {
+                out.close();
+            }
+        }
+    }
+
     /**
      * Tests access to tag names with delimiter characters.
      */
@@ -1615,7 +1648,7 @@ public void testConcurrentGetAndReload() throws Exception
 
         for (int i = 0; i < 2000; i++)
         {
-            assertTrue("Property not found", config.getProperty("test.short") != null); 
+            assertTrue("Property not found", config.getProperty("test.short") != null);
         }
 
         for (int i = 0; i < testThreads.length; ++i)
diff --git a/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java b/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java
index 6e9b580265..13eda2b2ea 100644
--- a/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java
+++ b/src/test/org/apache/commons/configuration/reloading/FileRandomReloadingStrategy.java
@@ -1,5 +1,8 @@
 package org.apache.commons.configuration.reloading;
 
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
+
 import java.io.File;
 import java.util.Random;
 
@@ -9,6 +12,10 @@
 public class FileRandomReloadingStrategy extends FileChangedReloadingStrategy
 {
     Random random = new Random();
+
+      /** The Log to use for diagnostic messages */
+    private Log logger = LogFactory.getLog(FileRandomReloadingStrategy.class);
+
     /**
      * Checks whether a reload is necessary.
      *
@@ -16,7 +23,15 @@ public class FileRandomReloadingStrategy extends FileChangedReloadingStrategy
      */
     public boolean reloadingRequired()
     {
-        return random.nextBoolean();
+        boolean result = random.nextBoolean();
+        if (result)
+        {
+            if (logger.isDebugEnabled())
+            {
+                logger.debug("File change detected: " + getName());
+            }
+        }
+        return result;
     }
 
     /**
@@ -28,4 +43,27 @@ public File getMonitoredFile()
     {
         return getFile();
     }
+
+    private String getName()
+    {
+        return getName(getFile());
+    }
+
+    private String getName(File file)
+    {
+        String name = configuration.getURL().toString();
+        if (name == null)
+        {
+            if (file != null)
+            {
+                name = file.getAbsolutePath();
+            }
+            else
+            {
+                name = "base: " + configuration.getBasePath()
+                       + "file: " + configuration.getFileName();
+            }
+        }
+        return name;
+    }
 }

From 6c301782443603dc0fe2e670b2b437e80c50484b Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Sat, 3 Oct 2009 03:07:41 +0000
Subject: [PATCH 4/6] Copy configurations when creating a CombinedConfiguration
 to eliminate need to lock DynamicCombinedConfiguration. Add more debugging

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/CONFIGURATION_390@821230 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/CombinedConfiguration.java  | 144 +-----------------
 .../configuration/ConfigurationUtils.java     |  15 +-
 .../DefaultConfigurationBuilder.java          |  13 ++
 .../DynamicCombinedConfiguration.java         |   2 +-
 .../configuration/XMLConfiguration.java       |   6 +
 .../resolver/CatalogResolver.java             |   5 +-
 ...estMultiFileHierarchicalConfiguration.java |   2 +-
 7 files changed, 46 insertions(+), 141 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/CombinedConfiguration.java b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
index 628b59f204..a80a6eafe0 100644
--- a/src/java/org/apache/commons/configuration/CombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
@@ -408,6 +408,10 @@ public void addConfiguration(AbstractConfiguration config, String name,
         }
 
         ConfigData cd = new ConfigData(config, name, at);
+        if (getLogger().isDebugEnabled())
+        {
+            getLogger().debug("Adding configuration " + config + " with name " + name);
+        }
         configurations.add(cd);
         if (name != null)
         {
@@ -634,142 +638,6 @@ public ConfigurationNode getRootNode()
             return combinedRoot;
         }
     }
-    /*
-    public Object getProperty(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.getProperty(key);
-        }
-    }
-
-    protected void addPropertyDirect(String key, Object obj)
-    {
-        synchronized(reloadLock)
-        {
-            super.addPropertyDirect(key, obj);
-        }
-    }
-
-    public void addNodes(String key, Collection nodes)
-    {
-        synchronized(reloadLock)
-        {
-            super.addNodes(key, nodes);
-        }
-    }
-
-    public boolean isEmpty()
-    {
-        synchronized(reloadLock)
-        {
-            return super.isEmpty();
-        }
-    }
-
-    public Configuration subset(String prefix)
-    {
-        synchronized(reloadLock)
-        {
-            return super.subset(prefix);
-        }
-    }
-
-    public SubnodeConfiguration configurationAt(String key, boolean supportUpdates)
-    {
-        synchronized(reloadLock)
-        {
-            return super.configurationAt(key, supportUpdates);
-        }
-    }
-
-    public SubnodeConfiguration configurationAt(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.configurationAt(key);
-        }
-    }
-
-    public List configurationsAt(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.configurationsAt(key);
-        }
-    }
-
-    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node)
-    {
-        synchronized(reloadLock)
-        {
-            return super.createSubnodeConfiguration(node);
-        }
-    }
-
-    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node, String subnodeKey)
-    {
-        synchronized(reloadLock)
-        {
-            return super.createSubnodeConfiguration(node, subnodeKey);
-        }
-    }
-
-    public boolean containsKey(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.containsKey(key);
-        }
-    }
-
-    public void setProperty(String key, Object value)
-    {
-        synchronized(reloadLock)
-        {
-            super.setProperty(key, value);
-        }
-    }
-
-    public void clearTree(String key)
-    {
-        synchronized(reloadLock)
-        {
-            super.clearTree(key);
-        }
-    }
-
-    public void clearProperty(String key)
-    {
-        synchronized(reloadLock)
-        {
-            super.clearProperty(key);
-        }
-    }
-
-    public Iterator getKeys()
-    {
-        synchronized(reloadLock)
-        {
-            return super.getKeys();
-        }
-    }
-
-    public Iterator getKeys(String prefix)
-    {
-        synchronized(reloadLock)
-        {
-            return super.getKeys(prefix);
-        }
-    }
-
-    public int getMaxIndex(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.getMaxIndex(key);
-        }
-    } */
 
     /**
      * Clears this configuration. All contained configurations will be removed.
@@ -919,6 +787,10 @@ private ConfigurationNode constructCombinedNode()
     {
         if (getNumberOfConfigurations() < 1)
         {
+            if (getLogger().isDebugEnabled())
+            {
+                getLogger().debug("No configurations defined for " + this);
+            }
             return new ViewNode();
         }
 
diff --git a/src/java/org/apache/commons/configuration/ConfigurationUtils.java b/src/java/org/apache/commons/configuration/ConfigurationUtils.java
index 3476b5aea0..cab3f739c4 100644
--- a/src/java/org/apache/commons/configuration/ConfigurationUtils.java
+++ b/src/java/org/apache/commons/configuration/ConfigurationUtils.java
@@ -32,6 +32,7 @@
 import org.apache.commons.configuration.event.ConfigurationErrorListener;
 import org.apache.commons.configuration.event.EventSource;
 import org.apache.commons.configuration.tree.ExpressionEngine;
+import org.apache.commons.configuration.reloading.Reloadable;
 import org.apache.commons.lang.StringUtils;
 import org.apache.commons.lang.SystemUtils;
 import org.apache.commons.logging.Log;
@@ -223,7 +224,19 @@ public static HierarchicalConfiguration convertToHierarchical(
 
         if (conf instanceof HierarchicalConfiguration)
         {
-            HierarchicalConfiguration hc = (HierarchicalConfiguration) conf;
+            HierarchicalConfiguration hc;
+            if (conf instanceof Reloadable)
+            {
+                Object lock = ((Reloadable) conf).getReloadLock();
+                synchronized(lock)
+                {
+                    hc = new HierarchicalConfiguration((HierarchicalConfiguration) conf);
+                }
+            }
+            else
+            {
+                hc = (HierarchicalConfiguration) conf;
+            }
             if (engine != null)
             {
                 hc.setExpressionEngine(engine);
diff --git a/src/java/org/apache/commons/configuration/DefaultConfigurationBuilder.java b/src/java/org/apache/commons/configuration/DefaultConfigurationBuilder.java
index 64faf93804..92dffa9f70 100644
--- a/src/java/org/apache/commons/configuration/DefaultConfigurationBuilder.java
+++ b/src/java/org/apache/commons/configuration/DefaultConfigurationBuilder.java
@@ -40,6 +40,7 @@
 import org.apache.commons.configuration.resolver.EntityResolverSupport;
 import org.apache.commons.lang.text.StrLookup;
 import org.apache.commons.logging.LogFactory;
+import org.apache.commons.logging.Log;
 import org.xml.sax.EntityResolver;
 
 /**
@@ -651,6 +652,11 @@ protected void initCombinedConfiguration(CombinedConfiguration config,
                     .next();
             ConfigurationDeclaration decl = new ConfigurationDeclaration(this,
                     conf);
+            if (getLogger().isDebugEnabled())
+            {
+                getLogger().debug("Creating configuration " + decl.getBeanClassName() + " with name " +
+                    decl.getConfiguration().getString(ATTR_NAME));
+            }
             AbstractConfiguration newConf = createConfigurationAt(decl);
             if (newConf != null)
             {
@@ -1225,6 +1231,8 @@ protected Object interpolate(Object value)
      */
     static class ConfigurationBeanFactory implements BeanFactory
     {
+        private Log logger = LogFactory.getLog(DefaultConfigurationBuilder.class);
+
         /**
          * Creates an instance of a bean class. This implementation expects that
          * the passed in bean declaration is a declaration for a configuration.
@@ -1268,6 +1276,11 @@ public Object createBean(Class beanClass, BeanDeclaration data,
                 }
                 else
                 {
+                    if (logger.isDebugEnabled())
+                    {
+                        logger.debug("Load failed for optional configuration " + tagName + ": "
+                            + ex.getMessage());
+                    }
                     // Notify registered error listeners
                     decl.getConfigurationBuilder().fireError(
                             EVENT_ERR_LOAD_OPTIONAL,
diff --git a/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java b/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
index f194f46442..c2d6228256 100644
--- a/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/DynamicCombinedConfiguration.java
@@ -769,7 +769,7 @@ private CombinedConfiguration getCurrentConfig()
             config = (CombinedConfiguration) configs.get(key);
             if (config == null)
             {
-                config = new CombinedConfiguration(getNodeCombiner(), reloadLock);
+                config = new CombinedConfiguration(getNodeCombiner());
                 if (loggerName != null)
                 {
                     Log log = LogFactory.getLog(loggerName);
diff --git a/src/java/org/apache/commons/configuration/XMLConfiguration.java b/src/java/org/apache/commons/configuration/XMLConfiguration.java
index 38d831c189..4542fccaca 100644
--- a/src/java/org/apache/commons/configuration/XMLConfiguration.java
+++ b/src/java/org/apache/commons/configuration/XMLConfiguration.java
@@ -49,6 +49,7 @@
 import org.apache.commons.configuration.tree.ConfigurationNode;
 import org.apache.commons.configuration.resolver.EntityRegistry;
 import org.apache.commons.configuration.resolver.DefaultEntityResolver;
+import org.apache.commons.logging.LogFactory;
 import org.w3c.dom.Attr;
 import org.w3c.dom.CDATASection;
 import org.w3c.dom.DOMException;
@@ -226,6 +227,7 @@ public class XMLConfiguration extends AbstractHierarchicalFileConfiguration
     public XMLConfiguration()
     {
         super();
+        setLogger(LogFactory.getLog(XMLConfiguration.class));
     }
 
     /**
@@ -243,6 +245,7 @@ public XMLConfiguration(HierarchicalConfiguration c)
         super(c);
         clearReferences(getRootNode());
         setRootElementName(getRootNode().getName());
+        setLogger(LogFactory.getLog(XMLConfiguration.class));
     }
 
     /**
@@ -255,6 +258,7 @@ public XMLConfiguration(HierarchicalConfiguration c)
     public XMLConfiguration(String fileName) throws ConfigurationException
     {
         super(fileName);
+        setLogger(LogFactory.getLog(XMLConfiguration.class));
     }
 
     /**
@@ -267,6 +271,7 @@ public XMLConfiguration(String fileName) throws ConfigurationException
     public XMLConfiguration(File file) throws ConfigurationException
     {
         super(file);
+        setLogger(LogFactory.getLog(XMLConfiguration.class));
     }
 
     /**
@@ -279,6 +284,7 @@ public XMLConfiguration(File file) throws ConfigurationException
     public XMLConfiguration(URL url) throws ConfigurationException
     {
         super(url);
+        setLogger(LogFactory.getLog(XMLConfiguration.class));
     }
 
     /**
diff --git a/src/java/org/apache/commons/configuration/resolver/CatalogResolver.java b/src/java/org/apache/commons/configuration/resolver/CatalogResolver.java
index 571de12f00..844c431369 100644
--- a/src/java/org/apache/commons/configuration/resolver/CatalogResolver.java
+++ b/src/java/org/apache/commons/configuration/resolver/CatalogResolver.java
@@ -23,6 +23,7 @@
 import org.apache.xml.resolver.Catalog;
 import org.apache.xml.resolver.readers.CatalogReader;
 import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
 import org.apache.commons.logging.impl.NoOpLog;
 import org.apache.commons.configuration.FileSystem;
 import org.apache.commons.configuration.ConfigurationException;
@@ -199,7 +200,7 @@ public InputSource resolveEntity(String publicId, String systemId)
             }
             catch (Exception e)
             {
-                log.debug("Failed to create InputSource for " + resolved + " ("
+                log.warn("Failed to create InputSource for " + resolved + " ("
                                 + e.toString() + ")");
                 return null;
             }
@@ -229,7 +230,7 @@ public Log getLogger()
      */
     public void setLogger(Log log)
     {
-        this.log = (log != null) ? log : new NoOpLog();
+        this.log = (log != null) ? log : LogFactory.getLog(CatalogResolver.class);
     }
 
     private synchronized org.apache.xml.resolver.tools.CatalogResolver getResolver()
diff --git a/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java b/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java
index 6da689a54e..500ff734ea 100644
--- a/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestMultiFileHierarchicalConfiguration.java
@@ -265,7 +265,7 @@ public void testFileReloadSchemaValidationError() throws Exception
         }
 
         output.delete();
-    }
+    }    
 
     private void copyFile(File input, File output) throws IOException
     {

From d84f641eae39b825bd9bf36422337f02bea3b2c6 Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Mon, 5 Oct 2009 02:06:44 +0000
Subject: [PATCH 5/6] Eliminate need to lock api methods

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/CONFIGURATION_390@821659 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/CombinedConfiguration.java  |  38 +++--
 .../HierarchicalReloadableConfiguration.java  | 152 ------------------
 .../apache/commons/configuration/Lock.java    |   2 +-
 .../MultiFileHierarchicalConfiguration.java   |   5 +
 .../PatternSubtreeConfigurationWrapper.java   |   5 +
 5 files changed, 32 insertions(+), 170 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/CombinedConfiguration.java b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
index a80a6eafe0..f2de1500c5 100644
--- a/src/java/org/apache/commons/configuration/CombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
@@ -823,23 +823,26 @@ private ConfigurationNode constructCombinedNode()
      */
     private Configuration findSourceConfiguration(ConfigurationNode node)
     {
-        ConfigurationNode root = null;
-        ConfigurationNode current = node;
-
-        // find the root node in this hierarchy
-        while (current != null)
+        synchronized(getReloadLock())
         {
-            root = current;
-            current = current.getParentNode();
-        }
+            ConfigurationNode root = null;
+            ConfigurationNode current = node;
 
-        // Check with the root nodes of the child configurations
-        for (Iterator it = configurations.iterator(); it.hasNext();)
-        {
-            ConfigData cd = (ConfigData) it.next();
-            if (root == cd.getRootNode())
+            // find the root node in this hierarchy
+            while (current != null)
             {
-                return cd.getConfiguration();
+                root = current;
+                current = current.getParentNode();
+            }
+
+            // Check with the root nodes of the child configurations
+            for (Iterator it = configurations.iterator(); it.hasNext();)
+            {
+                ConfigData cd = (ConfigData) it.next();
+                if (root == cd.getRootNode())
+                {
+                    return cd.getConfiguration();
+                }
             }
         }
 
@@ -949,11 +952,12 @@ public ConfigurationNode getTransformedRoot()
             }
 
             // Copy data of the root node to the new path
-            rootNode = ConfigurationUtils
+            ConfigurationNode root = ConfigurationUtils
                     .convertToHierarchical(getConfiguration(),
                             getConversionExpressionEngine()).getRootNode();
-            atParent.appendChildren(rootNode);
-            atParent.appendAttributes(rootNode);
+            atParent.appendChildren(root);
+            atParent.appendAttributes(root);
+            rootNode = root;
 
             return result;
         }
diff --git a/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java b/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
index c26d06a536..900be059ec 100644
--- a/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
+++ b/src/java/org/apache/commons/configuration/HierarchicalReloadableConfiguration.java
@@ -53,156 +53,4 @@ public Object getReloadLock()
     {
         return reloadLock;
     }
-
-    public Object getProperty(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.getProperty(key);
-        }
-    }
-
-    protected void addPropertyDirect(String key, Object obj)
-    {
-        synchronized(reloadLock)
-        {
-            super.addPropertyDirect(key, obj);
-        }
-    }
-
-    public void addNodes(String key, Collection nodes)
-    {
-        synchronized(reloadLock)
-        {
-            super.addNodes(key, nodes);
-        }
-    }
-
-    public boolean isEmpty()
-    {
-        synchronized(reloadLock)
-        {
-            return super.isEmpty();
-        }
-    }
-
-    public Configuration subset(String prefix)
-    {
-        synchronized(reloadLock)
-        {
-            return super.subset(prefix);
-        }
-    }
-
-    public SubnodeConfiguration configurationAt(String key, boolean supportUpdates)
-    {
-        synchronized(reloadLock)
-        {
-            return super.configurationAt(key, supportUpdates);
-        }
-    }
-
-    public SubnodeConfiguration configurationAt(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.configurationAt(key);
-        }
-    }
-
-    public List configurationsAt(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.configurationsAt(key);
-        }
-    }
-
-    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node)
-    {
-        synchronized(reloadLock)
-        {
-            return super.createSubnodeConfiguration(node);
-        }
-    }
-
-    protected SubnodeConfiguration createSubnodeConfiguration(ConfigurationNode node, String subnodeKey)
-    {
-        synchronized(reloadLock)
-        {
-            return super.createSubnodeConfiguration(node, subnodeKey);
-        }
-    }
-
-    protected void subnodeConfigurationChanged(ConfigurationEvent event)
-    {
-        synchronized(reloadLock)
-        {
-            super.subnodeConfigurationChanged(event);
-        }
-    }
-
-    void registerSubnodeConfiguration(SubnodeConfiguration config)
-    {
-        synchronized(reloadLock)
-        {
-            super.registerSubnodeConfiguration(config);
-        }
-    }
-
-    public boolean containsKey(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.containsKey(key);
-        }
-    }
-
-    public void setProperty(String key, Object value)
-    {
-        synchronized(reloadLock)
-        {
-            super.setProperty(key, value);
-        }
-    }
-
-    public void clearTree(String key)
-    {
-        synchronized(reloadLock)
-        {
-            super.clearTree(key);
-        }
-    }
-
-    public void clearProperty(String key)
-    {
-        synchronized(reloadLock)
-        {
-            super.clearProperty(key);
-        }
-    }
-
-    public Iterator getKeys()
-    {
-        synchronized(reloadLock)
-        {
-            return super.getKeys();
-        }
-    }
-
-    public Iterator getKeys(String prefix)
-    {
-        synchronized(reloadLock)
-        {
-            return super.getKeys(prefix);
-        }
-    }
-
-    public int getMaxIndex(String key)
-    {
-        synchronized(reloadLock)
-        {
-            return super.getMaxIndex(key);
-        }
-    }
 }
diff --git a/src/java/org/apache/commons/configuration/Lock.java b/src/java/org/apache/commons/configuration/Lock.java
index c6e3206655..c89f60ea27 100644
--- a/src/java/org/apache/commons/configuration/Lock.java
+++ b/src/java/org/apache/commons/configuration/Lock.java
@@ -31,6 +31,6 @@ public String getName()
 
     public String toString()
     {
-        return "Lock: " + name + " id = " + instanceId;
+        return "Lock: " + name + " id = " + instanceId + ": " + super.toString();
     }
 }
diff --git a/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java b/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
index c9c0c80568..6e27acd4d4 100644
--- a/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
+++ b/src/java/org/apache/commons/configuration/MultiFileHierarchicalConfiguration.java
@@ -408,6 +408,11 @@ public Configuration subset(String prefix)
         return this.getConfiguration().subset(prefix);
     }
 
+    public Object getReloadLock()
+    {
+        return this.getConfiguration().getReloadLock();
+    }
+
     public Node getRoot()
     {
         return this.getConfiguration().getRoot();
diff --git a/src/java/org/apache/commons/configuration/PatternSubtreeConfigurationWrapper.java b/src/java/org/apache/commons/configuration/PatternSubtreeConfigurationWrapper.java
index 73a44cdefa..56c47ad89b 100644
--- a/src/java/org/apache/commons/configuration/PatternSubtreeConfigurationWrapper.java
+++ b/src/java/org/apache/commons/configuration/PatternSubtreeConfigurationWrapper.java
@@ -78,6 +78,11 @@ public PatternSubtreeConfigurationWrapper(AbstractHierarchicalFileConfiguration
         this.init = true;
     }
 
+    public Object getReloadLock()
+    {
+        return config.getReloadLock();
+    }
+
     public void addProperty(String key, Object value)
     {
         config.addProperty(makePath(key), value);

From 6662bcbf6b789d2c291f9c63cd9c9204f1efd454 Mon Sep 17 00:00:00 2001
From: Ralph Goers <rgoers@apache.org>
Date: Mon, 5 Oct 2009 20:02:54 +0000
Subject: [PATCH 6/6] Add the bean class name to the exception to help identify
 the problem

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/branches/CONFIGURATION_390@821988 13f79535-47bb-0310-9956-ffa450edef68
---
 .../org/apache/commons/configuration/beanutils/BeanHelper.java  | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/java/org/apache/commons/configuration/beanutils/BeanHelper.java b/src/java/org/apache/commons/configuration/beanutils/BeanHelper.java
index 47ca6cb1c5..58458658b8 100644
--- a/src/java/org/apache/commons/configuration/beanutils/BeanHelper.java
+++ b/src/java/org/apache/commons/configuration/beanutils/BeanHelper.java
@@ -263,7 +263,7 @@ private static void initProperty(Object bean, String propName, Object value)
         if (!PropertyUtils.isWriteable(bean, propName))
         {
             throw new ConfigurationRuntimeException("Property " + propName
-                    + " cannot be set!");
+                    + " cannot be set on " + bean.getClass().getName());
         }
 
         try
