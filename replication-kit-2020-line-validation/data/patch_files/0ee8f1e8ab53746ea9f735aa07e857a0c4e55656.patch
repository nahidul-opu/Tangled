From 0ee8f1e8ab53746ea9f735aa07e857a0c4e55656 Mon Sep 17 00:00:00 2001
From: Stefan Bodewig <bodewig@apache.org>
Date: Wed, 26 Apr 2017 06:24:43 +0200
Subject: [PATCH] COMPRESS-389 only increment loc when anything has been read

---
 src/changes/changes.xml                                       | 4 ++++
 .../org/apache/commons/compress/archivers/zip/ZipFile.java    | 3 ++-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 3b24da7c4a6..d40a1a8d365 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -99,6 +99,10 @@ The <action> type attribute can be add,update,fix,remove.
         Added a way to limit amount of memory LZMACompressorStream and
         XZCompressorInputStream may use.
       </action>
+      <action issue="COMPRESS-389" type="fix" date="2017-04-26">
+        Internal location pointer in ZipFile could get incremented
+        even if nothing had been read.
+      </action>
     </release>
     <release version="1.13" date="2016-12-29"
              description="Release 1.13 - API compatible to 1.12 but requires Java 7 at runtime.">
diff --git a/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java b/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java
index 0623656d813..fc7510abb27 100644
--- a/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java
+++ b/src/main/java/org/apache/commons/compress/archivers/zip/ZipFile.java
@@ -1126,10 +1126,11 @@ public synchronized int read() throws IOException {
             else {
                 singleByteBuffer.rewind();
             }
-            int read = read(loc++, singleByteBuffer);
+            int read = read(loc, singleByteBuffer);
             if (read < 0) {
                 return read;
             }
+            loc++;
             return singleByteBuffer.get() & 0xff;
         }
 
