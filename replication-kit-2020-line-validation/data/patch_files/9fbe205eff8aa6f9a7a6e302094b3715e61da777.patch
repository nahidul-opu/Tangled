From 9fbe205eff8aa6f9a7a6e302094b3715e61da777 Mon Sep 17 00:00:00 2001
From: Sebastian Bazley <sebb@apache.org>
Date: Thu, 26 Mar 2009 20:46:31 +0000
Subject: [PATCH] COMPRESS-55 Don't attempt to set mode zero. Print error if
 mode 0 found not in trailer.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/compress/trunk@758846 13f79535-47bb-0310-9956-ffa450edef68
---
 .../archivers/cpio/CpioArchiveInputStream.java       | 12 ++++++++++--
 1 file changed, 10 insertions(+), 2 deletions(-)

diff --git a/src/main/java/org/apache/commons/compress/archivers/cpio/CpioArchiveInputStream.java b/src/main/java/org/apache/commons/compress/archivers/cpio/CpioArchiveInputStream.java
index 65115835a0d..5a3240ebdc4 100644
--- a/src/main/java/org/apache/commons/compress/archivers/cpio/CpioArchiveInputStream.java
+++ b/src/main/java/org/apache/commons/compress/archivers/cpio/CpioArchiveInputStream.java
@@ -321,7 +321,10 @@ private CpioArchiveEntry readNewEntry(final boolean hasCrc)
         }
 
         ret.setInode(readAsciiLong(8, 16));
-        ret.setMode(readAsciiLong(8, 16));
+        long mode = readAsciiLong(8, 16);
+        if (mode != 0){ // mode is initialised to 0
+            ret.setMode(mode);
+        }
         ret.setUID(readAsciiLong(8, 16));
         ret.setGID(readAsciiLong(8, 16));
         ret.setNumberOfLinks(readAsciiLong(8, 16));
@@ -333,7 +336,12 @@ private CpioArchiveEntry readNewEntry(final boolean hasCrc)
         ret.setRemoteDeviceMin(readAsciiLong(8, 16));
         long namesize = readAsciiLong(8, 16);
         ret.setChksum(readAsciiLong(8, 16));
-        ret.setName(readCString((int) namesize));
+        String name = readCString((int) namesize);
+        ret.setName(name);
+        if (mode == 0 && !name.equals(CPIO_TRAILER)){
+            // TODO - change this to throw
+            new IOException("Mode 0 only allowed in the trailer. Found: "+name).printStackTrace();
+        }
         pad(ret.getHeaderSize() + namesize, 4);
 
         return ret;
