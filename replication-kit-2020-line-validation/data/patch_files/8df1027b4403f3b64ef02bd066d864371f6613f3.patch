From 8df1027b4403f3b64ef02bd066d864371f6613f3 Mon Sep 17 00:00:00 2001
From: Alessandro Presta <alessandro@fb.com>
Date: Tue, 30 Jul 2013 11:49:25 -0700
Subject: [PATCH] GIRAPH-725: AggregatorWrapper instantiates aggregator
 bypassing ReflectionUtils (apresta)

---
 .../org/apache/giraph/aggregators/AggregatorWrapper.java  | 8 ++++++--
 .../org/apache/giraph/master/MasterAggregatorHandler.java | 2 +-
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/giraph-core/src/main/java/org/apache/giraph/aggregators/AggregatorWrapper.java b/giraph-core/src/main/java/org/apache/giraph/aggregators/AggregatorWrapper.java
index 6b98085bd..961380502 100644
--- a/giraph-core/src/main/java/org/apache/giraph/aggregators/AggregatorWrapper.java
+++ b/giraph-core/src/main/java/org/apache/giraph/aggregators/AggregatorWrapper.java
@@ -18,6 +18,8 @@
 
 package org.apache.giraph.aggregators;
 
+import org.apache.giraph.conf.ImmutableClassesGiraphConfiguration;
+import org.apache.giraph.utils.ReflectionUtils;
 import org.apache.hadoop.io.Writable;
 
 /**
@@ -41,14 +43,16 @@ public class AggregatorWrapper<A extends Writable> {
    * @param aggregatorClass Class type of the aggregator
    * @param persistent      False iff aggregator should be reset at the end of
    *                        each super step
+   * @param conf            Configuration
    * @throws IllegalAccessException
    * @throws InstantiationException
    */
   public AggregatorWrapper(Class<? extends Aggregator<A>> aggregatorClass,
-      boolean persistent) throws IllegalAccessException,
+      boolean persistent, ImmutableClassesGiraphConfiguration conf) throws
+      IllegalAccessException,
       InstantiationException {
     this.persistent = persistent;
-    currentAggregator = aggregatorClass.newInstance();
+    currentAggregator = ReflectionUtils.newInstance(aggregatorClass, conf);
     changed = false;
     previousAggregatedValue = currentAggregator.createInitialValue();
   }
diff --git a/giraph-core/src/main/java/org/apache/giraph/master/MasterAggregatorHandler.java b/giraph-core/src/main/java/org/apache/giraph/master/MasterAggregatorHandler.java
index 053791502..325d91f37 100644
--- a/giraph-core/src/main/java/org/apache/giraph/master/MasterAggregatorHandler.java
+++ b/giraph-core/src/main/java/org/apache/giraph/master/MasterAggregatorHandler.java
@@ -149,7 +149,7 @@ private void checkAggregatorName(String name) {
         (AggregatorWrapper<A>) aggregatorMap.get(name);
     if (aggregatorWrapper == null) {
       aggregatorWrapper =
-          new AggregatorWrapper<A>(aggregatorClass, persistent);
+          new AggregatorWrapper<A>(aggregatorClass, persistent, conf);
       aggregatorMap.put(name, (AggregatorWrapper<Writable>) aggregatorWrapper);
     }
     return aggregatorWrapper;
