From d75768a4b2e71f88bf47ee45163fd671bebbd7e3 Mon Sep 17 00:00:00 2001
From: Thomas Neidhart <tn@apache.org>
Date: Sun, 8 Nov 2015 21:07:13 +0000
Subject: [PATCH] Backport COLLECTIONS-334 to 3.2.2.

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/collections/branches/COLLECTIONS_3_2_X@1713294 13f79535-47bb-0310-9956-ffa450edef68
---
 src/changes/changes.xml                                     | 6 +++---
 .../org/apache/commons/collections/map/StaticBucketMap.java | 4 +++-
 2 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/src/changes/changes.xml b/src/changes/changes.xml
index 9d3a1b7730..053ccc5b43 100644
--- a/src/changes/changes.xml
+++ b/src/changes/changes.xml
@@ -35,6 +35,9 @@
     <action issue="COLLECTIONS-335" dev="jochen" type="fix" due-to="sebb">
       Fixed cache assignment for "TreeBidiMap#entrySet".
     </action>
+    <action issue="COLLECTIONS-334" dev="jochen" type="fix" due-to="sebb">
+      Synchronized access to lock in "StaticBucketMap#size()".
+    </action>
     <action issue="COLLECTIONS-294" dev="bayard" type="fix" due-to="Benjamin Bentmann">
       "CaseInsensitiveMap" will now convert input strings to lower-case in a
       locale-independent manner.
@@ -76,9 +79,6 @@
       "ListUtils#intersection(List, List)" will now also work correctly if there
       are duplicate elements in the provided lists.
     </action>
-    <action issue="COLLECTIONS-334" dev="jochen" type="fix" due-to="sebb">
-      Synchronized access to lock in "StaticBucketMap#size()".
-    </action>
     <action issue="COLLECTIONS-330" dev="mbenson" type="fix" due-to="Joerg Schaible">
       "LRUMap#keySet()#remove(Object)" will not throw a "ConcurrentModificationException" anymore.
     </action>
diff --git a/src/java/org/apache/commons/collections/map/StaticBucketMap.java b/src/java/org/apache/commons/collections/map/StaticBucketMap.java
index 4a130c3f64..1a0d379d8b 100644
--- a/src/java/org/apache/commons/collections/map/StaticBucketMap.java
+++ b/src/java/org/apache/commons/collections/map/StaticBucketMap.java
@@ -182,7 +182,9 @@ public int size() {
         int cnt = 0;
 
         for (int i = 0; i < buckets.length; i++) {
-            cnt += locks[i].size;
+            synchronized(locks[i]) {
+                cnt += locks[i].size;
+            }
         }
         return cnt;
     }
