From 51f88c4ed6a975677114745e3c92d6b9f49377fa Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Sun, 2 Mar 2008 21:00:44 +0000
Subject: [PATCH] CONFIGURATION-315: CombinedConfiguration now only sends a
 single EVENT_COMBINED_INVALIDATE event for a changed child configuration

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/configuration/trunk@632843 13f79535-47bb-0310-9956-ffa450edef68
---
 .../configuration/CombinedConfiguration.java    |  5 ++++-
 .../TestCombinedConfiguration.java              | 17 ++++++++++++++++-
 xdocs/changes.xml                               |  5 +++++
 3 files changed, 25 insertions(+), 2 deletions(-)

diff --git a/src/java/org/apache/commons/configuration/CombinedConfiguration.java b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
index 4cee442d82..780f42ec99 100644
--- a/src/java/org/apache/commons/configuration/CombinedConfiguration.java
+++ b/src/java/org/apache/commons/configuration/CombinedConfiguration.java
@@ -485,7 +485,10 @@ public void invalidate()
      */
     public void configurationChanged(ConfigurationEvent event)
     {
-        invalidate();
+        if (!event.isBeforeUpdate())
+        {
+            invalidate();
+        }
     }
 
     /**
diff --git a/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java b/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java
index 5af480bf54..667f87c515 100644
--- a/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java
+++ b/src/test/org/apache/commons/configuration/TestCombinedConfiguration.java
@@ -319,7 +319,7 @@ public void testUpdateContainedConfiguration()
         c.addProperty("test.otherTest", "yes");
         assertEquals("New property not found", "yes", config
                 .getString("test.otherTest"));
-        listener.checkEvent(3, 0);
+        listener.checkEvent(2, 0);
     }
 
     /**
@@ -569,6 +569,21 @@ public void testEscapeListDelimiters()
         assertEquals("Wrong value", "3,1415", config.getString("test.pi"));
     }
 
+    /**
+     * Tests whether an invalidate event is fired only after a change. This test
+     * is related to CONFIGURATION-315.
+     */
+    public void testInvalidateAfterChange()
+    {
+        ConfigurationEvent event = new ConfigurationEvent(config, 0, null,
+                null, true);
+        config.configurationChanged(event);
+        assertEquals("Invalidate event fired", 0, listener.invalidateEvents);
+        event = new ConfigurationEvent(config, 0, null, null, false);
+        config.configurationChanged(event);
+        assertEquals("No invalidate event fired", 1, listener.invalidateEvents);
+    }
+
     /**
      * Helper method for writing a file.
      *
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index bfb19d2437..555899ecb2 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,11 @@
 
   <body>
     <release version="1.6" date="in SVN" description="">
+      <action dev="oheger" type="fix" issue="CONFIGURATION-315">
+        CombinedConfiguration used to send two EVENT_COMBINED_INVALIDATE events
+        for each modified child configuration. Now this event is sent only
+        once after the affected child configuration was updated.
+      </action>
       <action dev="oheger" type="fix" issue="CONFIGURATION-306">
         INIConfiguration now preserves whitespace in quoted values.
       </action>
