From a31f7779307e722d29258b452e09ee01a735eebb Mon Sep 17 00:00:00 2001
From: Oliver Heger <oheger@apache.org>
Date: Mon, 30 Oct 2006 20:22:50 +0000
Subject: [PATCH] Updated ConfigurationDynaBean to better work together with
 different types of configurations; fix for CONFIGURATION-227

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/configuration/trunk@469259 13f79535-47bb-0310-9956-ffa450edef68
---
 .../beanutils/ConfigurationDynaBean.java      | 20 ++++++---
 .../TestConfigurationDynaBeanXMLConfig.java   | 44 +++++++++++++++++++
 xdocs/changes.xml                             |  4 ++
 3 files changed, 61 insertions(+), 7 deletions(-)
 create mode 100644 src/test/org/apache/commons/configuration/beanutils/TestConfigurationDynaBeanXMLConfig.java

diff --git a/src/java/org/apache/commons/configuration/beanutils/ConfigurationDynaBean.java b/src/java/org/apache/commons/configuration/beanutils/ConfigurationDynaBean.java
index b93685d065..002e4164ce 100644
--- a/src/java/org/apache/commons/configuration/beanutils/ConfigurationDynaBean.java
+++ b/src/java/org/apache/commons/configuration/beanutils/ConfigurationDynaBean.java
@@ -25,6 +25,7 @@
 import org.apache.commons.configuration.Configuration;
 import org.apache.commons.configuration.ConfigurationMap;
 import org.apache.commons.configuration.ConversionException;
+import org.apache.commons.configuration.SubsetConfiguration;
 import org.apache.commons.lang.BooleanUtils;
 import org.apache.commons.logging.Log;
 import org.apache.commons.logging.LogFactory;
@@ -44,12 +45,20 @@
  * {@link org.apache.commons.configuration.Configuration#getList(String)}
  * method. Setting an indexed property always throws an exception.</p>
  *
+ * <p>Note: Some of the methods expect that a dot (&quot;.&quot;) is used as
+ * property delimitor for the wrapped configuration. This is true for most of
+ * the default configurations. Hierarchical configurations, for which a specific
+ * expression engine is set, may cause problems.</p>
+ *
  * @author <a href="mailto:ricardo.gladwell@btinternet.com">Ricardo Gladwell</a>
  * @version $Revision$, $Date$
  * @since 1.0-rc1
  */
 public class ConfigurationDynaBean extends ConfigurationMap implements DynaBean
 {
+    /** Constant for the property delimiter.*/
+    private static final String PROPERTY_DELIMITER = ".";
+
     /** The logger.*/
     private static Log log = LogFactory.getLog(ConfigurationDynaBean.class);
 
@@ -184,10 +193,10 @@ public Object get(String name)
         if (result == null)
         {
             // otherwise attempt to create bean from configuration subset
-            Configuration subset = getConfiguration().subset(name);
+            Configuration subset = new SubsetConfiguration(getConfiguration(), name, PROPERTY_DELIMITER);
             if (!subset.isEmpty())
             {
-                result = new ConfigurationDynaBean(getConfiguration().subset(name));
+                result = new ConfigurationDynaBean(subset);
             }
         }
 
@@ -265,11 +274,7 @@ public DynaClass getDynaClass()
      */
     public void remove(String name, String key)
     {
-        Configuration subset = getConfiguration().subset(name);
-        if (subset == null)
-        {
-            throw new IllegalArgumentException("Mapped property '" + name + "' does not exist.");
-        }
+        Configuration subset = new SubsetConfiguration(getConfiguration(), name, PROPERTY_DELIMITER);
         subset.setProperty(key, null);
     }
 
@@ -290,6 +295,7 @@ else if (property instanceof List)
             {
                 List list = (List) property;
                 list.set(index, value);
+                getConfiguration().setProperty(name, list);
             }
             else if (property.getClass().isArray())
             {
diff --git a/src/test/org/apache/commons/configuration/beanutils/TestConfigurationDynaBeanXMLConfig.java b/src/test/org/apache/commons/configuration/beanutils/TestConfigurationDynaBeanXMLConfig.java
new file mode 100644
index 0000000000..e84b9ef25e
--- /dev/null
+++ b/src/test/org/apache/commons/configuration/beanutils/TestConfigurationDynaBeanXMLConfig.java
@@ -0,0 +1,44 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one or more
+ * contributor license agreements.  See the NOTICE file distributed with
+ * this work for additional information regarding copyright ownership.
+ * The ASF licenses this file to You under the Apache License, Version 2.0
+ * (the "License"); you may not use this file except in compliance with
+ * the License.  You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package org.apache.commons.configuration.beanutils;
+
+import org.apache.commons.configuration.Configuration;
+import org.apache.commons.configuration.XMLConfiguration;
+
+/**
+ * An additional test class for ConfigurationDynaBean. This test class performs
+ * the same tests as the default test class, but uses a XMLConfiguration as
+ * underlying configuration object.
+ *
+ * @author <a
+ * href="http://jakarta.apache.org/commons/configuration/team-list.html">Commons
+ * Configuration team</a>
+ * @version $Id$
+ */
+public class TestConfigurationDynaBeanXMLConfig extends
+        TestConfigurationDynaBean
+{
+    /**
+     * Creates the underlying configuration object. This implementation will
+     * create a XMLConfiguration.
+     * @return the underlying configuration
+     */
+    protected Configuration createConfiguration()
+    {
+        return new XMLConfiguration();
+    }
+}
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index 66315530a1..38c2801dc3 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -23,6 +23,10 @@
 
   <body>
     <release version="1.4-dev" date="in SVN">
+      <action dev="oheger" type="update" issue="CONFIGURATION-227">
+        The compatibility of ConfigurationDynaBean with other configuration types
+        than those that inherit from BaseConfiguration was improved.
+      </action>
       <action dev="oheger" type="update" issue="CONFIGURATION-233" due-to="Rainer Jung">
         The getList() method of CompositeConfiguration does now fully support
         variable interpolation. So it is possible to refer to a variable in
