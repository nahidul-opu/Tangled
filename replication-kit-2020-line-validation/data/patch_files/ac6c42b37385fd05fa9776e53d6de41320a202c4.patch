From ac6c42b37385fd05fa9776e53d6de41320a202c4 Mon Sep 17 00:00:00 2001
From: Kevin <djkevincr@yahoo.com>
Date: Sun, 18 Sep 2016 22:01:12 +0530
Subject: [PATCH] adding fix for GORA-401

---
 .../org/apache/gora/mapreduce/PersistentDeserializer.java   | 6 +++++-
 .../org/apache/gora/mapreduce/PersistentSerializer.java     | 2 +-
 .../src/test/java/org/apache/gora/util/TestIOUtils.java     | 5 +++++
 3 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentDeserializer.java b/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentDeserializer.java
index 79eee4291..8a957b91d 100644
--- a/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentDeserializer.java
+++ b/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentDeserializer.java
@@ -68,6 +68,10 @@ public void close() throws IOException { }
 
   @Override
   public PersistentBase deserialize(PersistentBase persistent) throws IOException {
-    return datumReader.read(reuseObjects ? persistent : null, decoder);
+    persistent = datumReader.read(reuseObjects ? persistent : null, decoder);
+    byte[] __g__dirty = new byte[persistent.getFieldsCount()];
+    decoder.readFixed(__g__dirty);
+    persistent.setDirtyBytes(java.nio.ByteBuffer.wrap(__g__dirty));
+    return persistent;
   }
 }
diff --git a/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentSerializer.java b/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentSerializer.java
index b75d1dd75..1851ff51b 100644
--- a/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentSerializer.java
+++ b/gora-core/src/main/java/org/apache/gora/mapreduce/PersistentSerializer.java
@@ -63,7 +63,7 @@ public void open(OutputStream out) throws IOException {
   @Override
   public void serialize(PersistentBase persistent) throws IOException {
     datumWriter.setSchema(persistent.getSchema());
-        
     datumWriter.write(persistent, encoder);
+    encoder.writeFixed(persistent.getDirtyBytes().array());
   }
 }
diff --git a/gora-core/src/test/java/org/apache/gora/util/TestIOUtils.java b/gora-core/src/test/java/org/apache/gora/util/TestIOUtils.java
index d0f3e1c92..ec2a791cb 100644
--- a/gora-core/src/test/java/org/apache/gora/util/TestIOUtils.java
+++ b/gora-core/src/test/java/org/apache/gora/util/TestIOUtils.java
@@ -30,6 +30,7 @@
 import org.apache.avro.util.ByteBufferInputStream;
 import org.apache.avro.util.ByteBufferOutputStream;
 import org.apache.gora.mapreduce.GoraMapReduceUtils;
+import org.apache.gora.persistency.impl.PersistentBase;
 import org.apache.gora.util.IOUtils;
 import org.apache.hadoop.conf.Configuration;
 import org.apache.hadoop.io.DataInputBuffer;
@@ -135,6 +136,10 @@ public static <T> void testSerializeDeserialize(T... objects) throws Exception {
           log.info("After : " + before);
         }
         assertEquals(before, after);
+        if ((before instanceof PersistentBase) && (after instanceof PersistentBase)) {
+          assertEquals(Arrays.equals(((PersistentBase) before).getDirtyBytes().array(),
+                  ((PersistentBase) after).getDirtyBytes().array()), true);
+        }
       }
       
       //assert that the end of input is reached
