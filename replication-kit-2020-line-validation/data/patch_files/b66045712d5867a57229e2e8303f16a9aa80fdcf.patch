From b66045712d5867a57229e2e8303f16a9aa80fdcf Mon Sep 17 00:00:00 2001
From: Niall Kegan Pemberton <niallp@apache.org>
Date: Thu, 23 Nov 2006 13:09:27 +0000
Subject: [PATCH] VALIDATOR-190 - EmailValidator allows control characters
 (ASCII 0-31 and 127) - thanks to Cott and Gabriel Belingueres

git-svn-id: https://svn.apache.org/repos/asf/jakarta/commons/proper/validator/trunk@478560 13f79535-47bb-0310-9956-ffa450edef68
---
 .../org/apache/commons/validator/EmailValidator.java |  2 +-
 src/test/org/apache/commons/validator/EmailTest.java | 12 ++++++++++++
 xdocs/changes.xml                                    |  5 +++++
 3 files changed, 18 insertions(+), 1 deletion(-)

diff --git a/src/share/org/apache/commons/validator/EmailValidator.java b/src/share/org/apache/commons/validator/EmailValidator.java
index a220cdd11..1b1b73292 100644
--- a/src/share/org/apache/commons/validator/EmailValidator.java
+++ b/src/share/org/apache/commons/validator/EmailValidator.java
@@ -38,7 +38,7 @@
  */
 public class EmailValidator {
 
-    private static final String SPECIAL_CHARS = "\\(\\)<>@,;:'\\\\\\\"\\.\\[\\]";
+    private static final String SPECIAL_CHARS = "\\000-\\037\\(\\)<>@,;:'\\\\\\\"\\.\\[\\]\\177";
     private static final String VALID_CHARS = "[^\\s" + SPECIAL_CHARS + "]";
     private static final String QUOTED_USER = "(\"[^\"]*\")";
     private static final String ATOM = VALID_CHARS + '+';
diff --git a/src/test/org/apache/commons/validator/EmailTest.java b/src/test/org/apache/commons/validator/EmailTest.java
index a5780128d..a1a3496e1 100644
--- a/src/test/org/apache/commons/validator/EmailTest.java
+++ b/src/test/org/apache/commons/validator/EmailTest.java
@@ -221,6 +221,18 @@ public void testEmailWithSpaces() throws ValidatorException {
 
     }
 
+   /**
+    * Tests the email validation with ascii control characters.
+    * (i.e. Ascii chars 0 - 31 and 127)
+    */
+    public void testEmailWithControlChars() throws ValidatorException {
+        EmailValidator validator = new EmailValidator();
+        for (char c = 0; c < 32; c++) {
+            assertFalse("Test control char " + ((int)c), validator.isValid("foo" + c + "bar@domain.com"));
+        }
+        assertFalse("Test control char 127", validator.isValid("foo" + ((char)127) + "bar@domain.com"));
+    }
+
     /**
      * Write this test according to parts of RFC, as opposed to the type of character
      * that is being tested.
diff --git a/xdocs/changes.xml b/xdocs/changes.xml
index a3d655632..fa3d652f9 100644
--- a/xdocs/changes.xml
+++ b/xdocs/changes.xml
@@ -40,6 +40,11 @@ The <action> type attribute can be add,update,fix,remove.
   <body>
 
     <release version="1.3.1" date="Pending">
+      <action dev="niallp" type="fix" issue="VALIDATOR-190">
+        EmailValidator allows control characters (ASCII 0-31 and 127).
+        <dueto name="Cott"/>
+        <dueto name="Gabriel Belingueres"/>
+      </action>
       <action dev="niallp" type="fix" issue="VALIDATOR-210" due-to="Neil Sherman">
         JavaScript Causes HTML Page to Contain Illegal HTML.
       </action>
