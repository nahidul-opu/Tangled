From ff970f2db73018f6f48b5361ffd9e21c5154aba9 Mon Sep 17 00:00:00 2001
From: Maja Kabiljo <majakabiljo@maja-mbp.thefacebook.com>
Date: Fri, 3 May 2013 10:20:55 -0700
Subject: [PATCH] GIRAPH-653: Hadoop_non_secure broken (majakabiljo)

---
 CHANGELOG                                         |  2 ++
 .../io/internal/WrappedVertexOutputFormat.java    | 15 ++++++++-------
 .../org/apache/giraph/yarn/GiraphYarnTask.java    |  2 +-
 3 files changed, 11 insertions(+), 8 deletions(-)

diff --git a/CHANGELOG b/CHANGELOG
index 765c2343a..7c906d292 100644
--- a/CHANGELOG
+++ b/CHANGELOG
@@ -1,6 +1,8 @@
 Giraph Change Log
 
 Release 1.0.1 - unreleased
+  GIRAPH-653: Hadoop_non_secure broken (majakabiljo)
+
   GIRAPH-650: Exception in GiraphConfiguration initialization (majakabiljo)
 
   GIRAPH-648: Allow IO formats to add parameters to Configuration (majakabiljo)
diff --git a/giraph-core/src/main/java/org/apache/giraph/io/internal/WrappedVertexOutputFormat.java b/giraph-core/src/main/java/org/apache/giraph/io/internal/WrappedVertexOutputFormat.java
index c1046ae1b..e5b9ef74a 100644
--- a/giraph-core/src/main/java/org/apache/giraph/io/internal/WrappedVertexOutputFormat.java
+++ b/giraph-core/src/main/java/org/apache/giraph/io/internal/WrappedVertexOutputFormat.java
@@ -25,7 +25,9 @@
 import org.apache.hadoop.io.Writable;
 import org.apache.hadoop.io.WritableComparable;
 import org.apache.hadoop.mapreduce.JobContext;
+/*if_not[HADOOP_NON_SECURE]*/
 import org.apache.hadoop.mapreduce.JobStatus;
+/*end[HADOOP_NON_SECURE]*/
 import org.apache.hadoop.mapreduce.OutputCommitter;
 import org.apache.hadoop.mapreduce.TaskAttemptContext;
 
@@ -141,17 +143,16 @@ public void abortTask(TaskAttemptContext context) throws IOException {
       }
 
       @Override
-      public void commitJob(JobContext context) throws IOException {
+      public void cleanupJob(JobContext context) throws IOException {
         getConf().updateConfiguration(context.getConfiguration());
-        outputCommitter.commitJob(context);
-
+        outputCommitter.cleanupJob(context);
       }
 
+      /*if_not[HADOOP_NON_SECURE]*/
       @Override
-      public void cleanupJob(JobContext context) throws IOException {
+      public void commitJob(JobContext context) throws IOException {
         getConf().updateConfiguration(context.getConfiguration());
-        outputCommitter.cleanupJob(context);
-
+        outputCommitter.commitJob(context);
       }
 
       @Override
@@ -159,8 +160,8 @@ public void abortJob(JobContext context,
           JobStatus.State state) throws IOException {
         getConf().updateConfiguration(context.getConfiguration());
         outputCommitter.abortJob(context, state);
-
       }
+      /*end[HADOOP_NON_SECURE]*/
     };
   }
 }
diff --git a/giraph-core/src/main/java/org/apache/giraph/yarn/GiraphYarnTask.java b/giraph-core/src/main/java/org/apache/giraph/yarn/GiraphYarnTask.java
index d596413de..6f869fe5b 100644
--- a/giraph-core/src/main/java/org/apache/giraph/yarn/GiraphYarnTask.java
+++ b/giraph-core/src/main/java/org/apache/giraph/yarn/GiraphYarnTask.java
@@ -121,7 +121,7 @@ private void finalizeYarnJob() {
       try {
         LOG.info("Master is ready to commit final job output data.");
         VertexOutputFormat vertexOutputFormat =
-          conf.createVertexOutputFormat();
+          conf.createWrappedVertexOutputFormat();
         OutputCommitter outputCommitter =
           vertexOutputFormat.getOutputCommitter(proxy);
         // now we will have our output in OUTDIR if all went well...
