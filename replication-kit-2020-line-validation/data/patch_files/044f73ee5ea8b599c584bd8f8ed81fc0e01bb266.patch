From 044f73ee5ea8b599c584bd8f8ed81fc0e01bb266 Mon Sep 17 00:00:00 2001
From: Xavier Hanin <xavier@apache.org>
Date: Fri, 14 Apr 2006 14:21:22 +0000
Subject: [PATCH] FIX: specifying a defaultconfmapping adds dependencies of
 each unlisted configuration (IVY-214) (thanks to Maarten Coene)

git-svn-id: https://svn.apache.org/repos/asf/incubator/ivy/trunk@484280 13f79535-47bb-0310-9956-ffa450edef68
---
 CHANGES.txt                                          |  1 +
 .../ivy/parser/AbstractModuleDescriptorParser.java   |  9 +++++++--
 test/java/fr/jayasoft/ivy/ResolveTest.java           |  9 +++++++++
 test/java/fr/jayasoft/ivy/ivy-214.xml                | 12 ++++++++++++
 4 files changed, 29 insertions(+), 2 deletions(-)
 create mode 100644 test/java/fr/jayasoft/ivy/ivy-214.xml

diff --git a/CHANGES.txt b/CHANGES.txt
index 5f7fd54b1..500364d51 100644
--- a/CHANGES.txt
+++ b/CHANGES.txt
@@ -9,6 +9,7 @@
 - IMPROVE: Change default cache artifact pattern to handle missing extension (IVY-196) (thanks to Johan Stuyts)
 - IMPROVE: Log messages do not display most specfic resolver name (IVY-170)
 
+- FIX: specifying a defaultconfmapping adds dependencies of each unlisted configuration (IVY-214) (thanks to Maarten Coene)
 - FIX: Ivy fails when downloading from a server that supports NTLM authentication (IVY-213) (thanks to Damon Rand)
 - FIX: problem with cache and returnFirst (IVY-207)
 - FIX: modules splitted across a chain are not handled correctly (IVY-206)
diff --git a/src/java/fr/jayasoft/ivy/parser/AbstractModuleDescriptorParser.java b/src/java/fr/jayasoft/ivy/parser/AbstractModuleDescriptorParser.java
index b6562da64..5bfa39d28 100644
--- a/src/java/fr/jayasoft/ivy/parser/AbstractModuleDescriptorParser.java
+++ b/src/java/fr/jayasoft/ivy/parser/AbstractModuleDescriptorParser.java
@@ -84,8 +84,13 @@ protected void parseDepsConfs(String confs, DefaultDependencyDescriptor dd, bool
                     } else {
                         for (int j = 0; j < modConfs.length; j++) {
                             String[] depConfs = getDefaultConfMappingDescriptor().getDependencyConfigurations(modConfs[j]);
-                            for (int k = 0; k < depConfs.length; k++) {
-                                dd.addDependencyConfiguration(modConfs[j].trim(), depConfs[k].trim());
+                            if (depConfs.length > 0) {
+                                for (int k = 0; k < depConfs.length; k++) {
+                                    dd.addDependencyConfiguration(modConfs[j].trim(), depConfs[k].trim());
+                                }
+                            } else {
+                                // no default mapping found for this configuration, map configuration to itself
+                                dd.addDependencyConfiguration(modConfs[j].trim(), modConfs[j].trim());
                             }
                         }
                     }
diff --git a/test/java/fr/jayasoft/ivy/ResolveTest.java b/test/java/fr/jayasoft/ivy/ResolveTest.java
index 01e894af5..443ac92b6 100644
--- a/test/java/fr/jayasoft/ivy/ResolveTest.java
+++ b/test/java/fr/jayasoft/ivy/ResolveTest.java
@@ -1340,6 +1340,15 @@ public void testIVY56() throws Exception {
                 null, new String[] {"default"}, _cache, null, true);
         assertNotNull(report);
     }
+        
+    public void testIVY214() throws Exception {
+        ResolveReport report = _ivy.resolve(ResolveTest.class.getResource("ivy-214.xml"), null, new String[] {"compile"}, _cache, null, true);
+        
+        assertNotNull(report);
+        assertFalse(report.hasError());
+        
+        assertEquals("Number of artifacts not correct", 1, report.getConfigurationReport("compile").getArtifactsNumber());
+    }
     
     public void testCircular() throws Exception {
         try {
diff --git a/test/java/fr/jayasoft/ivy/ivy-214.xml b/test/java/fr/jayasoft/ivy/ivy-214.xml
new file mode 100644
index 000000000..fbef39bd9
--- /dev/null
+++ b/test/java/fr/jayasoft/ivy/ivy-214.xml
@@ -0,0 +1,12 @@
+<ivy-module version="1.0">
+	<info organisation="test" module="IVY-214" status="integration" publication="20050202110000"/>
+	<configurations defaultconfmapping="compile-&gt;default">
+		<conf name="compile"/>
+		<conf name="runtime" extends="compile"/>
+		<conf name="test" extends="runtime"/>
+	</configurations>
+	<dependencies>
+		<dependency org="org1" name="mod1.2" rev="1+" force="true" conf="compile"/>
+		<dependency org="org3" name="mod3.2" rev="1+" conf="test"/>
+	</dependencies>
+</ivy-module>
\ No newline at end of file
