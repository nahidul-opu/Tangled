From c3d13908a2e8ca7b9832fa693ca72bc228a4e92d Mon Sep 17 00:00:00 2001
From: Stian Soiland-Reyes <stain@apache.org>
Date: Mon, 12 Sep 2016 17:23:28 +0000
Subject: [PATCH] BEANUTILS-495 workaround - sometimes Java 9 expects "," in US
 date

git-svn-id: https://svn.apache.org/repos/asf/commons/proper/beanutils/trunk@1760415 13f79535-47bb-0310-9956-ffa450edef68
---
 .../SqlTimestampConverterTestCase.java        | 26 ++++++++++++++++---
 1 file changed, 23 insertions(+), 3 deletions(-)

diff --git a/src/test/java/org/apache/commons/beanutils/converters/SqlTimestampConverterTestCase.java b/src/test/java/org/apache/commons/beanutils/converters/SqlTimestampConverterTestCase.java
index 6f4ec3064..d79cb0e92 100644
--- a/src/test/java/org/apache/commons/beanutils/converters/SqlTimestampConverterTestCase.java
+++ b/src/test/java/org/apache/commons/beanutils/converters/SqlTimestampConverterTestCase.java
@@ -18,7 +18,9 @@
 package org.apache.commons.beanutils.converters;
 
 import java.sql.Timestamp;
+import java.text.DateFormat;
 import java.util.Calendar;
+import java.util.Date;
 import java.util.Locale;
 
 import junit.framework.TestSuite;
@@ -51,6 +53,13 @@ public static TestSuite suite() {
 
     // ------------------------------------------------------------------------
 
+    private boolean isUSFormatWithComma() {
+        // BEANUTILS-495 workaround - sometimes Java 9 expects "," in date even if
+        // the format is set to lenient
+        DateFormat loc = DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.SHORT, Locale.US);
+        return loc.format(new Date()).contains(",");
+    }
+
     /**
      * Test Date Converter with no default value
      */
@@ -60,15 +69,26 @@ public void testLocale() {
         // Re-set the default Locale to Locale.US
         final Locale defaultLocale = Locale.getDefault();
         Locale.setDefault(Locale.US);
+        isUSFormatWithComma();
 
-        final String pattern = "M/d/yy h:mm a"; // SHORT style Date & Time format for US Locale
 
         // Create & Configure the Converter
         final DateTimeConverter converter = makeConverter();
         converter.setUseLocaleFormat(true);
 
+        String pattern; // SHORT style Date & Time format for US Locale
+        String testString;
+        if (isUSFormatWithComma()) {
+            pattern = "M/d/yy, h:mm a";
+            testString = "3/21/06, 3:06 PM";
+        } else {
+            // More regular pattern for Java 8 and earlier
+            pattern = "M/d/yy h:mm a";
+            testString = "3/21/06 3:06 PM";
+        }
+
+
         // Valid String --> Type Conversion
-        final String testString = "3/21/06 3:06 pm";
         final Object expected = toType(testString, pattern, null);
         validConversion(converter, expected, testString);
 
@@ -146,4 +166,4 @@ protected Object toType(final Calendar value) {
         return new Timestamp(getTimeInMillis(value));
     }
 
-}
\ No newline at end of file
+}
