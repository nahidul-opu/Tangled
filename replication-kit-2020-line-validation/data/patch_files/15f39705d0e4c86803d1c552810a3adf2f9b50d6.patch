From 15f39705d0e4c86803d1c552810a3adf2f9b50d6 Mon Sep 17 00:00:00 2001
From: wujinhu <wujinhu920@126.com>
Date: Tue, 25 Oct 2016 12:07:48 +0800
Subject: [PATCH] =?UTF-8?q?[EAGLE-679]=20Fix=20missing=20CoprocessorServic?=
 =?UTF-8?q?e=20and=20MR=20Running=20feeder=20task=20number=20limi=E2=80=A6?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Author: wujinhu <wujinhu920@126.com>

Closes #558 from wujinhu/EAGLE-679.
---
 .../eagle/jpm/mr/running/parser/MRJobParser.java      | 11 +++++++++++
 eagle-topology-assembly/pom.xml                       |  4 ----
 2 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/eagle-jpm/eagle-jpm-mr-running/src/main/java/org/apache/eagle/jpm/mr/running/parser/MRJobParser.java b/eagle-jpm/eagle-jpm-mr-running/src/main/java/org/apache/eagle/jpm/mr/running/parser/MRJobParser.java
index 0abf9a033f..945e8cebb8 100644
--- a/eagle-jpm/eagle-jpm-mr-running/src/main/java/org/apache/eagle/jpm/mr/running/parser/MRJobParser.java
+++ b/eagle-jpm/eagle-jpm-mr-running/src/main/java/org/apache/eagle/jpm/mr/running/parser/MRJobParser.java
@@ -78,6 +78,7 @@ public enum ParserStatus {
     private List<String> configKeys;
     private static final int TOP_BOTTOM_TASKS_BY_ELAPSED_TIME = 10;
     private static final int FLUSH_TASKS_EVERY_TIME = 5;
+    private static final int MAX_TASKS_PERMIT = 5000;
 
     static {
         OBJ_MAPPER.configure(JsonParser.Feature.ALLOW_NON_NUMERIC_NUMBERS, true);
@@ -428,6 +429,16 @@ private Set<String> calcFetchCounterAndAttemptTaskId(List<MRTask> tasks) {
     }
 
     private Function<String, Boolean> fetchTasks = jobId -> {
+        try {
+            JobExecutionAPIEntity entity = this.mrJobEntityMap.get(jobId);
+            int taskNumber = entity.getNumTotalMaps() + entity.getNumTotalReduces();
+            if (taskNumber > MAX_TASKS_PERMIT) {
+                LOG.info("too many tasks {}, ignore tasks", taskNumber);
+                return true;
+            }
+        } catch (Exception e) {
+            return true;
+        }
         String taskURL = app.getTrackingUrl() + Constants.MR_JOBS_URL + "/" + jobId + "/" + Constants.MR_TASKS_URL + "?" + Constants.ANONYMOUS_PARAMETER;
         InputStream is = null;
         List<MRTask> tasks = null;
diff --git a/eagle-topology-assembly/pom.xml b/eagle-topology-assembly/pom.xml
index a9dddb0cf9..f5aee5fa38 100644
--- a/eagle-topology-assembly/pom.xml
+++ b/eagle-topology-assembly/pom.xml
@@ -41,10 +41,6 @@
             <artifactId>eagle-server</artifactId>
             <version>${project.version}</version>
             <exclusions>
-                <exclusion>
-                    <groupId>org.apache.hbase</groupId>
-                    <artifactId>hbase-server</artifactId>
-                </exclusion>
                 <exclusion>
                     <groupId>javax.servlet</groupId>
                     <artifactId>servlet-api</artifactId>
